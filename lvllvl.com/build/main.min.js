g_htmlCache={};g_htmlCache["html/modeSelect.html"]='<div> <label><input type="radio" name="editorMode" id="mode2d" value="2d"> 2d</label> &nbsp;&nbsp; <label><input type="radio" name="editorMode" id="modeSprite" value="sprite"> Sprite</label> &nbsp;&nbsp; <label><input type="radio" name="editorMode" id="modeMusic" value="music"> Music</label> &nbsp;&nbsp; <label><input type="radio" name="editorMode" id="modeAssembler" value="assembler"> Assembler</label> &nbsp;&nbsp; </div>';g_htmlCache["html/saveAsTemplateDialog.html"]='<div id="saveAsTemplateDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="saveAs" style="margin-bottom: 10px">Template name:</label> <input class="formControl" type="text" size="20" value="Untitled" id="saveAsTemplate"/> </div> <div> Templates contain the screen dimensions, tileset and colour palette. </div> <div> They will appear on the start page for this browser </div> </div> ';g_htmlCache["html/saveAsDialog.html"]='<div id="saveProjectAsDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="saveAs" style="margin-bottom: 10px">File name:</label> <input class="formControl" type="text" size="20" value="Untitled" id="saveProjectAs"/> </div> </div> ';g_htmlCache["html/colorSubPalettePickerMobile.html"]='<h2 style="margin: 0 0 14px 0" id="">Color Palette</h2> <div style="text-align: center"> <canvas id="colorSubPalettePickerMobileCanvas\' + this.id + \'"></canvas> </div> <div id="colorPalettePanelSubPalettesMobile"> <div class="colorPalettePanelSubPaletteMobile" data-subPalette="0"> <div class="colorPalettePanelSubPaletteHolderMobile"> <div class="colorPalettePanelSubPaletteLabelMobile">0:</div> <div class="colorPalettePanelSubPaletteColorsMobile"> <div class="colorPalettePanelSubPaletteColorMobile" id="colorPalettePanelSubPalette0-Color0Mobile" data-subPalette="0" data-color="0"></div> <div class="colorPalettePanelSubPaletteColorMobile" id="colorPalettePanelSubPalette0-Color1Mobile" data-subPalette="0" data-color="1"></div> <div class="colorPalettePanelSubPaletteColorMobile" id="colorPalettePanelSubPalette0-Color2Mobile" data-subPalette="0" data-color="2"></div> <div class="colorPalettePanelSubPaletteColorMobile" id="colorPalettePanelSubPalette0-Color3Mobile" data-subPalette="0" data-color="3"></div> </div> </div> </div> <div class="colorPalettePanelSubPalette" data-subPalette="1"> <div class="colorPalettePanelSubPaletteHolder"> <div class="colorPalettePanelSubPaletteLabel">1:</div> <div class="colorPalettePanelSubPaletteColors"> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette1-Color0" data-subPalette="1" data-color="0"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette1-Color1" data-subPalette="1" data-color="1"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette1-Color2" data-subPalette="1" data-color="2"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette1-Color3" data-subPalette="1" data-color="3"></div> </div> </div> </div> <div class="colorPalettePanelSubPalette" data-subPalette="2"> <div class="colorPalettePanelSubPaletteHolder"> <div class="colorPalettePanelSubPaletteLabel">2:</div> <div class="colorPalettePanelSubPaletteColors"> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette2-Color0" data-subPalette="2" data-color="0"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette2-Color1" data-subPalette="2" data-color="1"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette2-Color2" data-subPalette="2" data-color="2"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette2-Color3" data-subPalette="2" data-color="3"></div> </div> </div> </div> <div class="colorPalettePanelSubPalette" data-subPalette="3"> <div class="colorPalettePanelSubPaletteHolder"> <div class="colorPalettePanelSubPaletteLabel">3:</div> <div class="colorPalettePanelSubPaletteColors"> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette3-Color0" data-subPalette="3" data-color="0"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette3-Color1" data-subPalette="3" data-color="1"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette3-Color2" data-subPalette="3" data-color="2"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette3-Color3" data-subPalette="3" data-color="3"></div> </div> </div> </div> </div> ';g_htmlCache["html/downloadAsDialog.html"]='<div id="downloadAsDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="downloadAs" style="margin-bottom: 10px">File name:</label> <input class="formControl" type="text" size="20" value="Untitled" id="downloadAs"/> </div> </div> ';g_htmlCache["html/githubRepositoryDetails.html"]='<div id="githubRepositoryDetails" class="panelFill dialogContent"> <div id="githubRepositoryLogin" class="githubRepositoryDialogSection" style="display: none"> <h2>Sign in to GitHub to Share Project</h2> <div> <p>Projects are shared using GitHub public repositories.</p> <p>To share a project, you will need to login to GitHub.</p> </div> <div class="ui-button ui-button-info" id="loginRegisterGitHub" style="padding: 4px; height: auto; line-height: 20px"> <img style="margin-right: 6px; margin-top: -4px" src="icons/GitHub-Mark-32px.png"> GitHub Login/Register </div> </div> <div id="githubRepositoryMessage" style="display: none; margin-bottom: 10px"> </div> <div id="githubRepositoryProgress"></div> <div id="githubRepositoryError" style="display: none; margin-top: 10px; background-color: #333333; padding: 10px"></div> <div id="githubRepositoryCommitOnly" class="githubRepositoryDialogSection"> <div class="formGroup"> <div class="formGroup"> <div style="margin: 6px 0 10px 0; display: inline-block"> <div>Commit To</div> <div style="margin-top: 4px"> <span id="githubRepositoryCommitOnlyDetails" style="font-size: 30px; font-weight: 300px; color: #eeeeee"> Repository Details </span> (<a href="javascript: void(0)" style="cursor: pointer" id="githubRepositoryCommitOnlyChange">Change</a>) </div> </div> </div> </div> <div class="formGroup" id="githubRepositoryCommitOnlyMessageRow"> <div class="formGroup"> <label class="controlLabel" for="githubRepositoryCommitOnlyMessage" style="margin-bottom: 10px">Commit Message:</label> <input class="formControl" type="text" size="40" value="A Commit" id="githubRepositoryCommitOnlyMessage"/> </div> </div> </div> <div id="githubShareInstructions" class="githubRepositoryDialogSection"> <div style="margin-bottom: 10px"> <p> Projects are shared by creating a link to a public GitHub repository. </p> <p> To create a public repository, enter the name of the repository below. </p> </div> </div> <div id="githubSharePrivateInstructions" class="githubRepositoryDialogSection"> Your current repository is private, to share this project, you will need to convert the repository to public or create a new repository </div> <div id="githubRepositoryForm" class="githubRepositoryDialogSection"> <div class="formGroup" id="githubRepositoryFormCreateOptions"> <div> <label class="rb-container">Create A New Repository <input type="radio" name="githubRepositoryAction" checked="checked" id="githubRepositoryAction_create" value="create"> <span class="checkmark"></span> </label> <br/> <label class="rb-container">Save To An Existing Repository <input type="radio" name="githubRepositoryAction" id="githubRepositoryAction_save" value="save"> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup"> <label class="controlLabel" for="repositoryOwner" style="margin-bottom: 10px">Owner:</label> <input class="formControl" type="text" size="20" value="Untitled" id="repositoryOwner"/> </div> <div class="formGroup"> <label class="controlLabel" for="repositoryName" style="margin-bottom: 10px">Repository Name:</label> <input class="formControl" type="text" size="20" value="Untitled" id="repositoryName"/> </div> <div class="formGroup" id="githubRepositoryTypeRow"> <label class="controlLabel" for="repositoryType" style="margin-bottom: 10px">Repository Type:</label> <div style="display: inline-block"> <label class="rb-container">Public <input type="radio" name="githubRepositoryType" id="githubRepositoryType_public" value="public"> <span class="checkmark"></span> </label> &nbsp; <label class="rb-container">Private <input type="radio" name="githubRepositoryType" id="githubRepositoryType_private" checked="checked" value="private"> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup" id="githubCommitMessageRow"> <div class="formGroup"> <label class="controlLabel" for="repositoryCommitMessage" style="margin-bottom: 10px">Commit Message:</label> <input class="formControl" type="text" size="30" value="A Commit" id="repositoryCommitMessage"/> </div> </div> <div id="repositoryShareCreateButtonHolder"> <div id="repositoryShareCreateButton" class="ui-button ui-button-primary">Create Repository and Commit</div> </div> </div> <div id="githubShareLinkSection" class="githubRepositoryDialogSection"> <div style="margin-bottom: 10px" id="githubShareLinkSectionRepositoryCreated"> Repository Created! Files Committed! You can commit changes to this repository to update it. </div> <div style="margin-bottom: 10px" id="githubShareLinkSectionRepositoryExists"> <div> Your current repository is public, you can share this or create a new one. </div> <div> <div> Current Repository: <span id="githubShareLinkCurrentRepository"></span> </div> <div> <div class="ui-button ui-button-primary" id="githubShareLinkCurrentRepositoryCommit">Commit Changes</div> <div class="ui-button" id="githubShareLinkCurrentRepositoryNew">Create New Repository</div> </div> </div> </div> <div> <h2>Share Link</h2> <div class="formGroup"> <label class="controlLabel" for="repositoryCommitMessage" style="margin-bottom: 10px">Initial View:</label> <select id="githubShareInitialView"> </select> </div> </div> <div> <input type="text" size="40" readonly id="githubShareLink"/> <div class="ui-button ui-button-primary" id="githubShareLinkCopy"><img src="icons/svg/glyphicons-basic-614-copy.svg">&nbsp;Copy To Clipboard</div> </div> </div> </div> ';g_htmlCache["html/newDialog.html"]='<div id="newDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="newDialogMode">Mode:</label> <select name="newDialogMode" id="newDialogMode"> <option value="monochrome" selected="selected">Text Mode</option> <option value="c64multicolor">C64 Multicolour</option> </select> </div> <div class="formGroup"> <label class="controlLabel" for="newDialogWidth">Grid Width:</label> <input type="text" class="formControl number" min="1" value="40" id="newDialogWidth" size="4"/> </div> <div class="formGroup"> <label class="controlLabel" for="newDialogHeight">Grid Height:</label> <input type="text" class="formControl number" min="1" value="25" id="newDialogHeight" size="4"/> </div> </div>';g_htmlCache["html/startPage.html"]='<div id="startPage" class="panelFill" style="background-color: #191919"> <div id="projectMenuBacking" style="display: none; top: 0; left: 0; bottom: 0; right: 0; background-color: black; opacity: 0.2; position: fixed; z-index: 1000"></div> <div id="projectMenu" style="display: none; position: absolute; width: auto; height: auto; z-index: 2000" class="ui-menu"> <div class="ui-menu-item"><div class="ui-menu-item-label projectMenuItem" data-action="open">Open</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label projectMenuItem" data-action="delete">Delete</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label projectMenuItem" data-action="rename">Rename...</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label projectMenuItem" data-action="download">Download</div></div> </div> <div id="repositoryMenu" style="display: none; position: absolute; width: auto; height: auto; z-index: 2000" class="ui-menu"> <div class="ui-menu-item"><div class="ui-menu-item-label repositoryMenuItem" data-action="opennocheck">Open without checking for updates</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label repositoryMenuItem" data-action="viewongithub">View on GitHub...</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label repositoryMenuItem" data-action="remove">Remove</div></div> </div> <div id="gdriveMenu" style="display: none; position: absolute; width: auto; height: auto; z-index: 2000" class="ui-menu"> <div class="ui-menu-item"><div class="ui-menu-item-label gdriveMenuItem" data-action="viewInGDrive">View in Google Drive...</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label gdriveMenuItem" data-action="download">Download</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label gdriveMenuItem" data-action="delete">Delete</div></div> </div> <div id="startPageBanner" style="position: absolute; top: 0px; left: 0px; right: 0px; height: 122px; background-color: #131313; padding: 10px; border-bottom: 1px solid #222222"> <h1 style="margin: 0px; font-size: 54px; font-weight: normal"><img src="images/logo40.png" style="width: 40px; height: 40px; filter: opacity(80%);"/><span style="margin: 0 6px">lvllvl</span><span style="font-size: 12px">alpha</span></h1> <div> Create pictures using character sets </div> <div class="ui-button-holder" style="margin-top: 10px"> <div class="ui-button ui-button-primary" id="start2D"><i class="halflings halflings-plus"></i> <span class="ui-text" data-textid="New Project">New Project...</span><div class="rippleJS"></div></div> <div class="ui-button" style="margin-left: 6px" id="startOpen"><img src="icons/svg/glyphicons-halflings-106-open.svg"/> <span class="ui-text" data-textid="Open Local File">Open Local File...</span><div class="rippleJS"></div></div> </div> <div style="position: absolute; right: 0; top: 0; padding: 10px; text-align: right" id="start-login-panel"> <div id="login" style="display: none"> <div class="ui-button ui-button-info" id="login-button"> <img src="icons/GitHub-Mark-32px.png">&nbsp; <span class="ui-text" data-textid="Sign In With GitHub">Sign In With GitHub...</span></div> </div> <div id="logout" style="display: none"> <div id="start-username"></div> <div class="ui-button" id="logout-button"><span class="ui-text" data-textid="Sign Out"><img src="icons/svg/glyphicons-halflings-186-log-out.svg"/> Sign Out</span></div> </div> </div> </div> <style> .start-tile { display: inline-block; width: 130px; height: 130px; margin-right: 10px; margin-bottom: 16px; position: relative; background-color: #131313; /* transparent; */ cursor: pointer; transition: all 0.1s; } .start-tile:hover { background-color: #262626; } .start-tile-image { cursor: pointer; position: absolute; top: 6px; bottom: 26px; left: 6px; right: 6px; background-color: #0a0a0a; background-position: center; /* Center the image */ background-repeat: no-repeat; /* Do not repeat the image */ transition: all 0.1s; /*background-size: cover; Resize the background image to cover the entire container */ } .start-tile-label { position: absolute; height: 18px; bottom: 2px; left: 6px; right: 24px; font-size: 12px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; cursor: pointer; color: #cdcdcd; transition: all 0.1s; } .start-tile-more { position: absolute; right: 1px; bottom: 0px; height: 18px; width: 12px; padding: 3px; cursor: pointer; filter: invert(40%); opacity: 0; display: none; transition: opacity 2.6s; } .start-tile-more img { cursor: pointer; } .start-tile:hover .start-tile-image { /* top: 5px; bottom: 25px; left: 5px; right: 5px; */ background-color: #161616; } .start-tile:hover .start-tile-label { color: #dddddd; } .start-tile:hover .start-tile-more { display: block; opacity: 1; cursor: pointer; } .start-tile-more:hover { filter: invert(80%); } </style> <div id="startPageProjectHolder" style="position: absolute; top: 143px; left: 0px; right: 0px; bottom: 62px; padding: 10px; overflow: auto"> <div id="github_repositories"></div> <div id="browserStorage_persistent"></div> <div id="browserStorage_projects"></div> <div id="browserStorageOld_projects"></div> </div> <div style="position: absolute; bottom: 0; left: 0px; right: 0px; height: 42px; padding: 10px"> <div id="startGoogleDriveStatus"> <div id="startGoogleDriveConnected" style="display: none"> <div class="ui-button" id="disconnectFromGDriveButton"> <img src="icons/GoogleDriveIcon512.png" style="filter: none" height="20"/> Disconnect Google Drive </div> </div> <div id="startGoogleDriveNotConnected" style="display: none"> <div class="ui-button" id="connectToGDriveButton"> <img src="icons/GoogleDriveIcon512.png" style="filter: none" height="20"/> Connect To Google Drive </div> </div> </div> <div style="margin: 4px 0"> <span style="margin-right: 10px">No Icon: Stored in Browser Storage </span> <span style="margin-right: 10px"><img style="filter: invert(60%); width: 14px; height: 14px; " src="icons/GitHub-Mark-64px.png">: Stored in GitHub</span> <span style="margin-right: 10px"><img style="filter: invert(60%); width: 14px; height: 14px; " src="icons/GoogleDriveIconMonochromatic512.png">: Stored in Google Drive</span> </div> </div> </div>';g_htmlCache["html/startPageMobile.html"]='<style> .start-tile { display: inline-block; width: 110px; height: 110px; margin-right: 6px; margin-bottom: 10px; position: relative; background-color: #202020; /* transparent; */ cursor: pointer; transition: all 0.1s; } .start-tile:hover { background-color: #262626; } .start-tile-image { cursor: pointer; position: absolute; top: 6px; bottom: 26px; left: 6px; right: 6px; background-position: center; /* Center the image */ background-repeat: no-repeat; /* Do not repeat the image */ display: flex; text-align: center; justify-content: center; /*background-size: cover; Resize the background image to cover the entire container */ } .start-tile-label { position: absolute; height: 18px; bottom: 2px; left: 6px; right: 24px; font-size: 12px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; cursor: pointer; color: #cdcdcd; transition: all 0.1s; } .start-tile-more { position: absolute; right: 1px; bottom: 0px; height: 18px; width: 12px; padding: 3px; cursor: pointer; filter: invert(40%); opacity: 0; display: none; transition: opacity 2.6s; } .start-tile-more img { cursor: pointer; } .start-tile:hover .start-tile-image { top: 5px; bottom: 25px; left: 5px; right: 5px; background-color: #161616; } .start-tile:hover .start-tile-label { color: #dddddd; } .start-tile:hover .start-tile-more { display: block; opacity: 1; cursor: pointer; } .start-tile-more:hover { filter: invert(80%); } #start-user-info { height: 18px; margin-top: 2px; } #start2D .start-tile-image { background-color: #2266aa; } #start-login-mobile .start-tile-image { background-color: #117744; } #start-logout-mobile .start-tile-image { background-color: #117744; } </style> <div id="startPage" class="panelFill" style="background-color: #191919"> <div id="projectMenuBacking" style="display: none; top: 0; left: 0; bottom: 0; right: 0; background-color: black; opacity: 0.2; position: fixed; z-index: 1000"></div> <div id="projectMenu" style="display: none; position: absolute; width: auto; height: auto; z-index: 2000" class="ui-menu"> <div class="ui-menu-item"><div class="ui-menu-item-label projectMenuItem" data-action="delete">Delete</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label projectMenuItem" data-action="rename">Rename...</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label projectMenuItem" data-action="download">Download</div></div> </div> <div id="repositoryMenu" style="display: none; position: absolute; width: auto; height: auto; z-index: 2000" class="ui-menu"> <div class="ui-menu-item"><div class="ui-menu-item-label repositoryMenuItem" data-action="viewongithub">View on GitHub...</div></div> <div class="ui-menu-item"><div class="ui-menu-item-label repositoryMenuItem" data-action="remove">Remove</div></div> </div> <div style="position: absolute; top: 0px; left: 0px; right: 0px; height: 230px; background-color: #131313; padding: 10px; border-bottom: 1px solid #222222"> <h1 style="margin: 0px; font-weight: 200; font-size: 50px"><img src="images/logo40.png" style="width: 40px; height: 40px; filter: opacity(80%); "><span style="margin: 0 6px">lvllvl</span><span style="font-size: 12px">alpha</span></h1> <div style="margin-bottom: 4px"> Create pictures using character sets </div> <div id="start-user-info"> Checking user status... </div> <div style="margin-top: 10px; display: flex"> <div class="start-tile" id="start-continue-last"> <div class="start-tile-image" style="background-color: #0f0f0f; "> <div class="rippleJS"></div> </div> <div class="start-tile-label">Continue Last</div> </div> <div class="start-tile" id="start2D"> <div class="start-tile-image" style="display: flex; justify-content: center; align-items: center; text-align: center"> <img style="filter: invert(60%)" src="icons/material/baseline-add_circle_outline-24px.svg" height="60"/> <div class="rippleJS"></div> </div> <div class="start-tile-label">New</div> </div> <div class="start-tile" id="start-login-mobile" style="display: none; "> <div class="start-tile-image" style=" display: flex; justify-content: center;align-items: center; text-align: center"> <img src="icons/svg/glyphicons-halflings-185-log-in.svg" height="60" style="filter: invert(65%)"/> <div class="rippleJS"></div> </div> <div class="start-tile-label">Sign In</div> </div> <div class="start-tile" id="start-logout-mobile" style="display: none;"> <div class="start-tile-image" style="display: flex; justify-content: center;align-items: center; text-align: center"> <img src="icons/svg/glyphicons-halflings-186-log-out.svg" height="60" style="filter: invert(65%)"> <div class="rippleJS"></div> </div> <div class="start-tile-label">Sign Out</div> </div> </div> </div> <div id="startPageProjectHolderMobile" style="position: absolute; top: 252px; left: 0px; right: 0px; bottom: 60px; padding: 10px; overflow: auto"> <div id="github_repositories"></div> <div id="browserStorage_projects"></div> </div> <div id="startPageProjectFooterMobile" style="position: absolute; bottom: 0px; height: 40px; left: 0px; right: 0px;padding: 10px; overflow: hidden"> <div id="startGoogleDriveStatusMobile"> <div id="startGoogleDriveConnectedMobile" style="display: none"> <div class="ui-button" id="disconnectFromGDriveButtonMobile"> <img src="icons/GoogleDriveIcon512.png" style="filter: none;margin-right: 6px" height="20"/> Disconnect Google Drive</div> </div> <div id="startGoogleDriveNotConnectedMobile" style="display: none"> <div class="ui-button" id="connectToGDriveButtonMobile"> <img src="icons/GoogleDriveIcon512.png" style="filter: none;margin-right: 6px" height="20"/> Connect To Google Drive</div> </div> </div> </div> </div>';g_htmlCache["html/music/musicEditTools.html"]='<div id="patternViewControls" class="panelFill" style="background-color: #444444; padding: 2px; display: flex; align-items: center;"> <div> <div class="musicTool musicToolSelected" data-tool="draw" id="musicTool_draw"><img width="20" src="icons/pen@2x.png" title="Pencil (n)"/></div> <div class="musicTool" data-tool="erase" id="musicTool_erase"><img width="20" src="icons/erase@2x.png" title="Blank (l)"/></div> <div class="musicTool" data-tool="select" id="musicTool_select"><img width="20" src="icons/select@2x.png" title="Marquee (m)"/></div> <div class="musicTool" data-tool="hand" id="musicTool_hand"><img width="20" src="icons/hand@2x.png" title="Hand (h)"/></div> </div> <div style="margin-left: 10px"> <label><input name="legato" id="legato" type="checkbox" value="1"> Legato</label> </div> <div style="margin-left: 10px"> <div class="ui-button" id="patternCreateBeat">Create A Beat...</div> </div> </div> ';g_htmlCache["html/music/playbackControls.html"]='<div id="playbackControls" style="padding: 4px; background-color: #444444" class="panelFill"> <div class="ui-button" id="musicStop"><i class="halflings halflings-stop"></i>&nbsp;Stop</div> <div class="ui-button ui-button-primary" id="musicPlay"><i class="halflings halflings-play"></i>&nbsp;Play</div> <label><input type="checkbox" id="sidLoop">Loop Current Pattern</label> <label>Tempo:</label> <select id="sidTempo" name="sidTempo"> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6" selected="selected">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> </select> ticks/16th note </div>';g_htmlCache["html/music/addAPatternDialog.html"]='<div class="panelFill" style="padding: 4px"> <h2>Add a pattern</h2> <div style="margin-bottom: 8px"> <label class="rb-container" style="margin-right: 4px">Create New Pattern <input type="radio" id="sidAddPatternCreate" name="sidAddPattern" value="create" checked="checked"> <span class="checkmark"/> </label> <label class="rb-container" style="margin-right: 4px">Choose Existing Pattern <input type="radio" id="sidAddPatternExisting" name="sidAddPattern" value="existing"> <span class="checkmark"/> </label> </div> <div class="formRow" id="sidAddPatternCreateControl"> <label class="controlLabel">Pattern Name:</label> <input type="text" id="sidPatternName" name="sidPatternName"/> </div> <div class="formRow" id="sidAddPatternLengthControl"> <label class="controlLabel">Pattern Length:</label> <select id="sidPatternLength" name="sidPatternLength"> <option value="4">128</option> </select> </div> <div class="formRow" id="sidAddPatternExistingControl"> <label class="controlLabel" for="sidExistingPatterns">Pattern</label> <select id="sidExistingPatterns"> </select> </div> </div>';g_htmlCache["html/music/bassist.html"]='<div id="bassistDialog" class="panelFill" style="background-color: #444444; padding: 2px;"> <div id="bassistPatterns" style="background-color: #222222; position: absolute; left: 10px; top: 10px; bottom: 0; width: 180px; overflow: auto; "> <div class="characterSetListEntry">Rock 1</div> </div> <div style="position: absolute; left: 200px; top: 0px; bottom: 0; right: 0; overflow: auto"> <div style="margin: 10px"> <h3 id="chooseTileSetHeading">Rock 1</h3> <div id="bassistParameters"> </div> </div> </div> </div> ';g_htmlCache["html/music/drummer.html"]='<div id="drummerDialog" class="panelFill" style="background-color: #222222; padding: 2px;"> <div id="drummerPatterns" style="background-color: #111111; position: absolute; left: 10px; top: 10px; bottom: 0; width: 180px; overflow: auto; "> <div class="characterSetListEntry">Rock 1</div> </div> <div style="position: absolute; left: 200px; top: 0px; bottom: 0; right: 0; overflow: auto"> <div style="margin: 10px"> <div id="drummerParameters"> </div> </div> </div> </div> ';g_htmlCache["html/music/patternViewPopup.html"]='<div class="" id="patternViewPopup" style="width: 200px"> <div style="margin: 8px"> <div class="patternViewPopupMenu"> <div class="ui-menu-item patternViewPopupItem" id="patternViewPopupDraw" data-value="draw"> <div style="display: inline-block; width: 14px" class="patternViewPopupCheck" id="patternViewPopupDrawCheckmark">*</div> Draw </div> <div class="ui-menu-item patternViewPopupItem" id="patternViewPopupErase" data-value="erase"> <div style="display: inline-block; width: 14px" class="patternViewPopupCheck" id="patternViewPopupEraseCheckmark">*</div> Erase </div> <div class="ui-menu-item patternViewPopupItem" id="patternViewPopupSelect" data-value="select"> <div style="display: inline-block; width: 14px" class="patternViewPopupCheck" id="patternViewPopupSelectCheckmark">*</div> Select </div> </div> <div id="patternViewPopupInstruments"> </div> </div> </div> ';g_htmlCache["html/music/sid/editInstrument.html"]='<div id="editInstrument" class="panelFill" style="background-color: #444444;"> <div id="editInstrumentHolder" style="position: absolute; background-color: #333333; top: 0; bottom: 100px; left: 0px; right: 8px; overflow-y: auto"> <div class="content" style="padding: 8px"> <h3>Edit Instrument</h3> <div class="formGroup"> <label class="controlLabel" for="instrumentName">Name:</label> <input type="text" class="formControl" id="instrumentName" name="instrumentName"/> </div> <div class="formGroup"> <label class="controlLabel" for="instrumentType">Type:</label> <div class="radioGroup"> <label><input type="radio" name="editInstrumentType" id="editInstrumentType_basic" value="basic" checked="checked">Basic</label> <label><input type="radio" name="editInstrumentType" id="editInstrumentType_advanced" value="advanced">Advanced</label> <label><input type="radio" name="editInstrumentType" id="editInstrumentType_drum" value="drum">Drum</label> </div> </div> <div class="formGroup"> <label class="controlLabel">ADSR:</label> <div class="" style="display: inline-block"> <label for="editInstrumentAttack">Attack:&nbsp;</label> <select class="formControl" id="editInstrumentAttack"> <option value="0">2ms</option> <option value="1">8ms</option> <option value="2">16ms</option> <option value="3">24ms</option> <option value="4">38ms</option> <option value="5">56ms</option> <option value="6">68ms</option> <option value="7">80ms</option> <option value="8">100 ms</option> <option value="9">250 ms</option> <option value="10">500 ms</option> <option value="11">800 ms</option> <option value="12">1 s</option> <option value="13">3 s</option> <option value="14">5s</option> <option value="15">8s</option> </select> &nbsp;&nbsp; <label class="" for="editInstrumentDecay">Decay:</label> &nbsp; <select class="formControl" id="editInstrumentDecay"> <option value="0">6ms</option> <option value="1">24ms</option> <option value="2">48ms</option> <option value="3">72ms</option> <option value="4">114ms</option> <option value="5">168ms</option> <option value="6">204ms</option> <option value="7">240ms</option> <option value="8">300 ms</option> <option value="9">750 ms</option> <option value="10">1.5s</option> <option value="11">2.4s</option> <option value="12">3s</option> <option value="13">9s</option> <option value="14">15s</option> <option value="15">24s</option> </select> &nbsp;&nbsp; <label class="" for="editInstrumentSustain">Sustain Level:</label> &nbsp; <select class="formControl" id="editInstrumentSustain"> <option value="0">0</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> &nbsp;&nbsp; <label class="" for="editInstrumentRelease">Release: </label> &nbsp; <select class="formControl" id="editInstrumentRelease"> <option value="0">6ms</option> <option value="1">24ms</option> <option value="2">48ms</option> <option value="3">72ms</option> <option value="4">114ms</option> <option value="5">168ms</option> <option value="6">204ms</option> <option value="7">240ms</option> <option value="8">300 ms</option> <option value="9">750 ms</option> <option value="10">1.5s</option> <option value="11">2.4s</option> <option value="12">3s</option> <option value="13">9s</option> <option value="14">15s</option> <option value="15">24s</option> </select> </div> </div> <div class="formGroup"> <label class="controlLabel">Vibrato:</label> <div class="radioGroup"> <label><input type="radio" id="vibratoOn" name="vibrato" value="on"/> On</label> <label><input type="radio" id="vibratoOff" name="vibrato" value="off" checked="checked"/> Off</label> </div> </div> <div id="vibratoControls" style="display: none; "> <div class="formGroup"> <label class="controlLabel"></label> <div style="display: inline-block; margin-left: 20px"> <div style="margin-bottom: 8px"> Change pitch by depth, change direction every speed ticks </div> <div> <label for="editInstrumentVibratoDepth">Amount:</label> &nbsp; <input name="editInstrumentVibratoDepth" id="editInstrumentVibratoDepth" value="0" class="number" min="0" max="255" size="4"> / tick (0-255) &nbsp;&nbsp; <label for="editInstrumentVibratoSpeed">Cycle Time</label> &nbsp; <input name="editInstrumentVibratoSpeed" id="editInstrumentVibratoSpeed" value="1" class="number" min="1" max="127" size="4"> ticks (1-127) &nbsp;&nbsp; <label for="editInstrumentVibratoDelay">Delay</label> &nbsp; <input name="editInstrumentVibratoDelay" id="editInstrumentVibratoDelay" value="0" class="number" min="0" max="255" size="4"> ticks (0-255) </div> </div> </div> </div> <div id="editInstrumentBasic"> <div class="formGroup"> <label class="controlLabel">Waveform:</label> <div class="checkboxGroup"> <label><input name="editInstrumentWaveform" id="editInstrumentWaveform_triangle" value="triangle" type="checkbox"> Triangle</label> <label><input type="checkbox" id="editInstrumentWaveform_sawtooth" value="sawtooth"> Sawtooth</label> <label><input type="checkbox" id="editInstrumentWaveform_pulse" value="pulse"> Pulse</label> <label><input type="checkbox" id="editInstrumentWaveform_noise" value="noise"> Noise</label> </div> </div> <div id="pulseControls" style="display: none"> <div class="formGroup"> <label class="controlLabel"></label> <div style="display: inline-block"> <label for="editInstrumentPMWidth">Initial Pulse Width:</label> <div style="display: inline-block"> <label><input name="editInstrumentPMWidth" id="editInstrumentPMWidth" value="50" maxlength="3" size="4" class="number"> %</label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel"></label> <div style="display: inline-block"> <label style="margin-bottom: 4px">Pulse Modulation: </label><br/> <div style="margin-bottom: 4px">For Time ticks, increase pulse width by Amount/tick, then decrease by Amount/tick for Time ticks</div> <label>Time <input name="editInstrumentPMSpeed" id="editInstrumentPMSpeed" maxlength="3" size="4" class="number" min="1" max="999" value="3"> ticks (1-999) </label> &nbsp;&nbsp; <label>Amount <input name="editInstrumentPMDepth" id="editInstrumentPMDepth" maxlength="3" size="4" class="number" value="3" min="0" max="127"> per tick (0-127)</label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel">Effect: </label> <div class="radioGroup"> <label><input type="radio" name="editInstrumentBasicEffect" name="editInstrumentBasicEffect_none" value="none" checked="checked"> None</label> <label><input type="radio" name="editInstrumentBasicEffect" name="editInstrumentBasicEffect_tremolo" value="tremolo"> Tremolo</label> <label><input type="radio" name="editInstrumentBasicEffect" name="editInstrumentBasicEffect_arpeggio" value="arpeggio"> Arpeggio</label> <label><input type="radio" name="editInstrumentBasicEffect" name="editInstrumentBasicEffect_pitch" value="pitch"> Pitch change</label> <label><input type="radio" name="editInstrumentBasicEffect" name="editInstrumentBasicEffect_modulatewaveform" value="pitch"> Modulate Waveform</label> </div> <div class="editInstrumentBasicEffect" id="editInstrumentTremolo" style="margin-left: 90px;"> <div style="background-color: #888888; padding: 8px; display: inline-block"> <label>On For <select name="editInstrumentTremoloOnSpeed" id="editInstrumentTremoloOnSpeed"> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6" selected="selected">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> ticks </label> &nbsp;&nbsp; <label>Off For <select name="editInstrumentTremoloOffSpeed" id="editInstrumentTremoloOffSpeed"> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6" selected="selected">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> ticks </label> </div> </div> <div class="editInstrumentBasicEffect" id="editInstrumentArpeggio" style="margin-left: 90px;"> <div style="background-color: #888888; padding: 8px; display: inline-block"> <label>Ticks/note: <select name="editInstrumentArpeggioSpeed" id="editInstrumentArpeggioSpeed"> <option value="1" selected="selected">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </label> <br/> <div> <label>Mode</label> <label><input type="radio" checked="checked" name="editInstrumentArpeggioMode" name="editInstrumentArpeggioMode" value="major"> Major</label> <label><input type="radio" name="editInstrumentArpeggioMode" value="melodic"> Melodic Minor</label> <label><input type="radio" name="editInstrumentArpeggioMode" value="harmonic"> Harmonic Minor</label> <label><input type="radio" name="editInstrumentArpeggioMode" value="dorian"> Dorian</label> <label><input type="radio" name="editInstrumentArpeggioMode" value="phrygian"> Phrygian</label> <label><input type="radio" name="editInstrumentArpeggioMode" value="lydian"> Lydian</label> <label><input type="radio" name="editInstrumentArpeggioMode" value="mixolydian"> Mixolydian</label> <label><input type="radio" name="editInstrumentArpeggioMode" value="aeolian"> Aeolian</label> <label><input type="radio" name="editInstrumentArpeggioMode" value="locrian"> Locrian</label> </div> <div> <label>Steps</label> <label><input type="radio" name="editInstrumentArpeggioSteps" value="2"> 2</label> <label><input type="radio" checked="checked" name="editInstrumentArpeggioSteps" value="3"> 3</label> <label><input type="radio" name="editInstrumentArpeggioSteps" value="4"> 4</label> <label><input type="radio" name="editInstrumentArpeggioSteps" value="5"> 5</label> <label><input type="radio" name="editInstrumentArpeggioSteps" value="6"> 6</label> <label><input type="radio" name="editInstrumentArpeggioSteps" value="7"> 7</label> <label><input type="radio" name="editInstrumentArpeggioSteps" value="8"> 8</label> </div> <div id="editInstrumentsArpeggioSteps"> </div> </div> </div> <div class="editInstrumentBasicEffect" id="editInstrumentPitch" style="margin-left: 90px;"> <div style="background-color: #888888; padding: 8px; display: inline-block"> <label><input type="radio" id="editInstrumentPitchEffect_bendup" name="editInstrumentPitchEffect" value="bendup" checked="checked">Bend up to note</label> <label><input type="radio" id="editInstrumentPitchEffect_benddown" name="editInstrumentPitchEffect" value="benddown">Bend down to note</label> <label><input type="radio" id="editInstrumentPitchEffect_drop" name="editInstrumentPitchEffect" value="drop">Continuous Pitch Drop</label> <label><input type="radio" id="editInstrumentPitchEffect_rise" name="editInstrumentPitchEffect" value="rise">Continuous Pitch Rise</label> <div> <label>Speed <input size="4" id="editInstrumentPitchEffectSpeed" value="120" class="number" min="0" max="255"> (0-255)</label> <label>Ticks <input size="4" id="editInstrumentPitchEffectTicks" value="6" min="0" max="16"> (0-16) </label> </div> </div> </div> </div> </div> </div> <div id="editInstrumentDrum"> <div class="formGroup"> <label class="controlLabel">Drum Type:</label> <div class="radioGroup"> <label><input type="radio" name="editInstrumentDrumType" id="editInstrumentDrumType_bass" value="bass"> Bass drum</label> <label><input type="radio" name="editInstrumentDrumType" id="editInstrumentDrumType_tom" value="tom"> Tom</label> <label><input type="radio" name="editInstrumentDrumType" id="editInstrumentDrumType_snare" value="snare"> Snare</label> <label><input type="radio" name="editInstrumentDrumType" id="editInstrumentDrumType_hihat" value="hihat"> Hi-hat</label> </div> </div> <div class="formGroup"> <label class="controlLabel">Noise + Waveform: </label> <div class="checkboxGroup"> <label><input name="editInstrumentWaveform" id="editInstrumentDrumWaveform_triangle" value="triangle" type="checkbox"> Triangle</label> <label><input type="checkbox" id="editInstrumentDrumWaveform_sawtooth" value="sawtooth"> Sawtooth</label> <label><input type="checkbox" id="editInstrumentDrumWaveform_pulse" value="pulse"> Pulse</label> </div> </div> </div> <div id="editInstrumentAdvanced" style="padding: 0 10px 0 10px"> <div id="editInstrumentAdvancedTabs"> <div style="display: inline-block; width: 100px" class="instrumentTab instrumentActiveTab" id="wavetableTab">Wave Table</div> <div style="display: inline-block; width: 100px" class="instrumentTab" id="pulsetableTab">Pulse Table</div> <div style="display: inline-block; width: 100px" class="instrumentTab" id="filtertableTab">Filter Table</div> </div> <div id="editInstrumentWavetable" class="instrumentTable"> </div> <div id="editInstrumentPulsetable" class="instrumentTable"> </div> <div id="editInstrumentFiltertable" class="instrumentTable"> </div> </div> </div> <canvas id="editInstrumentKeyboard" width="1126" height="60" style="background-color: white;position: absolute; bottom: 40px"></canvas> <div class="buttons" style="position: absolute; bottom: 10px; right: 10px; width: 300px; text-align: right; "> <div class="ui-button ui-button-primary" id="editInstrumentOK">OK<div class="rippleJS"></div></div> <div class="ui-button" id="editInstrumentApply">Apply<div class="rippleJS"></div></div> <div class="ui-button" id="editInstrumentCancel">Cancel<div class="rippleJS"></div></div> </div> </div> ';g_htmlCache["html/music/sid/editFilter.html"]='<div id="editFilter" class="panelFill" style="background-color: #444444;"> <div id="editFilterHolder" style="position: absolute; background-color: #333333; top: 0; bottom: 100px; left: 0px; right: 8px; overflow-y: auto"> <h3>Edit filter</h3> <div class="content" style="padding: 8px"> <div class="editInstrumentRow"> <label class="editInstrumentLabel" for="filterName">Name:</label> <input id="filterName" name="filterName"/> </div> </div> <div class="content" style="padding: 8px"> <div class="editInstrumentRow"> <label class="editInstrumentLabel" for="b5">Type:</label> <label><input type="radio" name="editFilterType" id="editFilterType_basic" value="basic" checked="checked">Basic</label> <label><input type="radio" name="editFilterType" id="editFilterType_advanced" value="advanced">Advanced</label> </div> </div> <div id="editFilterBasic"> <div class="content"> <div class="editInstrumentRow"> <label class="editInstrumentLabel" for="filterBasicType">Filter Type:</label> <label><input type="checkbox" id="filterBasicType_low" name="filterBasicType" checked="checked"> Lowpass</label> <label><input type="checkbox" id="filterBasicType_band" name="filterBasicType"> Bandpass</label> <label><input type="checkbox" id="filterBasicType_high" name="filterBasicType"> Highpass</label> </div> </div> <div class="content"> <div class="editInstrumentRow"> <label class="editInstrumentLabel" for="filterBasicCutoff">Cutoff:</label> <input size="4" class="number" id="filterBasicCutoff" name="filterBasicCutoff" value="40"/> (0-255) </div> </div> <div class="content"> <div class="editInstrumentRow"> <label class="editInstrumentLabel" for="filterBasicResonance">Resonance:</label> <input size="4" class="number" id="filterBasicResonance" name="filterBasicResonance" value="15"/> (0-15) </div> </div> <div class="content"> <div class="editInstrumentRow"> <label class="editInstrumentLabel" for="filterBasicAffects">Filter Affects:</label> <label><input type="checkbox" id="filterBasicAffects_channel1" name="filterBasicAffects" value="channel1" checked="checked"> Channel 1</label> <label><input type="checkbox" id="filterBasicAffects_channel2" name="filterBasicAffects" value="channel2" checked="checked"> Channel 2</label> <label><input type="checkbox" id="filterBasicAffects_channel3" name="filterBasicAffects" value="channel3" checked="checked"> Channel 3</label> </div> </div> <div class="content"> <div class="editInstrumentRow"> <label class="editInstrumentLabel" for="filterBasicModulate">Modulate Cutoff:</label> Direction <label><input type="radio" name="filterBasicModulateType" name="filterBasicModulateType_none" value="none">None</label> <label><input type="radio" name="filterBasicModulateType" name="filterBasicModulateType_up" value="up" checked="checked">Up</label> <label><input type="radio" name="filterBasicModulateType" name="filterBasicModulateType_down" value="down">Down</label> <label><input type="radio" name="filterBasicModulateType" name="filterBasicModulateType_up" value="updown">Up / Down</label> <label>Time: <input size="4" value="1" name="filterBasicModulateTicks" id="filterBasicModulateTicks"> Ticks</label> <label>Amount: <input size="4" value="1" name="filterBasicModulateAmount" id="filterBasicModulateAmount"></label> <label><input type="checkbox" id="filterBasicModulateRepeat" name="filterBasicModulateRepeat" checked="checked"> Repeat</label> </div> </div> </div> <div id="editFilterAdvanced"> <div id="editFiltertable" class="instrumentTable"> Filter table </div> </div> </div> <div class="buttons" style="position: absolute; bottom: 80px; left: 10px"> <button id="editFilterOK">OK</button> <button id="editFilterApply">Apply</button> <button id="editFilterCancel">Cancel</button> </div> <canvas id="editFilterKeyboard" width="1200" height="60" style="background-color: white; position: absolute; bottom: 0px"></canvas> </div>';g_htmlCache["html/music/sid/effectDialog.html"]='<div class="panelFill" style="background-color: #222222;"> <div> <div class="formGroup"> <label class="controlLabel" for="sidEffect">aaEffect:</label> <select class="formControl" name="sidEffect" id="sidEffect"> <option value="0">No Effect</option> <option value="17">Legato</option> <option value="1">Portamento Up</option> <option value="2">Portamento Down</option> <option value="3">Portamento To Note</option> <option value="4">Set Vibrato</option> <option value="5">Set Attack/Decay</option> <option value="6">Set Sustain/Release</option> <option value="10">Start Filter</option> <option value="16">Stop Filter</option> <option value="11">Set Filter Resonance/Channels</option> <option value="12">Set Filter Cutoff</option> <option value="13">Set Master Volume</option> <option value="14">Set Funk Tempo</option> <option value="15">Set Tempo</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamPortamentoSpeed"> <label class="controlLabel" for="sidEffectPortamentoSpeed">Portamento Speed:</label> <input size="4" class="formControl number" min="0" max="65535" value="0" id="sidEffectPortamentoSpeed"/> (0-65535) </div> <div class="sidEffectParam formGroup" id="sidEffectParamPortamentoTo"> <label class="controlLabel" for="sidEffectPortamentoTo">Portamento To:</label> <span id="sidEffectPortamentoToControl" style="display: inline-block"> <select id="sidEffectPortamentoTo" class="formControl"> </select> </span> </div> <div class="sidEffectParam formGroup" id="sidEffectParamSetVibratoSpeed"> <label class="controlLabel" for="sidEffectVibratoSpeed">Vibrato Speed:</label> <input size="4" class="formControl number" min="0" max="255" value="0" id="sidEffectVibratoSpeed"/> (0-255) </div> <div class="sidEffectParam formGroup" id="sidEffectParamSetVibratoDepth"> <label class="controlLabel" for="sidEffectVibratoDepth">Vibrato Depth:</label> <input size="4" class="formControl number" min="0" max="255" value="0" id="sidEffectVibratoDepth"/> (0-255) </div> <div class="sidEffectParam formGroup" id="sidEffectParamAttack"> <label class="controlLabel" for="sidEffectAttack">Attack:</label> <select class="formControl" id="sidEffectAttack"> <option value="0">2ms</option> <option value="1">8ms</option> <option value="2">16ms</option> <option value="3">24ms</option> <option value="4">38ms</option> <option value="5">56ms</option> <option value="6">68ms</option> <option value="7">80ms</option> <option value="8">100 ms</option> <option value="9">250 ms</option> <option value="10">500 ms</option> <option value="11">800 ms</option> <option value="12">1 s</option> <option value="13">3 s</option> <option value="14">5s</option> <option value="15">8s</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamDecay"> <label class="controlLabel" for="sidEffectDelay">Decay:</label> <select class="formControl" id="sidEffectDecay"> <option value="0">6ms</option> <option value="1">24ms</option> <option value="2">48ms</option> <option value="3">72ms</option> <option value="4">114ms</option> <option value="5">168ms</option> <option value="6">204ms</option> <option value="7">240ms</option> <option value="8">300 ms</option> <option value="9">750 ms</option> <option value="10">1.5s</option> <option value="11">2.4s</option> <option value="12">3s</option> <option value="13">9s</option> <option value="14">15s</option> <option value="15">24s</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamSustain"> <label class="controlLabel" for="sidEffectSustain">Sustain:</label> <select class="formControl" id="sidEffectSustain"> <option value="0">0</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamRelease"> <label class="controlLabel" for="sidEffectRelease">Release:</label> <select class="formControl" id="sidEffectRelease"> <option value="0">6ms</option> <option value="1">24ms</option> <option value="2">48ms</option> <option value="3">72ms</option> <option value="4">114ms</option> <option value="5">168ms</option> <option value="6">204ms</option> <option value="7">240ms</option> <option value="8">300 ms</option> <option value="9">750 ms</option> <option value="10">1.5s</option> <option value="11">2.4s</option> <option value="12">3s</option> <option value="13">9s</option> <option value="14">15s</option> <option value="15">24s</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamFilter"> <label class="controlLabel" for="sidEffectFilter">Filter:</label> <span id="sidEffectFilterControl"> <select id="sidEffectFilter" class="formControl"> </select> </span> </div> <div class="sidEffectParam formGroup" id="sidEffectParamFilterResonance"> <label class="controlLabel" for="sidEffectFilterResonance">Filter Resonance:</label> <input size="4" class="formControl number" min="0" max="15" value="15" id="sidEffectFilterResonance"/> (0-15) </div> <div class="sidEffectParam formGroup" id="sidEffectParamFilterChannels"> <label class="controlLabel">Filter Channels:</label> <div class="checkboxGroup"> <label><input type="checkbox" id="sidEffectFilterChannel_1" value="1"/>Channel 1</label> <label><input type="checkbox" id="sidEffectFilterChannel_2" value="2"/>Channel 2</label> <label><input type="checkbox" id="sidEffectFilterChannel_3" value="3"/>Channel 3</label> </div> </div> <div class="sidEffectParam formGroup" id="sidEffectParamFilterCutoff"> <label class="controlLabel">Filter Cutoff:</label> <input size="4" class="formControl number" min="0" max="255" value="0" id="sidEffectFilterCutoff"/> (0-255) </div> <div class="sidEffectParam formGroup" id="sidEffectParamTempo"> <label class="controlLabel" for="sidEffectTempo">Tempo:</label> <select class="formControl" id="sidEffectTempo"> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamTempo1"> <label class="controlLabel" for="sidEffectTempo1">Tempo 1:</label> <select class="formControl" id="sidEffectTempo1"> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamTempo2"> <label class="controlLabel" for="sidEffectTempo2">Tempo 2:</label> <select class="formControl" id="sidEffectTempo2"> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div> </div> </div>';g_htmlCache["html/music/sid/sidEffectsChooser.html"]='<div class="panelFill" style="padding: 8px; background-color: #222222;" id="sidEffectsChooser"> <div class="formGroup"> <label class="controlLabel" for="sidEffect">Effect:</label> <select class="formControl" name="sidEffect" id="sidEffect"> <option value="0">No Effect</option> <option value="17">Legato</option> <option value="1">Portamento Up</option> <option value="2">Portamento Down</option> <option value="3">Portamento To Note</option> <option value="4">Set Vibrato</option> <option value="5">Set Attack/Decay</option> <option value="6">Set Sustain/Release</option> <option value="10">Start Filter</option> <option value="16">Stop Filter</option> <option value="11">Set Filter Resonance/Channels</option> <option value="12">Set Filter Cutoff</option> <option value="13">Set Master Volume</option> <option value="14">Set Funk Tempo</option> <option value="15">Set Tempo</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamPortamentoSpeed"> <label class="controlLabel" for="sidEffectPortamentoSpeed">Portamento Speed:</label> <input size="4" class="formControl number" min="0" max="65535" value="0" id="sidEffectPortamentoSpeed"/> (0-65535) </div> <div class="sidEffectParam formGroup" id="sidEffectParamPortamentoTo"> <label class="controlLabel" for="sidEffectPortamentoTo">Portamento To:</label> <span id="sidEffectPortamentoToControl" style="display: inline-block"> <select id="sidEffectPortamentoTo" class="formControl"> </select> </span> </div> <div class="sidEffectParam" id="sidEffectVibrato"> <div> <label class="controlLabel" for="">Edit Parameter:</label> <label><input name="sidEffectVibratoEditParam" id="sidEffectVibratoEditParam_speed" value="speed" type="radio" checked="checked">Vibrato Speed</label> <label><input name="sidEffectVibratoEditParam" id="sidEffectVibratoEditParam_depth" value="depth" type="radio">Vibrato Depth</label> </div> <div class="sidEffectParam formGroup" id="sidEffectParamSetVibratoSpeed"> <label class="controlLabel" for="sidEffectVibratoSpeed">Vibrato Speed:</label> <input size="4" class="formControl number" min="0" max="255" value="0" id="sidEffectVibratoSpeed"/> (0-127) </div> <div class="sidEffectParam formGroup" id="sidEffectParamSetVibratoDepth"> <label class="controlLabel" for="sidEffectVibratoDepth">Vibrato Depth:</label> <input size="4" class="formControl number" min="0" max="255" value="0" id="sidEffectVibratoDepth"/> (0-255) </div> </div> <div class="sidEffectParam" id="sidEffectAttackDecay"> <div> <label class="controlLabel" for="">Edit Parameter:</label> <label><input id="sidEffectAttackDecayEditParam_attack" name="sidEffectAttackDecayEditParam" value="attack" type="radio" checked="checked">Attack</label> <label><input id="sidEffectAttackDecayEditParam_decay" name="sidEffectAttackDecayEditParam" value="decay" type="radio">Decay</label> </div> <div class="sidEffectParam formGroup" id="sidEffectParamAttack"> <label class="controlLabel" for="sidEffectAttack">Attack:</label> <select class="formControl" id="sidEffectAttack"> <option value="0">2ms</option> <option value="1">8ms</option> <option value="2">16ms</option> <option value="3">24ms</option> <option value="4">38ms</option> <option value="5">56ms</option> <option value="6">68ms</option> <option value="7">80ms</option> <option value="8">100 ms</option> <option value="9">250 ms</option> <option value="10">500 ms</option> <option value="11">800 ms</option> <option value="12">1 s</option> <option value="13">3 s</option> <option value="14">5s</option> <option value="15">8s</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamDecay"> <label class="controlLabel" for="sidEffectDelay">Decay:</label> <select class="formControl" id="sidEffectDecay"> <option value="0">6ms</option> <option value="1">24ms</option> <option value="2">48ms</option> <option value="3">72ms</option> <option value="4">114ms</option> <option value="5">168ms</option> <option value="6">204ms</option> <option value="7">240ms</option> <option value="8">300 ms</option> <option value="9">750 ms</option> <option value="10">1.5s</option> <option value="11">2.4s</option> <option value="12">3s</option> <option value="13">9s</option> <option value="14">15s</option> <option value="15">24s</option> </select> </div> </div> <div class="sidEffectParam" id="sidEffectSustainRelease"> <div> <label class="controlLabel" for="">Edit Parameter:</label> <label><input id="sidEffectSustainReleaseEditParam_sustain" name="sidEffectSustainReleaseEditParam" value="sustain" type="radio" checked="checked">Sustain</label> <label><input id="sidEffectSustainReleaseEditParam_release" name="sidEffectSustainReleaseEditParam" value="release" type="radio">Release</label> </div> <div class="sidEffectParam formGroup" id="sidEffectParamSustain"> <label class="controlLabel" for="sidEffectSustain">Sustain:</label> <select class="formControl" id="sidEffectSustain"> <option value="0">0</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamRelease"> <label class="controlLabel" for="sidEffectRelease">Release:</label> <select class="formControl" id="sidEffectRelease"> <option value="0">6ms</option> <option value="1">24ms</option> <option value="2">48ms</option> <option value="3">72ms</option> <option value="4">114ms</option> <option value="5">168ms</option> <option value="6">204ms</option> <option value="7">240ms</option> <option value="8">300 ms</option> <option value="9">750 ms</option> <option value="10">1.5s</option> <option value="11">2.4s</option> <option value="12">3s</option> <option value="13">9s</option> <option value="14">15s</option> <option value="15">24s</option> </select> </div> </div> <div class="sidEffectParam formGroup" id="sidEffectParamFilter"> <label class="controlLabel" for="sidEffectFilter">Filter:</label> <span id="sidEffectFilterControl"> <select id="sidEffectFilter" class="formControl"> </select> </span> </div> <div class="sidEffectParam formGroup" id="sidEffectParamFilterChannels"> <label class="controlLabel">Filter Channels:</label> <div class="checkboxGroup"> <label><input type="checkbox" id="sidEffectFilterChannel_1" value="1"/>Channel 1</label> <label><input type="checkbox" id="sidEffectFilterChannel_2" value="2"/>Channel 2</label> <label><input type="checkbox" id="sidEffectFilterChannel_3" value="3"/>Channel 3</label> </div> </div> <div class="sidEffectParam formGroup" id="sidEffectParamFilterResonance"> <label class="controlLabel" for="sidEffectFilterResonance">Filter Resonance:</label> <input size="4" class="formControl number" min="0" max="15" value="15" id="sidEffectFilterResonance"/> (0-15) </div> <div class="sidEffectParam formGroup" id="sidEffectParamFilterCutoff"> <label class="controlLabel">Filter Cutoff:</label> <input size="4" class="formControl number" min="0" max="255" value="0" id="sidEffectFilterCutoff"/> (0-255) </div> <div class="sidEffectParam formGroup" id="sidEffectParamVolume"> <label class="controlLabel" for="sidEffectVolume">Volume:</label> <select class="formControl" id="sidEffectVolume"> <option value="0">0</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamTempo"> <label class="controlLabel" for="sidEffectTempo">Tempo:</label> <select class="formControl" id="sidEffectTempo"> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamTempo1"> <label class="controlLabel" for="sidEffectTempo1">Tempo 1:</label> <select class="formControl" id="sidEffectTempo1"> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div> <div class="sidEffectParam formGroup" id="sidEffectParamTempo2"> <label class="controlLabel" for="sidEffectTempo2">Tempo 2:</label> <select class="formControl" id="sidEffectTempo2"> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> </select> </div> <div id="sidEffectsParamGraph"> <canvas style="background-color: black" id="sidEffectParamCanvas" width="300" height="300"></canvas> <div id="sidEffectsParamGraphInfo"> </div> </div> </div> ';g_htmlCache["html/c64/c64OnscreenJoystick.html"]='<div class="panelFill"> <style> .c64JoystickDirection, .c64JoystickFire { width: 100px; height: 20px; background-color: #777777; color: black; margin: 10px auto; } </style> <div style="text-align: center"> <div class="c64JoystickDirection" data-direction="up" id="">Up</div> <div class="c64JoystickDirection" data-direction="down" id="">Down</div> <div class="c64JoystickDirection" data-direction="left" id="">Left</div> <div class="c64JoystickDirection" data-direction="right" id="">Right</div> <div class="c64JoystickFire" id="">Fire</div> </div> </div>';g_htmlCache["html/c64/exportC64SpriteData.html"]='<div class="panelFill dialogContent" id="exportSpriteDataPanel" style="overflow: hidden;"> <div style="position: absolute; top: 10px; left: 10px; right: 10px; height: 30px;"> <div class="formGroup"> <label class="controlLabel" for="exportSpriteDataAs">File name:</label> <input type="text" class="formControl" size="20" value="untitled" id="exportSpriteDataAs"/> <div id="exportC64SpriteDataDownload" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg"/> Download</div> </div> </div> <div style="position: absolute; top: 50px; left: 10px; right: 10px; bottom: 80px"> <div id="exportC64SpriteDataSource" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0"></div> </div> <div style="position: absolute; bottom: 10px; height: 60px; left: 10px; right: 10px"> <div> <label>Export From $<input id="exportSpriteDataFrom" size="3"/></label> <label>Export To $<input id="exportSpriteDataTo" size="3"/></label> <label>First Line Number<input id="exportSpriteLineNumber" size="3" value="10"/></label> </div> </div> </div> ';g_htmlCache["html/project/newDocRecord.html"]='<div id="newDocRecordDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="newDocRecordType">Type:</label> <select id="newDocRecordType"> <option value="folder">Folder</option> <option value="screen">Screen</option> <option value="sprite">Sprite</option> <option value="color palette">Colour Palette</option> <option value="tile set">Tile Set</option> <option value="music">Music</option> <option value="script">Script</option> <option value="asm">ASM</option> <option value="binary">Binary</option> <option value="3d scene">3d scene</option> </select> </div> <div class="formGroup" id="newDocRecordDocName"> <label class="controlLabel" for="newProjectFileName">Name:</label> <input type="text" class="formControl submitOnEnter" id="newProjectFileName" spellcheck="false"/> </div> <div class="formGroup" id="newDocRecordSpriteScreenModeGroup"> <label class="controlLabel" for="newDocRecordSpriteScreenMode">Screen Mode</label> <select id="newDocRecordSpriteScreenMode"> <option value="monochrome">Monochrome</option> <option value="c64multicolor">C64 Multicolor</option> <option value="nes">NES</option> <option value="indexed">Indexed</option> </select> </div> <div id="newDocRecordGridDimensions"> <div class="formGroup"> <label class="controlLabel" for="newDocRecordGridWidth">Grid Size:</label> <input type="text" class="formControl number" min="1" max="200" value="40" id="newDocRecordGridWidth" size="2"/> &nbsp;x&nbsp; <input type="text" class="formControl number" min="1" max="200" value="25" id="newDocRecordGridHeight" size="2"> <span id="newDocRecordGridDimensionsDepth"> &nbsp;x&nbsp; <input type="text" class="formControl number" min="1" max="200" value="25" id="newDocRecordGridDepth" size="2"> </span> &nbsp; Cells </div> <div class="formGroup"> <label class="controlLabel" for="newDocRecordGridTileSet">Tile Set:</label> <select id="newDocRecordGridTileSet"> <option value="0">New</option> </select> </div> <div class="formGroup"> <label class="controlLabel" for="newDocRecordGridColorPalette">Colour Palette:</label> <select id="newDocRecordGridColorPalette"> <option value="0">New</option> </select> </div> </div> <div id="newDocRecordSpriteDimensions"> <div class="formGroup"> <label class="controlLabel" for="newDocRecordSpriteGridWidth">Tile Size:</label> 24 x 21 pixels </div> <div class="formGroup"> <label class="controlLabel" for="newDocRecordSpriteGridWidth">Grid Size:</label> <input type="text" class="formControl number" min="1" max="8" value="1" id="newDocRecordSpriteGridWidth" size="4"/> x <input type="text" class="formControl number" min="1" max="8" value="1" id="newDocRecordSpriteGridHeight" size="4" style="cursor: ew-resize;"> &nbsp;Tile(s) </div> <div class="formGroup"> <label class="controlLabel" for="newDocRecordSpriteTileSet">Tile Set:</label> <select id="newDocRecordSpriteTileSet"> <option value="0">New</option> </select> </div> <div class="formGroup"> <label class="controlLabel" for="newDocRecordSpriteColorPalette">Colour Palette:</label> <select id="newDocRecordSpriteColorPalette"> <option value="0">New</option> </select> </div> </div> <div id="newDocRecordBinFileGroup"> <div class="formGroup"> <label class="controlLabel" for="newDocRecordBinaryFile">Binary File(s):</label> <div style="display: inline-block"> <div class="ui-button ui-button-primary" id="newDocBinaryChooseFiles">Choose File(s)...</div> </div> <div id="newDocBinaryFiles" style="padding: 4px; background-color: #cccccc; color: #222222; margin-top: 10px"></div> <form id="newDocBinaryFileForm" style="position: absolute; left: -1000px"> <input type="file" accept=".bin" multiple id="newDocRecordBinaryFile"/> </form> </div> </div> </div>';g_htmlCache["html/project/saveProjectAsDialog.html"]='<div id="saveProjectAsDialog" class="panelFill dialogContent"> <h3> Save As.. </h3> <div id="saveAsForm"> <div class="formGroup"> <label class="controlLabel" for="saveProjectAs" style="margin-bottom: 10px">Project Name:</label> <input class="formControl submitOnEnter" type="text" size="20" value="Untitled" id="saveProjectAs" style="width: 180px"/> </div> <div class="formGroup"> <label class="controlLabel">Save To</label> <div class="checkboxGroup"> <label class="rb-container">Google Drive <input type="radio" id="saveMethod_googleDrive" name="saveMethod" value="googleDrive"> <span class="checkmark"></span> </label> <label class="rb-container">Browser Storage <input type="radio" id="saveMethod_browserStorage" name="saveMethod" value="browserStorage"> <span class="checkmark"></span> </label> </div> </div> </div> <div id="saveAsConnectToGDriveButtonSection" style="display: none"> <div class="ui-button" id="saveAsConnectToGDriveButton"> <img src="icons/GoogleDriveIcon512.png" style="filter: none" height="20"/> Connect To Google Drive </div> </div> <div id="saveAsGDriveProgress" style="display: none"> Saving to Google Drive... </div> </div> ';g_htmlCache["html/project/renameDialog.html"]='<div id="renameDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="renameProjectName">Name:</label> <input type="text" class="formControl" id="renameProjectName"/> </div> </div>';g_htmlCache["html/project/projectShareDialog.html"]='<div id="projectShareDialog" class="panelFill dialogContent"> <div id="projectShareLogin" style="display: none"> <h2>NOT USED??Sign In/Register</h2> <p>Projects are shared using GitHub public repositories.</p> To share a project, you will need to login and/or register to GitHub. <div class="ui-button" id="loginRegisterGitHub">GitHub Login/Register</div> </div> <div id="projectShareRepositoryDetails" style="display: none"> <h2>Repository Details</h2> <div class="formGroup" id="projectShareRepositoryOptions" style="display: none"> <div> <label class="rb-container">Create A New Repository <input type="radio" name="shareGithubRepositoryAction" checked="checked" id="shareGithubRepositoryAction_create" value="create"> <span class="checkmark"></span> </label> <br/> <label class="rb-container">Use Existing Repository <input type="radio" name="shareGithubRepositoryAction" id="shareGithubRepositoryAction_save" value="save"> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup" id="projectShareNewRepository" style="display: none"> <p> Create a new public GitHub repository. </p> </div> <div class="formGroup"> <label class="controlLabel" for="shareRepositoryOwner" style="margin-bottom: 10px">Owner:</label> <input class="formControl" type="text" size="20" value="Untitled" id="shareRepositoryOwner"/> </div> <div class="formGroup"> <label class="controlLabel" for="shareRepositoryName" style="margin-bottom: 10px">Repository Name:</label> <input class="formControl" type="text" size="20" value="Untitled" id="shareRepositoryName"/> </div> </div> </div>';g_htmlCache["html/project/createTemplateLink.html"]='<div id="templateLinkDialog" class="panelFill dialogContent"> <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 28px; overflow: auto; padding: 10px"> <div style="margin-bottom: 10px; line-height: 14px"> <div style="display: inline-block"> <img src="icons/svg/glyphicons-basic-351-link.svg" width="30" height="30" style="filter: invert(0.7)"/> </div> <div style="display: inline-block"> Create a link to a template.<br/> The link will jump straight into the editor with the presets chosen. </div> </div> <div class="formGroup"> <label class="controlLabel" for="templateLinkTileSetList">Editor:</label> <select id="templateLinkEditorList"> <option value="screen">Screen</option> <option value="sprite" class="unfinished">Sprite</option> <option value="color" class="unfinished">Colour Palette</option> <option value="3d" class="unfinished">3d Scene</option> <option value="music" class="unfinished">Music</option> <option value="assembly" class="unfinished">Assembly</option> <option value="c64" class="unfinished">C64 Emulator</option> </select> </div> <div class="formGroup"> <label class="controlLabel" for="templateLinkTileSetList">Tile Set:</label> <select id="templateLinkTileSetList"> </select> </div> <div class="formGroup"> <label class="controlLabel" for="templateLinkColorPaletteList">Color Palette:</label> <select id="templateLinkColorPaletteList"> </select> </div> <div class="formGroup"> <label class="controlLabel">Screen Mode:</label> <select id="templateLinkScreenMode" style="width: 177px"> <option value="textmode">Text Mode</option> <option value="c64multicolor">C64 Multicolour</option> <option value="c64ecm">C64 Extended BG Colour Mode</option> <option value="nes">NES</option> <option value="indexed">Indexed Colour</option> </select> </div> <div class="formGroup"> <label class="controlLabel" for="templateLinkWidth">Grid:</label> <label>Width: <input class="formControl number" id="templateLinkWidth" min="1" max="500" value="40" type="text" size="3"/> </label> <label>Height: <input class="formControl number" id="templateLinkHeight" min="1" max="500" value="25" type="text" size="3"/> </label> </div> <div class="formGroup"> <label class="controlLabel" for=""></label> <label class="cb-container">Can Flip Tiles <input type="checkbox" id="templateLinkCanFlipTiles"> <span class="checkmark"></span> </label> <label class="cb-container">Can Rotate Tiles <input type="checkbox" id="templateLinkCanRotateTiles"> <span class="checkmark"></span> </label> </div> </div> <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 26px; overflow: hidden; padding: 10px"> <div style="display: flex"> <input id="templateLink" type="text" class="formControl" style="width: 280px; background-color: #bbbbbb" value="https://lvllvl.com" readonly/> <div id="templateLinkCopy" class="ui-button ui-button-primary"> <img src="icons/svg/glyphicons-basic-614-copy.svg"> Copy Link </div> </div> </div> </div> ';g_htmlCache["html/project/newDocRecordMobile.html"]='<div id="newDocRecordMobileDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="newDocRecordMobileType">Type:</label> <select id="newDocRecordMobileType"> <option value="screen">Screen</option> <option value="sprite">Sprite</option> <option value="asm">ASM</option> <option value="3d scene">3d Scene</option> </select> </div> <div class="formGroup"> <label class="controlLabel" for="newProjectFileNameMobile">Name:</label> <input type="text" class="formControl" id="newProjectFileNameMobile" spellcheck="false"/> </div> <div id="newDocRecordMobileGridDimensions"> <div class="formGroup"> <label class="controlLabel" for="newDocRecordGridWidthMobile">Grid Size:</label> <input type="text" class="formControl number" min="1" value="40" id="newDocRecordGridWidthMobile" size="2"/> <span style="margin: 0 4px 0 4px">x</span> <input type="text" class="formControl number" min="1" value="25" id="newDocRecordGridHeightMobile" size="2"> <span id="newDocRecordGridDimensionsDepthMobile"> <span style="margin: 0 4px 0 4px">x</span> <input type="text" class="formControl number" min="1" value="25" id="newDocRecordGridDepthMobile" size="2"/> </span> </div> </div> <div id="newDocRecordMobileTileColor"> <div class="formGroup"> <label class="controlLabel" for="newDocRecordMobileTileSet">Tile Set:</label> <select id="newDocRecordMobileTileSet"> <option value="0">New</option> </select> </div> <div class="formGroup"> <label class="controlLabel" for="newDocRecordMobileColorPalette">Colour Palette:</label> <select id="newDocRecordMobileColorPalette"> <option value="0">New</option> </select> </div> </div> </div>';g_htmlCache["html/textMode/newTileSet.html"]='<div id="newTileSetDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="newTileSetName">Name:</label> <input type="text" class="formControl" id="newTileSetName" spellcheck="false"/> </div> <div class="formGroup"> <label class="controlLabel" for="newTileSetCount">Tile Count:</label> <input type="text" class="formControl number" min="1" id="newTileSetCount" value="256" spellcheck="false"/> </div> </div>';g_htmlCache["html/textMode/export3dAsGifFrames.html"]='<div class="panelFill" id="export3dGifFramesPanel"> <div style="position: absolute; top: 0; bottom: 0; right: 0; left: 0px; padding: 10px; overflow: auto"> <h3><i class="halflings halflings-film"></i>&nbsp;Frames</h3> <div id="export3dGIFFrames"> <div class="formGroup"> <label class="controlLabel" for="export3dGIFFromFrame">Export Frames:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="export3dGIFFromFrame"> &nbsp; <label for="export3dGIFToFrame">To</label> &nbsp; <input type="number" size="2" class="number" min="1" id="export3dGIFToFrame"> </div> <select name="export3dGIFLoopType" id="export3dGIFLoopType"> <option value="loop">Loop</option> <option value="pingpong">Ping Pong</option> </select> </div> <div class="formGroup"> <label class="controlLabel">Speed:</label> <select name="export3dGIFSpeed" id="export3dGIFSpeed"> <option value="1">100%</option> <option value="2">200%</option> <option value="3">300%</option> <option value="4">400%</option> <option value="custom">Custom</option> </select> </div> <div class="formGroup" id="custom3dSpeedSection" style="display: none"> <label class="controlLabel">Custom speed:</label> <div style="display: inline-block"> <input size="3" type="number" class="number" min="5" value="10" id="export3dGIFMSPerTick"/> ms per tick </div> </div> </div> <h3><i class="halflings halflings-film"></i>&nbsp;Camera</h3> <div id="export3dGIFCamera"> <div class="formGroup" id=""> <label class="controlLabel">Camera Type:</label> <div style="display: inline-block"> <label class="rb-container">Position/Rotation <input type="radio" name="export3dGIFCameraType" value="position"> <span class="checkmark"></span> </label> </div> <div style="display: inline-block"> <label class="rb-container">Orbit <input type="radio" name="export3dGIFCameraType" value="orbit" checked="checked"> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup export3dCameraPositionControls" id="export3dCameraPositionSection"> <label class="controlLabel">Position:</label> <div style="display: inline-block"> <label>x: <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraPosition" value="10" id="export3dCameraX"/></label> <label>y: <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraPosition" value="10" id="export3dCameraY"/></label> <label>z: <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraPosition" value="10" id="export3dCameraZ"/></label> </div> </div> <div class="formGroup export3dCameraPositionControls" id="export3dCameraRotationSection"> <label class="controlLabel">Rotation:</label> <div style="display: inline-block"> <label>x: <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraRotation" value="10" id="export3dRotationX"/></label> <label>y: <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraRotation" value="10" id="export3dRotationY"/></label> <label>z: <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraRotation" value="10" id="export3dRotationZ"/></label> </div> </div> </div> <div class="formGroup export3dCameraOrbitControls" id="export3dCameraTargetSection"> <label class="controlLabel">Target:</label> <div style="display: inline-block"> <label>x: <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraTarget" value="40" id="export3dCameraTargetX"/></label> <label>y: <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraTarget" value="0" id="export3dCameraTargetY"/></label> <label>z: <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraTarget" value="20" id="export3dCameraTargetZ"/></label> </div> </div> <div class="formGroup export3dCameraOrbitControls" id=""> <label class="controlLabel"></label> <div style="display: inline-block"> <label class="cb-container">Autorotate <input type="checkbox" name="export3dCameraAutorotate" id="export3dCameraAutorotate" value="yes" checked="checked"> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup export3dCameraOrbitControls" id="export3dCameraAzimuthSection"> <label class="controlLabel">Azimuth Angle:</label> <div style="display: inline-block"> <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraAzimuthAngle" value="90" id="export3dAzimuthAngle"/> </div> </div> <div class="formGroup export3dCameraOrbitControls" id="export3dCameraAltitudeSection"> <label class="controlLabel">Altitude Angle:</label> <div style="display: inline-block"> <input type="number" size="4" style="margin-right: 4px" min="-90" max="90" class="number export3dCameraAltitudeAngle" value="10" id="export3dAltitudeAngle"/> </div> </div> <div class="formGroup export3dCameraOrbitControls" id="export3dCameraDistanceSection"> <label class="controlLabel">Distance:</label> <div style="display: inline-block"> <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraDistance" value="160" id="export3dCameraDistance"/> </div> </div> <div class="formGroup" id="export3dCameraFOVSection"> <label class="controlLabel">Field Of View:</label> <div style="display: inline-block"> <input type="number" size="4" style="margin-right: 4px" class="number export3dCameraFOV" value="10" id="export3dCameraFOV"/> </div> </div> </div> </div>';g_htmlCache["html/textMode/tileSetChoosePreset.html"]='<div class="panelFill"> <div id="chooseCharacterSetList" style="position: absolute; left: 10px; top: 10px; bottom: 10px; width: 180px; overflow: auto; "> <div class="characterSetListEntry">c64</div> </div> <div style="position: absolute; left: 200px; top: 0px; bottom: 0; right: 0; overflow: auto; display: flex; flex-direction: column; padding: 10px"> <div> <h3 id="chooseCharacterSetHeading"></h3> </div> <div style="overflow: auto; flex-grow: 100; background-color: #050505; display: flex; text-align: center; flex-direction: column; align-items: center; vertical-align: middle;" id="chooseCharacterSetPreviewHolder"> <canvas id="chooseCharacterSetPreview" width="256" height="256" style="background-color: #222222"></canvas> </div> <div id="chooseCharacterSetOptions" style=" background-color: #272727; padding: 10px 10px 0px 10px"></div> <div id="chooseCharacterSetInfo"></div> </div> </div> ';g_htmlCache["html/textMode/referenceImageDialog.html"]='<div class="panelFill dialogContent" id="refLayer"> <div style="padding: 4px"> <div class="ui-button ui-button-nextaction" id="refLayerSourceChooseFile">Choose Image...</div> &nbsp;&nbsp; <div class="ui-button" id="refLayerClearImage">Clear Image</div> <input id="refLayerSourceFile" type="file" accept="image/*" style="position: absolute; top: -50px; left: -100px"> </div> <div style="padding: 4px; text-align: center"> <table> <tr> <td> <canvas width="320" height="200" id="refImageCanvas" style="border:1px solid white; background-color: #393939"></canvas> </td> <td> <div style="padding-left: 8px" id="refImageParameters"> <div class="formRow"> <label for="refImageScale" class="controlLabel">Scale (%)</label> <div class="ui-button" id="refImageScaleDecrease">-</div> <input size="3" style="width: 40px" type="text" id="refImageScale" class="number" value="100"/> <div class="ui-button" id="refImageScaleIncrease">+</div> &nbsp; <div class="ui-button" id="refImageScaleToFit">Fit</div> </div> <div class="formRow"> <label class="controlLabel">Position</label> <label for="refImageX">X</label>: <input size="3" style="width: 35px" type="text" id="refImageX" class="number" value="0"/> &nbsp;&nbsp; <label for="refImageY">Y</label>: <input size="3" style="width: 35px" type="text" id="refImageY" class="number" value="0"/> </div> <div class="formRow"> <label class="controlLabel">Brightness</label> <input style="width: 100px" type="range" min="-100" max="100" value="0" size="3" id="refImageBrightness"/> <input type="text" style="width: 30px" id="refImageBrightnessValue" value="0" class="number" min="-100" max="100" size="2"/> </div> <div class="formRow"> <label class="controlLabel">Contrast</label> <input style="width: 100px" type="range" class="" min="-100" max="100" value="0" size="3" id="refImageContrast"/> <input type="text" class="number" style="width: 30px" min="-100" max="100" value="0" size="2" id="refImageContrastValue"/> </div> <div class="formRow"> <label class="controlLabel">Saturation</label> <input style="width: 100px" type="range" min="-100" max="100" value="0" id="refImageSaturation"/> <input style="width: 30px" type="text" class="number" min="-100" max="100" value="0" size="2" id="refImageSaturationValue"/> </div> </div> </td> </tr> </table> </div> <div> <h3>Colours</h3> <div class="formRow"> <label class="controlLabel">Colour Reduction:</label> <select id="refImageColorReduction" name="refImageColorReduction" style="width: 177px"> <option value="none">None</option> <option value="closest">Closest</option> <option value="dither">Dither</option> </select> </div> <div id="refImageDitherGroup"> <div class="formRow"> <label class="controlLabel">Dither Method:</label> <select name="refImageDither" id="refImageDither" style="width: 177px"> <option value="FloydSteinberg" selected="selected">Floyd Steinberg</option> <option value="Atkinson">Atkinson</option> <option value="Sierra">Sierra</option> <option value="TwoSierra">Two Sierra</option> <option value="Stucki">Stucki</option> <option value="Jarvis">Jarvis</option> <option value="Burkes">Burkes</option> </select> </div> </div> <div class="formRow" id="refImageUseColorsRow"> <label class="controlLabel">Use Colours:</label> <div class="radioGroup"> <select id="refImageUseColors" name="refImageUseColors" style="width: 177px"> <option value="all">All Colours</option> <option value="greyscale">Greyscale</option> <option value="choose">Custom Set</option> </select> <br/> <div style="padding: 4px; display: none" id="refImageChooseColorsRow"> <button id="refImageChooseColors" type="button">Choose Colours...</button> </div> <div id="refImageChooseColorsCount"> </div> </div> <div style="padding: 4px 0 2px 0"> <label class="cb-container">Limit Colours Per Cell <input type="checkbox" id="refImageLimitPerCell"> <span class="checkmark"></span> </label> </div> </div> </div> </div> ';g_htmlCache["html/textMode/exportTxt.html"]='<div class="panelFill dialogContent" id="exportTxtPanel" style="overflow: hidden;"> <div style="position: absolute; top: 10px; left: 10px; right: 10px; height: 30px;"> <div class="formGroup"> <label class="controlLabel" for="exportTxtAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportTxtAs"/> <div id="exportTxtDownload" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg"/> Download</div> </div> </div> <div style="position: absolute; top: 50px; left: 10px; right: 10px; bottom: 80px"> <div id="exportTxtSource" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0"></div> </div> <div style="position: absolute; bottom: 10px; height: 60px; left: 10px; right: 10px"> <div class="formGroup" style="display: inline-block"> <label class="controlLabel" for="exportTxtFromFrame">Frames:</label> <div style="display: inline-block"> <input type="text" size="2" class="number" min="1" id="exportTxtFromFrame"> &nbsp; <label for="exportTxtToFrame">To</label> &nbsp; <input type="text" size="2" class="number" min="1" id="exportTxtToFrame"> <label class="cb-container">Insert Frame Separator <input type="checkbox" id="exportTxtInsertFrameSeparator" class="exportTxtInsertFrameSeparator" checked="checked"/> <span class="checkmark"></span> </label> </div> </div> </div> </div> ';g_htmlCache["html/textMode/toolSettings.html"]='<div class="activeBackground panelFill" style="display: flex; align-items: center"> <div id="tileToolsOpenButtonHolder" style="display: inline-block; width: 20px;"> <div id="tileToolsOpenButton" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-halflings-131-chevron-right.svg"></div> </div> <div id="toolSettingsCurrentTileHolder"> <canvas id="toolSettingsCurrentTile"></canvas> </div> <div style="display: flex" id="drawToolSettings-tileOrientation"> <div class="ui-button ui-button-dark" data-label="Tile Flip X" title="Tile Flip X (F)" id="tileFlipH"><img src="icons/svg/glyphicons-basic-747-reflect-y.svg"></div> <div class="ui-button ui-button-dark" data-label="Tile Flip Y" title="Tile Flip Y (G)" id="tileFlipV"><img src="icons/svg/glyphicons-basic-748-reflect-x.svg"></div> <div class="ui-button ui-button-dark" data-label="Tile Rotate (R)" title="Tile Rotate (R)" id="tileRotate"><img src="icons/svg/glyphicons-basic-493-rotate.svg"></div> </div> <div id="drawToolSettings-cellColor" style="position: relative; width: 22px; height:30px; margin: 0 8px"> <div id="drawToolSettings-cellForegroundColor" class="foregroundColor colorSetting" style="position: absolute; z-index: 200; top:3px; left: 0; width: 16px; height: 16px; background-color: rgb(255, 255, 255);"></div> <div id="drawToolSettings-cellBackgroundColor" class="cellBackgroundColor colorSetting" style="display: block; position: absolute; z-index: 800; top: 9px; left: 8px; width: 16px; height: 16px; background-color: rgb(0, 0, 0); z-index: 5; background-image: none;"><i style="font-size: 18px; margin-left: 1px" class="halflings halflings-remove"></i></div> </div> <div id="drawToolSettings-frameColors" style=" position: relative; width: 50px; height: 30px"> <div style="display: block; position: absolute; top: 3px; left: 8px; width: 30px; height: 22px; background-color: rgb(112, 109, 235); z-index: 5; background-image: none;" id="borderColor" class="borderColor colorSetting"></div> <div style="display: block; position: absolute; top: 7px; left: 14px; width: 18px; height: 14px; background-color: rgb(46, 44, 155); z-index: 10; background-image: none;" id="backgroundColor" class="backgroundColor colorSetting"></div> </div> <div id="currentDrawToolHolder"> <div class="currentDrawTool" id="toolSettingsDrawTool" style="display: inline-block"><img width="20" src="icons/glyphicons-31-pencil@2x.png"></div> <div style="display: inline-block; width: 72px; margin-left: 4px; white-space: nowrap" id="toolSettingsCurrentTool"> Draw </div> </div> <div style="padding: 8px; display: flex; line-height: 24px; vertical-align: middle" id="drawToolSettings" class="toolSettings"> <div id="smartRect" style="display: inline-block; margin-right: 10px"> <label class="cb-container">Smart Rect <input type="checkbox" value="color" id="drawChangesSmartRect" name="drawChanges" checked="checked" class="checkbox"/> <span class="checkmark"></span> </label> </div> <div id="shapeFillSetting" style="display: inline-block"> <label class="cb-container">Filled <input type="checkbox" value="color" id="shapeFill" name="shapeFill" class="checkbox"/> <span class="checkmark"></span> </label> </div> <div style="display: inline-block" class="drawFillSettings"> <label class="cb-container">Contiguous Fill <input type="checkbox" value="color" id="contiguousFill" name="contiguousFill" checked="checked" class="checkbox"/> <span class="checkmark"></span> </label> </div> <div style="display: inline-block" class="drawAffects"> <div style="display: inline-block; color: #8b8b8b; margin-right: 12px"> Affects </div> </div> <div style="display: inline-block" class="drawAffects"> <label class="cb-container"> <input type="checkbox" value="color" id="drawChangesCharacter" name="drawChanges" checked="checked" class="checkbox"/> <span class="cb-label">Tile</span> <span class="checkmark"></span> </label> </div> <div style="display: inline-block" class="drawAffects"> <label class="cb-container"> <input type="checkbox" value="color" id="drawChangesColor" name="drawChanges" checked="checked" class="checkbox"/> <span class="cb-label">FG Colour</span> <span class="checkmark"></span> </label> </div> <div style="display: inline-block" id="drawTools-cellBgColor" class="drawAffects"> <label class="cb-container"> <input type="checkbox" value="bgColor" id="drawChangesBGColor" name="drawChanges" checked="checked" class="checkbox"/> <span class="cb-label">BG Colour</span> <span class="checkmark"></span> </label> </div> </div> <div style="padding: 8px; display: flex" id="selectToolSettings" class="toolSettings"> <label class="cb-container"> <input type="checkbox" value="1" id="pasteWhitespace" class="checkbox" checked="checked"/> <span class="cb-label">Paste Blank Tiles</span> <span class="checkmark"></span> </label> <label class="cb-container"> <input type="checkbox" value="1" id="pasteOnWhitespace" class="checkbox"/> <span class="cb-label">Paste Only On Blank Tiles</span> <span class="checkmark"></span> </label> </div> <div style="padding: 8px; display: inline-block" id="charPixelToolSettings" class="toolSettings"> <label class="rb-container" style="margin-right: 4px">Draw <input type="radio" name="charPixelToolMode" value="draw" checked="checked"> <span class="checkmark"/> </label> <label class="rb-container" style="margin-right: 4px">Erase <input type="radio" name="charPixelToolMode" value="erase"> <span class="checkmark"/> </label> </div> <div id="lineSegmentToolSettings" class="toolSettings"> <label class="rb-container" id="lineSegmentToolMode_horizontal"> <input type="radio" name="lineSegmentToolMode" value="horizontal" checked="checked"> <span class="rb-label">Horizontal (F)</span> <span class="checkmark"/> </label> <label class="rb-container" id="lineSegmentToolMode_vertical"> <input type="radio" name="lineSegmentToolMode" value="vertical"> <span class="rb-label">Vertical (G)</span> <span class="checkmark"/> </label> <label class="rb-container" id="lineSegmentToolMode_fromleft"> <input type="radio" name="lineSegmentToolMode" value="fromleft"> <span class="rb-label">From Left</span> <span class="checkmark"/> </label> <label class="rb-container" id="lineSegmentToolMode_fromright"> <input type="radio" name="lineSegmentToolMode" value="fromright"> <span class="rb-label">From Right</span> <span class="checkmark"/> </label> <label class="rb-container" id="lineSegmentToolMode_fromtop"> <input type="radio" name="lineSegmentToolMode" value="fromtop"> <span class="rb-label">From Top</span> <span class="checkmark"/> </label> <label class="rb-container" id="lineSegmentToolMode_frombottom"> <input type="radio" name="lineSegmentToolMode" value="frombottom"> <span class="rb-label">From Bottom</span> <span class="checkmark"/> </label> <label class="cb-container" style="margin-right: 4px"> <input type="checkbox" name="lineSegmentToolInvert" id="lineSegmentToolInvert" value="1"> <span class="cb-label">Invert</span> <span class="checkmark"/> </label> </div> <div style="padding: 8px; display: flex; line-height: 24px; vertical-align: middle;"> <div style="display: inline-block" id="drawTools-mirrorH"> <label class="cb-container"> <input type="checkbox" value="mirrorh" id="drawMirrorH" name="drawMirror" class="checkbox"/> <span class="cb-label">Mirror H</span> <span class="checkmark"></span> </label> </div> <div style="display: inline-block" id="drawTools-mirrorV"> <label class="cb-container"> <input type="checkbox" value="mirrorv" id="drawMirrorV" name="drawMirror" class="checkbox"/> <span class="cb-label">Mirror V</span> <span class="checkmark"></span> </label> </div> </div> <div style="padding: 0px; display: flex" id="pixelToolSettings" class="toolSettings"> <div style=" overflow: hidden; white-space: nowrap; display: flex; align-items: center "> <div id="pixelToolSettings_pixelTool" style="display: inline-block"> <div class="pixelTool pixelToolSelected" id="pixelTool_draw" data-toolType="draw"><img width="20" src="icons/glyphicons-31-pencil@2x.png"/></div> <div class="pixelTool" id="pixelTool_erase" data-toolType="erase"><img width="20" src="icons/glyphicons-551-erase@2x.png"/></div> <div class="pixelTool" id="pixelTool_eyedropper" data-toolType="eyedropper"><img width="20" src="icons/glyphicons-91-eyedropper@2x.png"/></div> <div class="pixelTool" id="pixelTool_line" data-toolType="line"><img width="20" src="icons/glyphicons-98-vector-path-line@2x.png"/></div> <div class="pixelTool" id="pixelTool_rect" data-toolType="rect"><img width="20" src="icons/glyphicons-100-vector-path-all@2x.png"/></div> <div class="pixelTool" id="pixelTool_oval" data-toolType="oval"><img width="20" src="icons/glyphicons-96-vector-path-circle@2x.png"/></div> <div class="pixelTool" id="pixelTool_fill" data-toolType="fill"><img width="20" src="icons/svg/glyphicons-basic-245-fill.svg"/></div> <div style="display: inline-block" id="pixelToolLabel"></div> </div> <span style="margin: 0px 6px 0 0 " id="pixelToolSettings-colorLabel">Colour:</span> <div id="pixelToolSettings-c64multicolor" style="display: inline-block"></div> <div id="pixelToolSettings-nes" style="display: inline-block"> <div id="pixelToolSettings-nescolors"> <div data-index="0" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="pixelToolSubPaletteColor colorSubPaletteColor0Display colorSubPaletteColor0" id="pixelToolSettingsSubPaletteColor-0"></div> &nbsp;&nbsp; <div data-index="1" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="pixelToolSubPaletteColor colorSubPalette1Display colorSubPaletteColor1" id="pixelToolSettingsSubPaletteColor-1"></div> &nbsp;&nbsp; <div data-index="2" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="pixelToolSubPaletteColor colorSubPalette2Display colorSubPaletteColor2" id="pixelToolSettingsSubPaletteColor-2"></div> &nbsp;&nbsp; <div data-index="3" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="pixelToolSubPaletteColor colorSubPalette3Display colorSubPaletteColor3" id="pixelToolSettingsSubPaletteColor-3"></div> </div> </div> <div id="pixelToolSettings-multicolor" style="display: inline-block"> <label><div class="pixelToolSettingColor currentCellColorDisplay" id="pixelToolMulticolor"></div></label> &nbsp; </div> </div> </div> <div id="pixelDrawSettings" style="padding: 0px; display: none"> <div class="ui-button" data-label="Flip X" id="spriteFlipH"><img src="icons/svg/glyphicons-basic-747-reflect-y.svg"/></div> <div class="ui-button" data-label="Flip Y" id="spriteFlipV"><img src="icons/svg/glyphicons-basic-748-reflect-x.svg"/></div> <div class="ui-button" data-label="Rotate" id="spriteRotate"><img src="icons/svg/glyphicons-basic-493-rotate.svg"/></div> <div class="ui-button" data-label="Invert" id="spriteInvert"><img src="icons/svg/glyphicons-basic-543-star-half.svg"/></div> <div id="pixelShapeFillSetting" style="display: inline-block" class="toolSettings"> <label class="cb-container">Filled <input type="checkbox" value="color" id="pixelShapeFill" name="pixelShapeFill" class="checkbox"/> <span class="checkmark"></span> </label> </div> </div> </div>';g_htmlCache["html/textMode/blockSizeDialog.html"]='<div id="blockSizeDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="settingsBlockWidth">MetaTile Width:</label> <input type="text" class="formControl number" min="1" id="settingsBlockWidth" size="4"/> </div> <div class="formGroup"> <label class="controlLabel" for="settingsBlockHeight">MetaTile Height:</label> <input type="text" class="formControl number" min="1" id="settingsBlockHeight" size="4"/> </div> <div class="formGroup" id="settingsBlockColorModeContainer"> <label class="controlLabel" for="settingsBlockColourMode">Colour Mode:</label> <select id="settingsBlockColorMode"> <option value="character">Colour Per Tile</option> <option value="block">Colour Per MetaTile</option> </select> </div> </div> ';g_htmlCache["html/textMode/layers.html"]='<div class="activeBackground panelFill" style="border-left: 1px solid #333333"> <div class="title" style="background-color: #111111; height: 18px"> <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap"> Layers </div> </div> <div style="background-color: #222222; margin: 10px; position: absolute; top: 22px; bottom: 10px; left:0; right: 0; overflow-y: auto; overflow-x: hidden" id="layersHolder"></div> </div> ';g_htmlCache["html/textMode/exportMega65Assembly.html"]='<div class="panelFill dialogContent" id="exportMega65AssemblyPanel" style="overflow: hidden;"> <div style="position: absolute; top: 10px; left: 10px; right: 10px; height: 30px;"> <div class="formGroup"> <label class="controlLabel" for="exportMega65AssemblyAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportMega65AssemblyAs"/> <div id="exportMega65AssemblyDownload" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg"/> Download</div> </div> </div> <div style="position: absolute; top: 50px; left: 10px; right: 10px; bottom: 100px"> <div id="exportMega65AssemblySource" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0"></div> </div> <div style="position: absolute; bottom: 10px; height: 80px; left: 10px; right: 10px"> <div> <div class="formGroup" style="display: inline-block"> <label class="rb-container">ACME <input type="radio" class="formControl" size="20" value="acme" checked="checked" name="exportMega65AssemblyFormat" id="exportMega65AssemblyFormatAcme"/> <span class="checkmark"></span> </label> <label class="rb-container">Kick Ass <input type="radio" class="formControl" size="20" value="kickass" name="exportMega65AssemblyFormat" id="exportMega65AssemblyFormatKickAss"/> <span class="checkmark"></span> </label> <label class="rb-container">CA65 <input type="radio" class="formControl" size="20" value="ca65" name="exportMega65AssemblyFormat" id="exportMega65AssemblyFormatCA65"/> <span class="checkmark"></span> </label> <label class="rb-container">TASS <input type="radio" class="formControl" size="20" value="tass" name="exportMega65AssemblyFormat" id="exportMega65AssemblyFormatTASS"/> <span class="checkmark"></span> </label> </div> <div class="formGroup" style="display: inline-block"> <label class="controlLabel" for="exportMega65AssemblyNumberFormat">Number Format:</label> <div style="display: inline-block"> <label class="rb-container">Hex <input type="radio" class="formControl" size="20" value="hex" checked="checked" name="exportMega65NumberFormat" id="exportMega65AssemblyNumberFormatHex"/> <span class="checkmark"></span> </label> <label class="rb-container">Dec <input type="radio" class="formControl" size="20" value="dec" name="exportMega65NumberFormat" id="exportMega65AssemblyNumberFormatDec"/> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup" style="display: inline-block"> <label class="controlLabel" for="exportMega65AssemblyFromFrame">Frames:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="exportMega65AssemblyFromFrame"> &nbsp; <label for="exportMega65AssemblyToFrame">To</label> &nbsp; <input type="number" size="2" class="number" min="1" id="exportMega65AssemblyToFrame"> </div> </div> </div> <div class="formGroup"> <div class="checkboxGroup"> <label class="cb-container">Character Set Data <input type="checkbox" id="exportMega65AssemblyCharactersetData" class="exportMega65AssemblyInclude" checked="checked"/> <span class="checkmark"></span> </label> <div id="exportMega65AssemblyColorDataHolder" style="display: inline-block"> <label class="cb-container">Character Attribute Data <input type="checkbox" id="exportMega65AssemblyColorData" class="exportMega65AssemblyInclude" checked="checked"/> <span class="checkmark"></span> </label> </div> <div id="exportMega65AssemblyBlockDataHolder" style="display: inline-block"> <label class="cb-container">MetaTile Data <input type="checkbox" id="exportMega65AssemblyBlockData" class="exportMega65AssemblyInclude" checked="checked"/> <span class="checkmark"></span> </label> </div> <div id="exportMega65AssemblyBlockColorDataHolder" style="display: inline-block"> <label class="cb-container">Block Colour Data <input type="checkbox" id="exportMega65AssemblyBlockColorData" class="exportMega65AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportMega65AssemblyMapDataHolder" style="display: inline-block"> <label class="cb-container">Map Character Data <input type="checkbox" id="exportMega65AssemblyMapData" class="exportMega65AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportMega65AssemblyBlockMapDataHolder" style="display: inline-block"> <label class="cb-container">Map Block Data <input type="checkbox" id="exportMega65AssemblyBlockMapData" class="exportMega65AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportMega65AssemblyMapColorDataHolder" style="display: inline-block"> <label class="cb-container">Map Colour Data <input type="checkbox" id="exportMega65AssemblyMapColorData" class="exportMega65AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel">Layers:</label> <div class="radioGroup"> <label class="rb-container">Current Layer <input type="radio" name="exportMega65AssemblyLayer" id="exportMega65AssemblyLayerCurrent" value="current" checked="checked"/> <span class="checkmark"></span> </label> </div> </div> </div> </div> ';g_htmlCache["html/textMode/exportImageFrames.html"]='<div class="panelFill" id="exportImageFramesPanel"> <div style="position: absolute; top: 0; bottom: 0; right: 0; left: 0px; padding: 10px; overflow: auto"> <div class="exportImageGIFParameters"> <h3><i class="halflings halflings-film"></i>&nbsp;Frames</h3> <div id="exportImageFrames"> <div class="formGroup"> <label class="controlLabel" for="exportImageFromFrame" style="width: 50px">Frames:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="exportImageFromFrame" style="width: 30px"> &nbsp; <label for="exportImageToFrame">To</label> &nbsp; <input type="number" size="2" class="number" min="1" id="exportImageToFrame" style="width: 30px"> </div> <select name="exportImageLoopType" id="exportImageLoopType"> <option value="loop">Loop</option> <option value="pingpong">Ping Pong</option> </select> </div> <div class="formGroup"> <label class="controlLabel" style="width: 50px">Speed:</label> <select name="exportImageSpeed" id="exportImageSpeed"> <option value="1">100%</option> <option value="2">200%</option> <option value="3">300%</option> <option value="4">400%</option> <option value="custom">Custom</option> </select> </div> <div class="formGroup" id="exportImageCustomSpeed" style="display: none"> <label class="controlLabel">Custom speed:</label> <div style="display: inline-block"> <input type="number" size="3" class="number" min="5" value="10" id="exportImageMSPerTick"/> ms per tick </div> </div> </div> </div> <div class="exportImagePNGParameters"> <h3><i class="halflings halflings-film"></i>&nbsp;Frame</h3> <div class="exportImageFrameHolder"> <div class="formGroup"> <label class="controlLabel" for="exportImageFromFrame" style="width: 50px">Frame:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="exportImageFrame" style="width: 30px" value="1"/> </div> </div> </div> </div> </div> </div>';g_htmlCache["html/textMode/blockEditorTools.html"]='<div id="blockEditorTools" class="panelFill dialogContent" style="color: white; overflow: auto"> <div> <h3>Tool</h3> <div class="blockEditTool blockEditToolSelected" id="blockEditTool_pen"><img width="20" src="icons/glyphicons-31-pencil@2x.png"/></div> <div class="blockEditTool" id="blockEditTool_eyedropper"><img width="20" src="icons/glyphicons-91-eyedropper@2x.png"/></div> <div class="blockEditTool" id="blockEditTool_pixel"><img width="20" src="icons/pixel.png"/></div> <div id="currentBlockEditTool"></div> </div> <div id="blockEditorColorOptions" style="margin-top: 10px"> <h3>MetaTile Colour Options</h3> <div> <label><input type="radio" name="blockEditColorSetting" id="blockEditColorSetting_none" value="none" checked="checked">MetaTile will use current cell colour</label> </div> <div> <label><input type="radio" name="blockEditColorSetting" id="blockEditColorSetting_perecell" value="percell">Colour per block cell</label> </div> <div> <label><input type="radio" name="blockEditColorSetting" id="blockEditColorSetting_perblock" value="perblock">Colour per block</label> </div> </div> <div id="blockEditorColorSelection" style="margin-top: 10px"> <h3>Cell Colour</h3> <div style="position: relative"> <div style="background-color: rgb(114, 97, 216); display: block; position: absolute; top: 4px; left: 8px; width: 28px; height: 28px; background-color: #000000; z-index: 10;" id="blockEditForegroundColor" class="colorSetting"></div> <div style="display: block; position: absolute; top: 18px; left: 22px; width: 28px; height: 28px; background-color: rgb(0, 0, 0); z-index: 5; background-image: none;" id="blockEditBackgroundColor" class="colorSetting"><i style="font-size: 28px; margin-top: -1px" class="halflings halflings-remove"></i></div> </div> </div> <div id="blockPixelEditColor" style="margin-top: 10px"> <h3>Pixel Colour</h3> <div id="blockEditorC64PixelColors" style=" margin: 4px"> </div> <div style="display: inline-block; width: 18px; height: 18px; background-color: #000000; border: 1px solid #dddddd" class="" id="blockEditorMulticolorPixelColor"></div> </div> </div>';g_htmlCache["html/textMode/export3dAsGif.html"]='<div class="panelFill" id="export3dGifPanel"> <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0px; overflow: auto; padding: 10px"> <div class="formGroup"> <label class="controlLabel" for="export3dGIFAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="export3dGIFAs"/> </div> <div class="formGroup"> <label class="controlLabel" for="export3dGIFFormat">Format:</label> <label class="rb-container">GIF <input type="radio" name="exportGIFFormat" value="gif" checked="checked"> <span class="checkmark"></span> </label> <label class="rb-container">PNG <input type="radio" name="exportGIFFormat" value="png"> <span class="checkmark"></span> </label> </div> <div class="formGroup"> <label class="controlLabel" for="export3dGIFShorten"></label> <label class="cb-container">Shorten last frame (for Twitter looped GIFs) <input type="checkbox" name="exportGIFShorten" id="export3dGIFShorten" value="gif" checked="checked"> <span class="checkmark"></span> </label> </div> </div> </div> ';g_htmlCache["html/textMode/drawToolsSvg.html"]='<div class="activeBackground panelFill" id="toolsPanel" style="border-right: 1px solid #555555"> <div class="title" style="background-color: #111111; height: 18px;"> <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap"> Tools </div> </div> <div id="toolIconHolder" style="padding: 8px"> <div> <div class="drawTool drawToolSelected" id="drawTool_pen"><img src="icons/svg/glyphicons-basic-31-pencil.svg"/></div> <div class="drawTool" id="drawTool_erase"><img src="icons/svg/glyphicons-basic-250-eraser.svg"/></div> <div class="drawTool" id="drawTool_fill"><img src="icons/svg/glyphicons-basic-245-fill.svg"/></div> <div class="drawTool" id="drawTool_eyedropper"><img src="icons/svg/glyphicons-basic-91-eyedropper.svg"/></div> </div> <div> <div class="drawTool" id="drawTool_line"><img width="20" src="icons/svg/slash.svg"/></div> <div class="drawTool" id="drawTool_rect"><img width="20" src="icons/svg/square.svg"/></div> <div class="drawTool" id="drawTool_oval"><img width="20" src="icons/svg/circle.svg"/></div> <div class="drawTool" id="drawTool_select"><img width="20" src="icons/glyphicons-100-vector-path-select@2x.png"/></div> <div class="drawTool" id="drawTool_charpixel"><img width="20" src="icons/charpixel.png"/></div> <div class="drawTool" id="drawTool_type"><img width="20" src="icons/glyphicons-104-text@2x.png"/></div> <div class="drawTool" id="drawTool_pixel"><img width="20" src="icons/pixel.png"/></div> <div class="drawTool" id="drawTool_block"><img width="20" src="icons/glyphicons-156-show-big-thumbnails@2x.png"/></div> <div class="drawTool" id="drawTool_zoom"><img width="20" src="icons/glyphicons-28-search@2x.png"/></div> <div class="drawTool" id="drawTool_hand"><img src="icons/svg/glyphicons-basic-457-hand-open.svg"/></div> <div class="drawTool" id="drawTool_move"><img src="icons/svg/arrows-alt.svg"/></div> </div> <div id="currentTool" style="font-size: 8px; margin-top: 2px">draw</div> </div> <div id="drawTools-cellColor" style="position: relative; padding: 0px 8px 0px 8px; height: 68px"> <h3 id="drawTools-cellColorHeading" style="font-size: 10px; padding-bottom: 2px">Cell</h3> <div style="" id="cellForegroundColor" class="foregroundColor colorSetting"></div> <div style="display: block; position: absolute; top: 34px; left: 22px; width: 28px; height: 28px; background-color: #000000; z-index: 5;" id="cellBackgroundColor" class="cellBackgroundColor colorSetting"></div> </div> <div id="drawTools-c64multicolor" style="padding: 0px 8px 0px 8px; display: none"> <h3 style="font-size: 10px; padding-bottom: 2px">Multi</h3> <div> <div style="display: inline-block; width: 24px; height: 24px; background-color: #000000;" id="c64Multi1Color" class="c64Multi1Color colorSetting"></div> <div style="display: inline-block; width: 24px; height: 24px; background-color: #000000;" id="c64Multi2Color" class="c64Multi2Color colorSetting"></div> </div> </div> <div style="position: relative; display: none; padding: 0px 8px 0px 8px; height: 260px;" id="drawTools-nesColors"> <h3 style="font-size: 10px; padding-bottom: 2px">Palette</h3> <div style="position: relative; width: 54px; height: 16px; background-color: #000000; border: 1px solid #aaaaaa; z-index: 5" id="nesPalette" class="nesPalette"> <div class="nesSelectedPaletteName" style="font-size: 8px; position: absolute; top: 2px; left: 14px">Palette 0</div> </div> <div style="margin-top: 4px"> <div style="font-size: 8px">Colour 0</div> <div style="display: block; margin-top: 2px; width: 24px; height: 24px; background-color: #000000; border: 1px solid #aaaaaa" id="nesColor0" class="nesColor nesColor0" data-paletteIndex="0"></div> </div> <div style="margin-top: 4px"> <div style="font-size: 8px">Colour 1</div> <div style="display: block; margin-top: 2px; width: 24px; height: 24px; background-color: #000000; border: 1px solid #aaaaaa" id="nesColor1" class="nesColor nesColor1" data-paletteIndex="1"></div> </div> <div style="margin-top: 4px"> <div style="font-size: 8px">Colour 2</div> <div style="display: block; margin-top: 2px; width: 24px; height: 24px; background-color: #000000; border: 1px solid #aaaaaa" id="nesColor2" class="nesColor nesColor2" data-paletteIndex="2"></div> </div> <div style="margin-top: 4px"> <div style="font-size: 8px">Colour 3</div> <div style="display: block; margin-top: 2px; width: 24px; height: 24px; background-color: #000000; border: 1px solid #aaaaaa" id="nesColor3" class="nesColor nesColor3" data-paletteIndex="3"></div> </div> </div> <div id="drawTools-frameColors" style="padding: 0px 8px 0px 8px; position: relative; height: 66px"> <h3 style="font-size: 10px; padding-bottom: 2px">Frame</h3> <div style="display: block; position: absolute; top: 20px; left: 8px; width: 56px; height: 46px; background-color: #000000; z-index: 5" id="borderColor" class="borderColor colorSetting"></div> <div style="display: block; position: absolute; top: 30px; left: 18px; width: 36px; height: 26px; background-color: #000000; z-index: 10" id="backgroundColor" class="backgroundColor colorSetting"></div> </div> </div> ';g_htmlCache["html/textMode/toPrg.html"]='<div class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="exportPRGAs">File name:</label> <input class="formControl" type="text" size="20" value="" id="exportPRGAs"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportPRGAs">Type:</label> <div class="radioGroup"> <select name="exportPRGType" id="exportPRGType"> <option value="prg">PRG</option> <option value="d64">D64</option> </select> </div> </div> <div id="exportPRGD64Options" style="display: none"> <div class="formGroup"> <label class="controlLabel" for="exportPRGDiskName">Disk Name:</label> <input class="formControl" type="text" size="20" value="Untitled" id="exportPRGDiskName"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportPRGName">PRG Name:</label> <input class="formControl" type="text" size="20" value="Untitled" id="exportPRGName"/> </div> </div> <div class="formGroup"> <label class="controlLabel">Screen Mode:</label> <div class="checkboxGroup" style="padding-top: 6px"> <label class="rb-container" style="color: #eeeeee; font-size: 12px">Standard Character Mode <input type="radio" name="exportPRGColorMode" id="exportPRGColorModeStandard" value="standard" checked="checked"> <span class="checkmark"></span> </label> <div style="margin-left: 24px; color: #aaaaaa">256 characters, foreground colour per cell, background colour per frame</div> <br/> <label class="rb-container" style="color: #eeeeee; font-size: 12px">Multicolour Character Mode <input type="radio" name="exportPRGColorMode" id="exportPRGColorModeMulticolor" value="multicolor"> <span class="checkmark"></span> </label> <div style="margin-left: 24px; color: #aaaaaa">256 characters, 3 colours per cell, background colour per frame</div> <br/> <label class="rb-container" style="color: #eeeeee; font-size: 12px">Extended Background Colour Mode <input type="radio" name="exportPRGColorMode" id="exportPRGColorModeExtended" value="extended"/> <span class="checkmark"></span> </label> <div style="margin-left: 24px; color: #aaaaaa">64 characters, foreground colour per cell, background colour per cell, <br/>up to 4 different cell background colours</div> <br/> <label class="rb-container" style="color: #eeeeee; font-size: 12px">Monochrome <input type="radio" name="exportPRGColorMode" id="exportPRGColorModeMonochrome" value="monochrome"/> <span class="checkmark"></span> </label> <div style="margin-left: 24px; color: #aaaaaa">256 characters, one foreground colour, one background colour per frame</div> </div> <div class="formGroup" id="exportPRGMonochromeSection" style="display: none"> <label class="controlLabel"></label> <div class="checkboxGroup"> Monochrome Colour: <div id="exportPRGMonochromeColor" style="display: inline-block; width: 16px; height: 16px; border: 1px solid white"></div> </div> </div> </div> <div class="formGroup"> <label class="controlLabel" for="exportPRGFromFrame">Export Frames:</label> <div style="display: inline-block"> <input size="2" class="number" min="1" id="exportPRGFromFrame"> &nbsp; <label for="exportPRGToFrame">To</label> &nbsp; <input size="2" class="number" min="1" id="exportPRGToFrame"> &nbsp; <select name="exportPRGLoopType" id="exportPRGLoopType"> <option value="loop">Loop</option> <option value="pingpong">Ping Pong</option> </select> </div> </div> <div class="formGroup"> <label class="controlLabel">Music Options:</label> <div class="radioGroup"> <select name="exportPRGMusic" id="exportPRGMusic"> </select> <div style="margin-top: 8px; display: none" id="exportPRGSidFileSection"> <label for="exportPRGSIDFile">SID File</label> <input type="file" id="exportPRGSIDFile"> <div>SIDs may or may not work</div> <div>SIDs with a load address around $1000 will mostly work..</div> <div id="exportPRGSIDFileInfo"> </div> </div> </div> </div> </div> ';g_htmlCache["html/textMode/mobileMenu.html"]='<div id="mobileMenu" class="panelFill activeBackground"> <div> <div class="mobileMenuItem" data-value="dimensions">Dimensions</div> <div class="mobileMenuItem" data-value="screenmode">Screen Mode</div> <div class="mobileMenuItem" data-value="tilesetpreset">Tile Set</div> <div class="mobileMenuItem" data-value="colorpalettepreset">Colour Palette</div> </div> <div> <div class="mobileMenuItem" data-value="save">Save</div> <div class="mobileMenuItem" data-value="download">Download</div> <div class="mobileMenuItem" data-value="exportpng">Export PNG</div> </div> <div> <div class="mobileMenuItem" data-value="importimage">Import Image</div> </div> <div> <div class="mobileMenuItem" data-value="desktopview">Desktop Mode</div> </div> </div>';g_htmlCache["html/textMode/exportImagePreview.html"]='<div class="panelFill"> <div style="position: absolute; left: 10px; top: 10px;"> <div style="display: inline-block" id="exportImageSize"></div> </div> <div style="position: absolute; top: 10px; left: 10px; right: 10px; bottom: 46px" id="exportImagePreviewHolder"> <canvas id="exportImagePreview" style="border: 1px solid #222222;"></canvas> </div> <div style="position: absolute; left: 10px; right: 10px; bottom: 10px; display: flex; align-items: center"> <label class="controlLabel" for="imageExportPreviewScale">Preview&nbsp;Scale</label> <input id="imageExportPreviewScale" type="range" min="1" max="2500" value="50" size="3"> <input id="imageExportPreviewScaleText" class="number" type="text" style="width: 30px; margin: 0px 4px" min="1" max="1500" value="100" size="2"> <div class="ui-button" type="button" id="imageExportPreviewScaleReset">100%</div> </div> </div> ';g_htmlCache["html/textMode/exportCharPad.html"]='<div class="panelFill dialogContent" id="exportCharPadPanel"> <div class="formGroup"> <label class="controlLabel" for="exportCharPadAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportCharPadAs"/> </div> </div> ';g_htmlCache["html/textMode/exportGifEffects.html"]='<div class="panelFill" id="exportGifEffectsPanel"> <div style="position: absolute; top: 0; bottom: 0; right: 0; left: 0px; padding: 10px; overflow: auto"> <h3><i class="halflings halflings-star-empty"></i>&nbsp;Effects</h3> <div id="exportGIFEffects"> </div> </div> </div>';g_htmlCache["html/textMode/exportPetsciiC.html"]='<div class="panelFill dialogContent" id="exportPetsciiCPanel"> <div class="formGroup"> <label class="controlLabel" for="exportPetsciiCAs">File name:</label> <input type="text" class="formControl" size="20" value="untitled" id="exportPetsciiCAs"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportPetsciiCAsVariableName">Variable name:</label> <input type="text" class="formControl" size="20" value="frame" id="exportPetsciiCAsVariableName"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportPetsciiCFromFrame">Export Frames:</label> <div style="display: inline-block"> <input type="text" size="2" class="number" min="1" id="exportPetsciiCFromFrame"> &nbsp; <label for="exportPetsciiCToFrame">To</label> &nbsp; <input type="text" size="2" class="number" min="1" id="exportPetsciiCToFrame"> </div> </div> <div class="formGroup"> <label class="controlLabel" for=""></label> The current layer will be exported </div> </div> ';g_htmlCache["html/textMode/pixelDrawTools.html"]='<div class="activeBackground panelFill" id="toolsPanel"> <div class="title" style="background-color: #111111; height: 18px;"> <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 10px; overflow: hidden; white-space: nowrap"> Pixel Tools </div> </div> <div id="toolIconHolder" style="padding: 8px"> <div> <div class="pixelDrawTool pixelDrawToolSelected" id="pixelDrawTool_pen"><img width="20" src="icons/pen@2x.png" title="Pen (n)"/></div> <div class="pixelDrawTool" id="pixelDrawTool_erase"><img width="20" src="icons/erase@2x.png" title="Blank (l)"/></div> <div class="pixelDrawTool" id="pixelDrawTool_fill"><img width="20" src="icons/fill@2x.png" title="Fill Bucket (k)"/></div> <div class="pixelDrawTool" id="pixelDrawTool_eyedropper"><img width="20" src="icons/eyedropper@2x.png"/></div> <div class="pixelDrawTool" id="pixelDrawTool_line"><img width="20" src="icons/line@2x.png" title="Line (u)"/></div> <div class="pixelDrawTool" id="pixelDrawTool_rect"><img width="20" src="icons/rect@2x.png" title="Rect (u)"/></div> <div class="pixelDrawTool" id="pixelDrawTool_oval"><img width="20" src="icons/oval@2x.png" title="Oval (u)"/></div> <div class="pixelDrawTool" id="pixelDrawTool_select"><img width="20" src="icons/select@2x.png" title="Marquee (m)"/></div> <div class="pixelDrawTool" id="pixelDrawTool_zoom"><img width="20" src="icons/zoom@2x.png" title="Zoom (z)"/></div> <div class="pixelDrawTool" id="pixelDrawTool_hand"><img width="20" src="icons/hand@2x.png" title="Hand (h)"/></div> <div class="pixelDrawTool" id="pixelDrawTool_move"><img width="20" src="icons/move@2x.png" title="Move (v)"/></div> </div> <div id="currentPixelDrawTool" style="font-size: 8px; margin-top: 2px">draw</div> </div> <style> .pixelDrawToolsColor { background-color: transparent; /* #444444; */ border: 1px solie #222222; padding: 3px; margin-bottom: 6px; text-align: center; } .pixelDrawToolsColor:hover { background-color: #333333; } /* .pixelDrawToolsColor:hover h3 { color: #999999; } */ .pixelDrawToolsColor h3 { color: #666666; border-bottom: 1px solid #333333; } .pixelDrawToolsColorSelected { background-color: #292929; } .pixelDrawToolsColorSelected h3 { color: #c7c7c7; border-bottom: 1px solid #999999; } </style> <div id="pixelDrawTools-colors" style="padding: 0px 8px 0px 8px;"> <div class="pixelDrawToolsColor" id="pixelDrawToolsColor-background" data-type="background"> <h3 style="font-size: 9px; padding-bottom: 2px">Background</h3> <div> <div style="display: inline-block; width: 24px; height: 24px; background-color: #000000;" data-type="background" id="pixelC64Transparent" class="backgroundColor colorSetting"></div> </div> </div> <div class="pixelDrawToolsColor pixelDrawToolsColorSelected" id="pixelDrawToolsColor-cell" data-type="cell"> <h3 style="font-size: 9px; padding-bottom: 2px">Individual</h3> <div> <div style="display: inline-block; width: 24px; height: 24px; background-color: #000000;" data-type="cell" id="pixelC64Individual" class="foregroundColor colorSetting"></div> </div> </div> <div id="pixelDrawTools-c64multicolor"> <div class="pixelDrawToolsColor" id="pixelDrawToolsColor-multi1" data-type="multi1"> <h3 style="font-size: 9px; padding-bottom: 2px">Multi 1</h3> <div> <div style="display: inline-block; width: 24px; height: 24px; background-color: #000000;" data-type="multi1" id="pixelC64Multi1Color" class="c64Multi1Color colorSetting"></div> </div> </div> <div class="pixelDrawToolsColor" id="pixelDrawToolsColor-multi2" data-type="multi2"> <h3 style="font-size: 9px; padding-bottom: 2px">Multi 2</h3> <div> <div style="display: inline-block; width: 24px; height: 24px; background-color: #000000;" data-type="multi2" id="pixelC64Multi2Color" class="c64Multi2Color colorSetting"></div> </div> </div> </div> <div id="pixelDrawTools-nes"> nes colours </div> <div id="pixelDrawTools-indexed"> </div> </div> </div> ';g_htmlCache["html/textMode/colorEditor.html"]='<div class="activeBackground panelFill" style="color: white;"> <div class="title" style="background-color: #111111; height: 18px"> <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap"> Colour Editor </div> <div style="position: absolute; top: 2px; right: 2px; width: 20px"> <div id="colorEditorCloseButton" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div> </div> </div> <div id="colorEditorTabPanel"> <div class="colorEditorTab" id="colorEditorTab-rgb" data-colortype="rgb"> RGB </div> <div class="colorEditorTab colorEditorTabActive" id="colorEditorTab-hsv" data-colortype="hsv"> HSV </div> </div> <div id="colorEditorRGB" class="colorEditorPanel" style="display: none"> <div> <div class="colorComponentSelector"> <label for="editColorR">R:</label> <canvas width="260" height="34" id="editColorRCanvas" class="colorEditorSlider" data-component="r"></canvas> <input type="number" class="number colorEditorNumber" size="4" id="editColorR" data-component="r" min="0" max="255" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorG">G</label> <canvas width="260" height="34" id="editColorGCanvas" class="colorEditorSlider" data-component="g"></canvas> <input type="number" class="number colorEditorNumber" size="4" id="editColorG" data-component="g" min="0" max="255" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorB">B</label> <canvas width="260" height="34" id="editColorBCanvas" class="colorEditorSlider" data-component="b"></canvas> <input type="number" class="number colorEditorNumber" size="4" id="editColorB" data-component="b" min="0" max="255" value="0"> </div> </div> </div> <div id="colorEditorHSV" class="colorEditorPanel"> <div class="colorComponentSelector"> <label for="editColorH">H</label> <canvas width="260" height="34" id="editColorHCanvas" class="colorEditorSlider" data-component="h"></canvas> <input type="number" class="number colorEditorNumber" size="4" id="editColorH" data-component="h" min="0" max="360" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorS">S</label> <canvas width="260" height="34" id="editColorSCanvas" class="colorEditorSlider" data-component="s"></canvas> <input type="number" class="number colorEditorNumber" size="4" id="editColorS" data-component="s" min="0" max="100" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorB">V</label> <canvas width="260" height="34" id="editColorVCanvas" class="colorEditorSlider" data-component="v"></canvas> <input type="number" class="number colorEditorNumber" size="4" id="editColorV" data-component="v" min="0" max="100" value="0"> </div> </div> #<input type="text" maxlength="6" size="6" id="editColorHex"/> </div> ';g_htmlCache["html/textMode/exportSpritePad.html"]='<div class="panelFill dialogContent" id="exportSpritePadPanel"> <div class="formGroup"> <label class="controlLabel" for="exportSpritePadAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportSpritePadAs"/> </div> </div> ';g_htmlCache["html/textMode/colorPaletteChoosePresetMobile.html"]='<div class="panelFill"> <div style="position: absolute; left: 0px; top: 0px; bottom: 30px; right: 0; overflow: auto"> <div id="chooseColorPaletteMobileHolderA" style="position: absolute; left: 0; width: 300px; top: 0; bottom: 0px"> <div style="margin: 14px"> <h3 id="chooseColorPaletteMobileHeadingA"></h3> <div style="text-align: left"> <canvas id="chooseColorPaletteMobileCanvasA" width="256" height="256" style="background-color: #222222"></canvas> </div> <div id="chooseColorPaletteMobileOptionsA" style="background-color: #222222; position: absolute; left: 0; right: 0; bottom: 0; top: 360px; overflow-y: auto"></div> </div> </div> <div id="chooseColorPaletteMobileHolderB" style=" position: absolute; left: 0; width: 300px; top: 0; bottom: 0px"> <div style="margin: 14px"> <h3 id="chooseColorPaletteMobileHeadingB"></h3> <div style="text-align: left"> <canvas id="chooseColorPaletteMobileCanvasB" width="256" height="256" style="background-color: #222222"></canvas> </div> <div id="chooseColorPaletteMobileOptionsB" style="background-color: #222222; position: absolute; left: 0; right: 0; bottom: 0; top: 360px; overflow-y: auto"></div> </div> </div> </div> <div style="position: absolute; left: 0px; right: 0px; bottom: 0px; height: 50px; background-color: #222222; display: flex; align-items: center; padding: 10px 4px 10px 4px"> <div class="ui-button" id="chooseColorPaletteMobilePrev" style="flex-grow: 1; margin-right: 4px"><i class="halflings halflings-chevron-left"></i></div> <select id="colorPaletteChoosePresetMobileList" style="flex-grow: 1"> </select> <div class="ui-button" id="chooseColorPaletteMobileNext" style="flex-grow: 1; margin-left: 4px"><i class="halflings halflings-chevron-right"></i></div> </div> </div>';g_htmlCache["html/textMode/importImageMobile.html"]='<div class="panelFill" id="importImageMobilePanel"> <div class="content"> <div style="position: absolute; top: 0; left: 0; right: 0; height: 280px; background-color: #111111; border-bottom: 1px solid #555555; padding: 6px" id="importImageSourceContainer"> <div style="margin: 8px 0 14px 0"> <form id="importImageMobileForm"> <label class="controlLabel" for="importImageMobileSourceFile">Import:</label> <div class="ui-button" id="importImageMobileChooseFile">Choose Image / Video</div> <input class="formControl" id="importImageMobileSourceFile" style="position: absolute; top: -50px; left: -100px" type="file" accept="image/*,video/*"/> </form> </div> <div style="text-align: center; margin-bottom: 10px"> <canvas width="320" height="200" id="importImageMobileCanvas" style="border:1px solid white; background: transparent"></canvas> </div> <div style="padding: 0px 0 0px 0" class="importImageMobileVideoSetting"> <canvas id="importImageVideoRangeMobile" style="width: 100%; height: 18px;" height="18" style="cursor: default"></canvas> </div> </div> <div style="position: absolute; top: 292px; left: 0; right: 0; bottom: 0; overflow: auto; padding: 6px; display: none" id="importImageControlsContainer"> <div class="formRow"> <label class="controlLabel">Scale %</label> <input type="text" style="width: 40px" id="importImageMobileScaleValue" value="0" class="number" min="1" max="500" size="2"/> <div class="rangeHolder"> <input type="range" class="range" min="1" max="500" value="0" id="importImageMobileScale"/> </div> <div class="ui-button rangeButton" id="importImageMobileScaleToFit">Fit</div> </div> <div class="formRow"> <label class="controlLabel">Rotation</label> <input type="text" style="width: 40px" id="importImageMobileRotationValue" value="0" class="number" min="1" max="500" size="2"/> <div class="rangeHolder"> <input type="range" class="range" min="0" max="360" value="0" id="importImageMobileRotation"/> </div> <div class="ui-button rangeButton" id="importImageMobileRotation90">+90</div> </div> <div class="formRow importImageMobileVideoSetting"> <label class="controlLabel">Direction</label> <select id="importImageMobileDirection"> <option value="forwards">Forwards</option> <option value="backwards">Backwards</option> <option value="pingpong">Ping Pong</option> </select> </div> <div class="formRow importImageMobileVideoSetting"> <label class="controlLabel">Start Time</label> <input type="text" style="width: 40px" id="importImageMobileStartTimeValue" value="0" class="number" min="0" max="100" size="2"/> <div class="rangeHolder"> <input type="range" class="range" min="0" max="100" value="0" id="importImageMobileStartTime"/> </div> <div class="ui-button rangeButton" id="importImageMobileStartTimeReset">Reset</div> </div> <div class="formRow importImageMobileVideoSetting"> <label class="controlLabel">End Time</label> <input type="text" style="width: 40px" id="importImageMobileEndTimeValue" value="0" class="number" min="0" max="100" size="2"/> <div class="rangeHolder"> <input type="range" class="range" min="0" max="100" value="0" id="importImageMobileEndTime"/> </div> <div class="ui-button rangeButton" id="importImageMobileEndTimeReset">Reset</div> </div> <div class="formRow importImageMobileVideoSetting"> <label class="controlLabel">Frames</label> <input type="text" style="width: 40px" id="importImageMobileFramesValue" value="24" class="number" min="1" max="40" size="2"/> <div class="rangeHolder"> <input type="range" class="range" min="1" max="80" value="24" id="importImageMobileFrames"/> </div> <div class="ui-button rangeButton" id="importImageMobileFramesReset">Reset</div> </div> <div class="formRow importImageMobileVideoSetting"> <label class="controlLabel">Speed</label> <input type="text" style="width: 40px" id="importImageMobileSpeedValue" value="9" class="number" min="1" max="40" size="2"/> <div class="rangeHolder"> <input type="range" class="range" min="1" max="12" value="9" id="importImageMobileSpeed"/> </div> <div class="ui-button rangeButton" id="importImageMobileSpeedReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel">Brightness</label> <input type="text" style="width: 40px" id="importImageMobileBrightnessValue" value="0" class="number" min="-100" max="100" size="2"/> <div class="rangeHolder"> <input type="range" class="range" min="-100" max="100" value="0" id="importImageMobileBrightness"/> </div> <div class="ui-button rangeButton" id="importImageMobileBrightnessReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel">Contrast</label> <input type="text" style="width: 40px" class="number" min="-100" max="100" value="0" size="2" id="importImageMobileContrastValue"/> <div class="rangeHolder"> <input type="range" class="" min="-100" max="100" value="0" id="importImageMobileContrast"/> </div> <div class="ui-button rangeButton" id="importImageMobileContrastReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel">Saturation</label> <input style="width: 40px" type="text" class="number" min="-100" max="100" value="0" size="2" id="importImageMobileSaturationValue"/> <div class="rangeHolder"> <input type="range" min="-100" max="100" value="0" id="importImageMobileSaturation"/> </div> <div class="ui-button rangeButton" id="importImageMobileSaturationReset">Reset</div> </div> <div class="formRow" id=""> <label class="controlLabel" for=""></label> <div class="checkboxGroup"> <label class="cb-container">Invert Colours <input type="checkbox" id="importImageMobileInvertColors"/> <span class="checkmark"></span> </label> </div> </div> <div class="formRow"> <label class="controlLabel" for="importImageColorReductionMobile">Colour Reduction</label> <select name="importImageColorReductionMobile" id="importImageColorReductionMobile"> <option value="closest" selected="selected">Closest</option> <option value="dither">Dither</option> </select> </div> <div class="formRow" id="importImageDitherGroupMobile" id="importImageDitherMobile"> <label class="controlLabel" for="importImageDither">Dither Method</label> <select name="importImageDither" id="importImageDitherMobile"> <option value="FloydSteinberg">Floyd Steinberg</option> <option value="Atkinson">Atkinson</option> <option value="Sierra">Sierra</option> <option value="TwoSierra">Two Sierra</option> <option value="Stucki">Stucki</option> <option value="Jarvis">Jarvis</option> <option value="Burkes">Burkes</option> </select> </div> <div class="formRow" id="importImageColorsMobile"> <label class="controlLabel" for="importImageMobileUseColors">Colours</label> <select id="importImageMobileUseColors"> <option value="all" selected="selected">All Colours</option> <option value="choose">Custom Set</option> </select> </div> <div class="formRow" id="importImageMobileChooseColorsContainer" style="display: none"> <label class="controlLabel" for="importImageMobileUseColors">&nbsp;</label> <div class="ui-button" style="display: none" id="importImageMobileChooseColors">Choose Colours...</div> </div> <div class="formRow"> <label class="controlLabel" for="importImageMobileBackgroundColorType">BG Colour</label> <select name="importImageMobileBackgroundColorType" id="importImageMobileBackgroundColorType"> <option value="perCell" selected="selected">Background Colour Per Cell</option> <option value="frame">Use Frame Background Colour</option> </select> </div> <div class="formRow" id="importImageCharsMobile"> <label class="controlLabel" for="importImageMobileUseChars">Tiles</label> <select id="importImageMobileUseChars"> <option value="all" selected="selected">All Tiles</option> <option value="choose">Custom Set</option> </select> </div> <div class="formRow" id="importImageMobileChooseCharsContainer" style="display: none"> <label class="controlLabel" for="importImageMobileChooseChars">&nbsp;</label> <div class="ui-button" style="display: none" id="importImageMobileChooseChars">Choose Tiles...</div> </div> <div class="formRow" id=""> <label class="controlLabel" for="importImageMobileUseColors">Effects</label> <div class="checkboxGroup"> <label class="cb-container">Mirror H <input type="checkbox" id="importImageMobileMirrorH"/> <span class="checkmark"></span> </label> <label class="cb-container">Mirror V <input type="checkbox" id="importImageMobileMirrorV"/> <span class="checkmark"></span> </label> </div> </div> </div> </div> </div> ';g_htmlCache["html/textMode/info.html"]='<div class="activeBackground panelFill" style="color: white;"> <div class="title" style="background-color: #111111; height: 18px"> <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap"> Info </div> <div style="position: absolute; top: 2px; right: 2px; width: 20px"> <div id="infoPanelCloseButton" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div> </div> </div> <table class="infoTable"> <tr> <th>Cell:</th> <td> <div style="display: inline-block" id="info-coordinates"></div> </td> </tr> <tr> <th> Tile: </th> <td> <canvas style="background-color: #222222; border: 1px solid white" width="16" height="16" id="infoCharacterCanvas"></canvas> <div style="display: inline-block" id="info-character"></div> </td> </tr> <tr id="infoTableBlock" style="display: none"> <th> Block: </th> <td> <div style="display: inline-block" id="info-block"></div> </td> </tr> <tr id="info-fgColor"> <th> Cell FG: </th> <td> <div style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" id="infoCellFGColor"></div> <span id="infoCellFGColorIndex"></span> <span id="infoCellFGColorHex"></span> </td> </tr> <tr id="info-bgColor"> <th>Cell BG:</th> <td> <div style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" id="infoCellBGColor"></div> </td> </tr> <tr> <th>Zoom:</th> <td> <div style="display: inline-block" id="info-zoom">Zoom: 100%</div> </td> </tr> </table> </div>';g_htmlCache["html/textMode/exportPet.html"]='<div class="panelFill dialogContent" id="exportPetPanel"> <div class="formGroup"> <label class="controlLabel" for="exportPetAs">File name:</label> <input type="text" class="formControl" size="20" value="untitled" id="exportPetAs"/> </div> <div class="formGroup"> The current layer and frame will be exported </div> </div> ';g_htmlCache["html/textMode/layerPropertiesDialog.html.bk"]="";g_htmlCache["html/textMode/colorPaletteEdit.html"]='<div class="panelFill" id="colorPaletteEdit"> <style> #editColorPaletteDialog h2 { margin: 2px 0 10px 0; border-bottom: 1px solid #444444; padding-bottom: 6px; } .editColorPaletteTable { margin: 2px; } .editColorPaletteTable td { padding: 6px 10px 10px 10px; } .editColorPaletteColorInfo { font-size: 11px; line-height: 14px; } .editColorPaletteColorInfo .color-value { display: inline-block; width: 16px; text-align: right; margin-right: 6px; } .editColorPaletteColorInfo .gridinfo-label { width: 8px; display: inline-block; } .editColorPalettePanel { margin-bottom: 10px; } </style> <div style="position: absolute; top: 0; left: 0; right: 330px; bottom: 0; background-color: #191919"> <div style="position: absolute; overflow: auto; top: 0; left: 0; right: 0; height: 128px; padding: 0 10px 10px 10px; min-width: 410px"> <h2>Colour Palette Edit</h2> <div style="margin-bottom: 8px"> Draw and arrange colours in the grid to create a palette<br/> Select an area with the marquee tool to use gradient tools </div> <div style="margin-bottom: 8px"> <div class="colorPaletteTool colorPaletteToolSelected" id="colorPaletteEditTool_pen"><img width="20" src="icons/glyphicons-31-pencil@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteEditTool_erase"><img width="20" src="icons/glyphicons-551-erase@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteEditTool_eyedropper"><img width="20" src="icons/glyphicons-91-eyedropper@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteEditTool_select"><img width="20" src="icons/glyphicons-100-vector-path-select@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteEditTool_move"><img width="20" src="icons/glyphicons-187-move@2x.png"/></div> <div id="colorPaletteEditCurrentTool" style="display:inline-block">&nbsp;</div> </div> </div> <div id="colorPaletteEditCanvasHolder" style="position: absolute; overflow: auto; top: 128px; left: 0; right: 0; bottom: 70px; padding: 0 10px 10px 10px"> <canvas id="colorPaletteEditCanvas"></canvas> </div> <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 60px; padding: 10px;"> <div style="margin-bottom: 10px; display: flex; align-items: center;"> <label class="cb-container">Show Grid <input type="checkbox" id="colorPaletteEditShowGrid" checked="checked"> <span class="checkmark"/> </label> <label style="margin-right: 10px">Width: <input type="number" id="colorPaletteEditGridWidth" class="number" min="1" max="30" value="16" style="width: 30px" size="2"/></label> <label>Height: <input type="number" id="colorPaletteEditGridHeight" class="number" min="1" max="30" value="16" style="width: 30px" size="2"/></label> </div> <div style="display: flex"> <div class="ui-button" style="display: flex; align-items: center; height: 24px" id="colorPaletteEditClear">Clear Palette</div> <div class="ui-button" style="display: flex; align-items: center; margin: 0 10px; height: 24px" id="colorPaletteEditLoad">Load Palette File...</div> <div class="ui-button" id="colorPaletteEditLoadLospec" style="background-color: #232125; display: flex; height: 24px; align-items: center; margin-right: 10px"><img src="icons/lospec_logomark_1x.svg" style="filter: none; width: auto; height: 16px; margin-right: 6px"> Load Lospec Palette...</div> <div class="ui-button" style="display: flex; align-items: center; height: 24px" id="colorPaletteEditSave">Save As...</div> <form id="colorPaletteEditLoadForm" style="position: absolute; top: -50px; left: -1000px"> <input type="file" id="colorPaletteEditChooseFile" accept=".png,.json,.aco,.act,.ase,.gpl,.txt,.hex,.vpl,.jpg,.jpeg"/> </form> </div> </div> </div> <div style="position: absolute; top: 0; bottom: 0; right: 0; width: 300px; overflow: audo; padding: 0 10px 10px 10px; background-color: #191919"> <div class="editColorPalettePanel"> <h2>Current Colour</h2> <div style="position: relative;"> <div class="colorPaletteEditorDrawColor" style="display: flex"> <div style="width: 128px; height: 65px" id="colorPaletteEditImageMouseSelectedColor"></div> <div style="margin-left: 10px; width: 110px; height: 65px;" class="editColorPaletteColorInfo" id="colorPaletteEditImageMouseSelectedColorInfo"/> </div> <div style="display: flex"> <div style="width: 128px; height: 65px" id="colorPaletteEditImageMouseHoverColor"/> <div style="margin-left: 10px; width: 110px; height: 65px" class="editColorPaletteColorInfo" id="colorPaletteEditImageMouseHoverColorInfo"/> </div> </div> </div> <div class="editColorPalettePanel"> <div style="margin-bottom: 4px" class="editColorPaletteChooseMethod"> <h2>Choose Colours</h2> <label class="rb-container" style="margin-right: 4px">HSV / RGB <input type="radio" name="editColorPaletteMethod" value="rgb" checked="checked"> <span class="checkmark"/> </label> <label class="rb-container" style="margin-right: 4px">From Image <input type="radio" name="editColorPaletteMethod" value="image"> <span class="checkmark"/> </label> <label class="rb-container" style="margin-right: 4px">Colour Wheel <input type="radio" name="editColorPaletteMethod" value="colorwheel"> <span class="checkmark"/> </label> </div> <div id="colorPaletteEditGraphHolder" class="colorPaletteSelectionMethod" style="display: none"> <div> <label for="colorPaletteEditGraphParam">Param</label> <select id="colorPaletteEditGraphParam"> <optgroup label="RGB"> <option value="red" selected="selected">Red</option> <option value="green">Green</option> <option value="blue">Blue</option> </optgroup> <optgroup label="HSV"> <option value="hue">Hue</option> <option value="saturation">Saturation</option> <option value="value">Value</option> </optgroup> </select> </div> <div> <canvas id="colorPaletteEditGraph" style="background-color: black;"></canvas> </div> <div style="display: flex; margin: 10px 0"> <div style="margin-right: 10px"> <div style="margin-bottom: 6px">From</div> <div id="colorPaletteEditorFrom" class="colorPaletteEditorColor"></div> </div> <div> <div style="margin-bottom: 6px">To</div> <div id="colorPaletteEditorTo" class="colorPaletteEditorColor"></div> </div> </div> <div id="colorPaletteEditorGenerateGradient" class="ui-button">Generate Gradient</div> <div style="margin: 10px 0; font-weight: 400">Gradient Options</div> <label class="rb-container" style="margin-right: 4px">Linear <input type="radio" name="colorPaletteEditorGenerateGradientType" value="linear"> <span class="checkmark"/> </label> <label class="rb-container" style="margin-right: 4px">Bezier <input type="radio" name="colorPaletteEditorGenerateGradientType" value="bezier" checked="checked"> <span class="checkmark"/> </label> <label class="cb-container">Correct Lightness <input type="checkbox" id="colorPaletteEditorGradientCorrectLightness" value="1" checked="checked"> <span class="checkmark"/> </label> </div> <div id="colorPaletteEditSelectionMethod_rgb" class="colorPaletteSelectionMethod"> <h3>RGB</h3> <div> <div class="colorComponentSelector"> <label for="editColorPaletteR">R</label> <canvas width="200" height="28" id="colorPaletteEditRCanvas" class="colorPaletteSlider" data-component="r"></canvas> <input type="number" class="number colorPaletteNumber" size="4" id="colorPaletteEditR" data-component="r" min="0" max="255" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteG">G</label> <canvas width="200" height="28" id="colorPaletteEditGCanvas" class="colorPaletteSlider" data-component="g"></canvas> <input type="number" class="number colorPaletteNumber" size="4" id="colorPaletteEditG" data-component="g" min="0" max="255" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteB">B</label> <canvas width="200" height="28" id="colorPaletteEditBCanvas" class="colorPaletteSlider" data-component="b"></canvas> <input type="number" class="number colorPaletteNumber" size="4" id="colorPaletteEditB" data-component="b" min="0" max="255" value="0"> </div> </div> <h3>HSV</h3> <div> <div class="colorComponentSelector"> <label for="editColorPaletteH">H</label> <canvas width="200" height="28" id="colorPaletteEditHCanvas" class="colorPaletteSlider" data-component="h"></canvas> <input type="number" class="number colorPaletteNumber" size="4" id="colorPaletteEditH" data-component="h" min="0" max="360" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteS">S</label> <canvas width="200" height="28" id="colorPaletteEditSCanvas" class="colorPaletteSlider" data-component="s"></canvas> <input type="number" class="number colorPaletteNumber" size="4" id="colorPaletteEditS" data-component="s" min="0" max="100" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteB">V</label> <canvas width="200" height="28" id="colorPaletteEditVCanvas" class="colorPaletteSlider" data-component="v"></canvas> <input type="number" class="number colorPaletteNumber" size="4" id="colorPaletteEditV" data-component="v" min="0" max="100" value="0"> </div> </div> <div> <label for="colorPaletteEditHex">#</label> <input type="text" maxlength="6" id="colorPaletteEditHex" size="6"/> </div> </div> <div id="colorPaletteEditSelectionMethod_image" class="colorPaletteSelectionMethod" style="display: none"> <div> <div style="padding-bottom: 2px"> <div class="ui-button" id="colorPaletteEditImageChooseFile">Choose Image...</div> <div id="colorPaletteEditImageChooseFileName" style="display: inline-block; margin-left: 6px"></div> <input class="formControl" style="position: absolute; top: -50px; left: -100px" id="colorPaletteEditImage" type="file" accept="image/*"/> </div> <canvas id="colorPaletteEditFromImageImage" style="background-color: #111111"></canvas> </div> <div> <label>Scale</label> <div class="ui-button" id="colorPaletteEditImageScaleDecrease">-</div> <input type="number" size="3" style="width: 40px" type="text" id="colorPaletteEditImageScale" min="1" class="number" value="100"/> <div class="ui-button" id="colorPaletteEditImageScaleIncrease">+</div> <div class="ui-button" id="colorPaletteEditImageFit">Fit</div> </div> <div class="formGroup"> <label class="controlLabel" for="">Colour Count</label> <select id="colorPaletteEditFromImageColorCount"> <option value="2">2</option> <option value="4">4</option> <option value="8">8</option> <option value="16" selected="selected">16</option> <option value="32">32</option> <option value="64">64</option> <option value="128">128</option> </select> <button id="colorPaletteEditFromImageAdd">Add These Colours &gt;</button> </div> <canvas id="colorPaletteEditFromImagePalette" style="background-color: #111111"></canvas> </div> <div id="colorPaletteEditSelectionMethod_colorwheel" class="colorPaletteSelectionMethod" style="display: none"> <table> <tr> <td> <canvas id="colorPaletteEditColorWheel"></canvas> </td> <td> <canvas id="colorPaletteEditColorWheelValue" height="200" width="24"></canvas> </td> </tr> </table> </div> </div> </div> </div> ';g_htmlCache["html/textMode/colorPaletteSave.html"]='<div class="panelFill dialogContent" id="saveColorPalettePanel"> <div class="formGroup"> <label class="controlLabel" for="saveColorPaletteAs">File name:</label> <input type="text" class="formControl" size="20" value="Untitled" id="saveColorPaletteAs"/> </div> <div class="formGroup"> <label class="controlLabel">Format:</label> <select name="saveColorPaletteFormat" id="saveColorPaletteFormat"> <option value="json">JSON (Native)</option> <option value="png" selected="selected">PNG</option> <option value="aco">ACO (Adobe Color)</option> <option value="ase">ASE (Adobe Swatch Exchange)</option> <option value="gpl">GPL (GIMP)</option> <option value="txt">TXT (Paint.net)</option> <option value="hex">Hex</option> </select> </div> <div class="formGroup" id="saveColorPaletteSortOrderRow"> <label class="controlLabel" for="saveColorPaletteSortOrder">Sort Order</label> <select name="saveColorPaletteSortOrder" id="saveColorPaletteSortOrder"> <option value="default">Default Layout</option> <option value="source">Colour Index</option> <option value="hls">Hue</option> <option value="saturation">Saturation</option> <option value="brightness">Brightness</option> </select> </div> <div> <div class="formGroup" id="saveColorPaletteColorsAcrossRow" style="display: inline-block; margin-right: 10px"> <label class="controlLabel" for="saveColorPaletteColorsAcross">Colours Across</label> <input type="number" class="number" min="1" max="256" value="8" size="3" id="saveColorPaletteColorsAcross"/> </div> <div class="formGroup" id="saveColorPaletteCellWidthRow" style="display: inline-block; margin-right: 10px"> <label class="controlLabel" for="saveColorPaletteCellWidth">Cell Width</label> <input type="number" class="number" min="1" max="64" value="8" size="3" id="saveColorPaletteCellWidth"/> </div> <div class="formGroup" id="saveColorPaletteCellHeightRow" style="display: inline-block; margin-right: 10px"> <label class="controlLabel" for="saveColorPaletteCellHeight">Cell Height</label> <input type="number" class="number" min="1" max="64" value="8" size="3" id="saveColorPaletteCellHeight"/> </div> </div> <div> <label class="controlLabel">Palette:</label> <div style="display: inline-block"> <canvas id="saveColorPaletteCanvas"></canvas> </div> </div> </div> ';g_htmlCache["html/textMode/exportSEQ.html"]='<div class="panelFill dialogContent" id="exportSEQPanel"> <div class="formGroup"> <label class="controlLabel" for="exportSEQAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportSEQAs"/> </div> <div class="formGroup"> <label class="controlLabel">Include:</label> <div class="checkboxGroup"> <div> <label class="cb-container">CLR byte ($93) <input type="checkbox" id="exportSEQClearByte" checked="checked"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Uppercase/G0x40 Byte ($8E) <input type="checkbox" id="exportSEQNewG0x40Byte"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Shift-Return at end of lines ($8D) <input type="checkbox" id="exportSEQNewLineBytes"> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel" for="exportSEQAs">Header Bytes:</label> <input type="text" class="formControl" size="20" value="" id="exportSEQHeaderBytes"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportSEQAs">Footer Bytes:</label> <input type="text" class="formControl" size="20" value="" id="exportSEQFooterBytes"/> </div> <div> <label></label> <span>Bytes as dec: x,x,x or hex $x,$x,$x</span> </div> </div> ';g_htmlCache["html/textMode/exportPngMobile.html"]='<div class="panelFill"> <div style="display: inline-block" id="exportPNGMobileInfo"></div> <div id="exportPNGMobileCanvasHolder" style="position: absolute; top: 0; left: 0; right: 0; height: 260px; background-color: #111111; border-bottom: 1px solid #555555; padding: 6px"> <div style="text-align: center; padding-top: 20px"> <canvas id="exportPngMobilePreview" style="border: 1px solid #aaaaaa"></canvas> </div> </div> <div id="exportPNGMobileControlsHolder" style="position: absolute; top: 272px; left: 0; right: 0; bottom: 0; overflow: auto; padding: 6px"> <div class="formRow"> <label class="controlLabel" for="pngExportMobilePreviewScale">Preview Scale</label> <input id="pngExportMobilePreviewScaleText" class="number" type="text" style="width: 40px" min="1" max="5000" value="100" size="2"> <div class="rangeHolder"> <input id="pngExportMobilePreviewScale" style="width: 100%" type="range" min="20" max="500" value="100" size="3"> </div> <div class="ui-button rangeButton" id="pngExportPreviewMobileScaleReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel" for="exportPNGMobileAs">File name</label> <input type="text" class="formControl" size="20" value="" id="exportPNGMobileAs"/> </div> <div class="formRow"> <label class="controlLabel" for="exportPNGMobileScale">Scale</label> <select class="formControl" id="exportPNGMobileScale"> <option value="1">100%</option> <option value="2">200%</option> <option value="3">300%</option> <option value="4">400%</option> <option value="5">500%</option> </select> </div> <div class="formRow" style="display: block; padding: 10px 0"> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <label class="cb-container">Include Border <input type="checkbox" id="exportPNGMobileIncludeBorder" value="1"/> <span class="checkmark"/> </label> </div> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <label class="cb-container">Add Transparent Pixel <input type="checkbox" id="exportPNGMobileTransparentPixel" value="1"/> <span class="checkmark"/> </label> </div> </div> <div> <h3>Effects</h3> </div> <div id="exportImageMobileEffects"> </div> </div> </div> </div> ';g_htmlCache["html/textMode/replaceColor.html"]='<div class="panelFill dialogContent" id="replaceColorPanel"> <div class="formGroup"> <label class="controlLabel">Replace:</label> <div class="checkboxGroup"> <div> <label class="cb-container">Cell FG Colour <input type="checkbox" checked="checked" id="replaceColorFG"/> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Cell BG Colour <input type="checkbox" id="replaceColorBG"/> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel">Colour:</label> <div id="replaceColor" style="display: inline-block; width: 16px; height: 16px; border: 1px solid white;"></div> </div> <div class="formGroup"> <label class="controlLabel">With:</label> <div id="replaceWithColor" style="display: inline-block; width: 16px; height: 16px; border: 1px solid white"></div> </div> <div class="formGroup"> <label class="controlLabel">Frame</label> <div class="radioGroup"> <div> <label class="rb-container">Current Frame <input type="radio" name="replaceColorFrame" value="current" id="replaceColorCurrentFrame" checked="checked"> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">All Frames <input type="radio" name="replaceColorFrame" value="all" id="replaceColorAllFrames"> <span class="checkmark"></span> </label> </div> </div> </div> </div>';g_htmlCache["html/textMode/tileEditor.html"]='<div id="tileEditor" class="panelFill" style="color: white"> <div class="title" style="background-color: #111111; height: 28px"> <div style="position: absolute; top: 6px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap"> Tile Editor </div> <div style="position: absolute; top: 2px; right: 2px; width: 20px"> <div id="tileEditorCloseButton" class="ui-button ui-dialog-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div> </div> </div> <div style="position: absolute; bottom: 0px; top: 28px; left: 0; right: 0; overflow-y: auto; overflow-x: hidden"> <div id="tileEditorTileInfo" style="padding: 10px 0 0 10px"></div> <div style="text-align:center; margin-top: 10px" id="tileEditorCanvasHolder"> <canvas id="tileEditorCanvas" width="192" height="192" style="background-color: #000000"></canvas> </div> <div id="tileEditorFrameControls" style="display: none; margin: 8px"> Frame <button id="tileEditorPrevFrame">&lt;</button> <input class="number" size="2" min="1" value="1" style="width: 30px" id="tileEditorFrame"> <button id="tileEditorNextFrame">&gt;</button> &nbsp; of &nbsp; <div style="display: inline-block; width: 20px; color: white" id="tileEditorFrames"></div> <button id="tileEditorInsertFrame">+</button> <button id="tileEditorDeleteFrame">-</button> </div> <div id="tileEditorMultiColors" style="display: none; margin: 4px"> <label style="font-size: 10px">Colour:</label> <div style="display: inline-block; width: 18px; height: 18px; background-color: #000000; border: 1px solid #dddddd" class="" id="tileEditorMultiColor"></div> </div> <div id="tileEditorC64Colors" style="display: none; margin: 4px"> <div> Colour: </div> <div id="tileEditorC64Colors"> </div> </div> <div id="tileEditorSubPaletteColors" style="display: none"> <div data-index="0" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="tileEditorSubPaletteColor colorSubPaletteColor0Display colorSubPaletteColor0" id="tileEditorSubPaletteColor-0"></div> &nbsp;&nbsp; <div data-index="1" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="tileEditorSubPaletteColor colorSubPalette1Display colorSubPaletteColor1" id="tileEditorSubPaletteColor-1"></div> &nbsp;&nbsp; <div data-index="2" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="tileEditorSubPaletteColor colorSubPalette2Display colorSubPaletteColor2" id="tileEditorSubPaletteColor-2"></div> &nbsp;&nbsp; <div data-index="3" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="tileEditorSubPaletteColor colorSubPalette3Display colorSubPaletteColor3" id="tileEditorSubPaletteColor-3"></div> </div> <div id="tileEditorControls" style="margin: 8px 0px 0px 10px"> <div> <span id="tileEditorControlLabel">&nbsp;</span> </div> <div> <div> <div class="ui-button" data-label="Shift Left" title="Shift Left" id="tileEditorLeft"><img src="icons/svg/glyphicons-basic-859-square-left.svg"/></div> <div class="ui-button" data-label="Shift Right" title="Shift Right" id="tileEditorRight"> <img src="icons/svg/glyphicons-basic-860-square-right.svg"/></div> <div class="ui-button" data-label="Shift Up" title="Shift Up" id="tileEditorUp"><img src="icons/svg/glyphicons-basic-858-square-up.svg"/></div> <div class="ui-button" data-label="Shift Down" title="Shift Down" id="tileEditorDown"><img src="icons/svg/glyphicons-basic-857-square-down.svg"/></div> <div class="ui-button" data-label="Flip X" title="Flip X" id="tileEditorFlipH"><img src="icons/svg/glyphicons-basic-747-reflect-y.svg"/></div> <div class="ui-button" data-label="Flip Y" title="Flip Y" id="tileEditorFlipV"><img src="icons/svg/glyphicons-basic-748-reflect-x.svg"/></div> <div class="ui-button" data-label="Rotate" title="Rotate" id="tileEditorRotate"><img src="icons/svg/glyphicons-basic-493-rotate.svg"/></div> <div class="ui-button" data-label="Invert" title="Invert" id="tileEditorInvert"><img src="icons/svg/glyphicons-basic-543-star-half.svg"/></div> </div> <div> <div class="ui-button" data-label="Cut" title="Cut" id="tileEditorClear"><img src="icons/svg/glyphicons-basic-612-scissors.svg"/></div> <div class="ui-button" data-label="Copy" title="Copy" id="tileEditorCopy"><img src="icons/svg/glyphicons-basic-614-copy.svg"/></div> <div class="ui-button" data-label="Paste" title="Paste" id="tileEditorPaste"><img src="icons/svg/glyphicons-basic-613-paste.svg"/></div> Clipboard: <canvas width="16" height="16" style="background-color: black" id="tileEditorClipboard"></canvas> </div> </div> </div> <div style="margin: 8px 0 0 10px"> <div> <label for="tileEditorAnimatedType">Animated:</label> </div> <div style="margin-top: 2px"> <select id="tileEditorAnimatedType" style="margin-right: 6px; margin-top: 6px;"> <option value="">No</option> <option value="mixed">Mixed</option> <option value="left">Scroll Left</option> <option value="right">Scroll Right</option> <option value="up">Scroll Up</option> <option value="down">Scroll Down</option> <option value="blink">Blink</option> <option value="frames">Frames</option> </select> <div style="display: inline-block; margin-top: 6px" id="tileEditorAnimatedTicksPerFrameRow"> <label for="tileEditorAnimatedTicksPerFrame">Ticks/Frame:</label> <input size="2" class="number" min="1" max="16" value="6" id="tileEditorAnimatedTicksPerFrame"/> </div> </div> </div> </div> </div>';g_htmlCache["html/textMode/exportPngEffects.html"]='<div class="panelFill" id="exportPngEffectsPanel"> <div style="position: absolute; top: 0; bottom: 0; right: 0; left: 0px; padding: 10px; overflow: auto"> <div class="formGroup"> <h3><i class="halflings halflings-star-empty"></i>&nbsp;Effects</h3> <div id="exportImageEffects"> </div> </div> </div> </div> ';g_htmlCache["html/textMode/layerPropertiesDialog.html"]='<div class="panelFill dialogContent" id="refLayer"> <form id="refLayerForm"> <div id="layerDialogStandardProperties"> <div class="formGroup"> <label class="controlLabel" for="layersRefImageName">Name</label> <input type="text" id="layersRefImageName"> </div> <div class="formGroup" id="layerDialogLayerTypeRow" style="display: none"> <label class="controlLabel">Layer Type</label> <label class="rb-container">Grid <input type="radio" name="layerDialogLayerType" id="layerDialogLayerType_grid" value="grid" checked="checked"> <span class="checkmark"></span> </label> </div> </div> <div id="layerDialogGridProperties"> <div class="formGroup"> <label class="controlLabel">Screen Mode:</label> <select id="layersScreenMode" style="width: 177px"> <option value="textmode">Text Mode</option> <option value="c64standard">C64 Standard</option> <option value="c64multicolor">C64 Multicolour</option> <option value="c64ecm">C64 Extended BG Colour Mode</option> <option value="nes" class="unfinished">NES</option> <option value="vector">Vector Mode</option> <option value="indexed">Indexed Colour</option> </select> </div> <div class="formRow" id="layerDialogFlipRotateOptions"> <label class="controlLabel">&nbsp;</label> <label class="cb-container">Can Flip Tiles <input type="checkbox" name="layerTileFlip" id="layerTileFlip" value="1"> <span class="checkmark"></span> </label> <label class="cb-container">Can Rotate Tiles <input type="checkbox" name="layerTileRotate" id="layerTileRotate" value="1"> <span class="checkmark"></span> </label> </div> <div class="formGroup" id="layerDialogTileSetGroup"> <label class="controlLabel">Tile Set</label> <div style="display: inline-block"> <div> <label class="rb-container" style="margin-right: 4px">Use Current <input type="radio" name="layerDialogTileSet" id="layerTileSet" checked="checked" value="current"> <span class="checkmark"></span> </label> <label class="rb-container">New <input type="radio" name="layerDialogTileSet" id="layerTileSet" value="new"> <span class="checkmark"></span> </label> </div> <div id="layerDialogChooseTilesetHolder"> <div style="display: flex; align-items: center; padding: 2px 2px 2px 4px; background-color: #222222; min-height: 26px"> <div style="display: inline-block; width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis" id="layerDialogNewTileSet">C64 PETSCII</div> <div class="ui-button" id="layerDialogChooseTileSetButton">Choose...</div> </div> </div> </div> </div> <div class="formGroup" id="layerDialogColorPaletteGroup"> <label class="controlLabel">Colour Palette</label> <div style="display: inline-block"> <div> <label class="rb-container" style="margin-right: 4px">Use Current <input type="radio" name="layerDialogColorPalette" id="layerColorPaletteCurrent" checked="checked" value="current"> <span class="checkmark"></span> </label> <label class="rb-container">New <input type="radio" name="layerDialogColorPalette" id="layerColorPaletteNew" value="new"> <span class="checkmark"></span> </label> </div> <div id="layerDialogChooseColorPaletteHolder"> <div style="display: flex; align-items: center; padding: 2px 2px 2px 4px; background-color: #222222; min-height: 26px"> <div style="display: inline-block; width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis" id="layerDialogNewColorPalette">C64</div> <div class="ui-button" id="layerDialogChooseColourPaletteButton">Choose...</div> </div> </div> </div> </div> <div class="formGroup" id="layerDialogGridPropertiesBackgroundColor"> <label class="controlLabel">Background / Border</label> <div id="layerProperties-frameColors" style="padding: 0px 8px 0px 8px; width: 240px; position: relative; height: 50px; display: inline-block"> <div style="display: block; position: absolute; top: 0px; left: 8px; width: 56px; height: 46px; background-color: rgb(114, 97, 216); z-index: 5;" id="layerProperties-borderColor" class="borderColor colorSetting"></div> <div style="display: block; position: absolute; top: 10px; left: 18px; width: 36px; height: 26px; background-color: rgb(55, 36, 156); z-index: 10;" id="layerProperties-backgroundColor" class="backgroundColor colorSetting"></div> <div style="display: block; position: absolute; top: 0px; left: 70px"> <div> Background: <div style="display: inline-block; vertical-align: middle" id="layerPropertiesDialogBackgroundColorDescription"></div> </div> <div> Border: <div style="display: inline-block; vertical-align: middle" id="layerPropertiesDialogBorderColorDescription"></div> </div> </div> </div> </div> </div> <div id="layerDialogBackgroundProperties"> <div class="formGroup"> <label class="controlLabel">Name:</label> Background </div> </div> </form> </div> ';g_htmlCache["html/textMode/drawToolsPopup.html"]='<div class="" id="drawToolsPopup" style="width: 180px; background-color: #222222; cursor: default"> <canvas width="160" height="100" id="drawPopupCanvas" style=" margin: 8px;"></canvas> <div style="margin: 8px; width: 160px"> <div> <div class="drawPopupTool drawPopupToolSelected" id="drawPopupTool_pen"><img width="20" src="icons/glyphicons-31-pencil@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_erase"><img width="20" src="icons/glyphicons-551-erase@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_fill"><img width="20" src="icons/glyphicons-481-bucket@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_eyedropper"><img width="20" src="icons/glyphicons-91-eyedropper@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_line"><img width="20" src="icons/glyphicons-98-vector-path-line@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_rect"><img width="20" src="icons/glyphicons-100-vector-path-all@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_oval"><img width="20" src="icons/glyphicons-96-vector-path-circle@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_select"><img width="20" src="icons/glyphicons-100-vector-path-select@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_charpixel"><img width="20" src="icons/glyphicons-156-show-big-thumbnails@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_type"><img width="20" src="icons/glyphicons-104-text@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_pixel"><img width="20" src="icons/pixel@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_block"><img width="20" src="icons/block@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_zoom"><img width="20" src="icons/zoom@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_hand"><img width="20" src="icons/hand@2x.png"/></div> <div class="drawPopupTool" id="drawPopupTool_move"><img width="20" src="icons/move@2x.png"/></div> </div> </div> <div id="currentPopupTool" style="margin-left: 10px">draw</div> </div>';g_htmlCache["html/textMode/importC64Formats.html"]='<div class="panelFill" id="importC64FormatsPanel"> <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0px; overflow: auto; padding: 8px"> <h2 style="margin: 0 0 6px 0">Import C64 Formats</h2> <div class="formGroup"> <form id="importC64FormatsForm"> <label class="controlLabel" for="importC64FormatsSourceFile">File To Import:</label> <div class="ui-button ui-button-nextaction" id="importC64FormatsChooseFile">Choose...</div> <input class="formControl" id="importC64FormatsSourceFile" type="file" accept=".c,.seq,.prg,.d64,.crt,.vsf,.ctm" style="position: absolute; top: -50px; left: -100px"> <div class="ui-button" id="importC64PRGReset">Reset</div> </form> </div> <div style="margin: 6px 0 6px 0; color: #999999"> Import Formats: .C, .SEQ, C64 Executable (.PRG), .D64, .CRT, VICE Snapshot (.VSF), CharPad (.CTM) </div> <div style="border-top: 1px solid #555555; margin: 4px 0 10px 0"></div> <table> <tr> <td style="vertical-align: top"> <div> <canvas id="importC64FormatsPreview" width="320" height="200" style="border: 1px solid #222222"></canvas> <div>DRIVE: <div id="importC64FormatsDriveLight" style="display: inline-block; width: 30px; height: 16px; background-color: rgb(255, 0, 0);"></div> <div style="display: inline" id="importC64FormatsAttachedDisk"></div> <div id="importC64FormatsDrivePosition"></div> </div> </div> <div id="importC64FormatsFrames" style="display: none"> <span id="importC64FormatsFrameInfo">Frame x of x</span> <button id="importC64FormatsFramesPrev">&lt;</button> <button id="importC64FormatsFramesNext">&gt;</button> </div> <div id="importC64PRGControls" style="margin-top: 6px"> <div style="margin-top: 4px"> Run/Stop = ESC Key, Commodore Key = ctrl key </div> </div> </td> <td style="padding-left: 10px; vertical-align: top"> <div id="importC64Settings" style="display: none" class="importC64Settings"> <h3>Joystick</h3> <div> <label class="rb-container">None <input type="radio" id="importC64JoystickPortNone" name="importC64JoystickPort" value="0"> <span class="checkmark"></span> </label> <label class="rb-container">Port 1 <input type="radio" id="importC64JoystickPort1" name="importC64JoystickPort" value="1"> <span class="checkmark"></span> </label> <label class="rb-container">Port 2 <input type="radio" id="importC64JoystickPort2" checked="checked" name="importC64JoystickPort" value="2"> <span class="checkmark"></span> </label> </div> <div> <div> cursor keys = joystick directions </div> <div> z = fire </div> </div> </div> <div id="importSEQSettings" style="display: none" class="importC64Settings"> seq settings </div> <div id="importPetsciiCSettings" style="display: none" class="importC64Settings"> </div> <div id="importC64CharPadSettings" style="display: none" class="importC64Settings"> <div id="importC64CharPadInfo"> </div> <div class="checkboxGroup"> <div> <label class="cb-container">Import Characters <input type="checkbox" checked="checked" id="importC64CharPadCharacters"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Import MetaTiles (CharPad Tiles) <input type="checkbox" checked="checked" id="importC64CharPadBlocks"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Import Map <input type="checkbox" checked="checked" id="importC64CharPadMap"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Set Colour Per Mode <input type="checkbox" checked="checked" id="importC64CharPadScreenColorMode"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Use MetaTile Mode <input type="checkbox" id="importC64CharPadBlockMode"> <span class="checkmark"></span> </label> </div> </div> </div> <div id="importC64FormatsViceSettings" style="display: none" class="importC64Settings"> <div id="importC64ViceInfo"> </div> </div> </td> </tr> </table> </div> </div> ';g_htmlCache["html/textMode/exportGifFrames.html"]='<div class="panelFill" id="exportGifFramesPanel"> <div style="position: absolute; top: 0; bottom: 0; right: 0; left: 0px; padding: 10px; overflow: auto"> <h3><i class="halflings halflings-film"></i>&nbsp;Frames</h3> <div id="exportGIFFrames"> <div class="formGroup"> <label class="controlLabel" for="exportGIFFromFrame">Export Frames:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="exportGIFFromFrame"> &nbsp; <label for="exportGIFToFrame">To</label> &nbsp; <input type="number" size="2" class="number" min="1" id="exportGIFToFrame"> </div> <select name="exportGIFLoopType" id="exportGIFLoopType"> <option value="loop">Loop</option> <option value="pingpong">Ping Pong</option> </select> </div> <div class="formGroup"> <label class="controlLabel">Speed:</label> <select name="exportGIFSpeed" id="exportGIFSpeed"> <option value="1">100%</option> <option value="2">200%</option> <option value="3">300%</option> <option value="4">400%</option> <option value="custom">Custom</option> </select> </div> <div class="formGroup" id="customSpeedSection" style="display: none"> <label class="controlLabel">Custom speed:</label> <div style="display: inline-block"> <input type="number" size="3" class="number" min="5" value="10" id="exportGIFMSPerTick"/> ms per tick </div> </div> </div> </div> </div>';g_htmlCache["html/textMode/backgroundImage.html"]='<div class="panelFill" id="backgroundImage"> <form> <div style="padding: 4px"> <label for="bgImageSourceFile">File To Use (.gif,.png,.jpg)</label> <input id="bgImageSourceFile" type="file" accept=".gif,.png,.jpg,.jpeg"> </div> <div style="padding: 4px; text-align: center"> <table> <tr> <td> <canvas width="320" height="200" id="bgImageCanvas" style="border:1px solid white; background-color: #393939"></canvas> </td> <td> <div style="padding: 4px"> <label for="bgImageScale">Scale</label> <button type="button" id="bgImageScaleDecrease">-</button> <input size="3" id="bgImageScale" value="100"/> <button type="button" id="bgImageScaleIncrease">+</button> % </div> <div style="padding: 4px"> <label for="bgImageX">X</label> <input size="3" id="bgImageX" value="0"/> </div> <div style="padding: 4px"> <label for="bgImageY">Y</label> <input size="3" id="bgImageY" value="0"/> </div> </td> </tr> </table> </div> </form> </div> ';g_htmlCache["html/textMode/importSpriteImage.html"]='<div class="panelFill" id="importSpriteImagePanel"> <div style="position: absolute; left: 10px; top: 10px; right: 0px; height: 60px"> <div class="formGroup"> <div style="margin-bottom: 6px"> Choose an image file (.png, .jpg, .gif) containing a sprites </div> <div class="ui-button ui-button-nextaction" id="importSpriteChooseFile">Choose...</div> <input type="file" id="importSpriteFile" style="position: absolute; top: -50px; left: -100px"/> </div> </div> <div id="importSpriteImageCanvasHolder" style="background-color: #444444; position: absolute; top: 70px; bottom: 40px; left: 10px; right: 10px"> </div> </div>';g_htmlCache["html/textMode/frames.html"]='<div id="frames" class="panelFill ui-button-holder" style="padding: 4px; overflow: hidden; white-space: nowrap; background-color: #1c1c1c"> <div class="ui-button" id="play" style="width: 50px"><i class="halflings halflings-play"/>&nbsp;Play<div class="rippleJS"></div></div> <select id="playMode"> <option value="once">Once</option> <option value="loop" selected="selected">Loop</option> <option value="pingpong">Ping Pong</option> </select> <span class="frameControlSeparator">|</span> <label class="gridinfo-label" for="currentFrame">Frame</label> <div class="ui-button" title="Previous Frame" id="prevFrame">&lt;</div> <input size="2" type="number" id="currentFrame" value="1" class="number" min="1"/> <div style="display: inline-block; width: 24px; margin-left: 2px" id="frameCountInfo"></div> <div class="ui-button" title="Next Frame" id="nextFrame">&gt;</div> &nbsp;&nbsp; <label class="gridinfo-label" for="frameDuration">Frame Duration:</label> <input size="4" type="number" class="number integer" id="frameDuration" min="1" max="255" value="12"/> ticks &nbsp;&nbsp; <span class="frameControlSeparator">|</span> <div class="ui-button" id="insertFrame"><i class="halflings halflings-plus"/>&nbsp;New Frame<div class="rippleJS"></div></div> <div class="ui-button" id="duplicateFrame"><i class="halflings halflings-duplicate"/>&nbsp;Duplicate<div class="rippleJS"></div></div> <div class="ui-button" id="deleteFrame"><i class="halflings halflings-trash"/>&nbsp;Delete<div class="rippleJS"></div></div> <span class="frameControlSeparator">|</span> <label class="cb-container">Show Previous Frame <input type="checkbox" id="showGhostFrame" value="1" class="checkbox"/><span class="checkmark"/></label> </div>';g_htmlCache["html/textMode/drawToolsMobile.html"]='<div class="activeBackground panelFill"> <div id="toolIconHolderMobile" style="padding: 8px"> <div> </div> </div> </div> ';g_htmlCache["html/textMode/exportSvg.html"]='<div class="panelFill" id="exportSVGPanel"> <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0px; overflow: auto; padding: 10px"> <div class="formGroup"> <label class="controlLabel" for="exportSVGAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportSVGAs"/> </div> </div> </div>';g_htmlCache["html/textMode/exportX16Basic.html"]='<div class="panelFill dialogContent" id="exportX16BasicPanel" style="overflow: hidden;"> <div style="position: absolute; top: 10px; left: 10px; right: 10px; height: 30px;"> <div class="formGroup"> <label class="controlLabel" for="exportX16BasicAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportX16BasicAs"/> <div id="exportX16BasicDownload" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg"/> Download</div> </div> </div> <div style="position: absolute; top: 50px; left: 10px; right: 10px; bottom: 80px"> <div id="exportX16BasicSource" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0"></div> </div> <div style="position: absolute; bottom: 10px; height: 60px; left: 10px; right: 10px"> <div> </div> <div class="formGroup"> <label class="controlLabel">Include:</label> <div class="checkboxGroup"> <label class="cb-container">Tile Data <input type="checkbox" id="exportX16BasicTilesetData" class="exportX16BasicInclude" checked="checked"/> <span class="checkmark"></span> </label> <div id="exportX16BasicMapDataHolder" style="display: inline-block"> <label class="cb-container">Map Data <input type="checkbox" id="exportX16BasicMapData" class="exportX16BasicInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportX16BasicMapColorDataHolder" style="display: inline-block"> <label class="cb-container">Map Colour Data <input type="checkbox" id="exportX16BasicMapColorData" class="exportX16BasicInclude" checked="checked"> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel">Layers:</label> <div class="radioGroup"> <label class="rb-container">Current Layer <input type="radio" name="exportX16BasicLayer" id="exportX16BasicLayerCurrent" value="current" checked="checked"/> <span class="checkmark"></span> </label> </div> </div> </div> </div> ';g_htmlCache["html/textMode/characterSetChoosePresetMobile.html"]='<div class="panelFill"> <div style="position: absolute; left: 0px; top: 0px; bottom: 60px; right: 0; overflow: hidden"> <div id="chooseCharacterSetMobileHolderA" style="position: absolute; left: 0; width: 300px; top: 0; bottom: 0px"> <div style="margin: 14px"> <h3 id="chooseCharacterSetMobileHeadingA"></h3> <div id="chooseCharacterSetMobileInfoA"></div> <div style="text-align: center"> <canvas id="chooseCharacterSetMobileCanvasA" width="256" height="256" style="background-color: #222222"></canvas> </div> <div id="chooseCharacterSetMobileOptionsA" style="background-color: #222222; position: absolute; left: 0; right: 0; bottom: 0; top: 360px; overflow-y: auto"></div> </div> </div> <div id="chooseCharacterSetMobileHolderB" style="position: absolute; left: 1000px; width: 300px; top: 0; bottom: 0px"> <div style="margin: 14px"> <h3 id="chooseCharacterSetMobileHeadingB"></h3> <div id="chooseCharacterSetMobileInfoB"></div> <div style="text-align: center"> <canvas id="chooseCharacterSetMobileCanvasB" width="256" height="256" style="background-color: #222222"></canvas> </div> <div id="chooseCharacterSetMobileOptionsB" style="background-color: #222222; position: absolute; left: 0; right: 0; bottom: 0; top: 360px; overflow-y: auto"> </div> </div> </div> </div> <div style="position: absolute; left: 0px; right: 0px; bottom: 0px; height: 50px; background-color: #222222; display: flex; align-items: center; padding: 10px 4px 10px 4px"> <div class="ui-button" id="chooseCharacterSetMobilePrev" style="flex-grow: 1; margin-right: 4px"><i class="halflings halflings-chevron-left"></i></div> <select id="characterSetChoosePresetMobileList" style="flex-grow: 1"> </select> <div class="ui-button" id="chooseCharacterSetMobileNext" style="flex-grow: 1; margin-left: 4px"><i class="halflings halflings-chevron-right"></i></div> </div> </div>';g_htmlCache["html/textMode/screenModeDialog.html"]='<div id="screenModeDialog" class="panelFill"> <div style="padding: 10px"> <div class="formGroup"> <label class="controlLabel" for="screenModeDialogMode">Mode:</label> <select name="screenModeDialogMode" id="screenModeDialogMode"> <option value="textmode" selected="selected">Text Mode</option> <option value="c64multicolor">C64 Multicolour</option> <option value="c64ecm">C64 Extended Colour Mode</option> <option value="vector" class="">Vector</option> <option value="nes" class="unfinished">NES</option> <option value="indexed" class="">Indexed</option> </select> </div> </div> <div style="padding: 10px"> <div class="formGroup"> <label class="cb-container">Allow Tile Flip <input type="checkbox" id="screenModeDialogAllowTileFlip" checked="checked"> <span class="checkmark"/> </label> <label class="cb-container">Allow Tile Rotate <input type="checkbox" id="screenModeDialogAllowTileRotate" checked="checked"> <span class="checkmark"/> </label> </div> </div> </div>';g_htmlCache["html/textMode/importAssembly.html"]='<div class="panelFill" id="importAssemblyPanel"> <textarea rows="20" cols="60" id="importAssemblySource" style="position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px"></textarea> </div> ';g_htmlCache["html/textMode/exportGif.html"]='<div class="panelFill" id="exportGifPanel"> <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0px; overflow: auto; padding: 10px"> <div class="formGroup"> <label class="controlLabel" for="exportGIFAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportGIFAs"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportGIFFormat">Format:</label> <label class="rb-container">GIF <input type="radio" name="exportGIFFormat" value="gif" checked="checked"> <span class="checkmark"></span> </label> <label class="rb-container">Video <input type="radio" name="exportGIFFormat" value="video"> <span class="checkmark"></span> </label> </div> <div class="formGroup"> <label class="controlLabel" for="exportGIFShorten"></label> <label class="cb-container">Shorten last frame (for Twitter looped GIFs) <input type="checkbox" name="exportGIFShorten" id="exportGIFShorten" value="gif" checked="checked"> <span class="checkmark"></span> </label> </div> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <label class="cb-container">Include Border <input type="checkbox" id="exportGIFIncludeBorder" value="1"/> <span class="checkmark"></span> </label> </div> <div class="formGroup"> <label class="controlLabel">Scale:</label> <div class="radioGroup"> <label class="rb-container">100% <input type="radio" name="exportGIFScale" id="exportGIFScale1" value="1" checked="checked"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">200% <input type="radio" name="exportGIFScale" id="exportGIFScale2" value="2"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">300% <input type="radio" name="exportGIFScale" id="exportGIFScale3" value="3"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">400% <input type="radio" name="exportGIFScale" id="exportGIFScale4" value="4"/> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup"> <label class="controlLabel">Include Layers:</label> <div class="radioGroup"> <label class="rb-container">Current Layer <input type="radio" name="exportGIFLayer" id="exportGIFLayerCurrent" value="current"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">Visible Layers <input type="radio" name="exportGIFLayer" id="exportGIFLayerVisible" value="visible" checked="checked"> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">All Layers <input type="radio" name="exportGIFLayer" id="exportGIFLayerAll" value="all"> <span class="checkmark"></span> </label> </div> </div> </div> </div> ';g_htmlCache["html/textMode/importC64SpriteFormats.html"]='<div class="panelFill" id="importC64FormatsPanel"> <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0px; overflow: auto; padding: 8px"> <h2 style="margin: 0 0 6px 0">Import C64 Sprite Formats</h2> <div class="formGroup"> <form id="importC64SpriteFormatsForm"> <div class="ui-button ui-button-nextaction" id="importC64SpriteFormatsChooseFile">Choose File...</div> <input class="formControl" id="importC64SpriteFormatsSourceFile" type="file" accept=".spr,.spd,.prg,.d64" style="position: absolute; top: -50px; left: -100px"> <div class="ui-button" id="importC64SpritePRGReset">Reset</div> </form> </div> <div> <div style="display: inline-block; width: 390px"> <canvas id="importC64SpriteFormatsPreview" style="background-color: black"></canvas> <div id="importC64SpriteD64Controls" class="importC64SpriteSettings">DRIVE: <div id="importC64SpriteFormatsDriveLight" style="display: inline-block; width: 30px; height: 16px; background-color: rgb(255, 0, 0);"></div> <div style="display: inline" id="importC64SpriteFormatsAttachedDisk"></div> <div id="importC64SpriteFormatsDrivePosition"></div> </div> </div> <div style="display: inline-block; width: 120px; vertical-align: top"> <div id="importC64SpritePRGControls" style="display: none" class="importC64SpriteSettings"> <div id="importC64SpriteC64Controls"> <h3>Joystick</h3> <div> <label class="rb-container">None <input type="radio" id="importC64SpriteJoystickNone" name="importC64SpriteJoystickPort" value="0"> <span class="checkmark"></span> </label> <label class="rb-container">Port 1 <input type="radio" id="importC64SpriteJoystickPort1" name="importC64SpriteJoystickPort" value="1"> <span class="checkmark"></span> </label> <label class="rb-container">Port 2 <input type="radio" id="importC64SpriteJoystickPort2" checked="checked" name="importC64SpriteJoystickPort" value="2"> <span class="checkmark"></span> </label> </div> <div> <div> cursor keys = directions </div> <div> z = fire </div> </div> <div style="margin-top: 10px"> <div class="ui-button" id="importC64SpriteViewSprites">View Sprites</div> </div> </div> <div style="display: none" id="importC64SpriteSpriteControls"> <div class="ui-button" id="importC64SpriteBackToC64">&lt; Back To C64</div> <div style="margin-top: 10px"> <label> Address (hex): <input id="importC64SpritesFromAddress" value="0000"/> </label> </div> </div> </div> <div id="importC64SpriteSPRControls" style="display: none" class="importC64SpriteSettings"> <label class="cb-container">Multicolor <input type="checkbox" id="importC64SpriteSPRMulticolor" checked="checked" name="importC64SpriteSPRMulticolor" value="1"> <span class="checkmark"></span> </label> </div> </div> </div> </div> </div> ';g_htmlCache["html/textMode/exportSpritePng.html"]='<div class="panelFill" id="exportSpritePngPanel"> <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0px; padding: 10px; overflow: auto"> <div class="formGroup" class=""> <label class="controlLabel" for="exportSpritePNGAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportSpritePNGAs"/> </div> <div class="formGroup" class="exportSpriteFileHolder"> <label class="controlLabel" for="exportSpritePNGAs">File path:</label> <input type="text" class="formControl" size="20" value="" id="exportSpritePNGAsFile"/> <div class="ui-button" id="exportSpritePNGAsFileBrowse">Browse...</div> </div> <div class="formGroup" style="display: none"> <label class="controlLabel">Scale:</label> <div class="radioGroup" style="margin-top: 6px"> <label class="rb-container">100% <input type="radio" name="exportSpritePNGScale" id="exportSpritePNGScale1" value="1" checked="checked"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">200% <input type="radio" name="exportSpritePNGScale" id="exportSpritePNGScale2" value="2"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">300% <input type="radio" name="exportSpritePNGScale" id="exportSpritePNGScale3" value="3"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">400% <input type="radio" name="exportSpritePNGScale" id="exportSpritePNGScale3" value="4"/> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup" style="display: none"> <label class="controlLabel">&nbsp;</label> <label class="cb-container">Add Transparent Pixel <input type="checkbox" id="exportSpritePNGTransparentPixel" value="1"/> <span class="checkmark"></span> </label> </div> </div> </div> ';g_htmlCache["html/textMode/pixelDrawToolsMobileSide.html"]='<div class="activeBackground panelFill" id="pixelDrawToolsMobileSide"> <div id="animationPreviewHolderMobile" style="position: absolute; top: 4px; left: 4px; width: 64px; height: 64px"> <canvas id="animationPreviewCanvasMobile" style=""></canvas> </div> <div id="toolIconsScrollTop" style="z-index: 100; position: absolute; top: 81px; left: 0; right: 0; height: 14px; background-image: linear-gradient(to top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 255)); display: none"></div> <div id="toolIconsScrollBottom" style="z-index: 100; position: absolute; bottom: 144px; left: 0; right: 0; height: 10px; background-image: linear-gradient(to top, rgba(0, 0, 0, 255), rgba(0, 0, 0, 0)); display: none"></div> <div id="toolIconHolderMobile" style="padding: 0px 8px 0 8px; position: absolute; text-align: center; top: 82px; left: 0px; right: 0; bottom: 144px; border-bottom: 1px solid #111111; overflow-y: auto; overflow-x: hidden"> <div id="pixelToolIconsMobile" style="padding: 3px 0 3px 0"> <div class="pixelDrawToolMobileSide" id="pixelDrawToolMobileSide_pen" data-type="pen"><img src="icons/svg/glyphicons-basic-31-pencil.svg"/></div> <div class="pixelDrawToolMobileSide" id="pixelDrawToolMobileSide_erase" data-type="erase"><img src="icons/svg/glyphicons-basic-250-eraser.svg"/></div> <div class="pixelDrawToolMobileSide" id="pixelDrawToolMobileSide_fill" data-type="fill"><img src="icons/svg/glyphicons-basic-245-fill.svg"/></div> <div class="pixelDrawToolMobileSide" id="pixelDrawToolMobileSide_select" data-type="select"><img src="icons/select@2x.png"/></div> <div class="pixelDrawToolMobileSide" id="pixelDrawToolMobileSide_move" data-type="move"><img src="icons/move@2x.png"/></div> <div class="pixelDrawToolMobileSide" id="pixelDrawToolMobileSide_hand" data-type="hand"><img src="icons/svg/glyphicons-basic-457-hand-open.svg"/></div> <div class="pixelDrawToolMobileSide" id="pixelDrawToolMobileSide_line" data-type="line"><img src="icons/svg/slash.svg"/></div> <div class="pixelDrawToolMobileSide" id="pixelDrawToolMobileSide_rect" data-type="rect"><img src="icons/svg/square.svg"/></div> <div class="pixelDrawToolMobileSide" id="pixelDrawToolMobileSide_oval" data-type="oval"><img src="icons/svg/circle.svg"/></div> </div> </div> <div style="position: absolute; left: 0px; right: 0; bottom: 8px; height: 130px; text-align: center"> <div style="margin-bottom: 2px">Layers</div> <img id="pixelLayersButtonMobile" style="filter: invert(60%)" src="icons/material/baseline-layers-24px.svg" height="40"/> <div style="margin-bottom: 2px">Cell</div> <div id="pixelDrawToolsMobile-cellColor" style="position: relative; height: 50px; margin-bottom: 6px"> <div style="position: absolute; top: 2px; left: 7px; width: 34px; height: 34px; z-index: 6" id="cellForegroundColorMobile" class="foregroundColorMobile"></div> </div> </div> </div> ';g_htmlCache["html/textMode/exportX16Assembly.html"]='<div class="panelFill dialogContent" id="exportX16AssemblyPanel" style="overflow: hidden;"> <div style="position: absolute; top: 10px; left: 10px; right: 10px; height: 30px;"> <div class="formGroup"> <label class="controlLabel" for="exportX16AssemblyAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportX16AssemblyAs"/> <div id="exportX16AssemblyDownload" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg"/> Download</div> </div> </div> <div style="position: absolute; top: 50px; left: 10px; right: 10px; bottom: 100px"> <div id="exportX16AssemblySource" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0"></div> </div> <div style="position: absolute; bottom: 10px; height: 80px; left: 10px; right: 10px"> <div> <div class="formGroup" style="display: inline-block"> <label class="rb-container">ACME <input type="radio" class="formControl" size="20" value="acme" checked="checked" name="exportX16AssemblyFormat" id="exportX16AssemblyFormatAcme"/> <span class="checkmark"></span> </label> <label class="rb-container">Kick Ass <input type="radio" class="formControl" size="20" value="kickass" name="exportX16AssemblyFormat" id="exportX16AssemblyFormatKickAss"/> <span class="checkmark"></span> </label> <label class="rb-container">CA65 <input type="radio" class="formControl" size="20" value="ca65" name="exportX16AssemblyFormat" id="exportX16AssemblyFormatCA65"/> <span class="checkmark"></span> </label> <label class="rb-container">TASS <input type="radio" class="formControl" size="20" value="tass" name="exportX16AssemblyFormat" id="exportX16AssemblyFormatTASS"/> <span class="checkmark"></span> </label> </div> <div class="formGroup" style="display: inline-block"> <label class="controlLabel" for="exportX16AssemblyNumberFormat">Number Format:</label> <div style="display: inline-block"> <label class="rb-container">Hex <input type="radio" class="formControl" size="20" value="hex" checked="checked" name="exportX16NumberFormat" id="exportX16AssemblyNumberFormatHex"/> <span class="checkmark"></span> </label> <label class="rb-container">Dec <input type="radio" class="formControl" size="20" value="dec" name="exportX16NumberFormat" id="exportX16AssemblyNumberFormatDec"/> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup" style="display: inline-block"> <label class="controlLabel" for="exportX16AssemblyFromFrame">Frames:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="exportX16AssemblyFromFrame"> &nbsp; <label for="exportX16AssemblyToFrame">To</label> &nbsp; <input type="number" size="2" class="number" min="1" id="exportX16AssemblyToFrame"> </div> </div> </div> <div class="formGroup"> <div class="checkboxGroup"> <label class="cb-container">Colour Palette <input type="checkbox" id="exportX16AssemblyColorPalette" class="exportX16AssemblyInclude" checked="checked"/> <span class="checkmark"></span> </label> <label class="cb-container">Tile Data <input type="checkbox" id="exportX16AssemblyCharactersetData" class="exportX16AssemblyInclude" checked="checked"/> <span class="checkmark"></span> </label> <div id="exportX16AssemblyBlockDataHolder" style="display: inline-block"> <label class="cb-container">MetaTile Data <input type="checkbox" id="exportX16AssemblyBlockData" class="exportX16AssemblyInclude" checked="checked"/> <span class="checkmark"></span> </label> </div> <div id="exportX16AssemblyBlockColorDataHolder" style="display: inline-block"> <label class="cb-container">Block Colour Data <input type="checkbox" id="exportX16AssemblyBlockColorData" class="exportX16AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportX16AssemblyMapDataHolder" style="display: inline-block"> <label class="cb-container">Map Character Data <input type="checkbox" id="exportX16AssemblyMapData" class="exportX16AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportX16AssemblyBlockMapDataHolder" style="display: inline-block"> <label class="cb-container">Map Block Data <input type="checkbox" id="exportX16AssemblyBlockMapData" class="exportX16AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportX16AssemblyMapColorDataHolder" style="display: inline-block"> <label class="cb-container">Map Colour Data <input type="checkbox" id="exportX16AssemblyMapColorData" class="exportX16AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel">Layers:</label> <div class="radioGroup"> <label class="rb-container">Current Layer <input type="radio" name="exportX16AssemblyLayer" id="exportX16AssemblyLayerCurrent" value="current" checked="checked"/> <span class="checkmark"></span> </label> </div> </div> </div> </div> ';g_htmlCache["html/textMode/export3dAsGifPreview.html"]='<div class="panelFill"> <div style="position: absolute; left: 10px; top: 10px;"><div style="display: inline-block" id="export3dGIFInfo"></div></div> <div style="position: absolute; top: 30px; left: 10px; right: 10px; bottom: 46px" id="export3dGifPreviewHolder"> <canvas id="export3dGifPreview" style="border: 1px solid #aaaaaa;"></canvas> <canvas id="export3dGifRenderCanvas" style="position: absolute; top: 3000px; left: 0"></canvas> </div> <div style="position: absolute; left: 10px; bottom: 10px"> <label class="controlLabel" for="export3dGifPreviewScale">Preview Scale</label> <input id="export3dGifPreviewScale" style="width: 180px" type="range" min="1" max="2500" value="50" size="3"> <input id="export3dGifPreviewScaleText" class="number" type="text" style="width: 30px" min="1" max="1500" value="100" size="2"> <button type="button" id="export3dGifPreviewScaleReset">R</button> </div> </div> ';g_htmlCache["html/textMode/referenceImageDialogMobile.html"]='<div class="panelFill dialogContent" id="mobile_refLayer"> <div style="position: absolute; top: 0; left: 0; right: 0; height: 280px; background-color: #111111; border-bottom: 1px solid #555555; padding: 6px"> <div style="margin: 8px 0 14px 0"> <div class="ui-button" id="mobile_refLayerSourceChooseFile">Choose Image</div> &nbsp;&nbsp; <div class="ui-button" id="mobile_refLayerClearImage">Clear Image</div> <input class="formControl" id="mobile_refLayerSourceFile" style="position: absolute; top: -50px; left: -100px" type="file" accept="image/*"/> </div> <div style="text-align: center; margin-bottom: 10px"> <canvas width="320" height="200" id="mobile_refImageCanvas" style="border:1px solid white; background-color: #393939"></canvas> </div> </div> <div id="mobile_refImageControlsContainer" style="position: absolute; top: 292px; left: 0; right: 0; bottom: 0; overflow: auto; padding: 6px; display: none"> <div class="formRow"> <label for="mobile_refImageScale" class="controlLabel">Scale (%)</label> <input size="3" style="width: 40px" type="text" id="mobile_refImageScale" class="number" value="100"/> <div class="rangeHolder"> <input type="range" class="range" min="1" max="500" value="0" id="mobile_refImageScaleRange"/> </div> <div class="ui-button rangeButton" id="mobile_refImageScaleToFit">Fit</div> </div> <div class="formRow"> <label for="mobile_refImageRotation" class="controlLabel">Rotation</label> <input size="3" style="width: 40px" type="text" id="mobile_refImageRotation" class="number" value="0"/> <div class="rangeHolder"> <input type="range" class="range" min="0" max="359" value="0" id="mobile_refImageRotationRange"/> </div> <div class="ui-button rangeButton" id="mobile_refImageRotation90">90</div> </div> <div class="formRow" style="display: none"> <label class="controlLabel">Position</label> <label for="mobile_refImageX">X</label>: <input size="3" style="width: 35px" type="text" id="mobile_refImageX" class="number" value="0"/> &nbsp;&nbsp; <label for="mobile_refImageY">Y</label>: <input size="3" style="width: 35px" type="text" id="mobile_refImageY" class="number" value="0"/> </div> <div class="formRow"> <label class="controlLabel">Brightness</label> <input type="text" style="width: 40px" id="mobile_refImageBrightnessValue" value="0" class="number" min="-100" max="100" size="2"/> <div class="rangeHolder"> <input type="range" min="-100" max="100" value="0" size="3" id="mobile_refImageBrightness"/> </div> <div class="ui-button rangeButton" id="mobile_refImageBrightnessReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel">Contrast</label> <input type="text" class="number" style="width: 40px" min="-100" max="100" value="0" size="2" id="mobile_refImageContrastValue"/> <div class="rangeHolder"> <input type="range" class="" min="-100" max="100" value="0" size="3" id="mobile_refImageContrast"/> </div> <div class="ui-button rangeButton" id="mobile_refImageContrastReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel">Saturation</label> <input style="width: 40px" type="text" class="number" min="-100" max="100" value="0" size="2" id="mobile_refImageSaturationValue"/> <div class="rangeHolder"> <input type="range" min="-100" max="100" value="0" id="mobile_refImageSaturation"/> </div> <div class="ui-button rangeButton" id="mobile_refImageSaturationReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel">Colour Reduction:</label> <select id="mobile_refImageColorReduction" name="mobile_refImageColorReduction"> <option value="none">None</option> <option value="closest">Closest</option> <option value="dither">Dither</option> </select> </div> <div class="formRow" id="mobile_refImageDitherGroup"> <label class="controlLabel">Dither Method:</label> <select name="mobile_refImageDither" id="mobile_refImageDither"> <option value="FloydSteinberg" selected="selected">Floyd Steinberg</option> <option value="Atkinson">Atkinson</option> <option value="Sierra">Sierra</option> <option value="TwoSierra">Two Sierra</option> <option value="Stucki">Stucki</option> <option value="Jarvis">Jarvis</option> <option value="Burkes">Burkes</option> </select> </div> <div class="formRow" id="mobile_refImageUseColorsRow"> <label class="controlLabel">Use Colours:</label> <div class="radioGroup"> <select id="mobile_refImageUseColors" name="mobile_refImageUseColors"> <option value="all">All Colours</option> <option value="greyscale">Greyscale</option> <option value="choose">Custom Set</option> </select> <br/> </div> <div style="padding: 4px 0 2px 8px"> <label class="cb-container">Limit Colours Per Cell <input type="checkbox" id="mobile_refImageLimitPerCell"> <span class="checkmark"></span> </label> </div> </div> <div class="formRow" style="padding: 4px; display: none" id="mobile_refImageChooseColorsRow"> <label class="controlLabel">&nbsp;</label> <div class="ui-button" id="mobile_refImageChooseColors" type="button">Choose Colours...</div> <div id="mobile_refImageChooseColorsCount"> </div> </div> </div> </div> ';g_htmlCache["html/textMode/exportGifMobile.html"]='<div class="panelFill"> <div style="display: inline-block" id="exportGIFMobileInfo"></div> <div style="position: absolute; top: 0; left: 0; right: 0; height: 260px; background-color: #111111; border-bottom: 1px solid #555555; padding: 6px"> <div style="text-align: center; padding-top: 20px"> <canvas id="exportGIFMobilePreview" style="border: 1px solid #aaaaaa"></canvas> </div> <div class="ui-button ui-button-other" id="exportGIFMobileSaveGDrive" style="margin-top: 10px">Save To Google Drive</div> </div> <div style="position: absolute; top: 272px; left: 0; right: 0; bottom: 0; overflow: auto; padding: 6px"> <div class="formRow"> <label class="controlLabel" for="GIFExportMobilePreviewScale">Preview Scale</label> <input id="GIFExportMobilePreviewScaleText" class="number" type="text" style="width: 40px" min="1" max="5000" value="100" size="2"> <div class="rangeHolder"> <input id="GIFExportMobilePreviewScale" style="width: 100%" type="range" min="20" max="500" value="100" size="3"> </div> <div class="ui-button rangeButton" id="GIFExportPreviewMobileScaleReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel" for="exportGIFMobileAs">File name</label> <input type="text" class="formControl" size="20" value="" id="exportGIFMobileAs"/> </div> <div class="formRow"> <label class="controlLabel" for="exportGIFMobileScale">Scale</label> <select class="formControl" id="exportGIFMobileScale"> <option value="1">100%</option> <option value="2">200%</option> <option value="3">300%</option> <option value="4">400%</option> <option value="5">500%</option> </select> </div> <div class="formRow" style="display: block; padding: 10px 0"> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <label class="cb-container"> Include Border <input type="checkbox" id="exportGIFMobileIncludeBorder" value="1"/> <span class="checkmark"/> </label> </div> </div> </div> </div> <div id="exportGIFMobileProgress" style="display: none; position: absolute; background-color: #222222; left: 5px; right: 5px; top: 5px; bottom: 5px; z-index: 2000; padding: 6px"> </div> </div> ';g_htmlCache["html/textMode/exportImage.html"]='<div class="panelFill" id="exportImagePanel"> <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0px; overflow: auto; padding: 10px"> <div class="formGroup"> <label class="controlLabel" for="exportImageAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportImageAs"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportImageFormat">Format:</label> <label class="rb-container">GIF <input type="radio" name="exportImageFormat" value="gif" checked="checked"> <span class="checkmark"></span> </label> <label class="rb-container">PNG <input type="radio" name="exportImageFormat" value="png"> <span class="checkmark"></span> </label> </div> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <label class="cb-container">Include Border <input type="checkbox" id="exportImageIncludeBorder" value="1"/> <span class="checkmark"></span> </label> </div> <div class="formGroup" id="borderSizeHolder" style="margin-bottom: 8px"> <label class="controlLabel">Border Size</label> W: <input type="number" class="number" min="0" max="100" id="exportImageBorderWidth" value="32"> &nbsp;&nbsp; H: <input type="number" class="number" min="0" max="100" id="exportImageBorderHeight" value="36"> &nbsp; <div class="ui-button" id="exportImageBorderReset">Reset</div> </div> <div class="formGroup"> <label class="controlLabel">Scale:</label> <div class="ui-button" id="exportImageScale-dec">-</div> <select class="formControl" id="exportImageScale"> <option value="1">100%</option> <option value="2">200%</option> <option value="3">300%</option> <option value="4">400%</option> <option value="5">500%</option> </select> <div class="ui-button" id="exportImageScale-inc">+</div> </div> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <div style="display: inline-block" id="exportImageDimensions"></div> </div> <div class="formGroup"> <label class="controlLabel">Include Layers:</label> <div class="radioGroup"> <label class="rb-container">Current Layer <input type="radio" name="exportImageLayer" id="exportImageLayerCurrent" value="current"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">Visible Layers <input type="radio" name="exportImageLayer" id="exportImageLayerVisible" value="visible" checked="checked"> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">All Layers <input type="radio" name="exportImageLayer" id="exportImageLayerAll" value="all"> <span class="checkmark"></span> </label> </div> </div> </div> </div> ';g_htmlCache["html/textMode/exportPng.html"]='<div class="panelFill" id="exportPngPanel"> <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0px; padding: 10px; overflow: auto"> <div class="formGroup"> <label class="controlLabel" for="exportPNGAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportPNGAs"/> </div> <div class="formGroup"> <label class="controlLabel">Scale:</label> <div class="radioGroup" style="margin-top: 6px"> <label class="rb-container">100% <input type="radio" name="exportPNGScale" id="exportPNGScale1" value="1" checked="checked"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">200% <input type="radio" name="exportPNGScale" id="exportPNGScale2" value="2"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">300% <input type="radio" name="exportPNGScale" id="exportPNGScale3" value="3"/> <span class="checkmark"></span> </label> &nbsp;&nbsp; <label class="rb-container">400% <input type="radio" name="exportPNGScale" id="exportPNGScale3" value="4"/> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <label class="cb-container">Include Border <input type="checkbox" id="exportPNGIncludeBorder" value="1"/> <span class="checkmark"></span> </label> </div> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <label class="cb-container">Add Transparent Pixel <input type="checkbox" id="exportPNGTransparentPixel" value="1"/> <span class="checkmark"></span> </label> </div> <div class="formGroup"> <label class="controlLabel">Include Layers:</label> <div class="radioGroup"> <div> <label class="rb-container">Current Layer Only <input type="radio" name="exportPNGLayer" id="exportPNGLayerCurrent" value="current"/> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">Visible Layers <input type="radio" name="exportPNGLayer" id="exportPNGLayerVisible" value="visible" checked="checked"/> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">All Layers <input type="radio" name="exportPNGLayer" id="exportPNGLayerAll" value="all"> <span class="checkmark"></span> </label> </div> </div> </div> </div> </div> ';g_htmlCache["html/textMode/drawTools.html"]='<div class="activeBackground panelFill" id="toolsPanel"> <div class="title" style="background-color: #111111; height: 18px;"> <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 10px; overflow: hidden; white-space: nowrap"> <span class="ui-text" data-textid="Tile Tools">Tile Tools</span> </div> <div style="position: absolute; top: 2px; right: 2px; width: 14px"> <div id="tileToolsCloseButton" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-halflings-130-chevron-left.svg"></div> </div> </div> <div id="toolIconHolder" style="padding: 8px"> <div> <div class="drawTool drawToolSelected" id="drawTool_pen"><img width="20" src="icons/pen@2x.png" title="Pencil (n)"/></div> <div class="drawTool" id="drawTool_erase"><img width="20" src="icons/erase@2x.png" title="Blank (l)"/></div> <div class="drawTool" id="drawTool_fill"><img width="20" src="icons/fill@2x.png" title="Fill Bucket (k)"/></div> <div class="drawTool" id="drawTool_eyedropper"><img width="20" src="icons/eyedropper@2x.png" title="Eyedropper (i)"/></div> <div class="drawTool" id="drawTool_line"><img width="20" src="icons/line@2x.png" title="Line (u)"/></div> <div class="drawTool" id="drawTool_rect"><img width="20" src="icons/rect@2x.png" title="Rect (u)"/></div> <div class="drawTool" id="drawTool_oval"><img width="20" src="icons/oval@2x.png" title="Oval (u)"/></div> <div class="drawTool" id="drawTool_select"><img width="20" src="icons/select@2x.png" title="Marquee (m)"/></div> <div class="drawTool" id="drawTool_charpixel"><img width="20" src="icons/charpixel@2x.png" title="Char Pixel (o)"/></div> <div class="drawTool" id="drawTool_linesegment"><img width="20" src="icons/linesegment@2x.png" title="Line Segments"/></div> <div class="drawTool" id="drawTool_type"><img width="20" src="icons/type@2x.png" title="Type (t)"/></div> <div class="drawTool" id="drawTool_pixel"><img width="20" src="icons/pixel@2x.png" title="Pixel (p)"/></div> <div class="drawTool" id="drawTool_block"><img width="20" src="icons/block@2x.png" title="Meta Tile (b)"/></div> <div class="drawTool" id="drawTool_zoom"><img width="20" src="icons/zoom@2x.png" title="Zoom (z)"/></div> <div class="drawTool" id="drawTool_hand"><img width="20" src="icons/hand@2x.png" title="Hand (h)"/></div> <div class="drawTool" id="drawTool_move"><img width="20" src="icons/move@2x.png" title="Move (v)"/></div> </div> <div id="currentTool" style="font-size: 10px; white-space: nowrap; margin-top: 2px"></div> </div> <div id="drawTools-cellColor" style="position: relative; padding: 0px 8px 0px 8px; height: 68px"> <h3 id="drawTools-cellColorHeading" style="font-size: 10px; padding-bottom: 2px"><span class="ui-text" data-textid="Cell">Cell</span></h3> <div id="cellForegroundColor" class="foregroundColor colorSetting"></div> <div style="display: block; position: absolute; top: 34px; left: 22px; width: 28px; height: 28px; background-color: #000000; z-index: 5;" id="cellBackgroundColor" class="cellBackgroundColor colorSetting"></div> <img src="icons/switch.png" id="switchColors" title="Switch Colours (x)"/> </div> <div id="drawTools-c64multicolor" style="padding: 0px 8px 0px 8px; display: none"> <h3 style="font-size: 10px; padding-bottom: 2px">Multi</h3> <div> <div style="display: inline-block; width: 24px; height: 24px; background-color: #000000;" id="c64Multi1Color" class="c64Multi1Color colorSetting"></div> <div style="display: inline-block; width: 24px; height: 24px; background-color: #000000;" id="c64Multi2Color" class="c64Multi2Color colorSetting"></div> </div> </div> <div style="position: relative; display: none; padding: 0px 8px 0px 8px; height: 260px;" id="drawTools-colorSubPalettes"> <h3 style="font-size: 10px; padding-bottom: 2px">Palette</h3> <div style="position: relative; width: 54px; height: 16px; background-color: #000000; border: 1px solid #aaaaaa; z-index: 5" id="Palette" class="colorSubPalette"> <div style="position: absolute; left: 1px; top: 1px; width: 14px; height: 14px"> <div class="colorSubPaletteColor0" style="position: absolute; top: 0px; left: 0px; width: 50%; height: 50%;"></div> <div class="colorSubPaletteColor1"style="position: absolute; top: 0px; right: 0px; width: 50%; height: 50%;"></div> <div class="colorSubPaletteColor2"style="position: absolute; bottom: 0px; left: 0px; width: 50%; height: 50%;"></div> <div class="colorSubPaletteColor3"style="position: absolute; bottom: 0px; right: 0px; width: 50%; height: 50%;"></div> </div> <div class="colorSubPaletteSelectedPaletteName" style="font-size: 8px; position: absolute; top: 3px; left: 17px">Selected Sub Palette</div> </div> <div style="margin-top: 4px"> <div style="font-size: 8px">Colour 0</div> <div style="display: block; margin-top: 2px; width: 24px; height: 24px; background-color: #000000; border: 1px solid #aaaaaa" id="colorSubPaletteColor0" class="colorSubPaletteColor colorSubPaletteColor0" data-paletteIndex="0"></div> </div> <div style="margin-top: 4px"> <div style="font-size: 8px">Colour 1</div> <div style="display: block; margin-top: 2px; width: 24px; height: 24px; background-color: #000000; border: 1px solid #aaaaaa" id="colorSubPaletteColor1" class="colorSubPaletteColor colorSubPaletteColor1" data-paletteIndex="1"></div> </div> <div style="margin-top: 4px"> <div style="font-size: 8px">Colour 2</div> <div style="display: block; margin-top: 2px; width: 24px; height: 24px; background-color: #000000; border: 1px solid #aaaaaa" id="colorSubPaletteColor2" class="colorSubPaletteColor colorSubPaletteColor2" data-paletteIndex="2"></div> </div> <div style="margin-top: 4px"> <div style="font-size: 8px">Colour 3</div> <div style="display: block; margin-top: 2px; width: 24px; height: 24px; background-color: #000000; border: 1px solid #aaaaaa" id="colorSubPaletteColor3" class="colorSubPaletteColor colorSubPaletteColor3" data-paletteIndex="3"></div> </div> </div> <div id="drawTools-frameColors" style="padding: 0px 8px 0px 8px; position: relative; height: 66px"> <h3 style="font-size: 10px; padding-bottom: 2px"><span class="ui-text" data-textid="Frame">Frame</span></h3> <div style="display: block; position: absolute; top: 20px; left: 8px; width: 56px; height: 46px; background-color: #000000; z-index: 5" id="borderColor" class="borderColor colorSetting"></div> <div style="display: block; position: absolute; top: 30px; left: 18px; width: 36px; height: 26px; background-color: #000000; z-index: 10" id="backgroundColor" class="backgroundColor colorSetting"></div> </div> <div id="drawTools-3dBackgroundColor" style="padding: 0px 8px 0px 8px; position: relative; height: 66px; display: none"> <h3 style="font-size: 10px; padding-bottom: 2px"><span class="ui-text" data-textid="Frame">Background</span></h3> <div style="display: block; position: absolute; top: 30px; left: 18px; width: 36px; height: 26px; background-color: #000000; z-index: 10" id="background3dColor" class="background3dColor colorSetting"></div> </div> </div> ';g_htmlCache["html/textMode/tileSetSave.html"]='<div class="panelFill dialogContent" id="saveTileSetPanel"> <div class="formGroup"> <label class="controlLabel" for="saveTileSetAs">File name:</label> <input type="text" class="formControl" size="20" value="Untitled" id="saveTileSetAs"/> </div> <div class="formGroup"> <label class="controlLabel">Format:</label> <select name="saveTileSetFormat" id="saveTileSetFormat"> <option value="json">JSON (Native)</option> <option value="png">PNG</option> <option value="bin">Binary</option> </select> </div> <div class="formGroup" id="saveTilesSetTilesAcrossSection" style="display: none"> <label class="controlLabel">Tiles Across:</label> <input type="text" class="formControl number" min="1" value="16" id="saveTileSetTilesAcross" size="2"/> </div> </div> ';g_htmlCache["html/textMode/importImageEffects.html"]='<div class="panelFill"> <div style="position: absolute; padding: 10px; top: 0; left: 0; right: 0px; height: 85px; overflow: auto"> <h3><i class="halflings halflings-star-empty"/>&nbsp;Effects</h3> <div> <label class="controlLabel" for="importImageUseEffects" style="margin-top: 0">Use Effects</label> <label class="cb-container">&nbsp; <input type="checkbox" id="importImageUseEffects"> <span class="checkmark"></span> </label> </div> <div id="importImagePreviewAnimationRow" style="display: none; margin-top: 4px"> <label class="controlLabel" for="importImagePreviewAnimation" style="margin-top: 0">Show Preview</label> <label class="cb-container">&nbsp; <input type="checkbox" id="importImagePreviewAnimation" checked="checked"/> <span class="checkmark"></span> </label> </div> </div> <div id="importImageEffectsBorder" style="position: absolute; padding: 4px; top: 85px; left: 0; right: 0; height: 2px; display: none"> <div class="formRow"></div> </div> <div id="importEffectsHolder" style="position: absolute; padding: 4px; top: 96px; left: 0; right: 0; bottom: 0px; overflow: auto;"> <div id="importImageEffectsHolder" style=" display: none"> </div> </div> </div> </div>';g_htmlCache["html/textMode/importVideo.html"]='<div class="panelFill"> <div class="content"> <div style="padding: 4px; text-align: center"> <table> <tr> <td> <div class="formGroup"> <label class="controlLabel" for="importVideoSourceFile">File To Import:</label> <input class="formControl" id="importVideoSourceFile" type="file" accept=".mp4"> </div> <table> <tr> <td> <canvas width="320" height="200" id="importVideoCanvas" style="border:1px solid white; background: transparent"></canvas> </td> <td> <div style="padding: 4px"> <label for="importVideoScale">Scale</label> <button type="button" id="importVideoScaleDecrease">-</button> <input size="3" id="importVideoScale" value="100"/> <button type="button" id="importVideoScaleIncrease">+</button> % &nbsp;&nbsp; <button type="button" id="importVideoScaleToFit">Scale To Fit</button> </div> <div style="padding: 4px"> <label>Position</label> <label for="importVideoX">X</label> <input size="3" id="importVideoX" value="0"/> &nbsp;&nbsp; <label for="importVideoY">Y</label> <input size="3" id="importVideoY" value="0"/> </div> <div style="padding: 4px"> <label><input type="checkbox" id="importVideoQuantise" value="1" checked="checked">Quantise Colours </label> </div> <div> <label><input type="radio" name="importVideoDither" checked="checked" value="">No Dither</label> <label><input type="radio" name="importVideoDither" checked="checked" value="FloydSteinberg">Floyd Steinberg</label> <label><input type="radio" name="importVideoDither" value="Atkinson">Atkinson</label> <label><input type="radio" name="importVideoDither" value="Sierra">Sierra</label> </div> <div> <label>Brightness: <input type="text" id="importVideoBrightnessValue" value="0" class="number" min="-100" max="100" size="2"/> <input type="range" min="-100" max="100" value="0" size="3" id="importVideoBrightness"/> </label> </div> <div> <label>Contrast: <input type="text" class="number" min="-100" max="100" value="0" size="2" id="importImageContrastValue"/> <input type="range" class="" min="-100" max="100" value="0" size="3" id="importImageContrast"/></label> </div> <div> <label>Saturation: <input type="text" class="number" min="-100" max="100" value="0" size="2" id="importImageSaturationValue"/> <input type="range" min="-100" max="100" value="0" id="importImageSaturation"/> </label> </div> <div style="padding: 4px"> <label><input type="checkbox" id="importImageEdgeDetect" value="1">Edge Detection</label> </div> <div style="padding: 4px"> <label>Low Threshold: <input type="text" id="importImageEdgeDetectLow" value="20" class="number" min="0" max="100" size="2"/> </label> <label>High Threshold: <input type="text" id="importImageEdgeDetectHigh" value="90" class="number" min="0" max="100" size="2"/> </label> <label>Blur Radius: <input type="text" id="importImageEdgeDetectBlur" value="3" class="number" min="0" max="100" size="2"/> </label> </div> </td> </tr> </table> </tr> </table> </div> <div class="formGroup"> <label><input type="checkbox" id="importImageUseShader" checked="checked"> Use Shader to Convert (faster)</label> </div> <div class="formGroup"> <label class="controlLabel">Use Colours:</label> <div class="radioGroup"> <div> <label><input type="radio" name="importImageUseColors" value="all" checked="checked">All Colours</label> &nbsp; <label><input type="radio" name="importImageUseColors" value="greyscale">Greyscale</label> &nbsp; <label><input type="radio" name="importImageUseColors" value="choose">Custom Set</label> &nbsp; <label><input type="radio" name="importImageUseColors" value="create">Create Palette From Image</label> </div> <div style="padding: 4px; display: none" id="importImageChooseColorsRow"> <button id="importImageChooseColors" type="button">Choose Colours...</button> </div> <div style="padding: 4px; display: none" id="importImageCreatePalette"> Create <select id="importImageCreatePaletteColorCount"> <option value="2">2</option> <option value="4">4</option> <option value="8">8</option> <option value="16" selected="selected">16</option> <option value="32">32</option> <option value="64">64</option> <option value="128">128</option> <option value="256">256</option> </select> Colours <div> Colour palette will replace current colour palette </div> </div> </div> </div> <div class="formGroup"> <label class="controlLabel">BG Colour:</label> <div class="radioGroup"> <div> <label><input type="radio" name="importImageBackgroundColorChoose" value="auto" checked="checked">Choose Automatically</label> <label><input type="radio" name="importImageBackgroundColorChoose" value="manual">Choose Manually</label> </div> <div style="padding: 4px;display: none" id="importImageUseBackgroundColor"> Use colour: &nbsp; <div id="importImageBackgroundColor" class="backgroundColor" style="display: inline-block; width: 16px; height: 16px; border: 1px solid #eee"></div> </div> </div> </div> <div class="formGroup"> <label class="controlLabel"></label> <div class="checkboxGroup"> <label><input type="checkbox" value="1" id="petsciiMultipleBackgroundColors"> Multiple background colours</label> <div style="margin-left: 12px"> <label><input type="checkbox" value="1" id="petsciiMultipleBackgroundColorsLimit" checked="checked">Limit to 4</label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel">Use Characters:</label> <div class="radioGroup"> <label><input type="radio" name="importImageUseChars" value="all" checked="checked">All Characters</label> &nbsp; <label><input type="radio" name="importImageUseChars" value="choose">Custom Set</label> <div style="padding: 4px; display: none" id="importImageChooseCharsRow"> <button id="importImageChooseChars" type="button">Choose Characters...</button> </div> </div> </div> <div class="formGroup"> <label class="controlLabel">Animate: </label> <div class="radioGroup"> <label><input type="radio" checked="checked" name="petsciiImportAnimate" value="none" id="petsciiImportAnimateNone">None</label> <label><input type="radio" name="petsciiImportAnimate" value="zoom" id="petsciiImportAnimateZoom">Zoom</label> <label><input type="radio" name="petsciiImportAnimate" value="rotate" id="petsciiImportAnimateRotate">Rotate</label> <label><input type="radio" name="petsciiImportAnimate" value="pan" id="petsciiImportAnimateRotate">Pan</label> <label><input type="radio" name="petsciiImportAnimate" value="mirror" id="petsciiImportAnimateMirror">Mirror</label> <label><input type="radio" name="petsciiImportAnimate" value="imageParams" id="petsciiImportAnimateImageParams">Image Parameters</label> <div id="petsciiAnimateTicksControls"> <div> <label><input type="checkbox" id="petsciiImportPreviewAnimation"> Preview Animation</label> </div> <div> <label for="importImageFrames"> Frames </label> <input type="text" class="formControl number" value="12" min="1" size="4" id="importImageFrames"/> </div> <div> <label for="petsciiAnimateTicksPerFrame"> Ticks per frame </label> <input type="text" size="4" class="number" min="3" id="petsciiAnimateTicksPerFrame" value="12"/> </div> </div> <div style="padding: 4px; display: none" id="petsciiImportZoomControls"> <div> Zoom <input type="text" class="formControl number" min="1" size="4" name="petsciiImportZoomAmount" id="petsciiImportZoomAmount" value="1000"/> % &nbsp;&nbsp;in&nbsp;&nbsp; <input size="4" name="petsciiImportZoomFrames" class="number" min="1" id="petsciiImportZoomFrames" value="12"/> Frames </div> <div> <label><input type="checkbox" id="petsciiImportZoomInfinite" value="1"> Infinite Zoom</label> <label><input type="checkbox" id="petsciiImportZoomRotate" value="1"> Rotate</label> </div> <div> <label><input size="4" class="number" min="0" max="180" value="45" id="petsciiImportZoomRotateAngleSeparation" value="1"> Layer Angle Separation</label> </div> <div> Zoom Point: <label>x <input size="4" class="number" min="0" name="petsciiImportZoomX" id="petsciiImportZoomX" value="160"/></label> <label>y <input size="4" class="number" min="0" name="petsciiImportZoomY" id="petsciiImportZoomY" value="100"/></label> </div> </div> <div style="padding: 4px; display: none" id="petsciiImportRotateControls"> &nbsp;&nbsp; Rotate Point: <label>x <input size="4" class="number" min="0" name="petsciiImportRotateX" id="petsciiImportRotateX" value="160"/></label> <label>y <input size="4" class="number" min="0" name="petsciiImportRotateY" id="petsciiImportRotateY" value="100"/></label> <br/> <label>Frames: <input size="4" class="number" min="1" name="petsciiImportRotateFrames" id="petsciiImportRotateFrames" value="12"/></label> <br/> <label><input type="radio" name="petsciiImportRotateDirection" value="clockwise" checked="checked"/>Clockwise</label> <label><input type="radio" name="petsciiImportRotateDirection" value="anticlockwise"/>Anticlockwise</label> </div> <div style="padding: 4px; display: none" id="importImageMirrorControls"> mirror controls... </div> <div style="padding: 4px; display: none" id="petsciiImportPanControls"> <label>Frames: <input size="4" class="number" min="1" name="petsciiImportPanFrames" id="petsciiImportPanFrames" value="12"/></label><br/> <label>Horizontal Pan: <input size="4" class="number" min="0" id="petsciiImportPanX" value="1"/> Pixels / frame</label><br/> <label>Vertical Pan: <input size="4" class="number" min="0" id="petsciiImportPanY" value="0"/> Pixels / frame</label> </div> <div style="padding: 4px; display: none" id="petsciiImportImageParamControls"> <label>Frames: <input size="4" class="number" min="1" name="petsciiImportImageParamFrames" id="petsciiImportImageParamFrames" value="12"/></label><br/> <div> <label><input type="checkbox" checked="checked" id="petsciiImportAnimateBrightness"/> Brightness</label> <label>From <input size="5" class="number" min="-100" max="100" id="petsciiImportBrightnessFrom" value="0"/></label> <label>To <input size="5" class="number" min="-100" max="100" id="petsciiImportBrightnessTo" value="50"/></label> </div> <div> <label><input type="checkbox" checked="checked" id="petsciiImportAnimateContrast"/> Contrast</label> <label>From <input size="5" class="number" min="-100" max="100" id="petsciiImportContrastFrom" value="0"/></label> <label>To <input size="5" class="number" min="-100" max="100" id="petsciiImportContrastTo" value="50"/></label> </div> <div> <label><input type="checkbox" checked="checked" id="petsciiImportAnimateSaturation"/> Saturation</label> <label>From <input size="5" class="number" min="-100" max="100" id="petsciiImportSaturationFrom" value="0"/></label> <label>To <input size="5" class="number" min="-100" max="100" id="petsciiImportSaturationTo" value="50"/></label> </div> </div> <div style="padding: 4px; display: none" id="petsciiImportMorphControls"> <label>Frames: <input size="4" class="number" min="1" name="petsciiImportMorphFrames" id="petsciiImportMorphFrames" value="12"/></label><br/> <div>Click on images to define/move matching points</div> </div> </div> </div> </div> </div> ';g_htmlCache["html/textMode/exportC64.html"]='<div class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="exportC64As">File name:</label> <input class="formControl" type="text" size="20" value="" id="exportC64As"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportC64As">Type:</label> <div class="radioGroup"> <select name="exportC64Type" id="exportC64Type"> <option value="prg">PRG</option> <option value="d64">D64</option> </select> </div> </div> <div id="exportC64D64Options" style="display: none"> <div class="formGroup"> <label class="controlLabel" for="exportC64DiskName">Disk Name:</label> <input class="formControl" type="text" size="20" value="Untitled" id="exportC64DiskName"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportC64Name">PRG Name:</label> <input class="formControl" type="text" size="20" value="Untitled" id="exportC64Name"/> </div> </div> <div class="formGroup"> <label class="controlLabel">Screen Mode:</label> <div class="checkboxGroup" style="padding-top: 6px"> <label class="rb-container" style="color: #eeeeee; font-size: 12px">Standard Character Mode <input type="radio" name="exportC64ColorMode" id="exportC64ColorModeStandard" value="standard" checked="checked"> <span class="checkmark"></span> </label> <div style="margin-left: 24px; color: #aaaaaa">256 characters, foreground colour per cell, background colour per frame</div> <br/> <label class="rb-container" style="color: #eeeeee; font-size: 12px">Multicolour Character Mode <input type="radio" name="exportC64ColorMode" id="exportC64ColorModeMulticolor" value="multicolor"> <span class="checkmark"></span> </label> <div style="margin-left: 24px; color: #aaaaaa">256 characters, 3 colours per cell, background colour per frame</div> <br/> <label class="rb-container" style="color: #eeeeee; font-size: 12px">Extended Background Colour Mode <input type="radio" name="exportC64ColorMode" id="exportC64ColorModeExtended" value="extended"/> <span class="checkmark"></span> </label> <div style="margin-left: 24px; color: #aaaaaa">64 characters, foreground colour per cell, background colour per cell, <br/>up to 4 different cell background colours</div> <br/> <label class="rb-container" style="color: #eeeeee; font-size: 12px">Monochrome <input type="radio" name="exportC64ColorMode" id="exportC64ColorModeMonochrome" value="monochrome"/> <span class="checkmark"></span> </label> <div style="margin-left: 24px; color: #aaaaaa">256 characters, one foreground colour, one background colour per frame</div> </div> <div class="formGroup" id="exportC64MonochromeSection" style="display: none"> <label class="controlLabel"></label> <div class="checkboxGroup"> Monochrome Colour: <div id="exportC64MonochromeColor" style="display: inline-block; width: 16px; height: 16px; border: 1px solid white"></div> </div> </div> </div> <div class="formGroup"> <label class="controlLabel" for="exportC64FromFrame">Export Frames:</label> <div style="display: inline-block"> <input size="2" class="number" min="1" id="exportC64FromFrame"> &nbsp; <label for="exportC64ToFrame">To</label> &nbsp; <input size="2" class="number" min="1" id="exportC64ToFrame"> &nbsp; <select name="exportC64LoopType" id="exportC64LoopType"> <option value="loop">Loop</option> <option value="pingpong">Ping Pong</option> </select> </div> </div> <div class="formGroup"> <label class="controlLabel">Music Options:</label> <div class="radioGroup"> <select name="exportC64Music" id="exportC64Music"> </select> <div style="margin-top: 8px; display: none" id="exportC64SidFileSection"> <label for="exportC64SIDFile">SID File</label> <input type="file" id="exportC64SIDFile" accept=".sid,.bin"> <div>SIDs may or may not work</div> <div>SIDs with a load address around $1000 will mostly work..</div> <div id="exportC64SIDFileInfo"> </div> </div> </div> </div> <div> <div id="exportC64LoadingMessage"> <label class="controlLabel">&nbsp;</label> <img src="images/loading.gif"> <span style="font-weight: 600">loading assets...</span> </div> <button id="exportC64DownloadSource" style="display: none; margin-right: 20px" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg">Download Source</button> <button id="exportC64DownloadPRG" style="display: none" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg">Download PRG</button> </div> </div> ';g_htmlCache["html/textMode/exportImageEffects.html"]='<div class="panelFill" id="exportImageEffectsPanel"> <div style="position: absolute; top: 10px; left: 10px; right: 10px; height: 90px"> <h3><i class="halflings halflings-star-empty"></i>&nbsp;Effect</h3> <div style="display: flex"> <div class="ui-button" id="exportImageEffectPrev">&lt;</div> <select id="exportImageEffectOptions" style="width: 100%"> </select> <div class="ui-button" id="exportImageEffectNext">&gt;</div> </div> </div> <div style="position: absolute; top: 90px; left: 0px; right: 0px; bottom: 0px; overflow: auto"> <div id="exportImageEffectControls" style="padding: 10px"> </div> </div> </div>';g_htmlCache["html/textMode/exportGifPreview.html"]='<div class="panelFill"> <div style="position: absolute; left: 10px; top: 10px;"><div style="display: inline-block" id="exportGIFInfo"></div></div> <div style="position: absolute; top: 30px; left: 10px; right: 10px; bottom: 46px" id="exportGifPreviewHolder"> <canvas id="exportGifPreview" style="border: 1px solid #aaaaaa;"></canvas> </div> <div style="position: absolute; left: 10px; bottom: 10px"> <label class="controlLabel" for="gifExportPreviewScale">Preview Scale</label> <input id="gifExportPreviewScale" style="width: 180px" type="range" min="1" max="2500" value="50" size="3"> <input id="gifExportPreviewScaleText" class="number" type="text" style="width: 30px" min="1" max="1500" value="100" size="2"> <button type="button" id="gifExportPreviewScaleReset">R</button> </div> </div> ';g_htmlCache["html/textMode/importImageConverterSettings.html"]='<div class="panelFill"> <div id="importImageAllSettings" style="position: absolute; top: 0px; left: 0; right: 0px; bottom: 0; overflow: auto; padding: 10px"> <h3>Converter Settings</h3> <fieldset class="form-section"> <div class="formRow"> <label class="controlLabel">Import Method:</label> <div> <select name="importImageMethod" id="importImageMethod"> <option value="method1" selected="selected">Method 1</option> <option value="method2">Method 2</option> </select> </div> </div> <div class="formRow"> <label class="controlLabel">BG Colour:</label> <div class="radioGroup" id="importImageBGSettingsC64Standard" style="display: none"> Colour per Frame </div> <div class="radioGroup" id="importImageBGSettings"> <select name="importImageBackgroundColorType" id="importImageBackgroundColorType"> <option value="perCell" selected="selected">Background Colour Per Cell</option> <option value="frame">Background Colour Per Frame</option> </select> <br/> <span style="margin-top: 4px; display: inline-block">Choose \'Background Colour Per Frame\' for \'authentic\' PETSCII</span> </div> </div> <div class="formRow" id="importFrameBGSettings"> <label class="controlLabel">Frame BG Colour:</label> <div class="radioGroup"> <select name="importImageBackgroundColorChoose" id="importImageBackgroundColorChoose"> <option value="auto" selected="selected">Choose Automatically</option> <option value="current">Use Current</option> <option value="manual">Choose</option> </select> <div style="padding: 4px;display: none" id="importImageUseBackgroundColor"> Use colour: &nbsp; <div id="importImageBackgroundColor" class="backgroundColor" style="display: inline-block; width: 16px; height: 16px; border: 1px solid #eee"></div> </div> <br/> <span style="margin-top: 4px; display: inline-block">The best choice for a colour can be where the most detail appears</span> </div> </div> </fieldset> <fieldset class="form-section"> <h3><img src="images/colors.png" width="16" height="16"/> Colours</h3> <div class="formRow"> <label class="controlLabel">Use Colours:</label> <div class="radioGroup"> <select name="importImageUseColors" id="importImageUseColors"> <option value="all">All Colours</option> <option value="greyscale">Greyscale</option> <option value="choose">Custom Colour Set</option> <option value="create">Create Palette From Image</option> </select> <div style="padding: 8px 0 2px 0; display: none" id="importImageChooseColorsRow"> <button id="importImageChooseColors" type="button">Choose Colours...</button> <span id="importImageColoursChosen">0 Colours Chosen</span> </div> <div style="padding: 4px; display: none" id="importImageCreatePalette"> Create <select id="importImageCreatePaletteColorCount"> <option value="2">2</option> <option value="4">4</option> <option value="8">8</option> <option value="16" selected="selected">16</option> <option value="32">32</option> <option value="64">64</option> <option value="128">128</option> <option value="256">256</option> </select> Colours <div style="margin-top: 2px"> The new colour palette will replace the current colour palette </div> </div> </div> </div> <div class="formRow"> <label class="controlLabel">Colour Reduction:</label> <select name="importImageColorReduction" id="importImageColorReduction"> <option value="none">None</option> <option value="closest">Closest</option> <option value="dither" selected="selected">Dither</option> <option value="edge">Edge Detect</option> </select> </div> <div id="importImageDitherGroup"> <div class="formRow"> <label class="controlLabel">Dither Method:</label> <select name="importImageDither" id="importImageDither"> <option value="FloydSteinberg">Floyd Steinberg</option> <option value="Atkinson">Atkinson</option> <option value="Sierra">Sierra</option> <option value="TwoSierra">Two Sierra</option> <option value="Stucki">Stucki</option> <option value="Jarvis">Jarvis</option> <option value="Burkes">Burkes</option> </select> </div> </div> <div class="formRow" id="importImageEdgeDetectionGroup"> <label class="controlLabel">Edge Detection:</label> <div class="radioGroup"> <div> <label>Low Threshold: <input type="text" id="importImageEdgeDetectLow" value="20" class="number" min="0" max="100" size="2"/> </label> <label>High Threshold: <input type="text" id="importImageEdgeDetectHigh" value="90" class="number" min="0" max="100" size="2"/> </label> <label>Blur Radius: <input type="text" id="importImageEdgeDetectBlur" value="3" class="number" min="0" max="100" size="2"/> </label> </div> <div style="padding-top: 2px"> Line Thickness: <label><input type="radio" name="importImageEdgeDetectLineThickness" value="1"/> 1</label> <label><input type="radio" name="importImageEdgeDetectLineThickness" value="2" checked="checked"/> 2</label> </div> </div> </div> </fieldset> <fieldset class="form-section"> <h3><img src="images/chars.png" width="16" height="16"/> Characters</h3> <div class="formRow"> <label class="controlLabel">Use Characters:</label> <div class="radioGroup"> <select name="importImageUseChars" id="importImageUseChars"> <option value="all" selected="selected">All Characters</option> <option value="choose">Custom Set</option> </select> <div style="padding: 8px 0 2px 0; display: none" id="importImageChooseCharsRow"> <button id="importImageChooseChars" type="button">Choose Characters...</button> <span id="importImageCharactersChosen">0 Characters Chosen</span> </div> </div> </div> </fieldset> </div> </div> ';g_htmlCache["html/textMode/blockEditor.html"]='<div id="blockEditor" class="panelFill dialogContent" style="color: white"> <div style="position: absolute; top: 10px; bottom: 40px; left: 10px; right: 10px; overflow: auto" id="blockEditorBlockHolder"> <canvas id="blockEditorBlock" style="position: absolute; top: 0; left:0; bottom: 0; right: 0"></canvas> </div> <div id="blockEditorParams" style="position: absolute; bottom: 10px; height: 20px; left: 10px; right: 0"> <div id="blockDimensionsStatic"> <label>Width: <span id="blockEditorStaticWidth"></span></label> &nbsp; <label>Height: <span id="blockEditorStaticHeight"></span></label> </div> <div id="blockDimensionsEditable" style=""> <label>Width: <input class="number" min="1" max="20" id="blockEditorWidth" value="2" size="2"></label> &nbsp; <label>Height: <input class="number" min="1" max="20" id="blockEditorHeight" value="2" size="2"></label> </div> </div> </div>';g_htmlCache["html/textMode/replaceCharacter.html"]='<div class="panelFill dialogContent" id="replaceCharacterPanel"> <div class="formGroup"> <label class="controlLabel">Replace:</label> <canvas id="replaceCharacterCanvas" width="16" height="16" style="display: inline-block; border: 1px solid white;"></canvas> </div> <div class="formGroup"> <label class="controlLabel">With:</label> <canvas id="replaceWithCharacterCanvas" width="16" height="16" style="display: inline-block; border: 1px solid white;"></canvas> </div> <div class="formGroup"> <label class="controlLabel">Frame</label> <div class="radioGroup"> <div> <label class="rb-container">Current Frame <input type="radio" name="replaceCharacterFrame" value="current" id="replaceCharacterCurrentFrame" checked="checked"> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">All Frames <input type="radio" name="replaceCharacterFrame" value="all" id="replaceCharacterAllFrames"> <span class="checkmark"></span> </label> </div> </div> </div> </div>';g_htmlCache["html/textMode/newColorPalette.html"]='<div id="newColorPaletteDialog" class="panelFill dialogContent"> <div class="formGroup"> <label class="controlLabel" for="newColorPaletteName">Name:</label> <input type="text" class="formControl" id="newColorPaletteName" spellcheck="false"/> </div> </div>';g_htmlCache["html/textMode/exportJson.html"]='<div class="panelFill dialogContent" id="exportJsonPanel"> <div class="formGroup"> <label class="controlLabel" for="exportJsonAs">File name:</label> <input type="text" class="formControl" size="20" value="untitled" id="exportJsonAs"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportJsonType">Type:</label> <select id="exportJsonType"> <option value="native">Native</option> <option value="tiled">Tiled 1.2</option> </select> </div> <div class="formGroup exportJsonNativeSettings"> <label class="controlLabel">Include:</label> <div class="checkboxGroup"> <div> <label class="cb-container">Map Data <input type="checkbox" id="exportJSONMapData" checked="checked"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Tile Set Data <input type="checkbox" id="exportJSONTilesetData" checked="checked"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Colour Palette Data <input type="checkbox" id="exportJSONColorPaletteData" checked="checked"> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup exportJsonNativeSettings"> <label class="controlLabel" for="exportJsonFromFrame">Export Frames:</label> <div style="display: inline-block"> <input type="text" size="2" class="number" min="1" id="exportJsonFromFrame"> &nbsp; <label for="exportJsonToFrame">To</label> &nbsp; <input type="text" size="2" class="number" min="1" id="exportJsonToFrame"> </div> </div> <div class="formGroup exportJsonTiledSettings"> <label class="controlLabel">Include:</label> <div class="radioGroup"> <div> <label class="rb-container">All Tiles <input type="radio" name="exportJsonTiles" id="exportJsonTilesAll" value="all" checked="checked"/> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">Only Used Tiles <input type="radio" name="exportJsonTiles" id="exportJsonTilesUsed" value="used"> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel">Direction:</label> <div class="radioGroup"> <div> <label class="rb-container">Top to Bottom <input type="radio" name="exportJsonDirection" id="exportJsonDirectionTopToBottom" value="toptobottom" checked="checked"/> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">Bottom to Top <input type="radio" name="exportJsonDirection" id="exportJsonDirectionBottomToTop" value="bottomtotop"> <span class="checkmark"></span> </label> </div> </div> </div> </div> ';g_htmlCache["html/textMode/glyphEditor.html"]='<div id="glyphEditor" class="panelFill" style="color: white"> <div class="title" style="background-color: #111111; height: 28px"> <div style="position: absolute; top: 6px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap"> Tile Editor </div> <div style="position: absolute; top: 2px; right: 2px; width: 20px"> <div id="glyphEditorCloseButton" class="ui-button ui-dialog-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div> </div> </div> <div style="position: absolute; bottom: 0px; top: 28px; left: 0; right: 0; overflow-y: auto; overflow-x: hidden"> <div id="glyphEditorTileInfo" style="padding: 10px 0 0 10px"></div> <div style="text-align:center; margin-top: 10px" id="glyphEditorCanvasHolder"> <canvas id="glyphEditorCanvas" width="192" height="192" style="background-color: #000000"></canvas> </div> <div>Coming soon..</div> </div> </div>';g_htmlCache["html/textMode/colorPaletteEdit.html.bk"]='<div class="panelFill" id="editColorPaletteDialog"> <style> #editColorPaletteDialog h2 { margin: 2px 0 10px 0; border-bottom: 1px solid #444444; padding-bottom: 6px; } .editColorPaletteTable { margin: 2px; } .editColorPaletteTable td { padding: 6px 10px 10px 10px; } .editColorPaletteColorInfo { font-size: 10px; line-height: 13px; } .editColorPalettePanel { margin-bottom: 10px; } </style> <table class="editColorPaletteTable"> <tr> <td valign="top" style="padding-right: 20px"> <div class="editColorPalettePanel"> <h2>Tools</h2> <div class="colorPaletteTool colorPaletteToolSelected" id="colorPaletteTool_pen"><img width="20" src="icons/glyphicons-31-pencil@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteTool_erase"><img width="20" src="icons/glyphicons-551-erase@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteTool_eyedropper"><img width="20" src="icons/glyphicons-91-eyedropper@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteTool_select"><img width="20" src="icons/glyphicons-100-vector-path-select@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteTool_move"><img width="20" src="icons/glyphicons-187-move@2x.png"/></div> <div id="currentColorPaletteTool" style="display:inline-block">&nbsp;</div> </div> <div class="editColorPalettePanel"> <h2>Current Palette</h2> <canvas id="editColorPaletteCanvas" style=""></canvas> <div> <label class="cb-container">Show Grid <input type="checkbox" id="colorPaletteEditShowGrid" checked="checked"> <span class="checkmark"/> </label> <label>Width: <input type="text" class="number" min="1" max="30" value="16" style="width: 30px" size="2"/></label> <label>Height: <input type="text" class="number" min="1" max="30" value="16" style="width: 30px" size="2"/></label> </div> <div> <div class="ui-button" id="editColorPaletteClear">Clear Palette</div> </div> </div> </td> <td valign="top"> <div class="editColorPalettePanel"> <h2>Current Colour</h2> <div style="position: relative; width: 240px; height: 130px"> <div style="position: absolute; left: 0; top: 0; width: 128px; height: 65px" id="colorPaletteImageMouseSelectedColor"></div> <div style="position: absolute; left: 138px; top: 0; width: 110px; height: 65px;" class="editColorPaletteColorInfo" id="colorPaletteImageMouseSelectedColorInfo"/> <div style="position: absolute; left: 0; top: 65px; width: 128px; height: 65px" id="colorPaletteImageMouseHoverColor"/> <div style="position: absolute; left: 138px; top: 65px; width: 110px; height: 65px" class="editColorPaletteColorInfo" id="colorPaletteImageMouseHoverColorInfo"/> </div> </div> <div class="editColorPalettePanel"> <div style="margin-bottom: 4px"> <h2>Choose Colours</h2> <label class="rb-container" style="margin-right: 4px">HSV / RGB <input type="radio" name="editColorPaletteMethod" value="rgb" checked="checked"> <span class="checkmark"/> </label> <label class="rb-container" style="margin-right: 4px">From Image <input type="radio" name="editColorPaletteMethod" value="image"> <span class="checkmark"/> </label> <label class="rb-container" style="margin-right: 4px">Colour Wheel <input type="radio" name="editColorPaletteMethod" value="colorwheel"> <span class="checkmark"/> </label> </div> <div id="colorPaletteEditGraphHolder" class="colorPaletteSelectionMethod" style="display: none"> <div> <label for="colorPaletteEditGraphParam">Param</label> <select id="colorPaletteEditGraphParam"> <optgroup label="RGB"> <option value="red" selected="selected">Red</option> <option value="green">Green</option> <option value="blue">Blue</option> </optgroup> <optgroup label="HSV"> <option value="hue">Hue</option> <option value="saturation">Saturation</option> <option value="value">Value</option> </optgroup> </select> </div> <div> <canvas id="colorPaletteEditGraph" style="background-color: black;"></canvas> </div> </div> <div id="colorPaletteSelectionMethod_rgb" class="colorPaletteSelectionMethod"> <h3>RGB</h3> <div> <div class="colorComponentSelector"> <label for="editColorPaletteR">R:</label> <canvas width="200" height="28" id="editColorPaletteRCanvas" class="colorPaletteSlider" data-component="r"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="editColorPaletteR" data-component="r" min="0" max="255" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteG">G:</label> <canvas width="200" height="28" id="editColorPaletteGCanvas" class="colorPaletteSlider" data-component="g"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="editColorPaletteG" data-component="g" min="0" max="255" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteB">B:</label> <canvas width="200" height="28" id="editColorPaletteBCanvas" class="colorPaletteSlider" data-component="b"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="editColorPaletteB" data-component="b" min="0" max="255" value="0"> </div> </div> <h3>HSV</h3> <div> <div class="colorComponentSelector"> <label for="editColorPaletteH">H:</label> <canvas width="200" height="28" id="editColorPaletteHCanvas" class="colorPaletteSlider" data-component="h"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="editColorPaletteH" data-component="h" min="0" max="360" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteS">S:</label> <canvas width="200" height="28" id="editColorPaletteSCanvas" class="colorPaletteSlider" data-component="s"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="editColorPaletteS" data-component="s" min="0" max="100" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteB">V:</label> <canvas width="200" height="28" id="editColorPaletteVCanvas" class="colorPaletteSlider" data-component="v"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="editColorPaletteV" data-component="v" min="0" max="100" value="0"> </div> </div> <div> <label for="editColorPaletteHex">#</label> <input type="text" maxlength="6" id="editColorPaletteHex" size="6"/> </div> </div> <div id="colorPaletteSelectionMethod_image" class="colorPaletteSelectionMethod" style="display: none"> <div> <div style="padding-bottom: 2px"> <div class="ui-button" id="colourPaletteImageChooseFile">Choose Image...</div> <div id="colourPaletteImageChooseFileName" style="display: inline-block; margin-left: 6px"></div> <input class="formControl" style="position: absolute; top: -50px; left: -100px" id="colourPaletteImage" type="file" accept="image/*"/> </div> <canvas id="colorPaletteFromImageImage" style="background-color: #111111"></canvas> </div> <div> <label>Scale</label> <div class="ui-button" id="colorPaletteImageScaleDecrease">-</div> <input type="text" size="3" style="width: 40px" type="text" id="colorPaletteImageScale" min="1" class="number" value="100"/> <div class="ui-button" id="colorPaletteImageScaleIncrease">+</div> <div class="ui-button" id="colorPaletteImageFit">Fit</div> </div> <div class="formGroup"> <label class="controlLabel" for="">Colour Count</label> <select id="colorPaletteFromImageColorCount"> <option value="2">2</option> <option value="4">4</option> <option value="8">8</option> <option value="16" selected="selected">16</option> <option value="32">32</option> <option value="64">64</option> <option value="128">128</option> </select> <button id="colorPaletteFromImageAdd">Add These Colours &gt;</button> </div> <canvas id="colorPaletteFromImagePalette" style="background-color: #111111"></canvas> </div> <div id="colorPaletteSelectionMethod_colorwheel" class="colorPaletteSelectionMethod" style="display: none"> <table> <tr> <td> <canvas id="colorPaletteEditColorWheel"></canvas> </td> <td> <canvas id="colorPaletteEditColorWheelValue" height="200" width="24"></canvas> </td> </tr> </table> </div> </div> </td> </tr> </table> </div>';g_htmlCache["html/textMode/exportC64Assembly.html"]='<div class="panelFill dialogContent" id="exportC64AssemblyPanel" style="overflow: hidden;"> <div style="position: absolute; top: 10px; left: 10px; right: 10px; height: 30px;"> <div class="formGroup"> <label class="controlLabel" for="exportC64AssemblyAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportC64AssemblyAs"/> <div id="exportC64AssemblyDownload" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg"/> Download</div> </div> </div> <div style="position: absolute; top: 50px; left: 10px; right: 10px; bottom: 120px"> <div id="exportC64AssemblySource" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0"></div> </div> <div style="position: absolute; bottom: 10px; height: 100px; left: 10px; right: 10px"> <div style="display: flex; align-items: center; height: 35px"> <div class="formGroup" style="display: inline-block; margin-bottom: 0; "> <label style="margin-bottom: 0" class="rb-container">ACME <input type="radio" class="formControl" size="20" value="acme" checked="checked" name="exportC64AssemblyFormat" id="exportC64AssemblyFormatAcme"/> <span class="checkmark"></span> </label> <label style="margin-bottom: 0" class="rb-container">Kick Ass <input type="radio" class="formControl" size="20" value="kickass" name="exportC64AssemblyFormat" id="exportC64AssemblyFormatKickAss"/> <span class="checkmark"></span> </label> <label style="margin-bottom: 0" class="rb-container">CA65 <input type="radio" class="formControl" size="20" value="ca65" name="exportC64AssemblyFormat" id="exportC64AssemblyFormatCA65"/> <span class="checkmark"></span> </label> <label style="margin-bottom: 0" class="rb-container">TASS <input type="radio" class="formControl" size="20" value="tass" name="exportC64AssemblyFormat" id="exportC64AssemblyFormatTASS"/> <span class="checkmark"></span> </label> </div> <div class="formGroup" style="display: flex; align-items: center; margin-bottom: 0; margin-left: 20px"> <label class="controlLabel" for="exportC64AssemblyNumberFormat">Number Format:</label> <div style="display: inline-block"> <label style="margin-bottom: 0" class="rb-container">Hex <input type="radio" class="formControl" size="20" value="hex" checked="checked" name="exportC64NumberFormat" id="exportC64AssemblyNumberFormatHex"/> <span class="checkmark"></span> </label> <label style="margin-bottom: 0" class="rb-container">Dec <input type="radio" class="formControl" size="20" value="dec" name="exportC64NumberFormat" id="exportC64AssemblyNumberFormatDec"/> <span class="checkmark"></span> </label> </div> </div> <div class="formGroup" style="display: flex; align-items: center; margin-bottom: 0; margin-left: 20px"> <label class="controlLabel" for="exportC64AssemblyFromFrame" style="width: unset">Frames:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="exportC64AssemblyFromFrame"> &nbsp; <label for="exportC64AssemblyToFrame">To</label> &nbsp; <input type="number" size="2" class="number" min="1" id="exportC64AssemblyToFrame"> </div> </div> </div> <div style="display: flex; height: 35px; align-items: center"> <div class="checkboxGroup"> <label class="cb-container">Character Set Data <input type="checkbox" id="exportC64AssemblyCharactersetData" class="exportC64AssemblyInclude" checked="checked"/> <span class="checkmark"></span> </label> <div id="exportC64AssemblyColorDataHolder" style="display: inline-block"> <label class="cb-container">Character Attribute Data <input type="checkbox" id="exportC64AssemblyColorData" class="exportC64AssemblyInclude" checked="checked"/> <span class="checkmark"></span> </label> </div> <div id="exportC64AssemblyBlockDataHolder" style="display: inline-block"> <label class="cb-container">MetaTile Data <input type="checkbox" id="exportC64AssemblyBlockData" class="exportC64AssemblyInclude" checked="checked"/> <span class="checkmark"></span> </label> </div> <div id="exportC64AssemblyBlockColorDataHolder" style="display: inline-block"> <label class="cb-container">MetaTile Colour Data <input type="checkbox" id="exportC64AssemblyBlockColorData" class="exportC64AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportC64AssemblyMapDataHolder" style="display: inline-block"> <label class="cb-container">Map Character Data <input type="checkbox" id="exportC64AssemblyMapData" class="exportC64AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportC64AssemblyBlockMapDataHolder" style="display: inline-block"> <label class="cb-container">Map Meta Tile Data <input type="checkbox" id="exportC64AssemblyBlockMapData" class="exportC64AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="exportC64AssemblyMapColorDataHolder" style="display: inline-block"> <label class="cb-container">Map Colour Data <input type="checkbox" id="exportC64AssemblyMapColorData" class="exportC64AssemblyInclude" checked="checked"> <span class="checkmark"></span> </label> </div> </div> </div> <div style="display: flex; align-items: center; height: 35px"> <div style="display: flex; align-items: center"> <label style="width: unset" class="controlLabel">Layers:</label> <div class="radioGroup"> <label style="margin-bottom: 0" class="rb-container">Current Layer <input type="radio" name="exportC64AssemblyLayer" id="exportC64AssemblyLayerCurrent" value="current" checked="checked"/> <span class="checkmark"></span> </label> </div> </div> <div style="display: flex; align-items: center; margin-left: 20px"> <label class="cb-container">Selection Only <input type="checkbox" id="exportC64AssemblySelectionOnly" class="exportC64AssemblyInclude"/> <span class="checkmark"></span> </label> </div> <div style="display: flex; align-items: center"> <div style="margin-left: 20px">Character Index Size</div> <label style="margin-bottom: 0; margin-left: 6px" class="rb-container">8-bit <input type="radio" name="exportC64TileIndexSize" id="exportC64TileIndexSize_8" value="8" checked="checked"/> <span class="checkmark"></span> </label> <label style="margin-bottom: 0; margin-left: 6px" class="rb-container" style="margin-left: 8px">16-bit (split bytes) <input type="radio" name="exportC64TileIndexSize" id="exportC64TileIndexSize_16split" value="16split"/> <span class="checkmark"></span> </label> <label style="margin-bottom: 0; margin-left: 6px" class="rb-container" style="margin-left: 8px">16-bit (words) <input type="radio" name="exportC64TileIndexSize" id="exportC64TileIndexSize_16word" value="16word"/> <span class="checkmark"></span> </label> </div> <div id="exportC64MetaTileIndexSettings" style="display: flex; align-items: center"> <div style="margin-left: 20px">MetaTile Index Size</div> <label style="margin-bottom: 0; margin-left: 6px" class="rb-container">8-bit <input type="radio" name="exportC64MetaTileIndexSize" id="exportC64MetaTileIndexSize_8" value="8" checked="checked"/> <span class="checkmark"></span> </label> <label style="margin-bottom: 0; margin-left: 6px" class="rb-container" style="margin-left: 8px">16-bit (split bytes) <input type="radio" name="exportC64MetaTileIndexSize" id="exportC64MetaTileIndexSize_16split" value="16split"/> <span class="checkmark"></span> </label> <label style="margin-bottom: 0; margin-left: 6px" class="rb-container" style="margin-left: 8px">16-bit (words) <input type="radio" name="exportC64MetaTileIndexSize" id="exportC64MetaTileIndexSize_16word" value="16word"/> <span class="checkmark"></span> </label> </div> </div> </div> </div> ';g_htmlCache["html/textMode/pixelTools.html"]='<div id="pixelTools" class="panelFill activeBackground"> <div style="margin: 4px"> <div id="pixelToolSettings-c64multicolor" style="display: inline-block"> </div> </div> </div>';g_htmlCache["html/textMode/charRotationTools.html"]='<div> <div id="charRotationTools3d"> <div> <div class="ui-button" id="currentTileRotateLeft">&lt;</div> <div class="ui-button" id="currentTileRotateRight">&gt;</div> <div class="ui-button" id="currentTileRotateUp">/</div> <div class="ui-button" id="currentTileRotateDown">/</div> <div class="ui-button" id="currentTileRotateClockwise">C</div> <div class="ui-button" id="currentTileRotateAntiClockwise">A</div> </div> <div> <div style="display: inline-block">RX:</div> <div id="currentTileRX" style="display: inline-block">0</div> <div style="display: inline-block">RY:</div> <div id="currentTileRY" style="display: inline-block">0</div> <div style="display: inline-block">RZ:</div> <div id="currentTileRZ" style="display: inline-block">0</div> <div class="ui-button" id="currentTileRotateReset">reset</div> </div> </div> <div id="charOrientationTools2d" style="padding: 2px 4px; font-size: 10px"> <div style="margin-bottom: 2px; height: 20px; line-height: 20px"> <div style="display: inline-block" id="currentTileFlipHolder"> <div style="display: inline-block; color: #999999">Flip H:</div> <div id="currentTileFlipH" style="display: inline-block; font-weight: bold">0</div> <div style="display: inline-block; color: #999999">Flip V:</div> <div id="currentTileFlipV" style="display: inline-block; font-weight: bold">0</div> </div> <div style="display: inline-block" id="currentTileRotateHolder"> <div style="display: inline-block; color: #999999">Rotate:</div> <div id="currentTileRotate" style="display: inline-block; font-weight: bold">0</div> </div> <div class="ui-button ui-button-small" style="position: absolute; right: 2px; top: 1px" id="currentTileOrientation2dReset">Reset<div class="rippleJS"></div></div> </div> <div style="display:flex"> <span id="tileOrientationFlipControls" style="display: flex"> <div class="ui-button ui-button-small" style="margin-right: 2px" id="currentTileOrientation2dFlipH" data-label="Tile Flip X" title="Tile Flip X (F)"><img src="icons/svg/glyphicons-basic-747-reflect-y.svg"> Flip H<div class="rippleJS"></div></div> <div class="ui-button ui-button-small" style="margin-right: 2px" id="currentTileOrientation2dFlipV" data-label="Tile Flip Y" title="Tile Flip Y (G)"><img src="icons/svg/glyphicons-basic-748-reflect-x.svg"> Flip V<div class="rippleJS"></div></div> </span> <span id="tileOrientationRotateControls"> <div class="ui-button ui-button-small" id="currentTileOrientation2dRotate" data-label="Tile Rotate" title="Tile Rotate (R)"><img src="icons/svg/glyphicons-basic-493-rotate.svg"> Rotate<div class="rippleJS"></div></div> </span> </div> </div> </div> ';g_htmlCache["html/textMode/exportC64SpriteAssembly.html"]='<div class="panelFill dialogContent" id="exportC64SpriteAssemblyPanel"> <div style="position: absolute; top: 10px; left: 10px; right: 10px; height: 30px;"> <div class="formGroup"> <label class="controlLabel" for="exportC64SpriteAssemblyAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportC64SpriteAssemblyAs"/> <div id="exportC64SpriteAssemblyDownload" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg"/> Download</div> </div> </div> <div style="position: absolute; top: 50px; left: 10px; right: 10px; bottom: 140px"> <div id="exportC64SpriteAssemblySource" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0"></div> </div> <div style="position: absolute; bottom: 60px; height: 50px; left: 10px; right: 10px"> <div> <div class="formGroup" style="display: inline-block"> <label class="controlLabel">Type</label> <label class="rb-container">C64 <input type="radio" class="formControl" size="20" value="c64" checked="checked" name="exportC64SpriteAssemblyType" id="exportC64SpriteAssemblyTypeC64"/> <span class="checkmark"></span> </label> <label class="rb-container">Mega65 FCM <input type="radio" class="formControl" size="20" value="fcm" name="exportC64SpriteAssemblyType" id="exportC64SpriteAssemblyTypeFCM"/> <span class="checkmark"></span> </label> </div> </div> </div> <div style="position: absolute; bottom: 10px; height: 50px; left: 10px; right: 10px"> <div> <div class="formGroup" style="display: inline-block"> <label class="controlLabel">Format</label> <label class="rb-container">ACME <input type="radio" class="formControl" size="20" value="acme" checked="checked" name="exportC64SpriteAssemblyFormat" id="exportC64SpriteAssemblyFormatAcme"/> <span class="checkmark"></span> </label> <label class="rb-container">Kick Ass / CA65 <input type="radio" class="formControl" size="20" value="kickass" name="exportC64SpriteAssemblyFormat" id="exportC64SpriteAssemblyFormatKickAss"/> <span class="checkmark"></span> </label> </div> <div class="formGroup" style="display: inline-block"> <label class="controlLabel" for="exportC64AssemblyNumberFormat">Number Format:</label> <div style="display: inline-block"> <label class="rb-container">Hex <input type="radio" class="formControl" size="20" value="hex" name="exportC64SpriteNumberFormat" id="exportC64SpriteAssemblyNumberFormatHex"/> <span class="checkmark"></span> </label> <label class="rb-container">Dec <input type="radio" class="formControl" size="20" value="dec" name="exportC64SpriteNumberFormat" id="exportC64SpriteAssemblyNumberFormatDec"/> <span class="checkmark"></span> </label> <label class="rb-container">Bin <input type="radio" class="formControl" size="20" value="bin" checked="checked" name="exportC64SpriteNumberFormat" id="exportC64SpriteAssemblyNumberFormatBin"/> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel" for="exportC64SpriteAssemblyFromFrame">Export Frames:</label> <div style="display: inline-block"> <input type="text" size="2" class="number" min="1" id="exportC64SpriteAssemblyFromFrame"> &nbsp; <label for="exportC64SpriteAssemblyToFrame">To</label> &nbsp; <input type="text" size="2" class="number" min="1" id="exportC64SpriteAssemblyToFrame"> </div> </div> </div> </div> ';g_htmlCache["html/textMode/importImage.html"]='<div class="panelFill" id="importImagePanel"> <div class="content"> <div id="importImageHolder" style=" position: absolute; padding: 10px 10px 0 10px; top: 0; left: 0; right: 0px; bottom: 0; overflow: auto"> <h3><i class="halflings halflings-picture"/>&nbsp;Source</h3> <div> <table> <tr> <td> <div class="formGroup"> <form id="importImageForm"> <div class="ui-button ui-button-nextaction" id="importImageChooseFile">Choose Image/Video ...</div> &nbsp; <div id="importImageChooseFileName" style="display: inline-block; margin-left: 6px"></div> &nbsp;&nbsp; <div class="ui-button ui-button-nextaction" id="importImageUseReferenceImage">Use Reference Image</div> <input class="formControl" id="importImageSourceFile" type="file" accept="image/*,video/*" style="position: absolute; top: -50px; left: -100px" type="file"> </form> </div> <table> <tr> <td valign="top"> <canvas width="320" height="200" id="importImageCanvas" style="border:1px solid #444444; background: transparent"></canvas> <div class="formRow" style="margin-top: 4px"> <div style="display: inline-block; margin-right: 20px"> Scale <div class="ui-button" id="importImageScaleDecrease">-</div> <input size="3" style="width: 40px" type="text" id="importImageScale" class="number" value="100"/> <div class="ui-button" id="importImageScaleIncrease">+</div> <div class="ui-button" id="importImageScaleToFit">Fit</div> </div> <div style="display: inline-block"> <label for="importImageX">X</label>:&nbsp; <input size="3" style="width: 35px" type="text" class="number" id="importImageX" value="0"/> &nbsp;&nbsp; <label for="importImageY">Y</label>:&nbsp; <input size="3" style="width: 35px" type="text" class="number" id="importImageY" value="0"/> </div> </div> </td> <td valign="top"> <div style="padding-left: 8px"> <div class="formRow"> <label class="controlLabel" style="display: flex"><img src="icons/brightness_low-24px.svg" class="icon-invert" style="width: 12px; margin: 2px 6px 2px 4px"> Brightness</label> <input style="width: 100px" type="range" min="-100" max="100" value="0" id="importImageBrightness"/> <input type="text" style="width: 30px; margin-left: 10px" id="importImageBrightnessValue" value="0" class="number" min="-100" max="100" size="2"/> </div> <div class="formRow"> <label class="controlLabel" style="display: flex"><img src="icons/glyphicons-92-adjust.svg" class="icon-invert" style="width: 20px; margin-right: 2px"> Contrast</label> <input style="width: 100px" type="range" class="" min="-100" max="100" value="0" size="3" id="importImageContrast"/> <input type="text" class="number" style="width: 30px; margin-left: 10px" min="-100" max="100" value="0" size="2" id="importImageContrastValue"/> </div> <div class="formRow"> <label class="controlLabel" style="display: flex"><img src="icons/glyphicons-93-tint.svg" class="icon-invert" style="width: 20px; margin-right: 2px"> Saturation</label> <input style="width: 100px" type="range" min="-100" max="100" value="0" id="importImageSaturation"/> <input style="width: 30px; margin-left: 10px" type="text" class="number" min="-100" max="100" value="0" size="2" id="importImageSaturationValue"/> </div> <div class="formRow"> <label for="" class="controlLabel">&nbsp;</label> <label class="cb-container">Invert Colours <input type="checkbox" id="importImageInverColors" value="1"/> <span class="checkmark"></span> </label> </div> <div class="formRow"> <label for="" class="controlLabel">&nbsp;</label> <label class="cb-container">Image Smoothing <input type="checkbox" id="importImageSmoothing" value="1"/> <span class="checkmark"></span> </label> </div> <div class="formRow"> <label class="controlLabel">Crosshairs</label> <label>x <input size="4" type="text" class="number" style="width: 35px" min="0" name="imageImportZoomX" id="imageImportZoomX" value="160"/></label> &nbsp; <label>y <input size="4" type="text" class="number" style="width: 35px" min="0" name="imageImportZoomY" id="imageImportZoomY" value="100"/></label> </div> </div> </td> </tr> </table> </tr> </table> </div> <div id="importImageVideoControls" style="display: none"> <div> <canvas id="importImageVideoRange" width="590" height="18" style="cursor: default"></canvas> </div> <div id="importImageVideoInfo" style="display: none"></div> <div style="padding-left: 10px; margin: 4px 0 4px 0"> <div style="display: inline-block; margin-right: 20px"> Import <label> From: <input type="text" class="number" min="0" value="0" style="width: 50px" id="importImageVideoStartAt"/> ms </label> <label> To: <input type="text" class="number" min="0" value="0" style="width: 50px" size="6" id="importImageVideoEndAt"/> ms </label> </div> <div style="display: inline-block"> <label><input type="radio" name="importImageVideoPlayDirection" value="forwards" checked="checked">Forwards</label> <label><input type="radio" name="importImageVideoPlayDirection" value="backwards">Backwards</label> <label><input type="radio" name="importImageVideoPlayDirection" value="pingpong">Ping Pong</label> </div> </div> </div> </div> </div> </div> ';g_htmlCache["html/textMode/drawToolsMobileSide.html"]='<div class="activeBackground panelFill" id="drawToolsMobileSide" class="nodrag"> <div id="toolsMobileCurrentTileHolder" style="text-align: center; position: absolute; top: 0px; left: 0px; right: 0; height: 80px"> <canvas id="toolsMobileCurrentTile" class="has-mobile-context-menu"></canvas> <div style="margin-top: 1px" id="toolsMobileCurrentTileInfo">0</div> </div> <div id="toolIconsScrollTop" style="z-index: 100; position: absolute; top: 81px; left: 0; right: 0; height: 14px; background-image: linear-gradient(to top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 255)); display: none"></div> <div id="toolIconsScrollBottom" style="z-index: 100; position: absolute; bottom: 194px; left: 0; right: 0; height: 10px; background-image: linear-gradient(to top, rgba(0, 0, 0, 255), rgba(0, 0, 0, 0)); display: none"></div> <div id="toolIconHolderMobile" style="padding: 0px 8px 0 8px; position: absolute; text-align: center; top: 82px; left: 0px; right: 0; bottom: 194px; border-bottom: 1px solid #111111; overflow-y: auto; overflow-x: hidden"> <div id="toolIconsMobile" style="padding: 3px 0 3px 0"> <div class="drawToolMobileSide drawToolMobileSideSelected" id="drawToolMobileSide_pen" data-type="pen"><img src="icons/svg/glyphicons-basic-31-pencil.svg"/></div> <div class="drawToolMobileSide" id="drawToolMobileSide_erase" data-type="erase"><img src="icons/svg/glyphicons-basic-250-eraser.svg"/></div> <div class="drawToolMobileSide drawToolMobileSide2d" id="drawToolMobileSide_fill" data-type="fill"><img src="icons/svg/glyphicons-basic-245-fill.svg"/></div> <div class="drawToolMobileSide" id="drawToolMobileSide_eyedropper" data-type="eyedropper"><img src="icons/svg/glyphicons-basic-91-eyedropper.svg"/></div> <div class="drawToolMobileSide drawToolMobileSide2d" id="drawToolMobileSide_select" data-type="select"><img src="icons/select@2x.png"/></div> <div class="drawToolMobileSide drawToolMobileSide2d" id="drawToolMobileSide_move" data-type="move"><img src="icons/move@2x.png"/></div> <div class="drawToolMobileSide" id="drawToolMobileSide_hand" data-type="hand"><img src="icons/svg/glyphicons-basic-457-hand-open.svg"/></div> <div class="drawToolMobileSide drawToolMobileSide3d" id="drawToolMobileSide_rotate" data-type="rotate"><img src="icons/svg/glyphicons-basic-494-rotate-horizontal.svg"/></div> <div class="drawToolMobileSide" id="drawToolMobileSide_line" data-type="line"><img src="icons/svg/slash.svg"/></div> <div class="drawToolMobileSide" id="drawToolMobileSide_rect" data-type="rect"><img src="icons/svg/square.svg"/></div> <div class="drawToolMobileSide" id="drawToolMobileSide_oval" data-type="oval"><img src="icons/svg/circle.svg"/></div> <div class="drawToolMobileSide drawToolMobileSide2d" id="drawToolMobileSide_block" data-type="block"><img src="icons/block@2x.png"/></div> <div class="drawToolMobileSide drawToolMobileSide2d" id="drawToolMobileSide_pixel" data-type="pixel"><img src="icons/pixel.png"/></div> </div> </div> <div id="drawToolMobileColors" style="position: absolute; left: 0px; right: 0; bottom: 8px; height: 180px; text-align: center"> <div id="layersMobileSection" class="drawToolMobileSide2d"> <div style="margin-bottom: 2px">Layers</div> <img id="layersButtonMobile" style="filter: invert(60%)" src="icons/material/baseline-layers-24px.svg" height="40"/> </div> <div id="drawToolMobileSubpalette"> <div style="position: relative; height: 50px"> <div style="position: absolute; top: 2px; left: 7px; width: 34px; height: 34px; z-index: 6; background-color: white" id="nesPalettePickerMobile" class="nesPalettePickerMobile"> <div class="colorSubPaletteColor0" style="position: absolute; top: 0px; left: 0px; width: 50%; height: 50%; "></div> <div class="colorSubPaletteColor1" style="position: absolute; top: 0px; right: 0px; width: 50%; height: 50%; "></div> <div class="colorSubPaletteColor2" style="position: absolute; bottom: 0px; left: 0px; width: 50%; height: 50%;"></div> <div class="colorSubPaletteColor3" style="position: absolute; bottom: 0px; right: 0px; width: 50%; height: 50%; "></div> </div> </div> </div> <div id="drawToolMobileCellColor"> <div style="margin-bottom: 2px">Cell</div> <div id="drawToolsMobile-cellColor" style="position: relative; height: 50px; margin-bottom: 6px"> <div style="position: absolute; top: 2px; left: 7px; width: 34px; height: 34px; z-index: 6" id="cellForegroundColorMobile" class="foregroundColorMobile"></div> <div style="display: block; position: absolute; top: 16px; left: 29px; width: 34px; height: 34px; text-align: center; line-height: 34px; background-color: #000000; z-index: 5;" id="cellBackgroundColorMobile" class="cellBackgroundColorMobile"></div> </div> </div> <div id="drawToolMobileFrameColor" class="drawToolMobileSide2d"> <div style="margin-bottom: 2px">Frame</div> <div id="drawToolsMobile-frameColors" style="padding: 0; position: relative; height: 56px"> <div style="display: block; position: absolute; top: 2px; left: 7px; width: 56px; height: 46px; background-color: #000000; z-index: 5" id="borderColorMobile" class="borderColorMobile"></div> <div style="display: block; position: absolute; top: 12px; left: 17px; width: 36px; height: 26px; background-color: #000000; z-index: 10" id="backgroundColorMobile" class="backgroundColorMobile"></div> </div> </div> </div> </div> ';g_htmlCache["html/textMode/exportSpriteBinaryData.html"]='<div class="panelFill dialogContent" id="exportSpriteBinaryDataPanel"> <div class="formGroup"> <label class="controlLabel" for="exportSpriteBinaryAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportBinaryAs"/> </div> <div class="formGroup"> <label class="controlLabel">Format</label> <div class="radioGroup"> <div> <label class="rb-container">C64 <input type="radio" class="formControl" size="20" value="c64" name="exportSpriteBinaryFormat" id="exportSpriteBinaryFormatC64"/> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">Mega65 <input type="radio" class="formControl" size="20" value="mega65" name="exportSpriteBinaryFormat" id="exportSpriteBinaryFormatMega65"/> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel" for="exportSpriteBinaryFromFrame">Export Frames:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" checked="checked" id="exportSpriteBinaryFromFrame"> &nbsp; <label for="exportSpriteBinaryToFrame">To</label> &nbsp; <input type="number" size="2" class="number" min="1" id="exportSpriteBinaryToFrame"> </div> </div> <div class="formGroup"> <label class="controlLabel">Layers:</label> <div class="radioGroup"> <label class="rb-container">Current Layer <input type="radio" name="exportSpriteBinaryLayer" id="exportSpriteBinaryLayerCurrent" value="current" checked="checked"/> <span class="checkmark"></span> </label> &nbsp; </div> </div> </div> ';g_htmlCache["html/textMode/exportPngPreview.html"]='<div class="panelFill"> <div style="position: absolute; left: 10px; top: 10px;"><div style="display: inline-block" id="exportPNGInfo"></div></div> <div style="position: absolute; top: 30px; left: 10px; right: 10px; bottom: 46px" id="exportPngPreviewHolder"> <canvas id="exportPngPreview" style="border: 1px solid #aaaaaa"></canvas> </div> <div style="position: absolute; left: 10px; bottom: 10px"> <label class="controlLabel" for="pngExportPreviewScale">Preview Scale</label> <input id="pngExportPreviewScale" style="width: 180px" type="range" min="1" max="5000" value="100" size="3"> <input id="pngExportPreviewScaleText" class="number" type="text" style="width: 30px" min="1" max="5000" value="100" size="2"> <button type="button" id="pngExportPreviewScaleReset">R</button> </div> </div> </div> ';g_htmlCache["html/textMode/tileEditorMobile.html"]='<div id="tileEditorMobile" class="panelFill" style="color: white"> <div style="position: absolute; bottom: 0px; top: 28px; left: 0; right: 0; overflow-y: auto; overflow-x: hidden"> <div style="text-align:center; margin-top: 10px" id="tileEditorMobileCanvasHolder"> <canvas id="tileEditorMobileCanvas" width="192" height="192" style="background-color: #000000"></canvas> </div> <div id="tileEditorMobileFrameControls" style="display: none"> Frame <button id="tileEditorMobilePrevFrame">&lt;</button> <input class="number" size="2" min="1" value="1" id="tileEditorMobileFrame"> <button id="tileEditorMobileNextFrame">&gt;</button> &nbsp; of &nbsp; <input class="number" size="2" value="1" min="1" max="8" id="tileEditorMobileFrames"> <button id="tileEditorMobileInsertFrame">+</button> <button id="tileEditorMobileDeleteFrame">-</button> </div> <div id="tileEditorMobileMultiColors" style="display: none; margin: 4px"> <label style="font-size: 10px">Colour:</label> <div style="display: inline-block; width: 18px; height: 18px; background-color: #000000; border: 1px solid #dddddd" class="" id="tileEditorMobileMultiColor"></div> </div> <div id="tileEditorMobileC64Colors" style="display: none; margin: 4px"> <div> Colour: </div> <div id="tileEditorMobileC64Colors"> </div> </div> <div id="tileEditorMobileSubPaletteColors" style="display: none"> <div style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" data-index="0" class="tileEditorMobileSubPaletteColor colorSubPaletteColor0Display colorSubPaletteColor0" id="tileEditorMobileSubPaletteColor-0"></div> &nbsp;&nbsp; <div style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" data-index="1" class="tileEditorMobileSubPaletteColor colorSubPaletteColor1Display colorSubPaletteColor1" id="tileEditorMobileSubPaletteColor-1"></div> &nbsp;&nbsp; <div style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" data-index="2" class="tileEditorMobileSubPaletteColor colorSubPaletteColor2Display colorSubPaletteColor2" id="tileEditorMobileSubPaletteColor-2"></div> &nbsp;&nbsp; <div style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" data-index="3" class="tileEditorMobileSubPaletteColor colorSubPaletteColor3Display colorSubPaletteColor3" id="tileEditorMobileSubPaletteColor-3"></div> </div> <div id="tileEditorMobileControls" style="margin: 8px 0px 0px 10px"> <div> Controls: <span id="tileEditorMobileControlLabel"></span> </div> <div> <div> <div class="ui-button" data-label="Shift Left" id="tileEditorMobileLeft"><img src="icons/svg/glyphicons-basic-859-square-left.svg"/></div> <div class="ui-button" data-label="Shift Right" id="tileEditorMobileRight"> <img src="icons/svg/glyphicons-basic-860-square-right.svg"/></div> <div class="ui-button" data-label="Shift Up" id="tileEditorMobileUp"><img src="icons/svg/glyphicons-basic-858-square-up.svg"/></div> <div class="ui-button" data-label="Shift Down" id="tileEditorMobileDown"><img src="icons/svg/glyphicons-basic-857-square-down.svg"/></div> <div class="ui-button" data-label="Flip X" id="tileEditorMobileFlipH"><img src="icons/svg/glyphicons-basic-747-reflect-y.svg"/></div> <div class="ui-button" data-label="Flip Y" id="tileEditorMobileFlipV"><img src="icons/svg/glyphicons-basic-748-reflect-x.svg"/></div> <div class="ui-button" data-label="Rotate" id="tileEditorMobileRotate"><img src="icons/svg/glyphicons-basic-493-rotate.svg"/></div> <div class="ui-button" data-label="Invert" id="tileEditorMobileInvert"><img src="icons/svg/glyphicons-basic-543-star-half.svg"/></div> </div> <div> <div class="ui-button" data-label="Cut" id="tileEditorMobileClear"><img src="icons/svg/glyphicons-basic-612-scissors.svg"/></div> <div class="ui-button" data-label="Copy" id="tileEditorMobileCopy"><img src="icons/svg/glyphicons-basic-614-copy.svg"/></div> <div class="ui-button" data-label="Paste" id="tileEditorMobilePaste"><img src="icons/svg/glyphicons-basic-613-paste.svg"/></div> Clipboard: <canvas width="16" height="16" style="background-color: black" id="tileEditorMobileClipboard"></canvas> </div> </div> </div> <div style="margin: 8px 0 0 10px"> <div> <label for="tileEditorMobileAnimatedType">Animated:</label> </div> <div style="margin-top: 8px"> <select id="tileEditorMobileAnimatedType"> <option value="">No</option> <option value="mixed">Mixed</option> <option value="left">Scroll Left</option> <option value="right">Scroll Right</option> <option value="up">Scroll Up</option> <option value="down">Scroll Down</option> <option value="blink">Blink</option> <option value="frames">Frames</option> </select> </div> <div style="margin-top: 8px"> <label for="tileEditorMobileAnimatedTicksPerFrame">Ticks/Frame:</label> <input size="2" class="number" min="1" max="16" value="6" id="tileEditorMobileAnimatedTicksPerFrame"/> </div> </div> </div> </div>';g_htmlCache["html/textMode/editColorPalette.html"]='<div class="panelFill"> edit colour palette <canvas id="editColorPaletteCanvas" style="background-color: #111111"></canvas> </div>';g_htmlCache["html/textMode/toolSettingsMobile.html"]='<div class="activeBackground panelFill"> <div style="padding: 10px 4px;" id="drawToolSettingsMobile" class="toolSettingsMobile"> <div style="display: flex"> <label class="cb-container">Tile <input type="checkbox" id="drawChangesCharacterMobile" name="drawChangesMobile" checked="checked" value="tile"/> <span class="checkmark"></span> </label> <label class="cb-container">FG Colour <input type="checkbox" id="drawChangesColorMobile" name="drawChangesMobile" checked="checked" value="color"/> <span class="checkmark"></span> </label> <label class="cb-container">BG Colour <input type="checkbox" id="drawChangesBGColorMobile" name="drawChangesMobile" checked="checked" value="bgcolor"/> <span class="checkmark"></span> </label> <label class="cb-container" id="drawFillMobileContainer">Fill <input type="checkbox" id="drawShapeFillMobile" name="drawChangesMobile" value="fill"/> <span class="checkmark"></span> </label> <label class="cb-container">Mirror H <input type="checkbox" value="mirrorh" id="drawMirrorHMobile" name="drawMirrorMobile" class="checkbox"/> <span class="checkmark"></span> </label> <label class="cb-container">Mirror V <input type="checkbox" value="mirrorv" id="drawMirrorVMobile" name="drawMirrorMobile" class="checkbox"/> <span class="checkmark"></span> </label> </div> </div> <div style="padding: 0px;" id="pixelToolSettingsMobile" class="toolSettingsMobile"> <div id="pixelToolSettingsMobile-c64multicolor" style="display: flex; padding: 4px"></div> <div id="pixelToolSettingsMobile-nes" style="display: none"> <div id="pixelToolSettingsMobile-nescolors"> <div data-index="0" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="pixelToolSubPaletteColor colorSubPaletteColor0Display colorSubPaletteColor0" id="pixelToolSettingsSubPaletteColor-0"></div> &nbsp;&nbsp; <div data-index="1" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="pixelToolSubPaletteColor colorSubPalette1Display colorSubPaletteColor1" id="pixelToolSettingsSubPaletteColor-1"></div> &nbsp;&nbsp; <div data-index="2" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="pixelToolSubPaletteColor colorSubPalette2Display colorSubPaletteColor2" id="pixelToolSettingsSubPaletteColor-2"></div> &nbsp;&nbsp; <div data-index="3" style="display: inline-block; width: 16px; height: 16px; background-color: #000000; border: 1px solid #dddddd" class="pixelToolSubPaletteColor colorSubPalette3Display colorSubPaletteColor3" id="pixelToolSettingsSubPaletteColor-3"></div> </div> </div> <div id="pixelToolSettingsMobile-monochrome" style="display: flex; padding: 4px"> <div class="mobileRadio mobileRadioSelected" id="pixelMode-draw" data-value="draw"> <img src="icons/svg/glyphicons-basic-31-pencil.svg" height="18" style="margin-right: 4px"> Draw </div> <div class="mobileRadio" id="pixelMode-erase" data-value="erase"> <img src="icons/svg/glyphicons-basic-250-eraser.svg" height="18" style="margin-right: 4px">Erase </div> </div> <div id="pixelToolSettingsMobile-multicolor" style="display: none"> <label><div class="pixelToolSettingColor currentCellColorDisplay" id="pixelToolMulticolorMobile"></div></label> &nbsp; </div> </div> <div style="padding: 0px; display: inline-block" id="selectToolSettingsMobile" class="toolSettingsMobile"> <div class="ui-button" id="selectMobileDrawUsingSelection" style="font-size: 12px">To Pen</div> <div class="ui-button" id="selectMobileDeselect" style="font-size: 12px"><img src="icons/selectcancel@2x.png"></div> <div class="ui-button" id="selectMobileClear" style="font-size: 12px"><img src="icons/svg/glyphicons-basic-250-eraser.svg"></div> <div class="ui-button" id="selectMobileFlipHButton"><img src="icons/svg/glyphicons-basic-747-reflect-y.svg"></div> <div class="ui-button" id="selectMobileFlipVButton"><img src="icons/svg/glyphicons-basic-748-reflect-x.svg"></div> <div class="ui-button" id="selectMobileMoveButton"><img src="icons/move@2x.png"></div> </div> <div style="padding: 9; display: inline-block" id="pixelshapeToolSettingsMobile" class="toolSettingsMobile"> <label class="cb-container" id="pixelDrawFillMobileContainer">Fill <input type="checkbox" id="pixelDrawShapeFillMobile" name="pixelDrawChangesMobile" value="fill"/> <span class="checkmark"></span> </label> </div> <div style="padding: 0px; display: inline-block" id="pixelselectToolSettingsMobile" class="toolSettingsMobile"> <div class="ui-button" id="pixelselectMobileDeselect" style="font-size: 12px"><img src="icons/selectcancel@2x.png"></div> <div class="ui-button" id="pixelselectMobileClear" style="font-size: 12px"><img src="icons/svg/glyphicons-basic-250-eraser.svg"></div> <div class="ui-button" id="pixelselectMobileCut" style="font-size: 12px"><img src="icons/svg/glyphicons-basic-612-scissors.svg"></div> <div class="ui-button" id="pixelselectMobileCopy" style="font-size: 12px"><img src="icons/svg/glyphicons-basic-614-copy.svg"></div> <div class="ui-button" id="pixelselectMobilePaste" style="font-size: 12px"><img src="icons/svg/glyphicons-basic-613-paste.svg"></div> <div class="ui-button" id="pixelselectMobileFlipH" style="font-size: 12px"><img src="icons/svg/glyphicons-basic-747-reflect-y.svg"/></div> <div class="ui-button" id="pixelselectMobileFlipV" style="font-size: 12px"><img src="icons/svg/glyphicons-basic-748-reflect-x.svg"/></div> </div> </div>';g_htmlCache["html/textMode/importImageFrames.html"]='<div class="panelFill"> <div id="importImageFramesHolder" style="position: absolute; padding: 10px; top: 0; left: 0; right: 0px; bottom: 0; overflow: auto"> <h3><i class="halflings halflings-film"/>&nbsp;Frames</h3> <div class="formGroup"> <div id="importImageTickControls"> <div id="importImageAnimationFrames"> <div class="formRow"> Choose more than one frame for animated effects/video </div> <div class="formRow"> <label class="controlLabel" for="importImageFrames"> Frames </label> <input type="text" class="formControl number" value="1" min="1" size="4" id="importImageFrames"/> </div> <div class="formRow"> <label class="controlLabel" for="importImageTicksPerFrame"> Ticks/frame </label> <input type="text" size="4" class="number" min="1" id="importImageTicksPerFrame" value="6"/> </div> <div class="formRow"> <label class="controlLabel" for="importImageInsertFrames" style="margin-top: 0">Insert frames</label> <label class="cb-container">&nbsp; <input type="checkbox" id="importImageInsertFrames"/> <span class="checkmark"></span> </label> </div> </div> </div> </div> </div> </div> </div>';g_htmlCache["html/textMode/clearHiddenTiles.html"]='<div class="panelFill dialogContent" id="clearHiddenTilesPanel"> <div class="formGroup"> <label class="controlLabel">Frame</label> <div class="radioGroup"> <div> <label class="rb-container">Current Frame <input type="radio" name="clearHiddenTilesFrame" value="current" id="clearHiddenTilesCurrentFrame" checked="checked"> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">All Frames <input type="radio" name="clearHiddenTilesFrame" value="all" id="clearHiddenTilesAllFrames"> <span class="checkmark"></span> </label> </div> </div> </div> </div>';g_htmlCache["html/textMode/framesMobile.html"]='<div id="framesMobile" class="panelFill nodrag" style="border-top: 1px solid #555555; padding: 4px; overflow: hidden; white-space: nowrap; display: flex; justify-content: space-between"> <div class="ui-button" id="playMobile" style="width: 30px"><i class="halflings halflings-play"/></div> <div style="display: inline-block"> <div class="ui-button" id="prevFrameMobile"><i class="halflings halflings-chevron-left"/></div> <div style="display: inline-block; width: 34px; margin-left: 2px" id="frameCountInfoMobile"></div> <div class="ui-button" id="nextFrameMobile"><i class="halflings halflings-chevron-right"/></div> </div> <div style="display: inline-block"> <div class="ui-button" id="insertFrameMobile" style="margin-right: 4px"><i class="halflings halflings-plus"/></div> <div class="ui-button" id="duplicateFrameMobile" style="margin-right: 4px"><i class="halflings halflings-duplicate"/></div> <div class="ui-button" id="deleteFrameMobile" style="margin-right: 4px"><i class="halflings halflings-trash"/></div> </div> </div>';g_htmlCache["html/textMode/exportSpritePngPreview.html"]='<div class="panelFill"> <div style="position: absolute; left: 10px; top: 10px;"><div style="display: inline-block" id="exportSpritePNGInfo"></div></div> <div style="position: absolute; top: 30px; left: 10px; right: 10px; bottom: 46px" id="exportSpritePngPreviewHolder"> <canvas id="exportSpritePngPreview" style="border: 1px solid #aaaaaa"></canvas> </div> <div style="position: absolute; left: 10px; bottom: 10px"> <label class="controlLabel" for="pngExportPreviewScale">Preview Scale</label> <input id="spritepngExportPreviewScale" style="width: 180px" type="range" min="1" max="5000" value="100" size="3"> <input id="spritepngExportPreviewScaleText" class="number" type="text" style="width: 30px" min="1" max="5000" value="100" size="2"> <button type="button" id="spritepngExportPreviewScaleReset">R</button> </div> </div> </div> ';g_htmlCache["html/textMode/exportBinaryData.html"]='<div class="panelFill dialogContent" id="exportBinaryDataPanel"> <div class="formGroup"> <label class="controlLabel" for="exportBinaryAs">File name:</label> <input type="text" class="formControl" size="20" value="" id="exportBinaryAs"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportBinaryFromFrame">Format</label> <div class="radioGroup"> <div> <label class="rb-container">Binary <input type="radio" class="formControl" size="20" value="binary" checked="checked" name="exportBinaryFormat" id="exportBinaryFormat"/> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">C64 PRG (add address at beginning) <input type="radio" class="formControl" size="20" value="c64" name="exportBinaryFormat" id="exportBinaryFormatPRG"/> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">Mega65 <input type="radio" class="formControl" size="20" value="mega65" name="exportBinaryFormat" id="exportBinaryFormatMega65"/> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">Include MZ-80a header <input type="radio" class="formControl" size="20" value="mz80a" name="exportBinaryFormat" id="exportBinaryFormatMZ80a"/> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">MZ 700 <input type="radio" class="formControl" size="20" value="mz700" name="exportBinaryFormat" id="exportBinaryFormatMZ700"/> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel" for="exportBinaryFromFrame">Colour Mode</label> <label class="rb-container">FG Colour per Tile <input type="radio" class="formControl" size="20" value="standard" checked="checked" name="exportBinaryColorMode" id="exportBinaryColorMode_standard"/> <span class="checkmark"></span> </label> &nbsp; <label class="rb-container">C64 ECM <input type="radio" class="formControl" size="20" value="ecm" name="exportBinaryColorMode" id="exportBinaryColorMode_ecm"/> <span class="checkmark"></span> </label> </div> <div class="formGroup"> <label class="controlLabel">Include:</label> <div class="checkboxGroup"> <div> <label class="cb-container">Screen Character Data <input type="checkbox" id="exportBinaryCharacterData" checked="checked"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Screen Colour Data <input type="checkbox" id="exportBinaryColorData" checked="checked"> <span class="checkmark"></span> </label> </div> <div> <label class="cb-container">Character set Data <input type="checkbox" id="exportBinaryCharactersetData" checked="checked"> <span class="checkmark"></span> </label> </div> <div id="export-binary-character-attribute-row"> <label class="cb-container">Character Attribute Data <input type="checkbox" id="exportBinaryCharacterAttributeData"> <span class="checkmark"></span> </label> </div> </div> </div> <div class="formGroup"> <label class="controlLabel" for="exportBinaryFromFrame">Export Frames:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="exportBinaryFromFrame"> &nbsp; <label for="exportBinaryToFrame">To</label> &nbsp; <input type="number" size="2" class="number" min="1" id="exportBinaryToFrame"> </div> </div> <div class="formGroup"> <label class="controlLabel">Layers:</label> <div class="radioGroup"> <label class="rb-container">Current Layer <input type="radio" name="exportBinaryLayer" id="exportBinaryLayerCurrent" value="current" checked="checked"/> <span class="checkmark"></span> </label> &nbsp; </div> </div> </div> ';g_htmlCache["html/textMode/mobileMenuBar.html"]='<div id="mobileMenuBar" class="panelFill activeBackground nodrag"> <div id="mobileMenuBarHamburger" class="ui-mobile-button"> <div class="rippleJS"></div> <img src="icons/material/ic_menu_48px.svg"/> </div> <div id="mobileMenuCurrentTools"> </div> <div id="mobileMenuUndoRedo"> <div id="mobileMenuBarUndo" class="ui-mobile-button"> <img src="icons/material/ic_undo_48px.svg" class="ui-mobile-button-img"/> <div class="rippleJS"></div> </div> <div id="mobileMenuBarRedo" class="ui-mobile-button"> <img src="icons/material/ic_redo_48px.svg" class="ui-mobile-button-img"/> <div class="rippleJS"></div> </div> </div> </div>';g_htmlCache["html/textMode/selectToolsOld.html"]='<div id="selectTools" class="panelFill activeBackground"> <div style="margin: 4px"> <table> <tr> <td style="padding: 0 10px 0 0; vertical-align: top"> <div style="margin-bottom: 4px"> <div style="margin-bottom: 2px">Select From:</div> <label>x: <input class="formControl number" min="0" max="40" type="text" size="2" id="selectX1" value="0"></label> <label>y: <input class="formControl number" min="0" max="25" type="text" size="2" id="selectY1" value="0"></label> <span class="selectZControl"> <label>z: <input class="formControl number" min="0" max="25" type="text" size="2" id="selectZ1" value="0"></label> </span> </div> <div style="margin-bottom: 4px"> <div style="margin-bottom: 2px">Select To:</div> <label>x: <input class="formControl number" type="text" min="0" max="40" size="2" id="selectX2" value="0"></label> <label>y: <input class="formControl number" type="text" min="0" max="25" size="2" id="selectY2" value="0"></label> <span class="selectZControl"> <label>z: <input class="formControl number" type="text" min="0" max="25" size="2" id="selectZ2" value="0"></label> </span> </div> </td> <td style="padding: 0 10px 0 0"> <div style="margin: 4px 0 4px 0"> <button id="selectFillButton">Fill</button> <button id="selectInvertButton">Invert</button> <button id="selectFlipHButton">Flip H (F)</button> <button id="selectFlipVButton">Flip V (G)</button> </div> <div style="margin: 4px 0 4px 0"> Move: <button id="selectNudgeLeft">&lt;</button> <button id="selectNudgeRight">&gt;</button> <button id="selectNudgeUp">/</button> <button id="selectNudgeDown">/</button> </div> <div style="margin: 4px 0 4px 0"> Rotate: <button id="selectRotateLeft">&lt;</button> <button id="selectRotateRight">&gt;</button> <button id="selectRotateUp">/</button> <button id="selectRotateDown">/</button> </div> <br/><br/> <button id="selectReplaceColorsButton">Replace Colour</button> <button id="selectReplaceCharactersButton">Replace Character</button> <br/><br/> <button id="selectDrawUsingSelection">Draw Using Selection (D)</button> </td> <td style="padding: 0 10px 0 0; vertical-align: top"> <span class="selectZControl"> <label for="pasteRotation">Paste Angle</label> <select class="formControl" id="pasteRotation"> <option value="0">0</option> <option value="90">90</option> <option value="180">180</option> <option value="270">270</option> </select> <br/><br/> </span> <label> </table> </td> </tr> </table> </div> </div>';g_htmlCache["html/textMode/colorPalettePanel.html"]='<div class="activeBackground panelFill"> <div class="title" style="background-color: #111111; height: 18px"> <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap"> Colours </div> <div style="position: absolute; top: 2px; right: 2px; width: 20px"> <div id="colorPaletteCloseButton" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div> </div> </div> <div id="colorPalettePanelSubPalettes" style="display: none"> <div class="colorPalettePanelSubPalette" data-subPalette="0"> <div class="colorPalettePanelSubPaletteHolder"> <div class="colorPalettePanelSubPaletteLabel">0:</div> <div class="colorPalettePanelSubPaletteColors"> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette0-Color0" data-subPalette="0" data-color="0"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette0-Color1" data-subPalette="0" data-color="1"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette0-Color2" data-subPalette="0" data-color="2"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette0-Color3" data-subPalette="0" data-color="3"></div> </div> </div> </div> <div class="colorPalettePanelSubPalette" data-subPalette="1"> <div class="colorPalettePanelSubPaletteHolder"> <div class="colorPalettePanelSubPaletteLabel">1:</div> <div class="colorPalettePanelSubPaletteColors"> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette1-Color0" data-subPalette="1" data-color="0"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette1-Color1" data-subPalette="1" data-color="1"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette1-Color2" data-subPalette="1" data-color="2"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette1-Color3" data-subPalette="1" data-color="3"></div> </div> </div> </div> <div class="colorPalettePanelSubPalette" data-subPalette="2"> <div class="colorPalettePanelSubPaletteHolder"> <div class="colorPalettePanelSubPaletteLabel">2:</div> <div class="colorPalettePanelSubPaletteColors"> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette2-Color0" data-subPalette="2" data-color="0"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette2-Color1" data-subPalette="2" data-color="1"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette2-Color2" data-subPalette="2" data-color="2"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette2-Color3" data-subPalette="2" data-color="3"></div> </div> </div> </div> <div class="colorPalettePanelSubPalette" data-subPalette="3"> <div class="colorPalettePanelSubPaletteHolder"> <div class="colorPalettePanelSubPaletteLabel">3:</div> <div class="colorPalettePanelSubPaletteColors"> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette3-Color0" data-subPalette="3" data-color="0"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette3-Color1" data-subPalette="3" data-color="1"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette3-Color2" data-subPalette="3" data-color="2"></div> <div class="colorPalettePanelSubPaletteColor" id="colorPalettePanelSubPalette3-Color3" data-subPalette="3" data-color="3"></div> </div> </div> </div> </div> <div id="colorPalettePanelInfoHolder" style="position: absolute; top: 22px; left: 3px; right: 3px; height: 24px"> <div id="colorPalettePanelInfoColor" style="display: inline-block; width: 20px; height: 20px; background-color: #ff0000"></div> <div id="colorPalettePanelInfoColorDec" style="display: inline-block; width: 28px;">0</div> <div id="colorPalettePanelInfoColorHex" style="display: inline-block; width: 28px;">0x00</div> <div id="colorPalettePanelInfoColorRGB" style="display: inline-block; width: 60px">#000000</div> </div> <div id="colorPaletteHolder" style="position: absolute; top: 46px; left: 2px; right: 2px; bottom: 28px; border: 1px solid #000000; overflow-y: auto; overflow-x: hidden"> <canvas style="background-color: #222222" id="colorPalettePanelCanvas"></canvas> </div> <div style="position: absolute; display: flex; align-items: center; bottom: 2px; left: 3px; right: 3px; height: 24px"> <select id="colorPaletteSortOrder"> <option value="default">Default Layout</option> <option value="source">Color Index</option> <option value="hls">Hue</option> <option value="saturation">Saturation</option> <option value="brightness">Brightness</option> <option value="red">Red</option> <option value="green">Green</option> <option value="blue">Blue</option> </select> <div class="ui-button" id="chooseColorPaletteButton">Choose Palette...</div> <div class="ui-button" style="margin-left: 8px" id="editColorPaletteButton">Edit Palette...</div> <div class="ui-button" style="margin-left: 8px" id="loadColorPaletteButton">Load Palette...</div> </div> </div> ';g_htmlCache["html/textMode/colorPaletteEditor.html"]='<div class="panelFill" id="colorPaletteEditor"> <style> #editColorPaletteDialog h2 { margin: 2px 0 10px 0; border-bottom: 1px solid #444444; padding-bottom: 6px; } .editColorPaletteTable { margin: 2px; } .editColorPaletteTable td { padding: 6px 10px 10px 10px; } .editColorPaletteColorInfo { font-size: 10px; line-height: 13px; } .editColorPalettePanel { margin-bottom: 10px; } </style> <table class="editColorPaletteTable"> <tr> <td valign="top" style="padding-right: 20px; min-width: 356px"> <div class="editColorPalettePanel"> <h2>Tools</h2> <div class="colorPaletteTool colorPaletteToolSelected" id="colorPaletteEditorTool_pen"><img width="20" src="icons/glyphicons-31-pencil@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteEditorTool_erase"><img width="20" src="icons/glyphicons-551-erase@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteEditorTool_eyedropper"><img width="20" src="icons/glyphicons-91-eyedropper@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteEditorTool_select"><img width="20" src="icons/glyphicons-100-vector-path-select@2x.png"/></div> <div class="colorPaletteTool" id="colorPaletteEditorTool_move"><img width="20" src="icons/glyphicons-187-move@2x.png"/></div> <div id="colorPaletteEditorCurrentTool" style="display:inline-block">&nbsp;</div> </div> <div class="editColorPalettePanel"> <h2>Current Palette</h2> <div id="colorPaletteEditorCanvasHolder"> <canvas id="colorPaletteEditorCanvas"></canvas> </div> <div> <label class="cb-container">Show Grid <input type="checkbox" id="colorPaletteEditorShowGrid" checked="checked"> <span class="checkmark"/> </label> <label>Width: <input type="text" id="colorPaletteEditorGridWidth" class="number" min="1" max="30" value="16" style="width: 30px" size="2"/></label> <label>Height: <input type="text" id="colorPaletteEditorGridHeight" class="number" min="1" max="30" value="16" style="width: 30px" size="2"/></label> </div> <div> <div class="ui-button" id="colorPaletteEditorClear">Clear Palette</div> <div class="ui-button" style="margin-left: 10px" id="colorPaletteEditorLoad">Load Palette...</div> <div class="ui-button" style="margin-left: 10px" id="colorPaletteEditorLoad">Load Palette...</div> <form id="colorPaletteEditorLoadForm" style="position: absolute; top: -50px; left: -100px"> <input type="file" id="colorPaletteEditorChooseFile" accept=".png,.json,.aco,.act,.ase,.gpl,.txt,.hex,.vpl,.jpg,.jpeg"/> </form> </div> </div> </td> <td valign="top"> <div class="editColorPalettePanel"> <h2>Current Colour</h2> <div style="position: relative; width: 240px; height: 130px"> <div class="colorPaletteEditorDrawColor"> <div style="position: absolute; left: 0; top: 0; width: 128px; height: 65px" id="colorPaletteEditorImageMouseSelectedColor"></div> <div style="position: absolute; left: 138px; top: 0; width: 110px; height: 65px;" class="editColorPaletteColorInfo" id="colorPaletteEditorImageMouseSelectedColorInfo"/> </div> <div> <div style="position: absolute; left: 0; top: 65px; width: 128px; height: 65px" id="colorPaletteEditorImageMouseHoverColor"/> <div style="position: absolute; left: 138px; top: 65px; width: 110px; height: 65px" class="editColorPaletteColorInfo" id="colorPaletteEditorImageMouseHoverColorInfo"/> </div> </div> </div> <div class="editColorPalettePanel"> <div style="margin-bottom: 4px" class="editColorPaletteChooseMethod"> <h2>Choose Colours</h2> <label class="rb-container" style="margin-right: 4px">HSV / RGB <input type="radio" name="editColorPaletteMethod" value="rgb" checked="checked"> <span class="checkmark"/> </label> <label class="rb-container" style="margin-right: 4px">From Image <input type="radio" name="editColorPaletteMethod" value="image"> <span class="checkmark"/> </label> <label class="rb-container" style="margin-right: 4px">Colour Wheel <input type="radio" name="editColorPaletteMethod" value="colorwheel"> <span class="checkmark"/> </label> </div> <div id="colorPaletteEditorGraphHolder" class="colorPaletteSelectionMethod" style="display: none"> <div> <label for="colorPaletteEditorGraphParam">Param</label> <select id="colorPaletteEditorGraphParam"> <optgroup label="RGB"> <option value="red" selected="selected">Red</option> <option value="green">Green</option> <option value="blue">Blue</option> </optgroup> <optgroup label="HSV"> <option value="hue">Hue</option> <option value="saturation">Saturation</option> <option value="value">Value</option> </optgroup> </select> </div> <div> <canvas id="colorPaletteEditorGraph" style="background-color: black;"></canvas> </div> </div> <div id="colorPaletteEditorSelectionMethod_rgb" class="colorPaletteSelectionMethod"> <h3>RGB</h3> <div> <div class="colorComponentSelector"> <label for="editColorPaletteR">R</label> <canvas width="200" height="28" id="colorPaletteEditorRCanvas" class="colorPaletteSlider" data-component="r"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="colorPaletteEditorR" data-component="r" min="0" max="255" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteG">G</label> <canvas width="200" height="28" id="colorPaletteEditorGCanvas" class="colorPaletteSlider" data-component="g"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="colorPaletteEditorG" data-component="g" min="0" max="255" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteB">B</label> <canvas width="200" height="28" id="colorPaletteEditorBCanvas" class="colorPaletteSlider" data-component="b"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="colorPaletteEditorB" data-component="b" min="0" max="255" value="0"> </div> </div> <h3>HSV</h3> <div> <div class="colorComponentSelector"> <label for="editColorPaletteH">H</label> <canvas width="200" height="28" id="colorPaletteEditorHCanvas" class="colorPaletteSlider" data-component="h"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="colorPaletteEditorH" data-component="h" min="0" max="360" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteS">S</label> <canvas width="200" height="28" id="colorPaletteEditorSCanvas" class="colorPaletteSlider" data-component="s"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="colorPaletteEditorS" data-component="s" min="0" max="100" value="0"> </div> <div class="colorComponentSelector"> <label for="editColorPaletteB">V</label> <canvas width="200" height="28" id="colorPaletteEditorVCanvas" class="colorPaletteSlider" data-component="v"></canvas> <input type="text" class="number colorPaletteNumber" size="4" id="colorPaletteEditorV" data-component="v" min="0" max="100" value="0"> </div> </div> <div> <label for="colorPaletteEditorHex">#</label> <input type="text" maxlength="6" id="colorPaletteEditorHex" size="6"/> </div> </div> <div id="colorPaletteEditorSelectionMethod_image" class="colorPaletteSelectionMethod" style="display: none"> <div> <div style="padding-bottom: 2px"> <div class="ui-button" id="colorPaletteEditorImageChooseFile">Choose Image...</div> <div id="colorPaletteEditorImageChooseFileName" style="display: inline-block; margin-left: 6px"></div> <input class="formControl" style="position: absolute; top: -50px; left: -100px" id="colorPaletteEditorImage" type="file" accept="image/*"/> </div> <canvas id="colorPaletteEditorFromImageImage" style="background-color: #111111"></canvas> </div> <div> <label>Scale</label> <div class="ui-button" id="colorPaletteEditorImageScaleDecrease">-</div> <input type="text" size="3" style="width: 40px" type="text" id="colorPaletteEditorImageScale" min="1" class="number" value="100"/> <div class="ui-button" id="colorPaletteEditorImageScaleIncrease">+</div> <div class="ui-button" id="colorPaletteEditorImageFit">Fit</div> </div> <div class="formGroup"> <label class="controlLabel" for="">Colour Count</label> <select id="colorPaletteEditorFromImageColorCount"> <option value="2">2</option> <option value="4">4</option> <option value="8">8</option> <option value="16" selected="selected">16</option> <option value="32">32</option> <option value="64">64</option> <option value="128">128</option> </select> <button id="colorPaletteEditorFromImageAdd">Add These Colours &gt;</button> </div> <canvas id="colorPaletteEditorFromImagePalette" style="background-color: #111111"></canvas> </div> <div id="colorPaletteEditorSelectionMethod_colorwheel" class="colorPaletteSelectionMethod" style="display: none"> <table> <tr> <td> <canvas id="colorPaletteEditorColorWheel"></canvas> </td> <td> <canvas id="colorPaletteEditorColorWheelValue" height="200" width="24"></canvas> </td> </tr> </table> </div> </div> </td> </tr> </table> </div>';g_htmlCache["html/textMode/colorPaletteChoosePreset.html"]='<div class="panelFill"> <div id="chooseColorPaletteList" style="position: absolute; left: 10px; top: 10px; bottom: 0; width: 180px; overflow: auto; "> <div class="characterSetListEntry">c64</div> </div> <div style="position: absolute; left: 200px; top: 0px; bottom: 0; right: 0; overflow: auto" id="chooseColorPaletteDetails"> <div style="margin: 10px"> <h3 id="chooseColorPaletteHeading"></h3> <div id="chooseColorPaletteInfo"></div> <div id="chooseColorPaletteDescription"></div> <canvas id="chooseColorPalettePreview" width="256" height="256" style="background-color: #222222"></canvas> <div id="chooseColorPaletteOptions" style="height: 20px; background-color: #272727; width: 381px; padding: 10px 10px 4px 10px"></div> <div id="chooseColorPaletteControls"> <div class="formRow"> <label class="controlLabel">Brightness:</label> <input type="number" id="choosePaletteBrightnessValue" value="0" class="number" min="-100" max="100" size="3"/> <input type="range" min="-100" max="100" value="0" size="3" id="choosePaletteBrightness"/> <div class="ui-button" id="choosePaletteBrightnessReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel">Contrast:</label> <input type="number" class="number" min="-100" max="100" value="0" size="3" id="choosePaletteContrastValue"/> <input type="range" class="" min="-100" max="100" value="0" size="3" id="choosePaletteContrast"/></label> <div class="ui-button" id="choosePaletteContrastReset">Reset</div> </div> <div class="formRow"> <label class="controlLabel">Saturation:</label> <input type="number" class="number" min="-100" max="100" value="0" size="3" id="choosePaletteSaturationValue"/> <input type="range" min="-100" max="100" value="0" id="choosePaletteSaturation"/> <div class="ui-button" id="choosePaletteSaturationReset">Reset</div> </div> </div> </div> </div> </div>';g_htmlCache["html/textMode/tileSetImport.html"]='<div class="panelFill"> <div style="position: absolute; left: 10px; top: 10px; right: 0px; height: 60px"> <div class="formGroup"> <div style="margin-bottom: 6px"> Choose an image file (.png, .jpg, .gif) containing a character set, or a file containing binary character data (eg ROM, PRG file) </div> <form id="tileSetImportForm"> <div class="ui-button ui-button-nextaction" id="loadTileSetChooseFile">Choose...</div> <input type="file" id="loadTileSetFile" style="position: absolute; top: -50px; left: -100px"/> <span id="loadTileSetFileName"></span> </form> </div> </div> <div id="loadTileSetSettings" style="display: none"> <div id="loadTileSetFontSettings" style="display: none; position: absolute; left: 10px; top: 80px; bottom: 0px; width: 220px; overflow: auto"> <div>Load Font!</div> <div class="formGroup"> <label class="controlLabel" for="loadFontTileSetWidth">Tile Width:</label> <input type="number" class="float" min="1" max="128" size="3" id="loadFontTileSetWidth" value="64"> </div> <div class="formGroup"> <label class="controlLabel" for="loadFontTileSetHeight">Tile Height:</label> <input type="number" class="float" min="1" max="128" size="3" id="loadFontTileSetHeight" value="64"/> </div> <div class="formGroup"> <label class="controlLabel" for="loadFontTileSetXOffset">X Offset:</label> <input type="number" class="float" min="-500" max="500" size="3" id="loadFontTileSetXOffset" value="0"/> </div> <div class="formGroup"> <label class="controlLabel" for="loadFontTileSetYOffset">Y Offset:</label> <input type="number" class="float" min="-500" max="500" size="3" id="loadFontTileSetYOffset" value="0"/> </div> <div class="formGroup"> <label class="controlLabel" for="loadFontFontSize">Font Size:</label> <input type="number" class="float" min="1" max="128" size="3" id="loadFontFontSize" value="28"/> </div> <div class="formGroup"> <label class="controlLabel" for="loadFontFontSize">First Char:</label> <input type="number" class="number" min="0" max="16000" size="3" id="loadFontFirstChar" value="0"/> </div> <div class="formGroup"> <label class="controlLabel" for="loadFontFontSize">Tile Count:</label> <input type="number" class="number" min="1" max="1024" size="3" id="loadFontTileCount" value="256"/> </div> <div class="formGroup"> <div class="ui-button ui-button-nextaction" id="loadFontGenerate">Generate</div> </div> </div> <div id="loadTileSetParametersStatic" style="display: none; position: absolute; left: 10px; top: 80px; bottom: 0px; width: 220px; overflow: auto"> <div class="formGroup"> <label class="controlLabel" for="loadTileSetWidthStatic">Tile Width:</label> <label class="controlLabel" id="loadTileSetWidthStatic"></span> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetHeightStatic">Tile Height:</label> <span class="controlLabel" id="loadTileSetHeightStatic"></span> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetCountStatic">Tiles in File:</label> <span class="controlLabel" id="loadTileSetCountStatic"></span> </div> </div> <div id="loadTileSetParameters" style="position: absolute; left: 10px; top: 80px; bottom: 0px; width: 220px; overflow: auto"> <div class="formGroup"> <label class="controlLabel" for="loadTileSetMode">Mode:</label> <select name="loadTileSetMode" id="loadTileSetMode"> <option value="textmode">Text Mode</option> <option value="indexed">Indexed Colour</option> <option value="rgb">RGB Colour</option> </select> </div> <div class="formGroup" id="loadTileSetColorsControl"> <label class="controlLabel" for="loadTileSetColors">Colours:</label> <select name="loadTileSetColors" id="loadTileSetColors"> <option value="source">Source Image</option> <option value="64">Source (64 Colours)</option> <option value="32">Source (32 Colours)</option> <option value="16">Source (16 Colours)</option> <option value="8">Source (8 Colours)</option> <option value="0">Current Palette</option> </select> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetWidth">Resize Tiles:</label> <div class="checkboxGroup"> <div> <label class="rb-container">100% <input type="radio" name="loadTileSetResize" value="100" checked="checked"> <span class="checkmark"></span> </label> </div> <div> <label class="rb-container">50% <input type="radio" name="loadTileSetResize" value="50"> <span class="checkmark"></span> </div> <div> <label class="rb-container">25% <input type="radio" name="loadTileSetResize" value="25"> <span class="checkmark"></span> </div> </div> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetWidth">Tile Width:</label> <input type="number" class="number" min="1" max="128" size="3" id="loadTileSetWidth" value="8"> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetHeight">Tile Height:</label> <input type="number" class="number" min="1" max="128" size="3" id="loadTileSetHeight" value="8"/> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetCount">Tiles in File:</label> <input type="number" class="number" min="1" max="4096" size="3" id="loadTileSetCount" value="256"/> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetStartChar">Start Tile:</label> <input type="number" class="number" min="1" max="256" size="3" id="loadTileSetStartChar" value="1"/> </div> <div id="loadTileSetBinarySettings"> <div class="formGroup"> <label class="controlLabel" for="loadTileSetFileOffset">File Offset:</label> <input type="number" class="number" min="0" size="5" id="loadTileSetFileOffset" value="0"> Bytes </div> </div> <div id="loadTileSetImageSettings"> <div class="formGroup"> <label class="controlLabel" for="loadTileSetAcross">Tiles Across:</label> <input type="number" class="number" min="0" max="256" size="3" id="loadTileSetAcross" value="16"> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetHOffset">H Offset:</label> <input type="number" class="number" min="-4000" max="4000" size="3" id="loadTileSetHOffset" value="0"> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetVOffset">V Offset:</label> <input type="number" class="number" min="-4000" max="4000" size="3" id="loadTileSetVOffset" value="0"> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetHSpacing">Tile H Spacing:</label> <input type="number" class="number" min="-1024" max="1024" size="3" id="loadTileSetHSpacing" value="0"> </div> <div class="formGroup"> <label class="controlLabel" for="loadTileSetVSpacing">Tile V Spacing:</label> <input type="number" class="number" min="-1024" max="1024" size="3" id="loadTileSetVSpacing" value="0"> </div> <div class="formGroup"> <label class="controlLabel">Tile Direction:</label> <div style="display: inline-block"> <label><input type="radio" name="loadTileSetDirection" value="across" checked="checked">Across First</label><br/> <label><input type="radio" name="loadTileSetDirection" value="down">Down First</label> </div> </div> </div> <div> <label><input type="checkbox" id="loadTileSetInvert"> Invert</label> </div> </div> <div style="position: absolute; left: 240px; top: 50px; right: 0; bottom: 0; overflow: auto"> <div> <label for="loadTileSetPreviewSize">Preview Size: </label> <select id="loadTileSetPreviewSize"> <option value="1">100%</option> <option value="2" selected="selected">200%</option> <option value="3">300%</option> <option value="4">400%</option> </select> </div> <canvas id="loadTileSetCanvas" style="background-color: black"></canvas> </div> </div> </div>';g_htmlCache["html/textMode/dimensionsDialog.html"]='<div id="dimensionsDialog" class="panelFill"> <div style="padding: 10px"> <div id="settingsDimensionsTile"> <div> <h3>Tile Dimensions</h3> </div> <div class="formGroup"> <label class="controlLabel" for="settingsDimensionsTileWidth">Tile Width:</label> <input type="number" class="formControl number dimensionsNumber" min="1" id="settingsDimensionsTileWidth" size="4"/> </div> <div class="formGroup"> <label class="controlLabel" for="settingsDimensionsTileHeight">Tile Height:</label> <input type="number" class="formControl number dimensionsNumber" min="1" id="settingsDimensionsTileHeight" size="4"/> </div> </div> <div> <h3>Grid Dimensions</h3> </div> <div class="formGroup"> <label class="controlLabel" for="settingsDimensionsWidth">Grid Width:</label> <input type="number" class="formControl number dimensionsNumber" min="1" id="settingsDimensionsWidth" size="4"/> </div> <div class="formGroup"> <label class="controlLabel" for="settingsDimensionsHeight">Grid Height:</label> <input type="number" class="formControl number dimensionsNumber" min="1" id="settingsDimensionsHeight" size="4"/> </div> <div class="formGroup" id="dimensionsDialogDepth" style="display: none"> <label class="controlLabel" for="settingsDimensionsDepth">Depth:</label> <input type="number" class="formControl number dimensionsNumber" min="1" id="settingsDimensionsDepth" size="4"/> </div> <div> <h3>Current Grid Offset</h3> </div> <div class="formGroup"> <label class="controlLabel" for="settingsDimensionsOffsetX">Offset X:</label> <input type="number" class="formControl number dimensionsNumber" min="-1000" value="0" id="settingsDimensionsOffsetX" size="4"/> </div> <div class="formGroup"> <label class="controlLabel" for="settingsDimensionsOffsetY">Offset Y:</label> <input type="number" class="formControl number dimensionsNumber" min="-1000" value="0" id="settingsDimensionsOffsetY" size="4"/> </div> <div style="text-align: center"> <canvas id="settingsDimensionsOffsetCanvas" width="200" height="200" style=""></canvas> </div> </div> </div> ';g_htmlCache["html/textMode/exportImageMobile.html"]='<div class="panelFill"> <div style="display: inline-block" id="exportImageMobileInfo"></div> <div id="exportImagePreviewHolder" style="position: absolute; top: 0; left: 0; right: 0; height: 260px; background-color: #111111; border-bottom: 1px solid #555555; padding: 6px"> <div style="text-align: center;"> <canvas id="exportImagePreview" style="border: 1px solid #aaaaaa"></canvas> </div> </div> <div id="exportImageMobileControlsHolder" style="position: absolute; top: 272px; left: 0; right: 0; bottom: 0; overflow: auto; padding: 6px"> <div class="formRow"> <label class="controlLabel" for="imageExportMobilePreviewScale">Preview Scale</label> <input id="imageExportPreviewScaleText" class="number" type="text" style="width: 40px" min="1" max="5000" value="100" size="2"> <div class="rangeHolder"> <input id="imageExportPreviewScale" style="width: 100%" type="range" min="20" max="500" value="100" size="3"> </div> <div class="ui-button rangeButton" id="imageExportPreviewScaleReset">100%</div> </div> <div class="formRow"> <label class="controlLabel" for="exportImageAs">File name</label> <input type="text" class="formControl" size="20" value="" id="exportImageAs"/> </div> <div class="formGroup"> <label class="controlLabel" for="exportImageFormat">Format:</label> <label class="rb-container">GIF <input type="radio" name="exportImageFormat" value="gif" checked="checked"> <span class="checkmark"></span> </label> <label class="rb-container">PNG <input type="radio" name="exportImageFormat" value="png"> <span class="checkmark"></span> </label> </div> <div class="formRow"> <label class="controlLabel" for="exportImageScale">Scale</label> <select class="formControl" id="exportImageScale"> <option value="1">100%</option> <option value="2">200%</option> <option value="3">300%</option> <option value="4">400%</option> <option value="5">500%</option> </select> </div> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <div style="display: inline-block" id="exportImageDimensions"></div> </div> <div class="formRow" style="display: block; padding: 10px 0"> <div class="formGroup"> <label class="controlLabel">&nbsp;</label> <label class="cb-container">Include Border <input type="checkbox" id="exportImageIncludeBorder" value="1"/> <span class="checkmark"/> </label> </div> </div> <div class="formGroup" id="borderSizeHolder" style="margin-bottom: 8px"> <label class="controlLabel">Border Size</label> W: <input type="number" class="number" min="0" max="100" id="exportImageBorderWidth" value="32"> &nbsp;&nbsp; H: <input type="number" class="number" min="0" max="100" id="exportImageBorderHeight" value="36"> &nbsp; <div class="ui-button" id="exportImageBorderReset">Reset</div> </div> <div class="exportImageGIFParameters"> <h3><i class="halflings halflings-film"></i>&nbsp;Frames</h3> <div id="exportImageFrames"> <div class="formGroup"> <label class="controlLabel" for="exportImageFromFrame" style="width: 50px">Frames:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="exportImageFromFrame" style="width: 30px"> &nbsp; <label for="exportImageToFrame">To</label> &nbsp; <input type="number" size="2" class="number" min="1" id="exportImageToFrame" style="width: 30px"> </div> <select name="exportImageLoopType" id="exportImageLoopType"> <option value="loop">Loop</option> <option value="pingpong">Ping Pong</option> </select> </div> <div class="formGroup"> <label class="controlLabel" style="width: 50px">Speed:</label> <select name="exportImageSpeed" id="exportImageSpeed"> <option value="1">100%</option> <option value="2">200%</option> <option value="3">300%</option> <option value="4">400%</option> <option value="custom">Custom</option> </select> </div> <div class="formGroup" id="exportImageCustomSpeed" style="display: none"> <label class="controlLabel">Custom speed:</label> <div style="display: inline-block"> <input type="number" size="3" class="number" min="5" value="10" id="exportImageMSPerTick"/> ms per tick </div> </div> </div> </div> <div class="exportImagePNGParameters"> <h3><i class="halflings halflings-film"></i>&nbsp;Frame</h3> <div class="exportImageFrameHolder"> <div class="formGroup"> <label class="controlLabel" for="exportImageFromFrame" style="width: 50px">Frame:</label> <div style="display: inline-block"> <input type="number" size="2" class="number" min="1" id="exportImageFrame" style="width: 30px" value="1"/> </div> </div> </div> </div> <div> <h3>Effects</h3> </div> <div> <div class="ui-button" id="exportImageEffectPrev">&lt;</div> <select id="exportImageEffectOptions"> </select> <div class="ui-button" id="exportImageEffectNext">&gt;</div> </div> <div id="exportImageEffectControls"> </div> </div> </div> </div> ';g_htmlCache["html/textMode/colorPaletteLoad.html"]='<div class="panelFill dialogContent" id="colorPaletteLoadDialog"> <h2 style="margin-top: 0">Load / Import Colour Palette</h2> <div style="margin-bottom: 8px;"> Choose a colour palette file, drag a color palette file into the window, or load a <a href="https://lospec.com/palette-list" target="_blank">Lospec</a> palette from a URL </div> <div class="formGroup" style="display: flex"> <div style="display: flex; height: 24px; align-items: center" class="ui-button ui-button-nextaction" id="colorPaletteFileChoose">Choose File...</div> &nbsp; <div class="ui-button" style="background-color: #232125; display: flex; height: 24px; align-items: center;" id="colorPaletteLoadLospec"> <img src="icons/lospec_logomark_1x.svg" style="filter: none; width: auto; height: 16px; margin-right: 6px"> Load Lospec Palette...</div> <div id="colorPaletteFileChooseName" style="display: inline-block; margin-left: 6px"></div> <input class="formControl" id="colourPaletteFile" type="file" style="position: absolute; top: -50px; left: -100px" accept=".png,.json,.aco,.act,.ase,.gpl,.txt,.hex,.vpl,.jpg,.jpeg"/> </div> <div style="margin: 6px 0"> File types accepted: .png, .json, .aco, .act, .ase, .gpl, .txt, .hex, .vpl </div> <div style="display: none; font-weight: bold; color: #ff0000; margin: 4px 0 4px 0" id="colorPaletteLoadError"></div> <div id="colorPaletteLoadSettings" style="display: none"> <div class="formGroup"> <label class="controlLabel" for="">Load Colours:</label> <input id="colorPaletteLoadUserColorCount" value="16" type="number" class="number" min="1" max="256" size="3"/> of <span id="colorPaletteLoadColorCount"></span> </div> <div class="formGroup"> <label class="controlLabel" for="colorPaletteLoadColorsAcross">Colours Across:</label> <input class="number integer" type="number" size="4" value="8" min="1" max="16" id="colorPaletteLoadColorsAcross"/> </div> <div> <canvas id="colorPaletteLoadPreview" style="background-color: #111111"></canvas> </div> </div> </div> ';g_htmlCache["html/textMode/selectTools.html"]='<div id="selectTools" class="panelFill activeBackground"> <div style="margin: 4px"> <div style="margin: 10px 0 10px 0"> <label style="width: 50px; display: inline-block">Nudge:</label> <div class="ui-button" title="Nudge Left" id="selectNudgeLeft"><img src="icons/svg/glyphicons-basic-213-arrow-left.svg"></div> <div class="ui-button" title="Nudge Right" id="selectNudgeRight"><img src="icons/svg/glyphicons-basic-214-arrow-right.svg"></div> <div class="ui-button" title="Nudge Up" id="selectNudgeUp"><img src="icons/svg/glyphicons-basic-212-arrow-up.svg"></div> <div class="ui-button" title="Nudge Down" id="selectNudgeDown"><img src="icons/svg/glyphicons-basic-211-arrow-down.svg"></div> (cmd + arrow) </div> <div style="margin: 10px 0 10px 0"> <label style="width: 50px; display: inline-block">Shift: </label> <div class="ui-button" title="Shift Left" id="selectRotateLeft"><img src="icons/svg/glyphicons-basic-859-square-left.svg"></div> <div class="ui-button" title="Shift Right" id="selectRotateRight"><img src="icons/svg/glyphicons-basic-860-square-right.svg"></div> <div class="ui-button" title="Shift Up" id="selectRotateUp"><img src="icons/svg/glyphicons-basic-858-square-up.svg"></div> <div class="ui-button" title="Shift Down" id="selectRotateDown"><img src="icons/svg/glyphicons-basic-857-square-down.svg"></div> </div> <div style="margin: 6px 0 10px 0"> <label style="width: 50px; display: inline-block">&nbsp;</label> <div class="ui-button" id="selectFillButton"><img src="icons/svg/glyphicons-basic-245-fill.svg"> Fill (C)</div> <div class="ui-button" id="selectInvertButton"><img src="icons/svg/glyphicons-basic-543-star-half.svg">Invert</div> <div class="ui-button" id="selectFlipHButton"><img src="icons/svg/glyphicons-basic-747-reflect-y.svg"> Flip H (F)</div> <div class="ui-button" id="selectFlipVButton"><img src="icons/svg/glyphicons-basic-748-reflect-x.svg"> Flip V (G)</div> </div> <div style="margin: 10px 0 10px 0"> <label style="width: 50px; display: inline-block">&nbsp;</label> <div class="ui-button" id="selectReplaceColorsButton">Replace Colour...</div> <div class="ui-button" id="selectReplaceCharactersButton">Replace Tile...</div> <div class="ui-button" id="selectSwitchFCBC">Switch FG/BG Colours</div> </div> <div style="margin: 10px 0"> <label style="width: 50px; display: inline-block">&nbsp;</label> <div id="selectDrawUsingSelection" class="ui-button"><img src="icons/svg/glyphicons-basic-31-pencil.svg"><span>Draw Using Selection (D)</span></div> </div> </div> </div>';g_htmlCache["html/assemblerUtils/c64MemoryMap.html"]='<div style="padding: 4px; background-color: white" class="panelFill"> <div style="position: absolute; top: 0; left: 0; right: 0; height: 40px"> <input name="c64MemoryMapSearch" id="c64MemoryMapSearch" size="40"> </div> <div id="mos6502OpcodeInfo" style="position: absolute; top: 40px; left: 0; right: 0; bottom: 0; background-color: #aaaaaa"> memory map info </div> </div>';g_htmlCache["html/assemblerUtils/mos6502Opcodes.html"]='<div style="padding: 4px" class="panelFill" id="mos6502OpcodeDictionary"> <div style="position: absolute; top: 0; left: 0; right: 0; height: 40px"> <input name="mos6502OpcodeSearch" id="mos6502OpcodeSearch" placeholder="Search For..." size="40"> </div> <div id="mos6502OpcodeInfo" style="position: absolute; top: 40px; left: 0; right: 0; bottom: 0;"> opcode info opcode info </div> </div>';g_htmlCache["html/assemblerUtils/calculator.html"]='<style> .calculator-row { display: flex; } .calculator-row .calculator-button { /*width: calc(16% - 2px); 50px; */ width: 16%; /*flex-grow: 1;*/ height: 50px; text-align: center; line-height: 50px; font-size: 16px; font-weight: 300; margin: 1px; display: inline-block; cursor: pointer; background-color: #444444; } .calculator-row .calculator-button:hover { background-color: #484848; } .calculator-row .calculator-button:active { background-color: #525252; } .calculator-buttons .disabled, .calculator-buttons .disabled:hover { /* background-color: #444444; */ color: #666666; cursor: default; font-weight: 100; } .calculator-row .calculator-button.num { background-color: #222222; } .calculator-row .calculator-button.num:hover { background-color: #282828; } .calculator-row .calculator-button.num:active { background-color: #313131; } .calculator-sizes { display: flex; } .calculator-size { /*display: inline; */ flex-grow: 1; /*margin-right: 6px;*/ } .calculator-expression-holder { height: 40px; margin-bottom: 20px; padding: 10px; text-align: right; /* background-color: #636363; border-radius: 5px; box-shadow: 0px 5px 10px #444444 inset; */ } .calculator-expression { font-size: 14px; height: 16px; margin-bottom: 4px; } .calculator-value { font-size: 30px; } .calculator-mode { background-color: #222222; cursor: pointer; color: eeeeee; padding: 6px; border-left: 4px solid #222222; } .calculator-mode:hover { background-color: #292929; } .calculator-mode-selected { border-left: 4px solid orange; } .calculator-buttons .btn { cursor: pointer; } .btn { box-shadow: 0px 5px 10px #222222; } .col-xs-1 { display: inline-block; } .btn:focus { outline: none; } .button-row div { width: 50px; height: 50px; text-align: center; line-height: 50px; margin: 5px; } .button-row .btn { width: 50px; height: 50px; background-color: #636363; } .button-row .btn:hover { background-color: #858585; color: white !important; } .button-orange { background-color: #FF8400 !important; } .button-orange:hover { background-color: #FFA647 !important; } .button-blue { background-color: #0099FF !important; } .button-blue:hover { background-color: #33ADFF !important; } .button-off { background-color: #454545 !important; } .calc-history-eq { color: #B0B0B0; cursor: pointer; } #container { width: 600px; background-color: #2E2E2E; height: 100%; border-radius: 10px; margin-top: 20px; } /* #standard-buttons { display: inline-block; } #advanced-buttons { display: inline-block; display: none; margin-left: -20px; } #toggle-advanced:hover { background-color: #858585 !important; } #toggle-advanced span { pointer-events: none; } #calc-history { float: right; width: 200px; height: 270px; background-color: #636363; border-radius: 5px; margin-top: 6px; padding: 10px; box-shadow: 0px 5px 10px #444444 inset; } #calc-history-box { width: 180px !important; height: 220px !important; resize: none; overflow: hidden; } #calc-history hr { margin-top: 5px; margin-bottom: 5px; } */ </style> <div style="padding: 4px" class="calculator" tabindex="0"> <div class="calculator-expression-holder"> <div class="calculator-expression"> </div> <div class="calculator-value"> </div> </div> <div class="calculator-sizes"> <div class="calculator-size"> <label class="rb-container">BYTE <input type="radio" class="calculator-size-byte" name="calculator-size" value="byte"> <span class="checkmark"></span> </label> </div> <div class="calculator-size"> <label class="rb-container">UNSIGNED BYTE <input type="radio" checked="checked" class="calculator-size-ubyte" name="calculator-size" value="ubyte"> <span class="checkmark"></span> </label> </div> <div class="calculator-size"> <label class="rb-container">WORD <input type="radio" class="calculator-size-word" name="calculator-size" value="word"> <span class="checkmark"></span> </label> </div> <div class="calculator-size"> <label class="rb-container">DWORD <input type="radio" class="calculator-size-dword" name="calculator-size" value="dword"> <span class="checkmark"></span> </label> </div> </div> <div class="calculator-modes"> <div class="calculator-mode calculator-mode-selected calculator-mode-dec" data-mode="dec"> <label>DEC</label> <span class="calculator-value-dec">0</span> </div> <div class="calculator-mode calculator-mode-hex" data-mode="hex"> <label>HEX</label> <span class="calculator-value-hex">0</span> </div> <div class="calculator-mode calculator-mode-bin" data-mode="bin"> <label>BIN</label> <span class="calculator-value-bin">0</span> </div> </div> <div class="calculator-buttons"> <div class="calculator-row"> <div class="calculator-button op" data-op="rol">ROL</div> <div class="calculator-button op" data-op="ror">ROR</div> <div class="calculator-button op" data-op="or">Or</div> <div class="calculator-button op" data-op="xor">Xor</div> <div class="calculator-button op" data-op="not">Not</div> <div class="calculator-button op" data-op="and">And</div> </div> <div class="calculator-row"> <div class="calculator-button op" data-op="lsh">Lsh</div> <div class="calculator-button op" data-op="rsh">Rsh</div> <div class="calculator-button op clear" data-op="clear">CE</div> <div class="calculator-button op" data-op="clear">C</div> <div class="calculator-button op delete" data-op="delete">DEL</div> <div class="calculator-button op" data-op="divide"></div> </div> <div class="calculator-row"> <div class="calculator-button num hex" data-op="num" data-value="A">A</div> <div class="calculator-button num hex" data-op="num" data-value="B">B</div> <div class="calculator-button num dec hex" data-op="num" data-value="7">7</div> <div class="calculator-button num dec hex" data-op="num" data-value="8">8</div> <div class="calculator-button num dec hex" data-op="num" data-value="9">9</div> <div class="calculator-button op" data-op="multiply">x</div> </div> <div class="calculator-row"> <div class="calculator-button num hex" data-op="num" data-value="C">C</div> <div class="calculator-button num hex" data-op="num" data-value="D">D</div> <div class="calculator-button num dec hex" data-op="num" data-value="4">4</div> <div class="calculator-button num dec hex" data-op="num" data-value="5">5</div> <div class="calculator-button num dec hex" data-op="num" data-value="6">6</div> <div class="calculator-button op" data-op="subtract">-</div> </div> <div class="calculator-row"> <div class="calculator-button num hex" data-op="num" data-value="E">E</div> <div class="calculator-button num hex" data-op="num" data-value="F">F</div> <div class="calculator-button num dec hex bin" data-op="num" data-value="1">1</div> <div class="calculator-button num dec hex" data-op="num" data-value="2">2</div> <div class="calculator-button num dec hex" data-op="num" data-value="3">3</div> <div class="calculator-button op" data-op="plus">+</div> </div> <div class="calculator-row"> <div class="calculator-button op" data-op="bracket-left">(</div> <div class="calculator-button op" data-op="bracket-right">)</div> <div class="calculator-button">&nbsp;</div> <div class="calculator-button num dec hex bin" data-op="num" data-value="0">0</div> <div class="calculator-button">&nbsp;</div> <div class="calculator-button op" data-op="equals">=</div> </div> </div> </div>';var g_lastUpdate=false;var g_deltaTime=0;var UI=function(e){if(UI.ids.hasOwnProperty(e)){return UI.ids[e]}else{throw"UI: Unknown component: "+e;return null}};UI.primaryComponent=null;UI.componentTypes={};UI.components={};UI.componentCount=0;UI.mouseInComponent=null;UI.mouseDownInComponent=null;UI.popup=null;UI.mouseX=0;UI.mouseY=0;UI.mouseIsDown=[false,false,false];UI.windows=[];UI.readyFunctions=[];UI.ids={};UI.isMobile=false;UI.statsEnabled=false;UI.isFullscreen=false;UI.onKeyDown=null;UI.onKeyUp=null;UI.onKeyPress=null;UI.onUpdate=null;UI.browserEditOperations=false;UI.canProcessKeyEvents=true;UI.canProcessMenuKeys=true;UI.devicePixelRatio=Math.floor(window.devicePixelRatio);if(isNaN(UI.devicePixelRatio)||UI.devicePixelRatio<1){UI.devicePixelRatio=1}UI.goFullscreen=function(){isFullscreen=true;var e=document.body;if(e.requestFullscreen){e.requestFullscreen()}else if(e.mozRequestFullScreen){e.mozRequestFullScreen()}else if(e.webkitRequestFullscreen){e.webkitRequestFullscreen()}else if(e.msRequestFullscreen){e.msRequestFullscreen()}};UI.getContextNoSmoothing=function(e){var t=e.getContext("2d");t.imageSmoothingEnabled=false;t.webkitImageSmoothingEnabled=false;t.mozImageSmoothingEnabled=false;t.msImageSmoothingEnabled=false;t.oImageSmoothingEnabled=false;return t};UI.mobileDebug=function(e){var t=$("#debugBox").val();t+="\n----\n"+e;$("#debugBox").val(t)};UI.isMobile={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)||navigator.userAgent.match(/WPDesktop/i)},any:function(){return UI.isMobile.Android()||UI.isMobile.BlackBerry()||UI.isMobile.iOS()||UI.isMobile.Opera()||UI.isMobile.Windows()}};UI.getID=function(){UI.componentCount++;return"ui"+UI.componentCount};UI.on=function(e,t){e=e.toLowerCase();if(e=="ready"){if(UI.ready){t()}else{UI.readyFunctions.push(t)}}switch(e){case"keydown":UI.onKeyDown=t;break;case"keyup":UI.onKeyUp=t;break;case"keypress":UI.onKeyPress=t;break;case"update":UI.onUpdate=t;break;case"focus":UI.onFocus=t;break;case"blur":UI.onBlur=t;break}};UI.setStatsEnabled=function(e){UI.statsEnabled=e;if(e){$("#Stats-output").show()}else{$("#Stats-output").hide()}};UI.getStatsEnabled=function(){return UI.statsEnabled};var browserState=[];UI.browserPushState=function(e,t,i){};UI.browserPopState=function(e){};UI.browserOnPopState=function(e){};UI.get=function(e){if(UI.ids.hasOwnProperty(e)){return UI.ids[e]}else{return null}};UI.exists=function(e){return UI.ids.hasOwnProperty(e)};UI.registerComponentType=function(e,t){this.componentTypes[e]=t};UI.removeID=function(e){if(UI.ids.hasOwnProperty(e)){UI.ids[e]=null}};UI.create=function(e,t){if(!t){t=new Object}var i=null;if(this.componentTypes.hasOwnProperty(e)){i=new this.componentTypes[e](t);i.id=UI.getID();i.ui_type=e;UI.components[i.id]=i;i.uiID=null;if(typeof t.id!=="undefined"){if(UI.ids.hasOwnProperty(t.id)&&UI.ids[t.id]!=null){alert("UI: You have multiple components with id: "+t.id)}UI.ids[t.id]=i;i.uiID=t.id}if(typeof i.setVisible=="undefined"){i.setVisible=function(e){if(e==true){$("#"+this.id).show()}else{$("#"+this.id).hide()}}}if(typeof i.getVisible=="undefined"){i.getVisible=function(){return $("#"+this.id).css("display")!="none"}}i.uiEvents=Object();if(typeof i.on=="undefined"){i.on=function(e,t){this["uievent_"+e]=t}}if(typeof i.off=="undefined"){i.off=function(e){this["uievent_"+e]=null}}if(typeof i.trigger=="undefined"){i.trigger=function(e,t,i,r,a,s,o,l,n,h,d){if(this.hasOwnProperty("uievent_"+e)){return this["uievent_"+e](t,i,r,a,s,o,l,n,h,d)}}}if(typeof i.getOffset=="undefined"){i.getOffset=function(){return $("#"+this.id).offset()}}if(i.init){i.init(t)}}else{alert("UI: Unknown type: '"+e+"'")}return i};UI.add=function(e){UI.primaryComponent=e};UI.addWindow=function(e){UI.windows.push(e)};UI.showPopup=function(e,t,i){var r=UI.mouseX;var a=UI.mouseY;if(typeof t!="undefined"){r=t}if(typeof i!="undefined"){a=i}UI.saveComponent=UI.mouseInComponent;var s=UI(e);s.show(r,a);UI.popup=s;UI.capturedMouseComponent=s};UI.hidePopup=function(e){if(typeof e=="undefined"){e=UI.popup}if(typeof e=="undefined"){e=UI.capturedMouseComponent}if(e!=null){e.hide()}UI.popup=null;UI.capturedMouseComponent=null;UI.mouseDownInComponent=null;UI.mouseInComponent=null};UI.dialogStack=[];UI.showDialog=function(e){if(typeof e=="string"){e=UI.get(e)}UI.dialogStack.push(e);e.show();UI.mouseInComponent=e;UI.canProcessMenuKeys=false};UI.closeDialog=function(e){if(UI.dialogStack.length==0){return}if(typeof e=="undefined"){e=UI.dialogStack[UI.dialogStack.length-1]}if(typeof e=="string"){e=UI.get(e)}UI.dialogStack.splice(UI.dialogStack.length-1,1);UI.mouseDownInComponent=null;UI.mouseInComponent=null;if(UI.dialogStack.length==0){UI.canProcessMenuKeys=true}e.close()};UI.closeAllDialogs=function(){var e=0;while(UI.dialogStack.length>0){e++;if(e>100){break}UI.closeDialog()}};UI.runReadyFunctions=function(){for(var e=0;e<UI.readyFunctions.length;e++){UI.readyFunctions[e]()}UI.readyFunctions=new Array};UI.setAllowBrowserEditOperations=function(e){UI.browserEditOperations=e};UI.getMouseIsCaptured=function(){return UI.capturedMouseComponent!=null};UI.captureMouse=function(e,t){var i=UI.currentCursorDefinition;if(typeof t!="undefined"){if(typeof t.cursor!="undefined"){i=t.cursor}}if(document.all){document.onselectstart=function(){return false}}$("#ui").append('<div id="uimousecapture" style=" position: absolute; top: 0; left: 0; bottom: 0; right: 0; z-index: 10000; cursor: '+i+'"></div>');UI.capturedMouseComponent=e;function r(e){if(UI.capturedMouseComponent!=null&&typeof UI.capturedMouseComponent.mouseDown!="undefined"){UI.capturedMouseComponent.mouseDown(e)}}function a(e){if(UI.capturedMouseComponent!=null&&typeof UI.capturedMouseComponent.mouseMove!="undefined"){UI.capturedMouseComponent.mouseMove(e)}}function s(e){var t=UI.capturedMouseComponent;UI.releaseMouse();window.removeEventListener("mousedown",r,{capture:true,passive:false});window.removeEventListener("mousemove",a,{capture:true,passive:false});window.removeEventListener("mouseup",s,{capture:true,passive:false});if(t!=null&&typeof t.mouseUp!="undefined"){t.mouseUp(e)}}window.addEventListener("mousedown",r,{capture:true,passive:false});window.addEventListener("mousemove",a,{capture:true,passive:false});window.addEventListener("mouseup",s,{capture:true,passive:false})};UI.releaseMouse=function(){$("#uimousecapture").remove();UI.capturedMouseComponent=null;if(document.all){document.onselectstart=null}};var SHADOW_MAP_WIDTH=2048,SHADOW_MAP_HEIGHT=1024;var scene=null;UI.setWebGLEnabled=function(e){UI.webGLEnabled=e;if(!e){$("#WebGL-output").hide()}else{$("#WebGL-output").show()}};UI.init3d=function(){UI.renderer=new THREE.WebGLRenderer({antialias:true});UI.renderer.setSize(window.innerWidth,window.innerHeight);UI.renderer.shadowMap.enabled=false;UI.renderer.shadowMap.type=THREE.PCFShadowMap;$("#WebGL-output").append(UI.renderer.domElement);UI.stats=new Stats;UI.stats.setMode(0);UI.stats.domElement.style.position="absolute";UI.stats.domElement.style.right="0px";UI.stats.domElement.style.top="0px";$("#Stats-output").append(UI.stats.domElement);return;scene=new THREE.Scene;var e=new THREE.BoxGeometry(1,1,1);var t=new THREE.MeshBasicMaterial({color:65280});var i=new THREE.Mesh(e,t);scene.add(i);$("#WebGL-output").append(UI.renderer.domElement);var r=new THREE.DirectionalLight(657930,1);r.position.set(-800,400,-1500);r.target.position.set(0,0,0);r.castShadow=false;r.shadow=new THREE.LightShadow(new THREE.PerspectiveCamera(50,1,1200,2500));r.shadow.bias=-7e-5;r.shadow.mapSize.width=SHADOW_MAP_WIDTH*2;r.shadow.mapSize.height=SHADOW_MAP_HEIGHT*2;r.shadow.camera.zoom=12;scene.add(r);var r=new THREE.AmbientLight(5592405);scene.add(r);var r=new THREE.DirectionalLight(16777215,1);r.position.set(1e3,1e3,1500);r.target.position.set(0,0,0);r.castShadow=false;r.shadow=new THREE.LightShadow(new THREE.PerspectiveCamera(50,1,1200,2500));r.shadow.bias=-7e-5;r.shadow.mapSize.width=SHADOW_MAP_WIDTH*2;r.shadow.mapSize.height=SHADOW_MAP_HEIGHT*2;r.shadow.camera.zoom=12;scene.add(r);var a=[];a[0]=new THREE.PointLight(16777215,1,0);a[1]=new THREE.PointLight(16777215,.8,0);a[2]=new THREE.PointLight(16777215,1,0);a[0].position.set(0,200,0);a[1].position.set(100,200,100);a[2].position.set(-100,-200,-100);UI.setWebGLEnabled(true)};UI.webGLComponents=[];UI.canvasComponents=[];UI.menuComponents=[];UI.canvasRender=function(){if(UI.dialogStack.length>0){return}for(var e=0;e<UI.canvasComponents.length;e++){UI.canvasComponents[e].render()}};UI.webGLRender=function(){if(UI.dialogStack.length>0){return}if(UI.webGLEnabled===false){return}for(var e=0;e<UI.webGLComponents.length;e++){UI.webGLComponents[e].render()}};UI.getScreenWidth=function(){return $(window).width()};UI.getScreenHeight=function(){return $(window).height()};UI.blur=function(e){if(this.onBlur){this.onBlur(e)}};UI.focus=function(e){if(this.onFocus){this.onFocus(e)}};UI.resize=function(){if(UI.vrMode){UI.vrEditor.resize();return}SCREEN_WIDTH=window.innerWidth;SCREEN_HEIGHT=window.innerHeight;if(SCREEN_WIDTH%2){SCREEN_WIDTH-=1}if(SCREEN_HEIGHT%2){SCREEN_HEIGHT-=1}UI.renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT);if(UI.primaryComponent&&typeof UI.primaryComponent.resize!="undefined"){UI.primaryComponent.resize()}};UI.contextMenu=function(e){if(UI.mouseInComponent&&typeof UI.mouseInComponent.contextMenu!="undefined"){UI.mouseInComponent.contextMenu(e)}else{if(!UI.mouseInComponent){e.preventDefault()}else{}}};UI.doubleClick=function(e){if(UI.mouseInComponent){if(typeof UI.mouseInComponent.doubleClick!="undefined"){UI.mouseInComponent.doubleClick(e)}UI.mouseDownInComponent=UI.mouseInComponent}};UI.composedPath=function(e){var t=[];while(e){t.push(e);if(e.tagName==="HTML"){t.push(document);t.push(window);return t}e=e.parentElement}};UI.elementToComponent=function(e){var t=UI.composedPath(e);if(t){for(var i=0;i<t.length;i++){var r=t[i].id;if(UI.components.hasOwnProperty(r)){var a=UI.components[r];if(a){return a}}}}return null};UI.findMouseInComponent=function(e){var t=e.path||e.composedPath&&e.composedPath()||UI.composedPath(e.target);if(t){for(var i=0;i<t.length;i++){var r=t[i].id;if(UI.components.hasOwnProperty(r)){var a=UI.components[r];UI.mouseInComponent=a;break}}}},UI.keyDown=function(e){if(true){var t=e.keyCode;if(t==9){}var i=String.fromCharCode(t).toLowerCase();var r=e.metaKey;var a=e.ctrlKey;var s=e.shiftKey;if((r||a)&&(i=="c"||i=="x"||i=="z"||i=="v"||i=="a")){if(UI.browserEditOperations){return}}if(UI.canProcessMenuKeys){for(var o=0;o<this.menuComponents.length;o++){if(this.menuComponents[o].keyDown(e)){e.preventDefault();return}}}if(UI.popup!==null){UI.popup.trigger("keydown",e);return}if(UI.dialogStack.length>0){UI.dialogStack[UI.dialogStack.length-1].trigger("keydown",e);return}}if(typeof UI.onKeyDown!="undefined"&&UI.onKeyDown!==null){return UI.onKeyDown(e)}return false};UI.keyUp=function(e){if(true){var t=e.keyCode;if(t==9){}if(UI.canProcessMenuKeys){for(var i=0;i<this.menuComponents.length;i++){if(this.menuComponents[i].keyUp(e)){e.preventDefault();return}}}if(UI.popup!==null){UI.popup.trigger("keyup",e);return}if(UI.dialogStack.length>0){UI.dialogStack[UI.dialogStack.length-1].trigger("keyup",e);return}}if(UI.onKeyUp){return UI.onKeyUp(e)}return false};UI.keyPress=function(e){if(true){if(UI.canProcessKeyEvents){for(var t=0;t<this.menuComponents.length;t++){if(this.menuComponents[t].keyPress(e)){e.preventDefault();return}}}if(UI.popup!==null){UI.popup.trigger("keypress",e)}if(UI.dialogStack.length>0){UI.dialogStack[UI.dialogStack.length-1].trigger("keypress",e);return}}if(UI.onKeyPress){return UI.onKeyPress(e)}return false};UI.cut=function(e){};UI.copy=function(e){};UI.paste=function(e){};UI.setOperatingSystem=function(){var e=window.navigator.userAgent,t=window.navigator.platform,i=["Macintosh","MacIntel","MacPPC","Mac68K"],r=["Win32","Win64","Windows","WinCE"],a=["iPhone","iPad","iPod"],s=null;if(i.indexOf(t)!==-1){s="Mac OS"}else if(a.indexOf(t)!==-1){s="iOS"}else if(r.indexOf(t)!==-1){s="Windows"}else if(/Android/.test(e)){s="Android"}else if(!s&&/Linux/.test(t)){s="Linux"}UI.os=s};UI.setOperatingSystem();UI.loadScript=function(e,t){var i="script";var r=e.replace("/","-");var a,s=document.getElementsByTagName(i);s=s[s.length-1];if(document.getElementById(r)){if(t){t()}return}a=document.createElement(i);a.id=r;a.onload=function(){if(t){t()}};a.src=e;s.parentNode.insertBefore(a,s)};UI.requireScripts=function(e,t){var i=e.length;var r=0;for(var a=0;a<e.length;a++){UI.loadScript(e[a],function(){r++;if(i==r&&t){t()}})}};UI.getCursor=function(){return UI.currentCursor};UI.setCursor=function(e){if(UI.isMobile.any()){return}if(e!=UI.currentCursor){UI.currentCursor=e;UI.currentCursorDefinition=e;var t=e;switch(e){case"not-allowed":t="not-allowed";break;case"draw":t="none";t="url(cursors/pencil.png) 0 23, pointer";t="url(cursors/penciloutline.png) 0 15, pointer";break;case"erase":t="url(cursors/eraser.png) 2 14, pointer";break;case"text":t="text";break;case"zoom":t="url(cursors/zoom.png) 2 14, pointer";break;case"can-move":t="url(cursors/move.png) 2 2, pointer";break;case"move":t="url(cursors/move.png) 2 2, pointer";break;case"can-drag-scroll":t="url(cursors/openhand.png) 2 14, pointer";break;case"drag-scroll":t="url(cursors/closedhand.png) 2 14, pointer";break;case"can-drag":t="url(cursors/openhand.png) 2 14, pointer";break;case"drag":t="url(cursors/closedhand.png) 2 14, pointer";break;case"can-drag-selection-outline":t="url(cursors/openhand.png) 2 14, pointer";break;case"drag-selection-outline":t="url(cursors/closedhand.png) 2 14, pointer";break;case"fill":t="url(cursors/fill16.png) 17 14, pointer";break;case"eyedropper":t="url(cursors/eyedropper.png) 2 20, pointer";break;case"crosshair":t="crosshair";break;case"pixel":t="url(cursors/pixel2.png) 1 20, pointer";break;case"box-select":t="crosshair";break;case"e-resize":t="e-resize";break;case"w-resize":t="w-resize";break;case"ew-resize":t="ew-resize";break;case"default":t="default";break}UI.currentCursorDefinition=t;$("#WebGL-output").css("cursor",t);$("#WebGL-output canvas").css("cursor",t);$("#uimousecapture").css("cursor",t);$(".ui-webgl-panel").css("cursor",t);$("body canvas").css("cursor",t)}};UI.initEvents=function(){window.addEventListener("resize",function(){UI.resize()},false);window.addEventListener("popstate",function(e){UI.browserOnPopState(e)},false);window.addEventListener("focus",function(e){UI.focus(e)},false);window.addEventListener("blur",function(e){UI.blur(e)},false);document.addEventListener("keydown",function(e){UI.keyDown(e)},false);document.addEventListener("keyup",function(e){UI.keyUp(e)},false);document.addEventListener("keypress",function(e){UI.keyPress(e)},false);document.addEventListener("undo",function(e){alert("undo")});document.addEventListener("cut",function(e){UI.cut()});document.addEventListener("copy",function(e){UI.copy()});document.addEventListener("paste",function(e){UI.paste()})};$(document).ready(function(){UI.ready=true;var e="";e+='<div id="ui-menu-background" style="display: none; position: absolute; top: 30px; left: 0; right: 0; bottom: 0; background-color: black; z-index: 300; opacity: 0;"></div>';e+='<div id="Stats-output" style="display: none; position: absolute; top: 0; right: 0; z-index: 10000"></div><div id="WebGL-output"></div><div id="ui" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; overflow: visible" ></div>';e+='<textarea id="debugBox" style="display: none; position: absolute; width: 100%; bottom: 0; left: 0; right: 0; height: 400px; z-index: 4000"></textarea>';$("body").html(e);UI.init3d();UI.initEvents();if(UI.primaryComponent!=null){var e=UI.primaryComponent.getHTML();for(var t=0;t<UI.windows.length;t++){e+=UI.windows[t].getHTML()}$("#ui").html(e);UI.number=new UINumber;UI.number.init();UI.slider=new UISlider;UI.slider.init();$(document).keyup(function(e){if(e.which==27){if(g_dialogStack.length>0){}}});$(".ui-mouseevents").on("mouseenter",function(e){if(UI.mouseDownInComponent){return}var t=$(this).attr("id");if(UI.components.hasOwnProperty(t)){var i=UI.components[t];UI.mouseInComponent=i;if(typeof i.mouseEnter!=="undefined"){i.mouseEnter(e)}}});$(".ui-mouseevents").on("mouseleave",function(e){if(UI.mouseDownInComponent){return}var t=$(this).attr("id");if(UI.components.hasOwnProperty(t)){var i=UI.components[t];UI.mouseInComponent=null;if(typeof i.mouseLeave!=="undefined"){i.mouseLeave(e)}}});UI.runReadyFunctions();UI.vrMode=false;var i=false;function r(e){if(i===false){i=e}g_deltaTime=e-g_lastUpdate;g_lastUpdate=e;if(UI.statsEnabled){UI.stats.update()}TWEEN.update();if(UI.vrMode){UI.vrEditor.vrEffect.requestAnimationFrame(r)}else{requestAnimationFrame(r)}if(UI.onUpdate!==null){UI.onUpdate()}UI.webGLRender()}r(0)}});if(window.performance&&window.performance.now){getTimestamp=function(){return window.performance.now()}}else{if(window.performance&&window.performance.webkitNow){getTimestamp=function(){return window.performance.webkitNow()}}else{getTimestamp=function(){return(new Date).getTime()}}}function clearInputFile(e){if(e.value){try{e.value=""}catch(e){}if(e.value){var t=document.createElement("form"),i=e.parentNode,r=e.nextSibling;t.appendChild(e);t.reset();i.insertBefore(e,r)}}}(function(e){e.forEach(function(e){if(e.hasOwnProperty("append")){return}Object.defineProperty(e,"append",{configurable:true,enumerable:true,writable:true,value:function e(){var t=Array.prototype.slice.call(arguments),i=document.createDocumentFragment();t.forEach(function(e){var t=e instanceof Node;i.appendChild(t?e:document.createTextNode(String(e)))});this.appendChild(i)}})})})([Element.prototype,Document.prototype,DocumentFragment.prototype]);var UINumber=function(){this.mouseDownAtX=0;this.mouseDownAtY=0;this.focussedControl=null;this.initialValue=0;this.min=-9999999;this.max=-9999999};UINumber.prototype={initControls:function(e){var r=this;$(e).css("cursor","ew-resize");$(e).on("mousedown",function(e){e.preventDefault();r.mouseDownAtX=e.pageX;r.mouseDownAtY=e.pageY;$(this).blur();r.focussedControl=$(this);r.initialValue=parseInt($(this).val());r.min=false;var t=$(this).attr("min");if(typeof t!="undefined"){r.min=parseInt(t)}r.max=false;var i=$(this).attr("max");if(typeof i!="undefined"){r.max=parseInt(i)}UI.captureMouse(r,{cursor:"ew-resize"})});$(e).keypress(function(e){if(!e.which){return}var t=[8,9,13,35,36,37,39];var i=t.join(",").match(new RegExp(e.which));if(e.which==45||48<=e.which&&e.which<=57||48==e.which&&$(this).attr("value")||i){return}else{e.preventDefault()}});$(e).on("blur",function(){var e=parseInt($(this).val());var t=$(this).attr("min");if(typeof t!="undefined"&&e<t){$(this).val(t);return}var i=$(this).attr("max");if(typeof i!="undefined"&&e>i){$(this).val(i);return}})},init:function(){this.initControls(".number")},mouseMove:function(e){var t=e.pageX;var i=e.pageY;var r=t-this.mouseDownAtX;var a=this.mouseDownAtY-i;if(this.focussedControl){var s=this.initialValue+Math.floor((r+a)/4);if(this.min!==false&&s<this.min){s=this.min}if(this.max!==false&&s>this.max){s=this.max}this.focussedControl.val(s);this.focussedControl.trigger("change");this.focussedControl.trigger("keyup");e.preventDefault();return true}return false},mouseUp:function(e){if(this.focussedControl){if(e.pageX==this.mouseDownAtX&&e.pageY==this.mouseDownAtY){this.focussedControl.focus();this.focussedControl.select()}this.focussedControl=null;e.preventDefault();return true}return false}};var UISlider=function(){this.mouseDownAtX=0;this.mouseDownAtY=0;this.focussedControl=null;this.initialValue=0;this.thumbWidth=20;this.min=-9999999;this.max=-9999999};UISlider.prototype={initEvents:function(){},getHTML:function(e){var t="";t+='<div class="ui-slider" data-id="'+e+'">';t+='  <div class="ui-slider-track">';t+='  <div class="ui-slider-thumb" data-id="'+e+'"></div>';t+="</div>";return t},initControls:function(e){var o=this;$(e+" .slider").each(function(){console.log("insert html");var e=$(this).attr("id");var t=o.getHTML(e);$(t).insertAfter(this)});$(e+" .ui-slider-thumb").css("cursor","pointer");$(e+" .ui-slider-thumb").on("mousedown",function(e){console.log("thumb down");e.preventDefault();o.mouseDownAtX=e.pageX;o.mouseDownAtY=e.pageY;o.focussedControl=$(this);var t=$(this).parent();o.trackWidth=t.width();console.log("track width = "+o.trackWidth);var i=$(this).attr("data-id");o.sliderId=i;console.log("id = "+i);var r=$(this).position();o.mouseDownLeft=r.left;o.min=false;var a=$("#"+i).attr("min");if(typeof a!="undefined"){o.min=parseInt(a)}o.max=false;var s=$("#"+i).attr("max");if(typeof s!="undefined"){o.max=parseInt(s)}console.log("range = "+a+","+s);UI.captureMouse(o,{cursor:"ew-resize"})})},init:function(){this.initControls("html")},mouseMove:function(e){var t=e.pageX;var i=e.pageY;var r=t-this.mouseDownAtX;var a=this.mouseDownAtY-i;if(this.focussedControl){console.log("mouse move");var s=this.mouseDownLeft+r;if(s<-this.thumbWidth/2){s=-this.thumbWidth/2}if(s>this.trackWidth-this.thumbWidth/2){s=this.trackWidth-this.thumbWidth/2}this.focussedControl.css("left",s+"px");var o=(s+this.thumbWidth/2)/this.trackWidth;console.log("percent = "+o);var l=this.min+Math.round((this.max-this.min)*o);console.log("valkue = "+l);$("#"+this.sliderId).val(l);e.preventDefault();return true}return false},mouseUp:function(e){if(this.focussedControl){console.log("mouse up");this.focussedControl=null;e.preventDefault();return true}return false}};UI.MenuItem=function(){this.init=function(e){this.id=UI.getID();this.enabled=true;this.visible=true;this.menuBar=false;if(typeof e.menuBar!=="undefined"){this.menuBar=e.menuBar}this.menu=false;if(typeof e.menu!=="undefined"){this.menu=e.menu}if(typeof e.label==="undefined"){this.label=""}else{this.label=e.label}this.visible=true;if(typeof e.visible!="undefined"){this.visible=e.visible;if(!this.visible){this.style+=";display: none"}}if(typeof e.type==="undefined"){this.type="item"}else{this.type=e.type}if(typeof e.checked!=="undefined"){this.checked=e.checked}else{this.checked=false}if(typeof e.shortcut==="undefined"){this.shortcut=false}else{this.shortcut=e.shortcut;if(typeof this.shortcut.cmd=="undefined"){this.shortcut.cmd=false}if(typeof this.shortcut.shift=="undefined"){this.shortcut.shift=false}if(typeof this.shortcut.ctrl=="undefined"){this.shortcut.ctrl=false}if(typeof this.shortcut.alt=="undefined"){this.shortcut.alt=false}if(UI.os!=="Mac OS"&&this.shortcut.cmd){this.shortcut.cmd=false;this.shortcut.ctrl=true}if(this.shortcut.key!="undefined"){if(this.shortcut.key.length==1){this.shortcut.keyLowerCase=this.shortcut.key.toLowerCase();this.shortcut.charCode=this.shortcut.key.toLowerCase().charCodeAt(0)}}if(this.menuBar){this.menuBar.addShortcut(this.shortcut,this)}}};this.getShortcutHTML=function(){var e="";if(this.shortcut!==false){var e="";var t=this.shortcut;if(typeof t.ctrl!=="undefined"&&t.ctrl===true){e+="Ctrl"}if(typeof t.cmd!=="undefined"&&t.cmd===true){if(UI.os=="Mac OS"){e+="Cmd"}else{e+="Ctrl"}}if(typeof t.alt!=="undefined"&&t.alt===true){if(e!=""){e+="+"}e+="Alt"}if(typeof t.shift!=="undefined"&&t.shift===true){if(e!=""){e+="+"}e+="Shift"}if(typeof t.key!=="undefined"){if(e!=""){e+="+"}e+=t.key}}return e};this.setVisible=function(e){this.visible=e;if(this.visible){$("#"+this.id).show()}else{$("#"+this.id).hide()}};this.setChecked=function(e){this.checked=e;if(this.checked){$("#"+this.id+"-checkmark").html('<div class="ui-menu-item-checkmark"></div>')}else{$("#"+this.id+"-checkmark").html("")}};this.getChecked=function(){return this.checked};this.setEnabled=function(e){this.enabled=e;if(e){$("#"+this.id).addClass("ui-menu-item");$("#"+this.id).removeClass("ui-menu-item-disabled")}else{$("#"+this.id).addClass("ui-menu-item-disabled");$("#"+this.id).removeClass("ui-menu-item")}};this.setLabel=function(e){$("#"+this.id+" .ui-menu-item-label").html(e)};this.getElement=function(){var e=document.createElement("div");e.setAttribute("id",this.id);e.setAttribute("style","clear: both");if(!this.visible){e.setAttribute("style","display: none;")}var t="";if(this.type=="separator"){e.setAttribute("class","ui-menu-item-separator");t=this.label}else{e.setAttribute("class","ui-menu-item");t+='<div style="display: inline-block; width: 14px" id="'+this.id+'-checkmark">';if(this.checked){t+='<div class="ui-menu-item-checkmark"></div>'}t+="</div>";t+='<div class="ui-menu-item-label ui-text" data-textid="'+this.label+'">'+this.label+"</div>";var i=this.getShortcutHTML();t+='<div class="ui-menu-item-shortcut">';if(i!=""){t+="&nbsp;&nbsp;&nbsp;&nbsp;"+i}t+="</div>"}e.innerHTML=t;var r=this;e.onclick=function(e){var t=e.target;r.click(e)};return e};this.click=function(e){if(this.menuBar!==false){this.menuBar.hideMenu()}if(this.enabled){this.menuBar.trigger("itemclick",this.uiID);this.trigger("click",this.uiID);if(this.menu!==false){this.menu.flash()}}}};UI.registerComponentType("UI.MenuItem",UI.MenuItem);UI.Menu=function(){this.menuItems=[];this.element=null;this.addItem=function(e){e.menuBar=this.menuBar;e.menu=this;var t=UI.create("UI.MenuItem",e);this.menuItems.push(t);if(UI.ready){var i=this.getElement();i.append(t.getElement())}return t};this.getItem=function(e){for(var t=0;t<this.menuItems.length;t++){if(this.menuItems[t].uiID==e){return this.menuItems[t]}}return null};this.hasItem=function(e){for(var t=0;t<this.menuItems.length;t++){if(this.menuItems.uiID==e){return true}}return false};this.removeItem=function(e){};this.getItems=function(e){return this.menuItems};this.flash=function(){$("#"+this.menuBarItemId).addClass("ui-menubar-item-hover");var e=this;setTimeout(function(){$("#"+e.menuBarItemId).removeClass("ui-menubar-item-hover")},120)};this.addSeparator=function(e){e.menuBar=this.menuBar;e.type="separator";var t=UI.create("UI.MenuItem",e);this.menuItems.push(t);if(UI.ready){var i=this.getElement();i.append(t.getElement())}return t};this.getElement=function(){if(this.element==null){this.element=document.createElement("div");this.element.setAttribute("id",this.id);this.element.setAttribute("class","ui-menu")}return this.element};this.getHTML=function(){var e="";e+='<div class="ui-menu" id="ui-menu-'+this.id+'">';for(var t=0;t<this.menuItems.length;t++){switch(this.menuItems[t].type){case"item":e+='<div class="ui-menu-item" id="ui-menu-item-'+this.menuItems[t].id+'">'+this.menuItems[t].label;if(this.menuItems[t].shortcut!==false){var i="";var r=this.menuItems[t].shortcut;if(typeof r.ctrl!=="undefined"&&r.ctrl===true){i+="Ctrl"}if(typeof r.cmd!=="undefined"&&r.cmd===true){if(UI.os=="Mac OS"){i+="Cmd"}else{i+="Ctrl"}}if(typeof r.shift!=="undefined"&&r.shift===true){if(i!=""){i+="+"}i+="Shift"}if(typeof r.key!=="undefined"){if(i!=""){i+="+"}i+=r.key}e+="&nbsp;&nbsp;"+i}e+="</div>";break;case"separator":e+='<div class="ui-menu-item-separator" id="'+this.menuItems[t].id+'">'+this.menuItems[t].label+"</div>";break}}e+="</div>";return e}};UI.MenuBar=function(){this.menus=[];this.shortcuts=[];this.menuShownId=false;this.menuBarItemShownId=false;this.element=null;this.init=function(e){UI.menuComponents.push(this);this.visible=true;if(typeof e.visible!="undefined"){this.visible=e.visible;if(!this.visible){this.style+=";display: none"}}};this.addShortcut=function(e,t){this.shortcuts.push({shortcut:e,menuItem:t,enabled:true})};this.setShortcutEnabled=function(e,t){if(typeof e.cmd=="undefined"){e.cmd=false}if(typeof e.shift=="undefined"){e.shift=false}if(typeof e.ctrl=="undefined"){e.ctrl=false}if(UI.os!=="Mac OS"&&e.cmd){e.cmd=false;e.ctrl=true}for(var i=0;i<this.shortcuts.length;i++){if(this.shortcuts[i].shortcut.key==e.key&&this.shortcuts[i].shortcut.shift==e.shift&&this.shortcuts[i].shortcut.cmd==e.cmd&&this.shortcuts[i].shortcut.ctrl==e.ctrl){this.shortcuts[i].enabled=t}}};this.addMenu=function(e){var t=new UI.Menu;t.id=UI.getID();t.menuBarItemId=UI.getID();t.label=e.label;t.menuBar=this;this.menus.push(t);if(UI.ready){var i=this.getElement();var r=document.createElement("div");r.setAttribute("id",t.menuBarItemId);var a="ui-menubar-item ui-text";if(typeof e.className){a+=" "+e.className}r.setAttribute("class",a);r.setAttribute("data-textid",t.label);r.innerHTML=t.label;i.append(r);var s=this;r.onclick=function(e){var t=e.target;s.showMenu(t.id)};r.onmouseover=function(e){var t=e.target;if(s.menuBarItemShownId!==false&&s.menuBarItemShownId!==t.id){s.showMenu(t.id)}};var o=t.getElement();document.body.append(o)}return t};this.showOnly=function(e){$("#"+this.id+" .ui-menubar-item").hide();$("#"+this.id+" ."+e).show()};this.getElement=function(){if(this.element==null){this.element=document.createElement("div");this.element.setAttribute("id",this.id);this.element.setAttribute("class","ui-menubar-panel ui-mouseevents");if(!this.visible){this.element.setAttribute("style","display: none;")}this.homeLink=document.createElement("a");this.homeLink.setAttribute("href","/");this.element.append(this.homeLink);this.logo=document.createElement("img");this.logo.setAttribute("src","images/logo16t.png");this.logo.setAttribute("height","16");this.logo.setAttribute("style","padding: 3px 3px 3px 5px");this.logo.setAttribute("class","ui-menu-icon");this.homeLink.append(this.logo)}return this.element};this.getHTML=function(){var e="";e+='<div class="ui-menubar" style="';if(!this.visible){e+=" display: none; "}e+='" id="'+this.id+'">';for(var t=0;t<this.menus.length;t++){e+='<div class="ui-menubar-item" id="ui-menubar-item-'+this.menus[t].id+'">'+this.menus[t].label;e+="</div>"}e+="</div>";var i="";for(var t=0;t<this.menus.length;t++){i+=this.menus[t].getHTML()}$("body").append(i);var r=this;UI.on("ready",function(){r.initEvents()});return e};this.keyDown=function(e){var t=e.keyCode;var i=String.fromCharCode(t);if(t==93){i=""}i=i.toLowerCase();if(t==189){i="-"}if(t==187){i="="}if(t==109){i="-"}if(t==173){i="-"}if(t==219){i="["}if(t==221){i="]"}if(t==220){i="\\"}if(t==91){i=""}var r=e.metaKey;var a=e.ctrlKey;var s=e.shiftKey;var o=e.altKey;for(var l=0;l<this.shortcuts.length;l++){if(this.shortcuts[l].enabled&&i==this.shortcuts[l].shortcut.keyLowerCase){if(this.shortcuts[l].shortcut.cmd==r&&this.shortcuts[l].shortcut.shift==s&&this.shortcuts[l].shortcut.ctrl==a&&this.shortcuts[l].shortcut.alt==o){this.shortcuts[l].menuItem.click();e.preventDefault();return true}}}return false};this.keyUp=function(e){var t=e.keyCode;var i=String.fromCharCode(t).toLowerCase();if(t==189){i="-"}if(t==109){i="-"}if(t==173){i="-"}if(t==187){i="="}var r=e.metaKey;var a=e.ctrlKey;var s=e.shiftKey;var o=e.altKey;for(var l=0;l<this.shortcuts.length;l++){if(this.shortcuts[l].enabled&&i==this.shortcuts[l].shortcut.keyLowerCase){if(this.shortcuts[l].shortcut.cmd==r&&this.shortcuts[l].shortcut.shift==s&&this.shortcuts[l].shortcut.ctrl==a&&this.shortcuts[l].shortcut.alt==o){e.preventDefault();return true}}}return false};this.keyPress=function(e){return this.keyUp(e)};this.hideMenu=function(){if(this.menuBarItemShownId!==false){$("#"+this.menuBarItemShownId).removeClass("ui-menubar-item-selected")}if(this.menuShownId!==false){$("#"+this.menuShownId).fadeOut(20)}$("#ui-menu-background").hide();this.menuBarItemShownId=false;this.menuShownId=false};this.showMenu=function(e){var t=false;var i="";for(var r=0;r<this.menus.length;r++){if(this.menus[r].menuBarItemId==e){t=r;i=this.menus[r].id}}if(t===false){return}this.hideMenu();this.menuBarItemShownId=e;this.menuShownId=i;$("#ui-menu-background").show();var a=this;var s=document.getElementById("ui-menu-background");s.onclick=function(){a.hideMenu()};var o=$("#"+e).offset();var l={};l.left=o.left;l.top=o.top+25;$("#"+e).addClass("ui-menubar-item-selected");$("#"+i).css("top",l.top+"px");$("#"+i).css("left",l.left+"px");$("#"+i).fadeIn(20)};this.initMenuBarItemEvents=function(e){var t=this;$("#ui-menubar-item-"+e).on("click",function(){t.showMenu(e)});$("#ui-menubar-item-"+e).on("mouseover",function(){if(t.menuShownId!==""&&t.menuShownId!==e){t.showMenu(e)}})};this.menuClick=function(e){};this.initEvents=function(){var t=this;for(var e=0;e<this.menus.length;e++){var i=this.menus[e].id;this.initMenuBarItemEvents(i)}$(".ui-menu-item").on("click",function(){t.hideMenu();var e=$(this).attr("id");t.menuClick(e)});$("#ui-menu-background").on("click",function(){t.hideMenu()})}};UI.registerComponentType("UI.MenuBar",UI.MenuBar);UI.Panel=function(){this.components=new Array;this.element=null;this.width=false;this.height=false;this.init=function(e){this.cssclass=null;if(e.cssclass){this.cssclass=e.cssclass}this.style=null;if(e.style){this.style=e.style}this.visible=true;if(typeof e.visible!="undefined"){this.visible=e.visible;if(!this.visible){this.style+=";display: none"}}};this.add=function(e){if(e){this.components.push(e);if(UI.ready){var t=document.getElementById(this.id);t.appendChild(e.getElement())}}};this.resize=function(){for(var e=0;e<this.components.length;e++){if(typeof this.components[e].resize!="undefined"){this.components[e].resize()}}this.trigger("resize")};this.showOnly=function(e){for(var t=0;t<this.components.length;t++){var i="";if(this.components[t].uiID){i=this.components[t].uiID}if(this.components[t].ui_type=="UI.Include"){i=this.components[t].component}if(i==e){UI(i).setVisible(true)}else{UI(i).setVisible(false)}}};this.getElement=function(){if(this.element==null){this.element=document.createElement("div");this.element.setAttribute("id",this.id);if(!this.visible){this.setAttribute("style","display: none;")}}return this.element};this.getHTML=function(){var e="";e+='<div id="'+this.id+'" ';if(this.cssclass!=null){e+=' class="'+this.cssclass+'" '}if(this.style!=null){e+=' style="'+this.style+'" '}e+="  >";for(var t=0;t<this.components.length;t++){if(this.components[t]){e+=this.components[t].getHTML()}}e+="</div>";return e};this.scrollTo=function(e){$("#"+this.id).scrollTop(e)}};UI.registerComponentType("UI.Panel",UI.Panel);UI.Popup=function(){this.components=new Array;this.backgroundElement=null;this.element=null;this.init=function(e){this.cssclass=null;if(e.cssclass){this.cssclass=e.cssclass}this.style=null;if(e.style){this.style=e.style}this.visible=true;if(typeof e.visible!="undefined"){this.visible=e.visible;if(!this.visible){this.style+=";display: none"}}this.backgroundElement=document.createElement("div");this.backgroundElement.setAttribute("id",this.id+"-background");this.backgroundElement.setAttribute("style","display: none;  position: absolute; top: 0; left: 0; bottom: 0; right: 0");var t=this;document.body.append(this.backgroundElement);this.backgroundElement.addEventListener("click",function(e){e.preventDefault();UI.hidePopup(t)},true);this.backgroundElement.addEventListener("contextmenu",function(e){e.preventDefault()},true);this.backgroundElement.addEventListener("mousewheel",function(e){e.preventDefault()},false);var i=100;if(typeof e.width!="undefined"){i=e.width}var r=100;if(typeof e.height!="undefined"){r=e.height}this.element=document.createElement("div");this.element.setAttribute("id",this.id);if(r===false||r=="auto"){this.element.setAttribute("style","display: none; position: absolute; top: 0; left: 0;  width: "+i+"px; ")}else{this.element.setAttribute("style","display: none; position: absolute; top: 0; left: 0;  width: "+i+"px; height: "+r+"px")}this.element.setAttribute("class","ui-popup");document.body.append(this.element)};this.add=function(e){if(e){this.components.push(e);if(UI.ready){var t=document.getElementById(this.id);t.appendChild(e.getElement())}}};this.setDimensions=function(e,t){if(this.element){this.element.style.width=e+"px";if(t===false||t=="auto"){this.element.style.height="auto"}else{this.element.style.height=t+"px"}this.resize()}};this.resize=function(){for(var e=0;e<this.components.length;e++){if(this.components[e].resize){this.components[e].resize()}}};this.show=function(e,t){this.backgroundElement.style.display="block";this.backgroundElement.style.zIndex=1010;this.element.style.left=e+"px";this.element.style.top=t+"px";this.element.style.zIndex=2e3;this.fitOnScreen(e,t);$("#"+this.element.id).fadeIn(60)};this.hide=function(){this.backgroundElement.style.display="none";$("#"+this.element.id).fadeOut(60);this.trigger("close")};this.fitOnScreen=function(e,t){var i=$("#"+this.id).offset();var r=i.left;var a=i.top;if(typeof e!="undefined"){r=e}if(typeof t!="undefined"){a=t}var s=$("#"+this.id).width()+2;if(r+s>$(window).width()){r=$(window).width()-s;$("#"+this.id).css("left",r+"px")}var o=$("#"+this.id).height()+2;if(a+o>$(window).height()){a=$(window).height()-o;$("#"+this.id).css("top",a+"px")}};this.showOnly=function(e){for(var t=0;t<this.components.length;t++){var i="";if(this.components[t].uiID){i=this.components[t].uiID}if(this.components[t].ui_type=="UI.Include"){i=this.components[t].component}if(i==e){UI(i).setVisible(true)}else{UI(i).setVisible(false)}}};this.getElement=function(){if(this.element==null){this.element=document.createElement("div");this.element.setAttribute("id",this.id)}return this.element};this.mouseMove=function(e){this.trigger("mousemove",e)};this.mouseDown=function(e){this.trigger("mousedown",e)};this.mouseUp=function(e){this.trigger("mouseup",e)};this.mouseWheel=function(e){this.trigger("mousewheel",e)};this.scrollTo=function(e){$("#"+this.id).scrollTop(e)}};UI.registerComponentType("UI.Popup",UI.Popup);UI.SplitPanelResizeMouseDown=function(e,t,i){var r=UI.components[i];r.mouseDownX=e.pageX;r.mouseDownY=e.pageY;r.resizePanel=t;var a="default";switch(t){case"north":a="n-resize; cursor: row-resize";break;case"east":a="e-resize; cursor: col-resize";break;case"south":a="s-resize; cursor: row-resize";break;case"west":a="w-resize; cursor: col-resize";break}UI.captureMouse(r,{cursor:a});return false};UI.SplitPanel=function(e){this.element=null;this.southDefaultHeight=false;this.centerDefaultHeight=false;this.centerVisible=true;this.centerSizeSave=0;this.north=null;this.northSize=0;this.northBarSize=0;this.northBarSizeSave=0;this.northBorder=true;this.northLastWidth=false;this.northLastHeight=false;this.south=null;this.southSize=0;this.southBarSize=0;this.southBorder=true;this.southResizeHidden=false;this.southLastWidth=false;this.southLastHeight=false;this.east=null;this.eastSize=0;this.eastBarSize=0;this.eastBorder=true;this.eastLastWidth=false;this.eastLastHeight=false;this.west=null;this.westSize=0;this.westBarSize=0;this.westBorder=true;this.westLastWidth=false;this.westLastHeight=false;this.center=null;this.centerLastWidth=false;this.centerLastHeight=false;this.resizePanel="";this.overflow="hidden";if(typeof e.overflow!="undefined"){this.overflow=e.overflow}this.minPanelSize={};this.getPanelSize=function(e){var t=e.panel;if(t=="north"){return this.northSize}if(t=="south"){return this.southSize}};this.getPanelWidth=function(e){if(e=="center"){return $("#"+this.id+"center").width()}};this.getPanelHeight=function(e){if(e=="center"){return $("#"+this.id+"center").height()}};this.resizeThePanel=function(e){var t=0;var i=0;var r=false;if(typeof e!="undefined"){if(typeof e.panel!="undefined"){this.resizePanel=e.panel}if(typeof e.size!="undefined"){r=e.size}if(typeof e.xDiff!="undefined"){t=e.xDiff}if(typeof e.yDiff!="undefined"){i=e.yDiff}}if(this.resizePanel=="west"){if(r===false){r=this.westSize+t}if(typeof this.minPanelSize["west"]!="undefined"&&r<this.minPanelSize["west"]){return;r=this.minPanelSize["west"]}this.westSize=r;$("#"+this.id+"west").css("width",this.westSize+"px");$("#"+this.id+"westbar").css("left",this.westSize+"px");var a=this.westSize+this.westBarSize;$("#"+this.id+"center").css("left",a+"px");this.resize();this.trigger("resizewest",this.westSize)}else if(this.resizePanel=="east"){if(typeof this.eastSize=="undefined"||isNaN(this.eastSize)){this.eastSize=$("#"+this.id+"east").width()}if(typeof this.eastBarSize=="undefined"||isNaN(this.eastSizeBar)){this.eastBarSize=5}if(r===false){r=this.eastSize-t}if(typeof this.minPanelSize["east"]!="undefined"&&r<this.minPanelSize["east"]){return;r=this.minPanelSize["east"]}this.eastSize=r;$("#"+this.id+"east").css("width",this.eastSize+"px");var s=0;if(this.east!=null){s=this.eastSize+this.eastBarSize}$("#"+this.id+"eastbar").css("right",this.eastSize+"px");$("#"+this.id+"center").css("right",s+"px");this.resize();this.trigger("resizeeast",this.eastSize)}else if(this.resizePanel=="north"){if(r!==false){}else{r=this.northSize+i;var o=$("#"+this.id+"center").position();if(typeof o!="undefined"){var l=o.top+$("#"+this.id+"center").height();if(r+this.northBarSize>l-4){}}}if(typeof this.minPanelSize["north"]!="undefined"&&r<this.minPanelSize["north"]){return}var n=r+this.northBarSize;this.northSize=r;$("#"+this.id+"north").css("height",this.northSize+"px");$("#"+this.id+"northbar").css("top",this.northSize+"px");$("#"+this.id+"east").css("top",n+"px");$("#"+this.id+"eastbar").css("top",n+"px");$("#"+this.id+"west").css("top",n+"px");$("#"+this.id+"westbar").css("top",n+"px");if(this.centerVisible){$("#"+this.id+"center").css("top",n+"px")}else{var h=$("#"+this.id).height();this.southSize=h-this.northSize-this.northBarSize;$("#"+this.id+"south").css("height",this.southSize+"px")}this.resize();this.trigger("resizenorth",this.northSize)}else if(this.resizePanel=="south"){if(r!==false){}else{r=this.southSize-i}var d=r+this.southBarSize;this.southSize=r;$("#"+this.id+"south").css("height",this.southSize+"px");$("#"+this.id+"southbar").css("bottom",this.southSize+"px");$("#"+this.id+"east").css("bottom",d+"px");$("#"+this.id+"eastbar").css("bottom",d+"px");$("#"+this.id+"west").css("bottom",d+"px");$("#"+this.id+"westbar").css("bottom",d+"px");$("#"+this.id+"center").css("bottom",d+"px");this.resize();this.trigger("resizesouth",this.southSize)}};this.setMinSize=function(e,t){this.minPanelSize[e]=t};this.resize=function(){var e=$("#"+this.id).width();var t=$("#"+this.id).height();if(!this.centerVisible){if(this.northSize!=0&&this.southSize!=0){var i=$("#"+this.id).height();this.northSize=i-this.southSize-this.northBarSize;$("#"+this.id+"north").css("height",this.northSize+"px");$("#"+this.id+"northbar").css("top",this.northSize+"px")}else if(this.northSize!=0){var i=$("#"+this.id).height();if(i!=0){this.northSize=i;$("#"+this.id+"north").css("height",this.northSize+"px");$("#"+this.id+"northbar").css("top",this.northSize+"px")}}else if(this.southSize!=0){var i=$("#"+this.id).height();if(i!=0){this.southSize=i;$("#"+this.id+"south").css("height",this.southSize+"px");$("#"+this.id+"southbar").hide()}}else if(this.eastSize!=0){var r=$("#"+this.id).width();if(r!=0){this.eastSize=r;$("#"+this.id+"east").css("width",this.eastSize+"px");$("#"+this.id+"eastbar").hide()}}}if(this.center&&typeof this.center.resize!="undefined"){var a=e-this.eastSize-this.westSize;var s=t-this.southSize-this.northSize;if(true||a!==this.centerLastWidth||s!==this.centerLastHeight){this.centerLastWidth=a;this.centerLastHeight=s;this.center.resize()}}if(this.south&&typeof this.south.resize!="undefined"){if(this.southLastHeight!==this.southSize||this.southLastWidth!==e){this.southLastHeight=this.southSize;this.southLastWidth=e;this.south.resize()}}if(this.north&&typeof this.north.resize!="undefined"){if(true||this.northLastHeight!==this.northSize||this.northLastWidth!==e){this.northLastHeight=this.northSize;this.northLastWidth=e;this.north.resize()}}if(this.east&&typeof this.east.resize!="undefined"){if(this.eastLastHeight!==t||this.eastLastWidth!==this.eastSize){this.eastLastHeight=t;this.eastLastWidth=this.eastSize;this.east.resize()}}if(this.west&&typeof this.west.resize!="undefined"){if(this.westLastHeight!==t||this.westLastWidth!==this.westSize){this.westLastHeight=t;this.westLastWidth=this.westSize;this.west.resize()}}};this.mouseDown=function(e){};this.mouseMove=function(e){var t=e.pageX-this.mouseDownX;var i=e.pageY-this.mouseDownY;this.resizeThePanel({xDiff:t,yDiff:i});this.mouseDownX=e.pageX;this.mouseDownY=e.pageY};this.mouseUp=function(e){var t=e.pageX-this.mouseDownX;var i=e.pageY-this.mouseDownY;this.resizeThePanel({xDiff:t,yDiff:i})};this.getPanelVisible=function(e){switch(e){case"north":return this.northSize!=0;break;case"south":return this.southSize!=0;break;case"east":return this.eastSize!=0;break;case"west":return this.westSize!=0;break;case"center":return this.centerVisible;break}};this.getPanelVisible=function(e){if(e=="center"){return this.centerVisible}return $("#"+this.id+e).is(":visible")};this.setResizeVisible=function(e,t){if(e=="south"){if(t){this.southResizeHidden=false;if(UI.ready){$("#"+this.id+e+"bar").show();if(this.southBarSize==0){this.southBarSize=5;this.southSize-=this.southBarSize;$("#"+this.id+"south").css("height",this.southSize+"px");$("#"+this.id+e+"bar").css("height",this.southBarSize+"px");this.south.resize()}}this.southBarSize=5}else{this.southResizeHidden=true;if(UI.ready){$("#"+this.id+e+"bar").hide();if(this.southBarSize!=0){this.southSize+=this.southBarSize;this.southBarSize=0;$("#"+this.id+"south").css("height",this.southSize+"px");this.south.resize()}}this.southBarSize=0}}};this.setPanelVisible=function(e,t,i,r){var a=false;if(typeof i!="undefined"){a=i}var s=false;if(typeof r!="undefined"){s=r}if(typeof t=="undefined"||t){if(this.getPanelVisible(e)){return}$("#"+this.id+e).show();if(e!="center"){$("#"+this.id+e+"bar").show()}if(e=="center"){this.centerVisible=true;if(this.centerSizeSave==0){this.centerSizeSave=200;if(a!==false){this.centerSizeSave=a}}if(this.northSize!=0&&this.southSize!=0){var o=this.northSize-this.centerSizeSave;if(o<100){o=100}this.northSize=o;this.northBarSize=this.northBarSizeSave;this.southBarSize=this.southBarSizeSave;if(s){this.northBarSize=5;this.southBarSize=5;$("#"+this.id+"southbar").show()}}else if(this.northSize!=0){var o=this.northSize-this.centerSizeSave;if(o<100){o=100}this.northSize=o;this.northBarSize=5}else if(this.southSize!=0){var l=this.southSize-this.centerSizeSave;if(l<100){l=100}this.southSize=l;this.southBarSize=5;$("#"+this.id+"southbar").show()}else if(this.eastSize!=0){var n=this.eastSize-this.centerSizeSave;if(n<100){n=100}this.eastSize=n;this.eastBarSize=5;$("#"+this.id+"eastbar").show()}}if(e=="west"){if(typeof this.westSizeSave!="undefined"){this.westSize=this.westSizeSave;this.westBarSize=this.westBarSizeSave}}if(e=="east"){if(typeof this.eastSizeSave!="undefined"){this.eastSize=this.eastSizeSave;this.eastBarSize=this.eastBarSizeSave}}if(e=="north"){if(typeof this.northSizeSave!="undefined"){if(!this.centerVisible){var h=$("#"+this.id).height();if(this.southSize){this.northBarSize=5;this.northSize=this.northSizeSave;if(this.northSize<=0){this.northSize=100}if(h-this.northSize<100){this.northSize=h-100}this.southSize=h-this.northSize-this.northBarSize;this.southBarSizeSave=this.southBarSize;this.southBarSize=0}else{this.northSize=h;this.southBarSize;this.northBarSize=0}}else{if(a!==false){if(this.northSizeSave===false||this.northBarSizeSave<a){this.northSizeSave=a}}if(s){this.northBarSizeSave=5}if(this.northSizeSave!=0){this.northSize=this.northSizeSave;this.northBarSize=this.northBarSizeSave}var h=$("#"+this.id).height();if(this.centerDefaultHeight!==false){if(h-this.northSize<this.centerDefaultHeight){this.northSize=h-this.centerDefaultHeight;this.northBarSize=5}}}}}if(e=="south"){if(!this.centerVisible){var h=$("#"+this.id).height();if(this.northSize){this.southBarSize=0;this.northBarSize=this.northBarSizeSave;if(s){this.northBarSize=5}this.southSize=this.southSizeSave;if(a!==false){this.southSize=a}this.northSize=h-this.southSize-this.northBarSize}else{this.southSize=h;this.southBarSize=0;this.northBarSize=0}}else{if(typeof this.southSizeSave!="undefined"){this.southSize=this.southSizeSave}if(a!==false){this.southSize=a}var h=$("#"+this.id).height();if(this.centerDefaultHeight!==false){if(h-this.southSize<this.centerDefaultHeight){this.southSize=h-this.centerDefaultHeight;this.southBarSizeSave=5}}if(typeof this.southBarSizeSave!="undefined"){this.southBarSize=this.southBarSizeSave}if(s){this.southBarSize=5}}}}else{$("#"+this.id+e).hide();$("#"+this.id+e+"bar").hide();if(e=="center"){this.centerVisible=false;this.centerSizeSave=$("#"+this.id+e).height();var h=$("#"+this.id).height();var d=$("#"+this.id).width();if(this.northSize!=0&&this.southSize!=0){this.northSize=h-this.southSize-this.northBarSize;this.southBarSizeSave=this.southBarSize;this.southBarSize=0;if(s){this.northBarSize=5}}else if(this.northSize!=0){this.northSize=h;this.northBarSizeSave=this.northBarSize;this.northBarSize=0;this.southBarSizeSave=this.southBarSize;this.southBarSize=0}else if(this.southSize!=0){this.southSize=h;this.northBarSizeSave=this.northBarSize;this.northBarSize=0;this.southBarSizeSave=this.southBarSize;this.southBarSize=0}else if(this.eastSize!=0){this.centerSizeSave=$("#"+this.id+e).width();this.eastSize=d;this.eastBarSizeSave=this.eastBarSize;this.eastBarSize=0;this.westBarSizeSave=this.westBarSize;this.westBarSize=0}}if(e=="west"){if(this.westSize!=0){this.westSizeSave=this.westSize;this.westBarSizeSave=this.westBarSize;this.westSize=0;this.westBarSize=0}else{return}}if(e=="east"){if(this.eastSize!=0){this.eastSizeSave=this.eastSize;this.eastBarSizeSave=this.eastBarSize;this.eastSize=0;this.eastBarSize=0}else{return}}if(e=="north"){this.northSizeSave=this.northSize;this.northBarSizeSave=this.northBarSize;this.northSize=0;this.northBarSize=0;if(!this.centerVisible){if(this.southSize>0){var h=$("#"+this.id).height();this.southSize=h;this.southBarSizeSave=this.southBarSize;this.southBarSize=0}}}if(e=="south"){if(this.southSize!=0){this.southSizeSave=this.southSize;this.southBarSizeSave=this.southBarSize;this.southSize=0;this.southBarSize=0;if(!this.centerVisible){if(this.northSize>0){var h=$("#"+this.id).height();this.northSize=h}}}else{return}}}if(e=="west"){$("#"+this.id+"west").css("width",this.westSize+"px");$("#"+this.id+"westbar").css("left",this.westSize+"px");$("#"+this.id+"westbar").css("width",this.westBarSize+"px");var c=this.westSize+this.westBarSize;$("#"+this.id+"center").css("left",c+"px")}if(e=="east"&&this.east!=null){$("#"+this.id+"east").css("width",this.eastSize+"px");$("#"+this.id+"eastbar").css("right",this.eastSize+"px");var f=this.eastSize+this.eastBarSize;$("#"+this.id+"center").css("right",f+"px")}if(e=="north"){$("#"+this.id+"north").css("height",this.northSize+"px");$("#"+this.id+"northbar").css("top",this.northSize+"px");var u=this.northSize+this.northBarSize;$("#"+this.id+"center").css("top",u+"px");if(!this.centerVisible){$("#"+this.id+"south").css("height",this.southSize+"px");$("#"+this.id+"southbar").css("bottom",this.southSize+"px");var p=this.southSize+this.southBarSize}$("#"+this.id+"southbar").css("height",this.southBarSize+"px");$("#"+this.id+"northbar").css("height",this.northBarSize+"px")}if(e=="south"){$("#"+this.id+"south").css("height",this.southSize+"px");$("#"+this.id+"southbar").css("bottom",this.southSize+"px");var p=this.southSize+this.southBarSize;$("#"+this.id+"center").css("bottom",p+"px");if(!this.centerVisible){$("#"+this.id+"north").css("height",this.northSize+"px");$("#"+this.id+"northbar").css("top",this.northSize+"px");var u=this.northSize+this.northBarSize;$("#"+this.id+"center").css("top",u+"px")}$("#"+this.id+"southbar").css("height",this.southBarSize+"px");$("#"+this.id+"northbar").css("height",this.northBarSize+"px")}if(e=="center"){$("#"+this.id+"north").css("height",this.northSize+"px");$("#"+this.id+"northbar").css("top",this.northSize+"px");var u=this.northSize+this.northBarSize;$("#"+this.id+"center").css("top",u+"px");$("#"+this.id+"south").css("height",this.southSize+"px");$("#"+this.id+"southbar").css("bottom",this.southSize+"px");var p=this.southSize+this.southBarSize;$("#"+this.id+"center").css("bottom",p+"px");$("#"+this.id+"southbar").css("height",this.southBarSize+"px");$("#"+this.id+"northbar").css("height",this.northBarSize+"px");$("#"+this.id+"east").css("width",this.eastSize+"px");$("#"+this.id+"eastbar").css("right",this.eastSize+"px");var f=this.eastSize+this.eastBarSize;$("#"+this.id+"center").css("right",f+"px");$("#"+this.id+"eastbar").css("width",this.eastBarSize+"px")}this.resize()};this.hidePanel=function(e){$("#"+this.id+e).hide();$("#"+this.id+e+"bar").hide()};this.addEast=function(e,t,i,r){this.east=e;this.eastSize=t;this.eastHidden=r;if(typeof r=="undefined"){this.eastHidden=false}if(typeof t=="undefined"){this.eastSize=100}this.eastBarSize=5;if(typeof i!="undefined"){this.eastBorder=i;if(!this.eastBorder){this.eastBarSize=0}}if(this.eastHidden){this.eastSizeSave=this.eastSize;this.eastBarSizeSave=this.eastBarSize;this.eastBarSize=0;this.eastSize=0}if(UI.ready){var a=this.northSize+this.northBarSize;var s=this.southSize+this.southBarSize;var o=document.createElement("div");o.setAttribute("id",this.id+"east");var l="position: absolute; overflow-x; "+this.overflow+"; overflow-y: "+this.overflow+"; top: "+a+"px; right: 0px; bottom: "+s+"px; width: "+this.eastSize+"px; ";if(this.eastHidden){l+=" display: none;"}o.setAttribute("style",l);o.appendChild(e.getElement());var n=this.getElement();n.appendChild(o);if(this.eastBorder){var h=document.createElement("div");h.setAttribute("id",this.id+"eastbar");var l="position: absolute; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow+"; top: "+a+"px; right: "+this.eastSize+"px; bottom: "+s+"px; width: "+this.eastBarSize+"px; cursor: e-resize; cursor: col-resize;";if(this.eastHidden){l+=" display: none; "}h.setAttribute("style",l);h.setAttribute("onmousedown","return UI.SplitPanelResizeMouseDown(event, 'east', '"+this.id+"')");h.setAttribute("onselectstart","return false");h.innerHTML='<div class="ui-splitpanel-eastresize"><div class="ui-splitpanel-verticalresizehandle"></div></div>';n.appendChild(h)}this.resizePanel="south";this.resizeThePanel();this.resizePanel="north";this.resizeThePanel()}};this.addWest=function(e,t,i,r){this.westHidden=r;if(typeof r=="undefined"){this.westHidden=false}this.west=e;if(typeof t=="undefined"){t=100}this.westSize=t;this.westBarSize=5;if(typeof i!="undefined"){this.westBorder=i;if(!this.westBorder){this.westBarSize=0}}this.westThinBorder=false;if(this.westHidden){this.westSizeSave=this.westSize;this.westBarSizeSave=this.westBarSize;this.westBarSize=0;this.westSize=0}if(UI.ready){var a=this.northSize+this.northBarSize;var s=this.southSize+this.southBarSize;var o=document.createElement("div");o.setAttribute("id",this.id+"west");var l="position: absolute; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; top: "+a+"px; bottom: "+s+"px; width: "+this.westSize+"px;";if(this.westHidden){l+=" display: none; "}o.setAttribute("style",l);if(this.westThinBorder){l+=" border-right: 1px solid #ff0000; "}o.appendChild(e.getElement());var n=this.getElement();n.appendChild(o);if(this.westBorder){var h=document.createElement("div");h.setAttribute("id",this.id+"westbar");var l="position: absolute; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow+"; left: "+this.westSize+"px; top: "+a+"px; bottom: "+s+"px; width: "+this.westBarSize+"px;  cursor: w-resize; cursor: col-resize; vertical-align: middle;";if(this.westHidden){l+=" display: none"}h.setAttribute("style",l);h.setAttribute("onmousedown","return UI.SplitPanelResizeMouseDown(event, 'west', '"+this.id+"')");h.setAttribute("onselectstart","return false");h.innerHTML='<div class="ui-splitpanel-westresize"><div class="ui-splitpanel-verticalresizehandle"></div></div>';n.appendChild(h)}if(this.westHidden){this.westBarSize=0}this.resizePanel="south";this.resizeThePanel();this.resizePanel="north";this.resizeThePanel()}};this.addNorth=function(e,t,i,r){this.northHidden=r;if(typeof r=="undefined"){this.northHidden=false}this.north=e;if(typeof t=="undefined"){t=100}this.northSize=t;this.northBarSize=5;if(typeof i!="undefined"){this.northBorder=i;if(!this.northBorder){this.northBarSize=0}}if(this.northHidden){this.northSizeSave=this.northSize;this.northBarSizeSave=this.northBarSize;this.northBarSize=0;this.northSize=0}if(UI.ready){var a=document.createElement("div");a.setAttribute("id",this.id+"north");a.setAttribute("style","position: absolute; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; right: 0; top: 0; bottom: 0; height: "+this.northSize+"px");a.appendChild(e.getElement());var s=this.getElement();s.appendChild(a);if(this.northBorder){var o=document.createElement("div");o.setAttribute("id",this.id+"northbar");o.setAttribute("style","position: absolute; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; right: 0; top: "+this.northSize+"px; height: "+this.northBarSize+"px; cursor: n-resize; cursor: row-resize");o.setAttribute("onmousedown","return UI.SplitPanelResizeMouseDown(event, 'north', '"+this.id+"')");o.setAttribute("onselectstart","return false");o.innerHTML='<div class="ui-splitpanel-northresize"><div class="ui-splitpanel-horizontalresizehandle"></div></div>';s.appendChild(o)}this.resizePanel="north";this.resizeThePanel();this.resizePanel="south";this.resizeThePanel();this.resizePanel="east";this.resizeThePanel();this.resizePanel="west";this.resizeThePanel()}};this.addSouth=function(e,t,i,r){this.southHidden=r;if(typeof r=="undefined"){this.southHidden=false}this.south=e;if(typeof t=="undefined"){t=100}this.southSize=t;this.southBarSize=5;if(typeof i!="undefined"){this.southBorder=i;if(!this.southBorder){this.southBarSize=0}}if(this.southHidden){this.southSizeSave=this.southSize;this.southBarSizeSave=this.southBarSize;this.southBarSize=0;this.southSize=0}if(UI.ready){var a=document.createElement("div");a.setAttribute("id",this.id+"south");var s="position: absolute; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; right: 0; bottom: 0; height: "+this.southSize+"px;";if(this.southHidden){s+="display: none;"}a.setAttribute("style",s);a.appendChild(e.getElement());var o=this.getElement();o.appendChild(a);if(this.southBorder){var l=document.createElement("div");l.setAttribute("id",this.id+"southbar");var s="position: absolute; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; right: 0; bottom: "+this.southSize+"px; height: "+this.southBarSize+"px; cursor: s-resize; cursor: row-resize;";if(this.southHidden){s+="display: none;"}l.setAttribute("style",s);l.setAttribute("onmousedown","return UI.SplitPanelResizeMouseDown(event, 'south', '"+this.id+"')");l.setAttribute("onselectstart","return false");l.innerHTML='<div class="ui-splitpanel-southresize"><div class="ui-splitpanel-horizontalresizehandle"></div></div>';o.appendChild(l)}this.resizePanel="north";this.resizeThePanel();this.resizePanel="south";this.resizeThePanel();this.resizePanel="east";this.resizeThePanel();this.resizePanel="west";this.resizeThePanel();this.resizePanel="center";this.resizeThePanel()}};this.add=function(e,t){this.center=e;if(typeof t=="undefined"||t===false){this.centerVisible=true}else{this.centerVisible=false}if(UI.ready){var i=this.northSize+this.northBarSize;var r=this.southSize+this.southBarSize;var a=this.westSize+this.westBarSize;var s=this.eastSize+this.eastBarSize;if(this.east==null){s=0}var o=document.createElement("div");o.setAttribute("id",this.id+"center");o.setAttribute("style","position: absolute; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow+"; left: "+a+"px; top: "+i+"px; right: "+s+"px; bottom: "+r+"px;");o.appendChild(e.getElement());var l=this.getElement();l.appendChild(o)}};this.getElement=function(){if(this.element==null){this.element=document.getElementById(this.id);if(this.element){return this.element}this.element=document.createElement("div");this.element.setAttribute("id",this.id);this.element.setAttribute("style","position: absolute; left: 0; right: 0; top: 0; bottom: 0; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow)}return this.element};this.getHTML=function(){var e="";e+='<div style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; overflow-x: '+this.overflow+"; overflow-y: "+this.overflow+'" id="'+this.id+'"  >';if(this.north!=null){e+='    <div id="'+this.id+'north" style="position: absolute; overflow-x: '+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; right: 0; top: 0; bottom: 0; height: "+this.northSize+"px;";if(this.northHidden){e+=" display: none; "}e+='"   >';e+=this.north.getHTML();e+="    </div>";if(this.northBorder){e+='    <div id="'+this.id+'northbar" style="position: absolute; overflow-x: '+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; right: 0; top: "+this.northSize+"px; height: "+this.northBarSize+"px; cursor: n-resize; cursor: row-resize; ";if(this.northHidden){e+=" display: none; "}e+="\"  onmousedown=\"return UI.SplitPanelResizeMouseDown(event, 'north', '"+this.id+'\')" onselectstart="return false">';e+='        <div class="ui-splitpanel-northresize">';e+='            <div class="ui-splitpanel-horizontalresizehandle"></div> ';e+="        </div>";e+="    </div>"}}else{this.northBarSize=0}if(this.south!=null){e+='    <div id="'+this.id+'south" style="position: absolute; overflow-x: '+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; right: 0; bottom: 0; height: "+this.southSize+"px;";if(this.southHidden){e+=" display: none;"}e+=' "  >';e+=this.south.getHTML();e+="    </div>";if(this.southBorder){e+='    <div id="'+this.id+'southbar"  style="position: absolute; overflow-x: '+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; right: 0; bottom: "+this.southSize+"px; height: "+this.southBarSize+"px; cursor: s-resize; cursor: row-resize; ";if(this.southHidden||!this.centerVisible||this.southResizeHidden){e+=" display: none;"}e+="\"  onmousedown=\"return UI.SplitPanelResizeMouseDown(event, 'south', '"+this.id+'\')" onselectstart="return false">';e+='        <div class="ui-splitpanel-southresize">';e+='            <div class="ui-splitpanel-horizontalresizehandle"></div> ';e+="        </div>";e+="    </div>"}}else{this.southBarSize=0}if(this.east){var t=this.northSize+this.northBarSize;var i=this.southSize+this.southBarSize;e+='    <div id="'+this.id+'east" style="position: absolute; overflow-x; '+this.overflow+"; overflow-y: "+this.overflow+"; top: "+t+"px; right: 0px; bottom: "+i+"px; width: "+this.eastSize+"px;";if(this.eastHidden){e+=" display: none; "}e+=' " >';e+=this.east.getHTML();e+="    </div>";if(this.eastBorder){e+='    <div id="'+this.id+'eastbar" style="position: absolute; overflow-x: '+this.overflow+"; overflow-y: "+this.overflow+"; top: "+t+"px; right: "+this.eastSize+"px; bottom: "+i+"px; width: "+this.eastBarSize+"px; cursor: e-resize; cursor: col-resize; ";if(this.eastHidden){e+=" display: none "}e+=" \" onmousedown=\"return UI.SplitPanelResizeMouseDown(event, 'east', '"+this.id+'\')" onselectstart="return false">';e+='      <div class="ui-splitpanel-eastresize">';e+='        <div class="ui-splitpanel-verticalresizehandle"></div> ';e+="      </div>";e+="    </div>"}}else{this.eastBarSize=0}if(this.west){var t=this.northSize+this.northBarSize;var i=this.southSize+this.southBarSize;e+='    <div id="'+this.id+'west" style=" position: absolute; overflow-x: '+this.overflow+"; overflow-y: "+this.overflow+"; left: 0; top: "+t+"px; bottom: "+i+"px; width: "+this.westSize+"px;";if(this.westHidden){e+=" display: none; "}if(this.westThinBorder){e+=" border-right: 1px solid #ff0000; "}e+='" >';e+=this.west.getHTML();e+="    </div>";if(this.westBorder){e+='    <div id="'+this.id+'westbar"  style="position: absolute; overflow-x: '+this.overflow+"; overflow-y: "+this.overflow+"; left: "+this.westSize+"px; top: "+t+"px; bottom: "+i+"px; width: "+this.westBarSize+"px;  cursor: w-resize; cursor: col-resize; vertical-align: middle;";if(this.westHidden){e+=" display: none "}e+="\" onmousedown=\"return UI.SplitPanelResizeMouseDown(event, 'west', '"+this.id+'\')" onselectstart="return false">';e+='    <div class="ui-splitpanel-westresize">';e+='      <div class="ui-splitpanel-verticalresizehandle"></div> ';e+="    </div>";e+="    </div>"}}else{this.westBarSize=0}if(this.center){var t=this.northSize+this.northBarSize;var i=this.southSize+this.southBarSize;var r=this.westSize+this.westBarSize;var a=this.eastSize+this.eastBarSize;e+='    <div id="'+this.id+'center" style="';if(!this.centerVisible){e+=" display: none;"}e+="position: absolute; overflow-x: "+this.overflow+"; overflow-y: "+this.overflow+"; left: "+r+"px; top: "+t+"px; right: "+a+"px; bottom: "+i+'px; " >';e+=this.center.getHTML();e+="    </div>"}e+="</div>";return e}};UI.registerComponentType("UI.SplitPanel",UI.SplitPanel);var g_tabIndex=0;UI.TabPanel=function(e){this.args=e;this.element=null;this.components=new Array;this.currentTab=0;this.tabMap=new Object;this.tabHistory=[];this.canCloseTabs=true;this.onTabFocus=null;if(e.ontabfocus){this.onTabFocus=e.ontabfocus}this.onTabBlur=null;if(e.ontabblur){this.onTabBlur=e.ontabblur}this.onNoTabs=null;if(e.onnotabs){this.onNoTabs=e.onnotabs}if(typeof e.canCloseTabs!="undefined"){this.canCloseTabs=e.canCloseTabs}this.add=function(e){var t=e.title;if(e.hasOwnProperty("key")){t=e.key}this.components.push({key:t,tabId:g_tabIndex++,tab:e})};this.getTabs=function(){return this.components};this.getTabHTML=function(e){var t=this.components[e];var i="";i+='<div id="'+this.id+"tab-"+t.tabId+'" href="#" class="ui-tab';if(t.tabId==this.currentTab){i+=" ui-current-tab"}if(typeof this.components[e].tab.isTemp!="undefined"){if(this.components[e].tab.isTemp){i+=" ui-tab-temp "}}i+='"  ';if(typeof this.components[e].tab.visible!="undefined"&&!this.components[e].tab.visible){i+=' style="display: none" '}i+=" onclick=\"UI.TabPanelSetTab('"+this.id+"', "+t.tabId+')" ondblclick="UI.TabPanelDblClickTab(\''+this.id+"', "+t.tabId+')" onmousedown="return false" onselectstart="return false" ';i+=">";i+='<div class="ui-tab-label">';i+=this.components[e].tab.title;i+="</div>";if(this.canCloseTabs){i+='<div class="ui-tab-close" onclick="UI.TabPanelCloseTab(\''+this.id+"', "+t.tabId+')">';i+='<img src="icons/svg/glyphicons-basic-599-menu-close.svg"/>';i+="</div>"}i+="</div>";return i},this.addTab=function(e,t){var i=e.title;if(typeof e.key!="undefined"){i=e.key}for(var r=0;r<this.components.length;r++){if(this.components[r].key===i){if(this.currentTab!==this.components[r].tabId){if(typeof t!="undefined"&&t){this.showTab(i)}}return}}var a=this.components.length;var s=e;if(typeof s.visible=="undefined"){s.visible=true}if(typeof s.enabled=="undefined"){s.enabled=true}this.components.push({key:i,tabId:g_tabIndex++,tab:s});var o=this.id+"-header";var l=this.getTabHTML(a);$("#"+o).append(l);if(typeof t!="undefined"&&t){this.showTab(i)}return a};this.getCurrentTab=function(){for(var e=0;e<this.components.length;e++){if(this.components[e].tabId===this.currentTab){return this.components[e].key}}return false};this.getTabCount=function(){return this.components.length};this.getElement=function(){if(this.element==null){this.element=document.createElement("div");this.element.setAttribute("id",this.id);this.element.setAttribute("class","ui-tab-panel");this.element.innerHTML=this.getInnerHTML();var e=this;UI.on("ready",function(){e.showTab(0)})}return this.element};this.getInnerHTML=function(){var e="";e+='<div class="ui-tab-header"  id="'+this.id+'-header">';for(var t=0;t<this.components.length;t++){e+=this.getTabHTML(t)}e+="</div>";e+='<div class="ui-tab-bar"></div>';return e};this.getHTML=function(){var e="";e+='<div class="ui-tab-panel" id="'+this.id+'">';e+=this.getInnerHTML();e+="</div>";var t=this;UI.on("ready",function(){t.showTab(0)});return e};this.setTabLabel=function(e,t){var i=this.id+"tab-"+this.components[e].tabId;$("#"+i+" .ui-tab-label").html(t)};this.getTabData=function(e){if(e>=0&&e<this.components.length){return this.components[e].tab}return null};this.setTabData=function(e,t){if(e<0||e>=this.components.length){return}for(var i in t){this.components[e].tab[i]=t[i]}if(typeof t.key!="undefined"){this.components[e].key=t.key}if(typeof t.title!="undefined"){this.setTabLabel(e,t.title)}if(typeof t.isTemp!="undefined"){var r=this.id+"tab-"+this.components[e].tabId;if(t.isTemp){$("#"+r).addClass("ui-tab-temp")}else{$("#"+r).removeClass("ui-tab-temp")}}};this.getTabKey=function(e){if(e<0||e>=this.components.length){return""}return this.components[e].key};this.getTabIndex=function(e){for(var t=0;t<this.components.length;t++){if(this.components[t].key===e){return t}}return-1};this.getTabIndexFromId=function(e){for(var t=0;t<this.components.length;t++){if(this.components[t].tabId===e){return t}}return-1};this.setEnabled=function(e,t){var i=this.getTabIndex(e);if(i==-1){return}this.components[i].tab.enabled=t;var r=this.components[i].tabId;if(t){$("#"+this.id+"tab-"+r).removeClass("ui-tab-disabled");$("#"+this.id+"tab-"+r).addClass("ui-tab")}else{$("#"+this.id+"tab-"+r).addClass("ui-tab-disabled");$("#"+this.id+"tab-"+r).removeClass("ui-tab")}};this.setTabVisible=function(e,t){var i=this.getTabIndex(e);if(i==-1){return}var r=this.components[i].tabId;if(t){$("#"+this.id+"tab-"+r).show()}else{$("#"+this.id+"tab-"+r).hide()}};this.getTabVisible=function(e){var t=this.getTabIndex(e);if(t==-1){return false}var i=this.components[t].tabId;return $("#"+this.id+"tab-"+i).css("display")!="none"};this.closeTab=function(e){var t=this.getTabIndex(e);if(t==-1){return}if(t>=this.components.length){return}if(typeof this.components[t].tab.enabled!="undefined"){if(!this.components[t].tab.enabled){return}}var i=this.components[t].tabId;$("#"+this.id+"tab-"+ +i).remove();this.components.splice(t,1);var r=[];for(var a=0;a<this.tabHistory.length;a++){if(this.tabHistory[a]!==i){r.push(this.tabHistory[a])}}this.tabHistory=r;if(this.tabHistory.length>0){var s=this.tabHistory[this.tabHistory.length-1];var o=this.getTabIndexFromId(s);if(o!==-1){var e=this.components[o].key;this.showTab(e)}}else{if(this.components.length>0){var e=this.components[0].key;this.showTab(e)}else{if(this.onNoTabs!=null){this.onNoTabs(this)}this.trigger("notabs",this)}}};this.dblClickTab=function(e){var t=this.getTabIndex(e);if(t==-1){return}this.setTabData(t,{isTemp:false})};this.showTab=function(e){var t=this.getTabIndex(e);if(t==-1){return}if(t>=this.components.length){return}if(typeof this.components[t].tab.enabled!="undefined"){if(!this.components[t].tab.enabled){return}}var i=this.components[t].tabId;if(this.currentTab===i){return}if(this.onTabBlur!=null){if(!this.onTabBlur(this.getTabKey(this.currentTab),t,this)){return false}}if(this.trigger("tabblur",this.getTabKey(this.currentTab),e,this)===false){return false}this.currentTab=i;for(var r=0;r<this.components.length;r++){if(t==r){$("#"+this.id+"tab-"+this.components[r].tabId).addClass("ui-current-tab");$("#"+this.id+"tabcontent"+r).show();if(this.components[r].tab.layout){this.components[r].tab.layout()}}else{$("#"+this.id+"tab-"+this.components[r].tabId).removeClass("ui-current-tab");$("#"+this.id+"tabcontent"+r).hide()}}if(this.onTabFocus){this.onTabFocus(t,this)}this.trigger("tabfocus",e,this);this.tabHistory.push(i)}};UI.TabPanelCloseTab=function(e,t){var i=UI.components[e];var r=false;for(var a=0;a<i.components.length;a++){if(i.components[a].tabId===t){r=a;break}}if(r<i.components.length){var s=i.components[r].key;i.closeTab(s)}};UI.TabPanelSetTab=function(e,t){var i=UI.components[e];var r=false;for(var a=0;a<i.components.length;a++){if(i.components[a].tabId===t){r=a;break}}if(r===false){return}if(r<i.components.length){var s=i.components[r].key;i.showTab(s)}};UI.TabPanelDblClickTab=function(e,t){var i=UI.components[e];var r=false;for(var a=0;a<i.components.length;a++){if(i.components[a].tabId===t){r=a;break}}if(r===false){return}if(r<i.components.length){var s=i.components[r].key;i.dblClickTab(s)}};UI.registerComponentType("UI.TabPanel",UI.TabPanel);UI.HTMLPanel=function(){this.init=function(e){this.html="";if(e.html){this.html=e.html}this.style=null;if(e.style){this.style=e.style}this.visible=true;if(typeof e.visible!="undefined"){this.visible=e.visible;if(!this.visible){this.style+=";display: none"}}};this.setHTML=function(e){this.html=e;$("#"+this.id).html(e)};this.htmlLoaded=function(e,t){var i=this;$("#"+i.id).html(e);if(typeof UI.number!="undefined"){UI.number.initControls("#"+i.id+" .number")}else{console.error("weird error")}if(typeof UI.slider!="undefined"){UI.slider.initControls("#"+i.id)}else{console.error("weird error")}$("#"+i.id+" .nodrag").on("touchmove",function(e){e.preventDefault()});if(typeof t!="undefined"){t()}i.trigger("loaded")};this.load=function(e,t){var i=this;var r=this;if(typeof g_htmlCache!="undefined"&&typeof g_htmlCache[e]!="undefined"){this.htmlLoaded(g_htmlCache[e],t)}else{$.get(e+"?9",function(e){r.htmlLoaded(e,t)})}};this.resize=function(){this.trigger("resize")};this.getElement=function(){var e=document.createElement("div");e.setAttribute("id",this.id);e.setAttribute("class","ui-html-panel ui-mouseevents");if(!this.visible){e.setAttribute("style","display: none;")}if(typeof this.html!="undefined"&&this.html!==""){e.innerHTML=this.html}return e};this.getHTML=function(){var e="";e+='<div id="'+this.id+'" class="ui-html-panel ui-mouseevents" ';if(this.style!=null){e+=' style="'+this.style+'" '}e+=">";if(this.html){e+=this.html}e+="</div>";return e};this.mouseEnter=function(e){this.trigger("mouseenter",e)};this.mouseLeave=function(e){this.trigger("mouseleave",e)};this.mouseMove=function(e){this.trigger("mousemove",e)};this.doubleClick=function(e){this.trigger("dblclick",e)};this.mouseDown=function(e){this.trigger("mousedown",e)};this.mouseUp=function(e){this.trigger("mouseup",e)};this.mouseWheel=function(e){this.trigger("mousewheel",e)};this.contextMenu=function(e){this.trigger("contextmenu",e)}};UI.registerComponentType("UI.HTMLPanel",UI.HTMLPanel);UI.WebGLPanel=function(){this.init=function(e){this.enabled=true;UI.webGLComponents.push(this)};this.getHTML=function(){var e="";e+='<div id="'+this.id+'" style="position: absolute; top: 0; bottom: 0; left: 0; right: 0; oveflow: hidden" class="ui-webgl-panel ">';if(this.html){e+=this.html}e+="</div>";return e};this.contextMenu=function(e){this.trigger("contextmenu",e)};this.mouseMove=function(e){this.trigger("mousemove",e)};this.mouseDown=function(e){this.trigger("mousedown",e)};this.mouseUp=function(e){this.trigger("mouseup",e)};this.mouseWheel=function(e){this.trigger("mousewheel",e)};this.resize=function(){if(!this.enabled){return}var e=$("#"+this.id);var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}this.trigger("resize",this.left,this.top,this.width,this.height)};this.setEnabled=function(e){this.enabled=e};this.render=function(){if(!this.enabled){return}UI.renderer.setViewport(this.left,UI.getScreenHeight()-this.top-this.height,this.width,this.height);UI.renderer.setScissor(this.left,UI.getScreenHeight()-this.top-this.height,this.width,this.height);UI.renderer.setScissorTest(true);this.trigger("render",this.left,this.top,this.width,this.height)}};UI.registerComponentType("UI.WebGLPanel",UI.WebGLPanel);UI.CanvasPanel=function(){this.init=function(e){UI.canvasComponents.push(this);this.canvas=null;this.scale=1;this.left=false;this.top=false;this.width=false;this.height=false};this.getElement=function(){this.element=document.createElement("div");this.element.setAttribute("id",this.id);this.element.setAttribute("style","position: absolute; top: 0; bottom: 0; left: 0; right: 0");this.element.setAttribute("class","ui-canvas-panel ui-mouseevents");this.element.innerHTML='<canvas style="" id="'+this.id+'-canvas"></canvas>';return this.element};this.getHTML=function(){var e="";e+='<div id="'+this.id+'" style="position: absolute; top: 0; bottom: 0; left: 0; right: 0" class="ui-canvas-panel ui-mouseevents">';e+='<canvas style="" id="'+this.id+'-canvas"></canvas>';e+="</div>";return e};this.getCanvas=function(){if(this.canvas==null){this.canvas=document.getElementById(this.id+"-canvas")}return this.canvas};this.contextMenu=function(e){this.trigger("contextmenu",e)};this.mouseMove=function(e){this.trigger("mousemove",e)};this.mouseDown=function(e){this.trigger("mousedown",e)};this.mouseUp=function(e){this.trigger("mouseup",e)};this.mouseWheel=function(e){this.trigger("mousewheel",e)};this.mouseEnter=function(e){this.trigger("mouseenter",e)};this.mouseLeave=function(e){this.trigger("mouseleave",e)};this.resize=function(e){var t=false;if(typeof e!="undefined"){if(typeof e.force!="undefined"){t=e.force}}var i=$("#"+this.id);var r=i.offset();if(r){this.left=r.left;this.top=r.top;this.width=i.width();this.height=i.height()}this.canvas=this.getCanvas();if(this.width!=this.canvas.style.width||this.height!=this.canvas.style.height||t){if(this.width!=0&&this.height!=0){this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvas.width=this.width*UI.devicePixelRatio;this.canvas.height=this.height*UI.devicePixelRatio;this.scale=UI.devicePixelRatio}}this.trigger("resize",this.left,this.top,this.width,this.height)};this.getScale=function(){return this.scale};this.render=function(){return;if(this.left===false){this.resize()}if(this.width==0||this.height==0){return}this.canvas=this.getCanvas();if(this.width!=this.canvas.style.width||this.height!=this.canvas.style.height){if(this.width!=0&&this.height!=0){this.canvas.style.width=this.width;this.canvas.style.height=this.height;this.canvas.width=this.width*UI.devicePixelRatio;this.canvas.height=this.height*UI.devicePixelRatio;this.scale=UI.devicePixelRatio}}this.trigger("render",this.left,this.top,this.width,this.height)}};UI.registerComponentType("UI.CanvasPanel",UI.CanvasPanel);UI.CanvasScrollPanel=function(){this.init=function(e){this.canvas=null;this.scale=1;this.left=false;this.top=false;this.width=false;this.height=false;this.scrollX=0;this.scrollY=0;this.xScrollSpeed=0;this.yScrollSpeed=0;this.vScrollBarWidth=styles.ui.scrollbarWidth;this.vScrollBarHeight=0;this.vScrollBarPosition=null;this.vScrollBarPositionMin=0;this.vScrollBarPositionMax=0;this.vScrollBarPositionMouseOffset=0;this.vScroll=false;this.hScrollBarHeight=styles.ui.scrollbarWidth;this.hScrollBarWidth=0;this.hScrollBarPosition=null;this.hScrollBarPositionMin=0;this.hScrollBarPositionMax=0;this.hScrollBarPositionMouseOffset=0;this.hScroll=false;this.mouseIsDown=false;this.saveCursor=false;this.canvasScale=UI.devicePixelRatio};this.getElement=function(){this.element=document.createElement("div");this.element.setAttribute("id",this.id);this.element.setAttribute("style","position: absolute; top: 0; bottom: 0; left: 0; right: 0");this.element.setAttribute("class","ui-canvas-panel ui-mouseevents");this.element.innerHTML='<canvas style="" id="'+this.id+'-canvas"></canvas>';return this.element};this.getHTML=function(){var e="";e+='<div id="'+this.id+'" style="position: absolute; top: 0; bottom: 0; left: 0; right: 0" class="ui-canvas-panel ui-mouseevents">';e+='<canvas style="" id="'+this.id+'-canvas"></canvas>';e+="</div>";return e};this.initEvents=function(){var t=this;this.canvas.addEventListener("dblclick",function(e){t.dblClick(e)},false);this.canvas.addEventListener("mousedown",function(e){t.mouseDown(e)},false);this.canvas.addEventListener("mousemove",function(e){t.mouseMove(e)},false);this.canvas.addEventListener("mouseleave",function(e){if(t.mouseIsDown){UI.captureMouse(t)}},false);this.canvas.addEventListener("mouseup",function(e){t.mouseUp(e)},false);this.canvas.addEventListener("wheel",function(e){t.mouseWheel(e)},false);this.canvas.addEventListener("contextmenu",function(e){e.preventDefault()},false)};this.getCanvas=function(){if(this.canvas==null){this.canvas=document.getElementById(this.id+"-canvas");if(this.canvas!=null){this.initEvents()}}return this.canvas};this.contextMenu=function(e){this.trigger("contextmenu",e)};this.mouseDownVScroll=function(e,t,i){if(i<this.vScrollBarPosition){this.setYScroll(this.scrollY-20)}else if(i>this.vScrollBarPosition+this.vScrollBarPositionHeight){this.setYScroll(this.scrollY+20)}else{this.vScroll=true}};this.mouseDownHScroll=function(e,t,i){if(t<this.hScrollBarPosition){this.setXScroll(this.scrollX-20)}else if(t>this.hScrollBarPosition+this.hScrollBarPositionWidth){this.setXScroll(this.scrollX+20)}else{this.hScroll=true}};this.setButtons=function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){if(UI.os=="Mac OS"){this.buttons=2}}};this.mouseDown=function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;var r=0;this.buttons=1;if(!UI.isMobile.any()){r=e.button;this.setButtons(e);if(this.buttons&2){return}if(this.buttons&1){this.leftMouseUp=false}this.mouseIsDown=true}this.mouseDownAtScrollX=this.scrollX;this.mouseDownAtScrollY=this.scrollY;this.mouseDownAtY=i;this.mouseDownAtX=t;if(t>this.width-this.vScrollBarWidth&&i<this.height){return this.mouseDownVScroll(r,t,i)}if(t>0&&i>this.height-this.hScrollBarHeight){return this.mouseDownHScroll(r,t,i)}t+=this.scrollX;i+=this.scrollY;this.mouseDownX=t;this.mouseDownY=i;this.trigger("mousedown",e)};this.dblClick=function(e){this.trigger("dblclick",e)};this.mouseWheel=function(e,t){e.stopPropagation();e.preventDefault();var i=normalizeWheel(e);var r=6;this.setYScroll(this.scrollY+i.spinY*r);this.setXScroll(this.scrollX+i.spinX*r)};this.dragView=function(e,t,i,r){this.setYScroll(this.scrollY-r);this.setXScroll(this.scrollX-i)};this.mouseMoveVScroll=function(e,t,i,r){var a=this.vScrollBarHeight/this.contentHeight;var s=(t-this.mouseDownAtY)/a;this.setYScroll(this.mouseDownAtScrollY+s)};this.mouseMoveHScroll=function(e,t,i,r){var a=this.hScrollBarWidth/this.contentWidth;var s=(e-this.mouseDownAtX)/a;this.setXScroll(this.mouseDownAtScrollX+s)};this.mouseMove=function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;var r=t-this.lastMouseX;var a=i-this.lastMouseY;this.lastMouseX=t;this.lastMouseY=i;var s=false;if(this.buttons&4){UI.setCursor("drag-scroll");this.dragView(t,i,r,a);return}if(this.hScroll){this.mouseMoveHScroll(t,i,r,a);return}if(this.vScroll){this.mouseMoveVScroll(t,i,r,a);return}this.xScrollSpeed=0;this.yScrollSpeed=0;if(t>this.width-this.vScrollBarWidth&&i<this.canvas.height){UI.setCursor("default");return}if(t>0&&i<this.hScrollBarHeight){UI.setCursor("default");return}this.trigger("mousemove",e)};this.mouseUp=function(e){this.xScrollSpeed=0;this.yScrollSpeed=0;this.vScroll=false;this.hScroll=false;this.mouseDownX=false;this.mouseDownY=false;this.mouseIsDown=false;if(!UI.isMobile.any()){this.setButtons(e)}else{this.buttons=0}UI.setCursor("default");this.trigger("mouseup",e)};this.setXScroll=function(e){var t=this.viewWidth;if(e+t>this.contentWidth){e=this.contentWidth-t}if(e<0){e=0}this.scrollX=e};this.scrollToX=function(e){this.setXScroll(e)};this.scrollToY=function(e){this.setYScroll(e)};this.setYScroll=function(e){var t=this.viewHeight;if(e+t>this.contentHeight){e=this.contentHeight-t}if(e<0){e=0}this.scrollY=e};this.calculateScroll=function(){this.viewWidth=this.width;this.viewHeight=this.height;if(this.contentHeight<=this.viewHeight){this.vScrollBarWidth=0}else{this.vScrollBarWidth=styles.ui.scrollbarWidth;this.viewWidth=this.width-this.vScrollBarWidth}if(this.contentWidth<=this.viewWidth){this.hScrollBarHeight=0}else{this.hScrollBarHeight=styles.ui.scrollbarWidth;this.viewHeight=this.height-this.hScrollBarHeight;if(this.vScrollBarWidth===0&&this.contentHeight>this.viewHeight){this.vScrollBarWidth=styles.ui.scrollbarWidth;this.viewWidth=this.width-this.vScrollBarWidth}}if(this.scrollY+this.viewHeight>this.contentHeight){this.scrollY=this.contentHeight-this.viewHeight;if(this.scrollY<0){this.scrollY=0}}if(this.viewWidth+this.scrollX>this.contentWidth){this.scrollX=this.contentWidth-this.viewWidth;if(this.scrollX<0){this.scrollX=0}}this.vScrollBarHeight=this.viewHeight;this.vScrollBarPositionHeight=this.vScrollBarHeight*this.viewHeight/this.contentHeight;if(this.vScrollBarPositionHeight>this.vScrollBarHeight){this.vScrollBarPositionHeight=this.vScrollBarHeight}if(this.vScrollBarPositionHeight<4){this.vScrollBarPositionHeight=4}this.vScrollBarPosition=this.scrollY*this.vScrollBarHeight/this.contentHeight;this.hScrollBarWidth=this.viewWidth;this.hScrollBarPositionWidth=this.hScrollBarWidth*this.viewWidth/this.contentWidth;if(this.hScrollBarPositionWidth>this.hScrollBarWidth){this.hScrollBarPositionWidth=this.hScrollBarWidth}this.hScrollBarPosition=this.scrollX*this.hScrollBarWidth/this.contentWidth};this.setContentHeight=function(e){if(e!=this.contentHeight){this.contentHeight=e;this.render()}};this.getWidth=function(){return this.canvas.width};this.getHeight=function(){return this.canvas.height};this.setScrollY=function(e){this.scrollY=e;this.calculateScroll()};this.getScrollY=function(){return this.scrollY};this.getScrollX=function(){return this.scrollX};this.resize=function(){if(this.canvas==null){this.getCanvas();if(!this.canvas){return}}var e=$("#"+this.id);var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvasScale=UI.devicePixelRatio;this.canvas.width=this.width*this.canvasScale;this.canvas.height=this.height*this.canvasScale;this.width=this.canvas.width/this.canvasScale;this.height=this.canvas.height/this.canvasScale;this.viewWidth=this.width-this.vScrollBarWidth;this.viewHeight=this.height-this.hScrollBarHeight;this.contentWidth=this.viewWidth;this.trigger("resize")};this.getScale=function(){return this.canvasScale},this.getElementId=function(){return this.id},this.getContext=function(){if(this.canvas==null){this.getCanvas();if(this.canvas==null){return}}this.context=this.canvas.getContext("2d",{alpha:false});return this.context};this.draw=function(e){this.context.fillStyle="#ee3344";this.context.fillRect(0,0,this.canvas.width,this.canvas.height)};this.render=function(){if(this.canvas==null){this.getCanvas();if(this.canvas==null){return}}this.context=this.canvas.getContext("2d",{alpha:false});this.calculateScroll();this.draw(this.context);this.context.fillStyle=styles.ui.scrollbarHolder;if(this.hScrollBarPosition>0&&this.hScrollBarWidth>0){this.context.fillRect(0,(this.height-this.hScrollBarHeight)*this.canvasScale,this.viewWidth*this.canvasScale,this.hScrollBarHeight*this.canvasScale);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.hScrollBarPosition*this.canvasScale,(this.height-this.hScrollBarHeight+1)*this.canvasScale,this.hScrollBarPositionWidth*this.canvasScale,(this.hScrollBarHeight-2)*this.canvasScale)}if(this.vScrollBarPositionHeight>0&&this.vScrollBarWidth>0){this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect((this.width-this.vScrollBarWidth)*this.canvasScale,0,this.vScrollBarWidth*this.canvasScale,this.viewHeight*this.canvasScale);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect((this.width-this.vScrollBarWidth+1)*this.canvasScale,this.vScrollBarPosition*this.canvasScale,(this.vScrollBarWidth-2)*this.canvasScale,this.vScrollBarPositionHeight*this.canvasScale)}}};UI.registerComponentType("UI.CanvasScrollPanel",UI.CanvasScrollPanel);UI.DialogResizeMouseDown=function(e,t,i){var r=UI.components[i];r.mouseDownX=e.pageX;r.mouseDownY=e.pageY;r.mouseDownDialogWidth=r.width;r.mouseDownDialogHeight=r.height;r.mouseDownDialogX=r.left;r.mouseDownDialogY=r.top;r.mouseDownOn=t;var a="default";switch(t){case"northresize":a="n-resize";break;case"northeastresize":a="ne-resize";break;case"eastresize":a="e-resize";break;case"southeastresize":a="se-resize";break;case"southresize":a="s-resize";break;case"southwestresize":a="sw-resize";break;case"westresize":a="w-resize";break;case"northwestresize":a="nw-resize";break}UI.captureMouse(r,{cursor:a});return false};UI.DialogTitleMouseDown=function(e,t){var i=UI.components[t];i.mouseDownX=e.pageX;i.mouseDownY=e.pageY;i.mouseDownOn="titlebar";i.mouseDownDialogX=i.left;i.mouseDownDialogY=i.top;UI.captureMouse(i,{cursor:"move"});return false};var g_dialogZIndex=1e3;var g_dialogStack=new Array;UI.Dialog=function(e){this.init=function(e){this.element=null;this.args=e;this.top=10;this.left=10;this.width=900;if(e.width){this.width=e.width}this.height=560;if(e.height){this.height=e.height}this.showCloseButton=true;if(typeof e.showCloseButton!=="undefined"){this.showCloseButton=false}if(typeof e.fullScreen!="undefined"&&e.fullScreen){var t=UI.getScreenWidth();var i=UI.getScreenHeight();this.width=t-10;this.height=i-10;if(typeof e.maxWidth!="undefined"&&this.width>e.maxWidth){this.width=e.maxWidth}if(typeof e.maxHeight!="undefined"&&this.height>e.maxHeight){this.height=e.maxHeight}}this.mouseDownX=0;this.mouseDownY=0;this.mouseDownOn=false;this.components=new Array;this.buttons=new Array;this.closeButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-599-menu-close.svg">',style:"padding: 1px 4px",cssclass:"ui-button ui-dialog-close-button ui-button-danger"});this.element=this.getElement();document.body.append(this.element);$(".ui-mouseevents").on("mouseenter",function(e){var t=$(this).attr("id");t=t.replace("-content","");if(UI.components.hasOwnProperty(t)){var i=UI.components[t];UI.mouseInComponent=i;if(typeof i.mouseEnter!=="undefined"){i.mouseEnter(e)}}});$(".ui-mouseevents").on("mouseleave",function(e){var t=$(this).attr("id");t=t.replace("-content","");if(UI.components.hasOwnProperty(t)){var i=UI.components[t];UI.mouseInComponent=null;if(typeof i.mouseLeave!=="undefined"){i.mouseLeave(e)}}})};this.add=function(e){this.components.push(e);document.getElementById(this.id+"-content").append(e.getElement())};this.addButton=function(e){var t=document.getElementById(this.id+"-buttons");if((UI.os=="Mac OS"||UI.isMobile.any())&&typeof t.prepend!="undefined"){this.buttons.unshift(e);t.prepend(e.getElement())}else{this.buttons.push(e);t.append(e.getElement())}};this.resizeDialog=function(e,t){var i=UI.getScreenWidth();var r=UI.getScreenHeight();if(this.mouseDownOn=="eastresize"||this.mouseDownOn=="northeastresize"||this.mouseDownOn=="southeastresize"){var a=this.mouseDownDialogWidth+e;if(a<160){a=160}if(this.left+a<i-12){this.width=a}else{this.width=i-12-this.left}$("#"+this.id).css("width",this.width)}if(this.mouseDownOn=="westresize"||this.mouseDownOn=="northwestresize"||this.mouseDownOn=="southwestresize"){var s=this.mouseDownDialogX+e;if(s>8){}else{e=-this.mouseDownDialogX+8}this.left=this.mouseDownDialogX+e;this.width=this.mouseDownDialogWidth-e;$("#"+this.id).css("left",this.left);$("#"+this.id).css("width",this.width)}if(this.mouseDownOn=="northresize"||this.mouseDownOn=="northeastresize"||this.mouseDownOn=="northwestresize"){var o=this.mouseDownDialogY+t;if(o>8){}else{t=-this.mouseDownDialogY+8}this.top=this.mouseDownDialogY+t;this.height=this.mouseDownDialogHeight-t;$("#"+this.id).css("height",this.height);$("#"+this.id).css("top",this.top)}if(this.mouseDownOn=="southresize"||this.mouseDownOn=="southeastresize"||this.mouseDownOn=="southwestresize"){var l=this.mouseDownDialogHeight+t;if(l<80){l=80}if(this.top+l<r-12){this.height=l}else{this.height=r-12-this.top}$("#"+this.id).css("height",this.height)}this.trigger("resize");for(var n=0;n<this.components.length;n++){if(typeof this.components[n].resize!="undefined"){this.components[n].resize()}}};this.setWidth=function(e){this.width=e;$("#"+this.id).css("width",this.width)};this.setHeight=function(e){this.height=e;$("#"+this.id).css("height",this.height)};this.mouseDown=function(e){this.trigger("mousedown",e)};this.mouseMove=function(e){var t=e.pageX;var i=e.pageY;var r=e.pageX-this.mouseDownX;var a=e.pageY-this.mouseDownY;var s=UI.getScreenWidth();var o=UI.getScreenHeight();if(this.mouseDownOn=="titlebar"){if(this.mouseDownDialogY+a>4){if(this.mouseDownDialogY+this.height+a<o-12){this.top=this.mouseDownDialogY+a}else{this.top=o-12-this.height}}else{this.top=4}$("#"+this.id).css("top",this.top+"px");if(this.mouseDownDialogX+r>4){if(this.mouseDownDialogX+this.width+r<s-12){this.left=this.mouseDownDialogX+r}else{this.left=s-12-this.width}}else{this.left=4}$("#"+this.id).css("left",this.left+"px");return}else if(this.mouseDownOn!==false){this.resizeDialog(r,a);return}this.trigger("mousemove",e)};this.mouseUp=function(e){var t=e.pageX-this.mouseDownX;var i=e.pageY-this.mouseDownY;if(this.mouseDownOn=="titlebar"){this.mouseDownOn=false;return}else if(this.mouseDownOn!==false){this.mouseDownOn=false;return}this.trigger("mouseup",e);this.mouseDownOn=false};this.title="New Window";if(e.title){this.title=e.title}this.getElement=function(){if(this.element){return this.element}this.backgroundElement=document.createElement("div");this.backgroundElement.setAttribute("id",this.id+"-background");this.backgroundElement.setAttribute("class","ui-dialog-background");document.body.append(this.backgroundElement);this.element=document.createElement("div");this.element.setAttribute("id",this.id);this.element.setAttribute("class","ui-dialog");this.element.setAttribute("style","display: none; width: "+this.width+"px; height: "+this.height+"px; top: "+this.top+"px; left: "+this.left+"px; z-index: 1000");this.element.innerHTML=this.getInnerHTML();return this.element};this.getInnerHTML=function(){var e="";var t=4;e+='  <div id="'+this.id+"northresize\" onmousedown=\"return UI.DialogResizeMouseDown(event, 'northresize', '"+this.id+'\')" style=" position: absolute; top: 0; left: '+t+"px; right: "+t+"px; height: "+t+'px; cursor: n-resize"></div>';e+='  <div id="'+this.id+"northeastresize\" onmousedown=\"return UI.DialogResizeMouseDown(event, 'northeastresize', '"+this.id+'\')" style="position: absolute; top: 0; right: 0; width: '+t+"px; height: "+t+'px; cursor: ne-resize"></div>';e+='  <div id="'+this.id+"eastresize\" onmousedown=\"return UI.DialogResizeMouseDown(event, 'eastresize', '"+this.id+'\')" style=" position: absolute; top: '+t+"px; bottom: "+t+"px; right: 0px; width: "+t+'px; cursor: e-resize"></div>';e+='  <div id="'+this.id+"southeastresize\" onmousedown=\"return UI.DialogResizeMouseDown(event, 'southeastresize', '"+this.id+'\')" style="position: absolute; bottom: 0; right: 0; width: '+t+"px; height: "+t+'px; cursor: se-resize"></div>';e+='  <div id="'+this.id+"southresize\" onmousedown=\"return UI.DialogResizeMouseDown(event, 'southresize', '"+this.id+'\')" style="position: absolute; bottom: 0; left: '+t+"px; right: "+t+"px; height: "+t+'px; cursor: s-resize"></div>';e+='  <div id="'+this.id+"southwestresize\" onmousedown=\"return UI.DialogResizeMouseDown(event, 'southwestresize', '"+this.id+'\')" style="position: absolute; bottom: 0; left: 0; width: '+t+"px; height: "+t+'px; cursor: sw-resize"></div>';e+='  <div id="'+this.id+"westresize\" onmousedown=\"return UI.DialogResizeMouseDown(event, 'westresize', '"+this.id+'\')" style="position: absolute; top: '+t+"px; bottom: "+t+"px; left: 0px; width: "+t+'px; cursor: w-resize"></div>';e+='  <div id="'+this.id+"northwestresize\" onmousedown=\"return UI.DialogResizeMouseDown(event, 'northwestresize', '"+this.id+'\')" style=" position: absolute; top: 0; left: 0; width: '+t+"px; height: "+t+'px; cursor: nw-resize"></div>';e+='  <div id="'+this.id+'titlebar" class="ui-dialog-titlebar">';e+='    <div id="'+this.id+'titlebaricon" class="ui-dialog-titlebar-icon">o</div>';e+='    <div id="'+this.id+'titleheading" class="ui-dialog-titlebar-heading" onmousedown="return UI.DialogTitleMouseDown(event, \''+this.id+"')\" >";e+=this.title;e+="    </div>";e+='    <div id="'+this.id+'titlebarclose" onclick="UI.DialogClose(\''+this.id+'\')" class="ui-dialog-titlebar-close">';if(this.showCloseButton){e+=this.closeButton.getHTML()}e+="    </div>";e+="  </div>";e+='  <div id="'+this.id+'-content" class="ui-dialog-content ui-mouseevents" ';e+=">";for(var i=0;i<this.components.length;i++){e+=this.components[i].getHTML()}e+="  </div>";e+='  <div id="'+this.id+'-buttons" class="ui-dialog-buttons" >';for(var i=0;i<this.buttons.length;i++){e+="&nbsp;&nbsp;"+this.buttons[i].getHTML()}e+="  </div>";return e};this.getHTML=function(){var e="";e+='<div id="'+this.id+'-background" class="ui-dialog-background"></div>';e+='<div id="'+this.id+'" class="ui-dialog" style="display: none; width: '+this.width+"px; height: "+this.height+"px; top: "+this.top+"px; left: "+this.left+'px; z-index: 1000">';var t=4;e+='  <div id="'+this.id+"northresize\" onmousedown=\"return UI.DialogResizeMouseDown('northresize', '"+this.id+'\')" style=" position: absolute; top: 0; left: '+t+"px; right: "+t+"px; height: "+t+'px; cursor: n-resize"></div>';e+='  <div id="'+this.id+"northeastresize\" onmousedown=\"return UI.DialogResizeMouseDown('northeastresize', '"+this.id+'\')" style="position: absolute; top: 0; right: 0; width: '+t+"px; height: "+t+'px; cursor: ne-resize"></div>';e+='  <div id="'+this.id+"eastresize\" onmousedown=\"return UI.DialogResizeMouseDown('eastresize', '"+this.id+'\')" style=" position: absolute; top: '+t+"px; bottom: "+t+"px; right: 0px; width: "+t+'px; cursor: e-resize"></div>';e+='  <div id="'+this.id+"southeastresize\" onmousedown=\"return UI.DialogResizeMouseDown('southeastresize', '"+this.id+'\')" style="position: absolute; bottom: 0; right: 0; width: '+t+"px; height: "+t+'px; cursor: se-resize"></div>';e+='  <div id="'+this.id+"southresize\" onmousedown=\"return UI.DialogResizeMouseDown('southresize', '"+this.id+'\')" style="position: absolute; bottom: 0; left: '+t+"px; right: "+t+"px; height: "+t+'px; cursor: s-resize"></div>';e+='  <div id="'+this.id+"southwestresize\" onmousedown=\"return UI.DialogResizeMouseDown('southwestresize', '"+this.id+'\')" style="position: absolute; bottom: 0; left: 0; width: '+t+"px; height: "+t+'px; cursor: sw-resize"></div>';e+='  <div id="'+this.id+"westresize\" onmousedown=\"return UI.DialogResizeMouseDown('westresize', '"+this.id+'\')" style="position: absolute; top: '+t+"px; bottom: "+t+"px; left: 0px; width: "+t+'px; cursor: w-resize"></div>';e+='  <div id="'+this.id+"northwestresize\" onmousedown=\"return UI.DialogResizeMouseDown('northwestresize', '"+this.id+'\')" style=" position: absolute; top: 0; left: 0; width: '+t+"px; height: "+t+'px; cursor: nw-resize"></div>';e+='  <div id="'+this.id+'titlebar" class="ui-dialog-titlebar">';e+='    <div id="'+this.id+'titlebaricon" class="ui-dialog-titlebar-icon">o</div>';e+='    <div id="'+this.id+'titleheading" class="ui-dialog-titlebar-heading" onmousedown="return UI.DialogTitleMouseDown(\''+this.id+"')\" >";e+=this.title;e+="    </div>";e+='    <div id="'+this.id+'titlebarclose" onclick="UI.DialogClose(\''+this.id+'\')" class="ui-dialog-titlebar-close">';if(this.showCloseButton){e+=this.closeButton.getHTML()}e+="</div>";e+="  </div>";e+='  <div id="'+this.id+'content" class="ui-dialog-content" ';e+=">";for(var i=0;i<this.components.length;i++){e+=this.components[i].getHTML()}e+="  </div>";e+='  <div id="'+this.id+'buttons" class="ui-dialog-buttons" >';for(var i=0;i<this.buttons.length;i++){e+="&nbsp;&nbsp;"+this.buttons[i].getHTML()}e+="  </div>";e+="</div>";return e};this.fitContent=function(){};this.setTitle=function(e){this.title=e;$("#"+this.id+"titleheading").html(e)};this.show=function(){$("#"+this.id+"-background").css("z-index",g_dialogZIndex);$("#"+this.id+"-background").fadeIn(200);g_dialogZIndex++;$("#"+this.id).css("z-index",g_dialogZIndex);$("#"+this.id).fadeIn(100);g_dialogZIndex++;var e=$(window).height();var t=$(window).width();var i=this.width;var r=this.height;if(UI.isMobile.any()){this.top=0;this.top=40;if(this.top<15){this.top=0}i+=10}else{this.top=20}this.left=(t-i)/2;if(this.top+r>e&&e>300){this.height=e-30;$("#"+this.id).css("height",this.height)}if(this.left+i>t&&t>300){this.width=t-38;this.left=15;$("#"+this.id).css("width",this.width)}$("#"+this.id).css("top",this.top+"px");$("#"+this.id).css("left",this.left+"px");g_dialogStack.push(this)};this.close=function(){this.trigger("close");$("#"+this.id+"-background").fadeOut(200);$("#"+this.id).fadeOut(100);g_dialogZIndex-=2;g_dialogStack.pop()}};UI.DialogClose=function(e){UI.closeDialog()};UI.registerComponentType("UI.Dialog",UI.Dialog);UI.MobilePanel=function(e){this.init=function(e){this.element=null;this.args=e;this.top=10;this.left=10;this.width=900;if(e.width){this.width=e.width}this.height=560;if(e.height){this.height=e.height}if(typeof e.fullScreen!="undefined"&&e.fullScreen){var t=UI.getScreenWidth();var i=UI.getScreenHeight();this.width=t-10;this.height=i-10;if(typeof e.maxWidth!="undefined"&&this.width>e.maxWidth){this.width=e.maxWidth}if(typeof e.maxHeight!="undefined"&&this.height>e.maxHeight){this.height=e.maxHeight}}this.mouseDownX=0;this.mouseDownY=0;this.mouseDownOn=false;this.components=new Array;this.buttons=new Array;this.closeButton=UI.create("UI.Button",{text:'<span style="vertical-align: 2px; line-height: 10px">x</span>',style:"padding: 1px 4px",cssclass:"ui-dialog-close-button"});this.element=this.getElement();document.body.append(this.element);$("#"+this.id+"titlebar").on("touchmove",function(e){e.preventDefault()})};this.add=function(e){this.components.push(e);document.getElementById(this.id+"-content").append(e.getElement())};this.addButton=function(e){var t=document.getElementById(this.id+"-buttons");if((UI.os=="Mac OS"||UI.isMobile.any())&&typeof t.prepend!="undefined"){this.buttons.unshift(e);t.prepend(e.getElement())}else{this.buttons.push(e);t.append(e.getElement())}};this.resizeDialog=function(e,t){if(this.mouseDownOn=="eastresize"||this.mouseDownOn=="northeastresize"||this.mouseDownOn=="southeastresize"){this.width+=e;$("#"+this.id).css("width",this.width)}if(this.mouseDownOn=="westresize"||this.mouseDownOn=="northwestresize"||this.mouseDownOn=="southwestresize"){this.left+=e;this.width-=e;$("#"+this.id).css("left",this.left);$("#"+this.id).css("width",this.width)}if(this.mouseDownOn=="northresize"||this.mouseDownOn=="northeastresize"||this.mouseDownOn=="northwestresize"){this.top+=t;this.height-=t;$("#"+this.id).css("height",this.height);$("#"+this.id).css("top",this.top)}if(this.mouseDownOn=="southresize"||this.mouseDownOn=="southeastresize"||this.mouseDownOn=="southwestresize"){this.height+=t;$("#"+this.id).css("height",this.height)}this.trigger("resize")};this.setWidth=function(e){this.width=e;$("#"+this.id).css("width",this.width)};this.setHeight=function(e){this.height=e;$("#"+this.id).css("height",this.height)};this.mouseDown=function(e){this.trigger("mousedown",e)};this.mouseMove=function(e){var t=e.pageX;var i=e.pageY;var r=e.pageX-this.mouseDownX;var a=e.pageY-this.mouseDownY;if(this.mouseDownOn=="titlebar"){this.top=this.top+a;this.left=this.left+r;$("#"+this.id).css("top",this.top+"px");$("#"+this.id).css("left",this.left+"px");this.mouseDownX=t;this.mouseDownY=i;return}else if(this.mouseDownOn!==false){this.resizeDialog(r,a);this.mouseDownX=t;this.mouseDownY=i;return}this.trigger("mousemove",e)};this.mouseUp=function(e){var t=e.pageX-this.mouseDownX;var i=e.pageY-this.mouseDownY;if(this.mouseDownOn=="titlebar"){this.top=this.top+i;this.left=this.left+t;$("#"+this.id).css("top",this.top+"px");$("#"+this.id).css("left",this.left+"px");this.mouseDownOn=false;return}else if(this.mouseDownOn!==false){this.resizeDialog(t,i);this.mouseDownOn=false;return}this.trigger("mouseup",e);this.mouseDownOn=false};this.title="New Window";if(e.title){this.title=e.title}this.getElement=function(){if(this.element){return this.element}this.backgroundElement=document.createElement("div");this.backgroundElement.setAttribute("id",this.id+"-background");this.backgroundElement.setAttribute("class","ui-dialog-background");document.body.append(this.backgroundElement);this.element=document.createElement("div");this.element.setAttribute("id",this.id);this.element.setAttribute("class","ui-mobilepanel");this.element.setAttribute("style","display: none; width: "+this.width+"px; height: "+this.height+"px; top: "+this.top+"px; left: "+this.left+"px; z-index: 1000");this.element.innerHTML=this.getInnerHTML();return this.element};this.getInnerHTML=function(){var e="";var t=4;e+='  <div id="'+this.id+'titlebar" class="ui-mobilepanel-titlebar">';e+='  <div class="ui-mobile-button" style="width: 48px; height: 48px; display: inline-block" onclick="UI.MobilePanelClose(\''+this.id+'\')"><img style="; width: 42px; height: 42px" src="icons/material/ic_arrow_back_48px.svg"/></div>';e+='  <div id="'+this.id+'titleheading" class="ui-mobilepanel-titlebar-heading">'+this.title+"</div>";e+='  <div id="'+this.id+'-buttons" class="ui-mobilepanel-titlebar-buttons">';for(var i=0;i<this.buttons.length;i++){e+="&nbsp;&nbsp;"+this.buttons[i].getHTML()}e+="  </div>";e+="  </div>";e+='  <div id="'+this.id+'-content" class="ui-mobilepanel-content ui-mouseevents" ';e+=">";for(var i=0;i<this.components.length;i++){e+=this.components[i].getHTML()}e+="  </div>";return e};this.getHTML=function(){var e="";e+='<div id="'+this.id+'-background" class="ui-dialog-background"></div>';e+='<div id="'+this.id+'" class="ui-dialog" style="display: none; width: '+this.width+"px; height: "+this.height+"px; top: "+this.top+"px; left: "+this.left+'px; z-index: 1000">';var t=4;e+='  <div id="'+this.id+"northresize\" onmousedown=\"return UI.DialogResizeMouseDown('northresize', '"+this.id+'\')" style=" position: absolute; top: 0; left: '+t+"px; right: "+t+"px; height: "+t+'px; cursor: n-resize"></div>';e+='  <div id="'+this.id+"northeastresize\" onmousedown=\"return UI.DialogResizeMouseDown('northeastresize', '"+this.id+'\')" style="position: absolute; top: 0; right: 0; width: '+t+"px; height: "+t+'px; cursor: ne-resize"></div>';e+='  <div id="'+this.id+"eastresize\" onmousedown=\"return UI.DialogResizeMouseDown('eastresize', '"+this.id+'\')" style=" position: absolute; top: '+t+"px; bottom: "+t+"px; right: 0px; width: "+t+'px; cursor: e-resize"></div>';e+='  <div id="'+this.id+"southeastresize\" onmousedown=\"return UI.DialogResizeMouseDown('southeastresize', '"+this.id+'\')" style="position: absolute; bottom: 0; right: 0; width: '+t+"px; height: "+t+'px; cursor: se-resize"></div>';e+='  <div id="'+this.id+"southresize\" onmousedown=\"return UI.DialogResizeMouseDown('southresize', '"+this.id+'\')" style="position: absolute; bottom: 0; left: '+t+"px; right: "+t+"px; height: "+t+'px; cursor: s-resize"></div>';e+='  <div id="'+this.id+"southwestresize\" onmousedown=\"return UI.DialogResizeMouseDown('southwestresize', '"+this.id+'\')" style="position: absolute; bottom: 0; left: 0; width: '+t+"px; height: "+t+'px; cursor: sw-resize"></div>';e+='  <div id="'+this.id+"westresize\" onmousedown=\"return UI.DialogResizeMouseDown('westresize', '"+this.id+'\')" style="position: absolute; top: '+t+"px; bottom: "+t+"px; left: 0px; width: "+t+'px; cursor: w-resize"></div>';e+='  <div id="'+this.id+"northwestresize\" onmousedown=\"return UI.DialogResizeMouseDown('northwestresize', '"+this.id+'\')" style=" position: absolute; top: 0; left: 0; width: '+t+"px; height: "+t+'px; cursor: nw-resize"></div>';e+='  <div id="'+this.id+'titlebar" class="ui-dialog-titlebar">';e+='    <div id="'+this.id+'titlebaricon" class="ui-dialog-titlebar-icon">o</div>';e+='    <div id="'+this.id+'titleheading" class="ui-dialog-titlebar-heading" onmousedown="return UI.DialogTitleMouseDown(\''+this.id+"')\" >";e+=this.title;e+="    </div>";e+='    <div id="'+this.id+'titlebarclose" onclick="UI.DialogClose(\''+this.id+'\')" class="ui-mobile-button">';e+=this.closeButton.getHTML();e+="</div>";e+="  </div>";e+='  <div id="'+this.id+'content" class="ui-mobilepanel-content" ';e+=">";for(var i=0;i<this.components.length;i++){e+=this.components[i].getHTML()}e+="  </div>";e+='  <div id="'+this.id+'buttons" class="ui-dialog-buttons" style="position: absolute; bottom:0; height: 0">';for(var i=0;i<this.buttons.length;i++){e+="&nbsp;&nbsp;"+this.buttons[i].getHTML()}e+="  </div>";e+="</div>";return e};this.fitContent=function(){};this.setTitle=function(e){this.title=e;$("#"+this.id+"titleheading").html(e)};this.show=function(){$("#"+this.id+"-background").css("z-index",g_dialogZIndex);$("#"+this.id+"-background").fadeIn(1e3);g_dialogZIndex++;this.width=UI.getScreenWidth();this.height=UI.getScreenHeight();$("#"+this.id).css("width",this.width+"px");$("#"+this.id).css("height",this.height+"px");if(true){this.left=0;this.top=0;$("#"+this.id).css("top",this.top+"px");$("#"+this.id).css("left","-"+this.width+"px");$("#"+this.id).css("z-index",g_dialogZIndex);g_dialogZIndex++;$("#"+this.id).show();$("#"+this.id).animate({left:"0px",top:"0px"},200,function(){});g_dialogZIndex++}else{$("#"+this.id).css("z-index",g_dialogZIndex);$("#"+this.id).show();g_dialogZIndex++;this.left=0;this.top=0;$("#"+this.id).css("top",this.top+"px");$("#"+this.id).css("left",this.left+"px")}g_dialogStack.push(this)};this.close=function(){var e=this;if(true){$("#"+this.id).animate({left:"-"+this.width+"px",top:"0px"},200,function(){console.log("CLOSED!");$("#"+this.id).hide();$("#"+this.id+"-background").fadeOut(100);e.trigger("close")})}else{$("#"+this.id).hide();$("#"+this.id+"-background").hide()}g_dialogZIndex-=2;g_dialogStack.pop()}};UI.MobilePanelClose=function(e){UI.closeDialog()};UI.registerComponentType("UI.MobilePanel",UI.MobilePanel);UI.Button=function(e){this.init=function(e){this.args=e;this.enabled=true;if(typeof e.enabled!="undefined"){this.enabled=e.enabled}this.cssclass=null;if(e.cssclass){this.cssclass=e.cssclass}this.style=null;if(e.style){this.style=e.style}this.icon=null;if(e.icon){this.icon=e.icon}this.colour="";if(e.colour){this.colour=e.colour}if(e.color){this.colour=e.color}this.name="";if(e.name){this.name=e.name}this.onclick=null};this.getElement=function(){var t=this;this.element=document.createElement("div");this.element.setAttribute("id",this.id);if(this.enabled){var e="ui-button";if(this.colour!=""){e+=" ui-button-"+this.colour}this.element.setAttribute("class",e)}else{this.element.setAttribute("class","ui-button-disabled")}this.element.onclick=function(e){UI.ButtonClick(t.id)};this.element.innerHTML=this.getInnerHTML();return this.element};this.getInnerHTML=function(){var e="";if(this.icon){e+='<i class="button-icon icon-'+this.icon+'"></i>&nbsp;'}e+=this.args.text;e+='<div class="rippleJS"></div>';return e};this.getHTML=function(){var e="";e+='<div id="'+this.id+'" ';e+=" onclick=\"UI.ButtonClick('"+this.id+"')\" ";if(this.cssclass){e+=' class="'+this.cssclass+'" '}else{if(this.enabled){e+=' class="ui-button';if(this.colour!=""){e+=" ui-button-"+this.colour}e+='" '}else{e+=' class="ui-button-disabled" '}}if(this.style){e+=' style="'+this.style+'" '}e+=">";if(this.icon){e+='<i class="button-icon icon-'+this.icon+'"></i>&nbsp;'}e+=this.args.text;e+='<div class="rippleJS"></div>';e+="</div>";return e};this.click=function(){if(this.enabled){if(this.onclick){this.onclick(this)}if(this.args.onclick){this.args.onclick(this)}this.trigger("click",this)}};this.setEnabled=function(e){this.enabled=e;if(e){$("#"+this.id).removeClass("ui-button-disabled")}else{$("#"+this.id).addClass("ui-button-disabled")}};this.setText=function(e){this.args.text=e;$("#"+this.id+"text").html(e)};this.getText=function(){return this.args.text}};UI.registerComponentType("UI.Button",UI.Button);UI.ButtonMouseDown=function(e){};UI.ButtonClick=function(e){UI.components[e].click()};function domHasClass(e,t){if(e.classList)return e.classList.contains(t);return!!e.className.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))}function domAddClass(e,t){if(e.classList)e.classList.add(t);else if(!domHasClass(e,t))e.className+=" "+t}function domRemoveClass(e,t){if(e.classList)e.classList.remove(t);else if(domHasClass(e,t)){var i=new RegExp("(\\s|^)"+t+"(\\s|$)");e.className=e.className.replace(i," ")}}function uiTreeSyncToggle(e,t,i){var r=UI.components[e];if(r){r.continueSync()}}function uiTreeNodeInserted(e){var t=UI.components[e["treeID"]];var i=e["dragNodeID"];var r=e["dropNodeID"];var a=e["position"];t.moveNode(i,r,a)}function uiTreeNodeMouseClick(e,t){var i=UI.components[e];i.nodeClick(t)}function uiTreeNodeMouseDblClick(e,t){var i=UI.components[e];i.nodeDblClick(t)}function uiTreeNodeContextMenu(e,t,i){var r=UI.components[t];r.nodeContextMenu(i,e);return false}function uiTreeToggleNode(e,t){var i=UI.components[e];i.nodeToggleClick(t)}function uiTreeNodeMouseDown(e,t){var i=UI.components[e];i.treeNodeMouseDown(t);return false}function uiTreeNodeMouseOver(e,t){var i=UI.components[e];i.treeNodeMouseOver(t);return false}function uiTreeNodeMouseOverRow(e,t){var i=UI.components[e];i.treeNodeMouseOverRow(t);return false}function uiTreeNodeMouseOut(e,t){var i=UI.components[e];i.treeNodeMouseOut(t);return false}UI.TreeNode=function(e){this.m_tree=e.tree;this.m_treeID=this.m_tree.id+"-";if(typeof e.id!="undefined"){this.id=e.id}else{this.id=this.m_tree.getNodeID()}this.m_state=0;this.m_label="label";this.m_isLast=true;this.m_isLeaf=true;this.m_icon="file.png";this.m_type="node";this.m_attributes=null;this.m_selected=false;this.m_parent=null;this.m_children=new Array;this.getDepth=function(){var e=0;var t=this.m_parent;while(t!=null){e++;t=t.m_parent}return e};this.getAttribute=function(e){if(this.m_attributes){return this.m_attributes[e]}return null};this.getParentNode=function(){return this.m_parent};this.getPath=function(){var e=this.m_parent;var t=this.m_label;var i=0;while(e!=null){t=e.m_label+"/"+t;e=e.getParentNode();i++;if(i>100){break}}return t};this.getChildCount=function(){return this.m_children.length};this.getChild=function(e){if(e<this.m_children.length){return this.m_children[e]}return null};this.getChildByLabel=function(e){for(var t=0;t<this.m_children.length;t++){if(this.m_children[t].m_label==e){return this.m_children[t]}}return null};this.deleteChildren=function(){for(var e=0;e<this.m_children.length;e++){this.m_tree.deleteNode(this.m_children[e].id)}this.m_children=[]};this.getType=function(){return this.m_type};this.select=function(){this.m_tree.selectNode(this.id)};this.addChild=function(e){if(this.m_state==-1){this.m_state=0}var t=0;if(e.key){t=e.key}else{t=this.m_tree.getNodeID()}var i=this.m_tree.getNode(t,true);i.m_parent=this;if(typeof e.label!="undefined"){i.m_label=e.label}if(typeof e.type!="undefined"){i.m_type=e.type}if(this.m_tree.m_iconMap[i.m_type]){i.m_icon=this.m_tree.m_iconMap[i.m_type]}if(e.attributes){i.m_attributes=e.attributes}i.m_allRead=true;if(typeof e.allRead!="undefined"){i.m_allRead=e.allRead}i.m_lockedForModeration=false;if(typeof e.lockedForModeration!="undefined"){i.m_lockedForModeration=e.lockedForModeration}if(typeof e.isLeaf!="undefined"){i.m_isLeaf=e.isLeaf}this.m_isLeaf=false;i.m_isLast=true;if(this.m_children.length>0){this.m_children[this.m_children.length-1].m_isLast=false}this.m_children[this.m_children.length]=i;return i};this.setKey=function(e){this.m_tree.setNodeKey(e,this)};this.getDragHTML=function(){var e="";var t=this.m_tree.m_imagesDir+this.m_icon;if(this.m_tree.m_getNodeIcon){t=this.m_tree.m_getNodeIcon(this,t)}e+='<img width="18" height="16" style="width: 18px; height: 16px; margin: 0; padding: 0; border: 0" id="node'+this.id+'icon" src="'+t+'"/>';e+='<span style="cursor: default; font-size: 12px; font-family: arial, tahoma, helvetica; position: absolute; top: 0px; padding: 2px; padding-top: 3px" >';e+=this.m_label.replace(/ /g,"&nbsp;");e+="</span>";return e};this.getHTML=function(){var e="";var t=this.m_tree.id+"-";e+='<div id="'+t+"n"+this.id+'" onmousedown="return false" onselectstart="return false">';var i=16;if(this.id==0){i=2}e+='<div id="'+t+"node"+this.id+'row" style="height: '+i+'px; padding: 2px 0 4px 0; position: relative" ';e+=' class="ui-tree-row" onmouseover="uiTreeNodeMouseOverRow(\''+this.m_tree.id+"',"+this.id+')" ';e+="  onclick=\"uiTreeNodeMouseClick('"+this.m_tree.id+"',"+this.id+')" ';e+=" ondblclick=\"uiTreeNodeMouseDblClick('"+this.m_tree.id+"',"+this.id+')" ';e+=" oncontextmenu=\"return uiTreeNodeContextMenu(event, '"+this.m_tree.id+"',"+this.id+')" ';e+=' onselectstart="return false">';e+=this.getNodeHTML();e+="</div>";if(this.m_state==1){e+='<div id="'+t+"node"+this.id+'children" onmousedown="return false" onselectstart="return false">'}else{e+='<div id="'+t+"node"+this.id+'children" style="display: none" onmousedown="return false" onselectstart="return false">'}for(var r=0;r<this.m_children.length;r++){e+=this.m_children[r].getHTML()}e+="</div>";e+="</div>";return e};this.redraw=function(){if(this.id>0){var e=this.getNodeHTML();$("#"+this.m_tree.id+"-node"+this.id+"row").html(e)}if(this.m_state==1){if(this.m_children.length==0){$("#"+this.m_tree.id+"-node"+this.id+"children").hide();this.m_state=0}for(var t=0;t<this.m_children.length;t++){this.m_children[t].redraw()}}};this.getNodeHTML=function(){var e="";var t=this.m_tree.id+"-";if(this.m_parent!=null){var i=this.m_parent;var r="";while(i.m_parent!=null){if(i.m_type!="folder"){e='<div style="width: 10px; height: 16px; margin: 0; padding:0; border: 0; display: inline-block"></div>'+e}else{e='<div style="width: 10px; height: 16px; margin: 0; padding:0; border: 0; display: inline-block"></div>'+e}i=i.m_parent}if(this.m_state==-1||this.m_state==0){r=this.m_tree.m_imagesDir+"plus"}else{r=this.m_tree.m_imagesDir+"minus"}r+=".png";e+='<div style="display: inline-block; width: 2px; height: 16px;">';e+="</div>";if(this.m_type=="folder"){e+='<div style="display: inline-block; width: 16px; height: 16px;">';if(this.m_isLeaf){e+='<img class="ui-tree-toggle" width="8" height="8"  onmousedown="return false" onselectstart="return false" src="'+r+'" id="'+t+"node"+this.id+'toggle" style="margin: 0; padding: 2px 4px 2px 4px; border: 0; width: 8px; height: 8px" border="0"/>'}else{e+='<img  class="ui-tree-toggle" width="8" height="8" onmousedown="return false" onselectstart="return false" src="'+r+'" id="'+t+"node"+this.id+'toggle" style="margin: 0; padding: 2px 4px 2px 4px; border: 0; width: 8px; height: 8px" border="0"/>'}e+="</div>"}else{e+='<div style="display: inline-block; width: 4px; height: 16px;">';e+="</div>"}r=this.m_tree.m_imagesDir+this.m_icon;if(this.m_tree.m_getNodeIcon){r=this.m_tree.m_getNodeIcon(this,r)}var a=this.m_tree.trigger("getnodeicon",this,r);if(typeof a!="undefined"&&a){r=a;if(r.indexOf("/")!=0){r=this.m_tree.m_imagesDir+r}}if(this.m_type!=="folder"){e+='<div style="display: inline-block; width: 16px; height: 16px">';e+='<img class="ui-tree-icon" height="14" style="height: 14px; margin: 0; padding: 0; border: 0" id="'+t+"node"+this.id+'icon" src="'+r+'"  onmouseover="uiTreeNodeMouseOver(\''+this.m_tree.id+"',"+this.id+')" onmouseout="uiTreeNodeMouseOut(\''+this.m_tree.id+"',"+this.id+')" onmousedown="return uiTreeNodeMouseDown(\''+this.m_tree.id+"',"+this.id+')" onselectstart="return false"/>';e+="</div>"}var s="black";if(this.m_selected){}var o=String(this.m_label);if(this.m_tree.m_getNodeLabel){o=this.m_tree.m_getNodeLabel(this,o)}o=o.replace(/ /g,"&nbsp;");var l=this.m_tree.trigger("getnodelabel",this,o);if(typeof l!="undefined"){o=l}var n=3;e+="<div ";if(this.m_type=="folder"){}e+=' class="ui-tree-label" id="'+t+"node"+this.id+'label" style="white-space:nowrap; margin-left: 1px;border: 0px solid black; cursor: default; position: absolute; bottom: '+n+'px; display: inline; font-size: 12px; font-family: arial, tahoma, helvetica;" onmouseover="uiTreeNodeMouseOver(\''+this.m_tree.id+"',"+this.id+')" onmouseout="uiTreeNodeMouseOut(\''+this.m_tree.id+"',"+this.id+')" onmousedown="return uiTreeNodeMouseDown(\''+this.m_tree.id+"',"+this.id+')" onselectstart="return false">';e+=o;e+="</div>"}return e};this.setLabel=function(e){};this.setSelected=function(e){this.m_selected=e;var t=document.getElementById(this.m_treeID+"node"+this.id+"row");var i=document.getElementById(this.m_treeID+"node"+this.id+"label");if(i){if(e){domAddClass(t,"ui-tree-selected-row")}else{domRemoveClass(t,"ui-tree-selected-row")}}};this.refreshChildren=function(){var e="";for(var t=0;t<this.m_children.length;t++){e+=this.m_children[t].getHTML()}var i=document.getElementById(this.m_treeID+"node"+this.id+"children");i.innerHTML=e};this.setDropHighlight=function(e){var t=document.getElementById(this.m_treeID+"node"+this.id+"label");if(t){if(e){t.style.backgroundColor="#555";t.style.color="#fff"}else{t.style.backgroundColor="#fff";t.style.color="#000"}}};this.toggle=function(e,t){var i=document.getElementById(this.m_treeID+"node"+this.id+"children");if(i==null){return}if(this.m_state==-1){this.m_state=1;i.style.display="";this.loadChildren({},e,t)}else if(this.m_state==0){this.m_state=1;i.style.display="";this.m_state=1;if(e){e(this.m_tree.id,this.id,t)}}else if(this.m_state==1){i.style.display="none";this.m_state=0;if(e){e(this.m_tree.id,this.id,t)}}var r=document.getElementById(this.m_treeID+"node"+this.id+"toggle");if(r){var a="plus";if(this.m_state==-1||this.m_state==0){a="plus"}else{a="minus"}a+=".png";r.src=this.m_tree.m_imagesDir+a}}};UI.Tree=function(e){this.init=function(e){this.m_args=e;this.m_nodeIDs=0;this.m_selectedNodeID=-1;this.m_nodes=new Object;this.m_nodeKeys=new Object;this.m_rootPath="/*";if(e.root){this.m_rootPath=e.root}this.m_imagesDir="images/tree/";this.m_iconMap=new Object;this.m_iconMap[""]="folderclosed.png";this.m_iconMap["folder"]="folderclosed.png";this.m_iconMap["Template"]="document.gif";this.m_iconMap["Contact"]="user.gif";this.m_iconMap["Page"]="file.png";this.m_iconMap["color palette"]="file.png";this.m_iconMap["tile set"]="file.png";this.m_iconMap["graphic"]="file.png";this.m_iconMap["music"]="file_type_package.svg";this.m_iconMap["asm"]="file_type_wasm.svg";this.m_iconMap["bin"]="file_type_binary.svg";this.m_iconMap["js"]="file_type_js.svg";this.m_iconMap["json"]="file_type_json.svg";this.m_iconMap["prg"]="file_type_binary.svg";this.m_rootNode=this.getNode(this.getNodeID(),true);this.m_rootNode.m_state=-1;this.m_parent=null;this.m_isControl=false;if(e.uicontrol){this.m_isControl=e.uicontrol}this.m_name=this.id;if(e.name){this.m_name=e.name}this.m_canDrag=true;if(typeof e.candrag!="undefined"){if(e.candrag===false){this.m_canDrag=false}else{this.m_canDrag=e.candrag}}};this.setRoot=function(e){this.m_nodeIDs=0;this.m_selectedNodeID=-1;this.m_nodes=new Object;this.m_nodeKeys=new Object;this.m_rootPath="/*";if(e&&e!=""){this.m_rootPath=e}this.m_rootNode=this.getNode(this.getNodeID(),true);this.m_rootNode.m_state=-1;this.m_parent=null;this.load()};this.getNode=function(e,t){if(!this.m_nodes["n"+e]){if(t){this.m_nodes["n"+e]=new UI.TreeNode({tree:this,id:e})}else{return null}}return this.m_nodes["n"+e]};this.getNodeID=function(){return this.m_nodeIDs++};this.setNodeKey=function(e,t){this.m_nodeKeys[e]=t};this.getNodeFromKey=function(e){if(this.m_nodeKeys.hasOwnProperty(e)){return this.m_nodeKeys[e]}return null};this.getNodeFromPath=function(e){var t=e.split("/");var i=this.m_rootNode;for(var r=0;r<t.length;r++){if(t[r]!=""){i=i.getChildByLabel(t[r]);if(i==null){return null}}}return i};this.load=function(){var e=this.getRootNode();if(e.m_state!=1){e.toggle()}};this.getRootNode=function(){return this.m_rootNode};this.continueSync=function(){if(this.m_syncpath!=""){this.sync(this.m_syncpath)}};this.sync=function(e){this.m_syncpath=e;var t=e.split("/");if(t.length>0){var i=this.m_nodes["n0"];for(var r=0;r<t.length;r++){if(t[r]!=""){if(i.m_state!=1){var a=new Array;a["guidpath"]=e;i.toggle(uiTreeSyncToggle,a);return}i=this.m_nodes["n"+t[r]];if(typeof i=="undefined"){return}if(r==t.length-1){var s=this.m_onnodeselected;this.m_onnodeselected=null;this.selectNode(i.id);this.m_onnodeselected=s}}}}};this.onLoadChildren=function(e){return this.trigger("loadchildren",e)};this.onChildrenLoaded=function(e,t){return this.trigger("childrenloaded",e,t)};this.onLoad=function(){return this.trigger("load")};this.getHTML=function(){var e="";e+='<div id="'+this.id+'" class="ui-tree" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; overflow-x: auto; overflow-y: auto; padding: 0px; margin: 0px; border: 0px solid black"  onmousedown="return false" onselectstart="return false">';e+=this.m_rootNode.getHTML();e+="</div>";var t=this;UI.on("ready",function(){if(t.m_rootPath!="-1"){t.load()}else{t.trigger("ready")}});return e};this.nodeToggleClick=function(e){if(typeof e=="object"&&e.id){e=e.id}if(e>=0){this.trigger("nodetoggleclick",this.m_nodes["n"+e])}};this.nodeContextMenu=function(e,t){if(typeof e=="object"&&e.id){e=e.id}if(e>=0){this.trigger("nodecontextmenu",this.m_nodes["n"+e],t)}};this.nodeClick=function(e){if(typeof e=="object"&&e.id){e=e.id}if(e>=0){this.trigger("nodeclick",this.m_nodes["n"+e])}};this.nodeDblClick=function(e){if(typeof e=="object"&&e.id){e=e.id}if(e>=0){this.trigger("nodedblclick",this.m_nodes["n"+e])}};this.selectNode=function(e){if(typeof e=="object"&&e.id){e=e.id}if(e>=0){if(true){if(this.m_nodes["n"+e]){this.m_nodes["n"+e].setSelected(true)}if(this.m_selectedNodeID!=e&&this.m_selectedNodeID!=-1&&this.m_nodes["n"+this.m_selectedNodeID]){this.m_nodes["n"+this.m_selectedNodeID].setSelected(false)}this.m_selectedNodeID=e;this.trigger("nodeselect",this.m_nodes["n"+e]);if(this.m_isControl){$("#"+this.id+"value").val(this.m_nodes["n"+e].id)}}}};this.deleteNode=function(e){if(e>0){$("#"+this.id+"-"+"n"+e).remove();this.m_nodes["n"+e]=null}};this.m_inDrag=false;this.m_dragTargetNode=null;this.m_dragTargetElement=null;this.m_dragTargetRow=null;this.m_dragTargetPosition=0;this.m_dragNode=null;this.m_mouseDownX=0;this.m_mouseDownY=0;this.treeNodeMouseDown=function(e){this.m_mouseDownX=UI.mouseX;this.m_mouseDownY=UI.mouseY;this.m_dragNode=this.m_nodes["n"+e];if(this.m_canDrag){UI.startDrag(this,this.m_dragNode.getDragHTML(),12,0)}};this.treeNodeMouseOverRow=function(e){if(UI.m_inDrag){if(this.m_dragTargetElement==null){var t=UI.mouseX;var i=UI.mouseY;var r=this.id+"-"+"node"+e+"row";var a=document.getElementById(r);var s=$("#"+r).offset();if(s==null){return}var o=i-s.top;if(o>8){if(this.m_dragTargetRow!=a||this.m_dragTargetPosition!=1){if(this.m_dragTargetRow!=null){this.m_dragTargetRow.style.border="0px"}this.m_dragTargetRow=a;this.m_dragTargetPosition=1;this.m_dragTargetRow.style.borderBottom="1px dotted black"}}else{if(this.m_dragTargetRow!=a||this.m_dragTargetPosition!=-1){if(this.m_dragTargetRow!=null){this.m_dragTargetRow.style.border="0px"}this.m_dragTargetRow=a;this.m_dragTargetPosition=-1;this.m_dragTargetRow.style.borderTop="1px dotted black"}}this.m_dragTargetNode=this.m_nodes["n"+e]}else{if(this.m_dragTargetRow!=null){this.m_dragTargetRow.style.border="0px"}}}};this.treeNodeMouseOver=function(e){if(UI.m_inDrag){var t=this.m_nodes["n"+e];if(this.m_dragTargetNode!=null){this.m_dragTargetNode.setDropHighlight(false);this.m_dragTargetElement=null}if(t){this.m_dragTargetNode=t;this.m_dragTargetPosition=0;this.m_dragTargetElement=document.getElementById(this.id+"-node"+e+"label");t.setDropHighlight(true)}}};this.treeNodeMouseOut=function(e){if(UI.m_inDrag){var t=this.m_nodes["n"+e];if(this.m_dragTargetNode!=null){this.m_dragTargetNode.setDropHighlight(false);this.m_dragTargetElement=null}if(t){t.setDropHighlight(false);this.m_dragTargetNode=null;this.m_dragTargetElement=null}}};this.m_mouseInComponent=false;this.mouseMove=function(){if(UI.m_inDrag){var e=$("#"+this.id).offset();var t=$("#"+this.id).width();var i=$("#"+this.id).height();var r=UI.mouseX;var a=UI.mouseY;if(r>=e.left&&r<=e.left+t&&a>=e.top&&a<=e.top+i){if(!this.m_mouseInComponent){$("#mousecapture").remove();this.m_mouseInComponent=true}}else{if(this.m_mouseInComponent){if(this.m_dragTargetNode!=null){this.m_dragTargetNode.setDropHighlight(false);this.m_dragTargetNode=null}if(this.m_dragTargetRow!=null){this.m_dragTargetRow.style.border="0px"}$("#wtui").append('<div id="mousecapture" style=" position: absolute; top: 0; left: 0; bottom: 0; right: 0; z-index: 10000; "></div>');this.m_mouseInComponent=false}}}};this.mouseUp=function(){this.m_mouseInComponent=false;if(UI.m_inDrag){if(this.m_dragTargetNode!=null){var e=true;var t=this.m_dragTargetNode;while(t!=null){if(t==this.m_dragNode){e=false}t=t.getParentNode()}if(e){var i={treeID:this.id,dragNodeID:this.m_dragNode.id,dropNodeID:this.m_dragTargetNode.id,position:this.m_dragTargetPosition};g_wtuiClient.Insert(this.m_dragNode.id,this.m_dragTargetNode.id,this.m_dragTargetPosition,uiTreeNodeInserted,i)}}if(this.m_dragTargetNode!=null){this.m_dragTargetNode.setDropHighlight(false);this.m_dragTargetNode=null}if(this.m_dragTargetRow!=null){this.m_dragTargetRow.style.border="0px"}this.m_inDrag=false;$("#wtui_dragcomponent").hide()}UI.releaseMouse()};this.moveNode=function(e,t,i){var r=this.m_nodes["n"+e];if(!r){return false}var a=document.getElementById(this.id+"-n"+e);var s=r.getParentNode();var o=document.getElementById(this.id+"-node"+s.id+"children");var l=this.m_nodes["n"+t];if(i==0){var l=this.m_nodes["n"+t];var n=document.getElementById(this.id+"-node"+t+"children");if(l.m_state>=0){n.appendChild(a)}else{o.removeChild(a)}l.m_isLeaf=false;r.m_parent=l;for(var h=0;h<s.m_children.length;h++){if(s.m_children[h].id==r.id){s.m_children.splice(h,1);break}}l.m_children.push(r)}else{var d=this.m_nodes["n"+t];var c=document.getElementById(this.id+"-n"+t);l=d.getParentNode();var n=document.getElementById(this.id+"-node"+l.id+"children");if(i==-1){n.insertBefore(a,c)}else if(i==1){if(c.nextSibling){n.insertBefore(a,c.nextSibling)}else{n.appendChild(r)}}r.m_parent=d.m_parent;for(var h=0;h<s.m_children.length;h++){if(s.m_children[h].id==r.id){s.m_children.splice(h,1);break}}for(var h=0;h<l.m_children.length;h++){if(l.m_children[h].id==t){if(i==-1){l.m_children.splice(h,0,r)}else{l.m_children.splice(h+1,0,r)}break}}}if(s){if(s.m_children.length==0){s.m_isLeaf=true}for(var h=0;h<s.m_children.length;h++){s.m_children[h].m_isLast=h==s.m_children.length-1}s.redraw()}if(l&&l!=s){for(var h=0;h<l.m_children.length;h++){l.m_children[h].m_isLast=h==l.m_children.length-1}l.redraw()}if(l.m_state!=1){l.toggle()}this.trigger("nodemoved",r,s,l,i)};this.getSelectedNode=function(){if(this.m_selectedNodeID<0){return null}return this.m_nodes["n"+this.m_selectedNodeID]}};UI.registerComponentType("UI.Tree",UI.Tree);UI.ProgressBar=function(e){this.init=function(e){this.args=e;this.enabled=true;if(typeof e.enabled!="undefined"){this.enabled=e.enabled}this.cssclass=null;if(e.cssclass){this.cssclass=e.cssclass}this.style=null;if(e.style){this.style=e.style}this.colour="";if(e.colour){this.colour=e.colour}if(e.color){this.colour=e.color}this.name="";if(e.name){this.name=e.name}this.onclick=null};this.getElement=function(){var t=this;this.element=document.createElement("div");this.element.setAttribute("id",this.id);if(this.enabled){var e="ui-button";if(this.colour!=""){e+=" ui-button-"+this.colour}this.element.setAttribute("class",e)}else{this.element.setAttribute("class","ui-button-disabled")}this.element.onclick=function(e){UI.ButtonClick(t.id)};this.element.innerHTML=this.getInnerHTML();return this.element};this.setProgress=function(e){var t=100*e;$("#"+this.id+"-progress").css("width",t+"%")},this.getHTML=function(){var e="";e+='<div id="'+this.id+'" ';if(this.cssclass){e+=' class="'+this.cssclass+'" '}else{e+=' class="ui-progress-bar '+this.cssclass+'" '}e+=">";e+='<div id="'+this.id+'-progress" class="ui-progress-bar-progress"/>';e+="</div>";e+="</div>";return e};this.setEnabled=function(e){this.enabled=e}};UI.registerComponentType("UI.ProgressBar",UI.ProgressBar);var ImageUtils={};ImageUtils.createColorPaletteFromImage=function(e,t){var i={colors:e,method:2,boxSize:[64,64],boxPxls:2,initColors:4096,minHueCols:0,dithKern:null,dithDelta:0,dithSerp:false,palette:[],reIndex:false,useCache:true,cacheFreq:10,colorDist:"euclidean"};var r=new RgbQuant(i);r.sample(t);return r.palette()};ImageUtils.rgbQuant=function(e,t){if(typeof t.colors=="undefined"){t.colors=t.palette.length}var i={colors:256,method:2,boxSize:[64,64],boxPxls:2,initColors:4096,minHueCols:0,dithKern:null,dithDelta:0,dithSerp:false,palette:[],reIndex:false,useCache:true,cacheFreq:10,colorDist:"euclidean"};for(var r in i){if(t.hasOwnProperty(r)&&r!="palette"){i[r]=t[r]}}for(var a=0;a<t.palette.length;a++){var s=t.palette[a]>>16&255;var o=t.palette[a]>>8&255;var l=t.palette[a]&255;i.palette[a]=[s,o,l]}var n=new RgbQuant(i);n.sample(e);var h=n.palette();var d=[];for(var a=0;a<e.data.length;a++){if((a+1)%4==0){d.push(e.data[a])}}var c=n.reduce(e,1);var f=0;for(var a=0;a<e.data.length;a++){if((a+1)%4){e.data[a]=c[a]}else{e.data[a]=d[f++]}}};ImageUtils.adjustBrightness=function(e,t){t=Math.floor(255*(t/100));for(var i=0;i<e.data.length;i+=4){for(var r=0;r<3;r++){var a=e.data[i+r];a+=t;if(a>255){a=255}if(a<0){a=0}e.data[i+r]=a}}};ImageUtils.adjustSaturation=function(e,t){t*=-.01;for(var i=0;i<e.data.length;i+=4){var r=e.data[i];var a=e.data[i+1];var s=e.data[i+2];var o=r;if(a>o){o=a}if(s>o){o=s}if(r!=o)r+=(o-r)*t;if(a!=o){a+=(o-a)*t}if(s!=o){s+=(o-s)*t}e.data[i]=r;e.data[i+1]=a;e.data[i+2]=s}};ImageUtils.adjustContrast=function(e,t){t/=1.1;var i=259*(t+255)/(255*(259-t));for(var r=0;r<e.data.length;r+=4){e.data[r]=i*(e.data[r]-128)+128;e.data[r+1]=i*(e.data[r+1]-128)+128;e.data[r+2]=i*(e.data[r+2]-128)+128}};ImageUtils.invertColors=function(e){for(var t=0;t<e.data.length;t+=4){e.data[t]=255-e.data[t];e.data[t+1]=255-e.data[t+1];e.data[t+2]=255-e.data[t+2]}};ImageUtils.adjustHue=function(e,t){for(var i=0;i<e.data.length;i+=4){var r=e.data[i];var a=e.data[i+1];var s=e.data[i+2];var o={};o.values=[r,a,s,255];o=Colour.converters[Colour.RGBA][Colour.HSVA](o);var l=o.values[0];l+=t;l=l%360;o.values[0]=l;o=Colour.converters[Colour.HSVA][Colour.RGBA](o);e.data[i]=o.values[0];e.data[i+1]=o.values[1];e.data[i+2]=o.values[2]}};ImageUtils.limitColorsPerCell=function(e,t){var i=8;var r=8;var a=t.colors;var s=t.dithKern;var o=t.width;var l=t.height;var n=0;var h=0;var d=0;if(typeof t!="undefined"&&typeof t.bgColor!="undefined"){n=t.bgColor>>16&255;h=t.bgColor>>8&255;d=t.bgColor&255}console.log(t);console.log("bg color = "+n+","+h+","+d);var c=Math.ceil(o/i);var f=Math.ceil(l/r);var u=e.getImageData(0,0,o,l);for(var p=0;p<f;p++){for(var v=0;v<c;v++){var g=0;var m=0;var y=0;var b=0;var C=e.getImageData(v*i-g,p*r-m,i+g+y,r+m+b);for(var x=0;x<r;x++){for(var S=0;S<i;S++){var P=4*(g+S+(m+x)*(i+g+y));if(C.data[P+3]==0){C.data[P]=n;C.data[P+1]=h;C.data[P+2]=d;C.data[P+3]=255}}}ImageUtils.rgbQuant(C,{method:2,colors:2,palette:a,dithKern:s,dithDelta:0});for(var x=0;x<r;x++){for(var S=0;S<i;S++){var P=4*(g+S+(m+x)*(i+g+y));var w=4*(v*i+S+(p*r+x)*o);u.data[w]=C.data[P];u.data[w+1]=C.data[P+1];u.data[w+2]=C.data[P+2]}}}}console.log("limited the colours");e.putImageData(u,0,0,0,0,o,l)};ImageUtils.edgeDetect=function(e,t){console.log("edge detect");var i=20;var r=90;var a=3;var s=2;if(typeof t!="undefined"){if(typeof t.lowThreshold!="undefined"){i=t.lowThreshold}if(typeof t.highThreshold!="undefined"){r=t.highThreshold}if(typeof t.blurRadius!="undefined"){a=t.blurRadius}if(typeof t.lineThickness){s=t.lineThickness}}var o;o=new jsfeat.matrix_t(e.width,e.height,jsfeat.U8C1_t);jsfeat.imgproc.grayscale(e.data,e.width,e.height,o);var l=a;var n=l+1<<1;jsfeat.imgproc.gaussian_blur(o,o,n,0);jsfeat.imgproc.canny(o,o,i,r);var h=new Uint32Array(e.data.buffer);var d=255<<24;var c=o.cols*o.rows,f=0;while(--c>=0){f=o.data[c];h[c]=d|f<<16|f<<8|f}console.log("line thickness: "+s);if(s>1){for(var u=0;u<e.height;u++){for(var p=e.width-s;p>0;p--){var v=u*e.width*4+p*4;if(e.data[v]>100){e.data[v+4]=255;e.data[v+5]=255;e.data[v+6]=255;e.data[v+7]=255}}}for(var u=1;u<e.height;u++){for(var p=e.width-s;p>0;p--){var v=u*e.width*4+p*4;var g=(u-1)*e.width*4+p*4;if(e.data[v]>100){e.data[g+4]=255;e.data[g+5]=255;e.data[g+6]=255;e.data[g+7]=255}}}}};var CheckerboardPattern=function(){this.canvas=null;this.context=null;this.checkSize=5;this.lightColor="#161616";this.darkColor="#111111"};CheckerboardPattern.prototype={init:function(){},getCanvas:function(e,t){if(this.canvas==null||e>this.canvas.width||t>this.canvas.height){this.setDimensions(e,t)}return this.canvas},setDimensions:function(e,t){if(this.canvas==null){this.canvas=document.createElement("canvas")}if(this.context==null||this.canvas.width!=e||this.canvas.height!=t){this.canvas.width=e;this.canvas.height=t;this.context=this.canvas.getContext("2d")}this.context.fillStyle=this.lightColor;this.context.fillRect(0,0,this.canvas.width,this.canvas.height);var i=Math.ceil(this.canvas.width/this.checkSize);var r=Math.ceil(this.canvas.height/this.checkSize);this.context.fillStyle=this.darkColor;for(var a=0;a<r;a++){for(var s=0;s<i;s++){if((s+a)%2){this.context.fillRect(s*this.checkSize,a*this.checkSize,this.checkSize,this.checkSize)}}}}};var ImageLib=function(e){e=e||{};this.imageData=null;this.histogram=null;this.buf8=null;this.buf32=null;this.width=false;this.height=false;this.cellWidth=8;this.cellHeight=8;this.colorDist=e.colorDist=="manhattan"?c:h;this.palette=[[0,0,0],[255,255,255],[127,56,48],[114,185,194],[128,55,168],[97,165,57],[55,36,156],[204,219,102],[135,86,33],[85,65,1],[181,107,100],[77,77,77],[119,119,119],[166,237,125],[114,97,216],[164,164,164]];this.paletteI32=[];var s=.2126,o=.7152,l=.0722;function t(e,t,i){return Math.sqrt(s*e*e+o*t*t+l*i*i)}var i=255,r=255,a=255;var n=Math.sqrt(s*i*i+o*r*r+l*a*a);function h(e,t){var i=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return Math.sqrt(s*i*i+o*r*r+l*a*a)/n}var d=s*i+o*r+l*a;function c(e,t){var i=Math.abs(t[0]-e[0]),r=Math.abs(t[1]-e[1]),a=Math.abs(t[2]-e[2]);return(s*i+o*r+l*a)/d}};ImageLib.prototype={setPaletteI32:function(e){this.palette=[];this.paletteI32=[];for(var t=0;t<e.length;t++){var i=e[t]|4278190080;this.paletteI32.push(i);var r=[i&255,(i&65280)>>8,(i&16711680)>>16];this.palette.push(r)}},setImageData:function(e){this.imageData=e;this.buf32=new Uint32Array(this.imageData.data.buffer);this.width=this.imageData.width;this.height=this.imageData.height;this.buildI32Palette()},buildI32Palette:function(){this.paletteI32=[];var r=this;this.palette.forEach(function(e,t){var i=(255<<24|e[2]<<16|e[1]<<8|e[0])>>>0;r.paletteI32[t]=i})},nearestColorFromPalette:function(e,t,i){var r=1e3;var a=false;var s=[e&255,(e&65280)>>8,(e&16711680)>>16];var o=t.length;for(var l=0;l<o;l++){var n=this.colorDist(s,t[l]);if(n<r){r=n;a=l}}if(a===false){a=0}return i[a]},nearestColor:function(e){var t=1e3;var i=false;var r=[e&255,(e&65280)>>8,(e&16711680)>>16];var a=this.palette.length;for(var s=0;s<a;s++){var o=this.colorDist(r,this.palette[s]);if(o<t){t=o;i=s}}if(i===false){i=0}return this.paletteI32[i]},nearestColorIndex:function(e){var t=1e3;var i=false;var r=[e&255,(e&65280)>>8,(e&16711680)>>16];var a=this.palette.length;for(var s=0;s<a;s++){var o=this.colorDist(r,this.palette[s]);if(o<t){t=o;i=s}}if(i===false){console.log("nothing found...");i=0}return i},reduce:function(){var e=false;if(e){}else{return this.reduceNearest()}},reducePerCell:function(){var e=false;var t=this.buf32;var i=t.length;var r=new Uint32Array(i);var a=Math.floor(this.width/this.cellWidth);var s=Math.floor(this.height/this.cellHeight);var o=0;var l=0;var n=0;var h=0;var d=0,c=0;for(o=0;o<s;o++){for(l=0;l<a;l++){n=o*this.cellHeight*this.width+l*this.cellWidth;var f={};for(c=0;c<this.cellHeight;c++){for(d=0;d<this.cellWidth;d++){h=n+d+c*this.width;var u=t[h];if(u in f){f[u]++}else{f[u]=1}}}var p=this.sortedHashKeys(f,true);var v=p.length;var g=[];var m=[];var y=[];if(v>0){var b=this.nearestColorIndex(p[0]);g.push(b);m.push(this.palette[b]);y.push(this.paletteI32[b]);for(var C=1;C<p.length;C++){b=this.nearestColorIndex(p[C]);if(b!==g[0]){g.push(b);m.push(this.palette[b]);y.push(this.paletteI32[b]);break}}}else{}if(!e){for(c=0;c<this.cellHeight;c++){for(d=0;d<this.cellWidth;d++){h=n+d+c*this.width;var u=t[h];r[h]=this.nearestColorFromPalette(u,m,y)}}}else{this.reduceCellDither(r,l*this.cellWidth,o*this.cellHeight,m,y)}}}var x=new Uint8ClampedArray(r.buffer);return new ImageData(x,this.width,this.height)},reduceNearest:function(){var e=this.buf32;var t=e.length;for(var i=0;i<t;i++){var r=e[i];e[i]=this.nearestColor(r)&16777215|r&4278190080}var a=new Uint8ClampedArray(e.buffer);return new ImageData(a,this.width,this.height)},reduceCellDither:function(e,t,i,r,a){var s={FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]],Jarvis:[[7/48,1,0],[5/48,2,0],[3/48,-2,1],[5/48,-1,1],[7/48,0,1],[5/48,1,1],[3/48,2,1],[1/48,-2,2],[3/48,-1,2],[5/48,0,2],[3/48,1,2],[1/48,2,2]],Burkes:[[8/32,1,0],[4/32,2,0],[2/32,-2,1],[4/32,-1,1],[8/32,0,1],[4/32,1,1],[2/32,2,1]],Sierra:[[5/32,1,0],[3/32,2,0],[2/32,-2,1],[4/32,-1,1],[5/32,0,1],[4/32,1,1],[2/32,2,1],[2/32,-1,2],[3/32,0,2],[2/32,1,2]],TwoSierra:[[4/16,1,0],[3/16,2,0],[1/16,-2,1],[2/16,-1,1],[3/16,0,1],[2/16,1,1],[1/16,2,1]],SierraLite:[[2/4,1,0],[1/4,-1,1],[1/4,0,1]]};var o="FloydSteinberg";var l=false;if(!o||!s[o]){throw"Unknown dithering kernel: "+o}var n=s[o];var h=this.buf32;var d=this.width;var c=this.height;var f=h.len;var u=l?-1:1;for(var p=i;p<i+this.cellHeight;p++){if(l)u=u*-1;var v=p*d;for(var g=u==1?t:t+this.cellWidth-1,m=u==1?t+this.cellWidth:t;g!==m;g+=u){var y=v+g,b=h[y],C=b&255,x=(b&65280)>>8,S=(b&16711680)>>16;var P=this.nearestColorFromPalette(b,r,a),w=P&255,I=(P&65280)>>8,k=(P&16711680)>>16;h[y]=255<<24|k<<16|I<<8|w;if(this.dithDelta){var M=this.colorDist([C,x,S],[w,I,k]);if(M<this.dithDelta)continue}var T=C-w,D=x-I,E=S-k;for(var $=u==1?0:n.length-1,_=u==1?n.length:0;$!==_;$+=u){var B=n[$][1]*u,R=n[$][2];var A=R*d;if(B+g>=t&&B+g<t+this.cellWidth&&R+p>=i&&R+p<i+this.cellHeight){var F=n[$][0];var L=y+(A+B);var U=h[L]&255,H=(h[L]&65280)>>8,O=(h[L]&16711680)>>16;var G=Math.max(0,Math.min(255,U+T*F)),z=Math.max(0,Math.min(255,H+D*F)),N=Math.max(0,Math.min(255,O+E*F));h[L]=255<<24|N<<16|z<<8|G}}}}},reduceDither:function(e){e=e||{};var t=e.kernel||"FloydSteinberg";var i=false;var r={FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]],Jarvis:[[7/48,1,0],[5/48,2,0],[3/48,-2,1],[5/48,-1,1],[7/48,0,1],[5/48,1,1],[3/48,2,1],[1/48,-2,2],[3/48,-1,2],[5/48,0,2],[3/48,1,2],[1/48,2,2]],Burkes:[[8/32,1,0],[4/32,2,0],[2/32,-2,1],[4/32,-1,1],[8/32,0,1],[4/32,1,1],[2/32,2,1]],Sierra:[[5/32,1,0],[3/32,2,0],[2/32,-2,1],[4/32,-1,1],[5/32,0,1],[4/32,1,1],[2/32,2,1],[2/32,-1,2],[3/32,0,2],[2/32,1,2]],TwoSierra:[[4/16,1,0],[3/16,2,0],[1/16,-2,1],[2/16,-1,1],[3/16,0,1],[2/16,1,1],[1/16,2,1]],SierraLite:[[2/4,1,0],[1/4,-1,1],[1/4,0,1]]};if(!t||!r[t]){throw"Unknown dithering kernel: "+t}var a=r[t];var s=this.buf32;var o=this.width;var l=this.height;var n=s.len;var h=i?-1:1;for(var d=0;d<l;d++){if(i)h=h*-1;var c=d*o;for(var f=h==1?0:o-1,u=h==1?o:0;f!==u;f+=h){var p=c+f,v=s[p],g=v&255,m=(v&65280)>>8,y=(v&16711680)>>16,b=(v&4278190080)>>24;var C=this.nearestColor(v),x=C&255,S=(C&65280)>>8,P=(C&16711680)>>16;s[p]=b<<24|P<<16|S<<8|x;if(this.dithDelta){var w=this.colorDist([g,m,y],[x,S,P]);if(w<this.dithDelta)continue}var I=g-x,k=m-S,M=y-P;for(var T=h==1?0:a.length-1,D=h==1?a.length:0;T!==D;T+=h){var E=a[T][1]*h,$=a[T][2];var _=$*o;if(E+f>=0&&E+f<o&&$+d>=0&&$+d<l){var B=a[T][0];var R=p+(_+E);var A=s[R]&255,F=(s[R]&65280)>>8,L=(s[R]&16711680)>>16,U=(s[R]&4278190080)>>24;var H=Math.max(0,Math.min(255,A+I*B)),O=Math.max(0,Math.min(255,F+k*B)),G=Math.max(0,Math.min(255,L+M*B));s[R]=U<<24|G<<16|O<<8|H}}}}var z=new Uint8ClampedArray(s.buffer);return new ImageData(z,this.width,this.height)},colorStats1D:function(){var e=this.histogram;var t=this.buf32;var i=t.length;var r=0;for(var a=0;a<i;a++){r=t[a];if((r&4278190080)>>24==0)continue;if(r in e)e[r]++;else e[r]=1}},sortedHashKeys:function(i,r){var e=[];for(var t in i)e.push(t);return e.sort(function(e,t){return r?i[t]-i[e]:i[e]-i[t]})},buildPalette:function(){var e=this.histogram;var t=this.sortedHashKeys(e,true);var i=t;i=i.map(function(e){return+e});this.reducePalette(i)},reducePalette:function(e){}};var ColorUtils={};ColorUtils.hexStringToInt=function(e){if(e.length==0){return 0}if(e[0]=="#"){e=e.substring(1)}return parseInt(e,16)};ColorUtils.intToHexString=function(e){return("000000"+e.toString(16)).substr(-6)};var convert={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var model in convert){if(convert.hasOwnProperty(model)){if(!("channels"in convert[model])){throw new Error("missing channels property: "+model)}if(!("labels"in convert[model])){throw new Error("missing channel labels property: "+model)}if(convert[model].labels.length!==convert[model].channels){throw new Error("channel and label counts mismatch: "+model)}var channels=convert[model].channels;var labels=convert[model].labels;delete convert[model].channels;delete convert[model].labels;Object.defineProperty(convert[model],"channels",{value:channels});Object.defineProperty(convert[model],"labels",{value:labels})}}convert.rgb.hsl=function(e){var t=e[0]/255;var i=e[1]/255;var r=e[2]/255;var a=Math.min(t,i,r);var s=Math.max(t,i,r);var o=s-a;var l;var n;var h;if(s===a){l=0}else if(t===s){l=(i-r)/o}else if(i===s){l=2+(r-t)/o}else if(r===s){l=4+(t-i)/o}l=Math.min(l*60,360);if(l<0){l+=360}h=(a+s)/2;if(s===a){n=0}else if(h<=.5){n=o/(s+a)}else{n=o/(2-s-a)}return[l,n*100,h*100]};convert.rgb.hsv=function(e){var t;var i;var r;var a;var s;var o=e[0]/255;var l=e[1]/255;var n=e[2]/255;var h=Math.max(o,l,n);var d=h-Math.min(o,l,n);var c=function(e){return(h-e)/6/d+1/2};if(d===0){a=s=0}else{s=d/h;t=c(o);i=c(l);r=c(n);if(o===h){a=r-i}else if(l===h){a=1/3+t-r}else if(n===h){a=2/3+i-t}if(a<0){a+=1}else if(a>1){a-=1}}return[a*360,s*100,h*100]};convert.rgb.hwb=function(e){var t=e[0];var i=e[1];var r=e[2];var a=convert.rgb.hsl(e)[0];var s=1/255*Math.min(t,Math.min(i,r));r=1-1/255*Math.max(t,Math.max(i,r));return[a,s*100,r*100]};convert.rgb.cmyk=function(e){var t=e[0]/255;var i=e[1]/255;var r=e[2]/255;var a;var s;var o;var l;l=Math.min(1-t,1-i,1-r);a=(1-t-l)/(1-l)||0;s=(1-i-l)/(1-l)||0;o=(1-r-l)/(1-l)||0;return[a*100,s*100,o*100,l*100]};function comparativeDistance(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2)}convert.rgb.keyword=function(e){var t=reverseKeywords[e];if(t){return t}var i=Infinity;var r;for(var a in cssKeywords){if(cssKeywords.hasOwnProperty(a)){var s=cssKeywords[a];var o=comparativeDistance(e,s);if(o<i){i=o;r=a}}}return r};convert.keyword.rgb=function(e){return cssKeywords[e]};convert.rgb.xyz=function(e){var t=e[0]/255;var i=e[1]/255;var r=e[2]/255;t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92;i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92;r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92;var a=t*.4124+i*.3576+r*.1805;var s=t*.2126+i*.7152+r*.0722;var o=t*.0193+i*.1192+r*.9505;return[a*100,s*100,o*100]};convert.rgb.lab=function(e){var t=convert.rgb.xyz(e);var i=t[0];var r=t[1];var a=t[2];var s;var o;var l;i/=95.047;r/=100;a/=108.883;i=i>.008856?Math.pow(i,1/3):7.787*i+16/116;r=r>.008856?Math.pow(r,1/3):7.787*r+16/116;a=a>.008856?Math.pow(a,1/3):7.787*a+16/116;s=116*r-16;o=500*(i-r);l=200*(r-a);return[s,o,l]};convert.hsl.rgb=function(e){var t=e[0]/360;var i=e[1]/100;var r=e[2]/100;var a;var s;var o;var l;var n;if(i===0){n=r*255;return[n,n,n]}if(r<.5){s=r*(1+i)}else{s=r+i-r*i}a=2*r-s;l=[0,0,0];for(var h=0;h<3;h++){o=t+1/3*-(h-1);if(o<0){o++}if(o>1){o--}if(6*o<1){n=a+(s-a)*6*o}else if(2*o<1){n=s}else if(3*o<2){n=a+(s-a)*(2/3-o)*6}else{n=a}l[h]=n*255}return l};convert.hsl.hsv=function(e){var t=e[0];var i=e[1]/100;var r=e[2]/100;var a=i;var s=Math.max(r,.01);var o;var l;r*=2;i*=r<=1?r:2-r;a*=s<=1?s:2-s;l=(r+i)/2;o=r===0?2*a/(s+a):2*i/(r+i);return[t,o*100,l*100]};convert.hsv.rgb=function(e){var t=e[0]/60;var i=e[1]/100;var r=e[2]/100;var a=Math.floor(t)%6;var s=t-Math.floor(t);var o=255*r*(1-i);var l=255*r*(1-i*s);var n=255*r*(1-i*(1-s));r*=255;switch(a){case 0:return[r,n,o];case 1:return[l,r,o];case 2:return[o,r,n];case 3:return[o,l,r];case 4:return[n,o,r];case 5:return[r,o,l]}};convert.hsv.hsl=function(e){var t=e[0];var i=e[1]/100;var r=e[2]/100;var a=Math.max(r,.01);var s;var o;var l;l=(2-i)*r;s=(2-i)*a;o=i*a;o/=s<=1?s:2-s;o=o||0;l/=2;return[t,o*100,l*100]};convert.hwb.rgb=function(e){var t=e[0]/360;var i=e[1]/100;var r=e[2]/100;var a=i+r;var s;var o;var l;var n;if(a>1){i/=a;r/=a}s=Math.floor(6*t);o=1-r;l=6*t-s;if((s&1)!==0){l=1-l}n=i+l*(o-i);var h;var d;var c;switch(s){default:case 6:case 0:h=o;d=n;c=i;break;case 1:h=n;d=o;c=i;break;case 2:h=i;d=o;c=n;break;case 3:h=i;d=n;c=o;break;case 4:h=n;d=i;c=o;break;case 5:h=o;d=i;c=n;break}return[h*255,d*255,c*255]};convert.cmyk.rgb=function(e){var t=e[0]/100;var i=e[1]/100;var r=e[2]/100;var a=e[3]/100;var s;var o;var l;s=1-Math.min(1,t*(1-a)+a);o=1-Math.min(1,i*(1-a)+a);l=1-Math.min(1,r*(1-a)+a);return[s*255,o*255,l*255]};convert.xyz.rgb=function(e){var t=e[0]/100;var i=e[1]/100;var r=e[2]/100;var a;var s;var o;a=t*3.2406+i*-1.5372+r*-.4986;s=t*-.9689+i*1.8758+r*.0415;o=t*.0557+i*-.204+r*1.057;a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a*12.92;s=s>.0031308?1.055*Math.pow(s,1/2.4)-.055:s*12.92;o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:o*12.92;a=Math.min(Math.max(0,a),1);s=Math.min(Math.max(0,s),1);o=Math.min(Math.max(0,o),1);return[a*255,s*255,o*255]};convert.xyz.lab=function(e){var t=e[0];var i=e[1];var r=e[2];var a;var s;var o;t/=95.047;i/=100;r/=108.883;t=t>.008856?Math.pow(t,1/3):7.787*t+16/116;i=i>.008856?Math.pow(i,1/3):7.787*i+16/116;r=r>.008856?Math.pow(r,1/3):7.787*r+16/116;a=116*i-16;s=500*(t-i);o=200*(i-r);return[a,s,o]};convert.lab.xyz=function(e){var t=e[0];var i=e[1];var r=e[2];var a;var s;var o;s=(t+16)/116;a=i/500+s;o=s-r/200;var l=Math.pow(s,3);var n=Math.pow(a,3);var h=Math.pow(o,3);s=l>.008856?l:(s-16/116)/7.787;a=n>.008856?n:(a-16/116)/7.787;o=h>.008856?h:(o-16/116)/7.787;a*=95.047;s*=100;o*=108.883;return[a,s,o]};convert.lab.lch=function(e){var t=e[0];var i=e[1];var r=e[2];var a;var s;var o;a=Math.atan2(r,i);s=a*360/2/Math.PI;if(s<0){s+=360}o=Math.sqrt(i*i+r*r);return[t,o,s]};convert.lch.lab=function(e){var t=e[0];var i=e[1];var r=e[2];var a;var s;var o;o=r/360*2*Math.PI;a=i*Math.cos(o);s=i*Math.sin(o);return[t,a,s]};convert.rgb.ansi16=function(e){var t=e[0];var i=e[1];var r=e[2];var a=1 in arguments?arguments[1]:convert.rgb.hsv(e)[2];a=Math.round(a/50);if(a===0){return 30}var s=30+(Math.round(r/255)<<2|Math.round(i/255)<<1|Math.round(t/255));if(a===2){s+=60}return s};convert.hsv.ansi16=function(e){return convert.rgb.ansi16(convert.hsv.rgb(e),e[2])};convert.rgb.ansi256=function(e){var t=e[0];var i=e[1];var r=e[2];if(t===i&&i===r){if(t<8){return 16}if(t>248){return 231}return Math.round((t-8)/247*24)+232}var a=16+36*Math.round(t/255*5)+6*Math.round(i/255*5)+Math.round(r/255*5);return a};convert.ansi16.rgb=function(e){var t=e%10;if(t===0||t===7){if(e>50){t+=3.5}t=t/10.5*255;return[t,t,t]}var i=(~~(e>50)+1)*.5;var r=(t&1)*i*255;var a=(t>>1&1)*i*255;var s=(t>>2&1)*i*255;return[r,a,s]};convert.ansi256.rgb=function(e){if(e>=232){var t=(e-232)*10+8;return[t,t,t]}e-=16;var i;var r=Math.floor(e/36)/5*255;var a=Math.floor((i=e%36)/6)/5*255;var s=i%6/5*255;return[r,a,s]};convert.rgb.hex=function(e){var t=((Math.round(e[0])&255)<<16)+((Math.round(e[1])&255)<<8)+(Math.round(e[2])&255);var i=t.toString(16).toUpperCase();return"000000".substring(i.length)+i};convert.hex.rgb=function(e){var t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t){return[0,0,0]}var i=t[0];if(t[0].length===3){i=i.split("").map(function(e){return e+e}).join("")}var r=parseInt(i,16);var a=r>>16&255;var s=r>>8&255;var o=r&255;return[a,s,o]};convert.rgb.hcg=function(e){var t=e[0]/255;var i=e[1]/255;var r=e[2]/255;var a=Math.max(Math.max(t,i),r);var s=Math.min(Math.min(t,i),r);var o=a-s;var l;var n;if(o<1){l=s/(1-o)}else{l=0}if(o<=0){n=0}else if(a===t){n=(i-r)/o%6}else if(a===i){n=2+(r-t)/o}else{n=4+(t-i)/o+4}n/=6;n%=1;return[n*360,o*100,l*100]};convert.hsl.hcg=function(e){var t=e[1]/100;var i=e[2]/100;var r=1;var a=0;if(i<.5){r=2*t*i}else{r=2*t*(1-i)}if(r<1){a=(i-.5*r)/(1-r)}return[e[0],r*100,a*100]};convert.hsv.hcg=function(e){var t=e[1]/100;var i=e[2]/100;var r=t*i;var a=0;if(r<1){a=(i-r)/(1-r)}return[e[0],r*100,a*100]};convert.hcg.rgb=function(e){var t=e[0]/360;var i=e[1]/100;var r=e[2]/100;if(i===0){return[r*255,r*255,r*255]}var a=[0,0,0];var s=t%1*6;var o=s%1;var l=1-o;var n=0;switch(Math.floor(s)){case 0:a[0]=1;a[1]=o;a[2]=0;break;case 1:a[0]=l;a[1]=1;a[2]=0;break;case 2:a[0]=0;a[1]=1;a[2]=o;break;case 3:a[0]=0;a[1]=l;a[2]=1;break;case 4:a[0]=o;a[1]=0;a[2]=1;break;default:a[0]=1;a[1]=0;a[2]=l}n=(1-i)*r;return[(i*a[0]+n)*255,(i*a[1]+n)*255,(i*a[2]+n)*255]};convert.hcg.hsv=function(e){var t=e[1]/100;var i=e[2]/100;var r=t+i*(1-t);var a=0;if(r>0){a=t/r}return[e[0],a*100,r*100]};convert.hcg.hsl=function(e){var t=e[1]/100;var i=e[2]/100;var r=i*(1-t)+.5*t;var a=0;if(r>0&&r<.5){a=t/(2*r)}else if(r>=.5&&r<1){a=t/(2*(1-r))}return[e[0],a*100,r*100]};convert.hcg.hwb=function(e){var t=e[1]/100;var i=e[2]/100;var r=t+i*(1-t);return[e[0],(r-t)*100,(1-r)*100]};convert.hwb.hcg=function(e){var t=e[1]/100;var i=e[2]/100;var r=1-i;var a=r-t;var s=0;if(a<1){s=(r-a)/(1-a)}return[e[0],a*100,s*100]};convert.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]};convert.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]};convert.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]};convert.gray.hsl=convert.gray.hsv=function(e){return[0,0,e[0]]};convert.gray.hwb=function(e){return[0,100,e[0]]};convert.gray.cmyk=function(e){return[0,0,0,e[0]]};convert.gray.lab=function(e){return[e[0],0,0]};convert.gray.hex=function(e){var t=Math.round(e[0]/100*255)&255;var i=(t<<16)+(t<<8)+t;var r=i.toString(16).toUpperCase();return"000000".substring(r.length)+r};convert.rgb.gray=function(e){var t=(e[0]+e[1]+e[2])/3;return[t/255*100]};var PIXEL_STEP=10;var LINE_HEIGHT=40;var PAGE_HEIGHT=800;function normalizeWheel(e){var t=0,i=0,r=0,a=0;if("detail"in e){i=e.detail}if("wheelDelta"in e){i=-e.wheelDelta/120}if("wheelDeltaY"in e){i=-e.wheelDeltaY/120}if("wheelDeltaX"in e){t=-e.wheelDeltaX/120}if("axis"in e&&e.axis===e.HORIZONTAL_AXIS){t=i;i=0}r=t*PIXEL_STEP;a=i*PIXEL_STEP;if("deltaY"in e){a=e.deltaY}if("deltaX"in e){r=e.deltaX}if((r||a)&&e.deltaMode){if(e.deltaMode==1){r*=LINE_HEIGHT;a*=LINE_HEIGHT}else{r*=PAGE_HEIGHT;a*=PAGE_HEIGHT}}if(r&&!t){t=r<1?-1:1}if(a&&!i){i=a<1?-1:1}return{spinX:t,spinY:i,pixelX:r,pixelY:a}}var ieee754={};ieee754.read=function(e,t,i,r,a){var s,o;var l=a*8-r-1;var n=(1<<l)-1;var h=n>>1;var d=-7;var c=i?a-1:0;var f=i?-1:1;var u=e[t+c];c+=f;s=u&(1<<-d)-1;u>>=-d;d+=l;for(;d>0;s=s*256+e[t+c],c+=f,d-=8){}o=s&(1<<-d)-1;s>>=-d;d+=r;for(;d>0;o=o*256+e[t+c],c+=f,d-=8){}if(s===0){s=1-h}else if(s===n){return o?NaN:(u?-1:1)*Infinity}else{o=o+Math.pow(2,r);s=s-h}return(u?-1:1)*o*Math.pow(2,s-r)};ieee754.write=function(e,t,i,r,a,s){var o,l,n;var h=s*8-a-1;var d=(1<<h)-1;var c=d>>1;var f=a===23?Math.pow(2,-24)-Math.pow(2,-77):0;var u=r?0:s-1;var p=r?1:-1;var v=t<0||t===0&&1/t<0?1:0;t=Math.abs(t);if(isNaN(t)||t===Infinity){l=isNaN(t)?1:0;o=d}else{o=Math.floor(Math.log(t)/Math.LN2);if(t*(n=Math.pow(2,-o))<1){o--;n*=2}if(o+c>=1){t+=f/n}else{t+=f*Math.pow(2,1-c)}if(t*n>=2){o++;n/=2}if(o+c>=d){l=0;o=d}else if(o+c>=1){l=(t*n-1)*Math.pow(2,a);o=o+c}else{l=t*Math.pow(2,c-1)*Math.pow(2,a);o=0}}for(;a>=8;e[i+u]=l&255,u+=p,l/=256,a-=8){}o=o<<a|l;h+=a;for(;h>0;e[i+u]=o&255,u+=p,o/=256,h-=8){}e[i+u-p]|=v*128};var BBuffer=function(){this.data=[];this.index=0};BBuffer.prototype={getOffset:function(){return this.index},writeChar:function(e){this.data[this.index++]=e.charCodeAt(0)},writeChar16:function(e){var t=e.charCodeAt(0);this.writeUint16BE(t)},writeUint16BE:function(e){var t=e>>8&255;var i=e&255;this.data[this.index++]=t;this.data[this.index++]=i},writeUint32BE:function(e){var t=e>>24&255;var i=e>>16&255;var r=e>>8&255;var a=e&255;this.data[this.index++]=t;this.data[this.index++]=i;this.data[this.index++]=r;this.data[this.index++]=a},writeFloatBE:function(e){this.data[this.index]=0;this.data[this.index+1]=0;this.data[this.index+2]=0;this.data[this.index+3]=0;ieee754.write(this.data,e,this.index,false,23,4);this.index+=4},writeBuffer:function(e){var t=e.data;for(var i=0;i<t.length;i++){this.data[this.index++]=t[i]}},getByteArray:function(){var e=new Uint8Array(this.data.length);for(var t=0;t<this.data.length;t++){e[t]=this.data[t]}return e}};var ASE=function(){this.MODE_COLOR=1;this.MODE_GROUP=2;this.STATE_GET_MODE=1;this.STATE_GET_LENGTH=2;this.STATE_GET_NAME=3;this.STATE_GET_MODEL=4;this.STATE_GET_COLOR=5;this.STATE_GET_TYPE=6;this.COLOR_START=1;this.GROUP_START=49153;this.GROUP_END=49154;this.COLOR_SIZES={CMYK:4,RGB:3,LAB:3,GRAY:1},this.state=0;this.mode=0;this.colors=[];this.blockModel="";this.colors=[];this.data=[];this.index=0};ASE.prototype={readChar:function(){if(this.index>=this.data.length){return false}return String.fromCharCode(this.data[this.index++])},readChar16:function(){var e=this.readUint16BE();return String.fromCharCode(e)},readUint16BE:function(){var e=this.data[this.index++];var t=this.data[this.index++];return e<<8|t},readUint32BE:function(){var e=this.data[this.index++];var t=this.data[this.index++];var i=this.data[this.index++];var r=this.data[this.index++];return e<<24|t<<16|i<<8|r},readFloatBE:function(){var e=ieee754.read(this.data,this.index,false,23,4);this.index+=4;return e},writePalette:function(e){var t=new BBuffer;t.writeChar("A");t.writeChar("S");t.writeChar("E");t.writeChar("F");t.writeUint32BE(65536);t.writeUint32BE(e.length);console.log("number of colors"+e.length);for(var i=0;i<e.length;i++){var r=new BBuffer;t.writeUint16BE(this.COLOR_START);var a="Color";r.writeUint16BE(a.length+1);for(var s=0;s<a.length;s++){r.writeUint16BE(a.charCodeAt(s))}r.writeUint16BE(0);r.writeChar("R");r.writeChar("G");r.writeChar("B");r.writeChar(" ");var o=e[i].hex;var l=o>>16&255;var n=o>>8&255;var h=o&255;r.writeFloatBE(l/255);r.writeFloatBE(n/255);r.writeFloatBE(h/255);var d=2;r.writeUint16BE(d);var c=r.getOffset();console.log("block length = "+c);t.writeUint32BE(c);t.writeBuffer(r)}return t.getByteArray()},readPalette:function(e){this.colors=[];this.data=e;this.index=0;var t="";t+=this.readChar();t+=this.readChar();t+=this.readChar();t+=this.readChar();console.log(t);if(t!="ASEF"){console.log("not valide ase file")}this.version=[];this.version.push(this.readUint16BE());this.version.push(this.readUint16BE());console.log(this.version);this.blocks=this.readUint32BE();console.log("blocks = "+this.blocks);this.state=this.STATE_GET_MODE;this.mode=this.MODE_COLOR;var i=0;while(this.index<this.data.length){i++;if(i>99999){break}switch(this.state){case this.STATE_GET_MODE:this.readBlockMode();break;case this.STATE_GET_LENGTH:this.readBlockLength();break;case this.STATE_GET_NAME:this.readBlockName();break;case this.STATE_GET_MODEL:this.readBlockModel();break;case this.STATE_GET_COLOR:this.readBlockColor();break;case this.STATE_GET_TYPE:this.readBlockType();break}}console.log("returning");console.log(this.colors);return this.colors},readBlockMode:function(){var e=this.readUint16BE();console.log("block mode = "+e);switch(e){case this.COLOR_START:this.mode=this.MODE_COLOR;break;case this.GROUP_START:this.mode=this.MODE_GROUP;break;case this.GROUP_END:break}this.state=this.STATE_GET_LENGTH},readBlockLength:function(){this.blockLength=this.readUint32BE();console.log("block length = "+this.blockLength);this.state=this.STATE_GET_NAME},readBlockName:function(){var e=this.readUint16BE();var t="";for(var i=0;i<e;i++){t+=this.readChar16()}console.log("block name = "+t);if(this.mode==this.MODE_GROUP){this.state=this.STATE_GET_MODE}else{this.state=this.STATE_GET_MODEL}},readBlockModel:function(){var e="";e+=this.readChar();e+=this.readChar();e+=this.readChar();e+=this.readChar();console.log('block model = "'+e+'"');e=e.trim();console.log("model = "+e);this.blockModel=e;this.state=this.STATE_GET_COLOR},readBlockColor:function(){var e=this.blockModel.toUpperCase();var t=this.COLOR_SIZES[e];console.log("colour count = "+t);var i=[];for(var r=0;r<t;r++){i.push(this.readFloatBE())}if(this.blockModel=="RGB"){console.log("ADDING RGB COLOR!!");var a=Math.round(i[0]*255);var s=Math.round(i[1]*255);var o=Math.round(i[2]*255);var l=a<<16|(s<<8)+o;this.colors.push(l);console.log(l)}else if(this.blockModel=="Gray"){var a=Math.round(i[0]*255);var s=Math.round(i[0]*255);var o=Math.round(i[0]*255);var l=a<<16|(s<<8)+o;this.colors.push(l)}else if(this.blockModel=="CMYK"){var l=cmyk2rgb(i[0],i[1],i[2],i[3]);this.colors.push(l)}else if(this.blockModel=="LAB"){i[0]*=100;var n=convert.xyz.rgb(convert.lab.xyz(i));var a=Math.round(n[0]);var s=Math.round(n[1]);var o=Math.round(n[2]);if(a>255){a=255}if(s>255){s=255}if(o>255){o=255}var l=(a<<16)+(s<<8)+o;this.colors.push(l)}else{console.log("unknown model!!!!!: '"+this.blockModel+"'")}this.state=this.STATE_GET_TYPE},readBlockType:function(){var e=this.readUint16BE();this.state=this.STATE_GET_MODE}};var cmyk2rgb=function(e,t,i,r){if(e>1){e=1}if(t>1){t=1}if(i>1){i=1}if(r>1){r=1}e=e*(1-r)+r;t=t*(1-r)+r;i=i*(1-r)+r;var a=Math.round((1-e)*255);var s=Math.round((1-t)*255);var o=Math.round((1-i)*255);return(a<<16)+(s<<8)+o};var ACO=function(){this.colors=[];this.data=[];this.index=0};ACO.prototype={writeUint16BE:function(e){var t=e>>8&255;var i=e&255;this.data[this.index++]=t;this.data[this.index++]=i},readChar16:function(){var e=this.readUint16BE();return String.fromCharCode(e)},readUint16BE:function(){var e=this.data[this.index++];var t=this.data[this.index++];return e<<8|t},readInt16BE:function(){var e=this.data[this.index++];var t=this.data[this.index++];var i=e<<8|t;if((i&32768)===32768){i=-(65535-i+1)}return i},readColor:function(){var e=this.readUint16BE();console.log("color space = "+e);var t=this.readUint16BE();var i=this.readUint16BE();var r=this.readUint16BE();var a=this.readUint16BE();var s="";if(this.acoVersion==2){this.readUint16BE();var o=this.readUint16BE();for(var l=0;l<o;l++){s+=this.readChar16()}this.readUint16BE()}if(e==0){console.log(t+","+i+","+r);var n=t>>8;var h=i>>8;var d=r>>8;var c=(n<<16)+(h<<8)+d;this.colors.push(c)}else if(e==1){}else if(e==2){var f=1-t/65535;var u=1-i/65535;var r=1-r/65535;var p=1-a/65535;var c=cmyk2rgb(f,u,r,p);this.colors.push(c)}else if(e==7){console.log(t+","+i+","+r+","+a);if((i&32768)===32768){i=-(65535-i+1)}if((r&32768)===32768){r=-(65535-r+1)}var v=t/100;var g=i/100;var d=r/100;var m=convert.xyz.rgb(convert.lab.xyz([v,g,d]));var n=Math.round(m[0]);var h=Math.round(m[1]);var d=Math.round(m[2]);if(n>255){n=255}if(h>255){h=255}if(d>255){d=255}var c=(n<<16)+(h<<8)+d;this.colors.push(c)}else if(e==8){var y=1-t/1e4;if(y>1){y=1}var n=Math.round(y*255);var h=Math.round(y*255);var d=Math.round(y*255);var c=(n<<16)+(h<<8)+d;this.colors.push(c)}else if(e==9){}},readPalette:function(e){this.colors=[];this.data=e;this.index=0;this.acoVersion=this.readUint16BE();console.log("aco version = "+this.acoVersion);if(this.acoVersion==0||this.acoVersion>2){return false}this.colorCount=this.readUint16BE();console.log("colour count = "+this.colorCount);for(var t=0;t<this.colorCount;t++){this.readColor()}return this.colors},writePalette:function(e){console.log(e);this.colors=e;this.data=[];this.index=0;this.writeUint16BE(1);this.writeUint16BE(e.length);for(var t=0;t<e.length;t++){var i=e[t].hex;this.writeUint16BE(0);var r=i>>16&255;var a=i>>8&255;var s=i&255;console.log("write "+r+","+a+","+s);this.writeUint16BE(r<<8);this.writeUint16BE(a<<8);this.writeUint16BE(s<<8);this.writeUint16BE(0)}var o=new Uint8Array(this.data.length);for(var t=0;t<this.data.length;t++){o[t]=this.data[t]}return o}};var ParamGraph=function(){this.canvasElementId="";this.canvas=null;this.context=null;this.min=0;this.max=255;this.data=[];this.mouseInBar=false;this.mouseValue=0;this.paramChanged=false;this.mouseUpHandler=false;this.paddingY=12};ParamGraph.prototype={init:function(e){this.canvasElementId=e.canvasElementId},on:function(e,t){if(e=="paramchanged"){this.paramChanged=t}if(e=="mouseup"){this.mouseUpHandler=t}},setup:function(){if(this.canvas===null){this.canvas=document.getElementById(this.canvasElementId);this.initEvents()}this.canvasScale=Math.floor(window.devicePixelRatio);var e=300;var t=300;this.canvas.width=e*this.canvasScale;this.canvas.height=t*this.canvasScale;this.canvas.style.width=e+"px";this.canvas.style.height=t+"px";this.context=this.canvas.getContext("2d");this.context.scale(this.canvasScale,this.canvasScale);this.width=e;this.height=t-this.paddingY*2},initEvents:function(){var t=this;$("#"+this.canvasElementId).on("mousedown",function(e){t.mouseDown(e)});$("#"+this.canvasElementId).on("mousemove",function(e){t.mouseMove(e)});$("#"+this.canvasElementId).on("mouseup",function(e){t.mouseUp(e)});$("#"+this.canvasElementId).on("contextmenu",function(e){e.preventDefault()});$("#"+this.canvasElementId).on("mouseenter",function(e){t.mouseEnter(e)});$("#"+this.canvasElementId).on("mouseleave",function(e){t.mouseLeave(e)})},setBounds:function(e,t){this.min=e;this.max=t},setData:function(e){this.data=[];for(var t=0;t<e.length;t++){this.data.push(e[t])}},setButtons:function(e){if(e.buttons!="undefined"){this.buttons=e.buttons}if(e.buttons==="undefined"&&e.nativeEvent!=="undefined"){this.buttons=e.nativeEvent.buttons}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons==1){this.buttons=2}if(e.metaKey&&this.buttons==1){this.buttons=4}},mouseDown:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;var r=0;this.buttons=1;if(!UI.isMobile.any()){r=e.button;this.setButtons(e)}if(this.mouseInBar!==false&&this.mouseInBar>=0&&this.mouseInBar<this.data.length){this.setParamValueFromMouse();UI.captureMouse(this)}},mouseMove:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;var r=0;this.buttons=1;if(!UI.isMobile.any()){r=e.button;this.setButtons(e)}var a=Math.floor(t/this.barHolderWidth);if(a>=0&&a<=this.data.length){var s=this.height-i;if(a!==this.mouseInBar||this.mouseValue!==s){if(s<-this.paddingY){s=-this.paddingY}if(s>this.height-this.paddingY){s=this.height-this.paddingY}this.mouseInBar=a;this.mouseValue=s;if(this.buttons&1){this.setParamValueFromMouse()}}}this.draw()},mouseUp:function(e){if(this.mouseUpHandler!==false){this.mouseUpHandler(false)}},mouseEnter:function(e){},mouseLeave:function(e){},setParamValueFromMouse:function(){var e=this.max;var t=this.height;var i=Math.floor((this.mouseValue+this.paddingY)/t*e);if(i<this.min){i=this.min}if(i>=this.max){i=this.max}if(this.mouseInBar!==false&&this.mouseInBar>=0&&this.mouseInBar<this.data.length){this.data[this.mouseInBar]=i;if(this.paramChanged!==false){this.paramChanged(this.mouseInBar,i)}}this.draw()},draw:function(){if(!this.canvas){this.setup()}if(!this.context){return}var e=this.width;var t=this.height;this.barCount=this.data.length;this.barHolderWidth=e/this.barCount;this.barGap=2;var i=t;this.context.fillStyle="#111111";this.context.fillRect(0,0,this.canvas.width,this.canvas.height);this.context.font="8px Verdana";for(var r=0;r<this.barCount;r++){var a=Math.floor(r*this.barHolderWidth+this.barGap);var s=this.max;var o=this.data[r];var l=i*o/s;var n=this.barHolderWidth-2*this.barGap;var h=t-l+this.paddingY;this.context.fillStyle="#eeeeee";this.context.fillText(o,a,this.height+this.paddingY*2-3);if(r===this.mouseInBar){this.context.fillStyle="#eeeeee";this.context.fillRect(a,h,n,l);var o=Math.floor((this.mouseValue+this.paddingY)/this.height*this.max);if(o<this.min){o=this.min}if(o>this.max){o=this.max}var d=this.height-this.mouseValue;this.context.beginPath();this.context.strokeStyle="#eeeeee";this.context.fillStyle="#eeeeee";if(o<this.data[r]){this.context.strokeStyle="#222222";this.context.fillStyle="#222222"}this.context.lineWidth=1;this.context.moveTo(a,d+.5);this.context.lineTo(a+this.barHolderWidth-2*this.barGap,d+.5);this.context.stroke();this.context.fillText(o,a,d-3)}else{this.context.fillStyle="#aaaaaa";this.context.fillRect(a,h,n,l)}this.context.beginPath();this.context.strokeStyle=styles.music.oscilloscopeLines;this.context.lineWidth=1;this.context.moveTo(0,this.height+this.paddingY+.5);this.context.lineTo(this.width,this.height+this.paddingY+.5);this.context.stroke()}}};var C64MulticolorTypeControl=function(){this.elementId=false;this.editor=null;this.colorTypeSelectedHander=false};C64MulticolorTypeControl.prototype={init:function(e,t){this.editor=e;this.elementId=t.elementId;this.writeHTML()},on:function(e,t){switch(e){case"colortypeselected":this.colorTypeSelectedHander=t;break}},writeHTML:function(){var e="";e+='<div class="tileEditorC64ColorType tileEditorC64ColorType_background" data-type="background">';e+='  <div class="tileEditorC64Color backgroundColorDisplay" data-type="background" id="tileEditorC64Color-background"></div>';e+='<span class="tileEditorC64ColorLabel">&nbsp;Frame';if(!UI.isMobile.any()){e+=" (1)"}e+="</span>";e+="</div>";e+='<div class="tileEditorC64ColorType tileEditorC64ColorType_cell" data-type="cell">';e+='<div class="tileEditorC64Color foregroundColorDisplay tileEditorC64Color-cell"  data-type="cell"></div>';e+='<span class="tileEditorC64ColorLabel">&nbsp;Cell';if(!UI.isMobile.any()){e+=" (2)"}e+="</span>";e+="</div>";e+='<div class="tileEditorC64ColorType tileEditorC64ColorType_multi1" data-type="multi1"> ';e+='<div class="tileEditorC64Color c64Multi1ColorDisplay tileEditorC64Color-multi1"  data-type="multi1"></div>';e+='<span class="tileEditorC64ColorLabel">&nbsp;Multi 1';if(!UI.isMobile.any()){e+=" (3)"}e+="</span>";e+="</div>";e+='<div class="tileEditorC64ColorType tileEditorC64ColorType_multi2" data-type="multi2"> ';e+='<div class="tileEditorC64Color c64Multi2ColorDisplay tileEditorC64Color-multi2" data-type="multi2" ></div>';e+='<span class="tileEditorC64ColorLabel">&nbsp;Multi 2';if(!UI.isMobile.any()){e+=" (4)"}e+="</span>";e+="</div>";$("#"+this.elementId).html(e);this.initEvents()},initEvents:function(){var i=this;$("#"+this.elementId+" .tileEditorC64Color").on("click",function(e){var t=$(this).attr("data-type");i.showColorPicker(e,t);e.preventDefault()});$("#"+this.elementId+" .tileEditorC64ColorType").on("click",function(e){var t=$(this).attr("data-type");i.selectC64ColorType(t)})},showColorPicker:function(e,t){var i={};var r=this.editor.layers.getSelectedLayerObject();if(!r){return}i.currentColor=0;switch(t){case"cell":i.currentColor=this.editor.currentTile.getColor();i.type="cellcolor";break;case"background":i.currentColor=r.getBackgroundColor();i.type="background";i.hasNone=true;break;case"multi1":i.currentColor=r.getC64Multi1Color();i.type="multi1";break;case"multi2":i.currentColor=r.getC64Multi2Color();i.type="multi2";break}i.colorPickedCallback=function(e){switch(t){case"background":this.editor.setBackgroundColor(e);break;case"cell":this.editor.currentTile.setColor(e);break;case"multi1":this.editor.setC64Multi1Color(e);break;case"multi2":this.editor.setC64Multi2Color(e);break}};if(UI.isMobile.any()){this.editor.colorPaletteManager.showColorPickerMobile(i)}else{var a=e.pageX;var s=e.pageY;this.editor.colorPaletteManager.showColorPicker(a,s,i)}},selectC64ColorType:function(e){this.editor.tools.drawTools.pixelDraw.setC64MultiColorType(e);if(this.colorTypeSelectedHander!==false){this.colorTypeSelectedHander(e)}}};var TextDialog=function(){this.uiComponent=null};TextDialog.prototype={buildInterface:function(){var t=this;this.uiComponent=UI.create("UI.Dialog",{id:"textDialog",title:"",width:680});var e="";e+='<div class="panelFill">';e+='<div id="textDialogText" style="position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; width: calc(100% - 25px)"></div>';e+="</div>";this.htmlComponent=UI.create("UI.HTMLPanel",{html:e});this.uiComponent.add(this.htmlComponent);this.copyButton=UI.create("UI.Button",{text:"Copy To Clipboard",color:"primary"});this.uiComponent.addButton(this.copyButton);this.copyButton.on("click",function(e){t.copyText()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.editor=ace.edit("textDialogText");this.editor.getSession().setTabSize(2);this.editor.getSession().setUseSoftTabs(true);this.editor.on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});this.editor.on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});var i="ace/mode/assembly_6502";if(this.mode=="javascript"){i="ace/mode/javascript"}this.editor.getSession().setMode(i);this.editor.setShowInvisibles(true)},copyText:function(){var e=this.editor.selection.toJSON();this.editor.selectAll();this.editor.focus();document.execCommand("copy");this.editor.selection.fromJSON(e)},show:function(){if(this.uiComponent==null){this.buildInterface()}UI.showDialog("textDialog")},setText:function(e){if(this.uiComponent==null){this.buildInterface()}this.editor.setValue(e,-1)}};var exportFileDialog=false;function mobileOpenNewWindow(e,t){var i=e.indexOf("base64,");if(i!==-1){i+=7;e=e.substr(i)}var r=atob(e);var a=[];for(var s=0;s<r.length;s+=1024){var o=r.slice(s,s+1024);var l=new Array(o.length);for(var n=0;n<o.length;n++){l[n]=o.charCodeAt(n)}var h=new Uint8Array(l);a.push(h)}var d=new Blob(a,{type:t});var c=URL.createObjectURL(d);window.open(c,"_blank")}function mobileDownload(e){var t=e.data;var i=e.filename;var r=e.mimeType;if(UI.isMobile.iOS()){if(exportFileDialog===false){var a="";a+='<div id="exportFileDialog" style="position: absolute; background-color: black; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000">';a+='  <div style="text-align: center">';a+='  <div style="padding: 20px 0 0 0 ">';a+=" Tap and hold on the image to save";a+="  </div>";a+='<div style="text-align: center">';a+='    <div style="margin: 20px auto; max-width: 90%; max-height: 300px; overflow: scroll">';a+='      <img id="mobileExportFileDialogImage" class="downloadable-image" >';a+="    </div>";a+="</div>";a+='    <div style="margin-bottom: 20px">';a+='      <div class="ui-button" id="exportFileDialogDownloadButton">Open In New Window</div>';a+="    </div>";a+="    <div>";a+='      <div class="ui-button" id="exportFileDialogClose">Close</div>';a+="    </div>";a+="  </div>";a+="</div>";$("body").append(a);exportFileDialog=true;var s=document.getElementById("mobileExportFileDialogImage");console.log("data = ");console.log(t);s.src=t;$("#exportFileDialogClose").on("click",function(){$("#exportFileDialog").hide()});$("#exportFileDialogDownloadButton").on("click",function(){mobileOpenNewWindow(t,r)})}else{console.log("data = ");console.log(t);var s=document.getElementById("mobileExportFileDialogImage");s.src=t;$("#exportFileDialog").show()}}else{download(t,i,r)}}var TextStore={};TextStore.language="en";TextStore.setLanguage=function(e){this.language=e;$(".ui-text").each(function(){var e=$(this).attr("data-textid");$(this).html(TextStore.get(e))})};TextStore.get=function(e){var t=TextStore.content[e];if(typeof t==="undefined"){return e}var i=TextStore.language;var r=t[i];if(typeof r!=="undefined"){return r}r=t["en"];if(typeof r!=="undefined"){return r}return e};TextStore.content={Project:{en:"Project",ja:"",fr:"",de:"",it:"",zh:""},Save:{en:"Save",ja:""},"Save As...":{ja:""},"Save Project To GitHub...":{ja:"GitHub"},"Save To GitHub":{},"Commit Changes To GitHub...":{ja:"GitHub"},"Download Project...":{ja:""},"Go To Home Screen":{ja:""},Edit:{ja:""},Undo:{ja:""},Redo:{},Cut:{},Copy:{},Paste:{},"Clear All":{},"Clear...":{},"Select All":{},Deselect:{},Export:{},"Export PNG":{},"Export GIF":{},"Export Tileset":{},"Toggle Grid":{},"Toggle Show Previous Frame":{},"Visual Formats":{},"C64 Formats":{},"C64 Assembly Source...":{},"Dev Formats":{},"Binary Data...":{},Import:{},"2d Formats":{},"Import Image / Video":{},"Image / Video...":{},Screen:{},Dimensions:{},"Screen Mode":{},Mode:{},"Text mode":{},"C64 Multicolour":{},"Indexed Colour":{},"Block Mode":{},"Block Size":{},"Colour Mode":{},"Colour Per Cell":{},"Colour Per Tile":{},"Colour Per Block":{},"Reference Image":{},"Set Reference Image":{},Sprite:{},Monochrome:{},Help:{},Layers:{},"New Layer":{},"Layer Properties":{},"Delete Layer":{},"Bring Forward":{},"Send Backward":{},"Toggle Layer Visibility":{},"Select Above":{},"Select Below":{},Tiles:{},"Show Tile Editor":{},"Choose A Character Set":{},"Choose A Tile Set":{},"Load / Import Tile Set":{},"Save Tile Set":{},Colours:{"en-gb":"Colours","en-us":"Colors"},"Show Colour Editor":{"en-gb":"Show Colour Editor","en-us":"Show Color Editor"},"Choose A Colour Palette":{"en-gb":"Choose A Colour Palette","en-us":"Choose A Color Palette"},"Edit Colour Palette":{"en-gb":"Edit Colour Palette","en-us":"Edit Color Palette"},"Load Colour Palette":{"en-gb":"Load Colour Palette","en-us":"Load Color Palette"},"Save Colour Palette":{"en-gb":"Save Colour Palette","en-us":"Save Color Palette"},View:{},"Zoom In":{},"Zoom Out":{},"Fit On Screen":{},"Actual Pixels":{},"Show / Hide Grid":{},"Show / Hide Border":{},"Show / Hide Background":{},Scripting:{},"Project View":{},"Mouse / Keyboard shortcuts":{},"Scripting API":{},Video:{},Color:{"en-us":"Color","en-gb":"Colour",ja:""},"New Project":{ja:""},"Load From GitHub Repository":{ja:"GitHub"},"Open Local File":{ja:""},"Sign In With GitHub":{ja:""},"Sign Out":{},"Tile Tools":{},Cell:{},Frame:{},Pencil:{},Blank:{},"Fill Bucket":{},Eyedropper:{},Line:{},Rect:{},Oval:{},Marquee:{},Type:{},Pixel:{},Block:{},Zoom:{},Hand:{},Move:{}};var TouchVelocity=function(){this.touches=[]};TouchVelocity.prototype={init:function(){},pruneTouches:function(e){var t=getTimestamp();var i=t-e;while(this.touches.length>0&&this.touches[0].t<i){this.touches.shift()}},reset:function(){this.touches=[]},touchStart:function(e){this.reset()},touchMove:function(e){var t=e.touches;if(t.length>0){var i=t[0].pageX;var r=t[0].pageY;var a=getTimestamp();this.touches.push({t:a,x:i,y:r});this.pruneTouches(100)}},touchEnd:function(e){},getVelocity:function(){this.pruneTouches(1e3);var e=this.touches.length;if(e<2){return{x:0,y:0}}var t=this.touches[e-1].x-this.touches[0].x;var i=this.touches[e-1].y-this.touches[0].y;var r=this.touches[e-1].t-this.touches[0].t;return{vx:t/r,vy:i/r}}};THREE.Camera3dControls=function(e,t){this.object=e;this.domElement=t!==undefined?t:document;this.enabled=true;this.target=new THREE.Vector3;this.center=this.target;this.noZoom=false;this.zoomSpeed=1;this.minDistance=0;this.maxDistance=Infinity;this.minZoom=0;this.maxZoom=Infinity;this.noRotate=false;this.rotateSpeed=1;this.noPan=false;this.keyPanSpeed=7;this.autoRotate=false;this.autoRotateSpeed=2;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.noKeys=false;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var o=this;var i=1e-6;var s=new THREE.Vector2;var l=new THREE.Vector2;var n=new THREE.Vector2;var h=new THREE.Vector2;var d=new THREE.Vector2;var c=new THREE.Vector2;var r=new THREE.Vector3;var a=new THREE.Vector3;var f=new THREE.Vector2;var u=new THREE.Vector2;var p=new THREE.Vector2;var v;var g;var m=0;var y=0;var b=1;var C=new THREE.Vector3;var x=new THREE.Vector3;var S=new THREE.Quaternion;var P={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5};var w=P.NONE;this.target0=this.target.clone();this.position0=this.object.position.clone();this.zoom0=this.object.zoom;var I=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0));var k=I.clone().inverse();var M={type:"change"};var T={type:"start"};var D={type:"end"};this.rotateLeft=function(e){if(e===undefined){e=E()}y-=e};this.rotateUp=function(e){if(e===undefined){e=E()}m-=e};this.panLeft=function(e){var t=this.object.matrix.elements;r.set(t[0],t[1],t[2]);r.multiplyScalar(-e);C.add(r)};this.panUp=function(e){var t=this.object.matrix.elements;r.set(t[4],t[5],t[6]);r.multiplyScalar(e);C.add(r)};this.panIn=function(e){var t=this.object.matrix.elements;r.set(t[8],t[9],t[10]);r.multiplyScalar(e);C.add(r)};this.pan=function(e,t){var i=o.domElement===document?o.domElement.body:o.domElement;if(o.object instanceof THREE.PerspectiveCamera){var r=o.object.position;var a=r.clone().sub(o.target);var s=a.length();s*=Math.tan(o.object.fov/2*Math.PI/180);o.panLeft(2*e*s/i.clientHeight);o.panUp(2*t*s/i.clientHeight)}else if(o.object instanceof THREE.OrthographicCamera){o.panLeft(e*(o.object.right-o.object.left)/i.clientWidth);o.panUp(t*(o.object.top-o.object.bottom)/i.clientHeight)}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")}};this.getScale=function(){return b};this.setScale=function(e){b=e};this.dollyIn=function(e){if(e===undefined){e=$()}if(o.object instanceof THREE.PerspectiveCamera){b/=e}else if(o.object instanceof THREE.OrthographicCamera){o.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom*e));o.object.updateProjectionMatrix();o.dispatchEvent(M)}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")}};this.dollyOut=function(e){if(e===undefined){e=$()}if(o.object instanceof THREE.PerspectiveCamera){b*=e}else if(o.object instanceof THREE.OrthographicCamera){o.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/e));o.object.updateProjectionMatrix();o.dispatchEvent(M)}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")}};this.update=function(){var e=this.object.position;a.copy(e).sub(this.target);a.applyQuaternion(I);v=Math.atan2(a.x,a.z);g=Math.atan2(Math.sqrt(a.x*a.x+a.z*a.z),a.y);if(this.autoRotate&&w===P.NONE){this.rotateLeft(E())}v+=y;g+=m;v=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,v));g=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,g));g=Math.max(i,Math.min(Math.PI-i,g));var t=a.length()*b;t=Math.max(this.minDistance,Math.min(this.maxDistance,t));this.target.add(C);a.x=t*Math.sin(g)*Math.sin(v);a.y=t*Math.cos(g);a.z=t*Math.sin(g)*Math.cos(v);a.applyQuaternion(k);e.copy(this.target).add(a);this.object.lookAt(this.target);y=0;m=0;b=1;C.set(0,0,0);if(x.distanceToSquared(this.object.position)>i||8*(1-S.dot(this.object.quaternion))>i){this.dispatchEvent(M);x.copy(this.object.position);S.copy(this.object.quaternion)}};this.reset=function(){w=P.NONE;this.target.copy(this.target0);this.object.position.copy(this.position0);this.object.zoom=this.zoom0;this.object.updateProjectionMatrix();this.dispatchEvent(M);this.update()};this.getPolarAngle=function(){return g};this.getAzimuthalAngle=function(){return v};function E(){return 2*Math.PI/60/60*o.autoRotateSpeed}function $(){return Math.pow(.95,o.zoomSpeed)}function _(e){if(o.enabled===false)return;e.preventDefault();if(e.button===o.mouseButtons.ORBIT){if(o.noRotate===true)return;w=P.ROTATE;s.set(e.clientX,e.clientY)}else if(e.button===o.mouseButtons.ZOOM){if(o.noZoom===true)return;w=P.DOLLY;f.set(e.clientX,e.clientY)}else if(e.button===o.mouseButtons.PAN){if(o.noPan===true)return;w=P.PAN;h.set(e.clientX,e.clientY)}if(w!==P.NONE){document.addEventListener("mousemove",B,false);document.addEventListener("mouseup",R,false);o.dispatchEvent(T)}}function B(e){if(o.enabled===false)return;e.preventDefault();var t=o.domElement===document?o.domElement.body:o.domElement;if(w===P.ROTATE){if(o.noRotate===true)return;l.set(e.clientX,e.clientY);n.subVectors(l,s);o.rotateLeft(2*Math.PI*n.x/t.clientWidth*o.rotateSpeed);o.rotateUp(2*Math.PI*n.y/t.clientHeight*o.rotateSpeed);s.copy(l)}else if(w===P.DOLLY){if(o.noZoom===true)return;u.set(e.clientX,e.clientY);p.subVectors(u,f);if(p.y>0){o.dollyIn()}else if(p.y<0){o.dollyOut()}f.copy(u)}else if(w===P.PAN){if(o.noPan===true)return;d.set(e.clientX,e.clientY);c.subVectors(d,h);o.pan(c.x,c.y);h.copy(d)}if(w!==P.NONE)o.update()}function R(){if(o.enabled===false)return;document.removeEventListener("mousemove",B,false);document.removeEventListener("mouseup",R,false);o.dispatchEvent(D);w=P.NONE}function A(e){if(o.enabled===false||o.noZoom===true||w!==P.NONE)return;e.preventDefault();e.stopPropagation();var t=0;if(e.wheelDelta!==undefined){t=e.wheelDelta}else if(e.detail!==undefined){t=-e.detail}if(t>0){o.dollyOut()}else if(t<0){o.dollyIn()}o.update();o.dispatchEvent(T);o.dispatchEvent(D)}function F(e){if(o.enabled===false||o.noKeys===true||o.noPan===true)return;switch(e.keyCode){case o.keys.UP:o.pan(0,o.keyPanSpeed);o.update();break;case o.keys.BOTTOM:o.pan(0,-o.keyPanSpeed);o.update();break;case o.keys.LEFT:o.pan(o.keyPanSpeed,0);o.update();break;case o.keys.RIGHT:o.pan(-o.keyPanSpeed,0);o.update();break}}function L(e){if(o.enabled===false)return;switch(e.touches.length){case 1:if(o.noRotate===true)return;w=P.TOUCH_ROTATE;s.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(o.noZoom===true)return;w=P.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX;var i=e.touches[0].pageY-e.touches[1].pageY;var r=Math.sqrt(t*t+i*i);f.set(0,r);break;case 3:if(o.noPan===true)return;w=P.TOUCH_PAN;h.set(e.touches[0].pageX,e.touches[0].pageY);break;default:w=P.NONE}if(w!==P.NONE)o.dispatchEvent(T)}function U(e){if(o.enabled===false)return;e.preventDefault();e.stopPropagation();var t=o.domElement===document?o.domElement.body:o.domElement;switch(e.touches.length){case 1:if(o.noRotate===true)return;if(w!==P.TOUCH_ROTATE)return;l.set(e.touches[0].pageX,e.touches[0].pageY);n.subVectors(l,s);o.rotateLeft(2*Math.PI*n.x/t.clientWidth*o.rotateSpeed);o.rotateUp(2*Math.PI*n.y/t.clientHeight*o.rotateSpeed);s.copy(l);o.update();break;case 2:if(o.noZoom===true)return;if(w!==P.TOUCH_DOLLY)return;var i=e.touches[0].pageX-e.touches[1].pageX;var r=e.touches[0].pageY-e.touches[1].pageY;var a=Math.sqrt(i*i+r*r);u.set(0,a);p.subVectors(u,f);if(p.y>0){o.dollyOut()}else if(p.y<0){o.dollyIn()}f.copy(u);o.update();break;case 3:if(o.noPan===true)return;if(w!==P.TOUCH_PAN)return;d.set(e.touches[0].pageX,e.touches[0].pageY);c.subVectors(d,h);o.pan(c.x,c.y);h.copy(d);o.update();break;default:w=P.NONE}}function H(){if(o.enabled===false)return;o.dispatchEvent(D);w=P.NONE}this.update()};THREE.Camera3dControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.Camera3dControls.prototype.constructor=THREE.Camera3dControls;var SHOWUNFINISHED=false;var g_urlParams=new URLSearchParams(window.location.search);if(g_urlParams.has("features")&&g_urlParams.get("features")=="all"){SHOWUNFINISHED=true}var g_paramEditor="";if(g_urlParams.has("editor")){g_paramEditor=g_urlParams.get("editor")}var lut=[];for(var i=0;i<256;i++){lut[i]=(i<16?"0":"")+i.toString(16)}function generateUUID(){var e=Math.random()*4294967295|0;var t=Math.random()*4294967295|0;var i=Math.random()*4294967295|0;var r=Math.random()*4294967295|0;var a=lut[e&255]+lut[e>>8&255]+lut[e>>16&255]+lut[e>>24&255]+"-"+lut[t&255]+lut[t>>8&255]+"-"+lut[t>>16&15|64]+lut[t>>24&255]+"-"+lut[i&63|128]+lut[i>>8&255]+"-"+lut[i>>16&255]+lut[i>>24&255]+lut[r&255]+lut[r>>8&255]+lut[r>>16&255]+lut[r>>24&255];return a.toUpperCase()}function base64ToBuffer(e){var t=atob(e);var i=new Uint8Array(t.length);for(var r=0,a=i.length;r<a;r++){i[r]=t.charCodeAt(r)}return i}var Editor=function(){this.mode=false;this.newProjectDialog=null;this.mobileInterfaceType="full";this.projectSplitPanel=null;this.mainSplitPanel=null;this.menuBar=null;this.spriteEditor=null;this.textModeEditor=null;this.projectShare=null;this.music=null;this.assemblerEditor=null;this.colorPaletteEditor=null;this.tileSetEditor=null;this.scriptEditor=null;this.jsonEditor=null;this.textEditor=null;this.hexEditor=null;this.createTemplateLink=null;this.c64Debugger=null;this.nesDebugger=null;this.x16Debugger=null;this.dbgFont=null;this.features={};this.projectNavigator=null;this.projectNavigatorMobile=null;this.fileManager=null;this.doc=null;this.menuItems={};this.confirmLeave=true;this.allowKeyShortcuts=true;this.deviceType="desktop";this.githubClient=null;this.gistClient=null;this.githubLogoutDialog=null;this.gdrive=null;this.state={user:{},isLoggedIn:false};this.repositories=[];this.openingProject=false;this.fontSize=14;this.isElectron=false};var firestoreDb=null;Editor.prototype={init:function(e){this.setEnabled("textmode3d",true);if(typeof e!="undefined"){if(typeof e.type!="undefined"){this.isElectron=e.type=="electron"}}if(UI.isMobile.any()){this.deviceType="mobile"}else{this.deviceType="desktop"}var t=this;this.githubClient=new GitHubClient;this.githubClient.on("login",function(){t.displayUserDetails()});this.githubClient.on("logout",function(){t.confirmLogout();t.displayUserDetails()});this.github=new GitHubUI;this.github.init(this.githubClient);this.gist=new GistUI;this.gist.init(this.githubClient);this.gdrive=new GDrive;this.gdrive.init();this.gdrive.handleClientLoad();this.initFirebase();this.loadGlobalPrefs();this.buildInterface();this.fileManager=new FileManager;this.fileManager.init(this);this.textDialog=new TextDialog;this.startPage.processURL()},getNewProjectDialog:function(){if(this.newProjectDialog==null){this.newProjectDialog=new NewProjectDialog;this.newProjectDialog.init()}return this.newProjectDialog},getGuid:function(){guid=generateUUID();return guid},isOnline:function(){return typeof firebase!=="undefined"},setPref:function(e,t){if(typeof Storage!=="undefined"){localStorage.setItem(e,t)}},getPref:function(e){if(typeof Storage!=="undefined"){return localStorage.getItem(e)}},loadGlobalPrefs:function(){this.fontSize=parseInt(g_app.getPref("codeeditor.fontsize"),10);if(this.fontSize==null||isNaN(this.fontSize)||this.fontSize<=0){this.fontSize=14}else{this.fontSize=parseInt(this.fontSize)}this.setFontSize(this.fontSize)},setUser:function(e){var t=this.state;if(e==null){t.isLoggedIn=false;this.displayUserDetails()}else{t.isLoggedIn=true;t.user.id=e.uid;t.user.name=e.displayName;firestoreDb.collection("users").doc(t.user.id).set(t.user,{merge:true})}},openProject:function(e){var t=e.projectId;var s=e.projectName;var o=e.currentPath;var l=e.projectNavVisible;var n=e.githubOwner;var h=e.githubRepository;this.openingProject=true;this.doc=new Document;this.doc.init(this);this.createDocumentStructure(this.doc);var d=this;this.doc.openBrowserStorageProject(e,function(){d.fileManager.filename=s;var e=g_app.doc.getDocRecord("/settings");e.data.filename=s;d.projectNavigator.refreshTree();var t=false;if(typeof o!="undefined"&&o!==false){var i=d.doc.getDocRecord(o);if(i){if(d.projectNavigator.showDocRecord(o)!==false){t=true}}}if(!t){var r=d.doc.dir("/screens");if(r&&r.length>0){var a=r[0].name;d.setMode("2d");d.textModeEditor.loadScreen("/screens/"+a);t=true}}if(!t){g_app.setMode("none")}if(typeof l!="undefined"&&l){d.projectNavigator.setVisible(l)}d.github.setRepositoryDetails(n,h);d.openingProject=false})},confirmLogout:function(){var e=false;if(this.githubLogoutDialog==null){var t=300;height=190;if(UI.isMobile.any()){height=240}this.githubLogoutDialog=UI.create("UI.Dialog",{id:"githubLogutDialog",title:"Logged Out",width:t,height:height});var i="";i="<div>";i+="<p>You have signed out of lvllvl</p>";i+="<p>You may still be signed into GitHub</p>";i+="<p>Click the button below if you would also like to sign out of GitHub</p>";i+="</div>";i+="<div>";i+='<div class="ui-button ui-button-nextaction" id="signOutOfGitHub">Sign out of GitHub</div>';i+="</div>";var r=UI.create("UI.HTMLPanel",{html:i});this.githubLogoutDialog.add(r);var a=UI.create("UI.Button",{text:"Close",color:"secondary"});this.githubLogoutDialog.addButton(a);a.on("click",function(e){UI.closeDialog()});e=true}UI.showDialog("githubLogutDialog");if(e){$("#signOutOfGitHub").on("click",function(e){window.open("https://github.com/logout");UI.closeDialog()})}},displayUserDetails:function(){var e='<img src="icons/svg/glyphicons-halflings-1-user.svg" height="16" style="filter: invert(65%)">';if(this.githubClient.isLoggedIn()){var t=this.githubClient.getLoginName();$("#start-username").html(e+"&nbsp;"+t);$("#start-user-info").html(e+" Signed in as "+t);var i='<div style="text-align: right; margin-right: 10px">';i+=e+"&nbsp;"+t;i+=' (<a href="#" style="color: white; cursor: pointer" id="menuSignOut">Sign Out</a>)';i+="</div>";$("#menuUserInfo").html(i);var r=this;$("#menuSignOut").on("click",function(e){e.preventDefault();g_app.githubClient.logout()});var i="";i+='<div style="padding: 10px; margin-bottom: 20px; background-color: #222222; position: relative">';i+='<div style="font-size: 20px; display: inline-block; width: 200px; line-height: 36px; overflow: hidden">'+e+"&nbsp;"+t+"</div>";i+='<div class="ui-button" id="mobileMenuSignOut" style="position: absolute; right: 10px; top: 10px">Sign Out</div>';i+="</div>";$("#mobileMenuUserInfo").html(i);$("#mobileMenuSignOut").on("click",function(e){e.preventDefault();g_app.githubClient.logout()})}else{$("#start-username").html("");$("#start-user-info").html(e+" You are not signed in");var i='<div style="text-align: right; margin-right: 10px; margin-top: 4px">';i+='<div class="ui-button ui-button-info" id="menuSignIn">';i+='<img src="icons/GitHub-Mark-32px.png"/>';i+="&nbsp;&nbsp;Sign In With GitHub...</div>";i+="</div>";$("#menuUserInfo").html(i);$("#menuSignIn").on("click",function(e){e.preventDefault();g_app.githubClient.login()});var i='<div style="padding: 10px">';i+='<div style="font-size: 20px; margin-bottom: 10px">You are not signed in.</div>';i+="<div>";i+="</div>";i+="</div>";$("#mobileMenuUserInfo").html(i);$("#mobileMenuSignIn").on("click",function(e){e.preventDefault();g_app.githubClient.login()})}},initFirebase:function(){var t=this;if(typeof firebase!="undefined"){const i={apiKey:"AIzaSyAuSjHOq2_3RYn4fwBRRMqXSOON2SxjxCY",authDomain:"lvllvl.firebaseapp.com",databaseURL:"https://lvllvl.firebaseio.com",projectId:"lvllvl",storageBucket:"lvllvl.appspot.com",messagingSenderId:"673634360731",appId:"1:673634360731:web:3cfe4f051e2e98ed",measurementId:"G-0ENX7VSE20"};var e=firebase.initializeApp(i);firebase.auth().onAuthStateChanged(function(e){if(e){t.setUser(e);t.getRepositoryList();$("#login").hide();$("#start-login-mobile").hide();$("#logout").show();$("#start-logout-mobile").show();try{t.githubClient.setUser(e,function(){t.startPage.userLoginStatusUpdated()})}catch(e){console.log("login exception");console.log(e);t.githubClient.login()}}else{t.setUser(null);t.githubClient.setUser(null);t.getRepositoryList();t.startPage.userLoginStatusUpdated();$("#login").show();$("#start-login-mobile").show();$("#logout").hide();$("#start-logout-mobile").hide()}});firestoreDb=firebase.firestore()}},removeRepository:function(e,t,i){var r=firebase.auth().currentUser;if(r==null){return}var a=e+"-"+t;firestoreDb.collection("users/"+r.uid+"/repositories").doc(a).delete().then(function(){i()}).catch(function(e){console.log(e)})},getRepositoryList:function(){var e=firebase.auth().currentUser;if(e==null){this.repositories=[];this.startPage.updateRepositories();return}var i=this;firestoreDb.collection("users/"+e.uid+"/repositories").get().then(function(e){i.repositories=[];e.forEach(function(e){var t=e.data();i.repositories.push(t);i.startPage.updateRepositories()})})},setEnabled:function(e,t){this.features[e]=t},getEnabled:function(e){if(typeof this.features[e]=="undefined"){return true}return this.features[e]},initModeEvents:function(){var t=this;$(window).on("beforeunload",function(e){if(g_app.confirmLeave){e.preventDefault();return"Are you sure you want to leave this page?"}});UI.on("update",function(){t.update()});UI.on("keydown",function(e){t.keyDown(e)});UI.on("keyup",function(e){t.keyUp(e)});UI.on("keypress",function(e){t.keyPress(e)});$("#shareButton").on("click",function(){t.share()})},setAllowKeyShortcuts:function(e){this.allowKeyShortcuts=e;switch(this.mode){case"assembler":this.assemblerEditor.willReceiveKeyboardEvents(e);break;case"c64":this.c64Debugger.blurMachine();break}},keyDown:function(e){if(e.keyCode==89&&(e.metaKey||e.ctrlKey)){this.redo()}if(!this.allowKeyShortcuts){return}switch(this.mode){case"3d":case"2d":this.textModeEditor.keyDown(e);break;case"sprite":this.spriteEditor.keyDown(e);break;case"music":this.music.keyDown(e);break;case"c64":this.c64Debugger.keyDown(e);break;case"nes":this.nesDebugger.keyDown(e);break;case"color palette":this.colorPaletteEditor.colorPaletteEdit.keyDown(e);break;case"assembler":this.assemblerEditor.keyDown(e);break}},keyUp:function(e){if(!this.allowKeyShortcuts){return}switch(this.mode){case"3d":case"2d":this.textModeEditor.keyUp(e);break;case"sprite":this.spriteEditor.keyUp(e);break;case"music":this.music.keyUp(e);break;case"c64":this.c64Debugger.keyUp(e);break;case"nes":this.nesDebugger.keyUp(e);break;case"color palette":this.colorPaletteEditor.colorPaletteEdit.keyUp(e);break;case"assembler":this.assemblerEditor.keyUp(e);break}},keyPress:function(e){if(!this.allowKeyShortcuts){return}switch(this.mode){case"3d":case"2d":this.textModeEditor.keyPress(e);break;case"sprite":this.spriteEditor.keyPress(e);break;case"music":this.music.keyPress(e);break;case"color palette":this.colorPaletteEditor.colorPaletteEdit.keyPress(e);break}},setDeviceType:function(e){if(e=="desktop"){this.deviceType="desktop";UI("menubar").setVisible(true);UI("mobileMenuBar").setVisible(false);UI("projectSplitPanel").resizeThePanel({panel:"north",size:30});UI("tabSplitPanel").setPanelVisible("north",true)}if(e=="mobile"){this.deviceType="mobile";UI("menubar").setVisible(false);UI("mobileMenuBar").setVisible(true);UI("projectSplitPanel").resizeThePanel({panel:"north",size:70});UI("tabSplitPanel").setPanelVisible("north",false)}if(this.textModeEditor){this.textModeEditor.setDeviceType(e)}},isDesktopApp:function(){return this.isElectron},isMobile:function(){return this.deviceType=="mobile"},getMode:function(){return this.mode},setMode:function(e){this.mode=e;if(g_app.isMobile()){$("#mobileMenuUndoRedo").show()}switch(e){case"start":if(this.projectPanel){this.projectPanel.setPanelVisible("north",false)}this.startPage.show();UI.setWebGLEnabled(false);this.mainPanel.showOnly("startPage");break;case"3d":this.projectPanel.setPanelVisible("north",true);UI.setWebGLEnabled(true);this.contentPanel.showOnly("textModeEditor");this.textModeEditor.setType("3d");this.mainPanel.showOnly("projectSplitPanel");this.menuBar.showOnly("ui-menu-tilemode");$(".ui-menu-screen").show();$(".ui-menu-sprite").hide();this.textModeEditor.currentTile.setSouthPanelSize();this.menuBar.showOnly("ui-menu-3d");UI("gridPanel").showOnly("grid3d");this.textModeEditor.gridView3d.uiComponent.resize();this.textModeEditor.setEditorMode("tile");if(g_app.isMobile()){$(".drawToolMobileSide2d").hide();$(".drawToolMobileSide3d").show();$("#toolIconHolderMobile").css("bottom","94px");$("#toolIconsScrollBottom").css("bottom","94px");$("#drawToolMobileColors").css("height","80px")}break;case"2d":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}if(g_app.isMobile()){$("#mobileMenuCurrentTools").show()}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("textModeEditor");this.textModeEditor.setType("2d");UI("gridPanel").showOnly("grid2d");UI("gridView2d").resize();this.menuBar.showOnly("ui-menu-tilemode");if(this.textModeEditor.graphic&&this.textModeEditor.graphic.getType()=="sprite"){$(".ui-menu-screen").hide();$(".ui-menu-sprite").show()}else{$(".ui-menu-screen").show();$(".ui-menu-sprite").hide()}this.textModeEditor.tools.drawTools.tilePalette.drawTilePalette();this.textModeEditor.frames.updateFrameInfo();if(g_app.isMobile()){this.textModeEditor.tools.drawTools.checkMobileToolScroll()}if(g_app.isMobile()){$(".drawToolMobileSide2d").show();$(".drawToolMobileSide3d").hide();$("#toolIconHolderMobile").css("bottom","194px");$("#toolIconsScrollBottom").css("bottom","194px");$("#drawToolMobileColors").css("height","180px")}else{this.textModeEditor.updateEastInfoPanel()}break;case"color palette":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("colorPaletteEditor");this.menuBar.showOnly("ui-menu-colorpalette");break;case"tile set":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("tileSetEditor");this.menuBar.showOnly("ui-menu-tileset");break;case"script":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.scriptEditor.show();this.contentPanel.showOnly("scriptEditor");this.menuBar.showOnly("ui-menu-script");break;case"json":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}UI.setWebGLEnabled(false);this.jsonEditor.show();this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("jsonEditor");this.menuBar.showOnly("ui-menu-script");break;case"text":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}UI.setWebGLEnabled(false);this.textEditor.show();this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("textEditor");this.menuBar.showOnly("ui-menu-script");break;case"hex":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("hexEditor");this.menuBar.showOnly("ui-menu-script");break;case"music":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("musicEditor");this.menuBar.showOnly("ui-menu-music");UI("musicEditor").resize();break;case"assembler":if(g_app.isMobile()){$("#mobileMenuCurrentTools").hide()}if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.mainSplitPanel.setPanelVisible("north",true);this.menuBar.showOnly("ui-menu-c64-assembler");this.showAssembler();break;case"c64":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}if(g_app.isMobile()){$("#mobileMenuUndoRedo").hide()}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("c64debuggerPanel");this.menuBar.showOnly("ui-menu-c64");this.c64Debugger.show();break;case"nes":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}if(g_app.isMobile()){$("#mobileMenuUndoRedo").hide()}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("nesdebuggerPanel");this.menuBar.showOnly("ui-menu-nes");this.nesDebugger.show();break;case"x16":if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}if(g_app.isMobile()){$("#mobileMenuUndoRedo").hide()}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("x16DebuggerPanel");this.x16Debugger.show();break;default:if(this.projectPanel){this.projectPanel.setPanelVisible("north",true)}if(g_app.isMobile()){$("#mobileMenuUndoRedo").hide()}UI.setWebGLEnabled(false);this.mainPanel.showOnly("projectSplitPanel");this.contentPanel.showOnly("noEditorPanel");break}if(this.menuBar){if(e=="assembler"){this.menuBar.setShortcutEnabled({cmd:true,key:"Z"},false);this.menuBar.setShortcutEnabled({cmd:true,shift:true,key:"Z"},false);this.menuBar.setShortcutEnabled({cmd:true,key:"X"},false);this.menuBar.setShortcutEnabled({cmd:true,key:"C"},false);this.menuBar.setShortcutEnabled({cmd:true,key:"V"},false)}else{this.menuBar.setShortcutEnabled({cmd:true,key:"Z"},true);this.menuBar.setShortcutEnabled({cmd:true,shift:true,key:"Z"},true);this.menuBar.setShortcutEnabled({cmd:true,key:"X"},true);this.menuBar.setShortcutEnabled({cmd:true,key:"C"},true);this.menuBar.setShortcutEnabled({cmd:true,key:"V"},true)}}},debugMessage:function(e){},mobileMenuBarLoaded:function(){var t=this;$("#mobileMenuBarHamburger").on("click",function(e){t.textModeEditor.showMobileMenu()});$("#mobileMenuBarUndo").on("click",function(e){t.undo()});$("#mobileMenuBarRedo").on("click",function(e){t.redo()})},getMobileInterfaceType:function(){return this.mobileInterfaceType},mobileReduceInterface:function(){this.mobileInterfaceType="reduced";this.textModeEditor.mobileReduceInterface()},mobileRestoreInterface:function(){this.mobileInterfaceType="full";this.textModeEditor.mobileRestoreInterface()},buildInterface:function(){var a=this.isMobile();this.mainPanel=UI.create("UI.Panel",{id:"mainPanel"});UI.add(this.mainPanel);this.projectPanel=UI.create("UI.SplitPanel",{id:"projectSplitPanel"});this.mainPanel.add(this.projectPanel);this.mainSplitPanel=UI.create("UI.SplitPanel",{id:"mainSplitPanel"});this.projectPanel.add(this.mainSplitPanel);var s=this;UI.on("ready",function(){var e=false;var t=30;if(a){e=true;t=46}s.menuBar=UI.create("UI.MenuBar",{id:"menubar",visible:!e});s.menuBarHolder=UI.create("UI.Panel",{id:"menuBarHolder"});s.menuSplit=UI.create("UI.SplitPanel",{id:"menuSplit",visible:!e});var i='<div style="text-align: right">';i+='<div id="menuUserInfo" style="display: inline-block"></div>';i+='<div class="ui-button" id="shareButton" style="margin-left: 4px"><img src="icons/material/share-24px.svg">&nbsp;Share</div>';i+="</div>";s.userInfoPanel=UI.create("UI.HTMLPanel",{html:i});s.menuSplit.addEast(s.userInfoPanel,280,false);s.menuSplit.add(s.menuBar);s.projectPanel.addNorth(s.menuBarHolder,t,false);s.menuBarHolder.add(s.menuSplit);s.mobileMenuBar=UI.create("UI.HTMLPanel",{id:"mobileMenuBar",visible:e});s.menuBarHolder.add(s.mobileMenuBar);s.mobileMenuBar.load("html/textMode/mobileMenuBar.html",function(){s.mobileMenuBarLoaded()});s.initModeEvents();var r=null;r=s.menuBar.addMenu({label:"Project",className:"ui-menu-music ui-menu-tilemode ui-menu-3d ui-menu-colorpalette ui-menu-tileset ui-menu-script ui-menu-c64-assembler"});r.addItem({label:"New Project...",id:"file-new"});if(SHOWUNFINISHED&&g_paramEditor!="assembler"){r.addItem({label:"Project Explorer"+"...",id:"show-project-explorer",shortcut:{cmd:true,key:"P"}});r.addSeparator({})}r.addItem({label:"Save",id:"file-save",shortcut:{key:"S",cmd:true}});r.addItem({label:"Save As...",id:"file-saveas",shortcut:{key:"S",cmd:true,shift:true}});r.addItem({label:"Commit Project To GitHub...",id:"file-commit",shortcut:{key:"C",cmd:true,shift:true}});r.addItem({label:"Commit Changes To GitHub...",id:"project-commitchanges",shortcut:{key:"C",cmd:true,shift:true}});r.addItem({label:"Share Project...",id:"project-share"});r.addItem({label:"Download Project...",id:"file-download",shortcut:{key:"D",shift:true,cmd:true,shift:true}});r.addSeparator({});r.addItem({label:"Create A Template Link...",id:"file-templateLink"});UI("project-commitchanges").setVisible(false);r=s.menuBar.addMenu({label:"Edit",className:"ui-menu-tilemode ui-menu-3d"});r.addItem({label:"Undo",id:"edit-undo",shortcut:{cmd:true,key:"Z"}});r.addItem({label:"Redo",id:"edit-redo",shortcut:{cmd:true,shift:true,key:"Z"}});r.addSeparator({});r.addItem({label:"Cut",id:"edit-cut",shortcut:{cmd:true,key:"X"}});r.addItem({label:"Copy",id:"edit-copy",shortcut:{cmd:true,key:"C"}});r.addItem({label:"Copy as Image To Clipboard",id:"edit-copyimage",shortcut:{cmd:true,key:"I"}});r.addItem({label:"Paste",id:"edit-paste",shortcut:{cmd:true,key:"V"}});r.addItem({label:"Clear All",id:"edit-clearall",shortcut:{key:"Del"}});r.addItem({label:"Clear...",id:"edit-clear"});r.addItem({label:"Select All",id:"edit-selectall",shortcut:{cmd:true,key:"A"}});r.addItem({label:"Deselect",id:"edit-deselect",shortcut:{cmd:true,key:"D"}});r.addSeparator({});r.addItem({label:"Flip H",id:"edit-fliph"});r.addItem({label:"Flip V",id:"edit-flipv"});r.addItem({label:"Replace Colour"+"...",id:"edit-replaceColor"});r.addItem({label:"Replace Tile"+"...",id:"edit-replaceCharacter"});r.addItem({label:"Clear Hidden Tiles"+"...",id:"edit-clearHiddenTiles"});r=s.menuBar.addMenu({label:"Edit",className:"ui-menu-colorpalette"});r.addItem({label:"Undo",id:"colorpaletteedit-undo",shortcut:{cmd:true,key:"Z"}});r.addItem({label:"Redo",id:"colorpaletteedit-redo",shortcut:{cmd:true,shift:true,key:"Z"}});r=s.menuBar.addMenu({label:"Export",className:"ui-menu-tilemode"});r.addSeparator({label:"Visual Formats"});r.addItem({label:"GIF / PNG...",id:"export-image"});r.addItem({label:"Sprite Sheet (PNG)...",id:"export-png"});r.addItem({label:"SVG...",id:"export-svg"});r.addSeparator({label:"C64 Formats"});r.addItem({label:"C64 PRG / D64...",id:"export-prg"});r.addItem({label:"C64 Assembly Source"+"...",id:"export-c64assembly"});r.addItem({label:"Mega65 Assembly Source"+"...",id:"export-mega65assembly"});r.addItem({label:"X16 Assembly Source"+"...",id:"export-x16assembly"});r.addItem({label:"SEQ...",id:"export-seq"});r.addItem({label:"PETSCII C...",id:"export-petsciic"});r.addItem({label:".PET...",id:"export-pet"});r.addItem({label:"CharPad V5...",id:"export-charpad"});r.addItem({label:"SpritePad...",id:"export-spritepad"});if(SHOWUNFINISHED){r.addSeparator({label:"X16 Formats"});r.addItem({label:"X16 Basic"+"...",id:"export-x16basic"})}r.addSeparator({label:"Dev Formats"});r.addItem({label:"JSON...",id:"export-json"});r.addItem({label:"Binary Data"+"...",id:"export-binary"});r.addItem({label:"TXT...",id:"export-txt"});r.addSeparator({label:"Share"});r.addItem({label:"Share...",id:"export-share",shortcut:{cmd:true,key:"H"}});r=s.menuBar.addMenu({label:"Export",className:"ui-menu-3d"});r.addSeparator({label:"Visual Formats"});r.addItem({label:"PNG...",id:"export-3d-png"});r.addItem({label:"GIF"+"...",id:"export-3d-gif"});r.addItem({label:"OBJ"+"...",id:"export-obj"});r.addItem({label:"MagicaVoxel"+"...",id:"export-magicavoxel"});r=s.menuBar.addMenu({label:"Edit",className:"ui-menu-music"});r.addItem({label:"Undo",id:"edit-musicundo",shortcut:{cmd:true,key:"Z"}});r.addItem({label:"Redo",id:"edit-musicredo",shortcut:{cmd:true,shift:true,key:"Z"}});r.addSeparator({});r.addItem({label:"Cut",id:"edit-musiccut",shortcut:{cmd:true,key:"X"}});r.addItem({label:"Copy",id:"edit-musiccopy",shortcut:{cmd:true,key:"C"}});r.addItem({label:"Paste",id:"edit-musicpaste",shortcut:{cmd:true,key:"V"}});r.addItem({label:"Select All",id:"edit-musicselectall",shortcut:{cmd:true,key:"A"}});r.addItem({label:"Deselect",id:"edit-musicdeselect",shortcut:{cmd:true,key:"D"}});r=s.menuBar.addMenu({label:"Export",className:"ui-menu-music"});r.addItem({label:"SID...",id:"export-sid"});r.addItem({label:"PRG / BIN...",id:"export-sidprg"});r.addItem({label:"GoatTracker 2...",id:"export-goattracker"});r=s.menuBar.addMenu({label:"Import",className:"ui-menu-tilemode"});r.addSeparator({label:"2d Formats"});r.addItem({label:"Image / Video"+"...",id:"import-image"});r.addItem({label:"C64 Formats"+"...",id:"import-c64formats"});r.addItem({label:"C64 Formats"+"...",id:"import-c64spriteformats"});r.addItem({label:"Image"+"...",id:"import-spriteimage"});r=s.menuBar.addMenu({label:"Screen",className:"ui-menu-tilemode ui-menu-screen"});r.addItem({label:"Dimensions"+"...",id:"file-dimensions"});r.addItem({label:"Crop To Selection",id:"screen-crop"});r.addSeparator({label:"Mode"});r.addItem({label:"Text Mode",id:"mode-textmode",checked:true});r.addItem({label:"C64 Standard Character Mode",id:"mode-c64standard"});r.addItem({label:"C64 Multicolour Character Mode",id:"mode-c64multicolor"});r.addItem({label:"C64 Extended BG Colour Mode",id:"mode-c64ecm"});r.addItem({label:"Vector Mode",id:"mode-vector"});r.addItem({label:"Indexed Colour",id:"mode-indexed"});r.addItem({label:"RGB Colour",id:"mode-rgb"});if(SHOWUNFINISHED){r.addItem({label:"NES",id:"mode-nes"})}r.addSeparator({label:"Tile Orientation"});r.addItem({label:"Allow Tile Flip",id:"mode-tileflip"});r.addItem({label:"Allow Tile Rotate",id:"mode-tilerotate"});r.addItem({label:"Has Tile Materials",id:"mode-tilematerials"});r.addSeparator({label:styles.text.blockName+" Mode"});r.addItem({label:styles.text.blockName+" Mode",id:"mode-blockmode"});r.addItem({label:styles.text.blockName+" Size"+"...",id:"mode-blocksize"});UI("mode-blocksize").setEnabled(false);r.addSeparator({label:"Colour Mode"});r.addItem({label:"Colour Per Cell",id:"colorpermode-cell",checked:true});r.addItem({label:"Colour Per Tile",id:"colorpermode-character"});r.addItem({label:"Colour Per "+styles.text.blockName,id:"colorpermode-block"});UI("colorpermode-block").setEnabled(false);r.addSeparator({label:"Reference Image"});r.addItem({label:"Set Reference Image"+"...",id:"screen-referenceimage",shortcut:{cmd:true,key:"I"}});r=s.menuBar.addMenu({label:"Sprite",className:"ui-menu-tilemode ui-menu-sprite"});r.addItem({label:"Dimensions"+"...",id:"file-spritedimensions"});r.addSeparator({label:"Mode"});r.addItem({label:"Monochrome",id:"mode-spritetextmode",checked:true});r.addItem({label:"C64 Multicolour",id:"mode-spritec64multicolor"});r.addItem({label:"NES",id:"mode-spritenes"});r.addItem({label:"Indexed",id:"mode-spriteindexed"});r.addSeparator({label:"Help"});r.addItem({label:"Help"+"!",id:"mode-help"});r=s.menuBar.addMenu({label:"Scene",className:"ui-menu-3d"});r.addItem({label:"Dimensions...",id:"dimensions3d",checked:true});r=s.menuBar.addMenu({label:"Layers",className:"ui-menu-tilemode"});r.addItem({label:"New Layer"+"...",id:"layers-new",shortcut:{cmd:true,key:"L"}});r.addSeparator({});r.addItem({label:"Layer Properties"+"...",id:"layers-properties"});r.addItem({label:"Delete Layer",id:"layers-delete"});r.addItem({label:"Bring Forward",id:"layers-moveUp",shortcut:{cmd:true,key:"]"}});r.addItem({label:"Send Backward",id:"layers-moveDown",shortcut:{cmd:true,key:"["}});r.addItem({label:"Toggle Layer Visibility",id:"layers-toggle",shortcut:{cmd:true,key:"\\"}});r.addItem({label:"Select Above",id:"layers-selectAbove",shortcut:{alt:true,key:"]"}});r.addItem({label:"Select Below",id:"layers-selectBelow",shortcut:{alt:true,key:"["}});s.tileSetMenu=s.menuBar.addMenu({label:"Tiles",className:"ui-menu-tilemode ui-menu-screen ui-menu-3d"});s.tileSetMenu.addItem({label:"Show Tile Editor",id:"charactersets-edit",shortcut:{cmd:true,key:"E"}});s.tileSetMenu.addSeparator({label:"Current Tile Set"});s.tileSetMenu.addItem({label:"Choose A Tile Set"+"...",id:"charactersets-preset"});s.tileSetMenu.addItem({label:"Load / Import Tile Set"+"...",id:"charactersets-load"});s.tileSetMenu.addItem({label:"Save Tile Set"+"...",id:"charactersets-save"});s.tileSetMenu.addSeparator({label:"Project Tile Sets"});s.tileSetMenu.addItem({label:"Create a Tile Set...",id:"tileset-new"});r=s.menuBar.addMenu({label:"Tiles",className:"ui-menu-tileset"});r.addItem({label:"Choose A Character Set"+"...",id:"tileset-preset"});r.addItem({label:"Load / Import Tile Set"+"...",id:"tileset-load"});r.addItem({label:"Save Tile Set"+"...",id:"tileset-save"});s.colorPaletteMenu=s.menuBar.addMenu({label:"Colours",className:"ui-menu-tilemode ui-menu-3d"});s.colorPaletteMenu.addItem({label:"Show Colour Editor",id:"color-edit",shortcut:{cmd:true,shift:true,key:"E"}});s.colorPaletteMenu.addSeparator({});s.colorPaletteMenu.addItem({label:"Choose A Colour Palette"+"...",id:"colors-preset"});s.colorPaletteMenu.addItem({label:"Edit Colour Palette"+"...",id:"color-editcolorpalette"});s.colorPaletteMenu.addItem({label:"Load Colour Palette"+"...",id:"colors-load"});s.colorPaletteMenu.addItem({label:"Save Colour Palette"+"...",id:"colors-save"});s.colorPaletteMenu.addSeparator({label:"Project Tile Sets"});s.colorPaletteMenu.addItem({label:"Create a Colour Palette...",id:"colorpalette-new"});r=s.menuBar.addMenu({label:"Import / Export",className:"ui-menu-colorpalette"});r.addItem({label:"Choose A Colour Palette"+"...",id:"colorpalette-preset"});r.addItem({label:"Load Colour Palette"+"...",id:"colorpalette-load"});r.addItem({label:"Save Colour Palette"+"...",id:"colorpalette-save"});r=s.menuBar.addMenu({label:"View",className:"ui-menu-tilemode"});r.addItem({label:"Zoom In",id:"view-zoomin",shortcut:{cmd:true,key:"="}});r.addItem({label:"Zoom Out",id:"view-zoomout",shortcut:{cmd:true,key:"-"}});r.addItem({label:"Fit On Screen",id:"view-fitonscreen",shortcut:{cmd:true,key:"0"}});r.addItem({label:"Actual Pixels",id:"view-actualpixels",shortcut:{cmd:true,key:"1"}});r.addSeparator({});r.addItem({label:"Grid Lines",id:"edit-showgrid",checked:true,shortcut:{cmd:true,key:"G"}});r.addItem({label:"Border",id:"edit-showborder",checked:true,shortcut:{cmd:true,key:"H"}});r.addItem({label:"Background",id:"edit-showbackground",checked:true,shortcut:{cmd:true,key:"B"}});r.addSeparator({});r.addItem({label:"Cursor Tile Is Transparent",id:"cursor-tile-transparent"});r.addSeparator({});r.addItem({label:"Scripting"+"...",id:"edit-scripting",shortcut:{cmd:true,key:"R"}});r=s.menuBar.addMenu({label:"Interface",className:"ui-menu-tilemode"});r.addItem({label:"Tools Panel",id:"view-tools"});r.addSeparator({});r.addItem({label:"Layers Panel",id:"view-layerspanel"});r.addItem({label:"Tile Palette Panel Side",id:"view-tilepalettepanelside"});r.addItem({label:"Meta Tile Palette Panel Side",id:"view-metatilepalettepanelside"});r.addItem({label:"Colour Palette Panel",id:"view-palettepanel"});r.addSeparator({});r.addItem({label:"Tile Palette Panel Bottom",id:"view-tilepalettepanelbottom"});r.addItem({label:"Meta Tile Palette Panel Bottom",id:"view-metatilepalettepanelbottom"});r.addSeparator({});r.addItem({label:"Perf Stats",id:"view-perfstats"});r.addSeparator({});r.addItem({label:"Export GIF / "+"Video (old version)"+"...",id:"export-gif"});r.addItem({label:"Export C64 (new)...",id:"export-c64"});r.addSeparator({});r.addItem({label:"Mobile Mode",id:"settings-mobilemode"});r=s.menuBar.addMenu({label:"C64",className:"ui-menu-assembler-old"});r.addItem({label:"Show Raster Position",id:"c64-viewraster"});r.addItem({label:"Sound Playback",id:"c64-sound",checked:true});r.addSeparator({label:"Joysticks"});r.addItem({label:"Port 1",id:"c64-joystick1"});r.addItem({label:"Port 2",id:"c64-joystick2"});r.addItem({label:"Swap Joysticks",id:"c64-joystickswap"});r.addItem({label:"Joystick Settings...",id:"c64-joysticksettings"});r.addSeparator({label:"1351 Mouse"});r.addItem({label:"Port 1",id:"c64-mouse1"});r.addItem({label:"Port 2",id:"c64-mouse2"});r.addSeparator({label:"Size"});r.addItem({label:"100%",id:"c64-size-1"});r.addItem({label:"200%",id:"c64-size-2"});r.addItem({label:"300%",id:"c64-size-3"});r.addItem({label:"400%",id:"c64-size-4"});r.addItem({label:"Fit",id:"c64-size-fit"});r.addItem({label:"Fit",id:"c64-size-fitpixel"});r.addSeparator({});r.addItem({label:"Load PRG...",id:"c64-loadprg"});r.addItem({label:"Attach D64...",id:"c64-attachd64"});r.addSeparator({label:"PRG Start Settings"});r.addItem({label:"Load/Run",id:"c64-prgloadrun"});r.addItem({label:"Inject into RAM",id:"c64-prginject",checked:true});r.addItem({label:"Random Delay",id:"c64-randomdelay",checked:true});r.addItem({label:"Reset",id:"c64-reset"});r=s.menuBar.addMenu({label:"NES",className:"ui-menu-nes"});r.addItem({label:"Reset Machine",id:"nesdebugger-reset"});r=s.menuBar.addMenu({label:"C64",className:"ui-menu-c64 ui-menu-c64-assembler"});r.addSeparator({label:"Model"});r.addItem({label:"PAL",id:"c64debugger-model-pal",checked:true});r.addItem({label:"NTSC",id:"c64debugger-model-ntsc"});r.addSeparator({});r.addItem({label:"Show Raster Position",id:"c64debugger-viewraster"});r.addItem({label:"Show Grid",id:"c64debugger-grid",shortcut:{cmd:true,key:"G"}});r.addItem({label:"Mouse Info",id:"c64debugger-mouse",shortcut:{cmd:true,key:"I"}});r.addSeparator({});r.addItem({label:"Load PRG...",id:"c64debugger-loadprg"});r.addItem({label:"Attach D64...",id:"c64debugger-attachd64"});r.addItem({label:"Autostart D64...",id:"c64-autostartd64"});r.addItem({label:"Insert CRT...",id:"c64-insertcrt"});r.addSeparator({});r.addItem({label:"Download Snapshot",id:"c64-downloadsnapshot"});r.addSeparator({label:"PRG Start Settings"});r.addItem({label:"Load/Run",id:"c64debugger-prgloadrun"});r.addItem({label:"Inject into RAM",id:"c64debugger-prginject",checked:true});r.addItem({label:"Random Delay",id:"c64debugger-randomdelay",checked:true});r.addSeparator({});r.addItem({label:"Reset Machine",id:"c64debugger-reset"});r=s.menuBar.addMenu({label:"Sound",className:"ui-menu-c64"});r.addItem({label:"Sound Playback",id:"c64debugger-sound",checked:true});r.addSeparator({label:"SID Model"});r.addItem({label:"6581",id:"c64debugger-sound6581",checked:true});r.addItem({label:"8580",id:"c64debugger-sound8580"});r=s.menuBar.addMenu({label:"Joystick",className:"ui-menu-c64 ui-menu-c64-assembler"});r.addItem({label:"Port 1",id:"c64debugger-joystick1"});r.addItem({label:"Port 2",id:"c64debugger-joystick2"});r.addItem({label:"Swap Joysticks",id:"c64debugger-joystickswap",shortcut:{cmd:true,key:"J"}});r.addItem({label:"Joystick Settings...",id:"c64debugger-joysticksettings"});r.addSeparator({label:"1351 Mouse"});r.addItem({label:"Port 1",id:"c64debugger-mouse1"});r.addItem({label:"Port 2",id:"c64debugger-mouse2"});r=s.menuBar.addMenu({label:"Size",className:"ui-menu-c64 ui-menu-c64-assembler"});r.addItem({label:"100%",id:"c64debugger-size-1"});r.addItem({label:"200%",id:"c64debugger-size-2"});r.addItem({label:"300%",id:"c64debugger-size-3"});r.addItem({label:"400%",id:"c64debugger-size-4"});r.addItem({label:"Fit Pixel Multiple",id:"c64debugger-size-fitpixel"});r.addItem({label:"Fit",id:"c64debugger-size-fit"});r=s.menuBar.addMenu({label:"Speed",className:"ui-menu-c64"});r.addItem({label:"25%",id:"c64debugger-speed-25"});r.addItem({label:"50%",id:"c64debugger-speed-50"});r.addItem({label:"100%",id:"c64debugger-speed-100",checked:true});r.addItem({label:"150%",id:"c64debugger-speed-150"});r.addItem({label:"200%",id:"c64debugger-speed-200"});r.addItem({label:"300%",id:"c64debugger-speed-300"});r=s.menuBar.addMenu({label:"View",className:"ui-menu-3d"});r.addItem({label:"Show / Hide Grid",id:"view-3dgrid",shortcut:{cmd:true,key:"G"}});r.addSeparator({});r.addItem({label:"Perf Stats",id:"view-3dperfstats"});r=s.menuBar.addMenu({label:"View",className:"ui-menu-music  ui-menu-colorpalette ui-menu-tileset ui-menu-script"});r.addItem({label:"Project View"+"...",id:"view-project-explorer",shortcut:{cmd:true,key:"P"}});r=s.menuBar.addMenu({label:"View",className:"ui-menu-c64-assembler"});r.addSeparator({label:"Font"});r.addItem({label:"Increase Font Size",id:"view-increase-font-size",shortcut:{cmd:true,key:"="}});r.addItem({label:"Decrease Font Size",id:"view-decrease-font-size",shortcut:{cmd:true,key:"-"}});r.addItem({label:"Reset Font Size",id:"view-reset-font-size",shortcut:{cmd:true,key:"0"}});r.addItem({label:"Show Invisible Characters",id:"view-toggle-invisible-characters"});r.addItem({label:"Autocomplete",id:"view-toggle-autocomplete"});r.addItem({label:"Tab indentation ",id:"view-toggle-tabindentation"});r.addSeparator({label:"Theme"});r.addItem({label:"Light",id:"view-theme-chrome"});r.addItem({label:"Dark",id:"view-theme-tomorrow-night"});r=s.menuBar.addMenu({label:"View",className:"ui-menu-c64"});r.addItem({label:"Disassembly",id:"c64-view-toggle-disassembly"});r.addItem({label:"Scripting",id:"c64-view-toggle-scripting"});r.addItem({label:"BASIC",id:"c64-view-toggle-basic"});r.addItem({label:"Colours",id:"c64-view-toggle-colors"});r.addItem({label:"Memory",id:"c64-view-toggle-memory"});r.addItem({label:"Character Set",id:"c64-view-toggle-charset"});r.addItem({label:"Sprites",id:"c64-view-toggle-sprites"});r.addItem({label:"Bitmap",id:"c64-view-toggle-bitmap"});r.addItem({label:"SID",id:"c64-view-toggle-sid"});r.addItem({label:"Drive",id:"c64-view-toggle-drive"});r.addItem({label:"Docs",id:"c64-view-toggle-docs"});r.addItem({label:"Calculator",id:"c64-view-toggle-calc"});r.addSeparator({});r.addItem({label:"Increase Font Size",id:"c64-view-increase-font-size",shortcut:{cmd:true,key:"="}});r.addItem({label:"Decrease Font Size",id:"c64-view-decrease-font-size",shortcut:{cmd:true,key:"-"}});r.addItem({label:"Reset Font Size",id:"c64-view-reset-font-size",shortcut:{cmd:true,key:"0"}});r.addSeparator({});r.addItem({label:"Perf Stats",id:"c64-view-perfstats"});r=s.menuBar.addMenu({label:"Assembler",className:"ui-menu-c64"});r.addItem({label:"Show Assembler",id:"c64-view-toggle-assembler"});r.addSeparator({});r.addItem({label:"Show Invisible Characters",id:"c64-view-toggle-invisible-characters",shortcut:{cmd:true,key:"9"}});r.addItem({label:"Autocomplete",id:"c64-view-toggle-autocomplete"});r.addItem({label:"Use Tab indentation ",id:"c64-view-toggle-tabindentation"});r.addSeparator({label:"Theme"});r.addItem({label:"Light",id:"c64-view-theme-chrome"});r.addItem({label:"Dark",id:"c64-view-theme-tomorrow-night"});r=s.menuBar.addMenu({label:"Share",className:"ui-menu-c64 ui-menu-c64-share"});r.addItem({label:"Create a Link to the Current PRG/D64/CRT...",id:"c64-share-link"});r.addItem({label:"Export PRG/D64/CRT as a HTML Page...",id:"c64-export-html-page"});r=s.menuBar.addMenu({label:"Help",className:"ui-menu-tilemode"});r.addItem({label:"Common Actions"+"...",id:"help-commonactionshortcuts"});r.addItem({label:"Mouse / Keyboard shortcuts"+"...",id:"help-keyboardshortcuts"});if(SHOWUNFINISHED){r.addItem({label:"Scripting API"+"...",id:"help-scriptingapi"})}s.menuBar.on("itemclick",function(e){s.menuClick(e)});s.uiNumber=new UINumber;s.uiNumber.init();s.mainPanel.showOnly("startPage");s.textModeEditor.loadPreferences()});this.tabSplitPanel=UI.create("UI.SplitPanel",{id:"tabSplitPanel"});this.tabPanel=UI.create("UI.TabPanel",{});this.tabPanel.on("tabfocus",function(e,t){var i=s.tabPanel.getTabIndex(e);if(i>=0){var r=s.tabPanel.getTabData(i);var a=r.path;if(typeof a!="undefined"){g_app.projectNavigator.selectDocRecord(a)}}});this.tabPanel.on("notabs",function(e){g_app.setMode("none")});var e=true;if(a){e=true}this.tabSplitPanel.addNorth(this.tabPanel,34,false,e);this.contentPanel=UI.create("UI.Panel",{id:"appContent"});this.tabSplitPanel.add(this.contentPanel);this.mainSplitPanel.add(this.tabSplitPanel);this.startPage=new StartPage;this.startPage.init();this.startPage.buildInterface(this.mainPanel);this.textModeEditor=new TextModeEditor;this.textModeEditor.init();this.textModeEditor.buildInterface(this.contentPanel);this.colorPaletteEditor=new ColorPaletteEditor;this.colorPaletteEditor.init();this.colorPaletteEditor.buildInterface(this.contentPanel);this.tileSetEditor=new TileSetEditor;this.tileSetEditor.init();this.tileSetEditor.buildInterface(this.contentPanel);this.scriptEditor=new ScriptEditor;this.scriptEditor.init({parentPanel:this.contentPanel});this.jsonEditor=new JSONEditor;this.jsonEditor.init({parentPanel:this.contentPanel});this.textEditor=new TextEditor;this.textEditor.init({parentPanel:this.contentPanel});this.hexEditor=new HexEditor;this.hexEditor.init();this.hexEditor.buildInterface(this.contentPanel);this.createTemplateLink=new CreateTemplateLink;this.createTemplateLink.init();this.assembler=new Assembler;this.assembler.init();this.assemblerEditor=new AssemblerEditor;this.assemblerEditor.init();this.assemblerEditor.buildInterface(this.contentPanel);this.music=new Music;this.music.init();this.music.buildInterface(this.contentPanel);this.c64Debugger=new C64Debugger;this.c64Debugger.init();this.c64Debugger.buildInterface(this.contentPanel);this.nesDebugger=new NESDebugger;this.nesDebugger.init();this.nesDebugger.buildInterface(this.contentPanel);this.dbgFont=new DbgFont;this.dbgFont.init();this.setFontSize(this.fontSize);this.scripting=new Scripting;this.scriptingPanel=UI.create("UI.Panel",{id:"scriptingPanel"});this.scripting.init({parentPanel:this.scriptingPanel});this.mainSplitPanel.addWest(this.scriptingPanel,360,true,true);this.projectNavigator=new ProjectNavigator;this.projectNavigator.init(this);this.projectNavigatorPanel=UI.create("UI.Panel",{id:"projectNavigatorPanel"});this.projectNavigator.buildInterface(this.projectNavigatorPanel);this.projectPanel.addWest(this.projectNavigatorPanel,180,true,true)},toggleMobileView:function(){this.tabSplitPanel.setPanelVisible("north",true);this.projectPanel.setPanelVisible("north",true)},setTabPanelVisible:function(){this.tabSplitPanel.setPanelVisible("north",true)},setCurrentDocRecord:function(e){},menuClick:function(e){var t=this;switch(e){case"file-new":var i=g_app.getNewProjectDialog();i.show();break;case"file-open":this.fileManager.openLocalFile();break;case"file-spritedimensions":case"file-dimensions":this.textModeEditor.showDimensionsDialog();break;case"screen-crop":this.textModeEditor.cropToSelection();break;case"3d-mode":this.setMode("3d");break;case"file-save":this.fileManager.save();break;case"file-saveas":this.fileManager.showSaveAs();break;case"file-commit":case"project-commitchanges":g_app.github.save();break;case"project-share":this.share();break;case"file-saveastemplate":this.fileManager.showSaveAsTemplate();break;case"file-nes":this.setMode("nes");break;case"file-x16":this.setMode("x16");break;case"file-download":this.fileManager.showDownload();break;case"file-new":this.fileManager.showNew();break;case"file-templateLink":this.createTemplateLink.show();break;case"edit-undo":case"edit-musicundo":case"colorpaletteedit-undo":this.undo();break;case"edit-redo":case"edit-musicredo":case"colorpaletteedit-undo":this.redo();break;case"edit-cut":case"edit-musiccut":if(this.mode=="3d"||this.mode=="2d"){if(this.textModeEditor.getEditorMode()=="pixel"){this.textModeEditor.tools.drawTools.pixelSelect.cut()}else{this.textModeEditor.tools.drawTools.select.cut()}}if(this.mode=="music"){this.music.cut()}break;case"edit-copy":case"edit-musiccopy":if(this.mode=="3d"||this.mode=="2d"){if(this.textModeEditor.getEditorMode()=="pixel"){this.textModeEditor.tools.drawTools.pixelSelect.copy()}else{this.textModeEditor.tools.drawTools.select.copy();if(this.textModeEditor.tools.drawTools.select.getEnabled()){}}}if(this.mode=="music"){this.music.copy()}break;case"c64debugger-mouse":case"edit-copyimage":if(this.mode=="c64"){this.c64Debugger.showMouseInfo(!this.c64Debugger.mouseInfo)}else{this.textModeEditor.copyAsImage()}break;case"edit-paste":case"edit-musicpaste":if(this.mode=="3d"||this.mode=="2d"){if(this.textModeEditor.getEditorMode()=="pixel"){this.textModeEditor.tools.drawTools.pixelSelect.paste()}else{this.textModeEditor.tools.drawTools.select.paste()}}if(this.mode=="music"){this.music.paste()}break;break;case"edit-clearall":if(this.mode=="3d"||this.mode=="2d"){this.textModeEditor.tools.drawTools.select.clearAll()}if(this.mode=="music"){this.music.clear()}break;case"edit-clear":if(this.mode=="3d"||this.mode=="2d"){this.textModeEditor.tools.drawTools.select.clear()}break;case"edit-musicclear":this.music.clear();break;case"edit-fliph":if(this.textModeEditor.graphic.getType()=="sprite"){this.textModeEditor.tools.drawTools.pixelDraw.flipH()}else{this.textModeEditor.tools.drawTools.select.flipH()}break;case"edit-flipv":if(this.textModeEditor.graphic.getType()=="sprite"){this.textModeEditor.tools.drawTools.pixelDraw.flipV()}else{this.textModeEditor.tools.drawTools.select.flipV()}break;case"edit-selectall":if(this.mode=="3d"||this.mode=="2d"){if(this.textModeEditor.getEditorMode()=="pixel"){this.textModeEditor.tools.drawTools.pixelSelect.selectAll()}else{this.textModeEditor.tools.drawTools.select.selectAll()}}if(this.mode=="music"){this.music.selectAll()}break;case"edit-deselect":if(this.mode=="2d"){if(this.textModeEditor.getEditorMode()=="pixel"){this.textModeEditor.tools.drawTools.pixelSelect.unselectAll()}else{this.textModeEditor.tools.drawTools.select.unselectAll()}}if(this.mode=="3d"){this.textModeEditor.grid3d.selection.unselectAll()}case"edit-musicdeselect":this.music.clearSelect();break;case"edit-replaceColor":this.textModeEditor.replaceColor();break;case"edit-replaceCharacter":this.textModeEditor.replaceCharacter();break;case"edit-clearHiddenTiles":this.textModeEditor.clearHiddenTiles();break;case"edit-c64":this.setMode("c64");break;case"edit-toggleMode":var r=this.textModeEditor.getEditorMode();if(r!="pixel"){this.textModeEditor.setEditorMode("pixel")}else{this.textModeEditor.setEditorMode("tile")}break;case"view-3dgrid":this.textModeEditor.setGridVisible(!this.textModeEditor.getGridVisible());break;case"edit-showborder":this.textModeEditor.grid.toggleBorder();break;case"edit-showbackground":this.textModeEditor.layers.toggleBackground();break;case"edit-showbackgroundimage":this.textModeEditor.grid.toggleBackgroundImage();break;case"edit-setbackgroundimage":this.textModeEditor.backgroundImage.start();break;case"screen-referenceimage":this.textModeEditor.showReferenceImageDialog();break;case"edit-scripting":this.scripting.toggleVisible();break;case"export-png":this.textModeEditor.exportPng();break;case"export-svg":this.textModeEditor.exportSvg();break;case"export-image":this.textModeEditor.exportImage();break;case"export-gif":this.textModeEditor.exportGif();break;case"export-petsciic":this.textModeEditor.doExport("petsciic");break;case"export-pet":this.textModeEditor.doExport("pet");break;case"export-3d-gif":this.textModeEditor.export3dAsGif();break;case"export-charpad":this.textModeEditor.doExport("charpad");break;case"export-spritepad":this.textModeEditor.doExport("spritepad");break;case"export-c64assembly":this.textModeEditor.doExport("c64assembly");break;case"export-mega65assembly":this.textModeEditor.doExport("mega65assembly");break;case"export-x16assembly":this.textModeEditor.doExport("x16assembly");break;case"export-x16basic":this.textModeEditor.doExport("x16basic");break;case"export-share":this.share();break;case"export-txt":this.textModeEditor.doExport("txt");break;case"export-json":this.textModeEditor.doExport("json");break;case"export-binary":this.textModeEditor.doExport("binary");break;case"export-seq":this.textModeEditor.doExport("seq");break;case"export-prg":this.textModeEditor.toPrg.start();break;case"export-c64":this.textModeEditor.exportC64.start();break;case"export-magicavoxel":this.textModeEditor.doExport("vox");break;case"export-obj":this.textModeEditor.doExport("obj");break;case"export-sid":this.music.exportAsType("sid");break;case"export-goattracker":this.music.exportAsType("goattracker");break;case"export-wav":this.music.exportAsType("wav");break;case"export-sidprg":this.music.exportAsType("prg");break;case"import-image":this.textModeEditor.importImage.start();break;case"import-assembly":this.textModeEditor.importAssembly.start();break;case"import-c64formats":this.textModeEditor.importC64Formats.start();break;case"import-c64spriteformats":this.textModeEditor.importC64SpriteFormats.start();break;case"import-spriteimage":this.textModeEditor.startImportSpriteImage();break;case"mode-spritetextmode":case"mode-textmode":this.textModeEditor.setScreenMode(TextModeEditor.Mode.TEXTMODE);break;case"mode-c64standard":this.textModeEditor.setScreenMode(TextModeEditor.Mode.C64STANDARD);break;case"mode-c64ecm":this.textModeEditor.setScreenMode(TextModeEditor.Mode.C64ECM);break;case"mode-vector":this.textModeEditor.setScreenMode(TextModeEditor.Mode.VECTOR);this.textModeEditor.setHasTileFlip(true);this.textModeEditor.setHasTileRotate(true);break;case"mode-spritec64multicolor":case"mode-c64multicolor":this.textModeEditor.setScreenMode(TextModeEditor.Mode.C64MULTICOLOR);break;case"mode-spritenes":case"mode-nes":this.textModeEditor.setScreenMode("nes");this.textModeEditor.colorPaletteManager.colorSubPalettes.check();break;case"mode-indexed":case"mode-spriteindexed":this.textModeEditor.setScreenMode(TextModeEditor.Mode.INDEXED);break;case"mode-rgb":case"mode-spritergb":this.textModeEditor.setScreenMode(TextModeEditor.Mode.RGB);break;case"mode-multicolor":this.textModeEditor.setScreenMode("multicolor");break;case"mode-tileflip":this.textModeEditor.setHasTileFlip(!this.textModeEditor.getHasTileFlip());break;case"mode-tilerotate":this.textModeEditor.setHasTileRotate(!this.textModeEditor.getHasTileRotate());break;case"mode-tilematerials":this.textModeEditor.setHasTileMaterials(!this.textModeEditor.getHasTileMaterials());break;case"mode-blockmode":if(this.textModeEditor.getBlockModeEnabled()){this.textModeEditor.setBlockModeEnabled(false)}else{this.textModeEditor.setBlockModeEnabled(true)}if(this.textModeEditor.getBlockModeEnabled()){UI("mode-blockmode").setChecked(true);UI("mode-blocksize").setEnabled(true);UI("colorpermode-cell").setEnabled(false)}else{UI("mode-blockmode").setChecked(false);UI("mode-blocksize").setEnabled(false);UI("colorpermode-cell").setEnabled(true)}break;case"mode-blocksize":this.textModeEditor.showBlockSizeDialog();break;case"colorpermode-cell":this.textModeEditor.setColorPerMode("cell");break;case"colorpermode-character":this.textModeEditor.setColorPerMode("character");break;case"colorpermode-block":this.textModeEditor.setColorPerMode("block");break;case"layers-new":this.textModeEditor.layers.showNewLayerDialog();break;case"layers-properties":this.textModeEditor.layers.editLayer();break;case"layers-delete":if(confirm("Are you sure you want to delete this layer?")){this.textModeEditor.layers.deleteLayer()}break;case"layers-moveUp":this.textModeEditor.layers.moveLayer(1);break;case"layers-moveDown":this.textModeEditor.layers.moveLayer(-1);break;case"layers-toggle":this.textModeEditor.layers.toggleVisible();break;case"layers-selectAbove":this.textModeEditor.layers.moveSelect(1);break;case"layers-selectBelow":this.textModeEditor.layers.moveSelect(-1);break;case"layers-merge":this.textModeEditor.layers.showLayerMerge();break;case"layers-toframes":this.textModeEditor.layers.showLayersToFrames();break;case"layers-fromframes":this.textModeEditor.layers.showFramesToLayers();break;case"charactersets-edit":this.textModeEditor.showTileEditor();break;case"charactersets-preset":case"tileset-preset":this.textModeEditor.tileSetManager.showChoosePreset({});break;break;case"charactersets-load":case"tileset-load":this.textModeEditor.tileSetManager.showImport({});break;case"charactersets-save":case"tileset-save":this.textModeEditor.tileSetManager.showSave();break;case"tileset-new":this.textModeEditor.tileSetManager.showNewTileSetDialog();break;case"colorpalette-new":this.textModeEditor.colorPaletteManager.showNewColorPaletteDialog();break;case"color-edit":this.textModeEditor.toggleColorEditor();break;case"colors-preset":case"colorpalette-preset":this.textModeEditor.colorPaletteManager.showChoosePreset({});break;case"color-editcolorpalette":this.textModeEditor.editColorPalette();break;case"colors-load":case"colorpalette-load":this.textModeEditor.colorPaletteManager.showLoad({});break;case"colors-save":case"colorpalette-save":this.textModeEditor.colorPaletteManager.showSave();break;case"view-increase-font-size":case"c64-view-increase-font-size":case"view-zoomin":if(this.mode=="assembler"||this.mode=="c64"){this.changeFontSize(1)}else{this.textModeEditor.zoom(1)}break;case"view-decrease-font-size":case"c64-view-decrease-font-size":case"view-zoomout":if(this.mode=="assembler"||this.mode=="c64"){this.changeFontSize(-1)}else{this.textModeEditor.zoom(-1)}break;case"view-theme-chrome":this.assemblerEditor.setTheme("chrome");break;case"view-theme-tomorrow-night":this.assemblerEditor.setTheme("tomorrow_night");break;case"view-fitonscreen":case"view-reset-font-size":case"c64-view-reset-font-size":if(this.mode=="assembler"||this.mode=="c64"){this.resetFontSize()}else{this.textModeEditor.fitOnScreen()}break;case"view-toggle-invisible-characters":this.assemblerEditor.toggleInvisibles();break;case"view-toggle-autocomplete":this.assemblerEditor.toggleAutocomplete();break;case"view-toggle-tabindentation":this.assemblerEditor.toggleTabIndentation();break;case"c64-view-toggle-drive":var a=!UI(e).getChecked();this.c64Debugger.showPanel(e,a);break;case"c64-view-toggle-invisible-characters":this.c64Debugger.assemblerEditor.toggleInvisibles();break;case"c64-view-toggle-autocomplete":this.c64Debugger.assemblerEditor.toggleAutocomplete();break;case"c64-view-theme-chrome":this.c64Debugger.assemblerEditor.setTheme("chrome");break;case"c64-view-theme-tomorrow-night":this.c64Debugger.assemblerEditor.setTheme("tomorrow_night");break;case"c64-view-toggle-tabindentation":this.c64Debugger.assemblerEditor.toggleTabIndentation();break;case"c64-view-toggle-assembler":case"c64-view-toggle-disassembly":case"c64-view-toggle-scripting":case"c64-view-toggle-colors":case"c64-view-toggle-basic":case"c64-view-toggle-memory":case"c64-view-toggle-charset":case"c64-view-toggle-sprites":case"c64-view-toggle-bitmap":case"c64-view-toggle-sid":case"c64-view-toggle-drive":case"c64-view-toggle-docs":case"c64-view-toggle-calc":var a=!UI(e).getChecked();this.c64Debugger.showPanel(e,a);break;case"view-actualpixels":this.textModeEditor.actualPixels();break;case"home-page":document.location="/";break;case"view-project":case"view-project-explorer":case"show-project-explorer":this.projectNavigator.toggleVisible();break;case"settings-prgcode":this.textModeEditor.editC64PRGCode();break;case"settings-importshader":this.textModeEditor.editImportShader();break;case"settings-mobilemode":if(confirm("Are you sure you want to switch to mobile mode?")){this.setDeviceType("mobile")}break;case"cursor-tile-transparent":this.textModeEditor.toggleCursorTileTransparent();break;case"layout-palette-bottom":this.textModeEditor.setLayout("bottom");break;case"layout-palette-side":this.textModeEditor.setLayout("side");break;case"layout-minimal":this.textModeEditor.setLayout("minimal");break;case"view-tools":this.textModeEditor.setToolsVisible(!this.textModeEditor.getToolsVisible());break;case"view-infopanel":this.textModeEditor.setInfoPanelVisible(!this.textModeEditor.getInfoPanelVisible());break;case"view-layerspanel":this.textModeEditor.setLayersPanelVisible(!this.textModeEditor.getLayersPanelVisible());break;case"view-palettepanel":this.textModeEditor.setColorPalettePanelVisible(!this.textModeEditor.getColorPalettePanelVisible());break;case"view-tilepalettepanelside":this.textModeEditor.setTilePalettePanelVisible("side",!this.textModeEditor.getTilePalettePanelVisible("side"));break;case"view-metatilepalettepanelside":this.textModeEditor.setSideBlockPanelVisible(!this.textModeEditor.getSideBlockPanelVisible());break;case"view-tilepalettepanelbottom":this.textModeEditor.setTilePalettePanelVisible("bottom",!this.textModeEditor.getTilePalettePanelVisible("bottom"));break;case"view-metatilepalettepanelbottom":this.textModeEditor.setBottomBlockPanelVisible(!this.textModeEditor.getBottomBlockPanelVisible());break;case"c64-view-perfstats":case"view-perfstats":case"view-3dperfstats":if(UI.getStatsEnabled()){UI.setStatsEnabled(false);UI("view-perfstats").setChecked(false)}else{UI.setStatsEnabled(true);UI("view-perfstats").setChecked(true)}break;case"help-commonactionshortcuts":window.open("docs/common-action-shortcuts.html","common-action-shortcuts");break;case"help-keyboardshortcuts":window.open("docs/keyboard-shortcuts.html","keyboard-shortcuts");break;case"help-scriptingapi":window.open("docs/api.html","scripting-api");break;case"c64-sound":case"c64debugger-sound":c64.sound.toggleAudio();break;case"c64debugger-sound6581":c64.sound.setModel("6581");break;case"c64debugger-sound8580":c64.sound.setModel("8580");break;case"c64-share-link":this.c64Debugger.share();break;case"c64-export-html-page":this.c64Debugger.exportAsHTMLPage();break;case"c64-loadprg":case"c64debugger-loadprg":if(this.mode=="assembler"){if(this.assemblerEditor.debuggerCompact){this.assemblerEditor.debuggerCompact.choosePRG()}}if(this.mode=="c64"){this.c64Debugger.choosePRG()}break;case"c64-attachd64":case"c64debugger-attachd64":if(this.mode=="assembler"){if(this.assemblerEditor.debuggerCompact){this.assemblerEditor.debuggerCompact.chooseD64(false)}}if(this.mode=="c64"){this.c64Debugger.chooseD64(false)}break;case"c64-autostartd64":if(this.mode=="c64"){this.c64Debugger.chooseD64(true)}break;case"c64-insertcrt":if(this.mode=="c64"){this.c64Debugger.chooseCRT()}break;case"c64-downloadsnapshot":if(this.mode=="c64"){this.c64Debugger.downloadSnapshot()}break;case"c64-settings":if(this.mode=="c64"){}break;case"c64debugger-prgloadrun":case"c64-prgloadrun":if(this.mode=="c64"){this.c64Debugger.setPRGLoadMethod("loadrun")}if(this.mode=="assembler"){if(this.assemblerEditor.debuggerCompact){this.assemblerEditor.debuggerCompact.setPRGLoadMethod("loadrun")}}break;case"c64debugger-prginject":case"c64-prginject":if(this.mode=="c64"){this.c64Debugger.setPRGLoadMethod("inject")}if(this.mode=="assembler"){if(this.assemblerEditor.debuggerCompact){this.assemblerEditor.debuggerCompact.setPRGLoadMethod("inject")}}break;case"c64debugger-randomdelay":if(this.mode=="c64"){this.c64Debugger.toggleRandomDelay()}break;case"c64-reset":case"c64debugger-reset":if(this.mode=="assembler"){if(this.assemblerEditor.debuggerCompact){this.assemblerEditor.debuggerCompact.machineReset()}}if(this.mode=="c64"){this.c64Debugger.machineReset()}break;case"c64debugger-model-pal":if(this.mode=="c64"){this.c64Debugger.setModel("pal")}break;case"c64debugger-model-ntsc":if(this.mode=="c64"){this.c64Debugger.setModel("ntsc")}break;case"c64-viewraster":case"c64debugger-viewraster":if(this.mode=="assembler"){if(this.assemblerEditor.debuggerCompact){this.assemblerEditor.debuggerCompact.toggleShowRaster()}}if(this.mode=="c64"){this.c64Debugger.toggleShowRaster()}break;case"edit-showgrid":case"c64debugger-grid":if(this.mode=="c64"){this.c64Debugger.showGrid(!this.c64Debugger.grid)}else{this.textModeEditor.setGridVisible(!this.textModeEditor.getGridVisible())}break;case"c64-joystick1":case"c64-joystick2":case"c64debugger-joystick1":case"c64debugger-joystick2":var s=0;var o=true;if(e=="c64-joystick1"||e=="c64debugger-joystick1"){o=UI("c64-joystick1").getChecked();s=1}else if(e=="c64-joystick2"||e=="c64debugger-joystick2"){o=UI("c64-joystick2").getChecked();s=2}c64.joystick.setPortEnabled(s,!o);break;case"c64-joysticksettings":case"c64debugger-joysticksettings":c64.joystick.showSettingsDialog();break;case"c64-joystickswap":case"c64debugger-joystickswap":c64.joystick.swap();break;case"c64-mouse1":case"c64-mouse2":case"c64debugger-mouse1":case"c64debugger-mouse2":var s=0;var o=true;if(e=="c64-mouse1"||e=="c64debugger-mouse1"){o=UI("c64-mouse1").getChecked();s=1}else if(e=="c64-mouse2"||e=="c64debugger-mouse2"){o=UI("c64-mouse2").getChecked();s=2}c64.joystick.setMousePortEnabled(s,!o);break;case"c64-size-1":case"c64-size-2":case"c64-size-3":case"c64-size-4":case"c64debugger-size-1":case"c64debugger-size-2":case"c64debugger-size-3":case"c64debugger-size-4":var l=1;if(e=="c64-size-1"||e=="c64debugger-size-1"){l=1}else if(e=="c64-size-2"||e=="c64debugger-size-2"){l=2}else if(e=="c64-size-3"||e=="c64debugger-size-3"){l=3}else if(e=="c64-size-4"||e=="c64debugger-size-4"){l=4}if(this.mode=="assembler"){if(this.assemblerEditor.debuggerCompact){this.assemblerEditor.debuggerCompact.setSize(l)}}if(this.mode=="c64"){this.c64Debugger.setSize(l)}break;case"c64debugger-speed-25":case"c64debugger-speed-50":case"c64debugger-speed-100":case"c64debugger-speed-150":case"c64debugger-speed-200":case"c64debugger-speed-300":var n=100;switch(e){case"c64debugger-speed-25":n=25;break;case"c64debugger-speed-50":n=50;break;case"c64debugger-speed-100":n=100;break;case"c64debugger-speed-150":n=150;break;case"c64debugger-speed-200":n=200;break;case"c64debugger-speed-300":n=300;break}if(this.mode=="c64"){this.c64Debugger.setSpeed(n)}break;case"c64-size-fit":case"c64debugger-size-fit":if(this.mode=="assembler"){if(this.assemblerEditor.debuggerCompact){this.assemblerEditor.debuggerCompact.setSize("fit")}}if(this.mode=="c64"){this.c64Debugger.setSize("fit")}break;case"c64debugger-size-fitpixel":case"c64-size-fitpixel":if(this.mode=="assembler"){if(this.assemblerEditor.debuggerCompact){this.assemblerEditor.debuggerCompact.setSize("fitpixel")}}if(this.mode=="c64"){this.c64Debugger.setSize("fitpixel")}break}if(e.indexOf("tileset-select-")!==-1){var h=e.substring("tileset-select-".length);this.textModeEditor.tileSetManager.selectTileSet(h)}if(e.indexOf("colorpalette-select-")!==-1){var d=e.substring("colorpalette-select-".length);this.textModeEditor.colorPaletteManager.selectColorPalette(d)}},showProjectNavigator:function(){if(this.isMobile()){if(this.projectNavigatorMobile==null){this.projectNavigatorMobile=new ProjectNavigatorMobile;this.projectNavigatorMobile.init()}this.projectNavigatorMobile.show()}},getFontSize:function(){return this.fontSize},setFontSize:function(e){this.fontSize=e;g_app.setPref("codeeditor.fontsize",this.fontSize);if(this.assemblerEditor){this.assemblerEditor.setFontSize(this.fontSize)}if(this.c64Debugger){this.c64Debugger.setFontSize(this.fontSize)}},changeFontSize:function(e){var t=this.fontSize+e;if(isNaN(t)||t<=0){return}this.setFontSize(t)},resetFontSize:function(){this.setFontSize(14)},share:function(){if(this.mode=="assembler"){this.assemblerEditor.buildControls.showShare()}else if(this.mode=="c64"){this.c64Debugger.share()}else{this.gist.startShare()}},undo:function(){if(this.textModeEditor.colorPaletteEdit&&this.textModeEditor.colorPaletteEdit.visible){this.textModeEditor.colorPaletteEdit.undo();return}if(this.mode=="3d"||this.mode=="2d"){this.textModeEditor.history.undo()}if(this.mode=="sprite"){this.spriteEditor.history.undo()}if(this.mode=="music"){this.music.history.undo()}if(this.mode=="color palette"){this.colorPaletteEditor.colorPaletteEdit.undo()}if(this.mode=="assembler"){this.assemblerEditor.undo()}if(this.mode=="c64"){this.c64Debugger.undo()}},redo:function(){if(this.textModeEditor.colorPaletteEdit&&this.textModeEditor.colorPaletteEdit.visible){this.textModeEditor.colorPaletteEdit.redo();return}if(this.mode=="3d"||this.mode=="2d"){this.textModeEditor.history.redo()}if(this.mode=="sprite"){this.spriteEditor.history.undo()}if(this.mode=="music"){this.music.history.redo()}if(this.mode=="color palette"){this.colorPaletteEditor.colorPaletteEdit.redo()}if(this.mode=="assembler"){this.assemblerEditor.redo()}if(this.mode=="c64"){this.c64Debugger.redo()}},createDocumentStructure:function(e){e.createDocRecord("/","color palettes","folder",{});e.createDocRecord("/","tile sets","folder",{});e.createDocRecord("/","screens","folder",{});e.createDocRecord("/","sprites","folder",{});e.createDocRecord("/","music","folder",{});e.createDocRecord("/","asm","folder",{});e.createDocRecord("/asm","inc","folder",{});e.createDocRecord("/asm","bin","folder",{});e.createDocRecord("/","scripts","folder",{});e.createDocRecord("/","build","folder",{});e.createDocRecord("/","3d scenes","folder",{});e.createDocRecord("/","config","folder",{})},closeProject:function(){this.doc=null;this.projectNavigator.refresh(null);this.projectNavigator.currentPath=false},newProject:function(e,t){var i=this;this.closeProject();this.fileManager.setIsNew(true);var r="monochrome";var a="screen";if(typeof e.editor!="undefined"){a=e.editor}if(a==""){a="screen"}if(typeof e.mode!="undefined"){r=e.mode}this.doc=new Document;this.doc.init(this);var s="c64_colodore";var o="Colour Palette";if(typeof e.colorPalettePresetId!=="undefined"){if(e.colorPalettePresetId){s=e.colorPalettePresetId}}if(typeof e.colorPaletteName!="undefined"){o=e.colorPaletteName}var l=null;if(typeof e.colorPalette!="undefined"&&e.colorPalette){s=false;l=e.colorPalette}var n="Tile Set";var h="petscii";if(typeof e.tileSetPresetId!="undefined"){if(e.tileSetPresetId){h=e.tileSetPresetId}}var d=null;if(typeof e.tileSetCreated!="undefined"&&e.tileSetCreated){d=e.tileSet}if(typeof e.tileSetName!="undefined"){n=e.tileSetName}var c=40;var f=25;if(r=="nes"){c=32;f=30;s="nes"}if(typeof e.width!="undefined"){c=e.width}if(typeof e.height!="undefined"){f=e.height}if(typeof e.template!="undefined"){var u=e.template;for(var p=0;p<u.length;p++){this.doc.data.children.push(u[p])}var v="Untitled Screen";this.textModeEditor.open("/screens/"+v);this.textModeEditor.setLayoutType("textmode");this.setMode("2d");this.textModeEditor.setScreenMode(r);this.textModeEditor.fitOnScreen({minScale:1});this.textModeEditor.colorPaletteManager.colorPaletteUpdated();this.projectNavigator.refresh();this.textModeEditor.frames.frameTimeline.resize();this.textModeEditor.grid.setUpdateEnabled(true);this.textModeEditor.grid.update();this.textModeEditor.layers.updateAllLayerPreviews();return}else{this.createDocumentStructure(this.doc);this.doc.createDocRecord("/asm","main.asm","asm",c64Asm_example);this.doc.createDocRecord("/asm/inc","macros.asm","asm",c64Asm_macro);this.doc.createDocRecord("/scripts","screen.js","script","");this.doc.createDocRecord("/scripts","assembler.js","script","");this.doc.createDocRecord("/scripts","c64.js","script","");this.doc.createDocRecord("/config","assembler.json","json",'{\n  "assembler": "acme",\n  "arguments": "--format cbm",\n  "files": "main.asm",\n  "output": "out.prg",\n  "target": "c64"\n }');this.doc.createDocRecord("/config","c64.json","json","{\n}")}if(this.music){this.music.startNew({name:"Untitled Music",defaultInstruments:true})}var g="Untitled Screen";this.textModeEditor.graphic.setDrawEnabled(false);var m={name:g,gridWidth:c,gridHeight:f,colorPalettePresetId:s,colorPalette:l,colorPaletteName:o,tileSetPresetId:h,tileSet:d,tileSetName:n};if(typeof e.screenMode!="undefined"){m.screenMode=e.screenMode}if(typeof e.canFlipTile!="undefined"){m.canFlipTile=e.canFlipTile}if(typeof e.canRotateTile!="undefined"){m.canRotateTile=e.canRotateTile}this.textModeEditor.createDoc(m,function(){switch(a){case"3d":var e=25;g_app.textModeEditor.grid3d.createDoc({parentPath:"/3d scenes",name:g,gridWidth:c,gridHeight:f,gridDepth:e,colorPalettePresetId:s,colorPalette:l,tileSetPresetId:h,tileSet:d},function(e){g_app.projectNavigator.showDocRecord("/3d scenes/"+g)});break;default:case"screen":i.setMode("2d");i.projectNavigator.refresh();i.projectNavigator.showDocRecord("/screens/"+g);i.textModeEditor.graphic.setDrawEnabled(true);i.textModeEditor.graphic.invalidateAllCells();i.textModeEditor.graphic.redraw({allCells:true});i.textModeEditor.layers.updateAllLayerPreviews();break;case"sprite":i.projectNavigator.createSpriteRecord({name:"Untitled Sprite"},function(e){i.projectNavigator.refresh();i.projectNavigator.showDocRecord("/sprites/Untitled Sprite");g_app.textModeEditor.setBackgroundColor(g_app.textModeEditor.colorPaletteManager.noColor);i.textModeEditor.graphic.setDrawEnabled(true);i.textModeEditor.graphic.invalidateAllCells();i.textModeEditor.graphic.redraw({allCells:true});i.textModeEditor.layers.updateAllLayerPreviews()});break;case"music":i.projectNavigator.refresh();i.projectNavigator.showDocRecord("/music/Untitled Music");break;case"assembler":i.projectNavigator.refresh();i.projectNavigator.showDocRecord("/asm/main.asm");break;case"c64":i.projectNavigator.refresh();i.setMode("c64");break;case"nes":i.projectNavigator.refresh();i.setMode("nes");break}i.textModeEditor.graphic.setDrawEnabled(true);if(t){t()}})},autosave:function(){if(this.doc){g_app.fileManager.autosave()}},showAssembler:function(){UI.setWebGLEnabled(false);this.assemblerEditor.show();this.contentPanel.showOnly("assembler")},update:function(){if(this.mode===false){return}if(this.mode=="3d"||this.mode=="2d"){this.textModeEditor.update()}if(this.mode=="assembler"){this.assemblerEditor.update()}if(this.mode=="music"){this.music.update()}if(this.mode=="c64"){this.c64Debugger.update()}if(this.mode=="x16"){this.x16Debugger.update()}if(this.mode=="nes"){this.nesDebugger.update()}if(TextMode.update){TextMode.update()}}};var NewProjectDialog=function(){this.uiComponent=null;this.htmlPanel=null;this.mode="textmode";this.colorPaletteId="c64_colodore";this.colorPalette=null;this.colorPaletteCreated=false;this.colorPaletteName="C64";this.tileSetId="petscii";this.tileSetCreated=false;this.tileSet=null;this.tileSetName="C64 PETSCII"};NewProjectDialog.prototype={init:function(e){},initEvents:function(){var t=this;if($("#newProjectChooseTileSetButton").length>0){$("#newProjectChooseTileSetButton").on("click",function(){t.chooseTileSet()})}if($("#newProductChooseColourPaletteButton").length>0){$("#newProductChooseColourPaletteButton").on("click",function(){t.chooseColorPalette()})}$("input[name=newProjectMode]").on("click",function(){var e=$("input[name=newProjectMode]:checked").val();t.setMode(e)})},setMode:function(e){if(this.mode!==e){this.mode=e;if(e=="vector"){this.tileSetId="vector:modular-shapes";$("#newProjectTileSet").html("Modular Shapes");this.tileSetName="Modular Shapes";$("#enableFlipRotateRow").show()}else if(e=="petscii"){this.tileSetId="petscii";$("#newProjectTileSet").html("C64 PETSCII");this.tileSetName="C64 PETSCII";$("#enableFlipRotateRow").hide()}else{this.tileSetId="petscii";$("#newProjectTileSet").html("C64 PETSCII");this.tileSetName="C64 PETSCII";$("#enableFlipRotateRow").show()}}},chooseTileSet:function(){var o=this;var e={};if(this.mode=="vector"){e.type="vector"}else{e.type="character"}e.callback=function(e){var t=e.type;var i=e.presetId;var r=e.description;o.tileSetCreated=e.tileSetCreated;o.tileSet=e.tileSet;o.mode=e.mode;if(t=="vector"){$("input[name=newProjectMode][value=vector]").prop("checked",true);o.tileSetId="vector:"+i}else{$("input[name=newProjectMode][value=textmode]").prop("checked",true);o.tileSetId=i}if(o.mode=="indexed"){o.colorPalette=e.colorPalette;o.colorPaletteCreated=true;$("#newProjectColorPalette").html(r.name+" Palette");this.colorPaletteName=r.name}if(r){var a=r.width;var s=r.height;$("#newProjectTileSet").html(r.name);this.tileSetName=r.name}};var t=g_app.textModeEditor.tileSetManager;var i=t.getChoosePresetDialog();i.show(e)},chooseColorPalette:function(){var i=this;var e={};e.setColorPalette=false;e.callback=function(e){var t=e.description;i.colorPaletteCreated=e.colorPaletteCreated;if(!e.colorPaletteCreated){i.colorPaletteId=e.presetId;i.colorPalette=null}else{i.colorPaletteId=false;i.colorPalette=e.colorPalette}if(t){$("#newProjectColorPalette").html(t.name);this.colorPaletteName=t.name}};var t=g_app.textModeEditor.colorPaletteManager;var r=t.getChoosePresetDialog();r.show(e)},show:function(){var e=UI.isMobile.any();if(this.uiComponent==null){var t=this;var i=380;var r=254;if(e){r=580;i=500}this.uiComponent=UI.create("UI.Dialog",{id:"newProjectDialog",title:"New Project",width:i,height:r});var a='<div id="newProjectDialog">';if(e){a+='<div style="margin-bottom: 10px"></div>';a+='    <div class="formRow">';a+='      <div><label class="formControlLabel" for="newProjectMode">Mode</label></div>';a+='      <div style="margin-bottom: 8px"><label class="rb-container" style="margin-right: 10px; margin-bottom: 0"><input type="radio" name="newProjectMode" value="petscii"><span class="rb-label">PETSCII</span><span class="checkmark"></span></label></div>';a+='      <div style="margin-bottom: 8px"><label class="rb-container" style="margin-right: 10px; margin-bottom: 0"><input type="radio" name="newProjectMode" value="textmode" checked="checked"><span class="rb-label">Text Mode</span><span class="checkmark"></span></label></div>';a+='      <div style="margin-bottom: 8px"><label class="rb-container" style="margin-bottom: 0px;"><input type="radio" name="newProjectMode" value="vector"><span class="rb-label">Vector Mode</span><span class="checkmark"></span></label></div>';a+="    </div>"}else{a+='    <div class="formRow">';a+='      <label class="formControlLabel" for="newProjectMode">Mode</label>';a+='      <label class="rb-container" style="margin-right: 10px; margin-bottom: 0"><input type="radio" name="newProjectMode" value="petscii"><span class="rb-label">PETSCII</span><span class="checkmark"></span></label>';a+='      <label class="rb-container" style="margin-right: 10px; margin-bottom: 0"><input type="radio" name="newProjectMode" value="textmode" checked="checked"><span class="rb-label">Text Mode</span><span class="checkmark"></span></label>';a+='      <label class="rb-container" style="margin-bottom: 0px;"><input type="radio" name="newProjectMode" value="vector"><span class="rb-label">Vector Mode</span><span class="checkmark"></span></label>';a+="    </div>"}a+='    <div class="formRow">';a+='      <label class="formControlLabel" for="newProjectTileSet">Tile Set</label>';a+='      <div style="display: flex; align-items: center; padding: 2px 2px 2px 4px; background-color: #222222; min-height: 26px">';a+='        <div style="display: inline-block; width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis" id="newProjectTileSet">C64 PETSCII</div>';if(!e){a+='        <div class="ui-button" id="newProjectChooseTileSetButton">Choose...</div>'}a+="      </div>";a+="    </div>";a+='    <div class="formRow">';a+='      <label class="formControlLabel" for="newProjectColorPalette">Colour Palette</label>';a+='      <div style="display: flex; align-items: center; padding: 2px 2px 2px 4px; background-color: #222222; min-height: 26px">';a+='      <div style="display: inline-block; width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis" id="newProjectColorPalette">C64</div>';if(!e){a+='      <div class="ui-button" id="newProductChooseColourPaletteButton">Choose...</div>'}a+="      </div>";a+="    </div>";a+='    <div class="formRow">';a+='      <label class="formControlLabel" for="newProjectWidth">Dimensions</label>';a+='      <div style="display: flex">';a+='      <input type="number" style="width: 30px" class="formControl number dimensionsNumber" min="1" id="newProjectWidth" size="4" value="40"/>';a+="      <div>&nbsp;x&nbsp;</div>";a+='      <input type="number" style="width: 30px" class="formControl number dimensionsNumber" min="1" id="newProjectHeight" size="4" value="25"/>';a+="      </div>";a+="    </div>";a+='    <div class="formRow" id="enableFlipRotateRow">';a+='      <label class="formControlLabel" for="">Enable</label>';a+='  <div class="checkboxGroup">';a+='    <label class="cb-container no-margin">Tile Rotate';a+='      <input type="checkbox"  id="newProjectTileRotate" value="1" checked="checked">';a+='      <span class="checkmark"></span>';a+="    </label>";a+='    <label class="cb-container no-margin">Tile Flip';a+='      <input type="checkbox"  id="newProjectTileFlip" value="1" checked="checked">';a+='      <span class="checkmark"></span>';a+="    </label>";a+="  </div>";a+="    </div>";a+="</div>";this.htmlPanel=UI.create("UI.HTMLPanel",{html:a});this.uiComponent.add(this.htmlPanel);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.okButton.on("click",function(e){t.createNewProject();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.addButton(this.okButton);this.uiComponent.addButton(this.closeButton);UI.on("ready",function(){UI.number.initControls("#newProjectDialog"+" .number");t.initEvents()})}UI.showDialog("newProjectDialog")},createNewProject:function(){var e=parseInt($("#newProjectWidth").val(),10);var t=parseInt($("#newProjectHeight").val(),10);var i=$("#newProjectTileRotate").is(":checked");var r=$("#newProjectTileFlip").is(":checked");var a={};a.canFlipTile=r;a.canRotateTile=i;a.screenMode=$("input[name=newProjectMode]:checked").val();a.tileSetPresetId=this.tileSetId;a.tileSetCreated=this.tileSetCreated;a.tileSet=this.tileSet;a.tileSetName=this.tileSetName;if(a.tileSet){a.screenMode=this.mode}if(a.screenMode=="vector"){if(this.tileSetId.indexOf("vector")!==0){this.tileSetId="vector:modular-shapes"}a.canFlipTile=true;a.canRotateTile=true}else{if(this.tileSetId&&this.tileSetId.indexOf("vector")==0){a.tileSet="petscii"}}if(a.screenMode=="petscii"){a.canFlipTile=false;a.canRotateTile=false;a.screenMode=TextModeEditor.Mode.C64STANDARD}a.colorPalettePresetId=this.colorPaletteId;a.colorPalette=this.colorPalette;a.colorPaletteName=this.colorPaletteName;a.width=e;a.height=t;g_app.newProject(a)}};var ProjectNavigatorPopup=function(){this.html="<div>";this.html+='<div id="projectNavigatorMenuCreate" class="ui-menu-item projectNavigatorMenuItem" data-action="create"><div style="padding-right: 5px" class="ui-menu-item-label">New...</div></div>';this.html+='<div id="projectNavigatorMenuCreate" class="ui-menu-item projectNavigatorMenuItem" data-action="createfolder"><div style="padding-right: 5px" class="ui-menu-item-label">New Folder...</div></div>';this.html+='<div id="projectNavigatorMenuRename" class="ui-menu-item projectNavigatorMenuItem" data-action="rename"><div style="padding-right: 5px" class="ui-menu-item-label">Rename...</div></div>';this.html+='<div id="projectNavigatorMenuDelete" class="ui-menu-item projectNavigatorMenuItem" data-action="delete"><div style="padding-right: 5px" class="ui-menu-item-label">Delete</div></div>';this.html+="</div>";this.uiComponent=null;this.htmlComponent=null;this.visible=false;this.callback=false};ProjectNavigatorPopup.prototype={init:function(e){this.editor=e;this.uiComponent=UI.create("UI.Popup",{id:"projectNavigatorPopup",width:300,height:"auto"});this.uiComponent.on("close",function(){$(".ui-tree-contextselected-row").removeClass("ui-tree-contextselected-row")});this.htmlComponent=UI.create("UI.HTMLPanel",{html:this.html});this.uiComponent.add(this.htmlComponent);this.initEvents()},initEvents:function(){var t=this;$(".projectNavigatorMenuItem").on("click",function(){var e=$(this).attr("data-action");if(t.callback!==false){t.callback(e,this.args)}})},show:function(e,t,i){var r=120;var a="auto";this.uiComponent.setDimensions(r,a);UI.showPopup("projectNavigatorPopup",e-5,t-5);this.visible=true;if(typeof i!="undefined"&&typeof i.callback!="undefined"){this.args=i;this.callback=i.callback}},close:function(){if(this.visible){UI.hidePopup()}this.visible=false}};var ProjectNavigator=function(){this.editor=null;this.rootLabel="Project";this.visible=false;this.newDocRecordDialog=null;this.treeMap={};this.settings={};this.currentEditor=null;this.currentPath=false;this.projectNavigatorPopup=null;this.renameDialog=null;this.prgHandler="c64";this.cantDelete=["/color palettes","/tile sets","/screens","/sprites","/music","/scripts","/build"]};ProjectNavigator.prototype={init:function(e){this.editor=e;this.currentEditor=g_app.textModeEditor},setPrgHandler:function(e){if(e=="x16"||e=="c64"){this.prgHandler=e}},shareProject:function(){alert("share project")},selectCurrent:function(){var e=this.getCurrentPath();if(e){var t=g_app.doc.getDocRecord(e);if(t){this.selectNodeWithId(t.id)}}},getVisible:function(){return this.visible},setVisible:function(e){if(!g_app.isMobile()){this.visible=e;UI("projectSplitPanel").setPanelVisible("west",this.visible);if(this.visible){g_app.setTabPanelVisible(true);this.selectCurrent()}}},toggleVisible:function(){this.setVisible(!this.visible)},getCurrentEditor:function(){return this.currentEditor},getCurrentPath:function(){if(this.currentPath===false){var e=this.currentEditor;if(typeof e.doc!=="undefined"){if(e.doc==null){return}if(e.doc.type=="graphic"){this.currentPath="/screens/"+e.doc.name}}}return this.currentPath},hide:function(){this.visible=false;UI("projectSplitPanel").setPanelVisible("west",false)},updateModifiedList:function(){this.modifiedRecords=g_app.doc.getModifiedRecordsList();var e="";var t=this.modifiedRecords.length;var i=t+" Changed file";if(t!==1){i+="s"}$("#githubChangedHeading").html(i);for(var r=0;r<this.modifiedRecords.length;r++){e+='<div class="githubChangedFile">';e+='<img src="images/tree/file.png" style="filter: invert(0.65)"/>';e+=this.modifiedRecords[r].name;e+="</div>"}$("#githubModified").html(e)},setGithubRepositoryDetails:function(e,t){if(e===false&&t===false){$("#githubModified").html("");$("#projectGithubDetailsCreateHolder").show();var i="";$("#projectGithubDetails").html(i);$("#projectGithubButtons").hide();$("#projectModifiedFiles").hide();UI("projectNavigatorSplitPanel").resizeThePanel({panel:"north",size:84})}else{var r="https://github.com/"+e+"/"+t;var i='<div style="display: flex; align-items: center;  height: 24px">';i+='<img style="filter: invert(80%); width: 14px; height: 14px; margin: 0 4px" src="icons/GitHub-Mark-64px.png">';i+='<a href="'+r+'" target="_blank" style="cursor: pointer; color: #eeeeee; font-size: 11px">'+e+"/"+t+"</a>";i+="</div>";$("#projectGithubDetails").html(i);$("#projectGithubButtons").show();$("#projectModifiedFiles").show();$("#projectGithubDetailsCreateHolder").hide();$("#projectGithubDetailsHolder").show();UI("projectNavigatorSplitPanel").resizeThePanel({panel:"north",size:140});this.updateModifiedList()}},buildInterface:function(e){var i=this;var t=UI.create("UI.SplitPanel",{id:"projectNavigatorSplitPanel"});e.add(t);var r=UI.create("UI.Panel",{id:"projectGithubPanel"});var a="";a+='<div class="title" style="background-color: #111111; height: 24px">';a+=" <span>Project Explorer</span>";a+='  <div style="position: absolute; top: 2px; right: 2px; width: 20px">';a+='    <div id="projectCloseButton" class="ui-button ui-dialog-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>';a+="  </div>";a+="</div>";a+='<div class="title" style="background-color: #111111; height: 24px; position: relative">';a+='  <div style="position: absolute; top: 6px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap">';a+="GitHub Repository";a+="  </div>";a+="</div>";a+='<div id="projectGithubDetailsHolder" style="margin-bottom: 6px">';a+='<div id="projectGithubDetailsCreateHolder">';a+='<div class="ui-button" id="projectGithubDetailsCreate" style="margin-top: 4px">';a+='<img style="filter: invert(80%); width: 14px; height: 14px; margin: 0 4px" src="icons/GitHub-Mark-64px.png">';a+="Create A GitHub Repo</div>";a+="</div>";a+='  <div id="projectGithubDetails">owner/repository</div>';a+='  <div id="projectGithubButtons">';a+='    <div id="projectCommitButton" style="font-size: 9px; line-height: 15px; height: 14px" class="ui-button ui-button-primary">Commit to master</div>';a+='    <div id="projectPullButton" style="font-size: 9px; line-height: 15px; height: 14px" class="ui-button ui-button-primary">Pull Origin</div>';a+="  </div>";a+='  <div id="projectModifiedFiles">';a+='<div id="githubChangedHeading">';a+="</div>";a+='   <div id="githubModified" style="position: absolute; top: 108px; left: 0;right: 0; bottom: 0;" >modified files</div>';a+="  </div>";a+="</div>";var s=UI.create("UI.HTMLPanel",{html:a});r.add(s);t.addNorth(r,160);var o=UI.create("UI.SplitPanel",{id:"projectLocalSplitPanel"});t.add(o);var l="";l+='<div class="title" style="background-color: #111111; height: 24px">';l+='  <div style="position: absolute; top: 6px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap">';l+="Project Files";l+="  </div>";l+="</div>";l+="<div>";l+='<div id="projectAddFileButton" style="font-size: 9px; line-height: 15px; height: 14px" class="ui-button ui-button-primary"><i class="halflings halflings-plus"></i>&nbsp;New...</div>';l+='<div id="projectDeleteFileButton" style="font-size: 9px; line-height: 15px; height: 14px" class="ui-button ui-button-danger"><i class="halflings halflings-plus"></i>&nbsp;Delete</div>';l+="</div>";var n=UI.create("UI.HTMLPanel",{html:l});o.addNorth(n,48,false);this.tree=UI.create("UI.Tree",{candrag:false});o.add(this.tree);this.tree.on("nodetoggleclick",function(e){}),this.tree.on("nodeclick",function(e){e.select()});this.tree.on("nodedblclick",function(e){i.showFile(e,true)});this.tree.on("nodecontextmenu",function(e,t){i.showContextMenu(t,e);t.preventDefault()});this.tree.on("nodeselect",function(e){i.showFile(e)});var h=this.tree.getRootNode();this.treeRoot=h.addChild({label:this.rootLabel,type:"folder"});UI.on("ready",function(){h.toggle();i.treeRoot.toggle();i.initEvents();i.setGithubRepositoryDetails(false,false)})},initEvents:function(){var e=this;$("#projectCloseButton").on("click",function(){e.hide()});$("#projectAddFileButton").on("click",function(){e.showNewDocRecordDialog()});$("#projectCommitButton").on("click",function(){g_app.github.save()});$("#projectPullButton").on("click",function(){g_app.github.doPull()});$("#projectGithubDetailsCreate").on("click",function(){g_app.github.save()})},refresh:function(){this.refreshTree()},selectNodeWithId:function(e){if(this.treeMap.hasOwnProperty(e)){var t=this.treeMap[e];var i=t.m_parent;while(i!==null){if(i.m_state!=1){i.toggle()}i=i.m_parent}this.tree.selectNode(t.id)}},initNewRecordDialogContent:function(e){var t=this.tree.getSelectedNode();if(typeof e!="undefined"){if(typeof e.node!="undefined"){t=e.node}}if(t){var i=t.getType();if(i!="folder"){t=t.getParentNode()}}if(t==null){this.newDocRecordType=false;return false}var r=t.getPath();var a="/"+this.rootLabel+"/";var s=r.indexOf(a);if(s>=0){r="/"+r.substr(s+a.length)}this.parentPath=r;var o=g_app.doc.getDocRecord(r);document.getElementById("newDocBinaryFileForm").reset();this.binaryFilesChanged();if(o==null){this.newDocRecordType=false;return false}var l=o.name;var n="";var h="";switch(l){case"color palettes":h="color palette";n="Color Palette";break;case"tile sets":h="tile set";n="Tile Set";break;case"screens":h="screen";n="Screen";break;case"sprites":h="sprite";n="Sprite";break;case"music":h="music";n="Music";break;case"asm":case"inc":h="asm";n="ASM";break;case"scripts":h="script";n="Script";break;case"bin":h="binary";n="Binary";break;case"3d scenes":h="3d scene";n="3d scene";break}$("#newProjectFileName").val("Untitled");this.setNewRecordType(h)},getUniqueFilename:function(e,t,i){var r=0;var a="";if(typeof i!="undefined"&&i!=""){a="."+i}var s=t.lastIndexOf(".");if(s!==-1){var o=t.substring(s);if(o.toLowerCase()==a.toLowerCase()){t=t.substring(0,s)}}var l=t;while(g_app.doc.getDocRecord(e+l+a)){r++;l=t+" "+r}return l+a},createSpriteRecord:function(e,t){var i="Sprite";var r="graphic";if(typeof e!="undefined"){if(typeof e.name!="undefined"){i=e.name}}var a="";var s="";var o="petscii";var l="monochrome";if(s==""){a="c64_colodore"}var n="Sprite Tile Set";var h=1;var d=1;var c=this;g_app.textModeEditor.createDoc({parentPath:"/sprites",name:i,gridWidth:h,gridHeight:h,colorPalette:a,colorPaletteId:s,cellWidth:24,cellHeight:21,tileSetArgs:{width:24,height:21,name:n},screenMode:l},function(e){c.treeRoot.refreshChildren();c.selectNodeWithId(e.id);g_app.textModeEditor.setBackgroundColor(g_app.textModeEditor.colorPaletteManager.noColor);if(typeof t!="undefined"){t(e)}})},newFile:function(e){console.log("new file");console.log(e);var a=this.parentPath;var t=g_app.doc.getDocRecord(a);while(t!==null&&t.type!=="folder"){var i=a.lastIndexOf("/");if(i===-1){t=null}else{a=a.substring(0,i);t=g_app.doc.getDocRecord(a)}}var s=this.tree.getNodeFromPath("/"+this.rootLabel+"/"+a);if(a.length==0||a[0]!="/"){a="/"+a}var o=e.filename;if(o==""){o="Untitled"}var l=this.newDocRecordType;var r="";var n=g_app.doc.getDocRecord(a);var h="";switch(l){case"asm":h="asm";break;case"script":h="js";break}var o=this.getUniqueFilename(a+"/",o,h);var d=this;if(l=="asm"){r="; asm file";var c=g_app.doc.createDocRecord(a,o,l,r);this.refreshTreeNode(n,s);this.treeRoot.refreshChildren();this.selectNodeWithId(c.id)}if(l=="script"){r="// script";var c=g_app.doc.createDocRecord(a,o,l,r);this.refreshTreeNode(n,s);this.treeRoot.refreshChildren();this.selectNodeWithId(c.id)}if(l=="color palette"){var f=g_app.textModeEditor.colorPaletteManager.createColorPalette({name:"Colour Palette"});this.refreshTreeNode(n,s);this.reloadTreeBranch("/color palettes");this.treeRoot.refreshChildren()}if(l=="tile set"){var o="new tile set";var u=256;var p=g_app.textModeEditor.tileSetManager.createTileSet({name:o,width:8,height:8});var v=g_app.textModeEditor.tileSetManager.getTileSet(p);v.setTileCount(u);this.refreshTreeNode(n,s);this.reloadTreeBranch("/tile sets");this.treeRoot.refreshChildren();this.selectNodeWithId(p)}if(l=="screen"){l="graphic";var g="c64_colodore";var m="";var y=$("#newDocRecordGridTileSet").val();var f=$("#newDocRecordGridColorPalette").val();var b=parseInt($("#newDocRecordGridWidth").val(),10);if(isNaN(b)){b=40}var C=parseInt($("#newDocRecordGridHeight").val(),10);if(isNaN(C)){C=25}g_app.textModeEditor.createDoc({parentPath:"/screens",name:o,gridWidth:b,gridHeight:C,colorPalette:g,colorPaletteId:f,tileSet:"",tileSetId:y},function(e){d.refreshTreeNode(n,s);d.reloadTreeBranch("/color palettes");d.reloadTreeBranch("/tile sets");d.treeRoot.refreshChildren();d.selectNodeWithId(e.id)})}if(l=="sprite"){l="graphic";var g="";var m="petscii";var y=$("#newDocRecordSpriteTileSet").val();var f=$("#newDocRecordSpriteColorPalette").val();if(f==""){g="c64_colodore"}var x="Sprite Tile Set";var S=$("#newDocRecordSpriteScreenMode").val();var b=parseInt($("#newDocRecordSpriteGridWidth").val(),10);if(isNaN(b)){b=1}var C=parseInt($("#newDocRecordSpriteGridHeight").val(),10);if(isNaN(C)){C=1}g_app.textModeEditor.createDoc({parentPath:"/sprites",name:o,gridWidth:b,gridHeight:C,colorPalette:g,colorPaletteId:f,cellWidth:24,cellHeight:21,tileSet:null,tileSetId:y,tileSetArgs:{width:24,height:21,name:x},screenMode:S},function(e){d.refreshTreeNode(n,s);var t=g_app.doc.getDocRecord("/color palettes");var i=d.tree.getNodeFromPath("/Project/color palettes");d.refreshTreeNode(t,i);var r=g_app.doc.getDocRecord("/tile sets");var a=d.tree.getNodeFromPath("/Project/tile sets");d.refreshTreeNode(r,a);d.treeRoot.refreshChildren();d.selectNodeWithId(e.id);g_app.textModeEditor.setBackgroundColor(g_app.textModeEditor.colorPaletteManager.noColor)})}if(l=="music"){var c=g_app.music.startNew({name:o});this.currentEditor=g_app.music;d.refreshTreeNode(n,s);d.treeRoot.refreshChildren();this.selectNodeWithId(c.id)}if(l=="binary"){l="bin";var P=document.getElementById("newDocRecordBinaryFile").files;if(P.length==0){return}var w=0;var I=P[w];var o=I.name;var d=this;var k=new FileReader;k.onload=function(e){var t=new Uint8Array(e.target.result);var i=bufferToBase64(t);var r=g_app.doc.createDocRecord(a,o,l,i);d.refreshTreeNode(n,s);d.treeRoot.refreshChildren();d.selectNodeWithId(r.id);w++;if(w<P.length){I=P[w];o=I.name;k.readAsArrayBuffer(I)}};k.readAsArrayBuffer(I)}if(l=="folder"){var c=g_app.doc.createDocRecord(a,o,"folder",{});this.refreshTreeNode(n,s);this.treeRoot.refreshChildren();this.selectNodeWithId(c.id)}if(l=="3d scene"){var g="c64_colodore";var m="petscii";var y=$("#newDocRecordGridTileSet").val();var f=$("#newDocRecordGridColorPalette").val();var b=parseInt($("#newDocRecordGridWidth").val(),10);if(isNaN(b)){b=40}var C=parseInt($("#newDocRecordGridHeight").val(),10);if(isNaN(C)){C=25}var M=parseInt($("#newDocRecordGridDepth").val(),10);if(isNaN(M)){M=25}g_app.textModeEditor.grid3d.createDoc({parentPath:"/3d scenes",name:o,gridWidth:b,gridHeight:C,gridDepth:M,colorPalette:g,tileSet:m,tileSetId:y,colorPaletteId:f},function(e){d.refreshTreeNode(n,s);d.treeRoot.refreshChildren();d.selectNodeWithId(e.id)})}},setGridTileSets:function(){var e="";e+='<option value="">New</option>';var t=g_app.doc.dir("/tile sets");for(var i=0;i<t.length;i++){var r=t[i];var a=r.data.width;var s=r.data.height;e+='<option value="'+t[i].id+'">'+t[i].name+"</option>"}$("#newDocRecordGridTileSet").html(e);if(t.length>0){$("#newDocRecordGridTileSet").val(t[0].id)}},setGridColorPalettes:function(){var e="";e+='<option value="">New</option>';var t=g_app.doc.dir("/color palettes");for(var i=0;i<t.length;i++){var r=t[i];e+='<option value="'+r.id+'">'+r.name+"</option>"}$("#newDocRecordGridColorPalette").html(e);if(t.length>0){$("#newDocRecordGridColorPalette").val(t[0].id)}},setSpriteTileSets:function(){var e=24;var t=21;var i="";i+='<option value="">New</option>';var r=g_app.doc.dir("/tile sets");var a=0;var s=false;for(var o=0;o<r.length;o++){var l=r[o];var n=l.data.width;var h=l.data.height;if(n==e&&h==t){a++;if(s===false){s=r[o].id}i+='<option value="'+r[o].id+'">'+r[o].name+"</option>"}}$("#newDocRecordSpriteTileSet").html(i);if(a>0){$("#newDocRecordSpriteTileSet").val(s)}else{$("#newDocRecordSpriteTileSet").val("")}},setSpriteColorPalettes:function(){var e="";e+='<option value="">New</option>';var t=g_app.doc.dir("/color palettes");for(var i=0;i<t.length;i++){var r=t[i];e+='<option value="'+r.id+'">'+r.name+"</option>"}$("#newDocRecordSpriteColorPalette").html(e);if(t.length>0){$("#newDocRecordSpriteColorPalette").val(t[0].id)}},setNewRecordType:function(e,t){this.newDocRecordType=e;var i=$("#newProjectFileName").val();var r="";var a=i.lastIndexOf(".");if(a!==-1){i=i.substring(0,a)}if(typeof t=="undefined"||t){$("#newDocRecordType").val(e)}switch(e){case"3d scene":this.parentPath="3d scenes";$("#newDocRecordGridDimensions").show();$("#newDocRecordSpriteDimensions").hide();$("#newDocRecordGridDimensionsDepth").show();$("#newDocRecordSpriteScreenModeGroup").hide();$("#newDocRecordBinFileGroup").hide();$("#newDocRecordDocName").show();this.setGridTileSets();this.setGridColorPalettes();break;case"screen":this.parentPath="screens";$("#newDocRecordGridDimensions").show();$("#newDocRecordSpriteDimensions").hide();$("#newDocRecordGridDimensionsDepth").hide();$("#newDocRecordSpriteScreenModeGroup").hide();$("#newDocRecordBinFileGroup").hide();$("#newDocRecordDocName").show();this.setGridTileSets();this.setGridColorPalettes();break;case"sprite":this.parentPath="sprites";$("#newDocRecordGridDimensions").hide();$("#newDocRecordSpriteDimensions").show();$("#newDocRecordGridDimensionsDepth").hide();$("#newDocRecordSpriteScreenModeGroup").show();$("#newDocRecordBinFileGroup").hide();$("#newDocRecordDocName").show();this.setSpriteTileSets();this.setSpriteColorPalettes();break;case"color palette":this.parentPath="color palettes";$("#newDocRecordGridDimensions").hide();$("#newDocRecordSpriteDimensions").hide();$("#newDocRecordSpriteScreenModeGroup").hide();$("#newDocRecordBinFileGroup").hide();$("#newDocRecordDocName").show();break;case"tile set":this.parentPath="tile sets";$("#newDocRecordGridDimensions").hide();$("#newDocRecordSpriteDimensions").hide();$("#newDocRecordSpriteScreenModeGroup").hide();$("#newDocRecordBinFileGroup").hide();$("#newDocRecordDocName").show();break;case"script":this.parentPath="scripts";r="js";break;case"asm":if(this.parentPath===false||this.parentPath===""){this.parentPath="asm/inc"}r="asm";$("#newDocRecordGridDimensions").hide();$("#newDocRecordSpriteDimensions").hide();$("#newDocRecordSpriteScreenModeGroup").hide();$("#newDocRecordBinFileGroup").hide();$("#newDocRecordDocName").show();break;case"music":this.parentPath="music";$("#newDocRecordGridDimensions").hide();$("#newDocRecordSpriteDimensions").hide();$("#newDocRecordSpriteScreenModeGroup").hide();$("#newDocRecordBinFileGroup").hide();$("#newDocRecordDocName").show();break;case"binary":this.parentPath="asm/bin";$("#newDocRecordGridDimensions").hide();$("#newDocRecordSpriteDimensions").hide();$("#newDocRecordSpriteScreenModeGroup").hide();$("#newDocRecordBinFileGroup").show();$("#newDocRecordDocName").hide();break;case"folder":var s=this.tree.getSelectedNode();this.parentPath=this.getNodePath(s);$("#newDocRecordGridDimensions").hide();$("#newDocRecordSpriteDimensions").hide();$("#newDocRecordSpriteScreenModeGroup").hide();$("#newDocRecordBinFileGroup").hide();$("#newDocRecordDocName").show();break}i=this.getUniqueFilename("/"+this.parentPath+"/",i,r);$("#newProjectFileName").val(i);var o=i.length;if(r!=""){var a=i.lastIndexOf(".");if(a!=-1){o=a}}var l=document.getElementById("newProjectFileName");l.focus();l.setSelectionRange(0,o)},reloadTreeBranch:function(e){var t=g_app.doc.getDocRecord(e);var i=this.tree.getNodeFromPath("/Project"+e);this.refreshTreeNode(t,i)},showNewDocRecordDialog:function(e){var t=this;if(this.newDocRecordDialog==null){var i=320;var r=296;this.newDocRecordDialog=UI.create("UI.Dialog",{id:"newProjectFileDialog",title:"New",width:i,height:r});this.newFileHTML=UI.create("UI.HTMLPanel");this.newDocRecordDialog.add(this.newFileHTML);this.newFileHTML.load("html/project/newDocRecord.html",function(){$("#newDocRecordType").on("change",function(){var e=$(this).val();t.setNewRecordType(e,false)});$("#newDocRecordDialog .submitOnEnter").on("keypress",function(e){if(e.key.toLowerCase()=="enter"){t.submitNewDocRecordDialog()}});$("#newDocBinaryChooseFiles").on("click",function(){document.getElementById("newDocRecordBinaryFile").click()});$("#newDocRecordBinaryFile").on("change",function(){t.binaryFilesChanged()});t.initNewRecordDialogContent(e)});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.okButton.on("click",function(e){t.submitNewDocRecordDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.closeButton.on("click",function(e){UI.closeDialog()});this.newDocRecordDialog.addButton(this.okButton);this.newDocRecordDialog.addButton(this.closeButton);UI.showDialog("newProjectFileDialog")}else{UI.showDialog("newProjectFileDialog");this.initNewRecordDialogContent(e)}},binaryFilesChanged:function(){var e=document.getElementById("newDocRecordBinaryFile").files;var t="";if(e.length==0){t+="<div>No files chosen</div>"}for(var i=0;i<e.length;i++){var r=e[i];var a=r.name;t+="<div>";t+=a;t+="</div>"}$("#newDocBinaryFiles").html(t)},submitNewDocRecordDialog:function(){var e={};var t=this.tree.getSelectedNode();if(t){var i=t.getType();if(i!="folder"){t=t.getParentNode()}}e.filename=$("#newProjectFileName").val().trim();if(e.filename==""){alert("Please enter a name");$("#newProjectFileName").focus();return}e.parentNode=t;this.newFile(e);UI.closeDialog()},selectDocRecord:function(e){e=e.trim();if(e.length>0&&e[0]!="/"){e="/"+e}var t=g_app.doc.getDocRecord(e);if(!t){console.log("no record!"+e);return false}var i=t.id;this.selectNodeWithId(i)},showDocRecord:function(e,t){if(e==false){return false}e=e.trim();if(e.length>0&&e[0]!="/"){e="/"+e}var i=g_app.doc.getDocRecord(e);if(!i){return false}var r=i.type;var a=i.id;if(r!=="folder"){var s=g_app.tabPanel;var o=true;var l=false;if(typeof t!="undefined"){if(typeof t.tempTab!="undefined"){o=t.tempTab}if(typeof t.forceReload!="undefined"){l=t.forceReload}}var n=s.getTabs();var h=s.getTabIndex(a);var d=false;if(h===-1){for(var c=0;c<n.length;c++){if(n[c].tab.isTemp===true){d=c;break}}}var f="";f+='<img height="14" style="height: 14px; margin: 0; padding: 0; border: 0; filter: invert(0.8)" src="images/tree/file.png">';f+="&nbsp; "+i.name;if(d!==false){s.setTabData(d,{key:a,path:e,title:f,isTemp:o});s.showTab(a)}else if(h!==-1){if(!o){s.setTabData(h,{isTemp:o})}s.showTab(a)}else{s.addTab({key:a,path:e,title:f,isTemp:o},true)}}if(this.currentPath===e&&!l){return}this.currentPath=e;switch(r){case"music":g_app.setMode("music");g_app.music.show(e);this.currentEditor=g_app.music;break;case"color palette":g_app.setMode("color palette");g_app.colorPaletteEditor.load(e);this.currentEditor=g_app.colorPaletteEditor;break;case"tile set":g_app.setMode("tile set");g_app.tileSetEditor.load(e);this.currentEditor=g_app.tileSetEditor;break;case"script":g_app.setMode("script");g_app.scriptEditor.load(e);this.currentEditor=g_app.scriptEditor;break;case"json":g_app.setMode("json");g_app.jsonEditor.load(e);this.currentEditor=g_app.jsonEditor;break;case"textmode":case"graphic":g_app.setMode("2d");g_app.textModeEditor.loadScreen(e,this.settings);this.currentEditor=g_app.textModeEditor;break;case"3d scene":g_app.setMode("3d");g_app.textModeEditor.open3d(e,this.settings);this.currentEditor=g_app.textModeEditor;break;case"asm":g_app.setMode("assembler");g_app.assemblerEditor.showFile(e,false,this.settings,l);g_app.assemblerEditor.show();this.currentEditor=g_app.assemblerEditor;break;case"bin":g_app.setMode("hex");g_app.hexEditor.load(e);this.currentEditor=g_app.hexEditor;break;case"prg":if(this.prgHandler=="c64"){g_app.setMode("c64");g_app.c64Debugger.showFile(e);this.currentEditor=g_app.c64Debugger}if(this.prgHandler=="x16"){g_app.setMode("x16");g_app.x16Debugger.showFile(e);this.currentEditor=g_app.x16Debugger}break;default:g_app.setMode("text");g_app.textEditor.load(e);this.currentEditor=g_app.textEditor;break;return false}return true},getNodePath:function(e){var t=e.getPath();var i="/"+this.rootLabel+"/";var r=t.indexOf(i);if(r>=0){t="/"+t.substr(r+i.length)}return t},deleteRecord:function(e){if(g_app.doc.deleteDocRecord(e)){var t=e.lastIndexOf("/");if(t==-1){return}var i=e.substring(0,t);this.refreshTreeNodeFromPath(i);this.treeRoot.refreshChildren();var r=g_app.tabPanel;r.closeTab(e)}},showRename:function(e){if(this.renameDialog==null){var t=300;var i=120;if(UI.isMobile.any()){i=220;t=270}this.renameDialog=UI.create("UI.Dialog",{id:"docRecordRenameDialog",title:"Rename",width:t,height:i});var r='<div id="renameDocRecordDialog" class="panelFill dialogContent">';r+='  <div class="formGroup">';r+='    <label class="controlLabel" for="renameDocRecordName">Name:</label>';r+='    <input type="text" class="formControl submitOnEnter" spellcheck="false" id="renameDocRecordName"/>';r+="  </div>";r+="</div>";this.renameHTML=UI.create("UI.HTMLPanel",{html:r});this.renameDialog.add(this.renameHTML);var a=this;var s=UI.create("UI.Button",{text:"OK",color:"primary"});s.on("click",function(e){var t=$("#renameDocRecordName").val();a.renameDocRecord(a.renamePath,t);UI.closeDialog()});var o=UI.create("UI.Button",{text:"Cancel",color:"secondary"});o.on("click",function(e){UI.closeDialog()});this.renameDialog.addButton(s);this.renameDialog.addButton(o);$("#renameDocRecordDialog .submitOnEnter").on("keypress",function(e){if(e.key.toLowerCase()=="enter"){var t=$("#renameDocRecordName").val();a.renameDocRecord(a.renamePath,t);UI.closeDialog()}})}var l=g_app.doc.getDocRecord(e);if(l){this.renamePath=e;var n=l.name;$("#renameDocRecordName").val(n);UI.showDialog("docRecordRenameDialog");$("#renameDocRecordName").focus();var h=n.lastIndexOf(".");if(h!==-1){$("#renameDocRecordName")[0].setSelectionRange(0,h)}else{$("#renameDocRecordName").select()}}},renameDocRecord:function(e,t){var i=g_app.doc.getDocRecord(e);if(i){var r=this.tree.getNodeFromPath("/Project"+e);var a=i;var s=r.getParentNode();var o=e;var l=e.lastIndexOf("/");if(l!=-1){o=o.substr(0,l);a=g_app.doc.getDocRecord(o)}i.name=t;switch(i.type){case"graphic":break;case"tile set":var n=g_app.textModeEditor.tileSetManager.getTileSet(i.id);if(n){n.nameChanged()}break;case"color palette":var h=g_app.textModeEditor.colorPaletteManager.getColorPalette(i.id);if(h){h.nameChanged()}break}this.refreshTreeNode(a,s);this.treeRoot.refreshChildren()}},showContextMenu:function(e,i){var t=e.pageX;var r=e.pageY;var a=i.m_treeID+"node"+i.id+"row";$("#"+a).addClass("ui-tree-contextselected-row");if(this.projectNavigatorPopup==null){this.projectNavigatorPopup=new ProjectNavigatorPopup;this.projectNavigatorPopup.init(this.editor)}var s=this.getNodePath(i);var o=g_app.doc.getDocRecord(s);if(o.type=="folder"){$("#projectNavigatorMenuRename").hide();$("#projectNavigatorMenuCreate").show()}else{$("#projectNavigatorMenuRename").show();$("#projectNavigatorMenuCreate").show()}if(this.cantDelete.indexOf(s)!==-1){$("#projectNavigatorMenuDelete").hide()}else{$("#projectNavigatorMenuDelete").show()}var l=this;this.parentPath=s;this.projectNavigatorPopup.show(t,r,{path:s,callback:function(e,t){l.projectNavigatorPopup.close();switch(e){case"rename":l.showRename(s);break;case"create":l.showNewDocRecordDialog({path:s,node:i});break;case"createfolder":l.showNewDocRecordDialog({path:s,node:i});break;case"delete":if(confirm("Are you sure you want to delete?\n\n"+s)){l.deleteRecord(s)}break}}})},showFile:function(e,t){var i=false;if(typeof t!="undefined"){i=t}var r=e.getAttribute("filename");var a=e.getPath();var s=e.getType();var o="/"+this.rootLabel+"/";var l=a.indexOf(o);if(l>=0){a="/"+a.substr(l+o.length)}if(s!=="folder"&&this.currentEditor){if(typeof this.currentEditor.saveSettings!=="undefined"){this.currentEditor.saveSettings(this.settings)}}if(s=="folder"){e.toggle()}else{this.showDocRecord(a,{tempTab:!i})}},refreshTreeNodeFromPath:function(e){var t=g_app.doc.getDocRecord(e);var i=this.tree.getNodeFromPath("/Project"+e);this.refreshTreeNode(t,i)},refreshTreeNodeChildren:function(e,t){t.deleteChildren();var i=[];for(var r=0;r<e.length;r++){var a=e[r].name;var s=e[r].type;var o=e[r].id;if(typeof e[r].deleted=="undefined"||e[r].deleted!==true){i.push({index:r,label:a,type:s,attributes:{filename:a,id:o}})}}i.sort(function(e,t){if(e.type!=t.type){if(e.type=="folder"){return-1}if(t.type=="folder"){return 1}}return e.label.localeCompare(t.label)});for(var r=0;r<i.length;r++){var l=t.addChild(i[r]);this.treeMap[i[r]["attributes"].id]=l;if(i[r].type=="folder"&&typeof e[i[r].index].children!="undefined"){this.refreshTreeNodeChildren(e[i[r].index].children,l)}}},refreshTreeNode:function(e,t){if(typeof e.children=="undefined"||!t){return}this.refreshTreeNodeChildren(e.children,t);return;t.deleteChildren();var i=e.children;var r=[];for(var a=0;a<i.length;a++){var s=i[a].name;var o=i[a].type;var l=i[a].id;if(typeof i[a].deleted=="undefined"||i[a].deleted!==true){r.push({index:a,label:s,type:o,attributes:{filename:s,id:l}})}}r.sort(function(e,t){if(e.type!=t.type){if(e.type=="folder"){return-1}if(t.type=="folder"){return 1}}return e.label.localeCompare(t.label)});console.log("SORTED SUB DOCS");console.log(r);for(var a=0;a<r.length;a++){var n=t.addChild(r[a]);this.treeMap[r[a]["attributes"].id]=n;if(r[a].type=="folder"){this.refreshTreeNode(i[r[a].index],n)}}},refreshTree:function(e){if(g_app.doc==null){return}this.files=e;this.treeRoot.deleteChildren();this.treeMap={};var t=g_app.doc;var i=t.dir("/");if(i!=null){this.refreshTreeNodeChildren(i,this.treeRoot)}this.treeRoot.refreshChildren()},addFile:function(e,t){this.refreshTree()}};var ProjectShare=function(){this.editor=null;this.shareDialog=null;this.githubClient=null};ProjectShare.prototype={init:function(e){this.githubClient=e;this.github=g_app.github},initShareDialogContent:function(){this.checkRepository()},initShareDialogEvents:function(){var e=this;$("#loginRegisterGitHub").on("click",function(){e.githubClient.login(function(){e.userIsLoggedIn()})})},showShareDialog:function(){var e=this;console.log("SHOW SHARE DIALOG!!!");g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true);if(this.shareDialog==null){var t=320;var i=296;this.shareDialog=UI.create("UI.Dialog",{id:"projectShareDialog",title:"Share Project",width:t,height:i});this.shareHTML=UI.create("UI.HTMLPanel");this.shareDialog.add(this.shareHTML);this.shareHTML.load("html/project/projectShareDialog.html",function(){e.initShareDialogEvents();e.initShareDialogContent()});this.shareDialog.on("close",function(){console.log("CLOSE SHARE DIALOG");g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});var r=UI.create("UI.Button",{text:"OK",color:"primary"});r.on("click",function(e){UI.closeDialog()});var a=UI.create("UI.Button",{text:"Cancel",color:"secondary"});a.on("click",function(e){UI.closeDialog()});this.shareDialog.addButton(r);this.shareDialog.addButton(a);UI.showDialog("projectShareDialog")}else{UI.showDialog("projectShareDialog");this.initShareDialogContent()}},checkRepository:function(){if(!this.githubClient.isLoggedIn()){$("#projectShareLogin").show()}else{this.userIsLoggedIn()}},userIsLoggedIn:function(){$("#projectShareLogin").hide();$("#projectShareRepositoryDetails").show();var i=this.github.getCurrentRepository();console.log("current repository");console.log(i);if(i.repository==""){this.noCurrentRepository()}else{var r=this;this.githubClient.getRepoDetails(i,function(e){console.log("GET REPO DETAILS RESPONSE::::");console.log(e);var t=e.data.private;if(t){r.currentRepositoryIsPrivate(i)}else{r.currentRepositoryIsPublic(i)}})}},noCurrentRepository:function(e){$("#projectShareRepositoryDetails").show();$("#projectShareRepositoryOptions").hide();$("#projectShareNewRepository").show();var t=this.githubClient.getLoginName();$("#shareRepositoryOwner").val(t);$("#shareRepositoryName").val("Repository");$("#shareRepositoryName").select();$("#shareRepositoryName").focus()},currentRepositoryIsPublic:function(e){$("#projectShareRepositoryDetails").show();$("#projectShareRepositoryOptions").show();$("#projectShareNewRepository").hide();$("#shareRepositoryOwner").val(e.owner);$("#shareRepositoryName").val(e.repository);$("#shareGithubRepositoryAction_save").prop("checked",true)},currentRepositoryIsPrivate:function(){},createRepository:function(){var e={};e.owner=$("#shareRepositoryOwner").val().trim();e.repository=$("#shareRepositoryName").val().trim().replace(/ /g,"-");e.repositoryType="public";e.commitMessage="Initial Commit";if(e.owner==""){alert("Please enter a value for the repository owner");return}if(e.repository==""){alert("Please enter a name for the repository");return}}};var ProjectNavigatorMobile=function(){this.rootLabel="Project";this.visible=false;this.uiComponent=null;this.newDocRecordDialog=null;this.treeMap={};this.settings={};this.selectedId=false;this.currentEditor=null};ProjectNavigatorMobile.prototype={init:function(){this.currentEditor=g_app.textModeEditor},buildInterface:function(){var e=UI.getScreenWidth()-30;if(e>380){e=380}this.uiComponent=UI.create("UI.Dialog",{id:"projectNavigatorMobileDialog",title:"Project Explorer",width:e});html='<div class="panelFill">';html+='<div id="projectNavigatorMobileButtons" style="position: absolute; left: 10px; top: 10px; height: 30px; right: 10px">';html+="</div>";html+='<div id="projectDocListMobile"></div>';html+="</div>";var t=this;var i=UI.create("UI.HTMLPanel",{html:html});this.uiComponent.add(i);var r=UI.create("UI.Button",{text:"Open",color:"primary"});this.uiComponent.addButton(r);r.on("click",function(e){t.openSelected();UI.closeDialog()});var r=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(r);r.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){t.visible=false});$("#addRecordButton").on("click",function(){t.showNewDocRecordDialog()})},initNewRecordDialogContent:function(e){var t=false;if(typeof e!=="undefined"){if(typeof e.type!="undefined"){t=e.type}}$("#newDocRecordMobileType").val(t);var i=this;$("#newDocRecordMobileType").on("change",function(){var e=$(this).val();i.setNewRecordType(e,false)});var r="Untitled";$("#newProjectFileNameMobile").val(r)},setTileSets:function(e){var t=false;var i=false;if(typeof e!="undefined"){if(typeof e.width!="undefined"){t=e.width}if(typeof e.height!="undefined"){i=e.height}}var r="";r+='<option value="">New</option>';var a=g_app.doc.dir("/tile sets");var s=0;var o=false;for(var l=0;l<a.length;l++){var n=a[l];var h=n.data.width;var d=n.data.height;if((h===t||t===false)&&(d===i||i===false)){s++;if(o===false){o=a[l].id}r+='<option value="'+a[l].id+'">'+a[l].name+"</option>"}}$("#newDocRecordMobileTileSet").html(r);if(s>0){$("#newDocRecordMobileTileSet").val(o)}else{$("#newDocRecordMobileTileSet").val("")}},setColorPalettes:function(){var e="";e+='<option value="">New</option>';var t=g_app.doc.dir("/color palettes");for(var i=0;i<t.length;i++){var r=t[i];e+='<option value="'+r.id+'">'+r.name+"</option>"}$("#newDocRecordMobileColorPalette").html(e);if(t.length>0){$("#newDocRecordMobileColorPalette").val(t[0].id)}},setNewRecordType:function(e,t){var i=$("#newProjectFileNameMobile").val();var r="";var a="";var s=i.lastIndexOf(".");if(s!==-1){i=i.substring(0,s)}if(typeof t=="undefined"||t){$("#newDocRecordMobileType").val(e)}if(e=="sprite"){r="sprites";$("#newDocRecordGridDimensionsDepthMobile").hide();$("#newDocRecordMobileGridDimensions").hide();this.setColorPalettes();this.setTileSets({width:24,height:21})}if(e=="screen"){r="screens";$("#newDocRecordMobileGridDimensions").show();$("#newDocRecordGridDimensionsDepthMobile").hide();this.setColorPalettes();this.setTileSets()}if(e=="3d scene"){this.parentPath="3d scenes";$("#newDocRecordGridDimensionsDepthMobile").show();this.setTileSets();this.setColorPalettes()}if(e=="asm"){r="asm/inc";$("#newDocRecordMobileGridDimensions").hide();a="asm"}i=this.getUniqueFilename("/"+r+"/",i,a);$("#newProjectFileNameMobile").val(i);var o=i.length;if(a!=""){var s=i.lastIndexOf(".");if(s!=-1){o=s}}var l=document.getElementById("newProjectFileNameMobile");l.focus();l.setSelectionRange(0,o)},showNewDocRecordDialog:function(e){var t=false;if(typeof e!=="undefined"){if(typeof e.type!="undefined"){t=e.type}}var o=this;if(this.newDocRecordDialog==null){var i=UI.getScreenWidth()-30;if(i>380){i=380}var r=290;this.newDocRecordDialog=UI.create("UI.Dialog",{id:"newProjectFileDialogMobile",title:"New",width:i,height:r});this.newFileHTML=UI.create("UI.HTMLPanel");this.newDocRecordDialog.add(this.newFileHTML);this.newFileHTML.load("html/project/newDocRecordMobile.html",function(){o.initNewRecordDialogContent(e);if(t!=false){o.setNewRecordType(t)}});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.okButton.on("click",function(e){var t=$("#newDocRecordMobileType").val();var i=$("#newProjectFileNameMobile").val();var r=$("#newDocRecordGridWidthMobile").val();var a=$("#newDocRecordGridHeightMobile").val();var s=$("#newDocRecordGridDepthMobile").val();o.newRecord({type:t,name:i,width:r,height:a,depth:s});UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.closeButton.on("click",function(e){UI.closeDialog()});this.newDocRecordDialog.addButton(this.okButton);this.newDocRecordDialog.addButton(this.closeButton)}else{this.initNewRecordDialogContent(e);if(t!=false){this.setNewRecordType(t)}}UI.showDialog("newProjectFileDialogMobile")},getUniqueFilename:function(e,t,i){var r=0;var a="";if(typeof i!="undefined"&&i!=""){a="."+i}var s=t.lastIndexOf(".");if(s!==-1){var o=t.substring(s);if(o.toLowerCase()==a.toLowerCase()){t=t.substring(0,s)}}var l=t;while(g_app.doc.getDocRecord(e+l+a)){r++;l=t+" "+r}return l+a},newRecord:function(e){var t=e.name;var i=e.type;var r=this;var a="";var s=false;switch(i){case"sprite":s="sprites";break;case"screen":s="screens";break;case"asm":s="asm/inc";a="asm";break;case"3d scene":s="3d scenes";break}if(s===false){return}t=this.getUniqueFilename("/"+s+"/",t,a);if(i=="3d scene"){var o="c64_colodore";var l=$("#newDocRecordMobileTileSet").val();var n=$("#newDocRecordMobileColorPalette").val();var h=40;if(typeof e.width!="undefined"){h=parseInt(e.width,10)}var d=40;if(typeof e.height!="undefined"){d=parseInt(e.height,10)}if(isNaN(d)){d=25}var c=25;if(typeof e.depth!="undefined"){c=parseInt(e.depth,10)}if(isNaN(c)){c=25}g_app.textModeEditor.grid3d.createDoc({parentPath:"/3d scenes",name:t,gridWidth:h,gridHeight:d,gridDepth:c,colorPalette:o,tileSet:f,tileSetId:l,colorPaletteId:n},function(e){r.updateProjectList();r.selectDoc(e.id,"3d scenes/"+t);r.openSelected();UI.closeDialog()})}if(i=="screen"){i="graphic";var o="c64_colodore";var l=$("#newDocRecordMobileTileSet").val();var n=$("#newDocRecordMobileColorPalette").val();var h=40;if(typeof e.width!="undefined"){h=parseInt(e.width,10)}var d=40;if(typeof e.height!="undefined"){d=parseInt(e.height,10)}if(isNaN(d)){d=25}g_app.textModeEditor.createDoc({parentPath:"/screens",name:t,gridWidth:h,gridHeight:d,colorPalette:o,colorPaletteId:n,tileSet:"",tileSetId:l},function(e){r.updateProjectList();r.selectDoc(e.id,"screens/"+t);r.openSelected();UI.closeDialog()})}if(i=="sprite"){i="graphic";var o="";var f="petscii";var l=$("#newDocRecordMobileTileSet").val();var n=$("#newDocRecordMobileColorPalette").val();if(n==""){o="c64_colodore"}var u="Sprite Tile Set";g_app.textModeEditor.createDoc({parentPath:"/sprites",name:t,gridWidth:1,gridHeight:1,colorPalette:o,colorPaletteId:n,cellWidth:24,cellHeight:21,tileSet:"",tileSetId:l,tileSetArgs:{width:24,height:21,name:u}},function(e){r.updateProjectList();r.selectDoc(e.id,"sprites/"+t);r.openSelected();g_app.textModeEditor.setBackgroundColor(g_app.textModeEditor.colorPaletteManager.noColor);UI.closeDialog()})}if(i=="asm"){i="asm";data="; asm file";var p=g_app.doc.createDocRecord("/asm/inc",t,i,data);r.updateProjectList();r.selectDoc(p.id,"asm/inc/"+t);r.openSelected();UI.closeDialog()}},getDocListHTML:function(e,t){var i="";var r="";if(typeof t!="undefined"){r=t}var a=e.children;var s=e.name;if(s=="inc"){s="asm/"+s}for(var o=0;o<a.length;o++){if(a[o].type!=="folder"){var l=s+"/"+a[o].name;console.log(s);i+='<div class="projectNavigatorMobileDoc';if(this.selectedId===a[o].id){i+=" projectNavigatorMobileDocSelected"}var n=a[o].type;if(n=="graphic"){if(s=="screens"){n="screen"}if(s=="sprites"){n="sprite"}}i+='" data-path="'+l+'" data-parent="'+s+'" data-id="'+a[o].id+'" id="mobileDoc-'+a[o].id+'">';i+='<img class="projectNavigatorMobileDocIcon" src="'+Icons.get(n)+'" />';i+='<span class="projectNavigatorMobileFilename">'+r+a[o].name+"</span>";i+="</div>"}if(a[o].type=="folder"&&a[o].name=="inc"){i+=this.getDocListHTML(a[o],"inc/")}}return i},updateProjectList:function(){var e="";var t=g_app.doc;var i=t.dir("/");if(this.selectedId===false){var r=g_app.projectNavigator.getCurrentEditor();if(r){var a=r.doc;if(a){this.selectedId=a.id}}}if(i!=null){for(var s=0;s<i.length;s++){if(i[s].type!="hiddenfile"){var o=i[s].name;var l=i[s].type;var n=i[s].id;if(l=="folder"){if(o=="screens"||o=="sprites"||o=="asm"||o=="build"||o=="3d scenes"){e+='<div class="projectNavigatorMobileSection">';e+='<div class="projectNavigatorMobileFolder">';e+=o;if(o=="screens"){e+='<div class="ui-button mobileAddRecordButton" data-type="screen" id="mobileProjectAddScreenButton">';e+='<div class="rippleJS"></div>';e+='<i class="halflings halflings-plus"></i> New Screen...';e+="</div>"}if(o=="sprites"){e+='<div class="ui-button mobileAddRecordButton"  data-type="sprite" id="mobileProjectAddSpriteButton">';e+='<div class="rippleJS"></div>';e+='<i class="halflings halflings-plus"></i> New Sprite...</div>'}if(o=="asm"){e+='<div class="ui-button mobileAddRecordButton"  data-type="asm"  id="mobileProjectAddSpriteButton">';e+='<div class="rippleJS"></div>';e+='<i class="halflings halflings-plus"></i> New ASM...</div>'}if(o=="3d scenes"){e+='<div class="ui-button mobileAddRecordButton"  data-type="3d scene"  id="mobileProjectAdd3dSceneButton">';e+='<div class="rippleJS"></div>';e+='<i class="halflings halflings-plus"></i> New 3d Scene...</div>'}e+="</div>";var h=this.getDocListHTML(i[s]);if(h==""){h+='<div class="projectNavigatorMobileEmptyDocList"></div>'}e+=h;e+="</div>"}}}}}$("#projectDocListMobile").html(e);var d=this;$(".projectNavigatorMobileDoc").on("click",function(){var e=$(this).attr("data-id");var t=$(this).attr("data-path");d.selectDoc(e,t)});$(".mobileAddRecordButton").on("click",function(){var e=$(this).attr("data-type");$("#newDocRecordMobileType").val(e);d.showNewDocRecordDialog({type:e})})},selectDoc:function(e,t){this.selectedId=e;this.selectedPath=t;console.log("select doc "+e+","+t);$(".projectNavigatorMobileDoc").removeClass("projectNavigatorMobileDocSelected");$("#mobileDoc-"+e).addClass("projectNavigatorMobileDocSelected")},openSelected:function(){if(this.currentEditor){if(typeof this.currentEditor.saveSettings!=="undefined"){this.currentEditor.saveSettings(this.settings)}}var e="/"+this.selectedPath;console.log("PATH = '"+e+"'");var t=e.lastIndexOf("/");parentPath=e.substring(0,t);var i=g_app.doc.getDocRecord(e);if(!i){console.log("NO RECORD FOR "+e);return false}var r=i.type;console.log("TYPE = "+r);switch(r){case"textmode":case"graphic":g_app.setMode("2d");g_app.textModeEditor.loadScreen(e,this.settings);this.currentEditor=g_app.textModeEditor;break;case"3d scene":g_app.setMode("3d");g_app.textModeEditor.open3d(e,this.settings);this.currentEditor=g_app.textModeEditor;break;case"asm":g_app.setMode("assembler");g_app.assemblerEditor.showFile(e,this.settings);this.currentEditor=g_app.assemblerEditor;break;case"bin":g_app.setMode("hex");g_app.hexEditor.load(e);this.currentEditor=g_app.hexEditor;break;case"prg":g_app.setMode("c64");g_app.c64Debugger.showFile(e);this.currentEditor=g_app.c64Debugger;break}},show:function(){this.visible=true;if(this.uiComponent==null){this.buildInterface()}this.updateProjectList();UI.showDialog("projectNavigatorMobileDialog")}};var g_isNewUser=true;var StartPage=function(){this.uiComponent=null;this.renameDialog=null;this.projects={};this.localProjectList=[];this.githubProjectList=[];this.googleDriveProjectList=[];this.gdriveFileIdToLoad=false;this.gdriveStatusKnown=false;this.projectList=[];this.repositoryToLoad=false;this.repositoryToLoadView=false;this.userStatusKnown=false;this.gistToLoad=false;this.dragBorderElementTop=false;this.dragBorderVisible=false};StartPage.prototype={init:function(){},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.Panel",{id:"startPage"});e.add(this.uiComponent);this.htmlPanel=UI.create("UI.HTMLPanel",{id:"startPageHTML",html:'<div id="frames" class="panelFill" style="background-color: #ffffff"></div>'});this.uiComponent.add(this.htmlPanel);var i='<div style="text-align: center; padding-top: 100px">';i+='<div style="margin-bottom: 10px"><img src="images/logo32t.png"/></div>';i+="<div>loading....</div>";i+="</div>";this.loadingPanel=UI.create("UI.HTMLPanel",{id:"loadingPageHTML",html:i});this.uiComponent.add(this.loadingPanel,{id:"loadeeingPanel"});UI.on("ready",function(){t.uiComponent.showOnly("loadingPageHTML");var e="html/startPage.html";if(UI.isMobile.any()){e="html/startPageMobile.html"}t.htmlPanel.load(e,function(){t.initContent();t.initEvents()})})},show:function(){this.uiComponent.showOnly("startPageHTML");this.drawBrowserStorage()},gdriveStatusUpdated:function(){this.gdriveStatusKnown=true;if(this.gdriveFileIdToLoad!==false){var e=this.gdriveFileIdToLoad;g_app.gdrive.openProject({id:e,name:"Untitiled"});this.gdriveFileIdToLoad=false}},userLoginStatusUpdated:function(){this.userStatusKnown=true;if(this.repositoryToLoad!==false){var t=this.repositoryToLoad;var e=this;g_app.fileManager.getCacheFile(t,function(e){if(e!==null){g_app.fileManager.loadCachedData({data:e,view:this.repositoryToLoadView})}else{g_app.github.loadRepository({address:t,view:this.repositoryToLoadView,callback:function(){var e=1*60*60;g_app.fileManager.cacheFile(t,g_app.doc.data,e)}})}});this.repositoryToLoad=false}if(this.gistToLoad!==false){g_app.gist.loadFromGist({gist:this.gistToLoad})}},processURL:function(){var g=this;UI.on("ready",function(){var e=window.location.href;var t=new URLSearchParams(window.location.search);t.has("type");var i="";if(t.has("tileset")){i=t.get("tileset")}var r="";if(t.has("editor")){r=t.get("editor")}if(e.indexOf("/c64/")!==-1){r="c64"}var a=40;if(t.has("width")){a=parseInt(t.get("width"),10)}var s=25;if(t.has("height")){s=parseInt(t.get("height"),10)}var o="textmode";if(t.has("mode")){o=t.get("mode")}var l=false;if(t.has("tileflip")&&parseInt(t.get("tileflip"),10)==1){l=true}var n=false;if(t.has("tilerotate")&&parseInt(t.get("tilerotate"),10)==1){n=true}var h="";if(t.has("palette")){h=t.get("palette")}var d=false;if(t.has("gh")){d=t.get("gh")}var c=false;if(t.has("gist")){c=t.get("gist")}if(t.has("gid")){c=t.get("gid")}var f=false;if(t.has("gd")){f=t.get("gd")}var u=false;if(t.has("view")){u=t.get("view")}if(d!==false){g.repositoryToLoad=d;g.repositoryToLoadView=u;if(g.userStatusKnown){g.userLoginStatusUpdated()}return}if(f!==false){g.gdriveFileIdToLoad=f;if(g.gdriveStatusKnown){g.gdriveStatusUpdated()}return}if(c!==false){g.gistToLoad=c;g.gistToLoadView=u;if(g.userStatusKnown){g.userLoginStatusUpdated()}return}if(i!=""||h!=""||r!=""){var p={};p.mode=TextModeEditor.Mode.TEXTMODE;if(isNaN(a)||a<=0){p.width=40}else{p.width=a}if(isNaN(s)||s<=0){p.height=25}else{p.height=s}p.editor=r;p.tileSet=i;p.palette=h;p.screenMode=o;p.canFlipTile=l;p.canRotateTile=n;g_app.newProject(p,function(){});var e=window.location.href;var v=e.indexOf("?");if(v!==-1){e=e.substr(0,v)}UI.browserPushState({},"lvllvl",e)}else{g_app.setMode("start")}})},initRenameContent:function(){var e=this.projects[this.currentProjectId].name;$("#renameProjectName").val(e)},renameProject:function(e){var t=this;g_app.fileManager.renameProject({projectId:this.currentProjectId,name:e},function(){t.drawBrowserStorage()})},showRenameProject:function(e){var i=this;if(this.renameDialog==null){var t=360;var r=100;if(UI.isMobile.any()){r=220;t=270}this.renameDialog=UI.create("UI.Dialog",{id:"renameDialog",title:"Rename",width:t,height:r});this.newHTML=UI.create("UI.HTMLPanel");this.renameDialog.add(this.newHTML);this.newHTML.load("html/project/renameDialog.html",function(){i.initRenameContent()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.okButton.on("click",function(e){var t=$("#renameProjectName").val();i.renameProject(t);UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.closeButton.on("click",function(e){UI.closeDialog()});this.renameDialog.addButton(this.okButton);this.renameDialog.addButton(this.closeButton)}else{this.initRenameContent()}UI.showDialog("renameDialog")},displayPersist:function(e){var t=e;if(e!="persisted"){}t="";$("#browserStorage_persistent").html(t)},updateProjectThumbnails:function(){},drawProjects:function(){var a=this;var e="";var t=[];for(var i=0;i<this.localProjectList.length;i++){this.localProjectList[i].type="local";t.push(this.localProjectList[i])}for(var i=0;i<this.githubProjectList.length;i++){this.githubProjectList[i].type="github";var r=this.githubProjectList[i].owner;var s=this.githubProjectList[i].repository;var o=false;for(var l=0;l<this.localProjectList.length;l++){if(typeof this.localProjectList[l].githubOwner!="undefined"&&typeof this.localProjectList[l].githubRepository!="undefined"){if(this.localProjectList[l].githubOwner===r&&this.localProjectList[l].githubRepository===s){o=true;break}}}if(!o){t.push(this.githubProjectList[i])}}for(var i=0;i<this.googleDriveProjectList.length;i++){this.googleDriveProjectList[i].type="gdrive";t.push(this.googleDriveProjectList[i])}t.sort(function(e,t){if(typeof e.lastModified=="undefined"){return 1}if(typeof t.lastModified=="undefined"){return-1}if(e.lastModified<t.lastModified){return 1}if(e.lastModified>t.lastModified){return-1}return 0});if(t.length>0){if(typeof tryPersistWithoutPromtingUser!="undefined"){tryPersistWithoutPromtingUser(function(e){a.displayPersist(e)})}}for(var i=0;i<t.length;i++){var n=t[i].id;var h=t[i].name;if(h!=="__autosave"){a.projects[n]=t[i];var d="";if(t[i].type=="local"){var c=false;var f=false;if(typeof t[i].githubOwner!=="undefined"&&typeof t[i].githubRepository!="undefined"){c=t[i].githubOwner;f=t[i].githubRepository}d+='<div class="start-tile">';d+='<div class="rippleJS"></div>';d+='<div class="start-tile-image project-open" ';d+=' data-id="'+n+'" ';d+=' data-name="'+h+'" ';if(c&&f){d+=' data-owner="'+c+'" ';d+=' data-repository="'+f+'" '}d+=" style=\"image-rendering: pixelated; background-image: url('"+t[i].thumbnailData+"')\">";if(c&&f){}d+='<div class="rippleJS"></div>';d+="</div>";d+='<div class="start-tile-label project-open" data-id="'+n+'" data-name="'+h+'">';if(c&&f){d+='<img style="filter: invert(80%); margin-right: 4px; width: 14px; height: 14px; " src="icons/GitHub-Mark-64px.png"/>'}d+=h;d+="</div>";if(c&&f){d+='<div class="start-tile-more repository-more" data-id="'+n+'" data-owner="'+c+'" data-repository="'+f+'"><img src="icons/material/baseline-more_vert-24px.svg" height="16px"/></div>'}else{d+='<div class="start-tile-more project-more" data-id="'+n+'" data-name="'+h+'"><img src="icons/material/baseline-more_vert-24px.svg" height="16px"/></div>'}d+="</div>"}else if(t[i].type=="github"){var r=t[i].owner;var s=t[i].repository;d+='<div class="start-tile">';d+='<div class="rippleJS"></div>';d+='<div class="start-tile-image repository-open" title="'+s+'" data-owner="'+r+'" data-repository="'+s+'" style="text-align: center; display: flex-box">';d+='<img style="filter: invert(60%); width: 32px; height: 32px; " src="icons/GitHub-Mark-64px.png"/>';d+='<div class="rippleJS"></div>';d+="</div>";d+='<div class="start-tile-label repository-open" title="'+s+'" data-owner="'+r+'" data-repository="'+s+'">'+s+"</div>";d+='<div class="start-tile-more repository-more" data-id="'+n+'" data-owner="'+r+'" data-repository="'+s+'"><img src="icons/material/baseline-more_vert-24px.svg" height="16px"/></div>';d+="</div>"}else if(t[i].type=="gdrive"){var u=t[i].name;var p=t[i].id;d+='<div class="start-tile">';d+='<div class="rippleJS"></div>';d+='<div class="start-tile-image gdrive-open" data-id="'+p+'" title="'+u+'" style="text-align: center; display: flex-box">';d+='<img style="filter: invert(60%); width: 32px; height: 32px; " src="icons/GoogleDriveIconMonochromatic512.png"/>';d+='<div class="rippleJS"></div>';d+="</div>";d+='<div class="start-tile-label gdrive-open" data-id="'+p+'" title="'+u+'">'+u+"</div>";d+='<div class="start-tile-more gdrive-more"  data-id="'+p+'" title="'+u+'"><img src="icons/material/baseline-more_vert-24px.svg" height="16px"/></div>';d+="</div>"}e+=d}}$("#browserStorage_projects").html(e);a.updateProjectThumbnails();$(".project-open").on("click",function(){var e=$(this).attr("data-id");a.projectOpen({projectId:e})});$(".project-more").on("click",function(e){var t=$(this).attr("data-id");a.showProjectMenu(e,t)});$(".project-open").on("contextmenu",function(e){e.preventDefault();var t=$(this).attr("data-id");var i=$(this).attr("data-owner");var r=$(this).attr("data-repository");if(i&&r){a.showRepositoryMenu(e,i,r,t)}else{a.showProjectMenu(e,t)}});$(".repository-open").on("click",function(e){var t=$(this).attr("data-owner");var i=$(this).attr("data-repository");g_app.github.openRepository({owner:t,repository:i})});$(".repository-more").on("click",function(e){var t=$(this).attr("data-id");var i=$(this).attr("data-owner");var r=$(this).attr("data-repository");a.showRepositoryMenu(e,i,r,t)});$(".repository-open").on("contextmenu",function(e){var t=$(this).attr("data-owner");var i=$(this).attr("data-repository");e.preventDefault();a.showRepositoryMenu(e,t,i)});$(".gdrive-open").on("click",function(e){var t=$(this).attr("data-id");var i=$(this).attr("title");g_app.gdrive.openProject({id:t,name:i})});$(".gdrive-open").on("contextmenu",function(e){var t=$(this).attr("title");var i=$(this).attr("data-id");e.preventDefault();a.showGDriveMenu(e,t,i)});$(".gdrive-more").on("click",function(e){var t=$(this).attr("title");var i=$(this).attr("data-id");a.showGDriveMenu(e,t,i)});if(e==""){e="<div>Saved projects will appear here</div>";$("#browserStorage_projects").html(e)}},showDragBorder:function(){if(!this.dragBorderVisible){this.dragBorderVisible=true;if(this.dragBorderElementTop==false){this.dragBorderElementTop=document.createElement("div");this.dragBorderElementTop.setAttribute("style","position: absolute; border-top: 2px solid #4433dd; z-index: 3000; top: 0; height: 2px; left: 0; right: 0");this.dragBorderElementTop.setAttribute("id","dragBorderElementTop");document.body.appendChild(this.dragBorderElementTop);this.dragBorderElementBottom=document.createElement("div");this.dragBorderElementBottom.setAttribute("style","position: absolute; border-bottom: 2px solid #4433dd; z-index: 3000; height: 2px; bottom: 0; left: 0; right: 0");this.dragBorderElementBottom.setAttribute("id","dragBorderElementBottom");document.body.appendChild(this.dragBorderElementBottom);this.dragBorderElementLeft=document.createElement("div");this.dragBorderElementLeft.setAttribute("style","position: absolute; border-left: 2px solid #4433dd; z-index: 3000; top: 0; bottom: 0; left: 0; width: 2px");this.dragBorderElementLeft.setAttribute("id","dragBorderElementLeft");document.body.appendChild(this.dragBorderElementLeft);this.dragBorderElementRight=document.createElement("div");this.dragBorderElementRight.setAttribute("style","position: absolute; border-right: 2px solid #4433dd; z-index: 3000; top: 0; bottom: 0; width: 2px; right: 0");this.dragBorderElementRight.setAttribute("id","dragBorderElementRight");document.body.appendChild(this.dragBorderElementRight)}else{$("#dragBorderElementTop").show();$("#dragBorderElementBottom").show();$("#dragBorderElementLeft").show();$("#dragBorderElementRight").show()}}},hideDragBorder:function(){$("#dragBorderElementTop").hide();$("#dragBorderElementBottom").hide();$("#dragBorderElementLeft").hide();$("#dragBorderElementRight").hide();this.dragBorderVisible=false},setIsNewUser:function(e){g_isNewUser=e;if(!e){var t=g_app.getPref("textmode.petsciisortmethod");if(typeof t=="undefined"||t==null){g_app.setPref("textmode.petsciisortmethod","similar")}var i=g_app.getPref("textmode.infoPanelVisible");if(typeof i=="undefined"||i===null){g_app.setPref("textmode.infoPanelVisible","yes")}}},drawBrowserStorage:function(){var t=this;g_app.fileManager.getProjectList({type:"project"},function(e){t.localProjectList=e.projects;t.setIsNewUser(t.localProjectList.length==0);t.drawProjects()});g_app.fileManager.getAutosaveSummary(function(e){if(e.success){$("#start-continue-last .start-tile-image").css("background-image","url('"+e.thumbnailData+"')");$("#start-continue-last").show()}else{$("#start-continue-last").hide()}});$(".projectDelete").on("click",function(){if(confirm("Are you sure you want to delete?")){var e=$(this).attr("data-fileId");t.projectDelete({fileId:e})}});$(".templateOpen").on("click",function(){var e=$(this).attr("data-fileId");t.templateOpen({fileId:e})})},initContent:function(){if(UI.isMobile.any()){$("#startContinueLast").show();$("#startOpen").hide()}else{$("#startContinueLast").hide();$("#startOpen").show()}this.drawProjects()},initEvents:function(){var i=this;$("#startOpen").on("click",function(){g_app.fileManager.openLocalFile()});$("#start2D").on("click",function(){var e=g_app.getNewProjectDialog();e.show();if(UI.isMobile.any()){}});$("#start-continue-last").on("click",function(){var e={};e.fileId=i.continueLastFileId;g_app.fileManager.loadAutosave()});$("#loadRepository").on("click",function(){g_app.github.showLoadFromRepositoryDialog()});$("#start-login-mobile").on("click",function(){i.login()});$("#start-logout-mobile").on("click",function(){i.logout()});$("#login-button").on("click",function(){var e=function(){};var t=[];i.login(e,t)});$("#logout-button").on("click",function(){i.logout()});$("#testsave").on("click",function(){g_app.github.load()});$("#startImportImage").on("click",function(){var e={};g_app.newProject(e,function(){g_app.setMode("2d");g_app.textModeEditor.importImage.start()})});$("#startMusic").on("click",function(){var e={};g_app.newProject(e);g_app.setMode("music")});$("#connectToGDriveButton").on("click",function(){i.connectToGDrive()});$("#connectToGDriveButtonMobile").on("click",function(){i.connectToGDrive()});$("#disconnectFromGDriveButton").on("click",function(){i.disconnectFromGDrive()});$("#disconnectFromGDriveButtonMobile").on("click",function(){i.disconnectFromGDrive()});$("#projectMenuBacking").on("click",function(){i.hideProjectMenu();i.hideRepositoryMenu()});$(".projectMenuItem").on("click",function(){var e=$(this).attr("data-action");i.hideProjectMenu();switch(e){case"open":i.projectOpen({projectId:i.currentProjectId});break;case"delete":i.deleteProject();break;case"rename":i.showRenameProject();break;case"download":i.downloadProject();break}});$(".repositoryMenuItem").on("click",function(){var e=$(this).attr("data-action");i.hideRepositoryMenu();switch(e){case"opennocheck":i.projectOpen({projectId:i.currentProjectId,githubCheck:false});break;case"remove":i.removeRepository();break;case"viewongithub":i.viewOnGitHub();break}});$(".gdriveMenuItem").on("click",function(){var e=$(this).attr("data-action");i.hideGDriveMenu();switch(e){case"viewInGDrive":i.viewInGDrive();break;case"download":i.gDriveDownload();break;case"delete":i.gDriveDelete();break}});if(document.getElementById("startPageProjectHolderMobile")){document.getElementById("startPageProjectHolderMobile").addEventListener("dragover",function(e){e.preventDefault()});document.getElementById("startPageProjectHolderMobile").addEventListener("dragleave",function(e){e.preventDefault()});document.getElementById("startPageProjectHolderMobile").addEventListener("drop",function(e){e.preventDefault();var t;if(e.dataTransfer){var t=e.dataTransfer.files;if(t.length>0){g_app.fileManager.openFile(t[0])}}})}if(document.getElementById("startPageProjectHolder")){document.addEventListener("dragover",function(e){i.showDragBorder();e.preventDefault()});document.addEventListener("dragleave",function(e){i.hideDragBorder();e.preventDefault()});document.addEventListener("drop",function(e){e.preventDefault();i.hideDragBorder();var t;if(e.dataTransfer){var t=e.dataTransfer.files;if(t.length>0){g_app.fileManager.openFile(t[0])}}})}$("#startPageProjectHolder").on("contextmenu",function(e){e.preventDefault()});$("#startPageBanner *").on("contextmenu",function(e){e.preventDefault()})},viewInGDrive:function(){var e=this.currentGDriveId;for(var t=0;t<this.googleDriveProjectList.length;t++){if(this.googleDriveProjectList[t].id==e){window.open(this.googleDriveProjectList[t].webViewLink);return}}},gDriveDownload:function(){var e=this.currentGDriveId;for(var t=0;t<this.googleDriveProjectList.length;t++){if(this.googleDriveProjectList[t].id==e){window.open(this.googleDriveProjectList[t].webContentLink);return}}},gDriveDelete:function(){var e=this.currentGDriveId;for(var t=0;t<this.googleDriveProjectList.length;t++){if(this.googleDriveProjectList[t].id==e){return}}},login:function(e,t){if(UI.isMobile.any()){g_app.confirmLeave=false;g_app.githubClient.loginWithRedirect(e,t)}else{g_app.githubClient.login(e,t)}},logout:function(){g_app.githubClient.logout()},hideProjectMenu:function(){$("#projectMenuBacking").fadeOut({duration:200});$("#projectMenu").fadeOut({duration:200})},hideRepositoryMenu:function(){$("#projectMenuBacking").fadeOut({duration:200});$("#repositoryMenu").fadeOut({duration:200})},hideGDriveMenu:function(){$("#projectMenuBacking").fadeOut({duration:200});$("#gdriveMenu").fadeOut({duration:200})},connectToGDrive:function(){g_app.gdrive.handleAuthClick()},disconnectFromGDrive:function(){g_app.gdrive.handleSignoutClick()},deleteProject:function(){var e=this;if(confirm("Are you sure you want to delete?")){g_app.fileManager.deleteBrowserStorageProject({projectId:this.currentProjectId},function(){e.drawBrowserStorage()})}},viewOnGitHub:function(){var e="https://github.com/"+this.currentOwner+"/"+this.currentRepository;window.open(e)},removeRepository:function(){var e=this;if(confirm("Are you sure you want to remove this repository?\nThe repository will be removed from this page, but not deleted from GitHub.")){g_app.removeRepository(this.currentOwner,this.currentRepository,function(){g_app.fileManager.deleteBrowserStorageProject({projectId:e.currentProjectId},function(){g_app.getRepositoryList();e.drawBrowserStorage()})})}},downloadProject:function(){var e="project";for(var t=0;t<this.localProjectList.length;t++){if(this.localProjectList[t].id==this.currentProjectId){e=this.localProjectList[t].name;break}}g_app.fileManager.downloadProject({filename:e,projectId:this.currentProjectId})},showRepositoryMenu:function(e,t,i,r){var a=e.pageX;var s=e.pageY;this.currentOwner=t;this.currentRepository=i;this.currentProjectId=r;$("#projectMenuBacking").show();$("#repositoryMenu").show();$("#repositoryMenu").css("top",s+"px");$("#repositoryMenu").css("left",a+"px")},showGDriveMenu:function(e,t,i){var r=e.pageX;var a=e.pageY;this.currentGDriveName=t;this.currentGDriveId=i;$("#projectMenuBacking").show();$("#gdriveMenu").show();$("#gdriveMenu").css("top",a+"px");$("#gdriveMenu").css("left",r+"px")},showProjectMenu:function(e,t){var i=e.pageX;var r=e.pageY;this.currentProjectId=t;$("#projectMenuBacking").show();$("#projectMenu").show();$("#projectMenu").css("top",r+"px");$("#projectMenu").css("left",i+"px")},projectOpen:function(e){var t=e.projectId;var i="";var r=false;var a=false;var s=false;var o=false;var l=false;for(var n=0;n<this.localProjectList.length;n++){if(this.localProjectList[n].id==t){if(typeof this.localProjectList[n].name!="undefined"){i=this.localProjectList[n].name}if(typeof this.localProjectList[n].currentPath!="undefined"){r=this.localProjectList[n].currentPath}if(typeof this.localProjectList[n].projectNavVisible!="undefined"){a=this.localProjectList[n].projectNavVisible}if(typeof this.localProjectList[n].githubOwner!="undefined"){s=this.localProjectList[n].githubOwner}if(typeof this.localProjectList[n].githubRepository!="undefined"){o=this.localProjectList[n].githubRepository;l=true}}}if(typeof e.githubCheck!="undefined"){l=e.githubCheck}g_app.openProject({projectId:t,projectName:i,currentPath:r,projectNavVisible:a,githubOwner:s,githubRepository:o,githubCheck:l})},projectOpenOld:function(e){var t=e.fileId;g_app.fileManager.loadBrowserStorageProject(t)},templateOpen:function(e){var t=e.fileId;g_app.fileManager.loadBrowserStorageTemplate(t)},projectDelete:function(e){var t=e.fileId;var i=this;g_app.fileManager.deleteBrowserStorageProject(t,function(){i.drawBrowserStorage()})},updateRepositories:function(e){this.githubProjectList=g_app.repositories;this.drawProjects()}};var GitHubUI=function(){this.uiComponent=null;this.githubClient=null;this.loginPromptDialog=null;this.repositoryDetailsDialog=null;this.loadingRepositoryDialog=null;this.pullDialog=null;this.loadFromRepositoryDialog=null;this.owner=false;this.repository="";this.commitOnly=false;this.saveProgressBar=null;this.loadProgressBar=null;this.dialogAction="save";this.initialCommitMessage="Initial Commit";this.pullFinishedCallback=null};GitHubUI.prototype={init:function(e){this.githubClient=e},save:function(){this.dialogAction="save";if(!this.githubClient.isLoggedIn()){var e=this;this.promptToLogin(function(){UI.closeDialog();e.promptRepositoryDetails()})}else{this.promptRepositoryDetails()}},showPullDialog:function(){if(!this.pullDialog){var e=300;var t=220;if(g_app.isMobile()){t=260}this.pullProgressBar=UI.create("UI.ProgressBar");var i=this.pullProgressBar.getHTML();this.pullDialog=UI.create("UI.Dialog",{id:"githubPullDialog",title:"Pull Files",width:e,height:t});var r="";r+='<div id="pullDialogProgress" style="margin-top: 2px"></div>';r+='<div id="pullProgressBar" style="display: none; margin-top: 6px">';r+=i;r+="</div>";r+='<div id="pullDialogUpdatedFiles" style="display: none; position: absolute; top: 20px; left: 6px; right: 6px; line-height: 14px; letter-spacing: 0.2px; bottom: 30px; padding: 4px; margin: 8px 0; overflow: auto; background-color: #333333"></div>';r+='<div id="githubPullUpdatedHolder" style="position: absolute; display: none; left: 6px; bottom: 0px; right: 6px; height: 30px">';r+='<div class="ui-button ui-button-primary" id="githubPullUpdatedFiles" style="margin-right: 10px">Pull Updated Files From Origin</div>';r+='<div class="ui-button ui-button-secondary" id="githubOpenNoPull">Open Without Pull</div>';r+="</div>";var a=UI.create("UI.HTMLPanel",{html:r});this.pullDialog.add(a);this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.pullDialog.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});var s=this;$("#githubOpenNoPull").on("click",function(){if(s.pullFinishedCallback){s.pullFinishedCallback();s.pullFinishedCallback=null}UI.closeDialog()});$("#githubPullUpdatedFiles").on("click",function(){$("#githubPullUpdatedHolder").hide();s.doPull(function(e){if(s.pullFinishedCallback){s.pullFinishedCallback();s.pullFinishedCallback=null}UI.closeDialog()})})}$("#pullDialogProgress").html("");UI.showDialog("githubPullDialog")},doCheckForUpdatedFiles:function(o){this.showPullDialog();var e={owner:this.owner,repository:this.repository,listFilesOnly:true};$("#pullDialogProgress").html("Checking for updated files in repository....");var i="";e.progress=function(e){var t=e.message;i+="<div>"+t+"</div>";$("#pullDialogProgress").html(i)};var l=this;this.githubClient.pull(e,function(e){var t=e.filesToPull;var i=t.length;if(t.length>0){var r="Found "+i+" updated file";if(i!=1){r+="s"}$("#pullDialogProgress").html(r);var a="";for(var s=0;s<t.length;s++){a+='<div class="">'+t[s]+"</div>"}$("#pullDialogUpdatedFiles").html(a);$("#pullDialogUpdatedFiles").show();$("#githubPullUpdatedHolder").show();l.pullFinishedCallback=o}else{console.log("NO FILES TO PULL, call the callback");UI.closeDialog();g_app.projectNavigator.updateModifiedList();g_app.projectNavigator.treeRoot.refreshChildren();if(typeof o!="undefined"){o(e)}o(e)}})},doPull:function(t){var r=this;this.showPullDialog();var e={owner:this.owner,repository:this.repository};this.pullProgressBar.setProgress(0);$("#pullDialogUpdatedFiles").hide();$("#pullProgressBar").show();var i="";e.progress=function(e){var t=e.message;var i=e.progress;$("#pullDialogProgress").html(t);r.pullProgressBar.setProgress(e.progress)};this.githubClient.pull(e,function(e){UI.closeDialog();g_app.projectNavigator.updateModifiedList();g_app.projectNavigator.treeRoot.refreshChildren();if(typeof t!="undefined"){t(e)}})},shareProject:function(){this.dialogAction="share";this.promptRepositoryDetails()},promptToLogin:function(e){if(!this.loginPromptDialog){var t=200;var i=220;if(g_app.isMobile()){i=260}this.loginPromptDialog=UI.create("UI.Dialog",{id:"githubLoginPrompt",title:"Login Required",width:t,height:i});var r="<div>You need to login to commit to GitHub</div>";r+='<div class="ui-button" id="loginToGitHubButton">Login To GitHub</div>';this.loginHTML=UI.create("UI.HTMLPanel",{html:r});this.loginPromptDialog.add(this.loginHTML);this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.closeButton.on("click",function(e){UI.closeDialog()});this.loginPromptDialog.addButton(this.closeButton);var a=this;$("#loginToGitHubButton").on("click",function(){a.githubClient.login(function(){if(e){e()}})})}UI.showDialog("githubLoginPrompt")},initRepositoryDetailsEvents:function(){var t=this;$("input[name=githubRepositoryAction]").on("click",function(e){var t=$("input[name=githubRepositoryAction]:checked").val();if(t=="create"){$("#repositoryName").show();$("#repositoryName").focus();$("#githubRepositoryTypeRow").show()}else{$("#githubRepositoryTypeRow").hide()}});$("#githubRepositoryCommitOnlyChange").on("click",function(){t.setCommitOnly(false)});$("#loginRegisterGitHub").on("click",function(){t.githubClient.login(function(){t.userHasLoggedIn()})});$("#githubShareLinkCopy").on("click",function(){$("#githubShareLink").select();document.execCommand("copy")});$("#repositoryShareCreateButton").on("click",function(){t.createShareRepository()});$("#githubShareInitialView").on("change",function(){t.updateShareLink()});$("#githubShareLinkCurrentRepositoryCommit").on("click",function(){t.commitToShare()});$("#githubShareLinkCurrentRepositoryNew").on("click",function(){t.newShareRepository()});$("#githubRepositoryCommitOnlyMessage").on("keypress",function(e){if(e.keyCode==13){t.doCommit()}})},createShareRepository:function(){this.doCommit()},newShareRepository:function(){$("#githubShareLinkSectionRepositoryExists").hide();$("#repositoryOwner").val(this.owner);$("#githubShareLinkSection").hide();$("#repositoryName").select();$("#repositoryName").focus();this.setCommitOnly(false)},commitToShare:function(){$("#githubShareLinkSectionRepositoryExists").hide();$("#githubRepositoryProgress").show();$("#githubRepositoryError").hide();var t={};t.owner=this.owner;t.repository=this.repository;t.repositoryId=this.owner+"/"+this.repository;var i=this;this.recordRepository(t,function(e){i.saveToRepository(t)})},setCommitOnly:function(e){this.commitOnly=e;if(this.commitOnly){$("#githubRepositoryForm").hide();$("#githubRepositoryCommitOnly").show();var t=this.owner+"/"+this.repository;$("#githubRepositoryCommitOnlyDetails").html(t);if($("#repositoryCommitMessage").val()==this.initialCommitMessage){$("#repositoryCommitMessage").val("A Commit")}$("#githubRepositoryCommitOnlyMessage").select();$("#githubRepositoryCommitOnlyMessage").focus()}else{$("#githubRepositoryForm").show();$("#githubRepositoryCommitOnly").hide();$("#repositoryName").select();$("#repositoryName").focus()}},updateViewSelect:function(){var e=g_app.doc.dir("/");var t="";var i=false;for(var r=0;r<e.length;r++){if(e[r].type!=="hiddenfile"&&e[r].name!="3d"){var a="";var s=e[r].children;for(var o=0;o<s.length;o++){if(s[o].type!=="folder"&&s[o].type!=="hiddenfile"){var l=e[r].name+"/"+s[o].name;a+='<option value="'+l+'"';if(!i){if(s[o].type=="graphic"){a+=' selected="selected" ';i=true}}a+=">"+s[o].name+"</option>"}}if(a!=""){t+='<optgroup label="'+e[r].name+'">';t+=a;t+="</optgroup>"}}}$("#githubShareInitialView").html(t)},showShareLink:function(){this.updateViewSelect();$(".githubRepositoryDialogSection").hide();$("#githubRepositoryMessage").hide();$("#githubRepositoryProgress").hide();$("#githubRepositoryError").hide();$("#githubShareLinkSection").show();this.updateShareLink()},updateShareLink:function(){var e="https://lvllvl.com/?gh="+this.owner+"/"+this.repository;var t=$("#githubShareInitialView").val();if(t){e+="&view="+t}$("#githubShareLink").val(e)},initRepositoryDetailsContent:function(){if(this.owner===false){this.owner=this.githubClient.getLoginName()}$(".githubRepositoryDialogSection").hide();var e=false;if(this.dialogAction=="share"){if(this.repoOkButton){this.repoOkButton.setVisible(false)}$("#githubRepositoryFormCreateOptions").hide();$("#githubCommitMessageRow").hide();if(typeof this.repositoryDetails!="undefined"&&this.repositoryDetails){e=true;if(this.repositoryDetails.private===false){this.showShareLink();var t="";t+='<a href="'+this.repositoryDetails.html_url+'" target="_blank">';t+=this.repositoryDetails.full_name;t+="</a>";$("#githubShareLinkCurrentRepository").html(t);$("#githubShareLinkSectionRepositoryCreated").hide();$("#githubShareLinkSectionRepositoryExists").show()}else{$("#githubShareInstructions").show();$("#githubShareLinkSectionRepositoryExists").hide()}}else{$("#githubShareInstructions").show()}}else{$("#githubRepositoryFormCreateOptions").show();$("#githubCommitMessageRow").show()}if(this.dialogAction!="share"||!e){$("#githubRepositoryForm").show();$("#githubRepositoryMessage").html("");$("#githubRepositoryMessage").hide();$("#repositoryOwner").val(this.owner);if(this.repository!==false){$("#repositoryName").val(this.repository)}else{var i="repository-name";i=g_app.fileManager.getProjectName();$("#repositoryName").val(i);$("#repositoryCommitMessage").val(this.initialCommitMessage)}if(this.repository===false||this.repository===""){$("#githubRepositoryAction_save").prop("checked",false);$("#githubRepositoryAction_create").prop("checked",true);this.setCommitOnly(false)}else{this.setCommitOnly(true);$("#githubRepositoryAction_save").prop("checked",true);$("#githubRepositoryAction_create").prop("checked",false)}}if(this.dialogAction=="share"){$("#githubRepositoryTypeRow").hide()}else{if($("#githubRepositoryAction_create").is(":checked")){$("#githubRepositoryTypeRow").show()}else{$("#githubRepositoryTypeRow").hide()}}if(this.repoOkButton){this.repoOkButton.setEnabled(true)}if(this.repoCloseButton){this.repoCloseButton.setEnabled(true)}if(this.saveProgressBar==null){this.saveProgressBar=UI.create("UI.ProgressBar");var t=this.saveProgressBar.getHTML();$("#githubRepositoryProgress").html(t)}$("#githubRepositoryProgress").hide();$("#githubRepositoryError").hide();this.saveProgressBar.setProgress(0)},userHasLoggedIn:function(){this.repositoryDetails=false;if(this.dialogAction=="share"){if(this.repository!=""&&this.repository!=false){var t=this;this.githubClient.getRepoDetails({owner:this.owner,repository:this.repository},function(e){t.repositoryDetails=e.data;t.initRepositoryDetailsContent()});return}}this.initRepositoryDetailsContent()},initCommitRepositoryDetails:function(){$(".githubRepositoryDialogSection").hide();if(!this.githubClient.isLoggedIn()){$("#githubRepositoryLogin").show()}else{this.userHasLoggedIn()}if(this.dialogAction=="share"){$("#repositoryShareCreateButtonHolder").show();if(this.repoOkButton){this.repoOkButton.setVisible(false)}}else{$("#repositoryShareCreateButtonHolder").hide();if(this.repoOkButton){this.repoOkButton.setVisible(true)}}},loadRepository:function(e){var t=e.address;var i=false;if(typeof e.view!=="undefined"){i=e.view}var r=false;if(typeof e.callback!=="undefined"){r=e.callback}var a=t.indexOf("github.com");if(a!=-1){t=t.substr(a+11)}if(t.length==0){return}if(t[0]=="/"){t=t.substr(1)}var a=t.indexOf(".git");if(a!==-1){t=t.substr(0,a)}var a=t.indexOf("/");if(a==-1){return}var s=t.substr(0,a);var o=t.substr(a+1);var a=o.indexOf("/");if(a!=-1){o=o.substr(0,a)}s=s.replace(/\//g,"");o=o.replace(/\//g,"");this.openRepository({owner:s,repository:o,requireLogin:false,view:i},function(e){if(e.success){UI.closeDialog();if(r!==false){r()}}else{var t='<div class="alert">';var i=s+"/"+o;t+='<img src="icons/svg/glyphicons-basic-638-triangle-alert.svg" height="16" style="vertical-align: top"/>';t+='<div style="display: inline-block; width: calc(100% - 40px)"><strong>Could not open repository \''+i+"'</strong>";t+="<div>You may need to login to access this repository</div>";t+="</div>";t+="</div>";$("#loadFromGithubRepositoryAlert").html(t);$("#loadingRepositoryAlert").html(t)}})},showLoadFromRepositoryDialog:function(){var i=this;if(!this.loadFromRepositoryDialog){var e=360;var t=280;if(g_app.isMobile()){t=340}var r="";r+='<div id="loadFromGithubRepository" class="panelFill dialogContent">';r+='<div id="loadFromGithubRepositoryAlert" style="margin-bottom: 10px"></div>';r+='<div class="formGroup">';r+='<label class="controlLabel" for="repositoryAddress" style="margin-bottom: 10px">GitHub Repository:</label> ';r+='<input class="formControl" type="text" size="20" value="" id="repositoryAddress"/>';r+="</div>";r+="</div>";this.loadFromRepositoryDialog=UI.create("UI.Dialog",{id:"loadFromGithubRepository",title:"Load From GitHub Repository",width:e,height:t});this.loadRepositoryHTML=UI.create("UI.HTMLPanel",{html:r});this.loadFromRepositoryDialog.add(this.loadRepositoryHTML);var i=this;var a=UI.create("UI.Button",{text:"Load",color:"primary"});a.on("click",function(e){var t=$("#repositoryAddress").val();i.loadRepository({address:t})});this.loadFromRepositoryDialog.addButton(a);var s=UI.create("UI.Button",{text:"Close",color:"secondary"});s.on("click",function(e){UI.closeDialog()});this.loadFromRepositoryDialog.addButton(s);this.loadFromRepositoryDialog.on("close",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)})}g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true);$("#loadFromGithubRepositoryAlert").html("");UI.showDialog("loadFromGithubRepository")},promptRepositoryDetails:function(){var t=this;g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true);if(!this.repositoryDetailsDialog){var e=420;var i=320;if(g_app.isMobile()){i=340}this.repositoryDetailsDialog=UI.create("UI.Dialog",{id:"githubRepositoryDetails",title:"GitHub Repository Repository Details",width:e,height:i});this.repositoryDetailsHTML=UI.create("UI.HTMLPanel");this.repositoryDetailsDialog.add(this.repositoryDetailsHTML);this.repositoryDetailsHTML.load("html/githubRepositoryDetails.html",function(){t.initCommitRepositoryDetails();t.initRepositoryDetailsEvents()});this.repoOkButton=UI.create("UI.Button",{text:"Commit",color:"primary"});this.repoOkButton.on("click",function(e){t.doCommit()});this.repositoryDetailsDialog.addButton(this.repoOkButton);this.repoCloseButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.repoCloseButton.on("click",function(e){UI.closeDialog()});this.repositoryDetailsDialog.addButton(this.repoCloseButton);this.repositoryDetailsDialog.on("close",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});UI.showDialog("githubRepositoryDetails");$("#repositoryName").show()}else{UI.showDialog("githubRepositoryDetails");$("#repositoryName").show();this.initCommitRepositoryDetails()}},doCommit:function(){var r=this;var a={};a.owner=$("#repositoryOwner").val().trim();a.repository=$("#repositoryName").val().trim().replace(/ /g,"-");this.repoOkButton.setEnabled(false);this.repoCloseButton.setEnabled(false);var e=a.owner+"/"+a.repository;$("#githubRepositoryCommitOnly").hide();$("#githubRepositoryForm").hide();$("#githubRepositoryCommitOnly").hide();$("#githubRepositoryMessage").html("Commit to repository: '"+e+"'...");$("#githubRepositoryMessage").show();$("#githubRepositoryProgress").show();$("#githubRepositoryError").hide();if(this.dialogAction=="share"){a.action="create";a.repositoryType="public";a.commitOnly="Initial Commit"}else{a.action=$("input[name=githubRepositoryAction]:checked").val();a.repositoryType=$("input[name=githubRepositoryType]:checked").val();a.commitMessage=$("#repositoryCommitMessage").val()}if(a.owner==""){alert("Please enter a value for the repository owner");return}if(a.repository==""){alert("Please enter a name for the repository");return}$("#githubShareInstructions").hide();if(a.action=="create"){this.githubClient.requestScope("repo",function(){r.createRepository(a)})}else{if(!this.commitOnly){}this.githubClient.requestScope("repo",function(){r.githubClient.getRepoDetails(a,function(e){if(e.status==200){a.repositoryId=e.data.id;r.recordRepository(a,function(e){r.repositorySaveLocalVersion(a,function(){r.saveToRepository(a)})})}else if(e.status==404){var t=a.owner+"/"+a.repository;var i='<div class="alert">';i+='<img src="icons/svg/glyphicons-basic-638-triangle-alert.svg" height="16" style="vertical-align: top"/>';i+='<div style="display: inline-block; width: calc(100% - 40px)"><strong>Repository not found \''+t+"'</strong></div>";i+="</div>";$("#githubRepositoryMessage").html(i);$("#githubRepositoryMessage").show();if(r.commitOnly){$("#githubRepositoryCommitOnly").show()}else{$("#githubRepositoryForm").show()}$("#githubRepositoryProgress").hide();$("#githubRepositoryError").hide();r.repoOkButton.setEnabled(true);r.repoCloseButton.setEnabled(true)}})})}},repositorySaveLocalVersion:function(e,o){var t="browserStorage";var l=g_app.fileManager.getProjectName();if(g_app.fileManager.getIsNew()){l=e.repository}g_app.fileManager.getProjectList({type:"project",thumbnails:false},function(e){var t=e.projects;if(g_app.fileManager.getIsNew()){var i=true;var r=l;var a=0;while(i){i=false;for(var s=0;s<t.length;s++){if(t[s].type=="project"&&t[s].name==r){i=true;a++;r=l+"-"+a;break}}}l=r}g_app.doc.saveToBrowserStorage({filename:l},function(){g_app.fileManager.setIsNew(false);g_app.fileManager.setProjectName(l);if(typeof o!="undefined"){o()}})})},createRepository:function(l){this.repoOkButton.setEnabled(false);this.repoCloseButton.setEnabled(false);var n=l.owner+"/"+l.repository;$("#githubRepositoryForm").hide();$("#githubRepositoryCommitOnly").hide();$("#githubRepositoryMessage").html("Creating repository: '"+n+"'...");$("#githubRepositoryMessage").show();$("#githubRepositoryProgress").show();var h=this;this.repositorySaveLocalVersion(l,function(){h.githubClient.setRepositoryFolder("");h.githubClient.createRepo(l,function(e){var t=e.status;var i=e.statusText;if(t==500){var r='<div class="alert">';r+='<img src="icons/svg/glyphicons-basic-638-triangle-alert.svg" height="16" style="vertical-align: top"/>';r+='<div style="display: inline-block; width: calc(100% - 40px)"><strong>Could not create repository \''+n+"', does it already exist?</strong></div>";r+="</div>";$("#githubRepositoryMessage").html(r);if(h.commitOnly){$("#githubRepositoryCommitOnly").show()}else{$("#githubRepositoryForm").show()}$("#githubRepositoryProgress").hide();$("#githubRepositoryError").hide();h.repoOkButton.setEnabled(true);h.repoCloseButton.setEnabled(true)}else{var a=e.data;var s=a.name;var o=a.id;n=a.full_name;l.repositoryId=a.id;console.log("RECORD REPOSITORY IN FIRESTORE!!!!!!!!!!!!!!!!!!!");h.recordRepository(l,function(e){console.log("SAVE PROJECT REPOSITORY DETAUILSSSS!!!!!!!!!!!!!!!!!!!");g_app.fileManager.saveProjectRepositoryDetails({owner:l.owner,repository:l.repository},function(){h.saveToRepository(l)})})}})})},recordRepository:function(e,t){var i=e.owner+"-"+e.repository;var r=i;var a=firebase.auth().currentUser;var s=new Date;var o=s.getTime();firestoreDb.collection("users/"+a.uid+"/repositories").doc(r).set({owner:e.owner,repository:e.repository,repositoryId:e.repositoryId,lastModified:o},{merge:true}).then(function(e){if(t){t(e)}}).catch(function(e){console.log("could not record repository");console.log(e)})},saveToRepository:function(e){var i=this;this.repoOkButton.setEnabled(false);this.repoCloseButton.setEnabled(false);var t=e.owner+"/"+e.repository;$("#githubRepositoryForm").hide();$("#githubRepositoryCommitOnly").hide();$("#githubRepositoryMessage").html("Commit to repository: '"+t+"'...");$("#githubRepositoryMessage").show();$("#githubRepositoryProgress").show();$("#githubRepositoryError").hide();this.setRepositoryDetails(e.owner,e.repository);e.progress=function(e){i.saveProgressBar.setProgress(e.progress)};this.githubClient.save(e,function(e){g_app.projectNavigator.updateModifiedList();if(typeof e.error!="undefined"&&e.error===true){console.log("ERROR"+e.message);var t="<div>";t+="<p>Sorry an error was encountered:</p>";t+="<p>"+e.message+"</p>";t+="</div>";$("#githubRepositoryError").html(t);$("#githubRepositoryError").show();i.repoCloseButton.setEnabled(true);return}i.repoOkButton.setEnabled(true);i.repoCloseButton.setEnabled(true);if(i.dialogAction=="share"){$("#githubShareLinkSectionRepositoryCreated").hide();i.showShareLink()}else{UI.closeDialog()}})},showLoadingDialog:function(){if(this.loadingRepositoryDialog==null){var e=400;var t=200;var i=UI.getScreenWidth();if(i-40<e){e=i-40}this.loadingRepositoryDialog=UI.create("UI.Dialog",{id:"loadingRepositoryDialog",title:"Loading...",width:e,height:t,showCloseButton:false});var r='<h2 id="loadingRepositoryDialogHeading">Loading...</h2>';r+='<div id="loadingRepositoryAlert" style="margin-bottom: 10px"></div>';r+='<div id="loadingRepositoryDialogProgress" style="margin-bottom: 4px">&nbsp;</div>';this.loadProgressBar=UI.create("UI.ProgressBar");r+=this.loadProgressBar.getHTML();this.loadingRepositoryDialogHTML=UI.create("UI.HTMLPanel",{html:r});this.loadingRepositoryDialog.add(this.loadingRepositoryDialogHTML)}UI.showDialog("loadingRepositoryDialog")},setRepositoryDetails:function(e,t){this.owner=e;this.repository=t;g_app.projectNavigator.setGithubRepositoryDetails(e,t);if(e!=false&&t!=false){UI("file-commit").setVisible(false);UI("project-commitchanges").setVisible(true)}else{UI("file-commit").setVisible(true);UI("project-commitchanges").setVisible(false)}},openRepository:function(a,s){console.log("OPEN REPOSITORY!");var e=a.owner;var o=a.repository;var l=false;var n=true;if(typeof a.view!=="undefined"){l=a.view}if(typeof a.createLocalProject!="undefined"){n=a.createLocalProject}var h=this;this.showLoadingDialog();this.loadProgressBar.setProgress(0);$("#loadingRepositoryDialogHeading").html("Loading "+o+"...");$("#loadingRepositoryDialogProgress").html("Loading file list...");a.progress=function(e){$("#loadingRepositoryDialogProgress").html(e.message);h.loadProgressBar.setProgress(e.progress)};this.githubClient.load(a,function(e){if(e.success===false){s(e)}else{UI.closeDialog();h.setRepositoryDetails(a.owner,a.repository);if(n){console.log("CREATE LOCAL PROJECT!!!!!!!!!");g_app.fileManager.getUniqueProjectName(o,function(e){var t=g_app.fileManager;var i={filename:e,owner:a.owner,repository:a.repository};console.log("CREATE LOCAL PROJECT WITH NAME "+e);g_app.doc.saveToBrowserStorage(i,function(){})})}g_app.projectNavigator.refreshTree();if(l===false){var t=g_app.doc.dir("/screens");if(t&&t.length>0){var i=t[0].name;if(l===false){l="/screens/"+i}l=l.trim();if(l.length>0&&l[0]!="/"){l="/"+l}var r=g_app.doc.getDocRecord(l);if(!r){l=false}}}if(l!=false){g_app.projectNavigator.showDocRecord(l)}else{g_app.setMode("none")}if(typeof s!="undefined"){s({success:true})}}})},getCurrentRepository:function(){return{owner:this.owner,repository:this.repository}}};var g_gistPathSeparator=" ~~ ";var GistUI=function(){this.uiComponent=null};GistUI.prototype={init:function(e){this.githubClient=e},loadFromGist:function(e){var t=e.gist;g_app.githubClient.getGist({id:t},function(e){var t=e.data.files;var i=false;var r=false;g_app.doc=new Document;g_app.doc.init(g_app);g_app.createDocumentStructure(g_app.doc);var a=false;var s=false;var o=false;var l=g_gistPathSeparator;if(typeof t["settings"]!="undefined"){try{var o=JSON.parse(t[h].content);if(typeof o["separator"]!="undefined"){l=o["separator"]}}catch(e){}}var n=false;for(var h in t){if(h.indexOf(l)!=-1){n=true;break}}if(!n){l=" - "}for(var h in t){var d=t[h].filename;var c=t[h].content;d=d.split(l).join("/");var f="";var u=d.lastIndexOf(".");if(u!=-1){f=d.substr(u+1);f=f.toLowerCase().trim()}if(f=="prg"){i="c64";var c=t[h].content;c=base64ToBuffer(c);g_app.setMode("c64");var p={fullscreen:"yes",joystick:"port2"};s={filename:t[h].filename,prg:c,options:p}}if(f=="crt"){i="c64";var c=t[h].content;c=base64ToBuffer(c);g_app.setMode("c64");s={filename:t[h].filename,crt:c}}if(f=="bas"){if(d.indexOf("/")==-1){var c=t[h].content;var v="/scripts/"+h;var g=g_app.doc.getDocRecord(v);if(g==null){var m=g_app.doc.getDocRecord("/scripts");if(m){g_app.doc.createDocRecord("/scripts",h,"script","");g=g_app.doc.getDocRecord(v)}}if(g!=null){if(g.data==""){g.data=c}}}}if(f=="js"){if(d=="c64.js"){var c=t[h].content;var v="/scripts/"+h;var g=g_app.doc.getDocRecord(v);if(g==null){var m=g_app.doc.getDocRecord("/scripts");if(m){g_app.doc.createDocRecord("/scripts",h,"script","");g=g_app.doc.getDocRecord(v)}}if(g!=null){if(g.data==""){g.data=c}}}}if(f=="d64"){console.log("loading a d64!!!");i="c64";var c=t[h].content;c=base64ToBuffer(c);g_app.setMode("c64");s={filename:t[h].filename,d64:c}}if(d=="c64snapshot"){var c=base64ToBuffer(t[h].content);s={filename:"snapshot",snapshot:c}}if(d=="c64settings"){try{i="c64";a=JSON.parse(t[h].content)}catch(e){}}if(f=="asm"){if(i===false){i="assembler"}}if(d.length>0&&d.indexOf("/")!==-1){if(d[0]!="/"){d="/"+d}console.log("set doc record: "+d);g_app.doc.addRecord({path:d,content:c,sha:false});if(r===false||d=="/asm/main.asm"){r=d;console.log("set doc record to open = "+r)}if(d.indexOf("/screens/")==0||d.indexOf("/3d scenes/")==0||d.indexOf("/sprites/")==0||d.indexOf("/music/")==0){r=d;var y=r.lastIndexOf(".json");if(y!=-1){r=r.substr(0,y)}}}}if(i=="c64"){g_app.setMode("c64");g_app.projectNavigator.refreshTree();g_c64Settings=a;if(s){g_app.c64Debugger.setContentToStart(s)}g_app.c64Debugger.setupContent();return}console.log("opening: "+r);g_app.doc.openDoc({view:r})})},startShare:function(e){var t={};var i=g_app.projectNavigator.getCurrentPath();if(!i){return}var r=g_app.doc.getDocRecord(i);console.log(r);var a=r.type;if(a=="music"){var s=i;if(s.length>0&&s[0]=="/"){s=s.substr(1)}if(s.indexOf(".json")==-1){s+=".json"}s=s.replace(/\//g,g_gistPathSeparator);t[s]={content:JSON.stringify(r.data)}}if(a=="graphic"||a=="3d scene"){var s=i;if(s.length>0&&s[0]=="/"){s=s.substr(1)}if(s.indexOf(".json")==-1){s+=".json"}s=s.replace(/\//g,g_gistPathSeparator);t[s]={content:JSON.stringify(r.data)};var o=g_app.projectNavigator.getCurrentEditor();if(o&&typeof o.getThumbnailCanvas!=="undefined"){thumbnailCanvas=o.getThumbnailCanvas();if(thumbnailCanvas){thumbnailData=thumbnailCanvas.toDataURL("image/png");console.log("thumbnail Data:");console.log(thumbnailData);t["thumbnail.png"]={content:thumbnailData}}}var l=r.data.layers;for(var n=0;n<l.length;n++){var h=l[n].colorPaletteId;var d=g_app.textModeEditor.colorPaletteManager.getColorPalette(h);if(d){var c=d.getJSON();var f=d.getName();var s="color palettes"+g_gistPathSeparator+f;t[s]={content:JSON.stringify(c)}}var u=l[n].tileSetId;var p=g_app.textModeEditor.tileSetManager.getTileSet(u);if(p){var v=p.getJSON();var f=p.getName();var s="tile sets"+g_gistPathSeparator+f;t[s]={content:JSON.stringify(v)}}}}var g={version:1,separator:g_gistPathSeparator};t["settings"]={content:JSON.stringify(g)};this.share({files:t})},showDialog:function(){if(this.uiComponent==null){var e=500;var t=200;this.uiComponent=UI.create("UI.Dialog",{id:"gistShareDialog",title:"Share",width:e,height:t});var i="";i+='<div id="githubGistLogin" class="gistDialogSection" style="display: none">';i+="  <h2>Sign in to GitHub to Share Project</h2>";i+="  <div>";i+="    <p>Files are shared by creating a ";i+='    <a href="https://docs.github.com/en/free-pro-team@latest/github/writing-on-github/editing-and-sharing-content-with-gists" target="_blank">GitHub secret Gist</a>';i+="    .</p>";i+="    <p>To share your content, you will need to login to GitHub.</p>";i+="  </div>";i+='  <div class="ui-button ui-button-info" id="gistLoginRegisterGitHub" style="padding: 4px; height: auto; line-height: 20px">';i+='    <img style="margin-right: 6px; margin-top: -4px" src="icons/GitHub-Mark-32px.png">';i+="    GitHub Login / Register";i+="  </div>";i+="</div>";i+='<div id="githubGistAddScope" class="gistDialogSection" style="display: none">';i+="  <h2>Require Permission to create Gists</h2>";i+="  <div>";i+="    <p>Files are shared by creating a ";i+='    <a href="https://docs.github.com/en/free-pro-team@latest/github/writing-on-github/editing-and-sharing-content-with-gists" target="_blank">GitHub secret Gist</a>';i+="    .</p>";i+="    <p>To share a your project, you will need to allow lvllvl to create Gists.</p>";i+="  </div>";i+='  <div class="ui-button ui-button-info" id="gistAddScope" style="padding: 4px; height: auto; line-height: 20px">';i+='    <img style="margin-right: 6px; margin-top: -4px" src="icons/GitHub-Mark-32px.png">';i+="    Allow Gist Access";i+="  </div>";i+="</div>";i+='<div id="githubGistShare" class="gistDialogSection" style="display: none">';i+="  <h2>Share</h2>";i+="  <div>";i+="    <p>Files are shared by creating a ";i+='    <a href="https://docs.github.com/en/free-pro-team@latest/github/writing-on-github/editing-and-sharing-content-with-gists" target="_blank">GitHub secret Gist</a>';i+="    .</p>";i+="    <p>Click the 'Share' button to create a Gist and a link to the files.</p>";i+="  </div>";i+='  <div class="ui-button ui-button-info" id="gistShareGitHub" style="padding: 4px; height: auto; line-height: 20px">';i+='    <img style="margin-right: 6px; margin-top: -4px" src="icons/GitHub-Mark-32px.png">';i+="    Share";i+="  </div>";i+="</div>";i+='<div id="githubGistShareProgress" class="gistDialogSection" style="display: none">';i+="  uploading...";i+="</div>";i+='<div id="githubGistLink" class="gistDialogSection" style="display: none">';i+="  <h2>Share Link</h2>";i+="  <div>";i+="    <p>A secret Gist has been created on GitHub.</p>";i+="    <p>You can use the link below to share your content.</p>";i+="  </div>";i+='<input type="text" size="40" id="gistShareLink">';i+='<div class="ui-button ui-button-primary" id="gistShareLinkCopy"><img src="icons/svg/glyphicons-basic-614-copy.svg">&nbsp;Copy To Clipboard</div>';i+="</div>";var r=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.add(r);this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});var a=this;UI.on("ready",function(){$("#gistLoginRegisterGitHub").on("click",function(){a.githubClient.login(function(){a.userHasLoggedIn()},["gist"])});$("#gistAddScope").on("click",function(){var e=a.githubClient.getScopes();e.push("gist");a.githubClient.login(function(){a.userHasLoggedIn()},e)});$("#gistShareGitHub").on("click",function(){a.doShare()});$("#gistShareLinkCopy").on("click",function(){a.copyShareLink()})});this.uiComponent.on("close",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)})}UI.showDialog("gistShareDialog");g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)},share:function(e){this.files=[];this.shareData=false;this.shareFilename=false;if(typeof e.data!="undefined"){this.shareData=e.data;this.shareFilename=e.filename}if(typeof e.files!="undefined"){this.files=e.files}this.showDialog();$(".gistDialogSection").hide();if(!this.githubClient.isLoggedIn()){$("#githubGistLogin").show()}else if(!this.githubClient.hasScope("gist")){$("#githubGistAddScope").show()}else{this.userHasLoggedIn()}},userHasLoggedIn:function(){$(".gistDialogSection").hide();$("#githubGistShare").show()},doShare:function(){var i=this;$(".gistDialogSection").hide();$("#githubGistShareProgress").show();g_app.githubClient.createGist({files:i.files},function(e){console.log(e);var t=e.data.id;i.showLink({id:t})})},showLink:function(e){var t="https://lvllvl.com/?gid="+e.id;$(".gistDialogSection").hide();$("#githubGistLink").show();$("#gistShareLink").val(t)},copyShareLink:function(){$("#gistShareLink").focus();$("#gistShareLink").select();document.execCommand("copy")}};var CreateTemplateLink=function(){this.uiComponent=null;this.charsetId="petscii";this.colorPaletteId="c64_colodore"};CreateTemplateLink.prototype={init:function(){},show:function(e){this.charsetId="petscii";this.colorPaletteId="c64_colodore";console.log(e);if(typeof e!="undefined"){if(typeof e.charsetId!="undefined"){this.charsetId=e.charsetId}if(typeof e.colorPaletteId!="undefined"){this.colorPaletteId=e.colorPaletteId}}var t=this;if(this.uiComponent==null){var i=400;var r=330;this.uiComponent=UI.create("UI.Dialog",{id:"createTemplateLinkDialog",title:"Create Template Link",width:i,height:r});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/project/createTemplateLink.html",function(){t.initEvents();t.initContent()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.addButton(this.closeButton);this.uiComponent.on("close",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)})}else{this.initContent()}g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true);UI.showDialog("createTemplateLinkDialog")},initEvents:function(){var t=this;$("#templateLinkTileSetList").on("change",function(){t.generateLink()});$("#templateLinkColorPaletteList").on("change",function(){t.generateLink()});$("#templateLinkScreenMode").on("change",function(){t.generateLink()});$("#templateLinkCanFlipTiles").on("click",function(){t.generateLink()});$("#templateLinkCanRotateTiles").on("click",function(){t.generateLink()});$("#templateLinkCopy").on("click",function(){t.copyLink()});$("#templateLinkEditorList").on("change",function(){var e=$(this).val();t.setEditor(e);t.generateLink()})},initContent:function(){this.initCharsets();this.initColorPalettes();this.generateLink()},initCharsets:function(){var e="";var t=this;for(var i in CharacterSetPresets){if(CharacterSetPresets.hasOwnProperty(i)){var r=CharacterSetPresets[i].category;e+='<optgroup label="'+r+'">';for(var a=0;a<CharacterSetPresets[i].characterSets.length;a++){var s=CharacterSetPresets[i].characterSets[a].name;var o=CharacterSetPresets[i].characterSets[a].id;e+='<option value="'+o+'"';if(o==this.charsetId){e+=' selected="selected" '}e+=">";e+=s;e+="</option>";if(typeof CharacterSetPresets[i].characterSets[a].options!="undefined"){for(var l=0;l<CharacterSetPresets[i].characterSets[a].options.length;l++){var s=CharacterSetPresets[i].characterSets[a].options[l].name;var o=CharacterSetPresets[i].characterSets[a].options[l].id;e+='<option value="'+o+'"';if(o==this.charsetId){e+=' selected="selected" '}e+=">&nbsp;&nbsp;&nbsp;&nbsp;";e+=s;e+="</option>"}}}e+="</optgroup>"}}$("#templateLinkTileSetList").html(e)},initColorPalettes:function(){var e="";for(var t in ColorPalettePresets){if(ColorPalettePresets.hasOwnProperty(t)){var i=ColorPalettePresets[t].category;e+='<optgroup label="'+i+'">';for(var r=0;r<ColorPalettePresets[t].colorPalettes.length;r++){var a=ColorPalettePresets[t].colorPalettes[r].name;var s=ColorPalettePresets[t].colorPalettes[r].id;e+='<option value="'+s+'" ';if(s==this.colorPaletteId){e+=' selected="selected" '}e+=">"+a+"</option>"}e+="</optgroup>"}}$("#templateLinkColorPaletteList").html(e)},setEditor:function(e){this.editor=e;switch(this.editor){case"screen":break;case"sprite":break;case"music":break;case"assembly":break;case"color":break;case"c64":break}},generateLink:function(){console.log("GENERATE LINK");var e=$("#templateLinkEditorList").val();var t=$("#templateLinkTileSetList").val();var i=$("#templateLinkColorPaletteList").val();var r=parseInt($("#templateLinkWidth").val(),10);var a=parseInt($("#templateLinkHeight").val(),10);var s=$("#templateLinkScreenMode").val();var o=$("#templateLinkCanFlipTiles").is(":checked");var l=$("#templateLinkCanRotateTiles").is(":checked");var n="https://lvllvl.com/?";n+="editor="+e;n+="&tileset="+t;n+="&palette="+i;n+="&width="+r;n+="&height="+a;n+="&mode="+s;if(o){n+="&tileflip=1"}if(l){n+="&tilerotate=1"}$("#templateLink").val(n)},copyLink:function(){var e=document.getElementById("templateLink");e.select();e.setSelectionRange(0,99999);document.execCommand("copy")}};var DropImage=function(){this.editor=null;this.uiComponent=null};DropImage.prototype={init:function(e){this.editor=e},buildInterface:function(){var e=220;var t=186;this.uiComponent=UI.create("UI.Dialog",{id:"dropImage",title:"Image",width:e,height:t});var i="";i+="<div>";i+='<label class="rb-container">Import/Convert Image';i+='<input type="radio" name="dropImageAction" id="dropImageAction_import" value="import" checked="checked">';i+='<span class="checkmark"></span>';i+="</label>";i+="</div>";i+="<div>";i+='<label class="rb-container">Set as layer background';i+='<input type="radio" name="dropImageAction" id="dropImageAction_background" value="background">';i+='<span class="checkmark"></span>';i+="</label>";i+="</div>";i+="<div>";i+='<label class="rb-container">Import as a Tile Set';i+='<input type="radio" name="dropImageAction" id="dropImageAction_charset" value="charset">';i+='<span class="checkmark"></span>';i+="</label>";i+="</div>";i+="<div>";i+='<label class="rb-container">Import as a Colour Palette';i+='<input type="radio" name="dropImageAction" id="dropImageAction_colorpalette" value="colorpalette">';i+='<span class="checkmark"></span>';i+="</label>";i+="</div>";this.newHTML=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.add(this.newHTML);var r=this;this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.okButton.on("click",function(e){UI.closeDialog();r.doAction()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.addButton(this.okButton);this.uiComponent.addButton(this.closeButton)},processAction:function(e){var t=this;if(e=="import"){g_app.textModeEditor.importImage.start({dialogReadyCallback:function(){g_app.textModeEditor.importImage.setImportImage(t.file)}})}if(e=="background"){g_app.textModeEditor.showReferenceImageDialog({dialogReadyCallback:function(){g_app.textModeEditor.referenceImageDialog.chooseImage(t.file)}})}if(e=="charset"){g_app.textModeEditor.tileSetManager.showImport({dialogReadyCallback:function(){g_app.textModeEditor.tileSetManager.tileSetChoosePreset.tileSetImport.chooseTileSetFile(t.file)}})}if(e=="colorpalette"){g_app.textModeEditor.colorPaletteManager.showLoad({dialogReadyCallback:function(){g_app.textModeEditor.colorPaletteManager.colorPaletteChoosePreset.dropFile(t.file)}})}},doAction:function(){var e=$("input[name=dropImageAction]:checked").val();var t=this;if(g_app.doc==null){var i={};i.mode="monochrome";i.width=40;i.height=25;g_app.newProject(i,function(){t.processAction(e)})}else{this.processAction(e)}},start:function(e){console.log("DROP IMAGE!!!");this.file=e;if(this.uiComponent==null){this.buildInterface()}if(g_app.doc!==null){if(g_app.textModeEditor.importImage.visible){this.doAction("import");return}if(g_app.textModeEditor.colorPaletteEdit&&g_app.textModeEditor.colorPaletteEdit.visible){g_app.textModeEditor.colorPaletteEdit.dropFile(e);return}}if(g_app.textModeEditor.colorPaletteManager.colorPaletteChoosePreset&&g_app.textModeEditor.colorPaletteManager.colorPaletteChoosePreset.visible){g_app.textModeEditor.colorPaletteManager.colorPaletteChoosePreset.dropFile(e);return}if(g_app.textModeEditor.tileSetManager.tileSetChoosePreset&&g_app.textModeEditor.tileSetManager.tileSetChoosePreset.visible){g_app.textModeEditor.tileSetManager.tileSetChoosePreset.dropFile(e);return}UI.closeAllDialogs();UI.showDialog("dropImage")}};var Scripting=function(){this.codeEditor=null;this.visible=false;this.interpreter=null;this.isRunning=false;this.isProcessingEvents=false;this.pendingEvents=[];this.apiInitFunctions=[];this.errorHandler=null;this.doc=null;this.currentOutputLineId=0;this.outputElementId="scriptingOutputPanel";this.preScripts={};this.eventHandlers={}};Scripting.prototype={init:function(e){if(typeof e!="undefined"){if(typeof e.outputElementId!="undefined"){this.outputElementId=e.outputElementId}this.parentPanel=e.parentPanel}},setOutputElementId:function(e){this.outputElementId=e},on:function(e,t){this.eventHandlers[e]=t},buildInterface:function(){this.uiComponent=UI.create("UI.SplitPanel",{id:"scriptingSplitPanel"});this.parentPanel.add(this.uiComponent);var e=UI.create("UI.Panel");this.uiComponent.add(e);this.codeEditor=new CodeEditor;this.codeEditor.init("javascript");this.codeEditor.buildInterface(e);this.codeEditor.on("change",function(e){n.codeEditorChange()});var t='<div class="title" style="background-color: #111111; height: 28px">';t+='<div style="position: absolute; top: 6px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap">';t+="  Scripting";t+="</div>";t+='<div style="position: absolute; top: 2px; right: 2px; width: 20px">';t+='<div id="scriptingClose" class="ui-button ui-dialog-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>';t+="</div>";t+="</div>";var i=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.addNorth(i,28,false);var r=UI.create("UI.SplitPanel");this.uiComponent.addSouth(r,180);var a='<div class="panelFill"  id="scriptingRunControls">';a+='<div id="scriptingRunButton" class="ui-button ui-button-primary"><i class="halflings halflings-play"></i> Run</div>';a+="&nbsp;&nbsp;";a+='<div id="scriptingStopButton" class="ui-button">Stop</div>';a+="</div>";var s=UI.create("UI.HTMLPanel",{html:a});r.addNorth(s,40,false);var o='<div class="panelFill" id="'+this.outputElementId+'">';o+="</div>";var l=UI.create("UI.HTMLPanel",{html:o});r.add(l);var n=this;UI.on("ready",function(){n.initEvents()})},initEvents:function(){var r=this;$("#scriptingRunButton").on("click",function(){var e=r.codeEditor.getValue();r.runScript(e)});$("#scriptingTickButton").on("click",function(){r.doTick()});$("#scriptingStopButton").on("click",function(){r.stopScript()});$("#scriptingClose").on("click",function(){r.toggleVisible()});$("#scriptingOutputPanel").on("click",".scriptingOutputLine",function(){var e=$(this).attr("data-id");var t=$(this).attr("type");var i=$(this).attr("data-line");$(".scriptingOutputLine").css("background-color","transparent");$(".scriptingOutputLine").css("color","#eeeeee");$(this).css("background-color","#4586dd");$(this).css("color","#ffffff");if(typeof i!="undefined"){i=parseInt(i,10);if(!isNaN(i)){r.codeEditor.gotoLine(i,0,false)}}})},codeEditorChange:function(){if(this.doc!=null){this.doc.data=this.codeEditor.getValue()}},toggleVisible:function(){this.visible=!this.visible;UI("mainSplitPanel").setPanelVisible("west",this.visible);if(this.visible){if(!this.uiComponent){this.buildInterface()}this.load("/scripts/screen.js")}},load:function(e,t){if(typeof t=="undefined"&&e==this.path){return}this.currentFile=null;this.path=e;var i=g_app.doc.getDocRecord(e);if(i!=null){this.codeEditor.setValue(i.data);this.doc=i;if(typeof t!="undefined"){this.codeEditor.gotoLine(t)}}},logError:function(e){},initInterpreter:function(){},registerAPI:function(e){this.apiInitFunctions.push(e)},initAPI:function(i,e){var r=this;var t=i.createObjectProto(i.OBJECT_PROTO);i.setProperty(e,"System",t);var a=function(){return i.nativeToPseudo(r.pendingEvents)};i.setProperty(t,"getPendingEvents",i.createNativeFunction(a,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var s=function(){r.isProcessingEvents=false;r.pendingEvents=[]};i.setProperty(t,"eventsProcessed",i.createNativeFunction(s,false),Interpreter.NONENUMERABLE_DESCRIPTOR);GraphicAPI.initAPI(i,e);var o=i.createObjectProto(i.OBJECT_PROTO);i.setProperty(e,"console",o);var a=function(e){var t=i.pseudoToNative(e);if(typeof t!=="string"&&!(t instanceof String)){t=JSON.stringify(t)}r.addOutputLine({message:t})};i.setProperty(o,"log",i.createNativeFunction(a,false),Interpreter.NONENUMERABLE_DESCRIPTOR);for(var l=0;l<this.apiInitFunctions.length;l++){this.apiInitFunctions[l](i,e)}},parseBabelError:function(e){var t={};var i=e.toString().split("\n");if(i.length==0){return}var r=false;var a=i[0];var s=a.lastIndexOf("(");if(s!=-1){s++;var o=a.substring(s);a=a.substring(0,s-1);var l=o.lastIndexOf(")");if(l!==-1){o=o.substring(0,l)}var n=o.indexOf(":");if(n!=-1){o=o.substring(0,n)}r=parseInt(o,10);if(isNaN(r)){r=false}}t.lineNumber=r;t.message=a;return t},setPrescript:function(e,t){this.preScripts[e]=t},editorPreScript:function(){var e="";var t=";";e+="var Editor = {};"+t;e+="Editor.eventHandlers = {};"+t;e+="Editor.hasEventHandlers = false;"+t;e+="Editor.on = function(eventType, callback) {"+t;e+='  if(eventType === "run") { '+t;e+="    Editor.eventHandlers[eventType] = callback;"+t;e+="  } else {"+t;e+="    Editor.hasEventHandlers = true;"+t;e+="    Editor.eventHandlers[eventType] = callback;"+t;e+="  }";e+="}"+t;e+=GraphicAPI.getPreScript();for(var i in this.preScripts){e+=this.preScripts[i]}return e},editorPostScript:function(){var e="";var t=";";e+="if(Editor.hasEventHandlers) {"+t;e+="  while(1) {"+t;e+="    var _systemEvents = System.getPendingEvents();"+t;e+="    if(_systemEvents.length > 0) {"+t;e+="      for(var _systemEventIndex = 0; _systemEventIndex < _systemEvents.length; _systemEventIndex++) {"+t;e+="        if(Editor.eventHandlers.hasOwnProperty(_systemEvents[_systemEventIndex])) {"+t;e+="          Editor.eventHandlers[_systemEvents[_systemEventIndex]]();"+t;e+="        }"+t;e+="      }"+t;e+="    }"+t;e+="    System.eventsProcessed();"+t;e+="  }"+t;e+="}"+t;return e},clearOutputLines:function(){$("#"+this.outputElementId).html("")},addOutputLine:function(e){var t=e.message;var i="info";var r=false;if(typeof e.lineNumber!="undefined"){r=e.lineNumber}if(typeof e.type!="undefined"){i=e.type}this.currentOutputLineId++;var a="";a+='<div class="scriptingOutputLine" id="scriptingOutputLine'+this.currentOutputLineId+'" data-id="'+this.currentOutputLineId+'" data-type="'+i+'"';if(r!==false){a+=' data-line="'+r+'"'}a+=">";if(i=="error"){a+='<div class="assemblerOutputErrorIcon"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>'}if(r!==false){a+=r+": "}a+=t;a+="</div>";console.log("output element id = "+this.outputElementId);$("#"+this.outputElementId).append(a);var s=document.getElementById("scriptingOutputLine"+this.currentOutputLineId);s.scrollIntoView(false)},showErrors:function(){var e="";for(var t=0;t<this.errors.length;t++){var i=this.errors[t].lineNumber-this.preScriptLineCount;this.addOutputLine({message:this.errors[t].message,lineNumber:i,type:"error"})}},lineCount:function(e){return e.split("\n").length},runScripts:function(e,t){this.errorHandler=null;if(typeof t!="undefined"){if(typeof t.errorHandler!="undefined"){this.errorHandler=t.errorHandler}}if(e.length==0){return}this.scriptMap=[];this.errors=[];var i="";var r="";var a=0;var s=0;r=this.editorPreScript()+"\n";s=this.lineCount(r);this.preScriptLineCount=0;i+=r;this.scriptMap.push({from:a,to:a+s,filePath:"prescript"});a+=s;for(var o=0;o<e.length;o++){r=e[o].content;s=this.lineCount(r);this.scriptMap.push({from:a,to:a+s,filePath:e[o].filePath});a+=s;i+=r}r=this.editorPostScript()+"\n";s=this.lineCount(r);i+=r;this.scriptMap.push({from:a,to:a+s,filePath:"postscript"});a+=s;var l=null;try{l=Babel.transform(i,{presets:["es2015"],retainLines:true})}catch(e){var n=this.parseBabelError(e);this.mapError(n);this.errors.push(n);console.log("ERROR!!!");console.log(n);if(this.errorHandler!==null){this.errorHandler(n)}else{this.showErrors()}return}var h=l.code;this.run(h,t)},mapError:function(e){var t=e.lineNumber;var i=false;for(var r=0;r<this.scriptMap.length;r++){if(t>=this.scriptMap[r].from&&t<this.scriptMap[r].to){e.filePath=this.scriptMap[r].filePath;e.lineNumber=t-this.scriptMap[r].from+1;return}}},runScript:function(e,t){this.errorHandler=null;if(typeof t!="undefined"){if(typeof t.errorHandler!="undefined"){this.errorHandler=t.errorHandler}}if(e==""){return}var i=this.editorPreScript();var r=i.split("\n");this.preScriptLineCount=r.length;e=this.editorPreScript()+"\n"+e+"\n"+this.editorPostScript();try{e=Babel.transform(e,{presets:["es2015"],retainLines:true})}catch(e){this.errors=[];var a=this.parseBabelError(e);this.errors.push(a);if(this.errorHandler!==null){this.errorHandler(a)}else{this.showErrors()}return}var s=e.code;this.run(s,t)},run:function(e){var i=this;this.interpreter=new Interpreter(e,function(e,t){i.initAPI(e,t)});this.startedRunning();this.isProcessingEvents=true;this.code=e;this.processScriptEvents()},doTick:function(){if(this.isRunning){this.pendingEvents=[];this.pendingEvents.push("tick");this.isProcessingEvents=true;this.processScriptEvents()}},triggerEvent:function(e){if(this.isRunning){if(typeof e==="string"||e instanceof String){this.pendingEvents.push(e);this.isProcessingEvents=true;this.processScriptEvents()}}},processScriptEvents:function(){var t=false;var e=false;try{var i=0;GraphicAPI.frameStart();while(i<1e6&&this.isRunning&&this.isProcessingEvents){if(!this.interpreter.step()){break}var r=this.interpreter.stateStack[this.interpreter.stateStack.length-1];t=r.node.start;e=r.node.end}GraphicAPI.frameDone()}catch(e){this.finishedRunning();this.isProcessingEvents=false;var a=1;if(t===false){}else{for(var s=0;s<t;s++){if(this.code[s]=="\n"){a++}}if(this.errorHandler!==null){var o={lineNumber:a,message:e.message};this.errorHandler(o)}else{var o={type:"error",lineNumber:a,message:e.message};this.mapError(o);this.addOutputLine(o)}}}},stopScript:function(){this.finishedRunning()},getIsRunning:function(){return this.isRunning},startedRunning:function(){this.clearOutputLines();this.isRunning=true;if(typeof this.eventHandlers["start"]!="undefined"){this.eventHandlers["start"]()}},finishedRunning:function(){this.isRunning=false;if(typeof this.eventHandlers["end"]!="undefined"){console.log("call callback handler");this.eventHandlers["end"]()}}};var ScriptEditor=function(){this.doc=null;this.uiComponent=null;this.codeEditor=null};ScriptEditor.prototype={modified:function(){if(g_app.openingProject){return}g_app.doc.recordModified(this.doc,this.path)},init:function(e){this.parentPanel=e.parentPanel},buildInterface:function(){if(this.uiComponent!=null){return}this.uiComponent=UI.create("UI.Panel",{id:"scriptEditor"});this.parentPanel.add(this.uiComponent);var e=UI.create("UI.Panel");this.uiComponent.add(e);this.codeEditor=new CodeEditor;this.codeEditor.init("javascript");this.codeEditor.buildInterface(e);this.codeEditor.on("change",function(e){t.codeEditorChange()});var t=this;UI.on("ready",function(){t.initEvents()})},show:function(){console.log("show script editor");if(!this.uiComponent){this.buildInterface()}},initEvents:function(){},codeEditorChange:function(){if(this.doc!=null){this.modified();this.doc.data=this.codeEditor.getValue()}},saveSettings:function(e){e[this.path]={scrollTop:this.codeEditor.getScrollTop(),editSession:this.codeEditor.getEditSession()}},load:function(e,t){if(typeof t=="undefined"&&e==this.path){return}var i=g_app.doc.getDocRecord(e);if(i!=null){this.doc=i;this.path=e;if(typeof settings!="undefined"&&typeof settings[e]!="undefined"){this.codeEditor.setEditSession(settings[e].editSession)}else{this.codeEditor.setEditSession(ace.createEditSession(i.data,"ace/mode/json"))}if(typeof t!="undefined"){this.codeEditor.gotoLine(t)}}}};var ShaderEffects=function(){this.width=320;this.height=200;this.renderer=null;this.camera=null;this.renderTarget=null;this.renderTargetPixels=null;this.plane=null;this.planeGeometry=null;this.texture=null;this.material=null;this.srcCanvas=null;this.textureWidth=1024;this.textureHeight=1024;this.textureCanvas=null;this.effect=null;this.dstImageData=null;this.shaderEffectControls=null;this.paramChangedCallback=false};ShaderEffects.prototype={init:function(){this.renderer=new THREE.WebGLRenderer;this.renderer.autoClear=false;this.renderer.setSize(this.width,this.height);this.camera=new THREE.OrthographicCamera(this.width/-2,this.width/2,this.height/2,this.height/-2,1,1e3);this.camera.position.z=5;this.scene=new THREE.Scene;this.textureCanvas=document.createElement("canvas");this.shaderEffectControls=new ShaderEffectControls;this.shaderEffectControls.init();var i=this;this.shaderEffectControls.on("paramchanged",function(e,t){if(i.effect){i.effect.setParamValue(e,t)}if(i.paramChangedCallback){i.paramChangedCallback(e,t)}})},on:function(e,t){if(e=="paramchanged"){this.paramChangedCallback=t}},setControlsParentId:function(e){this.shaderEffectControls.setParentElementId(e)},setSize:function(e,t){this.width=e;this.height=t;this.camera.left=-this.width/2;this.camera.right=this.width/2;this.camera.top=this.height/2;this.camera.bottom=-this.height/2;this.camera.updateProjectionMatrix();this.renderer.setSize(this.width,this.height);if(!this.renderTarget){this.renderTarget=new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat});this.renderTargetPixels=new Uint8Array(this.width*this.height*4)}if(this.renderTarget.width!=this.width||this.renderTarget.height!=this.height){this.renderTarget.setSize(this.width,this.height);this.renderTargetPixels=new Uint8Array(this.width*this.height*4)}if(this.width>this.textureWidth||this.height>this.textureHeight){if(this.width<2048&&this.height<2048){this.textureWidth=2048;this.textureHeight=2048}else if(this.width<4096&&this.height<4096){this.textureWidth=4096;this.textureHeight=4096}else if(this.width<8192&&this.height<8192){this.textureWidth=8192;this.textureHeight=8192}}if(this.textureCanvas.width!=this.textureWidth||this.textureCanvas.height!=this.textureHeight){this.textureCanvas.width=this.textureWidth;this.textureCanvas.height=this.textureHeight;this.textureContext=this.textureCanvas.getContext("2d");if(this.plane){this.scene.remove(this.plane)}if(this.texture){this.texture.dispose()}if(this.material){this.material.dispose()}this.planeGeometry=new THREE.PlaneGeometry(this.textureWidth,this.textureHeight,5);this.texture=new THREE.Texture(this.textureCanvas);this.material=new THREE.MeshBasicMaterial({color:16777215,map:this.texture,side:THREE.DoubleSide});this.plane=new THREE.Mesh(this.planeGeometry,this.material);this.scene.add(this.plane)}this.plane.position.x=(this.textureWidth-this.width)/2;this.plane.position.y=-(this.textureHeight-this.height)/2;this.setupComposer()},setEffect:function(e){this.effect=e;this.shaderEffectControls.setParams(this.effect.getParams());this.setupComposer()},setupComposer:function(){if(!this.effect||!this.srcCanvas){return}this.composer=new THREE.EffectComposer(this.renderer,this.renderTarget);this.composer.setSize(this.width,this.height);this.composer.addPass(new THREE.RenderPass(this.scene,this.camera));this.effect.setupComposer(this.composer,this.width,this.height);effectCopy=new THREE.ShaderPass(THREE.CopyShader);this.composer.addPass(effectCopy)},setInput:function(e){this.srcCanvas=e;if(e.width!=this.width||e.height!=this.height){this.setSize(e.width,e.height)}},setOutput:function(e){this.dstCanvas=e;this.dstContext=this.dstCanvas.getContext("2d");if(!this.dstImageData||this.dstImageData.width!=e.width||this.dstImageData.height!=e.height){this.dstImageData=this.dstContext.getImageData(0,0,this.dstCanvas.width,this.dstCanvas.height)}},applyEffects:function(){if(this.effect==null){this.dstContext.putImageData(this.srcCanvas,0,0);return}if(this.textureContext==null){return}this.textureContext.clearRect(0,0,this.textureCanvas.width,this.textureCanvas.height);this.textureContext.drawImage(this.srcCanvas,0,0);this.material.map.needsUpdate=true;this.renderer.clear();this.composer.render();this.renderer.readRenderTargetPixels(this.renderTarget,0,0,this.width,this.height,this.renderTargetPixels);for(var e=0;e<this.dstImageData.height;e++){for(var t=0;t<this.dstImageData.width;t++){var i=4*(e*this.dstImageData.width+t);var r=4*((this.dstImageData.height-1-e)*this.dstImageData.width+t);this.dstImageData.data[r]=this.renderTargetPixels[i];this.dstImageData.data[r+1]=this.renderTargetPixels[i+1];this.dstImageData.data[r+2]=this.renderTargetPixels[i+2];this.dstImageData.data[r+3]=this.renderTargetPixels[i+3]}}this.dstContext.clearRect(0,0,this.dstCanvas.width,this.dstCanvas.height);this.dstContext.putImageData(this.dstImageData,0,0)}};var ShaderEffectControls=function(){this.parentElementId=null;this.paramChanged=false;this.params=[]};ShaderEffectControls.prototype={init:function(){},setParentElementId:function(e){this.parentElementId=e;this.initEvents()},on:function(e,t){if(e=="paramchanged"){this.paramChanged=t}},initEvents:function(){var s=this;$("#"+this.parentElementId).on("change",".effectParamSlider",function(){var e=$(this).val();var t=$(this).attr("data-id");var i=$(this).attr("data-name");$("#"+t+"_text").val(e);var r=$(this).attr("data-effect-index");var a=$(this).attr("data-effect-param");s.updateEffectParam(r,i,e)});$("#"+this.parentElementId).on("input",".effectParamSlider",function(){var e=$(this).val();var t=$(this).attr("data-id");var i=$(this).attr("data-name");$("#"+t+"_text").val(e);var r=$(this).attr("data-effect-index");var a=$(this).attr("data-effect-param");s.updateEffectParam(r,i,e)});$("#"+this.parentElementId).on("keyup",".effectParamText",function(){var e=$(this).val();var t=$(this).attr("data-id");var i=$(this).attr("data-name");$("#"+t+"_slider").val(e);var r=$(this).attr("data-effect-index");var a=$(this).attr("data-effect-param");s.updateEffectParam(r,i,e)});$("#"+this.parentElementId).on("click",".effectParamReset",function(){var e=$(this).attr("data-effect-index");var t=$(this).attr("data-effect-param");var i=$(this).attr("data-name");var r=s.effectDefaultValue(e);var a=$(this).attr("data-id");if($("#"+a+"_slider").length>0){$("#"+a+"_slider").val(r)}if($("#"+a+"_text").length>0){$("#"+a+"_text").val(r)}s.updateEffectParam(e,i,r)});$("#"+this.parentElementId).on("click",".effectParamOption",function(){var e=$(this).attr("data-effect-index");var t=$(this).attr("name");var i=$(this).val();var r=$(this).attr("data-name");s.updateEffectParam(e,r,i)})},setParams:function(e){this.params=e;var t="";for(var i=0;i<e.length;i++){var r=e[i];t+="<div>";t+='<div class="shaderEffectParamName">'+r.name+"</div>";switch(r.type){case"range":t+=this.getRangeControlHTML(r,i);break;case"options":t+=this.getOptionsControlHTML(r,i);break}t+="</div>"}if(this.parentElementId){$("#"+this.parentElementId).html(t)}},updateEffectParam:function(e,t,i){if(this.paramChanged!==false){this.paramChanged(t,i)}},effectDefaultValue:function(e,t){return this.params[e]["default"]},getId:function(e){return e.trim().toLowerCase().replace(/ /g,"_")},getRangeControlHTML:function(e,t){var i="";var r=e.min;var a=e.max;var s=this.getId(e.name);var o=s;var l=e.value;i+='<div class="rangeControl">';i+='<input type="number" style="width: 30px" "min="'+r+'" max="'+a+'" value="'+l+'" size="2"  class="effectParamText number" id="'+s+'_text"  data-effect-index="'+t+'" data-effect-param="'+o+'" data-name="'+e.name+'" data-id="'+s+'"/>';i+='<input style="flex: 1 1; margin: 0 2px" type="range"  min="'+r+'" max="'+a+'" value="'+l+'" size="3" class="effectParamSlider" id="'+s+'_slider" data-effect-index="'+t+'" data-effect-param="'+o+'" data-name="'+e.name+'" data-id="'+s+'"/>';i+='<div type="button" id="'+s+'_reset" class="ui-button effectParamReset" data-effect-index="'+t+'" data-effect-param="'+o+'" data-name="'+e.name+'" data-id="'+s+'">Reset</div>';i+="</div>";return i},getOptionsControlHTML:function(e,t){var i="";var r=this.getId(e.name);for(var a=0;a<e.options.length;a++){var s=e.options[a];i+='<label class="rb-container" style="margin-right: 8px">'+s;i+='<input type="radio" name="'+r+'"  class="effectParamOption" data-name="'+e.name+'" data-effect-index="'+t+'" value="'+s+'"';if(s==e.value){i+=' checked="checked" '}i+='><span class="checkmark"></span></label>'}return i}};var LotteCRTEffect=function(){this.params=[{name:"Blur",min:0,max:100,type:"range",value:30,default:30},{name:"Saturation",min:0,max:100,type:"range",value:50,default:50},{name:"Curve",options:["On","Off"],type:"options",value:"On",default:"On"},{name:"Scanline Intensity",min:0,max:100,type:"range",value:63,default:63},{name:"Mask Type",options:["None","Lite","Normal"],type:"options",value:"Normal",default:"Normal"},{name:"Vertical Line Intensity",min:0,max:100,type:"range",value:25,default:25},{name:"Glow",min:0,max:100,type:"range",value:40,default:40},{name:"VignetteOffset",min:0,max:100,type:"range",value:50,default:50},{name:"VignetteDarkness",min:0,max:100,type:"range",value:64,default:64}];this.curve=1;this.contrast=1;this.saturation=0;this.blurValue=.3;this.glowValue=40/50;this.scanlineIntensity=.63;this.maskType=0;this.verticalLineIntensity=1-.25;this.vignetteOffset=50/50;this.vignetteDarkness=64/50};LotteCRTEffect.prototype={getName:function(){return"CRT (Lotte)"},getParams:function(){return this.params},setParamValue:function(e,t){switch(e){case"Blur":this.blurValue=t/100;this.blurPass.uniforms["amount"].value=this.blurValue;break;case"Saturation":this.contrast=t/50;if(this.contrast==0){this.contrast=.5/50}this.crtPass.uniforms["contrast"].value=this.contrast;break;case"Scanline Intensity":this.scanlineIntensity=t/100;this.crtPass.uniforms["INPUT_THIN"].value=this.scanlineIntensity;break;case"Mask Type":this.maskType=2;if(t=="Lite"){this.maskType=1}if(t=="Normal"){this.maskType=0}this.crtPass.uniforms["masktype"].value=this.maskType;break;case"Vertical Line Intensity":this.verticalLineIntensity=t/100;this.crtPass.uniforms["INPUT_MASK"].value=1-this.verticalLineIntensity;break;case"Curve":this.curve=t=="On"?1:0;this.crtPass.uniforms["warpscreen"].value=this.curve;break;case"Glow":this.glowValue=t/50;this.bloomPass.copyUniforms["opacity"].value=this.glowValue;break;case"VignetteOffset":this.vignetteOffset=t/50;this.vignettePass.uniforms["offset"].value=this.vignetteOffset;break;case"VignetteDarkness":this.vignetteDarkness=t/50;this.vignettePass.uniforms["darkness"].value=this.vignetteDarkness;break}},setupComposer:function(e,t,i){this.blurPass=new THREE.ShaderPass(BlurShader);this.blurPass.uniforms["resolution"].value=new THREE.Vector2(t,i);this.blurPass.uniforms["amount"].value=this.blurValue;e.addPass(this.blurPass);this.crtPass=new THREE.ShaderPass(LotteCRTShader);e.addPass(this.crtPass);this.crtPass.uniforms["resolution"].value=new THREE.Vector2(t,i);this.crtPass.uniforms["INPUT_X"].value=t/3;this.crtPass.uniforms["INPUT_Y"].value=i/3;this.crtPass.uniforms["INPUT_THIN"].value=this.scanlineIntensity;this.crtPass.uniforms["INPUT_MASK"].value=this.verticalLineIntensity;this.crtPass.uniforms["masktype"].value=this.maskType;this.crtPass.uniforms["contrast"].value=this.contrast;this.crtPass.uniforms["warpscreen"].value=this.curve;this.bloomPass=new THREE.BloomPass;this.bloomPass.copyUniforms["opacity"].value=this.glowValue;e.addPass(this.bloomPass);this.vignettePass=new THREE.ShaderPass(VignetteShader);this.vignettePass.uniforms["offset"].value=this.vignetteOffset;this.vignettePass.uniforms["darkness"].value=this.vignetteDarkness;e.addPass(this.vignettePass)}};var MattiasCRTEffect=function(){this.params=[{name:"Blur",min:0,max:100,type:"range",value:30,default:30},{name:"Curve",options:["On","Off"],type:"options",value:"On",default:"On"},{name:"Frame",options:["On","Off"],type:"options",value:"On",default:"On"},{name:"Pixel Shape",options:["Square","Tall"],type:"options",value:"Tall",default:"Tall"},{name:"Colour Bleed",min:0,max:100,type:"range",value:12,default:12},{name:"Ghosting",min:0,max:100,type:"range",value:25,default:25},{name:"Scanline Intensity",min:0,max:100,type:"range",value:90,default:90},{name:"Vertical Line Intensity",min:0,max:100,type:"range",value:100,default:100},{name:"Glow",min:0,max:100,type:"range",value:30,default:30}];this.pixelRatio=1;this.curve=1;this.frame=1;this.blurValue=.3;this.ghosting=1;this.colorBleed=.25;this.scanlineIntensity=.9;this.verticalLineIntensity=1;this.glowValue=.3};MattiasCRTEffect.prototype={getName:function(){return"CRT (Mattias)"},getParams:function(){return this.params},setParamValue:function(e,t){switch(e){case"Curve":this.curve=t=="On"?1:0;this.crtPass.uniforms["curve"].value=this.curve;break;case"Frame":this.frame=t=="On"?1:0;this.crtPass.uniforms["frame"].value=this.frame;break;case"Pixel Shape":switch(t){case"Square":this.pixelRatio=0;break;case"Tall":this.pixelRatio=1;break;case"TV":this.pixelRatio=2;break}this.crtPass.uniforms["pixelRatio"].value=this.pixelRatio;break;case"Colour Bleed":this.colorBleed=t/50;this.crtPass.uniforms["colorBleed"].value=this.colorBleed;break;case"Ghosting":this.ghosting=t/25;this.crtPass.uniforms["ghosting"].value=this.ghosting;break;case"Scanline Intensity":this.scanlineIntensity=t/100;this.crtPass.uniforms["scanlineAmount"].value=this.scanlineIntensity;break;case"Vertical Line Intensity":this.verticalLineIntensity=t/100;this.crtPass.uniforms["verticalLineAmount"].value=this.verticalLineIntensity;break;case"Blur":this.blurValue=t/100;this.blurPass.uniforms["amount"].value=this.blurValue;break;case"Glow":this.glowValue=t/50;this.bloomPass.copyUniforms["opacity"].value=this.glowValue;break}},setupComposer:function(e,t,i){this.blurPass=new THREE.ShaderPass(BlurShader);this.blurPass.uniforms["resolution"].value=new THREE.Vector2(t,i);this.blurPass.uniforms["amount"].value=this.blurValue;e.addPass(this.blurPass);var r=new THREE.ShaderPass(THREE.CopyShader);e.addPass(r);this.crtPass=new THREE.ShaderPass(MattiasCRTShader);this.crtPass.uniforms["resolution"].value=new THREE.Vector2(t,i);this.crtPass.uniforms["curve"].value=this.curve;this.crtPass.uniforms["frame"].value=this.frame;this.crtPass.uniforms["pixelRatio"].value=this.pixelRatio;this.crtPass.uniforms["colorBleed"].value=this.colorBleed;this.crtPass.uniforms["ghosting"].value=this.ghosting;this.crtPass.uniforms["scanlineAmount"].value=this.scanlineIntensity;this.crtPass.uniforms["verticalLineAmount"].value=this.verticalLineIntensity;e.addPass(this.crtPass);this.bloomPass=new THREE.BloomPass;this.bloomPass.copyUniforms["opacity"].value=this.glowValue;e.addPass(this.bloomPass)}};var NoisyGlowEffect=function(){this.params=[{name:"Blur",min:0,max:100,type:"range",value:30,default:30},{name:"Noise",min:0,max:100,type:"range",value:30,default:30},{name:"BlurTwo",min:0,max:100,type:"range",value:30,default:30},{name:"Glow",min:0,max:100,type:"range",value:30,default:30}];this.blurValue=.1;this.blur2Value=.1;this.noiseValue=.3;this.glowValue=.3};NoisyGlowEffect.prototype={getName:function(){return"Noisy Glow"},getParams:function(){return this.params},setParamValue:function(e,t){switch(e){case"Blur":this.blurValue=t/100;this.blurPass.uniforms["amount"].value=this.blurValue;break;case"Noise":this.noiseValue=t/100;this.noisePass.uniforms["nIntensity"].value=this.noiseValue;break;case"BlurTwo":this.blur2Value=t/100;this.blur2Pass.uniforms["amount"].value=this.blur2Value;break;case"Glow":this.glowValue=t/50;this.bloomPass.copyUniforms["opacity"].value=this.glowValue;break}},setupComposer:function(e,t,i){BlurShader.uniforms["amount"].value=this.blurValue;BlurShader.uniforms["resolution"].value=new THREE.Vector2(t,i);this.blurPass=new THREE.ShaderPass(BlurShader);e.addPass(this.blurPass);var r=new THREE.ShaderPass(THREE.CopyShader);e.addPass(r);this.noisePass=new THREE.ShaderPass(NoiseShader);this.noisePass.uniforms["nIntensity"].value=this.noiseValue;e.addPass(this.noisePass);r=new THREE.ShaderPass(THREE.CopyShader);e.addPass(r);this.blur2Pass=new THREE.ShaderPass(BlurShader);e.addPass(this.blur2Pass);this.bloomPass=new THREE.BloomPass;this.bloomPass.copyUniforms["opacity"].value=this.glowValue;e.addPass(this.bloomPass)}};BlurShader={uniforms:{tDiffuse:{value:null},amount:{value:1},resolution:{value:new THREE.Vector2(960,600)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform vec2 resolution;","varying vec2 vUv;","void main( void )","    {","    vec2 uv = vUv;","    vec2 blur = vec2(amount/resolution.x, amount/resolution.y);","    vec4 sum = texture2D( tDiffuse, uv ) * 0.2270270270;","    sum += texture2D(tDiffuse, vec2( uv.x - 4.0 * blur.x, uv.y - 4.0 * blur.y ) ) * 0.0162162162;","    sum += texture2D(tDiffuse, vec2( uv.x - 3.0 * blur.x, uv.y - 3.0 * blur.y ) ) * 0.0540540541;","    sum += texture2D(tDiffuse, vec2( uv.x - 2.0 * blur.x, uv.y - 2.0 * blur.y ) ) * 0.1216216216;","    sum += texture2D(tDiffuse, vec2( uv.x - 1.0 * blur.x, uv.y - 1.0 * blur.y ) ) * 0.1945945946;","    sum += texture2D(tDiffuse, vec2( uv.x + 1.0 * blur.x, uv.y + 1.0 * blur.y ) ) * 0.1945945946;","    sum += texture2D(tDiffuse, vec2( uv.x + 2.0 * blur.x, uv.y + 2.0 * blur.y ) ) * 0.1216216216;","    sum += texture2D(tDiffuse, vec2( uv.x + 3.0 * blur.x, uv.y + 3.0 * blur.y ) ) * 0.0540540541;","    sum += texture2D(tDiffuse, vec2( uv.x + 4.0 * blur.x, uv.y + 4.0 * blur.y ) ) * 0.0162162162;","    gl_FragColor = sum;","    }   "].join("\n")};LotteCRTShader={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new THREE.Vector2(960,600)},warpscreen:{type:"f",value:1},INPUT_THIN:{type:"f",value:.55},INPUT_MASK:{type:"f",value:.5},INPUT_BLUR:{type:"f",value:-2.5},masktype:{type:"f",value:1},INPUT_X:{type:"f",value:960/3},INPUT_Y:{type:"f",value:600/3},contrast:{type:"f",value:1},saturation:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","uniform float warpscreen;","uniform float INPUT_THIN;","uniform float INPUT_MASK;","uniform float INPUT_BLUR;","uniform float masktype;","uniform float INPUT_X;","uniform float INPUT_Y;","uniform float contrast;","uniform float saturation;","varying vec2 vUv;","#define CRTS_GPU 1","#define CRTS_GLSL 1","#define CRTS_TONE 1","#define CRTS_CONTRAST 1","#define CRTS_SATURATION 1","vec3 CrtsFetch(vec2 uv){","uv*=vec2(INPUT_X,INPUT_Y)/resolution.xy;","uv+=vec2(0.5,0.5);","return texture2D(tDiffuse,vUv, -16.0).rgb;}","#ifdef CRTS_CPU"," #ifndef CrtsPow","  #define CrtsPow powf"," #endif"," #ifndef CRTS_RESTRICT","  #define CRTS_RESTRICT _restrict"," #endif"," #ifndef CRTS_STATIC","  #define CRTS_STATIC static"," #endif"," CRTS_STATIC void CrtsTone("," float *CRTS_RESTRICT dst,"," float contrast,","float saturation,"," float thin,"," float mask){"," if(masktype > 1.9) {","   mask=1.0f;"," } "," if(masktype > 0.9 && masktype < 2.0) {","   mask=0.5f+mask*0.5f;"," } ","  float midOut=0.18f/((1.5f-thin)*(0.5f*mask+0.5f));","   float pMidIn=CrtsPow(0.18f,contrast);","   dst[0]= contrast;","   dst[1]=((-pMidIn)+midOut)/((1.0f-pMidIn)*midOut);","   dst[2]=((-pMidIn)*midOut+pMidIn)/(midOut*(-pMidIn)+midOut);","   dst[3]=contrast+saturation;}","#endif","#ifdef CRTS_GPU"," #ifdef CRTS_GLSL","  #define CrtsF1 float","  #define CrtsF2 vec2","  #define CrtsF3 vec3","  #define CrtsF4 vec4","  #define CrtsFractF1 fract","  #define CrtsRcpF1(x) (1.0/(x))","  #define CrtsSatF1(x) clamp((x),0.0,1.0)","  CrtsF1 CrtsMax3F1(CrtsF1 a,CrtsF1 b,CrtsF1 c){","   return max(a,max(b,c));}"," #endif"," #ifdef CRTS_HLSL","  #define CrtsF1 float","  #define CrtsF2 float2","  #define CrtsF3 float3","  #define CrtsF4 float4","  #define CrtsFractF1 frac","  #define CrtsRcpF1(x) (1.0/(x))","  #define CrtsSatF1(x) saturate(x)","  CrtsF1 CrtsMax3F1(CrtsF1 a,CrtsF1 b,CrtsF1 c){","   return max(a,max(b,c));}"," #endif"," CrtsF4 CrtsTone("," CrtsF1 contrasts,"," CrtsF1 saturations,"," CrtsF1 thin,"," CrtsF1 mask){"," if(masktype > 1.9) {","   mask=1.0;","  } "," if(masktype > 0.9 && masktype < 2.0) {","   mask=0.5+mask*0.5;"," } ","  CrtsF4 ret;","  CrtsF1 midOut=0.18/((1.5-thin)*(0.5*mask+0.5));","  CrtsF1 pMidIn=pow(0.18,contrast);","  ret.x=contrast;","  ret.y=((-pMidIn)+midOut)/((1.0-pMidIn)*midOut);","  ret.z=((-pMidIn)*midOut+pMidIn)/(midOut*(-pMidIn)+midOut);","  ret.w=contrast+saturation;","  return ret;}"," CrtsF3 CrtsMask(CrtsF2 pos,CrtsF1 dark){"," if(masktype < 1.0) {","   CrtsF3 m=CrtsF3(dark,dark,dark);","   CrtsF1 x=CrtsFractF1(pos.x*(1.0/3.0));","   if(x<(1.0/3.0))m.r=1.0;","   else if(x<(2.0/3.0))m.g=1.0;","   else m.b=1.0;","   return m;"," } "," if(masktype > 0.9 && masktype < 2.0) {","   CrtsF3 m=CrtsF3(1.0,1.0,1.0);","   CrtsF1 x=CrtsFractF1(pos.x*(1.0/3.0));","   if(x<(1.0/3.0))m.r=dark;","   else if(x<(2.0/3.0))m.g=dark;","   else m.b=dark;","   return m;","  } "," if(masktype > 1.9) {","   return CrtsF3(1.0,1.0,1.0);"," } ","  #ifdef CRTS_MASK_SHADOW","   pos.x+=pos.y*3.0;","   CrtsF3 m=CrtsF3(dark,dark,dark);","   CrtsF1 x=CrtsFractF1(pos.x*(1.0/6.0));","   if(x<(1.0/3.0))m.r=1.0;","   else if(x<(2.0/3.0))m.g=1.0;","   else m.b=1.0;","   return m;","  #endif"," }"," CrtsF3 CrtsFilter(","  CrtsF2 ipos,","  CrtsF2 inputSizeDivOutputSize,     ","  CrtsF2 halfInputSize,","  CrtsF2 rcpInputSize,","  CrtsF2 rcpOutputSize,","  CrtsF2 twoDivOutputSize,   ","  CrtsF1 inputHeight,","  CrtsF2 warp,","  CrtsF1 thin,","  CrtsF1 blur,","  CrtsF1 mask,","  CrtsF4 tone"," ){","  #ifdef CRTS_DEBUG","   CrtsF2 uv=ipos*rcpOutputSize;","   if(uv.x<0.5){","    uv*=1.0/rcpInputSize;","    uv=floor(uv)+CrtsF2(0.5,0.5);","    uv*=rcpInputSize;","    CrtsF3 color=texture2D(tDiffuse, vUv).rgb;","    return color;","   }","  #endif","  CrtsF2 pos;","  CrtsF1 vin = 0.0;","  if(warpscreen > 0.5) {","   pos=ipos*twoDivOutputSize-CrtsF2(1.0,1.0);","   pos*=CrtsF2(","    1.0+(pos.y*pos.y)*warp.x,","    1.0+(pos.x*pos.x)*warp.y);","   vin=1.0-(","    (1.0-CrtsSatF1(pos.x*pos.x))*(1.0-CrtsSatF1(pos.y*pos.y)));","   vin=CrtsSatF1((-vin)*inputHeight+inputHeight);","   pos=pos*halfInputSize+halfInputSize;     "," } else { ","   pos=ipos*inputSizeDivOutputSize;"," } ","  CrtsF1 y0=floor(pos.y-0.5)+0.5;","  #ifdef CRTS_2_TAP","   pos.x+=0.5;","   CrtsF1 xi=floor(pos.x);","   CrtsF1 xf=pos.x-xi;","   xf=xf*xf*xf*(xf*(xf*6.0-15.0)+10.0);  ","   CrtsF1 x0=xi+xf-0.5;","   CrtsF2 p=CrtsF2(x0*rcpInputSize.x,y0*rcpInputSize.y);     ","   CrtsF3 colA=CrtsFetch(p);","   p.y+=rcpInputSize.y;","   CrtsF3 colB=CrtsFetch(p);","  #else","   CrtsF1 x0=floor(pos.x-1.5)+0.5;","   CrtsF2 p=CrtsF2(x0*rcpInputSize.x,y0*rcpInputSize.y);     ","   CrtsF3 colA0=CrtsFetch(p);","   p.x+=rcpInputSize.x;","   CrtsF3 colA1=CrtsFetch(p);","   p.x+=rcpInputSize.x;","   CrtsF3 colA2=CrtsFetch(p);","   p.x+=rcpInputSize.x;","   CrtsF3 colA3=CrtsFetch(p);","   p.y+=rcpInputSize.y;","   CrtsF3 colB3=CrtsFetch(p);","   p.x-=rcpInputSize.x;","   CrtsF3 colB2=CrtsFetch(p);","   p.x-=rcpInputSize.x;","   CrtsF3 colB1=CrtsFetch(p);","   p.x-=rcpInputSize.x;","   CrtsF3 colB0=CrtsFetch(p);","  #endif","  CrtsF1 off=pos.y-y0;","  CrtsF1 pi2=6.28318530717958;","  CrtsF1 hlf=0.5;","  CrtsF1 scanA=cos(min(0.5,  off *thin     )*pi2)*hlf+hlf;","  CrtsF1 scanB=cos(min(0.5,(-off)*thin+thin)*pi2)*hlf+hlf;","  #ifdef CRTS_2_TAP"," if(warpscreen > 0.5) { ","    scanA*=vin;","    scanB*=vin;"," } ","   CrtsF3 color=(colA*scanA)+(colB*scanB);","  #else","   CrtsF1 off0=pos.x-x0;","   CrtsF1 off1=off0-1.0;","   CrtsF1 off2=off0-2.0;","   CrtsF1 off3=off0-3.0;","   CrtsF1 pix0=exp2(blur*off0*off0);","   CrtsF1 pix1=exp2(blur*off1*off1);","   CrtsF1 pix2=exp2(blur*off2*off2);","   CrtsF1 pix3=exp2(blur*off3*off3);","   CrtsF1 pixT=CrtsRcpF1(pix0+pix1+pix2+pix3);"," if(warpscreen > 0.5) { ","    pixT*=vin;"," } ","   scanA*=pixT;","   scanB*=pixT;","   CrtsF3 color=","    (colA0*pix0+colA1*pix1+colA2*pix2+colA3*pix3)*scanA +","    (colB0*pix0+colB1*pix1+colB2*pix2+colB3*pix3)*scanB;","  #endif","  color*=CrtsMask(ipos,mask);","  #ifdef CRTS_TONE","   CrtsF1 peak=max(1.0/(256.0*65536.0),","    CrtsMax3F1(color.r,color.g,color.b));","   CrtsF3 ratio=color*CrtsRcpF1(peak);","   #ifdef CRTS_CONTRAST","    peak=pow(peak,tone.x);","   #endif","   peak=peak*CrtsRcpF1(peak*tone.y+tone.z);","   #ifdef CRTS_SATURATION","    ratio=pow(ratio,CrtsF3(tone.w,tone.w,tone.w));","   #endif","   return ratio*peak;"," #else","  return color;"," #endif"," }","#endif","void main() {"," vec2 fragCoord = vUv * resolution;"," gl_FragColor.rgb=CrtsFilter(","  fragCoord.xy,","  vec2(INPUT_X,INPUT_Y)/resolution.xy,","  vec2(INPUT_X,INPUT_Y)*vec2(0.5,0.5),","  1.0/vec2(INPUT_X,INPUT_Y),","  1.0/resolution.xy,","  2.0/resolution.xy,","  INPUT_Y,","  vec2(1.0/48.0,1.0/24.0),","  INPUT_THIN,","  INPUT_BLUR,","  INPUT_MASK,","  CrtsTone(0.5,0.0,INPUT_THIN,INPUT_MASK));","gl_FragColor.a = 1.0;","}"].join("\n")};MattiasCRTShader={uniforms:{tDiffuse:{value:null},curve:{value:1},frame:{value:1},pixelRatio:{value:1},colorBleed:{value:.25},ghosting:{value:1},scanlineAmount:{value:.9},verticalLineAmount:{value:1},resolution:{value:new THREE.Vector2(900,600)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),blurfragmentShader:["uniform sampler2D tDiffuse;","uniform float curve;","uniform float pixelRatio;","varying vec2 vUv;","void main( void )","    {","    vec2 uv = vUv;","    vec2 blur = vec2(2.0/960.0, 2.0/600.0);","    vec4 sum = texture2D( tDiffuse, uv ) * 0.2270270270;","    sum += texture2D(tDiffuse, vec2( uv.x - 4.0 * blur.x, uv.y - 4.0 * blur.y ) ) * 0.0162162162;","    sum += texture2D(tDiffuse, vec2( uv.x - 3.0 * blur.x, uv.y - 3.0 * blur.y ) ) * 0.0540540541;","    sum += texture2D(tDiffuse, vec2( uv.x - 2.0 * blur.x, uv.y - 2.0 * blur.y ) ) * 0.1216216216;","    sum += texture2D(tDiffuse, vec2( uv.x - 1.0 * blur.x, uv.y - 1.0 * blur.y ) ) * 0.1945945946;","    sum += texture2D(tDiffuse, vec2( uv.x + 1.0 * blur.x, uv.y + 1.0 * blur.y ) ) * 0.1945945946;","    sum += texture2D(tDiffuse, vec2( uv.x + 2.0 * blur.x, uv.y + 2.0 * blur.y ) ) * 0.1216216216;","    sum += texture2D(tDiffuse, vec2( uv.x + 3.0 * blur.x, uv.y + 3.0 * blur.y ) ) * 0.0540540541;","    sum += texture2D(tDiffuse, vec2( uv.x + 4.0 * blur.x, uv.y + 4.0 * blur.y ) ) * 0.0162162162;","    gl_FragColor = sum;","    }   "].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float curve;","uniform float frame;","uniform float pixelRatio;","uniform float ghosting;","uniform float colorBleed;","uniform float scanlineAmount;","uniform float verticalLineAmount;","uniform vec2 resolution;","varying vec2 vUv;","#define PI 3.14159265359","vec4 blur(sampler2D samp, vec2 uv, float amount, vec2 resolution) ","{","    vec2 blurSrc = vec2(amount/resolution.x, amount/resolution.y);","    vec4 sum = texture2D( samp, uv ) * 0.2270270270;","    sum += texture2D(samp, vec2( uv.x - 4.0 * blurSrc.x, uv.y - 4.0 * blurSrc.y ) ) * 0.0162162162;","    sum += texture2D(samp, vec2( uv.x - 3.0 * blurSrc.x, uv.y - 3.0 * blurSrc.y ) ) * 0.0540540541;","    sum += texture2D(samp, vec2( uv.x - 2.0 * blurSrc.x, uv.y - 2.0 * blurSrc.y ) ) * 0.1216216216;","    sum += texture2D(samp, vec2( uv.x - 1.0 * blurSrc.x, uv.y - 1.0 * blurSrc.y ) ) * 0.1945945946;","    sum += texture2D(samp, vec2( uv.x + 1.0 * blurSrc.x, uv.y + 1.0 * blurSrc.y ) ) * 0.1945945946;","    sum += texture2D(samp, vec2( uv.x + 2.0 * blurSrc.x, uv.y + 2.0 * blurSrc.y ) ) * 0.1216216216;","    sum += texture2D(samp, vec2( uv.x + 3.0 * blurSrc.x, uv.y + 3.0 * blurSrc.y ) ) * 0.0540540541;","    sum += texture2D(samp, vec2( uv.x + 4.0 * blurSrc.x, uv.y + 4.0 * blurSrc.y ) ) * 0.0162162162;","    return sum;","}","vec3 bsample( sampler2D samp, vec2 tc, float offs, vec2 resolution )","{","    if(pixelRatio == 1.0) {","      tc = tc * vec2(1.035, 0.96) + vec2(-0.0125*0.75, 0.02);","\t     tc = tc * 1.2 - 0.1;","    }","    vec3 s = pow( abs( blur( samp, vec2( tc.x, 1.0-tc.y ), 5.0, resolution ).rgb), vec3( 2.2 ) );","    return s*vec3(1.25);","}","vec3 tsample( sampler2D samp, vec2 tc, float offs, vec2 resolution )","{","    if(pixelRatio == 1.0) {","      tc = tc * vec2(1.035, 0.96) + vec2(-0.0125*0.75, 0.02);","\t     tc = tc * 1.2 - 0.1;","    }","    vec3 s = pow( abs( texture2D( samp, vec2( tc.x, 1.0-tc.y ) ).rgb), vec3( 2.2 ) );","    return s*vec3(1.25);","    }","vec3 filmic( vec3 LinearColor )","    {","    vec3 x = max( vec3(0.0), LinearColor-vec3(0.004));","    return (x*(6.2*x+0.5))/(x*(6.2*x+1.7)+0.06);","    }","vec2 docurve( vec2 uv )","{","    uv = (uv - 0.5) * 2.0;","    uv *= 1.1;","    uv.x *= 1.0 + pow((abs(uv.y) / 5.0), 2.0);","    uv.y *= 1.0 + pow((abs(uv.x) / 4.0), 2.0);","    uv  = (uv / 2.0) + 0.5;","    uv =  uv *0.92 + 0.04;","    return uv;","}","float rand(vec2 co)","    {","    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);","    }","void main() {","    float time = 1.0;","    vec2 uv = vUv;","    uv.y = 1.0 - uv.y;","    vec2 resolution = vec2(960.0,600.0);","    vec2 curved_uv = uv; ","    if(curve > 0.5) ","      curved_uv = mix( docurve( uv ), uv, 0.8 );","    float scale = 0.13;","    if(pixelRatio == 0.0) {","      scale = 0.0;","    }","    if(pixelRatio == 1.0) {","    curved_uv = curved_uv + vec2(-0.0128, 0);","    }","    if(pixelRatio != 1.0) {","    curved_uv = curved_uv + vec2(-0.003, 0);","    }","    vec2 scuv = curved_uv * (1.0 - scale) + scale / 2.0 + vec2(0.003, -0.001);","    vec3 col;","    float x =  sin(0.1*time+curved_uv.y*13.0)*sin(0.23*time+curved_uv.y*19.0)*sin(0.3+0.11*time+curved_uv.y*23.0)*0.0012;","    float o =sin(gl_FragCoord.y*1.5)/resolution.x;","    x += o*0.25;","\t  x *= 0.2;","    col.r = tsample(tDiffuse,vec2(x+scuv.x+0.0009*colorBleed,scuv.y+0.0009*colorBleed),resolution.y/800.0, resolution ).x+0.02;","    col.g = tsample(tDiffuse,vec2(x+scuv.x+0.0000*colorBleed,scuv.y-0.0011*colorBleed),resolution.y/800.0, resolution ).y+0.02;","    col.b = tsample(tDiffuse,vec2(x+scuv.x-0.0015*colorBleed,scuv.y+0.0000*colorBleed),resolution.y/800.0, resolution ).z+0.02;","    float i = clamp(col.r*0.299 + col.g*0.587 + col.b*0.114, 0.0, 1.0 );","    i = pow( 1.0 - pow(i,2.0), 1.0 );","    i = (1.0-i) * 0.85 + 0.15;","    float ghs = 0.05 * ghosting;","    float ghs2 = 0.45 * ghosting;","    float ghs3 = 0.35 * ghosting;","    vec3 r = bsample(tDiffuse, vec2(x-0.014*1.0, -0.027)*ghs2+0.007*vec2( 0.35*sin(1.0/7.0 + 15.0*curved_uv.y + 0.9*time),","        0.35*sin( 2.0/7.0 + 10.0*curved_uv.y + 1.37*time) )+vec2(scuv.x+0.001,scuv.y+0.001),","        5.5+1.3*sin( 3.0/9.0 + 31.0*curved_uv.x + 1.70*time),resolution).xyz*vec3(0.5,0.25,0.25);","    vec3 g = bsample(tDiffuse, vec2(x-0.019*1.0, -0.020)*ghs2+0.007*vec2( 0.35*cos(1.0/9.0 + 15.0*curved_uv.y + 0.5*time),","        0.35*sin( 2.0/9.0 + 10.0*curved_uv.y + 1.50*time) )+vec2(scuv.x+0.000,scuv.y-0.002),","        5.4+1.3*sin( 3.0/3.0 + 71.0*curved_uv.x + 1.90*time),resolution).xyz*vec3(0.25,0.5,0.25);","    vec3 b = bsample(tDiffuse, vec2(x-0.017*1.0, -0.003)*ghs3+0.007*vec2( 0.35*sin(2.0/3.0 + 15.0*curved_uv.y + 0.7*time),","        0.35*cos( 2.0/3.0 + 10.0*curved_uv.y + 1.63*time) )+vec2(scuv.x-0.002,scuv.y+0.000),","        5.3+1.3*sin( 3.0/7.0 + 91.0*curved_uv.x + 1.65*time),resolution).xyz*vec3(0.25,0.25,0.5);","    col += vec3(ghs*(1.0-0.299))*pow(clamp(vec3(3.0)*r,vec3(0.0),vec3(1.0)),vec3(2.0))*vec3(i);","    col += vec3(ghs*(1.0-0.587))*pow(clamp(vec3(3.0)*g,vec3(0.0),vec3(1.0)),vec3(2.0))*vec3(i);","    col += vec3(ghs*(1.0-0.114))*pow(clamp(vec3(3.0)*b,vec3(0.0),vec3(1.0)),vec3(2.0))*vec3(i);","    col *= vec3(0.95,1.05,0.95);","    col = clamp(col*1.3 + 0.75*col*col + 1.25*col*col*col*col*col,vec3(0.0),vec3(10.0));","    float vig = (0.1 + 1.0*16.0*curved_uv.x*curved_uv.y*(1.0-curved_uv.x)*(1.0-curved_uv.y));","    vig = 1.3*pow(vig,0.5);","    col *= vig;","    float scans = clamp( 0.35+0.18*sin(0.0*time+curved_uv.y*resolution.y*1.5), 0.0, 1.0);","    float s = pow(scans, scanlineAmount);","    col = col * vec3(s);","    col*=1.0 - 0.23 * verticalLineAmount * (clamp((mod(gl_FragCoord.xy.x, 3.0))/2.0,0.0,1.0));","    col = filmic( col );","    vec2 seed = curved_uv*resolution.xy;","    col -= 0.015*pow(vec3(rand( seed +time ), rand( seed +time*2.0 ), rand( seed +time * 3.0 ) ), vec3(1.5) );","    col *= (1.0-0.004*(sin(50.0*time+curved_uv.y*2.0)*0.5+0.5));"," if(frame == 1.0) {","    if(pixelRatio == 1.0) { ","    if (curved_uv.x < 0.028) ","      col *= max((curved_uv.x-0.022), 0.0) * 100.0;","    if(curved_uv.x > 0.947) ","        col *= max((0.953 - curved_uv.x), 0.0) * 100.0;","    if (curved_uv.y < 0.01) ","        col *= curved_uv.y * 100.0;","    if(curved_uv.y > 0.99)","        col *= (1.0 - curved_uv.y) * 100.0;","    }","    if(pixelRatio != 1.0 ) { ","    if (curved_uv.x < -0.0001) ","      col *= max((curved_uv.x + 0.0059), 0.0) * 100.0;","    if(curved_uv.x > 0.9955) ","        col *= max((1.0015 - curved_uv.x), 0.0) * 100.0;","    if (curved_uv.y < 0.01) ","        col *= curved_uv.y * 100.0;","    if(curved_uv.y > 0.99)","        col *= (1.0 - curved_uv.y) * 100.0;","    }"," }","\tgl_FragColor = vec4( col, 1.0 );","}"].join("\n")};NoiseShader={uniforms:{tDiffuse:{value:null},time:{value:0},nIntensity:{value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform float time;","uniform float nIntensity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, vUv );","float dx = rand( vUv + time );","vec3 cResult = cTextureScreen.rgb + cTextureScreen.rgb * clamp( 0.1 + dx, 0.0, 1.0 );","cResult = cTextureScreen.rgb + clamp( nIntensity, 0.0,1.0 ) * ( cResult - cTextureScreen.rgb );","gl_FragColor =  vec4( cResult, cTextureScreen.a );","}"].join("\n")};VignetteShader={uniforms:{tDiffuse:{value:null},offset:{value:1},darkness:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float offset;","uniform float darkness;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tvec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );","\tgl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );","}"].join("\n")};var Config=function(){this.data={}};Config.prototype={init:function(){}};var JSONEditor=function(){this.doc=null;this.path="";this.uiComponent=null;this.codeEditor=null};JSONEditor.prototype={modified:function(){if(g_app.openingProject){return}g_app.doc.recordModified(this.doc,this.path)},init:function(e){this.parentPanel=e.parentPanel},buildInterface:function(){if(this.uiComponent!=null){return}this.uiComponent=UI.create("UI.Panel",{id:"jsonEditor"});this.parentPanel.add(this.uiComponent);var e=UI.create("UI.Panel");this.uiComponent.add(e);this.codeEditor=new CodeEditor;this.codeEditor.init("json");this.codeEditor.buildInterface(e);this.codeEditor.on("change",function(e){t.codeEditorChange()});var t=this;UI.on("ready",function(){t.initEvents()})},show:function(){if(!this.uiComponent){this.buildInterface()}},initEvents:function(){},codeEditorChange:function(){if(this.doc!=null){this.modified();this.doc.data=this.codeEditor.getValue();console.log(this.doc.data)}},saveSettings:function(e){console.log("save settings");e[this.path]={scrollTop:this.codeEditor.getScrollTop(),editSession:this.codeEditor.getEditSession()}},load:function(e,t,i){console.log("current path = "+this.path);console.log("new path = "+e);if(typeof t=="undefined"&&e==this.path){return}this.doc=null;this.path=e;var r=g_app.doc.getDocRecord(e);if(r!=null){this.doc=r;if(typeof i!="undefined"&&typeof i[e]!="undefined"){console.log("set edit session");this.codeEditor.setEditSession(i[e].editSession)}else{console.log("create edit session");var a=r.data;if(!isString(r.data)){a=JSON.stringify(a,null,2)}this.codeEditor.setEditSession(ace.createEditSession(a,"ace/mode/json"))}if(typeof t!="undefined"){this.codeEditor.gotoLine(t)}}}};var Icons={};Icons.get=function(e){console.log("get icon for "+e);switch(e){case"graphic":return"icons/svg/glyphicons-basic-37-file.svg";break;case"asm":return"icons/svg/glyphicons-basic-37-file.svg";break;default:return"icons/svg/glyphicons-basic-37-file.svg";break}};var keys={textMode:{play:{keyCode:32,shift:false},toolsPencil:{key:"N"},toolsErase:{key:"L"},toolsBucket:{key:"K"},toolsEyedropper:{key:"I"},toolsPixel:{key:"P"},toolsCharPixel:{key:"O"},toolsMarquee:{key:"M"},toolsShape:{key:"U"},toolsZoom:{key:"Z"},toolsType:{key:"T"},toolsHand:{key:"H"},toolsMove:{key:"V"},toolsBlock:{key:"B"},drawCharacter:{key:"C"},drawFGColor:{key:"F"},drawBGColor:{key:"G"},cursorUp:{},selectDrawWithSelection:{key:"D"},selectFlipSelectionH:{key:"F"},selectFlipSelectionV:{key:"G"},selectFillSelection:{key:"C"},drawCharacter:{key:false},drawFGColor:{key:false},drawBGColor:{key:false},drawTileFlipH:{key:"F"},drawTileFlipV:{key:"G"},lineSegmentHorizontal:{key:"F"},lineSegmentVertical:{key:"G"},c64MultiFG:{key:"2"},c64MultiBG:{key:"1"},c64MultiMC1:{key:"3"},c64MultiMC2:{key:"4"},tilePaletteLeft:{keyCode:65,shift:false},tilePaletteRight:{keyCode:68,shift:false},tilePaletteUp:{keyCode:87,shift:false},tilePaletteDown:{keyCode:83,shift:false},characterRecentNext:{keyCode:69,shift:false},characterRecentPrev:{keyCode:81,shift:false},characterRotate:{keyCode:82,shift:false},showTilePicker:{key:"/"},colorPaletteLeft:{keyCode:65,shift:true},colorPaletteRight:{keyCode:68,shift:true},colorPaletteUp:{keyCode:87,shift:true},colorPaletteDown:{keyCode:83,shift:true},colorPaletteRecentNext:{keyCode:69,shift:true},colorPaletteRecentPrev:{keyCode:81,shift:true},switchColors:{key:"x"},showColorPicker:{key:"?"},framesNext:{key:"."},framesPrev:{key:","}}};var styles={text:{blockName:"Meta Tile"},ui:{scrollbarWidth:10,scrollbarHolder:"#111111",scrollbar:"#555555"},textMode:{tilePaletteFg:"#d0d0d0",tilePaletteBg:"#222222",gridView2dBackground:"#010101",gridView2dPixelGridLine:"#555555",gridView2dPixelGridLineWidth:.2,gridView2dGridLine:"#888888",gridView2dGridLineWidth:.2,gridView2dGridBlockLine:"#ffffff",gridView2dGridBlockLineWidth:.3,gridView2dSelectLineDark:"#444444",gridView2dSelectLineLight:"#dddddd",typingKeyboardKeyHighlight:"#aaaaaa",typingKeyboardLines:"#333333",typingKeyboardBackground:"#eeeeee",currentTileBackground:"#222222",tileEditorGridBg:"#000000",tileEditorGridFg:"#ffffff",tileEditorGridLines:"#aaaaaa",tileEditorGridBorder:"#c9c9c9",popupTextColor:"#eeeeee"},tilePalette:{selectOutline:"#1ea0ff",highlightOutline:"#888888"},colorPalette:{highlightOutline:"#ff0000"},music:{selectFill:"#7777ff",selectOutline:"#bbbbff",rulerBackground:"#222222",rulerLines:"#666666",rulerBarLines:"#aaaaaa",oscilloscopeBackground:"#111111",oscilloscopeLines:"#eeeeee",effectsBackground:"#555555",effectsText:"#333333",effectsFill:"#aaaaaa",effectsOutline:"#333333",effectsCursor:"#0000ff",effectsCursorOutline:"#00ff00",cursorOutline:"#0000ff",pianoRollBlackKey:"#000000",pianoRollWhiteKey:"#ffffff",pianoRollKeyOutline:"#222222",pianoRollHighlightedNote:"#aaaaff",pianoRollSelectedNote:"#7777aa",noteOutline:"#cccccc",ghostNoteOutline:"#dddddd",selectedNoteOutline:"#aaaaff",gridBackground:"#333333",gridBlackNotes:"#1b1b1b",gridWhiteNotes:"#333333",gridLines:"#444444",gridOctaveLines:"#595959",gridBarLines:"#9a9a9a",gridBeatLines:"#666666"}};var FileManager=function(){this.editor=null;this.filename="Untitled";this.saveTo="browserStorage";this.googleDriveFileId=false;this.saveInProgress=false;this.gDriveSaveInProgress=false;this.isNew=false;this.saveAsDialog=null;this.saveAsTemplateDialog=null;this.downloadAsDialog=null;this.newDialog=null;this.importCharPad=null;this.dropImage=null;this.saveButton=null;this.desktopFileManager=null};FileManager.prototype={init:function(e){this.editor=e;if(g_app.isDesktopApp()){this.desktopFileManager=new DesktopFileManager(this.editor)}var t=this;UI.on("ready",function(){t.initLoadForm();t.initSaveAsDialog();t.initDownloadAsDialog()})},initSaveAsDialog:function(){var t=this;var e=380;var i=230;if(UI.isMobile.any()){e=330;i=280}this.saveAsDialog=UI.create("UI.Dialog",{id:"saveProjectAsDialog",title:"Save As",width:e,height:i});this.saveAsHTML=UI.create("UI.HTMLPanel");this.saveAsDialog.add(this.saveAsHTML);this.saveAsDialog.on("close",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false);t.saveInProgress=false;t.saveButton.setEnabled(true)});this.saveAsHTML.load("html/project/saveProjectAsDialog.html",function(){$("#saveProjectAs").focus();$("#saveProjectAs").select();$("#saveProjectAsDialog .submitOnEnter").on("keypress",function(e){if(e.keyCode==13){t.submitForm()}});$("input[name=saveMethod]").on("click",function(){var e=$("input[name=saveMethod]:checked").val();t.setSaveMethod(e)});$("#saveAsConnectToGDriveButton").on("click",function(){t.connectToGDrive()})});this.saveButton=UI.create("UI.Button",{text:"Save",color:"primary"});this.saveAsDialog.addButton(this.saveButton);this.saveButton.on("click",function(e){t.submitForm()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.saveAsDialog.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})},submitForm:function(){var t=this;var e={};e.filename=$("#saveProjectAs").val();e.saveMethod=$("input[name=saveMethod]:checked").val();this.saveInProgress=true;this.saveButton.setEnabled(false);this.saveAs(e,function(e){t.saveInProgress=false;t.saveButton.setEnabled(true);if(e.success){UI.closeDialog()}})},connectToGDrive:function(){g_app.gdrive.handleAuthClick()},checkGDriveAccess:function(){if(this.saveMethod==="googleDrive"&&!g_app.gdrive.checkIsSignedIn()){$("#saveAsConnectToGDriveButtonSection").show()}else{$("#saveAsConnectToGDriveButtonSection").hide()}},setSaveMethod:function(e){this.saveMethod=e;if(e=="googleDrive"){this.checkGDriveAccess()}else{$("#saveAsConnectToGDriveButtonSection").hide()}},initDownloadAsDialog:function(){var i=this;var e=400;var t=120;if(UI.isMobile.any()){e=330;t=140}this.downloadAsDialog=UI.create("UI.Dialog",{id:"downloadAsDialog",title:"Download As",width:e,height:t});this.downloadAsHTML=UI.create("UI.HTMLPanel");this.downloadAsDialog.add(this.downloadAsHTML);this.downloadAsHTML.load("html/downloadAsDialog.html",function(){});this.downloadOkButton=UI.create("UI.Button",{text:"Download",color:"primary"});this.downloadAsDialog.addButton(this.downloadOkButton);this.downloadOkButton.on("click",function(e){var t={};t.filename=$("#downloadAs").val();t.saveMethod="download";t.setSaveMethod=false;if(i.downloadAs(t)){UI.closeDialog()}});this.downloadCloseButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.downloadAsDialog.addButton(this.downloadCloseButton);this.downloadCloseButton.on("click",function(e){UI.closeDialog()})},initLoadForm:function(){var e='<form id="loadDataForm"  style="position: absolute; top: -40px">';e+='<input type="file" name="data" size="10" id="loadData" accept=".json,.prg,.ctm,.spd,.c,.zip,.png,.jpg"/>';e+="</form>";$("body").append(e);var i=this;document.getElementById("loadData").addEventListener("change",function(e){var t=document.getElementById("loadData").files[0];i.openFile(t)},false)},openFile:function(i){var e=i.name;var t="";var r=e.lastIndexOf(".");if(r!=-1){t=e.substr(r+1);t=t.toLowerCase().trim()}var a=new FileReader;var s=this;switch(t){case"jpg":case"png":if(this.dropImage==null){this.dropImage=new DropImage}this.dropImage.start(i);break;case"aco":case"act":case"ase":case"gpl":case"txt":case"hex":case"vpl":this.loadColorPalette(i);break;case"mp4":case"mov":console.log("drag movie!");break;case"zip":g_app.doc=new Document;g_app.doc.init(g_app);g_app.createDocumentStructure(g_app.doc);g_app.doc.loadZipFile(i,function(){});break;case"json":a.onload=function(e){s.loadLocalFile(e.target.result);document.getElementById("loadDataForm").reset()};a.readAsText(i);break;case"ctm":a.onload=function(e){var t=new Uint8Array(e.target.result);s.loadCTMFile(t);document.getElementById("loadDataForm").reset()};a.readAsArrayBuffer(i);break;case"c":a.onload=function(e){s.loadCFile(e.target.result);document.getElementById("loadDataForm").reset()};a.readAsText(i);break;case"spd":a.onload=function(e){var t=new Uint8Array(e.target.result);s.loadSPDFile(t);document.getElementById("loadDataForm").reset()};a.readAsArrayBuffer(i);break;case"prg":this.loadPRGFile(i);document.getElementById("loadDataForm").reset();break;case"c64":this.loadC64Snapshot(i);document.getElementById("loadDataForm").reset();break;case"d64":a.onload=function(e){var t=new Uint8Array(e.target.result);s.loadD64File(i.name,t);document.getElementById("loadDataForm").reset()};a.readAsArrayBuffer(i);break;case"crt":this.loadCRTFile(i);document.getElementById("loadDataForm").reset();break;case"nes":a.onload=function(e){var t=new Uint8Array(e.target.result);s.loadNESFile(t);document.getElementById("loadDataForm").reset()};a.readAsArrayBuffer(i);break;case"bas":this.loadBasFile(i);document.getElementById("loadDataForm").reset();break}},loadColorPalette:function(e){console.log("load colour palette!!");if(g_app.doc!==null){if(g_app.textModeEditor.colorPaletteManager.colorPaletteLoad&&g_app.textModeEditor.colorPaletteManager.colorPaletteLoad.visible){g_app.textModeEditor.colorPaletteManager.colorPaletteLoad.setImportFile(e);return}if(g_app.textModeEditor.colorPaletteEdit&&g_app.textModeEditor.colorPaletteEdit.visible){g_app.textModeEditor.colorPaletteEdit.dropFile(e);return}g_app.textModeEditor.colorPaletteManager.showLoad({dialogReadyCallback:function(){g_app.textModeEditor.colorPaletteManager.colorPaletteLoad.setImportFile(e)}})}else{var t={};t.mode="textmode";t.width=40;t.height=25;g_app.newProject(t,function(){g_app.textModeEditor.colorPaletteManager.showLoad({dialogReadyCallback:function(){g_app.textModeEditor.colorPaletteManager.colorPaletteLoad.setImportFile(e)}})})}},loadNESFile:function(e){g_app.doc=new Document;var t=this;g_app.newProject({},function(){g_app.projectNavigator.refreshTree();g_app.setMode("nes");g_app.nesDebugger.loadROM(e)})},loadC64Snapshot:function(e){if(g_app.doc!==null){if(g_app.getMode()=="assembler"){g_app.assemblerEditor.debuggerCompact.loadPRGFile(e);g_app.assemblerEditor.debuggerCompact.loadSnapshotFile(e)}else{g_app.setMode("c64");g_app.c64Debugger.loadSnapshotFile(e)}}else{g_app.newProject({},function(){g_app.projectNavigator.refreshTree();g_app.setMode("c64");g_app.c64Debugger.loadSnapshotFile(e)})}},loadBasFile:function(e){if(g_app.doc!==null){g_app.setMode("c64");g_app.c64Debugger.loadBASFile(e)}else{g_app.newProject({},function(){g_app.projectNavigator.refreshTree();g_app.setMode("c64");g_app.c64Debugger.loadBASFile(e)})}},loadPRGFile:function(e){if(g_app.doc!==null){if(g_app.getMode()=="assembler"){g_app.assemblerEditor.debuggerCompact.loadPRGFile(e)}else{g_app.setMode("c64");g_app.c64Debugger.loadPRGFile(e)}}else{g_app.newProject({},function(){g_app.projectNavigator.refreshTree();g_app.setMode("c64");g_app.c64Debugger.loadPRGFile(e)})}},loadCRTFile:function(e){var t=this;if(g_app.doc!==null){if(g_app.getMode()=="assembler"){g_app.assemblerEditor.debuggerCompact.insertCRT(e)}else{g_app.setMode("c64");g_app.c64Debugger.insertCRT(e)}}else{g_app.newProject({},function(){g_app.projectNavigator.refreshTree();g_app.setMode("c64");g_app.c64Debugger.insertCRT(e)})}},loadD64File:function(e,t){var i=this;if(g_app.doc!==null){if(g_app.getMode()=="assembler"){g_app.assemblerEditor.debuggerCompact.attachD64AsByteArray(e,t)}else{g_app.setMode("c64");g_app.c64Debugger.autostartD64=true;g_app.c64Debugger.attachD64AsByteArray(e,t)}}else{g_app.newProject({},function(){g_app.projectNavigator.refreshTree();g_app.setMode("c64");g_app.c64Debugger.autostartD64=true;g_app.c64Debugger.attachD64AsByteArray(e,t)})}},loadCFile:function(i){if(this.importC==null){this.importC=new ImportC;this.importC.init(g_app.textModeEditor)}g_app.doc=new Document;var r=this;g_app.newProject({},function(){r.importC.read(i);g_app.projectNavigator.refreshTree();var e=g_app.doc.dir("/screens");var t=e[0].name;g_app.textModeEditor.loadScreen("/screens/"+t);r.importC.doImport();g_app.setMode("2d")})},loadCTMFile:function(i){if(this.importCharPad==null){this.importCharPad=new ImportCharPad;this.importCharPad.init(g_app.textModeEditor)}g_app.doc=new Document;var r=this;g_app.newProject({},function(){r.importCharPad.readCharPad(i);g_app.projectNavigator.refreshTree();var e=g_app.doc.dir("/screens");var t=e[0].name;g_app.textModeEditor.loadScreen("/screens/"+t);r.importCharPad.doImport();g_app.setMode("2d")})},loadSPDFile:function(i){if(this.importSpritePad==null){this.importSpritePad=new ImportSpritePad;this.importSpritePad.init(g_app.textModeEditor)}g_app.doc=new Document;var r=this;g_app.newProject({},function(){g_app.projectNavigator.createSpriteRecord({},function(){r.importSpritePad.readSpritePad(i);g_app.projectNavigator.refreshTree();var e=g_app.doc.dir("/sprites");var t=e[0].name;g_app.projectNavigator.showDocRecord("/sprites/"+t);r.importSpritePad.doImport();g_app.setMode("2d")})})},loadLocalFile:function(e){g_app.doc=new Document;g_app.doc.loadLocalFile(e,function(){g_app.projectNavigator.refreshTree();var e=g_app.doc.dir("/screens");var t=e[0].name;g_app.textModeEditor.loadScreen("/screens/"+t);var i=g_app.doc.getDocRecord("/settings");if(i){if(typeof i.data.currentFGColor!="undefined"){g_app.textModeEditor.currentTile.setColor(i.data.currentFGColor)}if(typeof i.data.currentBGColor!="undefined"){g_app.textModeEditor.currentTile.setBGColor(i.data.currentBGColor)}if(typeof i.data.selectedLayerId!="undefined"){g_app.textModeEditor.layers.selectLayer(i.data.selectedLayerId)}}g_app.setMode("2d");g_app.textModeEditor.tools.drawTools.tilePalette.resize()})},openLocalFile:function(){document.getElementById("loadData").click()},getBrowserStorageFileId:function(e){var t=localStorage.getItem("directory");if(typeof t=="undefined"||!t){return false}t=$.parseJSON(t);var i=false;for(var r=0;r<t.length;r++){if(t[r].filename==e){return t[r].fileId}}return false},loadBrowserStorageProject:function(e){var t=localStorage.getItem(e);if(!t){alert("Unable to load file");return}this.loadLocalFile(t)},loadBrowserStorageTemplate:function(e){var t=localStorage.getItem(e);if(!t){alert("Unable to load file");return}var i=$.parseJSON(t);var r={template:i.children};g_app.newProject(r)},deleteBrowserStorageProjectOld:function(e){var t=localStorage.getItem("directory");if(typeof t=="undefined"||!t){t=[]}else{t=$.parseJSON(t)}var i=false;for(var r=0;r<t.length;r++){if(t[r].fileId==e){i=r;break}}if(i===false){return}t.splice(i,1);localStorage.setItem("directory",JSON.stringify(t));localStorage.removeItem(e)},removeBrowserStorageFiles:function(e,t,i){if(t>=e.length){i()}else{var r=e[t++];if(true){var a=this;localforage.removeItem(r,function(){a.removeBrowserStorageFiles(e,t,i)})}else{this.removeBrowserStorageFiles(e,t,i)}}},checkCacheExpiry:function(n){var h=this;localforage.getItem("cachedir",function(e,t){var i=t;if(typeof i==="undefined"||!i){i=[]}var r=Date.now();var a=[];var s=[];for(var o=0;o<i.length;o++){var l=i[o].key;if(l!=="undefined"){if(i[o].expiryDate<r){s.push(i[o].key)}else{a.push(i[o])}}}localforage.setItem("cachedir",a,function(e){h.removeBrowserStorageFiles(s,0,function(){if(typeof n!="undefined"){n()}})})})},cacheFile:function(n,h,d,c){var e=this;localforage.getItem("cachedir",function(e,t){var i=t;if(typeof i==="undefined"||!i){i=[]}var r=false;for(var a=0;a<i.length;a++){if(i[a].key==n){r=a;break}}var s=new Date;var o=Date.now()+d*1e3;var l={key:n,expiryDate:o};if(r!==false){i[r]=l}else{i.push(l)}localforage.setItem("cachedir",i,function(e){localforage.setItem(n,h,function(e){if(typeof c!="undefined"){c(e)}})})})},getCacheFile:function(e,i){this.checkCacheExpiry(function(){localforage.getItem(e,function(e,t){if(typeof t=="undefined"){i(null)}i(t)})})},autosave:function(){var e=g_app.doc.data;var t=g_app.projectNavigator.getCurrentEditor();if(t&&typeof t.getThumbnailCanvas!=="undefined"){thumbnailCanvas=t.getThumbnailCanvas();if(thumbnailCanvas){thumbnailData=thumbnailCanvas.toDataURL()}}localforage.setItem("__autosaveData",e,function(e){if(typeof thumbnailData!=="undefined"){localforage.setItem("__autosaveThumbnail",thumbnailData,function(e){})}})},getAutosaveSummary:function(i){localforage.getItem("__autosaveThumbnail",function(e,t){if(e!=null){i({success:false})}else{i({success:true,thumbnailData:t})}})},loadCachedData:function(e,t){g_app.doc=new Document;g_app.doc.data=e.data;var i=false;if(typeof e.view!=="undefined"){i=e.view}g_app.projectNavigator.refreshTree();var r=g_app.doc.dir("/screens");if(r&&r.length>0){var a=r[0].name;if(i===false){i="/screens/"+a}i=i.trim();if(i.length>0&&i[0]!="/"){i="/"+i}}var s=g_app.doc.getDocRecord(i);if(!s){i=false}if(i){g_app.projectNavigator.showDocRecord(i)}else{g_app.setMode("none")}if(typeof t!="undefined"){t()}},loadAutosave:function(){localforage.getItem("__autosaveData",function(e,t){if(e==null){g_app.doc=new Document;g_app.doc.data=t;g_app.projectNavigator.refreshTree();var i=g_app.doc.dir("/screens");var r=i[0].name;g_app.textModeEditor.loadScreen("/screens/"+r);var a=g_app.doc.getDocRecord("/settings");if(a){if(typeof a.data.currentFGColor!="undefined"){g_app.textModeEditor.currentTile.setColor(a.data.currentFGColor)}if(typeof a.data.currentBGColor!="undefined"){g_app.textModeEditor.currentTile.setBGColor(a.data.currentBGColor)}if(typeof a.data.selectedLayerId!="undefined"){g_app.textModeEditor.layers.selectLayer(a.data.selectedLayerId)}}g_app.setMode("2d")}})},setProjectName:function(e){this.filename=e},getProjectName:function(){return this.filename},getFilename:function(){return this.filename},getIsNew:function(){return this.isNew},setIsNew:function(e){this.isNew=e},showSaveAs:function(){$("#saveAsForm").show();$("#saveAsGDriveProgress").hide();$("#saveProjectAs").val(this.getFilename());if(this.saveTo){$("#saveMethod_"+this.saveTo).prop("checked",true)}this.checkGDriveAccess();UI.showDialog("saveProjectAsDialog");this.saveInProgress=false;this.saveButton.setEnabled(true);g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true);$("#saveProjectAs").focus();$("#saveProjectAs").select();this.saveAsDialog.fitContent()},showSaveAsTemplate:function(){UI.showDialog("saveAsTemplateDialog");this.saveAsDialog.fitContent()},showDownload:function(){UI.showDialog("downloadAsDialog")},showNewDialog:function(){var e=g_app.getNewProjectDialog();e.show()},saveAs:function(e,a){var s="Untitled";var o="browserStorage";if(typeof e!="undefined"){if(typeof e.filename!="undefined"){s=e.filename}if(typeof e.saveMethod!="undefined"){o=e.saveMethod}}var l=this;if(o=="browserStorage"){this.getProjectId({name:s,type:"project",saveTo:o},function(e){if(e.success){if(!confirm("A project with this name already exists, do you want to overwrite?")){a({success:false});return}l.deleteBrowserStorageProject({projectId:e.projectId},function(e){l.setIsNew(false);l.save({filename:s,saveTo:o},a)});return}l.setIsNew(false);l.save({filename:s,saveTo:o},a)});return}if(o=="googleDrive"){if(!g_app.gdrive.checkIsSignedIn()){alert("Please connect to Google Drive first by clicking the 'Connect To Google Drive' button");return}var l=this;g_app.gdrive.listProjects({name:s},function(e){var t=false;l.googleDriveFileId=false;for(var i=0;i<e.length;i++){var r=e[i].mimeType;if(e[i].name==s||e[i].name==s+".zip"){t=e[i].id;break}}if(t!==false){if(!confirm("A project with this name already exists, do you want to overwrite?")){a({success:false});return}l.googleDriveFileId=t}$("#saveAsForm").hide();$("#saveAsGDriveProgress").show();l.setIsNew(false);l.save({filename:s,saveTo:o,showProgress:false},function(e){a(e)})})}},save:function(e,i){if(this.getIsNew()){this.showSaveAs();return}var t=this.filename;var r=this.saveTo;var a=true;if(typeof e!="undefined"){if(typeof e.filename!="undefined"){t=e.filename}if(typeof e.saveTo!="undefined"){r=e.saveTo}if(typeof e.showProgress!="undefined"){a=e.showProgress}}this.filename=t;this.saveTo=r;this.setIsNew(false);if(this.saveTo=="browserStorage"){if(typeof persistStorage!="undefined"){persistStorage()}g_app.doc.saveToBrowserStorage({filename:t});if(typeof i!=="undefined"){i({success:true})}return}if(this.saveTo=="googleDrive"){var s=this;if(this.gDriveSaveInProgress){console.log("save in progress!");return}this.gDriveSaveInProgress=true;try{g_app.gdrive.saveProject({fileId:this.googleDriveFileId,filename:this.filename,showProgress:a},function(e){s.gDriveSaveInProgress=false;s.filename=e.name;var t=s.filename.lastIndexOf(".");if(t!==-1){s.filename.substr(0,t)}s.googleDriveFileId=e.id;if(typeof i!=="undefined"){i({success:true})}})}catch(e){alert("error encountered: "+e.message);s.gDriveSaveInProgress=false;console.error("GDRIVE SAVE EXCEPTION CAUGHT!!!");console.log(e)}}},downloadAs:function(e){var t=e.filename;g_app.doc.downloadAs(t,{});return true},deleteBrowserStorageFiles:function(e){if(this.filesDeleted>=this.filesToDelete.length){this.filesDeleted=0;this.filesToDelete=[];e()}else{var t=this.filesToDelete[this.filesDeleted].id;var i=this;localforage.removeItem(t,function(){i.filesDeleted++;i.deleteBrowserStorageFiles(e)})}},deleteBrowserStorageProject:function(e,s){var o=e.projectId;var i=this;this.getProjectFiles({projectId:o},function(e){var t=e.files;i.filesToDelete=t;i.filesDeleted=0;i.deleteBrowserStorageFiles(function(){localforage.removeItem(o,function(){localforage.removeItem(o+"-thumbnail",function(){localforage.getItem("projects",function(e,t){var i=[];var r=[];if(t!=="undefined"&&t!==null&&typeof t.length!=="undefined"){i=t}for(var a=0;a<i.length;a++){if(i[a].id!=o){r.push(i[a])}}localforage.setItem("projects",r,function(){s()})})})})})})},getRepositoryTreeFiles:function(i,r,a,s,o){var l=r[s];var e=false;for(var t=0;t<a.length;t++){if(a[t].path==l.path&&a[t].sha==l.sha){e=t;break}}if(e===false){s++;if(s>=r.length){o()}else{this.getRepositoryTreeFiles(i,r,a,s,o)}return}var n=a[e].id;var h=true;if(l.path.indexOf("asm/")===0||l.path.indexOf("scripts/")===0||l.path.indexOf("build/")===0||l.path.indexOf("config/")==0){h=false}var d=this;this.getBrowserFile({fileId:n},function(e){var t=false;if(h&&isString(e.content)){t=$.parseJSON(e.content)}else{t=e.content}i[l.path]={id:n,data:t};s++;if(s>=r.length){o()}else{d.getRepositoryTreeFiles(i,r,a,s,o)}})},getRepositoryFiles:function(e,i,r){var a={};var s=this;var t={};t.name=e;t.type="repository";this.getProjectId(t,function(e){if(e.success===false){r({});return}else{var t=e.projectId;s.getProjectFiles({projectId:t},function(e){s.getRepositoryTreeFiles(a,i,[],0,function(){r(a)})})}})},saveProjectRepositoryDetails:function(e,r){var a=this.filename;var s="project";var o=e.owner;var l=e.repository;var t=this;localforage.getItem("projects",function(e,t){for(var i=0;i<t.length;i++){if(t[i].name==a&&t[i].type==s){t[i].githubRepository=l;t[i].githubOwner=o;break}}localforage.setItem("projects",t,function(e){if(typeof r!=="undefined"){r()}})})},updateFileSHA:function(e,l,t,n){var i=this.filename;var r=this;this.getProjectId({name:i},function(e){var o=e.projectId;r.getProjectFiles({projectId:o},function(e){var t=e.files;for(var i=0;i<l.length;i++){var r="/"+l[i].path;var a=l[i].sha;for(var s=0;s<t.length;s++){if(r==t[s].path){t[s].sha=a;break}}}localforage.setItem(o,t,function(e){n()})})})},getUniqueProjectName:function(e,o){var l=e;g_app.fileManager.getProjectList({type:"project"},function(e){var t=e.projects;var i=true;var r=l;var a=0;while(i){i=false;for(var s=0;s<t.length;s++){if(t[s].type=="project"&&t[s].name==r){i=true;a++;r=l+"-"+a;break}}}o(l)})},saveProject:function(e,h){var d=this;var c=e.name;var f="project";if(typeof e.type!="undefined"){f=e.type}var u=false;if(typeof e.currentPath!="undefined"){u=e.currentPath}var p=false;var v=false;if(typeof e.owner!="undefined"&&typeof e.repository!="undefined"){v=e.owner;p=e.repository}var g=null;if(typeof e.thumbnailData!="undefined"){g=e.thumbnailData}var m=false;if(typeof e.projectNavVisible!="undefined"){m=e.projectNavVisible}var t=new Date;var y=t.getTime();try{localforage.getItem("projects",function(e,t){var i=[];if(t!=="undefined"&&t!==null&&typeof t.length!=="undefined"){i=t}var r=false;for(var a=0;a<i.length;a++){if(i[a].name==c&&i[a].type==f){r=a;break}}if(r!==false){var s=i[r].id;i[r].lastModified=y;i[r].currentPath=u;i[r].projectNavVisible=m;if(p!==false){t[r].githubRepository=p;t[r].githubOwner=v}localforage.setItem("projects",i,function(e){localforage.setItem(s+"-thumbnail",g,function(e){h({success:true,projectId:s})})});return;d.deleteBrowserStorageProject({projectId:o},function(e){localforage.setItem("projects",i,function(e){localforage.setItem(o+"-thumbnail",g,function(e){h({success:true,projectId:o})})})})}else{if(r===false){var o="";var l=false;while(!l){o=g_app.getGuid();l=true;for(var a=0;a<i.length;a++){if(i[a].id===o){l=false;break}}}var n={id:o,name:c,type:f,lastModified:y,projectNavVisible:m};if(p!==false){n["githubRepository"]=p;n["githubOwner"]=v}if(u!==false){n.currentPath=u}i.push(n)}localforage.setItem("projects",i,function(e){localforage.setItem(o+"-thumbnail",g,function(e){h({success:true,projectId:o})})})}})}catch(e){alert("uh oh, an error occurred while trying to save the project information");console.log(e)}},deleteToDeleteList:function(e,t){var i=0;if(typeof t!="undefined"){i=t}if(this.toDeleteList.length==0||i>1e4){e();return}var r=this.toDeleteList[this.toDeleteList.length-1];var a=this;this.deleteBrowserStorageProject({projectId:r.id},function(){if(a.toDeleteList.length>0){a.toDeleteList.length=a.toDeleteList.length-1;a.deleteToDeleteList(e,i++)}else{e()}})},clearRepositoriesCache:function(t){var i=this;this.getProjectList({type:"repository"},function(e){if(e.success){i.toDeleteList=e.projects;i.deleteToDeleteList(function(){t()})}})},getProjectThumbnails:function(i){if(this.projectThumbnailsLoaded>=this.projectList.length){i({success:true,projects:this.projectList});this.projectList=[];return}var r=this;var e=this.projectList[this.projectThumbnailsLoaded];var t=e.id;localforage.getItem(t+"-thumbnail",function(e,t){if(r.projectThumbnailsLoaded<r.projectList.length){r.projectList[r.projectThumbnailsLoaded].thumbnailData=t}r.projectThumbnailsLoaded++;r.getProjectThumbnails(i)})},getProjectList:function(e,r){var a="project";var s=true;if(typeof e.type!="undefined"){a=e.type}if(typeof e.thumbnails!="undefined"){s=e.thumbnails}var o=this;localforage.getItem("projects",function(e,t){o.projectList=[];if(t!=="undefined"&&t!=null&&typeof t.length!=="undefined"){for(var i=0;i<t.length;i++){if(t[i].type==a){o.projectList.push(t[i])}}}if(s){o.projectThumbnailsLoaded=0;o.getProjectThumbnails(r)}else{r({success:true,projects:o.projectList})}})},getProjectId:function(e,r){var a=e.name;var s="project";if(typeof e.type!="undefined"){s=e.type}this.getProjectList({type:s},function(e){var t=e.projects;for(var i=0;i<t.length;i++){if(t[i].type==s&&t[i].name==a){r({success:true,projectId:t[i].id});return}}r({success:false})})},saveFile:function(e,t){var i=e.file;var r=false;if(typeof e.fileId!="undefined"&&e.fileId!==false){r=e.fileId}else{r=g_app.getGuid()}localforage.setItem(r,i.content,function(e){t({success:true,fileId:r})})},getBrowserFile:function(e,i){var t=e.fileId;localforage.getItem(t,function(e,t){i({success:true,content:t})})},getProjectFiles:function(e,r){var t=e.projectId;try{localforage.getItem(t,function(e,t){var i=[];if(typeof t!="undefined"&&t!==null){i=t}r({files:i})})}catch(e){alert("coudn't get list of current project files");console.log(e)}},renameProject:function(e,a){var s=e.projectId;var o=e.name;localforage.getItem("projects",function(e,t){var i=[];if(t!=="undefined"&&t!=null&&typeof t.length!=="undefined"){for(var r=0;r<t.length;r++){if(t[r].id==s){t[r].name=o}}}localforage.setItem("projects",t,function(e,t){a({success:true})})})},openFilesFromBrowser:function(t){if(this.filesToOpen.length==0){t({});return}var i=this;var r=this.filesToOpen[this.filesOpenedCount];var a=r.path;var e=r.id;this.getBrowserFile({fileId:e},function(e){if(typeof r.deleted=="undefined"||r.deleted!==true){i.openedFiles.push({path:a,content:e.content})}i.filesOpenedCount++;if(i.filesOpenedCount>=i.filesToOpen.length){i.filesOpenedCount=0;i.filesToOpen=[];t({})}else{i.openFilesFromBrowser(t)}})},downloadZip:function(e){var t=new JSZip;var i={};var r=e.files;var a=e.filename;for(var s=0;s<r.length;s++){var o="file";var l="";var n=r[s].path.lastIndexOf(".");if(n!=-1){l=r[s].path.substr(n+1)}if(l==""&&r[s].content==""){o="folder"}var h=r[s].path.split("/");var d="";var c=t;var f=h.length-1;if(o=="folder"){f++}for(var u=0;u<f;u++){if(u!=0){d+="/"}d+=h[u];if(typeof i[d]=="undefined"){c=c.folder(h[u]);i[d]=c}else{c=i[d]}}if(o!="folder"){var p=h[h.length-1];var l="";var v=p.lastIndexOf(".");if(v!==-1){l=p.substr(v+1).toLowerCase()}var g="";if(l=="prg"||l=="bin"){c.file(p,r[s].content,{base64:true})}else{if(typeof r[s].content!=="string"){g=JSON.stringify(r[s].content)}else{g=r[s].content}c.file(p,g)}}}t.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}).then(function(e){download(e,a+".zip","application/zip")})},downloadProject:function(e){var t=e.projectId;var i=this;var r=e.filename;this.getProjectFiles({projectId:t},function(e){i.filesToOpen=e.files;i.filesOpenedCount=0;i.openedFiles=[];console.log(e.files);i.openFilesFromBrowser(function(e){console.log(i.openedFiles);i.downloadZip({filename:r,files:i.openedFiles})})})}};var ImportOld=function(){this.editor=null};ImportOld.prototype={init:function(e){this.editor=e},getGuid:function(){e=generateUUID();return e;var e=settings.data.guid++;return e},read:function(e){console.log(e);var t=40;var i=25;var r=8;var a=8;var s=this.getGuid();var o=this.getGuid();var l="cell";var n="textmode";for(var h=0;h<e.children.length;h++){e.children[h].id=this.getGuid();if(e.children[h].name=="screens"){}if(e.children[h].name=="color palettes"){e.children[h].children[0].id=o}if(e.children[h].name=="tile sets"){e.children[h].children[0].id=s;a=e.children[h].children[0].data.width;r=e.children[h].children[0].data.height;for(var d=0;d<e.children[h].children[0].children.length;d++){if(e.children[h].children[0].children[d].name=="block sets"){for(var c=0;c<e.children[h].children[0].children[d].children.length;c++){if(e.children[h].children[0].children[d].children[c].type=="block set"){var f=e.children[h].children[0].children[d].children[c].data;for(var u=0;u<f.blocks.length;u++){var p=f.blocks[u].data;for(var v=0;v<p.length;v++){for(var g=0;g<p[v].length;g++){p[v][g].t=p[v][g].c;delete p[v][g].c}}}}}}}}}var m={};m.children=[];m.data={};m.id=this.getGuid();m.type="graphic";for(var h=0;h<e.children.length;h++){if(e.children[h].name=="screens"){var y=e.children[h].children[0];m.name=y.name;n=y.screenMode;if(typeof y.colorPerMode!="undefined"){l=y.colorPerMode}if(n=="monochrome"){n="textmode"}var b=y.data.frames;var C=y.data.layers;t=y.data.width;i=y.data.height;var x=[];var S=[];for(var d=0;d<C.length;d++){var P=C[d];var w=this.getGuid();var I=P.type;if(I=="background"){}var k=false;var M=r;var T=a;var D={blockMode:k,cellHeight:r,cellWidth:a,colorPaletteId:o,colorPerMode:l,compositeOperation:P.compositeOperation,gridHeight:i,gridWidth:t,label:P.label,layerId:w,opacity:P.opacity,screenMode:n,tileSetId:s,type:I,visible:P.visible,frames:[]};if(I!=="background"){S.push(D)}}var E=true;for(var d=0;d<b.length;d++){x.push({duration:b[d].duration});for(var c=0;c<C.length;c++){var $=[];var _=-1;var B=-1;if(C[c].type=="background"){_=b[d].bgColor;B=b[d].borderColor;for(var v=0;v<i;v++){$[v]=[];for(var g=0;g<t;g++){var R={t:32,fc:0,bc:-1,fh:0,fv:0};$[v].push(R)}}}else{var A=C[c].gridZ;var F=b[d].data[A];for(var v=0;v<F.length;v++){$[v]=[];for(var g=0;g<F[v].length;g++){var R={};for(var L in F[v][g]){if(L=="c"){R["t"]=F[v][g]["c"]}else{R[L]=F[v][g][L]}}$[v][g]=R}}var U={data:$};U.bgColor=b[d].bgColor;U.borderColor=b[d].borderColor;U.c64Multi1Color=b[d].c64Multi1Color;U.c64Multi2Color=b[d].c64Multi2Color;S[c-1].frames.push(U)}}}m.data.width=a*t;m.data.height=r*i;m.data.frames=x;m.data.layers=S;e.children[h].children[0]=m}}}};var DesktopFileManager=function(){this.editor=null};DesktopFileManager.prototype={init:function(e){this.editor=e;console.log("new desktop file manager!!!!!!!!!!!!!!!!!!")}};function bufferToBase64(e){var t=Array.prototype.map.call(e,function(e){return String.fromCharCode(e)}).join("");return btoa(t)}function base64ToBuffer(e){var t=atob(e);var i=new Uint8Array(t.length);Array.prototype.forEach.call(t,function(e,t){i[t]=e.charCodeAt(0)});return i}function isString(e){return typeof e==="string"||e instanceof String}var Document=function(){this.data={};this.savingToBrowserStorage=false;this.binaryExtensions=["prg","bin","rom","nes"];this.modified={}};Document.prototype={init:function(e){if(typeof e!="undefined"){this.editor=e}else{this.editor=g_app}this.data={children:[{id:1,name:"settings",type:"hiddenfile",data:{guid:1}}]}},deleteDocRecord:function(e){var t=e.lastIndexOf("/");if(t==-1){return false}var i=e.substring(0,t);var r=e.substring(t+1);var a=this.getDocRecord(i);if(!a){return false}var s=a.children;var o=false;for(var l=0;l<s.length;l++){if(s[l].name==r){o=l;break}}if(o===false){return false}var n=s[o];s[o].deleted=true;this.recordModified(n,e);return true},getTypeFromPath:function(e){if(e.length===0){return}if(e[0]=="/"){e=e.substr(1)}var t=e.split("/");var i="";var r=e.lastIndexOf(".");if(r!=-1){i=e.substr(r+1);i=i.toLowerCase().trim()}if(i!=""&&i!="json"){return i}switch(t[0]){case"screens":return"screen";break;case"sprites":return"sprite";break;case"3d scenes":return"3d scene";break}},setDocRecord:function(e,t){var i=this.getDocRecord(e);if(i){i.data=t}else{var r=e.split("/");var a="";for(var s=1;s<r.length;s++){var o=r[s];a=a+"/";var i=this.getDocRecord(a+o);if(!i){type="folder";data={};if(s==r.length-1){type=this.getTypeFromPath(e);data=t}if(a.length>1){a=a.substr(0,a.length-1)}this.createDocRecord(a,o,type,data);if(a.length>1){a+="/"}}a+=o}}},createDocRecord:function(e,t,i,r,a){var s=a;if(typeof a=="undefined"||a===false){s=g_app.getGuid()}var o=this.getDocRecord(e);var l={id:s,name:t,type:i,data:r,children:[]};o.children.push(l);if(e[e.length-1]!="/"){e+="/"}this.recordModified(l,e+t);return l},getDocRecordById:function(e,t){var i=null;if(typeof t!="undefined"){var i=this.getDocRecord(t)}if(i){var r=i.children;for(var a=0;a<r.length;a++){if(r[a].id==e){return r[a]}}}return null},hasVersion:function(e,t){if(e.length>0&&e[0]!="/"){e="/"+e}var i=this.getDocRecord(e);if(i==null){console.log("record doesn't exist!!!!!!");return false}if(typeof i.sha=="undefined"){console.log("record doesnt have a sha!!!");return true}if(i.sha!=t){if(i.sha!="modified"){return false}}return false},recordSaved:function(e){if(this.modified.hasOwnProperty(e)){delete this.modified[e]}},recordModified:function(e,t){var i=e.id;if(e.sha!=="modified"){e.sha="modified";g_app.projectNavigator.updateModifiedList()}if(!this.modified.hasOwnProperty(i)){this.modified[i]={path:t}}},getDocRecord:function(e){if(e=="/"){return this.data}e=e.trim();if(e.length==0||e[0]!="/"){e=this.currentDirectory+e}var t=e.split("/");var i=this.data;for(var r=1;r<t.length;r++){var a=t[r];var s=i.children;i=null;for(var o=0;o<s.length;o++){if(s[o].name==a){i=s[o];break}}if(i==null){return null}}return i},dir:function(e){var t=this.getDocRecord(e);if(t==null){return null}return t.children},folderExists:function(e,t){var i=false;if(typeof t!="undefined"){i=t}var r=e.split("/");var a="";var s=this.getDocRecord("/");var o=true;for(var l=0;l<r.length;l++){var n=r[l].trim();var h=a;if(n!==""){a+="/"+n}var d=this.getDocRecord(a);if(d==null){o=false;if(t){this.createDocRecord(h,n,"folder",{})}else{return false}}}return o},checkFormat:function(e){var t=false;if(typeof e.children=="undefined"){return}for(var i=0;i<e.children.length;i++){if(e.children[i].name=="screens"){if(e.children[i].children[0].type=="textmode"){t=true;break}}}if(t){var r=new ImportOld;r.read(e)}},loadJSONExport:function(i,r){g_app.newProject({},function(){if(typeof i.tileSet!="undefined"){var e=g_app.textModeEditor.tileSetManager.getCurrentTileSet();if(e){e.readJsonDataV1({jsonData:i.tileSet});g_app.textModeEditor.tileSetManager.tileSetUpdated({updateBlankCells:true,updateSortMethods:true})}}if(typeof i.colorPalette!="undefined"){var t=g_app.textModeEditor.colorPaletteManager.getCurrentColorPalette();if(t){t.loadFromJSON(i.colorPalette)}}if(typeof i.tileMap!="undefined"){g_app.textModeEditor.graphic.loadJSON(i.tileMap)}r()})},loadLocalFile:function(e,t){if(e[0]=="{"||e[0]=="["){var i=$.parseJSON(e);if(typeof i.tileMap!="undefined"&&typeof i.tileMap.layers!="undefined"||typeof i.tileSet!="undefined"&&typeof i.tileSet.tiles!="undefined"||typeof i.colorPalette!="undefined"&&typeof i.colorPalettel.data!="undefiend"){this.loadJSONExport(i,t);return}this.checkFormat(i);this.data=i;if(t!="undefined"){t()}}else{var r=this;var a=new JSZip;a.loadAsync(e,{base64:true}).then(function(e){e.file("data.json").async("string").then(function(e){var e=$.parseJSON(e);r.checkFormat(e);r.data=e;if(t!="undefined"){t()}})})}},downloadAs:function(t,e){var i=JSON.stringify(this.data);if(t.indexOf(".zip")==-1){t+=".zip"}this.createZipFile({},function(e){download(e,t,"application/zip")})},addRecord:function(e){var t=e.path;var i=e.content;var r=e.sha;var a=false;if(typeof e.deleted!="undefined"){a=e.deleted}if(t.length>0&&t[0]!="/"){t="/"+t}var s=e.id;try{var o=t.lastIndexOf("/");var l=t.substring(0,o).trim();while(l.length>0&&l[0]==="/"){l=l.substr(1)}var n=t.substring(o+1);var h="";var d=n.lastIndexOf(".");if(d!==-1){h=n.substring(d+1).trim().toLowerCase()}if(h=="json"&&(l=="color palettes"||l=="tile sets"||l=="screens"||l=="sprites"||l=="music"||l=="3d scenes")){n=n.substring(0,d)}this.folderExists(l,true);var c=this.getDocRecord(t);switch(l){case"color palettes":if(isString(i)){i=$.parseJSON(i)}var s=i.id;if(!c){var f=g_app.textModeEditor.colorPaletteManager.createColorPalette({id:s,name:n});c=this.getDocRecordById(f,"/color palettes")}else{if(typeof s!="undefined"){c.id=s}}var u=g_app.textModeEditor.colorPaletteManager.getColorPalette(c.id);u.loadFromJSON(i);break;case"tile sets":if(isString(i)){i=$.parseJSON(i)}if(i!=null){var s=i.id;if(!c){var p=g_app.textModeEditor.tileSetManager.createTileSet({id:s,name:n});c=this.getDocRecordById(p,"/tile sets")}else{if(typeof s!="undefined"){c.id=s}}var v=g_app.textModeEditor.tileSetManager.getTileSet(c.id);v.readJsonDataV1({jsonData:i})}else{console.error("tileset data is NULL!!!!!!");console.log(g_app.doc)}break;case"screens":case"sprites":if(isString(i)){i=$.parseJSON(i)}if(typeof i.id==="undefined"){i.id=g_app.getGuid()}if(!c){c=this.createDocRecord("/"+l,n,"graphic",i,i.id)}else{c.id=i.id;c.data=i}break;case"3d scenes":console.error("ADD A 3d SCENE!!!");if(isString(i)){i=$.parseJSON(i)}if(typeof i.id==="undefined"){i.id=g_app.getGuid()}if(!c){c=this.createDocRecord("/"+l,n,"3d scene",i,i.id)}else{c.id=i.id;c.data=i}break;case"music":if(isString(i)){i=$.parseJSON(i)}if(typeof i.id=="undefined"){i.id=g_app.getGuid()}if(!c){c=this.createDocRecord("/"+l,n,"music",i,i.id)}else{c.id=i.id;c.data=i}break;default:var g="";if(h=="s"||h=="asm"||h=="dasm"){g="asm"}else if(h=="js"){g="script"}else{g=h}if(!c){c=this.createDocRecord("/"+l,n,g,i)}else{c.data=i}break}c.sha=r;c.deleted=a}catch(e){console.log("error");console.log(e)}},isBinary:function(e){var t="";var i=e.lastIndexOf(".");if(i!==-1){t=e.substr(i+1).toLowerCase()}return this.binaryExtensions.indexOf(t)!==-1},processZipContents:function(t,i,r,a){var s=this;var e=t[i].zipEntry;var o=t[i].relativePath;var l=e.name;var n="";var h=l.lastIndexOf(".");if(h!==-1){n=l.substr(h+1).toLowerCase()}var d="text";var c=s.binaryExtensions.indexOf(n)!==-1;if(c){d="base64"}r.file(l).async(d).then(function(e){if(n=="json"){e=$.parseJSON(e)}s.addRecord({path:l,content:e,sha:""});i++;if(i>=t.length){a()}else{s.processZipContents(t,i,r,a)}})},loadZipFile:function(e,a){var s=this;JSZip.loadAsync(e).then(function(e){try{var i=0;var r=[];e.forEach(function(e,t){if(!t.dir){i++;r.push({relativePath:e,zipEntry:t})}});var t=0;s.processZipContents(r,0,e,function(){s.openDoc();if(typeof a!="undefined"){a()}})}catch(e){console.log("error");console.log(e)}},function(e){console.log(e)})},createZipFile:function(e,t){var i=this.getFiles({});var r=new JSZip;var a={};for(var s=0;s<i.length;s++){if(typeof i[s].deleted=="undefined"||i[s].deleted!==true){var o="file";if(typeof i[s].type!=="undefined"){o=i[s].type}var l=i[s].path.split("/");var n="";var h=r;var d=l.length-1;if(o=="folder"){d++}for(var c=0;c<d;c++){if(c!=0){n+="/"}n+=l[c];if(typeof a[n]=="undefined"){h=h.folder(l[c]);a[n]=h}else{h=a[n]}}if(o!="folder"){var f=l[l.length-1];var u="";var p=f.lastIndexOf(".");if(p!==-1){u=f.substr(p+1).toLowerCase()}var v="";if(u=="prg"||u=="bin"){h.file(f,i[s].content,{base64:true})}else{if(typeof i[s].content!=="string"){v=JSON.stringify(i[s].content)}else{v=i[s].content}h.file(f,v)}}}}r.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}).then(function(e){if(typeof t!="undefined"){t(e)}})},openDoc:function(e){try{g_app.doc=this;var t=false;if(typeof e!="undefined"){if(typeof e.view!=="undefined"){t=e.view}}g_app.projectNavigator.refreshTree();var i=g_app.doc.dir("/screens");if(i&&i.length>0){var r=i[0].name;if(t===false){t="/screens/"+r}t=t.trim();if(t.length>0&&t[0]!="/"){t="/"+t}}if(t!==false){var a=g_app.doc.getDocRecord(t);if(!a){t=false}}if(t!=false){g_app.projectNavigator.showDocRecord(t)}else{g_app.setMode("none")}}catch(e){console.log(e)}},getModifiedRecordsList:function(e){var t="";var i=[];if(typeof e!="undefined"){if(typeof e.parentFolder!="undefined"){t=e.parentFolder}}var r=g_app.doc;var a=r.dir(t);for(var s=0;s<a.length;s++){if(a[s].type!="hiddenfile"){var o=a[s];var l=o.type;var n=o.id;var h=o.name;var d="";if(typeof o.sha!=="undefined"){d=o.sha}var c="";var f=h.lastIndexOf(".");if(f!==-1){c=h.substring(f+1).toLowerCase()}var l=a[s].type;switch(l){case"folder":var u=t+"/"+h;var p=this.getModifiedRecordsList({parentFolder:u});if(p.length>0){for(var v=0;v<p.length;v++){i.push(p[v])}}break;default:if(d==="modified"){i.push({name:h,path:t+"/"+h})}break}}}return i},getFiles:function(e){var t="";var i=false;var r=true;var a=[];if(typeof e!="undefined"){if(typeof e.parentFolder!="undefined"){t=e.parentFolder}if(typeof e.doStringify!="undefined"){i=e.doStringify}if(typeof e.includeEmptyFolders!="undefined"){r=e.includeEmptyFolders}}var s=g_app.doc;var o=s.dir(t);for(var l=0;l<o.length;l++){if(o[l].type!="hiddenfile"){var n=o[l];var h=n.type;var d=n.id;var c=n.name;var f="";var u=false;if(typeof n.sha!=="undefined"){f=n.sha}if(typeof n.deleted!="undefined"){u=n.deleted}var p="";var v=c.lastIndexOf(".");if(v!==-1){p=c.substring(v+1).toLowerCase()}var g=this.binaryExtensions.indexOf(p)!==-1;var h=o[l].type;switch(h){case"folder":var m=t+"/"+c;var y=this.getFiles({doStringify:i,parentFolder:m,includeEmptyFolders:r});if(y.length>0){for(var b=0;b<y.length;b++){a.push(y[b])}}else{if(r){a.push({id:d,deleted:u,name:c,content:"",type:"folder",path:t+"/"+c})}}break;case"tile set":var C=g_app.textModeEditor.tileSetManager.getTileSet(d);if(C){var x=C.getJSON();var S=c+".json";var P=x;if(i){P=JSON.stringify(x)}a.push({type:"json",deleted:u,sha:f,id:d,content:P,path:t+"/"+S})}break;case"color palette":var w=g_app.textModeEditor.colorPaletteManager.getColorPalette(d);if(w){var I=w.getJSON();var S=c+".json";var P=I;if(i){P=JSON.stringify(I)}a.push({id:d,deleted:u,type:"json",sha:f,content:P,path:t+"/"+S})}break;case"music":var k=n.data;var S=c+".json";var P=k;if(i){P=JSON.stringify(k)}a.push({id:d,deleted:u,type:"json",sha:f,content:P,path:t+"/"+S});break;case"graphic":case"3d scene":var k=n.data;var S=c+".json";var P=k;if(i){P=JSON.stringify(k)}a.push({id:d,deleted:u,type:"json",sha:f,content:P,path:t+"/"+S});break;case"asm":default:var P=n.data;var h="string";var M="";if(g){h="blob";M="base64"}else{if(p=="json"&&i&&!isString(P)){P=JSON.stringify(P,null,2)}}a.push({id:d,deleted:u,type:h,sha:f,encoding:M,content:P,path:t+"/"+c});break}}}return a},saveFilesToBrowser:function(s){var e=g_app.fileManager;var o=this;var l=this.filesToSave[this.savedFiles];var n=false;var t=false;for(var i=0;i<this.projectFiles.length;i++){if(this.projectFiles[i].path==l.path){t=this.projectFiles[i].id;n=i;break}}if(typeof l.deleted!="undefined"&&l.deleted){l.content=""}e.saveFile({file:l,fileId:t},function(e){var t="";if(typeof l.sha!="undefined"){t=l.sha}var i=false;if(typeof l.deleted!="undefined"){i=l.deleted}var r=new Date;var a={path:l.path,lastModified:r.getTime(),sha:t,id:e.fileId,deleted:i};if(n!==false){o.projectFiles[n]=a}else{o.projectFiles.push(a)}o.recordSaved(l.id);o.savedFiles++;if(o.savedFiles>=o.filesToSave.length){o.filesToSave=[];o.savedFiles=0;localforage.setItem(o.currentProjectId,o.projectFiles,function(e){s({})})}else{o.saveFilesToBrowser(s)}})},saveToBrowserStorage:function(e,t){var i=this;var r=getTimestamp();if(this.savingToBrowserStorage){if(r-this.saveStartedAt<5e3){return}}var a=null;this.saveStartedAt=r;this.savingToBrowserStorage=true;var s=g_app.projectNavigator.getCurrentEditor();var o=g_app.projectNavigator.getCurrentPath();var l=g_app.projectNavigator.getVisible();console.log("GET THUMBNAIL CANAS FROM EDITOR");try{if(s&&typeof s.getThumbnailCanvas!=="undefined"){thumbnailCanvas=s.getThumbnailCanvas();if(thumbnailCanvas){a=thumbnailCanvas.toDataURL()}}}catch(e){}var n=e.filename;var h="project";var d=g_app.fileManager;this.filesToSave=this.getFiles();this.savedFiles=0;var c={name:n,type:h};c["currentPath"]=o;c["projectNavVisible"]=l;c["thumbnailData"]=a;if(typeof e.owner!="undefined"){c["owner"]=e.owner}if(typeof e.repository!="undefined"){c["repository"]=e.repository}d.saveProject(c,function(e){i.currentProjectId=e.projectId;d.getProjectFiles({projectId:i.currentProjectId},function(e){i.projectFiles=e.files;i.saveFilesToBrowser(function(){var e=getTimestamp()-i.saveStartedAt;i.savingToBrowserStorage=false;console.log("save done, took: "+e);if(typeof t!="undefined"){t()}})})})},openFilesFromBrowser:function(t){if(this.filesToOpen.length==0){t({});return}var e=g_app.fileManager;var i=this;var r=this.filesToOpen[this.filesOpenedCount];var a=r.path;var s=r.id;var o="";if(typeof r.sha!="undefined"){o=r.sha}var l=false;if(typeof r.deleted!="undefined"){l=r.deleted}e.getBrowserFile({fileId:s},function(e){i.addRecord({path:a,id:s,deleted:l,sha:o,content:e.content});i.filesOpenedCount++;if(i.filesOpenedCount>=i.filesToOpen.length){i.filesOpenedCount=0;i.filesToOpen=[];t({})}else{i.openFilesFromBrowser(t)}})},openBrowserStorageProject:function(e,t){var i=e.projectId;var r=false;var a=false;var s=true;if(typeof e.githubOwner!="undefined"&&typeof e.githubRepository!="undefined"){r=e.githubOwner;a=e.githubRepository;if(typeof e.githubCheck!="undefined"){s=e.githubCheck}}var o=this;var l=g_app.fileManager;l.getProjectFiles({projectId:i},function(e){o.filesToOpen=e.files;o.filesOpenedCount=0;o.openFilesFromBrowser(function(e){if(r&&a){g_app.github.setRepositoryDetails(r,a);if(!g_app.isOnline()){if(confirm("You do not seem to be online, do you want to load offline version?")){t(e)}}else if(s){g_app.github.doCheckForUpdatedFiles(function(){t(e)})}else{t(e)}}else{t(e)}})})}};var GDrive=function(){this.clientId="673634360731-12v9nmqqaeablrq76htpm73jthktae4i.apps.googleusercontent.com";this.apiKey="AIzaSyAuSjHOq2_3RYn4fwBRRMqXSOON2SxjxCY";this.clientId="778997112136-5fdbsmc9o1td7m07fo9jpopkm9gp0gch.apps.googleusercontent.com";this.apiKey="AIzaSyDhavt6Zes2iw_q9pU2N3WlMfRAI3YYbYk";this.discoveryDocs=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];this.scopes="https://www.googleapis.com/auth/drive.file";this.accessToken="";this.currentUser=false;this.callback=false;this.clientLoaded=false;this.currentProjectId=false;this.currentProjectName=false;this.progressElement=null};GDrive.prototype={init:function(){},handleClientLoad:function(){try{var e=this;gapi.load("client:auth2",function(){e.initClient()})}catch(e){}},initClient:function(){var t=this;gapi.client.init({apiKey:this.apiKey,clientId:this.clientId,discoveryDocs:this.discoveryDocs,scope:this.scopes}).then(function(){t.clientLoaded=true;gapi.auth2.getAuthInstance().isSignedIn.listen(function(e){t.updateSigninStatus(e)});t.updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());g_app.startPage.gdriveStatusUpdated()},function(e){console.log(e);g_app.startPage.gdriveStatusUpdated()})},updateSigninStatus:function(e){if(e){this.currentUser=gapi.auth2.getAuthInstance().currentUser.get();var t=this.currentUser.getAuthResponse(true);this.accessToken=t.access_token;$("#startGoogleDriveConnected").show();$("#startGoogleDriveNotConnected").hide();$("#startGoogleDriveConnectedMobile").show();$("#startGoogleDriveNotConnectedMobile").hide();$("#saveAsConnectToGDriveButtonSection").hide();if(this.callback!==false){this.callback();this.callback=false}this.listProjects({},function(e){})}else{this.accessToken="";this.currentUser=false;$("#startGoogleDriveConnected").hide();$("#startGoogleDriveNotConnected").show();$("#startGoogleDriveConnectedMobile").hide();$("#startGoogleDriveNotConnectedMobile").show();$("#saveAsConnectToGDriveButtonSection").show();this.listProjects({},function(e){})}},checkIsSignedIn:function(){try{if(!gapi.auth2.getAuthInstance().isSignedIn.get()){this.updateSigninStatus(false);return false}this.currentUser=gapi.auth2.getAuthInstance().currentUser.get();if(!this.currentUser){this.updateSigninStatus(false);return false}var e=this.currentUser.getAuthResponse(true);if(!e){this.updateSigninStatus(false);return false}this.accessToken=e.access_token;this.updateSigninStatus(this.accessToken!="");return this.accessToken!=""}catch(e){this.accessToken="";return false}},handleAuthClick:function(e){if(!this.checkIsSignedIn()){if(typeof e!="undefined"){this.callback=e}gapi.auth2.getAuthInstance().signIn()}else{if(typeof e!="undefined"){e()}}},handleSignoutClick:function(){try{gapi.auth2.getAuthInstance().signOut().then(function(){gapi.auth2.getAuthInstance().disconnect()})}catch(e){console.error("error on signout");console.log(e)}},handleUploadProgress:function(e){var t=0;var i=e.loaded||e.position;var r=e.total;if(e.lengthComputable){t=Math.ceil(i/r*100)}},uploadToAppFolder:function(t,i,r){var a=this;this.getAppFolderId(function(e){a.doUpload(false,e,t,i,r)})},setFolderId:function(e,t,i){var r=this;$.ajax({url:"https://www.googleapis.com/drive/v3/files/"+t+"?addParents="+e,type:"PATCH",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify({addParents:e,fileId:t}),processData:false,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer"+" "+r.accessToken)},xhr:function(){var e=$.ajaxSettings.xhr();if(e.upload){e.upload.addEventListener("progress",function(e){if(typeof callbacks!="undefined"&&typeof callbacks.progress!="undefined"){}},false)}return e},success:function(e){i(e)},error:function(e){if(typeof callbacks!="undefined"&&typeof callbacks.error!="undefined"){}console.log("ERROR!!!");console.log(e)},async:true,cache:false,timeout:6e4})},downloadFile:function(e,t,i){var r=new XMLHttpRequest;var a=false;if(typeof gapi!="undefined"&&typeof gapi.auth2!="undefiend"){a=gapi.auth2.getAuthInstance().isSignedIn.get()}if(a){r.open("GET","https://www.googleapis.com/drive/v3/files/"+e+"?alt=media",true);var s=gapi.auth.getToken().access_token;r.setRequestHeader("Authorization","Bearer "+s)}else{r.open("GET","https://drive.google.com/uc?export=download&id="+e,true)}r.responseType="blob";r.onload=function(){if(typeof i!="undefined"){i(r.response)}};r.send()},doUpload:function(e,t,i,r,a){try{var s="application/bin";var o="";var l=r.lastIndexOf(".");if(l!==-1){o=r.substr(l+1).toLowerCase()}switch(o){case"gif":s="image/gif";break;case"png":s="image/png";break;case"json":s="application/json";break;case"zip":s="application/zip";break}var n={name:r,mimeType:s,parents:[t]};var h=gapi.auth.getToken().access_token;var d=new FormData;d.append("metadata",new Blob([JSON.stringify(n)],{type:"application/json"}));d.append("file",i);var c=new XMLHttpRequest;if(e!==false){c.open("PATCH","https://www.googleapis.com/upload/drive/v3/files/"+e)}else{c.open("post","https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name")}c.setRequestHeader("Authorization","Bearer "+h);c.responseType="json";c.onload=function(){if(typeof a!="undefined"&&typeof a.success!="undefined"){a.success(c.response)}};c.send(d)}catch(e){if(typeof a!="undefined"&&typeof a.error!="undefined"){a.error(e)}}},doUploadold:function(e,t,i,r){var a=new FormData;a.append("file",t,i);a.append("upload_file",true);a.append("uploadType","media");a.append("parents",JSON.stringify([e]));var s=this;$.ajax({type:"POST",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer"+" "+s.accessToken)},url:"https://www.googleapis.com/upload/drive/v3/files",xhr:function(){var e=$.ajaxSettings.xhr();if(e.upload){e.upload.addEventListener("progress",function(e){if(typeof r!="undefined"&&typeof r.progress!="undefined"){r.progress(e)}},false)}return e},success:function(e){if(typeof r!="undefined"&&typeof r.success!="undefined"){var t=e.id;r.success(e)}},error:function(e){if(typeof r!="undefined"&&typeof r.error!="undefined"){r.error(e)}console.log(e)},async:true,data:a,cache:false,contentType:false,processData:false,timeout:6e4})},createFolderold:function(e){var t={name:"lvllvl",mimeType:"application/vnd.google-apps.folder"};gapi.client.drive.files.create({resource:t,fields:"id"},function(e,t){if(e){console.error(e)}else{}})},createFolder:function(e,t,i){try{var r="application/vnd.google-apps.folder";var a={name:t,mimeType:r};if(e!==false){a["parents"]=[e]}var s=gapi.auth.getToken().access_token;var o=new FormData;o.append("metadata",new Blob([JSON.stringify(a)],{type:"application/json"}));var l=new XMLHttpRequest;l.open("post","https://www.googleapis.com/upload/drive/v3/files?fields=id");l.setRequestHeader("Authorization","Bearer "+s);l.responseType="json";l.onload=function(){if(typeof i!="undefined"&&typeof i.success!="undefined"){i.success(l.response)}};l.send(o)}catch(e){if(typeof i!="undefined"&&typeof i.error!="undefined"){i.error(e)}}},createFolderOld2:function(e,t){var i=this;$.ajax({url:"https://www.googleapis.com/drive/v2/files",type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify({title:e,mimeType:"application/vnd.google-apps.folder"}),processData:false,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer"+" "+i.accessToken)},xhr:function(){var e=$.ajaxSettings.xhr();if(e.upload){e.upload.addEventListener("progress",function(e){if(typeof t!="undefined"&&typeof t.progress!="undefined"){t.progress(e)}},false)}return e},success:function(e){if(typeof t!="undefined"&&typeof t.success!="undefined"){t.success(e)}},error:function(e){if(typeof t!="undefined"&&typeof t.error!="undefined"){t.error(e)}console.log(e)},async:true,cache:false,timeout:6e4})},getAppFolderId:function(i){var r=this;gapi.client.drive.files.list({q:"name='lvllvl' and trashed != true",pageSize:10,fields:"nextPageToken, files(id, name, parents)"}).then(function(e){var t=e.result.files;if(t.length===0){r.createFolder(false,"lvllvl",{success:function(e){var t=e.id;i(t)}})}else{i(t[0].id)}})},getProjectFolderId:function(r){var a=this;this.getAppFolderId(function(i){gapi.client.drive.files.list({q:"name='projects' and '"+i+"' in parents and trashed != true",pageSize:10,fields:"nextPageToken, files(id, name, parents)"}).then(function(e){var t=e.result.files;if(t.length===0){a.createFolder(i,"projects",{success:function(e){var t=e.id;r(t)}})}else{r(t[0].id)}})})},listFiles:function(i){gapi.client.drive.files.list({pageSize:10,fields:"nextPageToken, files(id, name)"}).then(function(e){var t=e.result.files;i(t)})},listProjects:function(r,s){var e=g_app.startPage;if(this.accessToken==""){e.googleDriveProjectList=[];e.drawProjects();return}var t=this;this.getProjectFolderId(function(e){var t=" '"+e+"' in parents  and trashed != true";if(typeof r!="undefined"){if(typeof r.name!="undefined"){var i=r.name;t+=" and ( name = '"+i+"' or name = '"+i+".zip')"}}gapi.client.drive.files.list({pageSize:100,fields:"nextPageToken, files(id, name,modifiedTime,size,webContentLink,webViewLink, mimeType)",q:t}).then(function(e){var t=e.result.files;if(typeof s!="undefined"){s(t)}var i=g_app.startPage;i.googleDriveProjectList=[];for(var r=0;r<t.length;r++){var a=Date.parse(t[r].modifiedTime);i.googleDriveProjectList.push({name:t[r].name,id:t[r].id,webContentLink:t[r].webContentLink,webViewLink:t[r].webViewLink,lastModified:a})}i.drawProjects()})})},uploadToProjectFolder:function(t,i,r,a){var s=this;this.getProjectFolderId(function(e){s.doUpload(i,e,t,r,a)})},showProgress:function(e){var t="save";if(typeof e!="undefined"){t=e}var i=180;var r=30;if(this.progressElement==null){this.progressElement=document.createElement("div");this.progressElement.setAttribute("id","gdriveProgress");this.progressElement.setAttribute("style","display: none; color: #aaaaaa; background-color: #111111; position: absolute; top: 0; right: 0;  width: "+i+"px; height: "+r+"px");document.body.append(this.progressElement)}var a="";if(t=="save"){a+='<div style="display: flex; justify-content: center; align-items: center; padding: 4px">';a+='<img src="icons/GoogleDriveIcon512.png" height="20">';a+='<span style="margin-left: 8px">Saving to Google Drive...</span>';a+="</div>"}if(t=="open"){a+='<div style="display: flex; justify-content: center; align-items: center; padding: 4px">';a+='<img src="icons/GoogleDriveIcon512.png" height="20">';a+='<span style="margin-left: 8px">Opening From Google Drive...</span>';a+="</div>"}$("#gdriveProgress").html(a);$("#gdriveProgress").show()},hideProgress:function(){$("#gdriveProgress").hide()},saveProject:function(e,t){var i="untitled";var r=false;var a=false;if(typeof e!="undefined"){if(typeof e.filename!="undefined"){i=e.filename}if(typeof e.fileId!="undefined"){r=e.fileId}if(typeof e.showProgress!="undefined"){a=e.showProgress}}i+=".zip";if(a){this.showProgress()}var s=this;g_app.doc.createZipFile({},function(e){s.uploadToProjectFolder(e,r,i,{success:function(e){if(a){s.hideProgress()}t(e)}})});return;var o=JSON.stringify(g_app.doc.data);var l="";var n=i.lastIndexOf(".");if(n!==-1){l=i.substr(n+1).toLowerCase()}if(l!="json"){i+=".json"}this.uploadToProjectFolder(o,i,{success:t});console.log("SAVE TO GOOGLE DRIVE!!!!")},openProject:function(i){var r=this;this.showProgress("open");this.downloadFile(i.id,i.name,function(e){g_app.doc=new Document;g_app.doc.init(g_app);g_app.createDocumentStructure(g_app.doc);g_app.doc.loadZipFile(e,function(){var e=i.name;var t=e.lastIndexOf(".");if(t!=-1){e=e.substr(0,t)}g_app.fileManager.saveTo="googleDrive";g_app.fileManager.filename=e;g_app.fileManager.googleDriveFileId=i.id;r.currentProjectId=i.id;r.currentProjectName=e;r.hideProgress()})})}};var SpriteEditor=function(){};SpriteEditor.prototype={init:function(){var e=this},buildInterface:function(e){var t=UI.create("UI.SplitPanel",{id:"spriteEditor"});e.add(t);var i=UI.create("UI.HTMLPanel",{id:"spriteToolsPanel"});t.addWest(i,72,true);var r=UI.create("UI.HTMLPanel",{id:"spriteLayersPanel"});t.addEast(r,172,true);var a=UI.create("UI.Panel",{id:"spriteGridPanel"});t.add(a)}};function deprecated(e){}var TextModeEditor=function(){this.graphic=null;this.tileSetManager=null;this.colorPaletteManager=null;this.blockSetManager=null;this.importImage=null;this.importC64Formats=null;this.importC64SpriteFormats=null;this.importSpriteImage=null;this.importAssembly=null;this.tools=null;this.doc=null;this.type="2d";this.mode="draw";this.tileEditor=null;this.tileEditorMobile=null;this.blockEditor=null;this.textModeFile=null;this.info=null;this.colorPalettePanel=null;this.colorEditor=null;this.chooseColorsDialog=null;this.chooseCharactersDialog=null;this.toPrg=null;this.toPrgAdvanced=null;this.export3dGifDialog=null;this.exportImageDialog=null;this.exportGifDialog=null;this.exportSvgDialog=null;this.exportGifMobileDialog=null;this.gridDimensionsDialog=null;this.cursorTileTransparent=false;this.exportFrameImage=null;this.exportPngDialog=null;this.exportSpritePngDialog=null;this.checkerboardPattern=null;this.exportPngMobileDialog=null;this.exportJson=null;this.exportTxt=null;this.exportBinaryData=null;this.exportSpriteBinaryData=null;this.exportC64Assembly=null;this.exportMega65Assembly=null;this.exportX16Basic=null;this.exportX16Basic=null;this.exportC64SpriteAssembly=null;this.exportSEQ=null;this.exportPetsciiC=null;this.exportVox=null;this.exportObj=null;this.info=null;this.backgroundImage=null;this.importShaderEditor=null;this.replaceColorDialog=null;this.replaceCharacterDialog=null;this.referenceImageDialog=null;this.referenceImageDialogMobile=null;this.editColorPaletteDialog=null;this.colorPaletteEdit=null;this.tilePaletteEditor=null;this.frames=null;this.shiftDown=false;this.altDown=false;this.ctrlDown=false;this.cmdDown=false;this.screenMode=TextModeEditor.Mode.TEXTMODE;this.invertY=true;this.mobileMenu=null;this.lastSelectAnimate=0;this.gridVisible=true;this.grid3d=null;this.screenModeDialog=null;this.editorMode="tile";this.histories={};this.openingDoc=false};TextModeEditor.Mode={};TextModeEditor.Mode.TEXTMODE="textmode";TextModeEditor.Mode.C64STANDARD="c64standard";TextModeEditor.Mode.C64MULTICOLOR="c64multicolor";TextModeEditor.Mode.C64ECM="c64ecm";TextModeEditor.Mode.NES="nes";TextModeEditor.Mode.INDEXED="indexed";TextModeEditor.Mode.RGB="rgb";TextModeEditor.Mode.VECTOR="vector";TextModeEditor.prototype={getThumbnailCanvas:function(){return this.graphic.getThumbnailCanvas()},setAlterKeys:function(e){this.shiftDown=e.shiftKey;this.ctrlDown=e.ctrlKey;this.altDown=e.altKey;this.cmdDown=e.metaKey},initEvents:function(){},saveSettings:function(e){if(this.doc===null){return}var t={};t.currentTile=this.currentTile.getCharacters();t.fgColor=this.currentTile.getColor();t.bgColor=this.currentTile.getBGColor();var i=this.gridView2d.getCameraPosition();t.cameraX=i.x;t.cameraY=i.y;t.scale=this.gridView2d.getScale();t.currentFrame=this.graphic.getCurrentFrame();e[this.doc.id]=t},restoreSettings:function(e){var t=false;var i=false;var r=false;if(typeof this.doc.data!="undefined"&&typeof this.doc.data.settings!="undefined"){var a=this.doc.data.settings;if(typeof a.currentFgColor!="undefined"){i=a.currentFgColor}if(typeof a.currentBgColor!="undefined"){r=a.currentBgColor}}if(this.type!="3d"){if(typeof e=="undefined"||!e.hasOwnProperty(this.doc.id)){this.gridView2d.fitOnScreen({});return}}var a=e[this.doc.id];if(typeof a=="undefined"||!a){return}if(typeof a.currentTile!="undefined"){this.currentTile.setCharacters(a.currentTile)}if(i!==false){this.currentTile.setColor(i)}else{if(typeof a.fgColor!="undefined"){this.currentTile.setColor(a.fgColor)}}if(r!==false){this.currentTile.setBGColor(r)}else{if(typeof a.bgColor!="undefined"){this.currentTile.setBGColor(a.bgColor)}}if(this.type!="3d"){var s=false;var o=false;var l=false;var n=false;if(typeof a.cameraX!="undefined"){s=a.cameraX}if(typeof a.cameraY!="undefined"){o=a.cameraY}if(typeof a.scale!="undefined"){l=a.scale}if(s!==false&&o!==false){this.gridView2d.setCameraPosition(s,o)}if(l!==false){this.gridView2d.setScale(l)}}var n=false;if(typeof a.currentFrame!="undefined"){n=a.currentFrame}if(n!==false){this.frames.gotoFrame(n)}},preload:function(){this.preloadImage=new Image;this.preloadImage.onload=function(){};this.preloadImage.src="charsets/petscii.png";this.preloadImage2=new Image;this.preloadImage2.onload=function(){};this.preloadImage2.src="palettes/c64_colodore.png"},loadPreferences:function(){var e=g_app.getPref("textmode.cursortiletransparent");if(typeof e!="undefined"&&e!=null){this.setCursorTileTransparent(parseInt(e,10)==1)}},init:function(){var e=this;this.colorPaletteManager=new ColorPaletteManager;this.colorPaletteManager.init(this);this.preload();UI.on("ready",function(){e.initEvents();e.graphic=new Graphic;e.graphic.init(e);e.checkerboardPattern=new CheckerboardPattern;e.exportFrameImage=new ExportFrameImage;e.exportFrameImage.init(e);e.tileSetManager=new TileSetManager;e.tileSetManager.init(e);e.blockSetManager=new BlockSetManager;e.blockSetManager.init(e);e.grid=new Grid;e.grid.init(e);e.grid3d=new Grid3d;e.grid3d.init(e);if(UI.exists("gridView3d")){e.gridView3d=new GridView3d;e.gridView3d.init(e,UI("gridView3d"),{view:"3d"});UI("gridView3d").resize();e.gridViewFront=new GridView3d;e.gridViewFront.init(e,UI("gridViewFrontWebGL"),{view:"front"});UI("gridViewFrontWebGL").resize();e.gridViewTop=new GridView3d;e.gridViewTop.init(e,UI("gridViewTopWebGL"),{view:"top"});UI("gridViewTopWebGL").resize()}e.gridView2d=new GridView2d;e.gridView2d.init(e,UI("gridView2d"));e.layers=new Layers;e.layers.init(e);e.layers.buildInterface(UI("layersPanel"));e.frames=new Frames;e.frames.init(e);e.frames.buildInterface(UI("framesPanel"));e.frames.buildMobileInterface(UI("framesMobilePanel"));e.importImage=new ImportImage;e.importImage.init(e);e.importAssembly=new ImportAssembly;e.importAssembly.init(e);e.importC64Formats=new ImportC64Formats;e.importC64Formats.init(e);e.importC64SpriteFormats=new ImportC64SpriteFormats;e.importC64SpriteFormats.init(e);e.chooseColorsDialog=new ChooseColorsDialog;e.chooseColorsDialog.init(e);e.chooseCharactersDialog=new ChooseCharactersDialog;e.chooseCharactersDialog.init(e);e.backgroundImage=new BackgroundImage;e.backgroundImage.init(e);e.toPrg=new ToPRG;e.toPrg.init(e);e.toPrgAdv=new ToPRGAdv;e.toPrgAdv.init(e);e.exportC64=new ExportC64Dialog;e.exportC64.init(e);e.textModeFile=new TextModeFile;e.textModeFile.init(e)})},modified:function(){if(g_app.openingProject){return}g_app.doc.recordModified(this.doc,this.path)},createDoc:function(c,f){var u=g_app.doc;var p="/screens";if(typeof c.parentPath!="undefined"){p=c.parentPath}var v=c.name;var e=c.colorPalette;var g=c.gridWidth;var m=c.gridHeight;var y=8;var b=8;if(typeof c.cellWidth!="undefined"){y=c.cellWidth}if(typeof c.cellHeight!="undefined"){b=c.cellHeight}var C=TextModeEditor.Mode.TEXTMODE;if(typeof c.screenMode!="undefined"){C=c.screenMode}if(C=="monochrome"){C=TextModeEditor.Mode.TEXTMODE}var x=this;var t={};if(typeof c.tileSetArgs!="undefined"){t=c.tileSetArgs}else if(typeof c.tileSetPresetId!="undefined"){t.preset=c.tileSetPresetId}if(typeof c.tileSet!="undefined"&&c.tileSet!=null){t.preset=false;t.tileSet=c.tileSet}t.tileSetName="Tile Set";if(typeof c.tileSetName!="undefined"){t.tileSetName=c.tileSetName}if(typeof c.tileSetId!="undefined"&&c.tileSetId!=""){t.tileSetId=c.tileSetId}var i={};i.preset=c.colorPalettePresetId;if(typeof c.colorPaletteId!="undefined"&&c.colorPaletteId!=""){i.colorPaletteId=c.colorPaletteId}i.colorPalette=c.colorPalette;i.colorPaletteName="Colour Palette";if(typeof c.colorPaletteName!="undefined"){i.colorPaletteName=c.colorPaletteName}this.colorPaletteManager.addColorPaletteToDoc(i,function(d){x.tileSetManager.addTileSetToDoc(t,function(e){var t=x.tileSetManager.getTileSet(e);if(p=="/screens"){if(t&&t.getTileCount()==0){t.setTileCount(1)}}y=t.getTileWidth();b=t.getTileHeight();var i=6;var r=14;var a={label:"Layer 0",visible:true,opacity:1,layerId:g_app.getGuid(),screenMode:C,colorPerMode:"cell",compositeOperation:"source-over",blockMode:false,cellWidth:y,cellHeight:b,colorPaletteId:d,tileSetId:e,type:"grid",gridWidth:g,gridHeight:m,frames:[]};if(typeof c.canFlipTile!="undefined"){a.hasTileFlip=c.canFlipTile}if(typeof c.canRotateTile!="undefined"){a.hasTileRotate=c.canRotateTile}var s=g_app.getGuid();var o=g*y;var l=m*b;var n={id:s,width:o,height:l,frames:[],layers:[a]};var h=u.createDocRecord(p,v,"graphic",n,s);if(typeof f!=="undefined"){f(h)}})})},setupHistory:function(){var e=this.doc.id;if(this.histories.hasOwnProperty(e)){this.history=this.histories[e]}else{this.history=new History;this.history.init(this);this.histories[e]=this.history}},open3d:function(e,t){var i=this.tools.drawTools.tilePalette.tilePaletteDisplay;var r=false;if(i){r=i.getDrawEnabled();i.setDrawEnabled(false)}var a=this.colorPalettePanel.colorPaletteDisplay;var s=false;if(a){s=a.getDrawEnabled();a.setDrawEnabled(false)}this.path=e;this.doc=g_app.doc.getDocRecord(e);this.grid3d.connectToDoc();this.tools.drawTools.setDrawTool("pen");this.restoreSettings(t);var o=this.currentTile.getTiles();if(o===false||o.length===0){this.currentTile.setCharacters([[0]])}this.setupHistory();if(i){i.setDrawEnabled(r);this.tools.drawTools.tilePalette.drawTilePalette({redrawTiles:true})}if(a){a.setDrawEnabled(s);a.draw()}},loadScreen:function(e,t){var i=this.tools.drawTools.tilePalette.tilePaletteDisplay;var r=this.sideTilePalette.tilePaletteDisplay;var a=false;if(i){a=i.getDrawEnabled();i.setDrawEnabled(false)}var s=false;if(r){s=r.getDrawEnabled();r.setDrawEnabled(false)}var o=this.colorPalettePanel.colorPaletteDisplay;var l=false;if(o){l=o.getDrawEnabled();o.setDrawEnabled(false)}try{if(this.path===e){}this.path=e;var n=this.path.indexOf("/sprites/")===0;this.doc=g_app.doc.getDocRecord(this.path);if(this.doc==null){alert("couldn't open");return}this.setupHistory();var h=0;var d=0;var c=0;var f=0;var u=0;var p=0;for(var v=0;v<this.doc.data.layers.length;v++){var g=this.doc.data.layers[v];var m=g.cellWidth*g.gridWidth;var y=g.cellHeight*g.gridHeight;if(g.gridWidth>h){h=g.gridWidth}if(g.gridHeight>d){d=g.gridHeight}if(g.cellWidth>c){c=g.cellWidth}if(g.cellHeight>f){f=g.cellHeight}if(m>u){u=m}if(y>p){p=y}}if(typeof this.doc.data.width=="undefined"){this.doc.data.width=u;this.doc.data.height=p}this.graphic.gridWidth=h;this.graphic.gridHeight=d;this.graphic.cellWidth=c;this.graphic.cellHeight=f;if(n){this.setEditorMode("pixel");this.graphic.type="sprite";this.setLayoutType("sprite")}else{this.setEditorMode("tile");this.graphic.type="screen";this.setLayoutType("textmode")}var b=this.graphic.getDrawEnabled();this.graphic.setDrawEnabled(false);var C=false;var x=false;var S=false;if(typeof this.doc.data!="undefined"&&typeof this.doc.data.settings!="undefined"){var t=this.doc.data.settings;if(typeof t.currentTile!="undefined"){C=t.currentTile}if(typeof t.currentFgColor!="undefined"){x=t.currentFgColor}if(typeof t.currentBgColor!="undefined"){S=t.currentBgColor}}var P=0;this.graphic.connectToDoc();if(typeof t!="undefined"&&typeof t[this.doc.id]!="undefined"){if(typeof t[this.doc.id].currentFrame!="undefined"){P=t[this.doc.id].currentFrame}}if(this.graphic.getFrameCount()==0){this.graphic.setFrameCount(1);P=0}this.graphic.setCurrentFrame(P);var w=this.layers.getLayerId(0);this.layers.selectLayer(w);if(this.editorMode=="pixel"){this.tools.pixelDrawTools.setDrawTool("pen")}else{this.tools.drawTools.setDrawTool("pen")}this.colorPaletteManager.colorPaletteUpdated();if(x===false){x=0;var g=this.layers.getSelectedLayerObject();if(g&&typeof g.getColorPalette!="undefined"){var I=g.getColorPalette();if(I){if(I.getColorCount()==16){x=14}}}if(g&&typeof g.getBackgroundColor!="undefined"){if(x==0&&g.getBackgroundColor()==0){x=1}}}if(x!==false){this.currentTile.setColor(x)}if(S===false){S=this.colorPaletteManager.noColor}this.currentTile.setBGColor(S);C=0;if(C!==false){this.currentTile.setTiles([[this.tileSetManager.noTile]]);this.setSelectedTiles([[C]])}this.frames.frameTimeline.resize();this.frames.updateFrameInfo();this.graphic.setDrawEnabled(b);if(this.type!="3d"){this.graphic.invalidateAllCells();this.gridView2d.previousScreenFrame=false;this.gridView2d.findViewBounds();this.graphic.redraw({allCells:true});this.restoreSettings(t);this.graphic.setDrawEnabled(false);this.updateBlockModeInterface()}this.graphic.setDrawEnabled(b);this.tools.drawTools.tilePalette.resize();this.sideTilePalette.resize();this.setupMenu()}catch(e){console.log(e.message);console.log(e)}if(i){i.setDrawEnabled(a);this.tools.drawTools.tilePalette.drawTilePalette({redrawTiles:true})}if(r){r.setDrawEnabled(s);this.sideTilePalette.drawTilePalette({redrawTiles:true})}if(this.tools.drawTools.blockPalette){this.tools.drawTools.blockPalette.drawBlockPalette()}if(this.sideBlockPalette){this.sideBlockPalette.drawBlockPalette()}if(o){o.setDrawEnabled(l);o.draw()}},startNew:function(e,t){alert("start new");this.frames.stop();this.frames.clear();this.colorPaletteManager.reset();var i=40;var r=25;var a=1;if(typeof e.width!=="undefined"){i=e.width}if(typeof e.height!=="undefined"){a=e.height}if(typeof e.depth!=="undefined"){r=e.depth}var s="c64_colodore";var o="petscii";if(typeof e.colorPalette!="undefined"){s=e.colorPalette}if(typeof e.tileSet!="undefined"){o=e.tileSet}this.colorPaletteManager.reset();this.colorPaletteManager.userPresetColorPalette(s);this.tileSetManager.reset();this.tileSetManager.userPresetTileSet(o,function(){this.frames.setFrameCount(1);this.frames.setCurrentFrame(0);this.frames.setDimensions(i,a,r);if(t){t()}})},setSelectedTiles:function(e){var t=this.tools.drawTools;if(t.tilePalette){t.tilePalette.selectedGridChanged(e);t.tilePalette.drawTilePalette();this.sideTilePalette.selectedGridChanged(e);this.sideTilePalette.drawTilePalette()}this.currentTile.setCharacters(e)},redrawTilePalettes:function(){var e=this.tools.drawTools;if(e.tilePalette){e.tilePalette.drawTilePalette({redrawTiles:true});this.sideTilePalette.drawTilePalette({redrawTiles:true})}},load:function(e){this.textModeFile.load(e)},getSaveData:function(){return this.textModeFile.getSaveData()},getBlockModeEnabled:function(){var e=this.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return false}return e.getBlockModeEnabled()},updateBlockModeInterface:function(){var e=this.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return}if(e.getBlockModeEnabled()){$("#infoTableBlock").show();UI("mode-blockmode").setChecked(true);UI("mode-blocksize").setEnabled(true);UI("colorpermode-cell").setEnabled(false);UI("colorpermode-block").setEnabled(true)}else{$("#infoTableBlock").hide();UI("mode-blockmode").setChecked(false);UI("mode-blocksize").setEnabled(false);UI("colorpermode-cell").setEnabled(true);UI("colorpermode-block").setEnabled(false)}var t=e.getColorPerMode();UI("colorpermode-cell").setChecked(false);UI("colorpermode-character").setChecked(false);UI("colorpermode-block").setChecked(false);this.setInterfaceColorPerMode(t)},updateInterfaceTileOrientation:function(){UI("mode-tileflip").setChecked(this.getHasTileFlip());UI("mode-tilerotate").setChecked(this.getHasTileRotate());this.currentTile.setOrientationToolsVisibility()},updateInterfaceTileMaterials:function(){UI("mode-tilematerials").setChecked(this.getHasTileMaterials());this.currentTile.setMaterialsVisibility()},getHasTileFlip:function(){return this.graphic.getHasTileFlip()},setHasTileFlip:function(e){this.graphic.setHasTileFlip(e);this.updateInterfaceTileOrientation();this.currentTile.refresh();this.graphic.redraw({allCells:true});var t=this.layers.getSelectedLayerObject();this.layers.updateLayerLabel(t.getId())},getHasTileRotate:function(){return this.graphic.getHasTileRotate()},setHasTileRotate:function(e){this.graphic.setHasTileRotate(e);this.updateInterfaceTileOrientation();this.currentTile.refresh();this.graphic.redraw({allCells:true});var t=this.layers.getSelectedLayerObject();this.layers.updateLayerLabel(t.getId())},getHasTileMaterials:function(){return this.graphic.getHasTileMaterials()},setHasTileMaterials:function(e){this.graphic.setHasTileMaterials(e);this.updateInterfaceTileMaterials()},setBlockModeEnabled:function(r){var a=this.layers.getSelectedLayerObject();if(!a||a.getType()!="grid"){alert("please choose a grid layer");return}if(r){var s=this;this.blockSetManager.showBlockSizeDialog(function(e,t,i){s.blockSetManager.checkBlockMode(e,t);a.setBlockModeEnabled(r);a.setBlockDimensions(e,t);a.setColorPerMode(i);s.graphic.redraw({allCells:true});s.updateBlockModeInterface();s.setInterfaceColorPerMode(i);s.layers.updateLayerLabel(a.getId());s.startBlockTool()})}else{a.setBlockModeEnabled(r);this.graphic.redraw({allCells:true});this.updateBlockModeInterface();if(a.getColorPerMode()=="block"){a.setColorPerMode("cell");UI("colorpermode-cell").setChecked(true);UI("colorpermode-block").setChecked(false)}this.layers.updateLayerLabel(a.getId());this.startBlockTool()}},showDimensionsDialog:function(){if(this.gridDimensionsDialog==null){this.gridDimensionsDialog=new GridDimensionsDialog;this.gridDimensionsDialog.init(this)}this.gridDimensionsDialog.showDimensions()},cropToSelection:function(){this.tools.drawTools.select.cropToSelection()},showBlockSizeDialog:function(){var r=this.layers.getSelectedLayerObject();if(!r||r.getType()!="grid"){alert("please choose a grid layer");return}var a=this;this.blockSetManager.showBlockSizeDialog(function(e,t,i){a.blockSetManager.checkBlockMode(e,t);r.setBlockModeEnabled(true);r.setBlockDimensions(e,t);r.setColorPerMode(i);a.graphic.redraw({allCells:true})})},setColorPerMode:function(e){var t=this.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){alert("please choose a grid layer");return}t.setColorPerMode(e);this.setInterfaceColorPerMode(e);this.graphic.redraw({allCells:true})},getColorPerMode:function(){var e=this.layers.getSelectedLayerObject();if(e&&typeof e.getColorPerMode!="undefined"){return e.getColorPerMode()}return"cell"},getScreenMode:function(){var e=this.layers.getSelectedLayerObject();if(e&&typeof e.getScreenMode!="undefined"){return e.getMode()}return TextModeEditor.Mode.TEXTMODE},getGridVisible:function(){if(this.type=="3d"){return this.grid3d.getGridVisible()}else{return this.gridVisible}},setGridVisible:function(e){if(this.type=="3d"){this.grid3d.setGridVisible(e)}else{this.gridVisible=e;UI("edit-showgrid").setChecked(e)}},syncColorPickers:function(){var e=this.currentTile.getColor();this.currentTile.setColor(e,{update:false});this.updateBackgroundColorPicker();this.updateBorderColorPicker();this.updateC64MultiColorPickers();this.colorsUpdated()},updateCurrentColorToSpriteColor:function(){if(this.graphic.getType()=="sprite"){var e=this.layers.getSelectedLayerObject();if(e&&e.getType()=="grid"){var t=e.getCell({x:0,y:0});if(t){this.currentTile.setColor(t.fc)}}}},updateC64MultiColorPickers:function(){var e=this.layers.getSelectedLayerObject();if(!e){return}if(typeof e.getColorPalette=="undefined"){return}var t=e.getColorPalette();if(!t){return}if(typeof e.getC64Multi1Color!="undefined"){var i=e.getC64Multi1Color();var r=t.getHexString(i);$(".c64Multi1Color").css("background-color","#"+t.getHexString(i));$(".c64Multi1ColorDisplay").css("background-color","#"+t.getHexString(i))}if(typeof e.getC64Multi2Color!="undefined"){var i=e.getC64Multi2Color();var r=t.getHexString(i);$(".c64Multi2Color").css("background-color","#"+t.getHexString(i));$(".c64Multi2ColorDisplay").css("background-color","#"+t.getHexString(i))}},tilesUpdated:function(){if(this.doc){this.doc.data.settings={currentTile:this.currentTile.getCharacters(),currentFgColor:this.currentTile.getColor(),currentBgColor:this.currentTile.getBGColor()}}},colorsUpdated:function(){this.tileSetManager.redrawCharacters();if(this.type!="3d"){this.graphic.invalidateAllCells();this.graphic.redraw({allCells:true})}if(typeof this.tools.drawTools.blockPalette&&this.blockEditor){if(this.blockEditor.visible){this.blockEditor.draw()}}this.layers.updateAllLayerPreviews();if(this.doc){this.doc.data.settings={currentTile:this.currentTile.getCharacters(),currentFgColor:this.currentTile.getColor(),currentBgColor:this.currentTile.getBGColor()}}},updateBackgroundColorPicker:function(){var e=this.layers.getSelectedLayerObject();if(!e||typeof e.getBorderColor=="undefined"){return}var t=e.getBackgroundColor();var i=e.getColorPalette();if(!i){return}if(t==this.colorPaletteManager.noColor){$(".backgroundColorMobile").css("background-color","transparent");$(".backgroundColor").css("background-color","transparent");$("#backgroundColor").css("background-image","url('images/transparent.png')");$("#backgroundColorMobile").css("background-image","url('images/transparent.png')");$(".backgroundColorDisplay").css("background-color","#000000");$(".backgroundColorDisplay").html('<i style="color: #cccccc; font-size: 16px; margin-top: -1px" class="halflings halflings-remove"></i>')}else{var r=i.getHexString(t);$(".backgroundColorMobile").html("");$(".backgroundColorMobile").css("background-color","#"+r);$(".backgroundColor").html("");$(".backgroundColor").css("background-color","#"+r);$("#backgroundColor").css("background-image","none");$("#backgroundColorMobile").css("background-image","none");$(".backgroundColorDisplay").html("");$(".backgroundColorDisplay").css("background-color","#"+r)}},getC64ECMColor:function(e){var t=this.layers.getSelectedLayerObject();if(t&&typeof t.getC64ECMColor!="undefined"){return t.getC64ECMColor(e)}return 0},setC64ECMColor:function(e,t,i,r){var a=this.layers.getSelectedLayerObject();if(a&&typeof a.setC64ECMColor!="undefined"){a.setC64ECMColor(e,t,i,r);var s=a.getColorPalette();if(!s){return}this.updateBackgroundColorPicker();if(typeof r==="undefined"||r===true){this.colorsUpdated()}}},setBackgroundColor:function(e,t){var i=this.layers.getSelectedLayerObject();if(i&&typeof i.setBackgroundColor!="undefined"){i.setBackgroundColor(e);var r=i.getColorPalette();if(!r){return}this.updateBackgroundColorPicker();if(typeof t==="undefined"||t===true){this.colorsUpdated()}}},updateBorderColorPicker:function(){var e=this.layers.getSelectedLayerObject();if(!e||typeof e.getBorderColor=="undefined"){return}var t=e.getBorderColor();var i=e.getColorPalette();if(!i){return}if(t==this.colorPaletteManager.noColor){var r=i.getHexString(t);$(".borderColor").css("background-color","transparent");$(".borderColorMobile").css("background-color","transparent");$("#borderColor").css("background-image","url('images/transparent.png')");$("#borderColorMobile").css("background-image","url('images/transparent.png')")}else{var r=i.getHexString(t);$(".borderColor").css("background-color","#"+r);$(".borderColorMobile").css("background-color","#"+r);$("#borderColor").css("background-image","none");$("#borderColorMobile").css("background-image","none")}},setBorderColor:function(e,t){var i=this.layers.getSelectedLayerObject();if(i&&typeof i.setBorderColor!="undefined"){i.setBorderColor(e);var r=i.getColorPalette();if(!r){return}this.updateBorderColorPicker()}},setC64Multi1Color:function(e,t){var i=this.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){return}i.setC64Multi1Color(e);this.updateC64MultiColorPickers();if(typeof t==="undefined"||t===true){this.colorsUpdated()}},setC64Multi2Color:function(e,t){var i=this.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){return}i.setC64Multi2Color(e);this.updateC64MultiColorPickers();if(typeof t==="undefined"||t===true){this.colorsUpdated()}},setInterfaceColorPerMode:function(e){switch(e){case"cell":$("#drawTools-cellColorHeading").html("Cell");break;case"character":$("#drawTools-cellColorHeading").html("Tile");break;case"block":$("#drawTools-cellColorHeading").html(styles.text.blockName);break}UI("colorpermode-cell").setChecked(false);UI("colorpermode-character").setChecked(false);UI("colorpermode-block").setChecked(false);UI("colorpermode-"+e).setChecked(true);this.tileSetManager.tileSetUpdated();this.syncColorPickers();this.colorPaletteManager.colorPaletteUpdated()},setInterfaceScreenMode:function(e){var t=this;var i=this.grid.getUpdateEnabled();this.grid.setUpdateEnabled(false);switch(e){case TextModeEditor.Mode.TEXTMODE:case TextModeEditor.Mode.C64ECM:case TextModeEditor.Mode.C64STANDARD:this.screenMode=TextModeEditor.Mode.TEXTMODE;this.layers.setBackgroundEnabled(true);this.currentTile.setBGColor(this.colorPaletteManager.noColor);break;case TextModeEditor.Mode.C64MULTICOLOR:this.screenMode=TextModeEditor.Mode.C64MULTICOLOR;this.currentTile.setColor(this.currentTile.getColor(),{force:true});this.currentTile.setBGColor(this.colorPaletteManager.noColor);this.grid.setBorderEnabled(true);break;case TextModeEditor.Mode.NES:this.screenMode=TextModeEditor.Mode.NES;this.currentTile.setBGColor(this.colorPaletteManager.noColor);this.colorPaletteManager.colorSubPalettes.selectPalette(0);this.grid.setBorderEnabled(false);break;case TextModeEditor.Mode.INDEXED:this.screenMode=TextModeEditor.Mode.INDEXED;this.grid.setBorderEnabled(false);break;case TextModeEditor.Mode.RGB:this.screenMode=TextModeEditor.Mode.RGB;this.grid.setBorderEnabled(false);break}if(g_app.isMobile()){if(e===TextModeEditor.Mode.NES){$("#drawToolMobileSubpalette").show();$("#drawToolMobileCellColor").hide();$("#drawToolMobileFrameColor").hide()}else{$("#drawToolMobileSubpalette").hide();$("#drawToolMobileCellColor").show();$("#drawToolMobileFrameColor").show()}}this.currentTile.setScreenMode(e);if(this.tools.pixelDrawTools){this.tools.pixelDrawTools.setScreenMode(e)}if(this.graphic.getType()=="sprite"){UI("mode-spritetextmode").setChecked(false);UI("mode-spritec64multicolor").setChecked(false);if(UI.exists("mode-spritenes")){UI("mode-spritenes").setChecked(false)}if(UI.exists("mode-spriteindexed")){UI("mode-spriteindexed").setChecked(false)}if(UI.exists("mode-spritergb")){UI("mode-spritergb").setChecked(false)}UI("mode-sprite"+e).setChecked(true)}else{UI("mode-textmode").setChecked(false);UI("mode-c64multicolor").setChecked(false);if(UI.exists("mode-c64standard")){UI("mode-c64standard").setChecked(false)}if(UI.exists("mode-c64ecm")){UI("mode-c64ecm").setChecked(false)}if(UI.exists("mode-vector")){UI("mode-vector").setChecked(false)}if(UI.exists("mode-nes")){UI("mode-nes").setChecked(false)}if(UI.exists("mode-indexed")){UI("mode-indexed").setChecked(false)}if(UI.exists("mode-rgb")){UI("mode-rgb").setChecked(false)}UI("mode-"+e).setChecked(true)}this.tools.drawTools.setScreenMode(e);if(this.tileEditor){this.tileEditor.setScreenMode(e)}if(this.tileEditorMobile){this.tileEditorMobile.setScreenMode(e)}if(this.info){this.info.setScreenMode(e)}if(e=="vector"){UI("export-svg").setEnabled(true)}else{UI("export-svg").setEnabled(false)}this.tileSetManager.tileSetUpdated();this.syncColorPickers();this.colorPaletteManager.colorPaletteUpdated();this.currentTile.canvasDrawCharacters();this.grid.setUpdateEnabled(i);if(this.type!="3d"){this.graphic.redraw({allCells:true})}if(this.type=="2d"){this.layers.updateAllLayerPreviews()}},setScreenMode:function(e){if(e=="vector"){UI("export-svg").setEnabled(true)}else{UI("export-svg").setEnabled(false)}var t=this.layers.getSelectedLayerObject();if(!t){return}var i=this;t.setScreenMode(e,function(){i.setInterfaceScreenMode(e);i.layers.updateLayerLabel(t.getId())})},editC64PRGCode:function(){this.toPrgAdv.editCode()},toggleMobile:function(){this.textModeEditorPanel.setPanelVisible("east",true);UI("textEditorContent").setPanelVisible("south",true);UI("framesMobilePanel").setVisible(false);UI("toolsDesktopPanel").setVisible(true)},getEditorMode:function(){return this.editorMode},setEditorMode:function(e){this.editorMode=e;if(e=="pixel"){this.tools.pixelDrawTools.setDrawTool("pen");$("#pixelDrawSettings").show()}else{this.tools.drawTools.setDrawTool("pen");$("#pixelDrawSettings").hide()}UI("toolsMobileSidePanel").setVisible(this.deviceType=="mobile"&this.editorMode!="pixel");UI("toolsDesktopPanel").setVisible(this.deviceType=="desktop"&this.editorMode!="pixel");UI("pixelToolsMobileSidePanel").setVisible(this.deviceType=="mobile"&this.editorMode=="pixel");UI("pixelToolsDesktopPanel").setVisible(this.deviceType=="desktop"&this.editorMode=="pixel")},showReferenceImageDialog:function(e){if(g_app.isMobile()){if(this.referenceImageDialogMobile==null){this.referenceImageDialogMobile=new ReferenceImageDialog;this.referenceImageDialogMobile.init(this)}this.referenceImageDialogMobile.show()}else{if(this.referenceImageDialog==null){this.referenceImageDialog=new ReferenceImageDialog;this.referenceImageDialog.init(this)}this.referenceImageDialog.show(e)}},initGrid3dControls:function(){var t=this;$("#gridXYBack").on("click",function(){var e=t.grid3d.getXYPosition();e-=1;if(e>=0){t.grid3d.setXYPosition(e)}});$("#gridXYForward").on("click",function(){var e=t.grid3d.getXYPosition();e+=1;if(e<t.grid3d.getGridDepth()){t.grid3d.setXYPosition(e)}});$("#gridXYPosition").on("change",function(){var e=parseInt($(this).val(),10);if(isNaN(e)){return}t.grid3d.setXYPosition(e)});$("#gridXZDown").on("click",function(){var e=t.grid3d.getXZPosition();e-=1;if(e>=0){t.grid3d.setXZPosition(e)}});$("#gridXZUp").on("click",function(){var e=t.grid3d.getXZPosition();e+=1;if(e<t.grid3d.getGridHeight()){t.grid3d.setXZPosition(e)}});$("#gridXZPosition").on("change",function(){var e=parseInt($(this).val(),10);if(isNaN(e)){return}t.grid3d.setXZPosition(e)})},editImportShader:function(){if(this.importShaderEditor==null){this.importShaderEditor=new ImportShaderEditor;this.importShaderEditor.init(this)}this.importShaderEditor.show()},setType:function(e){this.type=e;this.currentTile.setType(e);if(e=="2d"){this.graphic.redraw({allCells:true});this.layers.updateAllLayerPreviews()}},keyDown:function(e){if(e.keyCode==keys.textMode.play.keyCode&&this.tools.drawTools.tool!="type"){this.frames.play()}this.setAlterKeys(e);this.tools.keyDown(e);this.frames.keyDown(e)},keyUp:function(e){this.setAlterKeys(e);if(this.colorPaletteEdit&&this.colorPaletteEdit.visible){this.colorPaletteEdit.keyUp(e);return}this.tools.keyUp(e)},keyPress:function(e){this.setAlterKeys(e);if(this.colorPaletteEdit&&this.colorPaletteEdit.visible){this.colorPaletteEdit.keyPress(e);return}this.tools.keyPress(e)},setupMenu:function(){if(this.graphic.getType()=="sprite"){UI("edit-replaceCharacter").setVisible(false);UI("export-png").setVisible(true);UI("export-prg").setVisible(false);UI("export-seq").setVisible(false);UI("export-petsciic").setVisible(false);UI("export-charpad").setVisible(false);UI("export-spritepad").setVisible(true);UI("import-image").setVisible(false);UI("import-c64formats").setVisible(false);UI("import-c64spriteformats").setVisible(true);UI("import-spriteimage").setVisible(true);$(".ui-menu-screen").hide();$(".ui-menu-sprite").show()}else{UI("edit-replaceCharacter").setVisible(true);UI("export-png").setVisible(false);UI("export-prg").setVisible(true);UI("export-seq").setVisible(true);UI("export-petsciic").setVisible(true);UI("export-charpad").setVisible(true);UI("export-spritepad").setVisible(false);UI("import-image").setVisible(true);UI("import-c64formats").setVisible(true);UI("import-c64spriteformats").setVisible(false);UI("import-spriteimage").setVisible(false);$(".ui-menu-screen").show();$(".ui-menu-sprite").hide()}},showMobileMenu:function(){if(this.mobileMenu==null){this.mobileMenu=new MobileMenu;this.mobileMenu.init(this)}this.mobileMenu.show()},showScreenModeDialog:function(){var a=this;if(this.screenModeDialog==null){var e=300;var t=140;if(UI.isMobile.any()){t=240}this.screenModeDialog=UI.create("UI.Dialog",{id:"screenModeDialog",title:"Screen Mode",width:e,height:t});this.screenModeHTML=UI.create("UI.HTMLPanel");this.screenModeDialog.add(this.screenModeHTML);this.screenModeHTML.load("html/textMode/screenModeDialog.html",function(){$("#screenModeDialogMode").val(a.getScreenMode());$("#screenModeDialogAllowTileFlip").prop("checked",a.getHasTileFlip());$("#screenModeDialogAllowTileRotate").prop("checked",a.getHasTileRotate());a.getHasTileRotate()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.screenModeDialog.addButton(this.okButton);this.okButton.on("click",function(e){var t=$("#screenModeDialogMode").val();a.setScreenMode(t);if(t=="nes"){a.colorPaletteManager.colorSubPalettes.check()}var i=$("#screenModeDialogAllowTileFlip").is(":checked");a.setHasTileFlip(i);var r=$("#screenModeDialogAllowTileRotate").is(":checked");a.setHasTileRotate(r);UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.screenModeDialog.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}UI.showDialog("screenModeDialog");$("#screenModeDialogMode").val(this.getScreenMode())},showTileEditor:function(e){if(g_app.isMobile()){if(this.tileEditorMobile==null){this.tileEditorMobile=new TileEditorMobile;this.tileEditorMobile.init(this)}this.tileEditorMobile.show(e)}else{this.tileEditor.toggleVisible();if(this.tileEditor.getVisible()){UI("charactersets-edit").setLabel("Hide Tile Editor")}else{UI("charactersets-edit").setLabel("Show Tile Editor")}}},showColorEditor:function(){this.colorEditor.setVisible(true)},toggleColorEditor:function(e){this.colorEditor.toggleVisible()},getCursorTileTransparent:function(){return this.cursorTileTransparent},setCursorTileTransparent:function(e){this.cursorTileTransparent=e;UI("cursor-tile-transparent").setChecked(e);g_app.setPref("textmode.cursortiletransparent",e?1:0);if(this.currentTile){this.currentTile.drawCursor()}},toggleCursorTileTransparent:function(){this.setCursorTileTransparent(!this.getCursorTileTransparent())},export3dAsGif:function(){if(g_app.isMobile()){if(this.export3dGifMobileDialog==null){this.export3dGifMobileDialog=new Export3dGifMobile;this.export3dGifMobileDialog.init(this)}this.export3dGifMobileDialog.show()}else{if(this.export3dGifDialog==null){this.export3dGifDialog=new Export3dGif;this.export3dGifDialog.init(this)}this.export3dGifDialog.start()}},exportGif:function(){if(g_app.isMobile()){if(this.exportGifMobileDialog==null){this.exportGifMobileDialog=new ExportGifMobile;this.exportGifMobileDialog.init(this)}this.exportGifMobileDialog.show()}else{if(this.exportGifDialog==null){this.exportGifDialog=new ExportGif;this.exportGifDialog.init(this)}this.exportGifDialog.start()}},exportImage:function(){if(this.exportImageDialog==null){this.exportImageDialog=new ExportImage;this.exportImageDialog.init(this)}this.exportImageDialog.show()},exportSvg:function(){if(g_app.isMobile()){}else{if(this.exportSvgDialog==null){this.exportSvgDialog=new ExportSvg;this.exportSvgDialog.init(this)}this.exportSvgDialog.show()}},exportPng:function(){if(this.graphic.getType()=="sprite"){if(g_app.isMobile()){}else{if(this.exportSpritePngDialog==null){this.exportSpritePngDialog=new ExportSpritePng;this.exportSpritePngDialog.init(this)}this.exportSpritePngDialog.show();return}}if(g_app.isMobile()){if(this.exportPngMobileDialog==null){this.exportPngMobileDialog=new ExportPngMobile;this.exportPngMobileDialog.init(this)}this.exportPngMobileDialog.show()}else{if(this.exportPngDialog==null){this.exportPngDialog=new ExportPng;this.exportPngDialog.init(this)}this.exportPngDialog.show()}},copyAsImage:function(){if(g_app.isMobile()){if(this.exportPngMobileDialog==null){this.exportPngMobileDialog=new ExportPngMobile;this.exportPngMobileDialog.init(this)}this.exportPngMobileDialog.show()}else{if(this.exportImageDialog==null){this.exportImageDialog=new ExportImage;this.exportImageDialog.init(this)}var r=this;this.exportImageDialog.createUI(function(){var e={};e.frame=r.graphic.getCurrentFrame();e.effects=false;e.includeBorder=false;e.scale=r.exportImageDialog.getScale();var t=r.tools.drawTools.select.getSelection();if(r.tools.drawTools.select.getEnabled()&&t.minX!=t.maxX&&t.minY!=t.maxY){var i=r.layers.getSelectedLayerObject();if(i.getType()=="grid"){e.section=true;e.fromX=t.minX*i.getCellWidth()*e.scale;e.width=(t.maxX-t.minX)*i.getCellWidth()*e.scale;e.fromY=t.minY*i.getCellHeight()*e.scale;e.height=(t.maxY-t.minY)*i.getCellHeight()*e.scale}}else{e.section=true;e.fromX=0;e.width=r.graphic.getGraphicWidth()*e.scale;e.fromY=0;e.height=r.graphic.getGraphicHeight()*e.scale}r.exportImageDialog.drawFrame(e);r.exportImageDialog.copyToClipboard(e)})}},exportTileset:function(){var e="Tileset";var t=this.tileSetManager.getCurrentTileSet();t.exportPng({filename:e})},createBin:function(e){var t=e.source;var i=e.type;var r=t.split("/");var a="";while(r.length>0&&r[0]==""){r.shift()}if(r.length==0){return}var s=g_app.doc.getDocRecord(t);if(s==null){return"error"}var o=s.id;var l=s.type;var n=s.name;var h=n;var d="bin/"+n+".bin";var c={success:false};if(this.exportC64Assembly==null){this.exportC64Assembly=new ExportC64Assembly;this.exportC64Assembly.init(this)}switch(l){case"tile set":c=this.tileSetManager.createBin({tileSetId:o,name:h,binPath:d,binType:i});break;case"graphic":var f=[];var u="charmap";if(typeof e.type!="undefined"){u=e.type.toLowerCase()}switch(u){case"blockset":f=this.exportC64Assembly.getBlockSetData({path:t},"binary");break;case"blockmap":f=this.exportC64Assembly.getBlockMapData({path:t},"binary");break;case"blockcolor":case"blockcolour":f=this.exportC64Assembly.getBlockColorData({path:t},"binary");break;default:f=this.exportC64Assembly.getCharMapData({path:t},"binary");break}var p=bufferToBase64(f);var l="bin";var v="/asm/bin";n=h+" - "+u+".bin";var s=g_app.doc.getDocRecord(v+"/"+n);if(s){s.data=p}else{var g=g_app.doc.createDocRecord(v,n,l,p)}g_app.projectNavigator.reloadTreeBranch("/asm/bin");g_app.projectNavigator.treeRoot.refreshChildren();c={success:true,path:"bin/"+n};break}return c},startImportSpriteImage:function(){if(this.importSpriteImage==null){this.importSpriteImage=new ImportSpriteImage;this.importSpriteImage.init(this)}this.importSpriteImage.start()},doExport:function(e){switch(e){case"txt":if(this.exportTxt==null){this.exportTxt=new ExportTxt;this.exportTxt.init(this)}this.exportTxt.start();break;case"json":if(this.exportJson==null){this.exportJson=new ExportJson;this.exportJson.init(this)}this.exportJson.start();break;case"binary":if(this.graphic.getType()=="sprite"){if(this.exportSpriteBinaryData==null){this.exportSpriteBinaryData=new ExportSpriteBinaryData;this.exportSpriteBinaryData.init(this)}this.exportSpriteBinaryData.start()}else{if(this.exportBinaryData==null){this.exportBinaryData=new ExportBinaryData;this.exportBinaryData.init(this)}this.exportBinaryData.start()}break;case"petsciic":if(this.exportPetsciiC==null){this.exportPetsciiC=new ExportPetsciiC;this.exportPetsciiC.init(this)}this.exportPetsciiC.start();break;case"pet":if(this.exportPet==null){this.exportPet=new ExportPet;this.exportPet.init(this)}this.exportPet.start();break;case"c64assembly":if(this.graphic.getType()=="sprite"){if(this.exportC64SpriteAssembly==null){this.exportC64SpriteAssembly=new ExportC64SpriteAssembly;this.exportC64SpriteAssembly.init(this)}this.exportC64SpriteAssembly.start()}else{if(this.exportC64Assembly==null){this.exportC64Assembly=new ExportC64Assembly;this.exportC64Assembly.init(this)}this.exportC64Assembly.start()}break;case"mega65assembly":if(this.exportMega65Assembly==null){this.exportMega65Assembly=new ExportMega65Assembly;this.exportMega65Assembly.init(this)}this.exportMega65Assembly.start();break;case"x16assembly":if(this.exportX16Assembly==null){this.exportX16Assembly=new ExportX16Assembly;this.exportX16Assembly.init(this)}this.exportX16Assembly.start();break;case"charpad":if(this.exportCharPad==null){this.exportCharPad=new ExportCharPad;this.exportCharPad.init(this)}this.exportCharPad.start();break;case"spritepad":if(this.exportSpritePad==null){this.exportSpritePad=new ExportSpritePad;this.exportSpritePad.init(this)}this.exportSpritePad.start();break;case"seq":if(this.exportSEQ==null){this.exportSEQ=new ExportSEQ;this.exportSEQ.init(this)}this.exportSEQ.start();break;case"x16basic":if(this.exportX16Basic==null){this.exportX16Basic=new ExportX16Basic;this.exportX16Basic.init(this)}this.exportX16Basic.start();break;case"vox":if(this.exportVox==null){this.exportVox=new ExportVox;this.exportVox.init(this)}this.exportVox.start();break;case"obj":if(this.exportObj==null){this.exportObj=new ExportObj;this.exportObj.init(this)}this.exportObj.start();break}},zoom:function(e){if(this.type=="2d"){this.gridView2d.zoom(e)}if(this.type=="3d"){console.error("need to get active grid view");this.gridView3d.zoom(e)}},fitOnScreen:function(e){if(this.type=="2d"){this.gridView2d.fitOnScreen(e)}if(this.type=="3d"){console.error("need to get active grid view");this.gridView3d.fitOnScreen()}},actualPixels:function(){if(this.type=="2d"){this.gridView2d.actualPixels()}if(this.type=="3d"){console.error("need to get active grid view");this.gridView3d.actualPixels()}},replaceColor:function(){if(this.replaceColorDialog==null){this.replaceColorDialog=new ReplaceColorDialog;this.replaceColorDialog.init(this)}this.replaceColorDialog.show()},replaceCharacter:function(){if(this.replaceCharacterDialog==null){this.replaceCharacterDialog=new ReplaceCharacterDialog;this.replaceCharacterDialog.init(this)}this.replaceCharacterDialog.show()},clearHiddenTiles:function(){if(this.clearHiddenTilesDialog==null){this.clearHiddenTilesDialog=new ClearHiddenTilesDialog;this.clearHiddenTilesDialog.init(this)}this.clearHiddenTilesDialog.show()},editTilePalette:function(){if(this.tilePaletteEditor==null){this.tilePaletteEditor=new TilePaletteEditor;this.tilePaletteEditor.init(this)}this.tilePaletteEditor.show()},editColorPalette:function(){if(this.colorPaletteEdit==null){this.colorPaletteEdit=new ColorPaletteEdit;this.colorPaletteEdit.init(this)}this.colorPaletteEdit.show()},update:function(){var e=getTimestamp();if(e-this.lastSelectAnimate>260){this.lastSelectAnimate=e;if(this.lastDashOffset==0){this.lastDashOffset=5}else{this.lastDashOffset=0}}if(this.importImage!==null){this.importImage.update()}if(this.exportGifDialog!==null){if(this.exportGifDialog.update()){return}}if(this.exportImageDialog!==null){if(this.exportImageDialog.update()){return}}if(this.export3dGifDialog!==null){if(this.export3dGifDialog.update()){return}}if(this.exportGifMobileDialog!==null&&this.exportGifMobileDialog.visible){if(this.exportGifMobileDialog.update()){return}}if(this.colorPaletteEdit&&this.colorPaletteEdit.visible){this.colorPaletteEdit.update();return}if(this.frames!==null){this.frames.update()}if(this.animationPreview.getVisible()){this.animationPreview.update()}if(this.importImage.visible!==true){if(this.gridView2d&&this.type=="2d"){this.gridView2d.render()}if(g_app.getMode()=="3d"){this.grid3d.update()}}if(this.importC64Formats!=null&&this.importC64Formats.visible===true){this.importC64Formats.update()}if(this.importC64SpriteFormats!=null&&this.importC64SpriteFormats.visible===true){this.importC64SpriteFormats.update()}}};TextModeEditor.prototype.mobileReduceInterface=function(){var e=UI("textEditorMobileSplitPanel");e.setPanelVisible("north",false);e.setPanelVisible("south",false);this.textModeEditorPanel.setPanelVisible("west",true);this.tilePaletteMobile.setCurrentTileVisible(false);this.tilePaletteMobile.draw()};TextModeEditor.prototype.mobileRestoreInterface=function(){var e=UI("textEditorMobileSplitPanel");e.setPanelVisible("north",true);e.setPanelVisible("south",true);this.textModeEditorPanel.setPanelVisible("west",false);this.tilePaletteMobile.setCurrentTileVisible(true);this.tilePaletteMobile.draw()};TextModeEditor.prototype.setLayoutType=function(e){var t=UI.isMobile.any();if(t){return}if(e=="textmode"){var i=g_app.getPref("textmode.eastPanelSize");if(typeof i=="undefined"||i==null||i<100){i=340}else{i=parseInt(i,10)}this.textModeEditorPanel.resizeThePanel({panel:"east",size:i});var r=g_app.getPref("textmode.infoPanelVisible")=="yes";this.setInfoPanelVisible(r);var a=g_app.getPref("textmode.colorPaletteVisible")!="no";var s=g_app.getPref("textmode.colorPanelSize");if(typeof s=="undefined"||s==null){s=150}else{s=parseInt(s,10)}this.setColorPalettePanelVisible(a);var o=g_app.getPref("textmode.layersPanelVisible")!="no";var l=g_app.getPref("textmode.layersPanelSize");if(typeof l=="undefined"||l==null){l=200}else{l=parseInt(l,10)}this.setLayersPanelVisible(o);if(g_isNewUser){g_app.setPref("textmode.sideTilePaletteVisible","yes");g_app.setPref("textmode.tilePaletteVisible","no");g_app.setPref("textmode.bottomBlockPaletteVisible","no");g_app.setPref("textmode.sideBlockPaletteVisible","no")}var n=g_app.getPref("textmode.sideTilePaletteVisible")=="yes";this.setTilePalettePanelVisible("side",n);var h=g_app.getPref("textmode.sideBlockPaletteVisible")=="yes";this.setSideBlockPanelVisible(h);var d=g_app.getPref("textmode.bottomBlockPaletteVisible")=="yes";this.setBottomBlockPanelVisible(d);var c=g_app.getPref("textmode.tilePaletteVisible")!="no";this.setTilePalettePanelVisible("bottom",c);if(o){if(a&&n){UI("textModeEastPanel").resizeThePanel({panel:"north",size:l})}}if(a){if(o||n){UI("textModeEastPanel").resizeThePanel({panel:"south",size:s})}}var f=g_app.getPref("textmode.toolsPanelVisible")!=="no";this.setToolsVisible(f)}if(e=="sprite"){var i=g_app.getPref("sprite.eastPanelSize");if(typeof i=="undefined"||i==null||i<100){i=340}else{i=parseInt(i,10)}this.textModeEditorPanel.resizeThePanel({panel:"east",size:i});var r=g_app.getPref("sprite.infoPanelVisible")=="yes";this.setInfoPanelVisible(r);var a=g_app.getPref("sprite.colorPaletteVisible")!="no";var s=g_app.getPref("sprite.colorPanelSize");if(typeof s=="undefined"||s==null){s=140}else{s=parseInt(s,10)}this.setColorPalettePanelVisible(a);var o=g_app.getPref("sprite.layersPanelVisible")!="no";var l=g_app.getPref("sprite.layersPanelSize");if(typeof l=="undefined"||l==null){l=200}else{l=parseInt(l,10)}this.setLayersPanelVisible(o);var n=false;this.setTilePalettePanelVisible("side",n);var c=true;this.setTilePalettePanelVisible("bottom",c);var f=g_app.getPref("sprite.toolsPanelVisible")!=="no";this.setToolsVisible(f)}};TextModeEditor.prototype.buildEastPanel=function(){var e=g_app.getPref("textmode.colorPaletteVisible")!="no";var t=g_app.getPref("textmode.layersPanelVisible")!="no";var i=g_app.getPref("textmode.sideTilePaletteVisible")=="yes";var r=g_app.getPref("textmode.infoPanelVisible")=="yes";var a=UI.isMobile.any();this.deviceType="desktop";if(a){this.deviceType="mobile"}var s=false;if(a){s=true}var o=UI.create("UI.SplitPanel",{id:"eastInfoPanel"});var l=g_app.getPref("textmode.eastPanelSize");if(typeof l=="undefined"||l==null||l<100){l=340}else{l=parseInt(l,10)}this.textModeEditorPanel.addEast(o,l,true,s);this.textModeEditorPanel.setMinSize("east",10);this.textModeEditorPanel.on("resizeeast",function(e){var t="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){t="sprite"}g_app.setPref(t+".eastPanelSize",e)});var n=UI.create("UI.Panel",{id:"infoPanel"});o.addNorth(n,148,true,!r);this.info=new Info;this.info.init(this);this.info.buildInterface(n);var h=UI.create("UI.SplitPanel",{id:"textModeEastPanel"});o.add(h);var d=g_app.getPref("textmode.layersPanelSize");if(typeof d=="undefined"||d==null){d=200}else{d=parseInt(d,10)}var c=UI.create("UI.Panel",{id:"layersPanel"});h.addNorth(c,d,true,!t);h.on("resizenorth",function(e){var t="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){t="sprite"}g_app.setPref(t+".layersPanelSize",e)});var f=UI.create("UI.SplitPanel",{id:"eastTilesSplitPanel"});var u=UI.create("UI.Panel",{id:"eastTilesPanel"});this.sideTilePalette=new TilePalette;this.sideTilePalette.init(this,{prefix:"side",blockStacking:"vertical"});this.sideTilePalette.buildInterface(u);f.add(u);var p=UI.create("UI.SplitPanel",{id:"eastBlockPanel"});f.addSouth(p,300);this.sideBlockPalette=new BlockPalette;this.sideBlockPalette.init(this,{prefix:"side"});this.sideBlockPalette.buildInterface(p);this.blockEditor=new BlockEditor;this.blockEditor.init(this);UI.on("ready",function(){});h.add(f,!i);h.centerDefaultHeight=180;var v=UI.create("UI.SplitPanel",{id:"colorSplitPanel"});var g=g_app.getPref("textmode.colorPanelSize");if(typeof g=="undefined"||g==null){g=140}else{g=parseInt(g,10)}h.addSouth(v,g,true,!e);h.on("resizesouth",function(e){var t="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){t="sprite"}g_app.setPref(t+".colorPanelSize",e)});var m=UI.create("UI.Panel",{id:"palettePanel"});v.add(m);this.colorPalettePanel=new ColorPalettePanel;this.colorPalettePanel.init(this);this.colorPalettePanel.buildInterface(m);var y=false;var b=UI.create("UI.Panel",{id:"colorEditPanel"});v.addSouth(b,180,false,!y);this.colorEditor=new ColorEditor;this.colorEditor.init(this);this.colorEditor.buildInterface(b);var C=this;UI.on("ready",function(){})};TextModeEditor.prototype.buildInterface=function(e){var t=this;this.desktopToolsWidth=77;var i=UI.isMobile.any();this.deviceType="desktop";if(i){this.deviceType="mobile"}var r=UI.getScreenWidth();var a=UI.getScreenHeight();this.textModeEditorPanel=UI.create("UI.SplitPanel",{id:"textModeEditor"});e.add(this.textModeEditorPanel);var s=UI.create("UI.SplitPanel",{id:"textEditorMobileSplitPanel"});this.textModeEditorPanel.add(s);var o=UI.create("UI.SplitPanel",{id:"textEditorContent"});s.add(o);var l=UI.create("UI.SplitPanel",{id:"gridSplitPanel"});o.add(l);var n=UI.create("UI.Panel");l.addWest(n,300,true,true);l.setMinSize("west",150);var h=true;if(i){h=false}var d=UI.create("UI.Panel");l.addSouth(d,24,false,!h);this.gridInfo=new GridInfo;this.gridInfo.init(this);this.gridInfo.buildInterface(d);this.tileEditor=new TileEditor;this.tileEditor.init(this);this.tileEditor.buildInterface(n);var c=UI.create("UI.SplitPanel");l.add(c);var f=UI.create("UI.Panel",{id:"gridPanel"});c.add(f);var u=this.desktopToolsWidth;if(i){u=70}var p=UI.create("UI.Panel",{id:" toolsPanel"});var v=false;var g=true;if(i){v=true;g=false}var m=false;var y=UI.create("UI.HTMLPanel",{id:"toolsDesktopPanel",visible:g&!m});p.add(y);var b=UI.create("UI.HTMLPanel",{id:"pixelToolsDesktopPanel",visible:g&m});p.add(b);var C=g_app.getPref("textmode.toolsPanelVisible")!=="no";this.textModeEditorPanel.addWest(p,u,false,!C);if(C){UI.on("ready",function(){UI("view-tools").setChecked(true)})}var x=UI.create("UI.HTMLPanel",{id:"toolsMobileSidePanel",visible:v&!m});p.add(x);var S=UI.create("UI.HTMLPanel",{id:"pixelToolsMobileSidePanel",visible:v&m});p.add(S);var P=UI.create("UI.Panel",{id:"framesMobilePanel",visible:v});var w=UI.create("UI.HTMLPanel",{id:"toolsSettingsMobileHTMLPanel"});var I=UI.create("UI.HTMLPanel",{id:"toolsMobileHTMLPanel"});var k=UI.create("UI.SplitPanel");k.add(P);s.addSouth(k,50,false,!v);var M=30;if(i){M=40}var T=UI.create("UI.Panel",{id:"toolSettingsPanel"});s.addNorth(T,M,false);T.add(w);this.buildEastPanel();var D=g_app.getPref("textmode.tilePaletteVisible")!="no";var E=210;if(!D){E=0;var $=true;if($){E+=60}}var _=false;if(i){_=true;E=68;if(a<700){E=50}}var B=UI.create("UI.Panel",{id:"bottomToolsPanel"});var R=UI.create("UI.Panel",{visible:!i,id:"textEditorDesktopToolsHolder"});var A=UI.create("UI.SplitPanel",{id:"textEditorDesktopTools"});R.add(A);var F=UI.create("UI.Panel",{visible:i,id:"textEditorMobileToolsHolder"});B.add(F);B.add(R);var L=UI.create("UI.Panel",{id:"tilePaletteMobile"});F.add(L);this.tilePaletteMobile=new TilePaletteMobile;this.tilePaletteMobile.init(this);this.tilePaletteMobile.buildInterface(L);var U=UI.create("UI.Panel",{visible:false,id:"spriteFramesMobile"});F.add(U);this.spriteFramesMobile=new SpriteFrames;this.spriteFramesMobile.init(this,"mobile");this.spriteFramesMobile.buildInterface(U);o.addSouth(B,E,!i);if(!D){o.setResizeVisible("south",false)}var H=UI.create("UI.Panel");A.add(H);this.currentTile=new CurrentTile;this.currentTile.init(this);this.animationPreview=new AnimationPreview;this.animationPreview.init(this);this.tools=new Tools;this.tools.init(this);this.tools.buildInterface(H);var O=UI.create("UI.Panel",{id:"framesPanel"});A.addSouth(O,60,false);this.build2dInterface(f);this.build3dInterface(f)};TextModeEditor.prototype.build2dInterface=function(e){var t=UI.create("UI.Panel",{id:"grid2d"});e.add(t);var i=UI.create("UI.CanvasPanel",{id:"gridView2d"});t.add(i)};TextModeEditor.prototype.build3dInterface=function(e){var t=UI.create("UI.Panel",{id:"grid3d"});e.add(t);var i=UI.create("UI.SplitPanel");t.add(i);var r=UI.create("UI.WebGLPanel",{id:"gridView3d"});i.add(r);var a=this.deviceType==="mobile";var s=a;var o=UI.create("UI.SplitPanel");i.addEast(o,500,!a,s);i.setMinSize("east",4);var l=UI.create("UI.SplitPanel",{id:"gridViewFront"});var n=UI.create("UI.WebGLPanel",{id:"gridViewFrontWebGL"});var h="<div>";h+="Front";h+='<div class="ui-button" id="gridXYBack">&lt;</div>';h+='<input class="number" size="2" min="0" value="2" id="gridXYPosition"/>';h+='<div class="ui-button" id="gridXYForward">&gt;</div>';h+="</div>";var d=UI.create("UI.HTMLPanel",{html:h});l.addSouth(d,20,false);l.add(n);o.addNorth(l,200,!a,s);o.setMinSize("north",20);var c=UI.create("UI.SplitPanel",{id:"gridViewTop"});var f=UI.create("UI.WebGLPanel",{id:"gridViewTopWebGL"});h="<div>";h+="Top";h+='<div class="ui-button" id="gridXZDown">&lt;</div>';h+='<input class="number" size="2" min="0" value="2" id="gridXZPosition"/>';h+='<div class="ui-button" id="gridXZUp">&gt;</div>';h+="</div>";var u=UI.create("UI.HTMLPanel",{html:h});c.addSouth(u,20,false);c.add(f);o.add(c);if(a){}var p=this;UI.on("ready",function(){p.initGrid3dControls()})};TextModeEditor.prototype.updateEastInfoPanel=function(){var e=false;if(this.getLayersPanelVisible()){e=true;UI("view-layerspanel").setChecked(true)}else{UI("view-layerspanel").setChecked(false)}var t=false;if(this.getTilePalettePanelVisible("side")){e=true;t=true;UI("view-tilepalettepanelside").setChecked(true)}else{UI("view-tilepalettepanelside").setChecked(false)}if(this.getSideBlockPanelVisible()){e=true;t=true;UI("view-metatilepalettepanelside").setChecked(true)}else{UI("view-metatilepalettepanelside").setChecked(false)}UI("textModeEastPanel").setPanelVisible("center",t,300,true);if(this.getColorPalettePanelVisible()){e=true;UI("view-palettepanel").setChecked(true)}else{UI("view-palettepanel").setChecked(false)}if(e){this.textModeEditorPanel.setPanelVisible("east",true)}else{this.textModeEditorPanel.setPanelVisible("east",false)}};TextModeEditor.prototype.setInfoPanelVisible=function(e){if(e){this.textModeEditorPanel.setPanelVisible("east",true)}UI("eastInfoPanel").setPanelVisible("north",e);var t="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){t="sprite"}g_app.setPref(t+".infoPanelVisible",e?"yes":"no");this.updateEastInfoPanel()};TextModeEditor.prototype.getInfoPanelVisible=function(){return UI("eastInfoPanel").getPanelVisible("north")};TextModeEditor.prototype.setLayersPanelVisible=function(e){if(e){this.textModeEditorPanel.setPanelVisible("east",true)}UI("textModeEastPanel").setPanelVisible("north",e,180,true);var t="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){t="sprite"}g_app.setPref(t+".layersPanelVisible",e?"yes":"no");UI("view-layerspanel").setChecked(e);this.updateEastInfoPanel()};TextModeEditor.prototype.getLayersPanelVisible=function(){return UI("textModeEastPanel").getPanelVisible("north")};TextModeEditor.prototype.setSideBlockPanelVisible=function(e){if(!this.textModeEditorPanel.getPanelVisible("east")){UI("textModeEastPanel").setPanelVisible("center",true,300,true);this.textModeEditorPanel.setPanelVisible("east",true,300,true)}UI("eastTilesSplitPanel").setPanelVisible("south",e,300,true);var t="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){t="sprite"}g_app.setPref(t+".sideBlockPaletteVisible",e?"yes":"no");this.updateEastInfoPanel()};TextModeEditor.prototype.getSideBlockPanelVisible=function(){return UI("eastTilesSplitPanel").getPanelVisible("south")};TextModeEditor.prototype.setBottomBlockPanelVisible=function(e){UI("tilePaletteSplitPanel").setPanelVisible("east",e,300,true);var t="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){t="sprite"}g_app.setPref(t+".bottomBlockPaletteVisible",e?"yes":"no");this.updateBottomPanel()};TextModeEditor.prototype.getBottomBlockPanelVisible=function(){return UI("tilePaletteSplitPanel").getPanelVisible("east")};TextModeEditor.prototype.setTilePalettePanelVisible=function(e,t){var i="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){i="sprite"}if(e=="side"){UI("eastTilesSplitPanel").setPanelVisible("center",t,300,true);g_app.setPref(i+".sideTilePaletteVisible",t?"yes":"no");this.updateEastInfoPanel()}else{UI("tilePaletteSplitPanel").setPanelVisible("center",t,300,true);g_app.setPref(i+".tilePaletteVisible",t?"yes":"no");this.updateBottomPanel()}};TextModeEditor.prototype.getTilePalettePanelVisible=function(e){if(e=="side"){return UI("eastTilesSplitPanel").getPanelVisible("center")}else{return UI("tilePaletteSplitPanel").getPanelVisible("center")}};TextModeEditor.prototype.updateBottomPanel=function(){var e=false;if(this.getTilePalettePanelVisible("bottom")){e=true;UI("view-tilepalettepanelbottom").setChecked(true)}else{UI("view-tilepalettepanelbottom").setChecked(false)}if(this.getBottomBlockPanelVisible()){e=true;UI("view-metatilepalettepanelbottom").setChecked(true)}else{UI("view-metatilepalettepanelbottom").setChecked(false)}var t=280;if(!e){t=0;var i=true;if(i){t+=60}UI("textEditorContent").setResizeVisible("south",false)}else{UI("textEditorContent").setResizeVisible("south",true)}UI("textEditorContent").resizeThePanel({panel:"south",size:t});this.bottomTilePaletteVisible=e;var r=180;if(e===false){r=28}UI("textModeBottomPanel").resizeThePanel({panel:"west",size:r})};TextModeEditor.prototype.setColorPalettePanelVisible=function(e){if(e){this.textModeEditorPanel.setPanelVisible("east",true)}else{if(this.colorEditor.getVisible()){this.colorEditor.setVisible(false)}}var t="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){t="sprite"}g_app.setPref(t+".colorPaletteVisible",e?"yes":"no");UI("textModeEastPanel").setPanelVisible("south",e,150,true);UI("view-palettepanel").setChecked(e);this.updateEastInfoPanel()};TextModeEditor.prototype.getColorPalettePanelVisible=function(){return UI("textModeEastPanel").getPanelVisible("south")};TextModeEditor.prototype.getToolsVisible=function(e){return this.textModeEditorPanel.getPanelVisible("west")};TextModeEditor.prototype.setToolsVisible=function(e){this.textModeEditorPanel.setPanelVisible("west",e);if(e){$("#tileToolsOpenButtonHolder").hide();$("#drawToolSettings-cellColor").hide();$("#drawToolSettings-frameColors").hide()}else{$("#tileToolsOpenButtonHolder").show();$("#drawToolSettings-cellColor").show();$("#drawToolSettings-frameColors").show()}var t="textmode";if(g_app.textModeEditor.graphic.type=="sprite"){t="sprite"}g_app.setPref(t+".toolsPanelVisible",e?"yes":"no");UI("view-tools").setChecked(e)};TextModeEditor.prototype.setLayout=function(e){return;if(e=="bottom"){UI("eastToolPanel").setPanelVisible("north",false);UI("textEditorContent").resizeThePanel({panel:"south",size:280});UI("textModeBottomPanel").resizeThePanel({panel:"west",size:200})}if(e=="side"){UI("eastToolPanel").setPanelVisible("north",true);var t=26;var i=true;if(i){t+=60}UI("textEditorContent").resizeThePanel({panel:"south",size:t});UI("textModeBottomPanel").resizeThePanel({panel:"west",size:28})}if(e=="minimal"){this.setInfoPanelVisible(false);this.setLayersPanelVisible(false);this.setColorPalettePanelVisible(false);var t=26;var i=true;if(i){t+=60}UI("textEditorContent").resizeThePanel({panel:"south",size:t});UI("textModeBottomPanel").resizeThePanel({panel:"west",size:28})}if(e=="custom"){}};TextModeEditor.prototype.startBlockTool=function(){if(this.getSideBlockPanelVisible()||this.getBottomBlockPanelVisible()){return}if(this.getTilePalettePanelVisible("side")){var e=UI("eastTilesSplitPanel").getPanelHeight("center");var t=Math.floor(e/2);this.setSideBlockPanelVisible(true);UI("eastTilesSplitPanel").resizeThePanel({panel:"south",size:t})}else if(this.getTilePalettePanelVisible("bottom")){var i=UI("tilePaletteSplitPanel").getPanelWidth("center");this.setBottomBlockPanelVisible(true);var t=300;if(i>1e3){t=Math.floor(i/2)}UI("tilePaletteSplitPanel").resizeThePanel({panel:"east",size:t})}};TextModeEditor.prototype.setDeviceType=function(e){var t=80;this.deviceType=e;if(e=="mobile"){this.textModeEditorPanel.setPanelVisible("east",false);UI("textEditorContent").setPanelVisible("south",false);UI("textEditorContent").resizeThePanel({panel:"south",size:0});UI("framesMobilePanel").setVisible(true);UI("toolsMobileSidePanel").setVisible(true&this.editorMode!="pixel");UI("toolsDesktopPanel").setVisible(false);UI("pixelToolsMobileSidePanel").setVisible(true&this.editorMode=="pixel");UI("pixelToolsDesktopPanel").setVisible(false);UI("textModeEditor").resizeThePanel({panel:"west",size:62});UI("textEditorMobileSplitPanel").setPanelVisible("south",true);UI("textEditorMobileSplitPanel").resizeThePanel({panel:"south",size:50});UI("textEditorMobileSplitPanel").setPanelVisible("north",true);UI("textEditorMobileSplitPanel").resizeThePanel({panel:"north",size:50})}if(e=="desktop"){this.textModeEditorPanel.setPanelVisible("east",true);UI("textEditorContent").setPanelVisible("south",true);UI("textEditorContent").resizeThePanel({panel:"south",size:260});UI("framesMobilePanel").setVisible(false);UI("toolsMobileSidePanel").setVisible(false);UI("toolsDesktopPanel").setVisible(true&this.editorMode!="pixel");UI("pixelToolsMobileSidePanel").setVisible(false);UI("pixelToolsDesktopPanel").setVisible(true&this.editorMode=="pixel");UI("textModeEditor").resizeThePanel({panel:"west",size:this.desktopToolsSize});UI("textEditorMobileSplitPanel").setPanelVisible("south",false);UI("textEditorMobileSplitPanel").resizeThePanel({panel:"south",size:0});UI("textEditorMobileSplitPanel").setPanelVisible("north",false);UI("textEditorMobileSplitPanel").resizeThePanel({panel:"north",size:0})}this.currentTile.setDeviceType(e);if(e=="desktop"){}};var TextModeFile=function(){this.editor=null};TextModeFile.prototype={init:function(e){this.editor=e},load:function(i,r){alert("load");console.error("LOAD!!!!!");if(!i.frames){return}console.log(i);var e=0;if(typeof i.version!="undefined"){e=i.version}else{i.version=0}this.editor.history.setEnabled(false);this.editor.frames.clear();if(typeof i.clearColor!="undefined"){}if(typeof i.floorColor!="undefined"){}var a=this;this.loadTileSets(i,function(){var e=a.editor.tileSetManager;var t=e.getCurrentTileSet();a.loadColorPalettes(i);a.loadFrames(i);if(typeof r!="undefined"){r()}});if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}this.editor.history.setEnabled(true)},loadColorPalettes:function(e){var t=e.version;this.editor.colorPaletteManager.reset();if(typeof e.materials!="undefined"){var i=e.materials;var r=[];for(var a=0;a<i.length;a++){if(i[a].i=="floor"){}else if(i[a].i=="background"){}else{r.push(i[a].c)}}for(var a=0;a<i.length;a++){if(i[a].i=="floor"){}else if(i[a].i=="background"){}else{if(typeof i[a].i!="undefined"){r[i[a].i]=i[a].c}}}var s=this.editor.colorPaletteManager.getCurrentColorPalette();s.setColors(r)}else{this.editor.colorPaletteManager.useDefaultColorPalette()}},tileSetImageData:function(e){var t=8;var i=8;var r=t*32;var a=i*8;if(typeof this.charsCanvas=="undefined"||!this.charsCanvas){this.charsCanvas=document.createElement("canvas");this.charsImageData=null;this.charsContext=null}if(this.charsCanvas.width!=r||this.charsCanvas.height!=a||this.charsImageData==null){this.charsCanvas.width=r;this.charsCanvas.height=a;this.charsContext=this.charsCanvas.getContext("2d");this.charsImageData=this.charsContext.getImageData(0,0,this.charsCanvas.width,this.charsCanvas.height)}var s=this.charsImageData;var o=0;var l=e.length/i;for(var n=0;n<l;n++){var h=n%32;var d=Math.floor(n/32);for(var c=0;c<i;c++){var f=e[o++];for(var u=0;u<t;u++){var p=(h*t+u+(d*i+c)*s.width)*4;var v=1<<t-1-u;var g=f&v;if(g){s.data[p]=255;s.data[p+1]=255;s.data[p+2]=255;s.data[p+3]=255}else{s.data[p]=0;s.data[p+1]=0;s.data[p+2]=0;s.data[p+3]=0}}}}return s},loadTileSets:function(e,t){var i=0;var r=0;var a=false;var s=e.version;var o=this.editor.tileSetManager;if(typeof e.charactersets=="undefined"||e.charactersets.length==0){o.useDefaultTileSet(t);return}o.reset();if(e.charactersets&&e.charactersets.length>0){i=e.charactersets.length;for(var l=0;l<e.charactersets.length;l++){var n=e.charactersets[l].name;var h=e.charactersets[l].type;if(typeof h=="undefined"){h="ascii"}var d=new TileSet;d.init(this.editor,n);if(e.charactersets[l]["data"].length>0){d.type=h;var c=this.tileSetImageData(e.charactersets[l]["data"]);d.setFromImageData(c);r++}else{d.setToPreset("petscii",function(){r++;if(r==i&&!a){if(typeof t!="undefined"){t();a=true}}})}if(typeof e.charactersets[l]["properties"]!=undefined){var f=e.charactersets[l]["properties"];d.characterProperties=[];for(var l=0;l<256;l++){d.characterProperties[l]={}}for(var l=0;l<f.length;l++){var u=f[l].c;d.setAnimated(u,f[l].a);d.setAnimatedType(u,f[l].at);d.setAnimatedTicksPerFrame(u,f[l].af)}}}o.addTileSet(d)}o.setCurrentTileSet(0);if(typeof t!="undefined"){if(r==i&&!a){t()}}},loadFrames:function(e){var t=e.version;var i=e.width;var r=e.depth;var a=e.height;var s=e.background;if(typeof s=="undefined"){s=6}var o=e.border;if(typeof o=="undefined"){o=14}var l=e.timeUnits;if(typeof l=="undefined"){l="ms"}var n=this.editor.frames;var h=0;var d="right";if(t==0){d="left"}if(t<=1){}n.setDimensions(i,a,r);n.setFrameCount(e.frames.length);for(var h=0;h<e.frames.length;h++){n.setCurrentFrame(h);var c=true;if(typeof e.frames[h].rotation!="undefined"){c=e.frames[h].rotation}if(typeof e.frames[h].chars!="undefined"){var f=e.frames[h].chars;var u=0;while(u<f.length){var p=f[u++];var v=f[u++];if(d=="left"){v=a-1-v}var g=f[u++];var m=f[u++];var y=f[u++];var b=false;if(t>=1.1){b=f[u++];if(b==-1){b=false}}var C=0;var x=0;var S=0;if(c){if(t==0){C=f[u++];x=f[u++]}else{var P=f[u++];C=P&3;x=(P&12)>>2;S=(P&30)>>4;C=C*.25;x=x*.25;S=S*.25}}this.editor.grid.setCell({c:m,x:p,y:v,z:g,fc:y,rx:C,ry:x,rz:S,bc:b,update:false})}}else if(typeof e.frames[h].slices!="undefined"){for(var u=0;u<e.frames[h].slices.length;u++){var w=e.frames[h].slices[u];var I=0;var p=0;var v=0;var g=w[I++];while(I<w.length){var m=w[I++];var y=w[I++];var b=false;if(t>=1.1){b=w[I++];if(b==-1){b=false}}var C=0;var x=0;var S=0;if(c){console.log("has rotation");if(t<=1){C=w[I++];x=w[I++]}else{var P=w[u++];C=P&3;x=(P&12)>>2;S=(P&30)>>4;C=C*.25;x=x*.25;S=S*.25}}this.editor.grid.setCell({c:m,x:p,y:v,z:g,fc:y,rx:C,ry:x,rz:S,bc:b,update:false});p++;if(p>=i){p=0;v++}}}}n.frames[h].duration=e.frames[h].duration;if(l=="ms"){var k=.05;n.frames[h].duration=Math.floor(e.frames[h].duration*k)}if(typeof e.frames[h].bgColor!="undefined"){n.frames[h].bgColor=e.frames[h].bgColor}else{n.frames[h].bgColor=s}if(typeof e.frames[h].borderColor!="undefined"){n.frames[h].borderColor=e.frames[h].borderColor}else{n.frames[h].borderColor=o}}n.setCurrentFrame(0)},getSaveData:function(){var e=this.editor.frames;var t=[];for(var i=0;i<e.frameCount;i++){var r={};r["duration"]=e.frames[i].duration;r["bgColor"]=e.frames[i].bgColor;var a=[];var s=false;for(var o=0;o<e.depth;o++){for(var l=0;l<e.height;l++){for(var n=0;n<e.width;n++){if(e.frames[i].data[o][l][n].rotX!=0||e.frames[i].data[o][l][n].rotY!=0||e.frames[i].data[o][l][n].rotZ!=0){s=true;l=e.height;o=e.depth;break}}}}for(var o=0;o<e.depth;o++){for(var l=0;l<e.height;l++){for(var n=0;n<e.width;n++){var h=e.frames[i].data[o][l][n];var d=e.frames[i].data[o][l][n].character;var c=h.bgColor;if(d!=this.editor.tileSetManager.blankCharacter||c!==false){a.push(n);a.push(l);a.push(o);a.push(d);a.push(h.color);if(c!==false){a.push(c)}else{a.push(-1)}if(s){var f=parseInt(h.rotX*4)%4;var u=parseInt(h.rotY*4)%4;var p=parseInt(h.rotZ*4)%4;var v=f+(u<<2)+(p<<4);a.push(v)}}}}}var g=[];for(var o=0;o<e.depth;o++){var m=true;for(var l=0;l<e.height;l++){for(var n=0;n<e.width;n++){var d=e.frames[i].data[o][l][n].character;if(d!=this.editor.tileSetManager.blankCharacter||e.frames[i].data[o][l][n].bgColor!==false){m=false;l=e.height;break}}}if(!m){var y=[];y.push(o);for(var l=0;l<e.height;l++){for(var n=0;n<e.width;n++){var h=e.frames[i].data[o][l][n];var d=e.frames[i].data[o][l][n].character;var b=e.frames[i].data[o][l][n].color;var c=e.frames[i].data[o][l][n].bgColor;y.push(d);y.push(b);if(c!==false){y.push(c)}else{y.push(-1)}if(s){var v=h.rotX+(h.rotY<<2)+(h.rotZ<<4);a.push(v)}}}g.push(y)}}var C=JSON.stringify(a);var x=JSON.stringify(g);if(C.length<x.length){r["chars"]=a}else{r["slices"]=g}r["rotation"]=s;t.push(r)}var S={};S["version"]=1.1;S["width"]=e.width;S["depth"]=e.depth;S["height"]=e.height;S["background"]=this.editor.tools.currentBackgroundColor;S["border"]=this.editor.tools.currentBorderColor;S["frames"]=t;S["timeUnits"]="ticks";S["clearColor"]=this.editor.clearColor;S["floorColor"]=this.editor.floorColor;return S}};var History=function(){this.editor=null;this.history=[];this.historyLength=0;this.historyPosition=0;this.changes=[];this.entryName="";this.enabled=true;this.newEntryEnabled=true};History.prototype={init:function(e){this.editor=e},setEnabled:function(e){this.enabled=e},getEnabled:function(e){return this.enabled},setNewEntryEnabled:function(e){this.newEntryEnabled=e},undo:function(){this.setEnabled(false);var e=false;if(this.historyPosition>0){this.historyPosition--;if(this.historyPosition<this.historyLength){var t=this.history[this.historyPosition];var i=this.editor.tileSetManager.getCurrentTileSet();var r=[];var a=false;var s={};for(var o=t.actions.length-1;o>=0;o--){var l=t.actions[o].name;var n=t.actions[o].params;if(l=="setCell"||l=="setCell3d"){a=true;if(this.editor.graphic.getCurrentFrame()!=n.frame){this.editor.frames.gotoFrame(n.frame)}var h=n.layerRef;s.t=n.oldCharacter;s.x=n.x;s.y=n.y;s.z=n.z;s.fc=n.oldColor;s.bc=n.oldBgColor;if(l=="setCell3d"){s.rx=n.oldRx;s.ry=n.oldRy}s.rz=n.oldRz;s.fh=n.oldFh;s.fv=n.oldFv;if(typeof n.oldB!==false){s.b=n.oldB}else{s.b=0}s.update=false;if(l=="setCell"){var d=this.editor.layers.getLayerObjectFromRef(h);if(d){d.setCell(s)}}else if(l=="setCell3d"){this.editor.grid3d.setCell(s)}}if(l=="setBlockCell"){e=true;var c=this.editor.blockSetManager.getCurrentBlockSet();c.setCharacterInBlock(n.b,n.x,n.y,n.oldCharacter)}if(l=="cursorLocation"){this.editor.gridView2d.setLastCursorLocation(n)}if(l=="cursorPixelLocation"){this.editor.tools.drawTools.pixelDraw.setLastCursorPixelLocation(n)}if(l=="setSelection"){this.editor.tools.drawTools.select.setSelection({from:n.lastFrom,to:n.lastTo,enabled:n.lastEnabled});this.editor.graphic.redraw({allCells:true})}if(l=="pixelSetSelection"){this.editor.tools.drawTools.pixelSelect.setSelection({from:n.lastFrom,to:n.lastTo,enabled:n.lastEnabled})}if(l=="setCharPixel"){i.setPixel(n.c,n.x,n.y,n.oldValue,false);var f=false;for(var u=0;u<r.length;u++){if(n.c==r[u]){f=true;break}}if(!f){r.push(n.c)}}if(l=="setBackgroundColor"){this.editor.tools.currentBackgroundColor=n.oldColor;this.editor.setBackgroundColor(n.oldColor)}if(l=="setBorderColor"){this.editor.tools.currentBorderColor=n.oldColor;this.editor.grid.setBorderColor(n.oldColor)}if(l=="insertframe"){this.editor.frames.deleteFrame(n.position+1)}if(l=="deleteframe"){this.editor.frames.insertFrame(n.position-1,false,n.frameData,n.layerFrameData)}if(l=="deletelayer"){this.editor.layers.newLayer({layerId:n.layerId,layerPosition:n.layerPosition,layerData:n.layerData});this.editor.graphic.redraw({allCells:true})}if(l=="createlayer"){this.editor.layers.deleteLayer({layerId:n.layerId})}}if(e){if(g_newSystem){this.editor.graphic.invalidateAllCells();this.editor.gridView2d.draw()}else{this.editor.grid.update({allCells:true})}}else if(a){if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}this.editor.layers.updateAllLayerPreviews()}if(r.length>0){for(var o=0;o<r.length;o++){i.updateCharacter(r[o])}this.editor.tileSetManager.tileSetUpdated();this.editor.graphic.invalidateAllCells();if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update({allCells:true})}}}}this.setEnabled(true)},redo:function(){this.setEnabled(false);if(this.historyPosition<this.historyLength){var e=this.history[this.historyPosition];var t=this.editor.tileSetManager.getCurrentTileSet();var i=[];var r=false;var a={};for(var s=0;s<e.actions.length;s++){var o=e.actions[s].name;var l=e.actions[s].params;if(o=="setCell"||o=="setCell3d"){r=true;if(this.editor.graphic.getCurrentFrame()!=l.frame){this.editor.frames.gotoFrame(l.frame)}var n=l.layerRef;a.t=l.newCharacter;a.x=l.x;a.y=l.y;a.z=l.z;a.fc=l.newColor;a.bc=l.newBgColor;a.rx=l.newRx;a.ry=l.newRy;a.rz=l.newRz;a.fh=l.newFh;a.fv=l.newFv;if(typeof l.newB!==false){a.b=l.newB}else{a.b=0}a.update=false;if(o=="setCell"){var h=this.editor.layers.getLayerObjectFromRef(n);if(h){h.setCell(a)}}else if(o=="setCell3d"){this.editor.grid3d.setCell(a)}}if(o=="setBlockCell"){r=true;var d=this.editor.blockSetManager.getCurrentBlockSet();d.setCharacterInBlock(l.b,l.x,l.y,l.newCharacter)}if(o=="setCharPixel"){t.setPixel(l.c,l.x,l.y,l.newValue,false);var c=false;for(var f=0;f<i.length;f++){if(l.c==i[f]){c=true;break}}if(!c){i.push(l.c)}}if(o=="setBackgroundColor"){this.editor.tools.currentBackgroundColor=l.newColor;this.editor.setBackgroundColor(l.newColor)}if(o=="setBorderColor"){this.editor.tools.currentBorderColor=l.newColor;this.editor.grid.setBorderColor(l.newColor)}if(o=="setSelection"){this.editor.tools.drawTools.select.setSelection({from:l.from,to:l.to,enabled:l.enabled});this.editor.graphic.redraw({allCells:true})}if(o=="pixelSetSelection"){this.editor.tools.drawTools.pixelSelect.setSelection({from:l.from,to:l.to,enabled:l.enabled})}if(o=="insertframe"){this.editor.frames.insertFrame(l.position)}if(o=="deleteframe"){this.editor.frames.deleteFrame(l.position)}if(o=="deletelayer"){this.editor.layers.deleteLayer({layerId:l.layerId})}if(o=="createlayer"){this.editor.layers.newLayer({layerId:l.layerId})}}if(r){if(o=="setCharPixel"){this.editor.graphic.invalidateAllCells()}if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update({allCells:true})}this.editor.layers.updateAllLayerPreviews()}if(i.length>0){for(var s=0;s<i.length;s++){t.updateCharacter(i[s])}this.editor.tileSetManager.tileSetUpdated();this.editor.graphic.invalidateAllCells();if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update({allCells:true})}}this.historyPosition++}this.setEnabled(true)},startEntry:function(e){if(!this.enabled){return}if(!this.newEntryEnabled){return}this.endEntry();this.changes=[];this.entryName=e},addAction:function(e,t){if(!this.enabled){return}if(e=="setCell"||e=="setCell3d"){for(var i=this.changes.length-1;i>=0;i--){if(this.changes[i].name==e&&this.changes[i].params.x==t.x&&this.changes[i].params.y==t.y&&this.changes[i].params.z==t.z&&this.changes[i].params.frame==t.frame){t.layerRef=this.changes[i].params.layerRef;t.oldCharacter=this.changes[i].params.oldCharacter;t.oldColor=this.changes[i].params.oldColor;t.oldBgColor=this.changes[i].params.oldBgColor;t.oldRotX=this.changes[i].params.oldRotX;t.oldRotY=this.changes[i].params.oldRotY;t.oldRotZ=this.changes[i].params.oldRotZ;this.changes.splice(i,1)}}}this.changes.push({name:e,params:t})},endEntry:function(){if(!this.enabled){return}if(!this.newEntryEnabled){return}if(this.changes.length>0){this.history[this.historyPosition]={name:this.entryName,actions:this.changes};this.historyPosition++;this.historyLength=this.historyPosition}this.changes=[]}};var Info=function(){this.character=0;this.block=false;this.fgColor=0;this.bgColor=0;this.x=0;this.y=0;this.z=0;this.characterCanvas=null;this.characterContext=null};Info.prototype={init:function(e){this.editor=e},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.HTMLPanel",{id:"info"});UI.on("ready",function(){t.uiComponent.load("html/textMode/info.html",function(){t.initEvents();t.initContent()})});e.add(this.uiComponent)},initEvents:function(){var t=this;this.characterCanvas=document.getElementById("infoCharacterCanvas");$("#infoPanelCloseButton").on("click",function(e){t.editor.setInfoPanelVisible(false)})},initContent:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=8;var i=8;this.characterCanvasScale=Math.floor(UI.devicePixelRatio);this.characterCanvas.width=2*t*this.characterCanvasScale;this.characterCanvas.height=2*i*this.characterCanvasScale;this.characterCanvas.style.width=2*t+"px";this.characterCanvas.style.height=2*i+"px";this.characterContext=this.characterCanvas.getContext("2d");this.characterImageData=this.characterContext.getImageData(0,0,this.characterCanvas.width,this.characterCanvas.height)},leaveGrid:function(){var e="";$("#info-coordinates").html(e)},setCoordinates:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(e==this.x&&t==this.y&&i==this.z){return}this.x=e;this.y=t;this.z=i;var a=this.x;var s=this.y;var o="X: "+a;o+=", ";o+="Y: "+s;o+="<br>";if(r&&r.getType()=="grid"){var l=this.x+this.y*this.editor.frames.width;var n=("0000"+l.toString(16)).substr(-4);o+=" "+l+" (0x"+n+")"}$("#info-coordinates").html(o)},setBlock:function(e){if(typeof e=="undefined"||e===false){return}if(e===this.block){return}this.block=e;var t=("00"+e.toString(16)).substr(-2);var i="";i+=e+" (0x"+t+")";$("#info-block").html(i)},setCharacter:function(e){if(e==this.character){return}this.character=e;var t=("00"+e.toString(16)).substr(-2);var i="";i+=e+" (0x"+t+")";$("#info-character").html(i);var r=2*this.characterCanvasScale;var a=this.editor.tileSetManager.getCurrentTileSet();var s=parseInt(e);if(isNaN(s)){return}a.drawCharacter({character:s,x:0,y:0,scale:r,imageData:this.characterImageData,colorRGB:14540253,bgColorRGB:1118481});this.characterContext.putImageData(this.characterImageData,0,0)},setFGColor:function(e){if(e==this.fgColor||typeof e=="undefined"){return}this.fgColor=e;if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR&&e>=8&&this.editor.graphic.getType()!="sprite"){e-=8}var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i="#"+t.getHexString(e);$("#infoCellFGColor").css("background-color",i);$("#infoCellFGColorIndex").html(e);var r=("00"+e.toString(16)).substr(-2);$("#infoCellFGColorHex").html("(0x"+r+")");if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){$(".currentCellColorDisplay").css("background-color",i)}},setBGColor:function(e){if(e==this.bgColor){return}this.bgColor=e;if(e===this.editor.colorPaletteManager.noColor){$("#infoCellBGColor").css("color","#ffffff");$("#infoCellBGColor").css("background-color","#000000");$("#infoCellBGColor").html('<i style="font-size: 16px; margin-top: -1px" class="halflings halflings-remove"></i>')}else{this.editor.colorPaletteManager.getCurrentColorPalette();var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i="#"+t.getHexString(e);$("#infoCellBGColor").css("background-color",i);$("#infoCellBGColor").html("")}var r="bg: ";if(e===false){r+=""}else{r+=e}},setZoom:function(e){var e=e*100;var t=e.toFixed(2)+"%";$("#info-zoom").html(t)},setScreenMode:function(e){switch(e){case TextModeEditor.Mode.TEXTMODE:case TextModeEditor.Mode.C64ECM:$("#info-bgColor").show();$("#info-fgColor").show();break;case TextModeEditor.Mode.C64STANDARD:$("#info-bgColor").hide();$("#info-fgColor").show();break;case TextModeEditor.Mode.C64MULTICOLOR:$("#info-fgColor").show();$("#info-bgColor").hide();break;case TextModeEditor.Mode.INDEXED:case TextModeEditor.Mode.RGB:$("#info-bgColor").hide();$("#info-fgColor").hide();break;default:$("#info-bgColor").show();$("#info-fgColor").show();break}}};var GridInfo=function(){this.character=0;this.block=false;this.fgColor=0;this.bgColor=0;this.x=0;this.y=0;this.z=0;this.characterCanvas=null;this.characterContext=null};GridInfo.prototype={init:function(e){this.editor=e},buildInterface:function(e){var t=this;var i='<div style="background-color: #1d1d1d; position: absolute; top: 0; left: 0; right: 0; bottom: 0">';i+='<div id="gridinfo-coordinates" style="padding: 4px"></div>';i+='<div id="gridInfoZoom" style="text-align: right; display: block; position: absolute; width: 160px; right: 80px; top: 4px">';i+="Zoom: ";i+="</div>";i+='<div style="position: absolute; top: 4px; right: 4px">';i+='<div class="ui-button" style="margin-right: 4px; height: 14px; width: 10px; padding: 2px 4px; text-align: center; line-height: 12px" id="gridInfoZoomOut">-</div>';i+='<div class="ui-button" style="margin-right: 4px; height: 14px; width: 10px;  padding: 2px 4px; text-align: center; line-height: 12px" id="gridInfoZoomIn">+</div>';i+='<div class="ui-button" style="height: 14px; width: 10px;  padding: 2px 8px 2px 6px; text-align: center; line-height: 12px" id="gridInfoZoomFit">Fit</div>';i+="</div>";i+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{id:"gridinfo",html:i});e.add(this.uiComponent);UI.on("ready",function(){t.initEvents()})},initEvents:function(){var e=this;$("#gridInfoZoomOut").on("click",function(){e.editor.zoom(-1)});$("#gridInfoZoomIn").on("click",function(){e.editor.zoom(1)});$("#gridInfoZoomFit").on("click",function(){e.editor.fitOnScreen(1)})},leaveGrid:function(){var e="";$("#info-coordinates").html(e)},setSpriteInfo:function(e,t,i,r,a,s){var o=this.editor.layers.getSelectedLayerObject();var l=o.getColorPalette();if(e==this.x&&t==this.y&&i==this.z&&this.tileIndex==r&&this.fc==a&&this.bc==s){return}this.x=e;this.y=t;this.z=i;this.tileIndex=r;this.bc=s;this.fc=a;this.fgColorHex="#"+l.getHexString(this.fc);this.bgColorHex="";if(this.bc!==-1){this.bgColorHex="#"+l.getHexString(this.bc)}var n=this.x;var h=this.y;var d="";d+='<div style="display: inline-block; width: 100px; overflow: hidden">';d+='<label class="gridinfo-label">XY:</label>';d+='<div class="gridinfo-value">'+n+", "+h+"</div>";d+="</div>";$("#gridinfo-coordinates").html(d)},setInfo:function(e,t,i,r,a,s){var o=this.editor.layers.getSelectedLayerObject();var l=o.getColorPalette();if(e==this.x&&t==this.y&&i==this.z&&this.tileIndex==r&&this.fc==a&&this.bc==s){return}this.x=e;this.y=t;this.z=i;this.tileIndex=r;this.bc=s;this.fc=a;this.fgColorHex="#"+l.getHexString(this.fc);this.bgColorHex="";if(this.bc!==-1){this.bgColorHex="#"+l.getHexString(this.bc)}var n=this.x;var h=this.y;var d="";d+='<div style="display: inline-block; width: 100px; overflow: hidden">';d+='<label class="gridinfo-label">XY</label>';d+='<div class="gridinfo-value">'+n+", "+h+"</div>";d+="</div>";if(o&&o.getType()=="grid"){var c=this.x+this.y*this.editor.graphic.getGridWidth();var f=("0000"+c.toString(16)).substr(-4);d+='<div style="display: inline-block; width: 100px; overflow: hidden">';d+='<div class="gridinfo-value">';d+=" "+c+" (0x"+f+")";d+="</div>";d+="</div>"}d+='<div style="display: inline-block; width: 100px; overflow: hidden">';d+='<label class="gridinfo-label">Tile</label>';d+='<div class="gridinfo-value">'+this.tileIndex;var u=this.tileIndex.toString(16);d+=" (0x"+u+")";d+="</div>";d+="</div>";d+='<div style="display: inline-block; width: 100px; overflow: hidden">';d+='<label class="gridinfo-label">FG Colour</label>';d+='<div class="gridinfo-value">';d+='<div style="display: inline-block; width: 12px; height: 12px; margin-right: 3px; background-color:'+this.fgColorHex+';"></div>';d+=this.fc;d+="</div>";d+="</div>";d+='<div style="display: inline-block; width: 140px; overflow: hidden">';d+='<label class="gridinfo-label">BG Colour</label>';d+='<div class="gridinfo-value">';if(this.bc!=-1){d+='<div style="display: inline-block; width: 12px; height: 12px; margin-right: 3px; background-color:'+this.bgColorHex+';"></div>';d+=this.bc}else{d+="use frame"}d+="</div>";d+="</div>";$("#gridinfo-coordinates").html(d)},setBlock:function(e){if(typeof e=="undefined"||e===false){return}if(e===this.block){return}this.block=e;var t=("00"+e.toString(16)).substr(-2);var i="";i+=e+" (0x"+t+")";$("#info-block").html(i)},setCharacter:function(e){if(e==this.character){return}this.character=e;var t=("00"+e.toString(16)).substr(-2);var i="";i+=e+" (0x"+t+")";$("#info-character").html(i);var r=2*this.characterCanvasScale;var a=this.editor.tileSetManager.getCurrentTileSet();var s=parseInt(e);if(isNaN(s)){return}a.drawCharacter({character:s,x:0,y:0,scale:r,imageData:this.characterImageData,colorRGB:14540253,bgColorRGB:1118481});this.characterContext.putImageData(this.characterImageData,0,0)},setFGColor:function(e){if(e==this.fgColor||typeof e=="undefined"){return}this.fgColor=e;if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR&&e>=8&&this.editor.graphic.getType()!="sprite"){e-=8}var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i="#"+t.getHexString(e);$("#infoCellFGColor").css("background-color",i);$("#infoCellFGColorIndex").html(e);var r=("00"+e.toString(16)).substr(-2);$("#infoCellFGColorHex").html("(0x"+r+")");if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){$(".currentCellColorDisplay").css("background-color",i)}},setBGColor:function(e){if(e==this.bgColor){return}this.bgColor=e;if(e===this.editor.colorPaletteManager.noColor){$("#infoCellBGColor").css("color","#ffffff");$("#infoCellBGColor").css("background-color","#000000");$("#infoCellBGColor").html('<i style="font-size: 16px; margin-top: -1px" class="halflings halflings-remove"></i>')}else{this.editor.colorPaletteManager.getCurrentColorPalette();var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i="#"+t.getHexString(e);$("#infoCellBGColor").css("background-color",i);$("#infoCellBGColor").html("")}var r="bg: ";if(e===false){r+=""}else{r+=e}},setZoom:function(e){var e=e*100;var t='<label class="gridinfo-label">Zoom</label>';t+='<div class="gridinfo-value">';t+=e.toFixed(0)+"%";t+="</div>";$("#gridInfoZoom").html(t)},setScreenMode:function(e){switch(e){case TextModeEditor.Mode.TEXTMODE:case TextModeEditor.Mode.C64ECM:$("#info-bgColor").show();$("#info-fgColor").show();break;case TextModeEditor.Mode.C64STANDARD:$("#info-bgColor").hide();$("#info-fgColor").show();break;case TextModeEditor.Mode.C64MULTICOLOR:$("#info-fgColor").show();$("#info-bgColor").hide();break;case TextModeEditor.Mode.INDEXED:case TextModeEditor.mode.RGB:$("#info-bgColor").hide();$("#info-fgColor").hide();break;default:$("#info-bgColor").show();$("#info-fgColor").show();break}}};var MobileMenu=function(){this.editor=null;this.uiComponent=null;this.menuPosition=0;this.touchStartX=0;this.touchStartY=0;this.touchStartScrollY=0;this.moveHorizonal=false;this.moveVertical=false;this.touchVelocity=null};MobileMenu.prototype={init:function(e){this.editor=e;this.touchVelocity=new TouchVelocity},initEvents:function(){var i=this;$(".mobileMenuItem").on("click",function(e){var t=$(this).attr("data-value");i.menuItemSelected(t)})},getMenuHTML:function(){var e=[{className:"screen-menu-item",label:"Dimensions",id:"dimensions",icon:'<img  height="25" src="icons/svg/glyphicons-basic-69-ruler.svg"/>'},{label:"Screen Mode",id:"screenmode",icon:'<img  height="25" src="icons/svg/glyphicons-basic-87-tv.svg"/>'},{label:"Reference Image",id:"referenceimage",icon:'<img  height="25" src="icons/svg/glyphicons-halflings-15-picture.svg"/>'},{className:"screen-menu-item",label:"Choose A Character Set",id:"tilesetpreset",icon:'<img height="25" src="icons/svg/glyphicons-basic-422-book-library.svg"/>'},{label:"Choose A Colour Palette",id:"colorpalettepreset",icon:'<img height="25" src="icons/svg/glyphicons-basic-444-sampler.svg"/>'},{className:"screen-menu-item",label:"Import Image / Video",id:"importimage",icon:'<img  height="25" src="icons/svg/glyphicons-basic-399-import.svg">'},{label:"Export GIF/PNG",id:"exportimage",icon:'<img  height="25" src="icons/svg/glyphicons-basic-199-save.svg">'},{label:"Export PNG",id:"exportpng",icon:'<img  height="25" src="icons/svg/glyphicons-basic-199-save.svg">'},{label:"Export GIF",id:"exportgif",icon:'<img  height="25" src="icons/svg/glyphicons-basic-199-save.svg">'},{className:"screen-menu-item",label:"Export Tileset",id:"exporttileset",icon:'<img  height="25" src="icons/svg/glyphicons-basic-199-save.svg">'},{label:"Toggle Grid",id:"togglegrid",icon:'<img height="25" src="icons/material/grid_on-24px.svg"/>'},{label:"Toggle Show Previous Frame",id:"toggleprev"},{label:"Minimal Interface",id:"minimalinterface"},{label:"Desktop Mode",id:"desktopview"}];var t="";t+='<div class="mobile-menu-header" style="position: absolute; top: 0; left: 0; right: 0; height: 200px; background-color: #111111">';t+='<div id="mobileMenuUserInfo"></div>';t+='<div style="padding: 0 10px 0 10px">';t+='<div style="padding: 0 0 10px 0">';if(SHOWUNFINISHED){t+='<div class="ui-button ui-button-primary" id="mobileMenuProjectExplorer"> <img height="25" src="icons/svg/glyphicons-basic-21-home.svg">&nbsp;Project Explorer</div>';t+="&nbsp;"}t+='<div class="ui-button ui-button-info" id="mobileMenuSave" style="margin-right: 10px"> <img  height="25" src="icons/svg/glyphicons-basic-199-save.svg"/>&nbsp;<span class="ui-text" data-textid="Save">'+TextStore.get("Save")+"</div>";t+='<div class="ui-button ui-button-info" id="mobileMenuSaveAs"> <img  height="25"  src="icons/svg/glyphicons-basic-200-save-as.svg"/>&nbsp;<span class="ui-text" data-textid="Save As">'+TextStore.get("Save As")+"</span>...</div>";t+="</div>";t+='<div style="padding: 10px 0">';t+='<div class="ui-button ui-button-info" id="mobileMenuGitHub"> <img  height="25" src="icons/svg/glyphicons-basic-545-cloud-upload.svg"/>&nbsp;<span class="ui-text" data-textid="Commit To GitHub">'+TextStore.get("Commit To GitHub")+"</span>...</div>";t+="</div>";t+="</div>";t+="</div>";t+='<div id="mobile-menu-content" style="position: absolute; top: 200px; left: 0; right: 0; bottom: 0; overflow-y: auto; background-color: #222222">';for(var i=0;i<e.length;i++){var r=e[i].className;t+="<div";if(typeof r!="undefined"){t+=' class="'+r+'"'}t+=">";t+='<a href="javascript: void(0)"  class="mobile-menu-item" data-id="'+e[i].id+'">';t+='<div class="rippleJS-manual"></div>';t+='<div class="mobile-menu-icon" >';if(e[i].icon){t+=e[i].icon}t+="</div>";t+='<span class="ui-text" data-textid="'+e[i].label+'" id="mobile-menu-item-'+e[i].id+'">';t+=TextStore.get(e[i].label);t+="</span>";t+="</a>";t+="</div>"}t+="</div>";return t},show:function(){var o=this;if(this.uiComponent==null){var e=UI.getScreenWidth();var t=UI.getScreenHeight();o.menuWidth=e-80;o.menuHeight=t;if(o.menuWidth>330){o.menuWidth=330}this.uiComponentHolder=document.createElement("div");this.uiComponentHolder.setAttribute("id","mobile-menu-holder");this.uiComponentHolder.setAttribute("style","position: absolute; z-index: 90; top: 0; bottom: 0; left: 0; right:0; background-color: black; opacity: 0.6; display: none");document.body.append(this.uiComponentHolder);$("#mobile-menu-holder").on("click",function(e){o.hideMenu()});this.uiComponent=document.createElement("div");this.uiComponent.setAttribute("id","mobile-menu");this.uiComponent.setAttribute("style","position: absolute; z-index: 100; display: none");document.body.append(this.uiComponent);$("#mobile-menu").css("top","0");$("#mobile-menu").css("bottom","0");$("#mobile-menu").css("overflow","auto");$("#mobile-menu").css("left","-"+this.menuWidth+"px");$("#mobile-menu").css("width",this.menuWidth+"px");$("#mobile-menu").css("background-color","#222222");var i=this.getMenuHTML();$("#mobile-menu").html(i);g_app.displayUserDetails();$(".mobile-menu-item").on("click",function(e){var t=$(this).attr("data-id");o.hideMenu(t)});$(".mobile-menu-header").on("contextmenu",function(e){e.preventDefault()});$(".mobile-menu-header").on("touchstart",function(e){o.touchStart(e)});$(".mobile-menu-header").on("touchmove",function(e){o.touchMove(e)});$(".mobile-menu-header").on("touchend",function(e){o.touchEnd(e)});$(".mobile-menu-item").on("contextmenu",function(e){});$(".mobile-menu-item").on("touchstart",function(e){o.touchStart(e)});$(".mobile-menu-item").on("touchmove",function(e){o.touchMove(e)});$(".mobile-menu-item").on("touchend",function(e){o.touchEnd(e)});$("#mobile-menu-content").on("scroll",function(e){var t=$(this).scrollTop();var i=o.touchStartScrollY-t;if(i<0){i=-i}if(i>5){o.moveVertical=true}});$("#mobileMenuProjectExplorer").on("click",function(){o.hideMenu();g_app.showProjectNavigator()});$("#mobileMenuSave").on("click",function(){o.hideMenu();g_app.fileManager.save()});$("#mobileMenuSaveAs").on("click",function(){o.hideMenu();g_app.fileManager.showSaveAs()});$("#mobileMenuGitHub").on("click",function(){o.hideMenu();g_app.github.save()})}if(this.editor.graphic.getType()=="sprite"){$("#mobile-menu-content .screen-menu-item").hide()}else{$("#mobile-menu-content .screen-menu-item").show()}if(this.editor.getGridVisible()){this.setMenuItemText("togglegrid","Hide Grid")}else{this.setMenuItemText("togglegrid","Show Grid")}if(this.editor.frames.showPrevFrame){this.setMenuItemText("toggleprev","Hide Prev Frame")}else{this.setMenuItemText("toggleprev","Show Prev Frame")}$("#mobile-menu").show();$("#mobile-menu-holder").show();var r=300*(-this.menuPosition/this.menuWidth);$("#mobile-menu").animate({left:"0px"},{duration:300,step:function(e,t){var i=$("#mobile-menu").position();var r=i.left;var a=(o.menuWidth+r)/o.menuWidth;var s=.6*a;$("#mobile-menu-holder").css("opacity",s)},complete:function(){UI.browserPushState({type:"mobile-menu"},"lvllvl Menu",window.location.href);o.menuPosition=0}})},setMenuItemText:function(e,t){$("#mobile-menu-item-"+e).html(t)},setMenuPosition:function(e){this.menuPosition=e;$("#mobile-menu").css("left",e+"px");var t=(this.menuWidth+this.menuPosition)/this.menuWidth;var i=.6*t;$("#mobile-menu-holder").css("opacity",i)},showRipple:function(){console.log("show ripple");var e=getHolderWithRippleJsClass(this.touchAt,"rippleJS-manual");startRipple("touchstart",this.touchAt,e)},touchStart:function(e){this.touchVelocity.touchStart(e);var t=e.touches;this.touchStartScrollY=$("#mobile-menu-content").scrollTop();if(t.length>0){var i=t[0].pageX;var r=t[0].pageY;this.touchStartX=i;this.touchStartY=r;this.touchAt={offsetX:t[0].offsetX,offsetY:t[0].offsetY,clientX:t[0].clientX,clientY:t[0].clientY,target:t[0].target};console.log(this.touchAt);console.log(t[0].target);var a=this;setTimeout(function(){if(!a.moveHorizonal&&!a.moveVertical){a.showRipple()}},170)}},touchMove:function(e){this.touchVelocity.touchMove(e);var t=e.touches;if(t.length>0){var i=t[0].pageX;var r=t[0].pageY;if(this.moveVertical){return}var a=i-this.touchStartX;var s=-16;if(a<s){this.moveHorizonal=true}if(this.moveHorizonal){a=i-this.touchStartX-s;if(a>0){a=0}this.setMenuPosition(a)}}},touchEnd:function(e){this.touchVelocity.touchEnd(e);var t=e.touches;this.moveHorizonal=false;this.moveVertical=false;var i=this.menuWidth/3.5;if(i<-95){i=-95}var r=this.touchVelocity.getVelocity();if(-this.menuPosition>i||r.vx<-1.5){this.hideMenu(false,r)}else{this.show()}},hideMenu:function(e,t){var i=this;var r=300;var a=$("#mobile-menu").position();var s=a.left;var o=-this.menuWidth;var l=s-o;if(typeof t!="undefined"){r=-l/t.vx;if(r>300){r=300}}$("#mobile-menu").animate({left:"-"+this.menuWidth+"px"},r,function(){$("#mobile-menu").hide();$("#mobile-menu-holder").fadeOut(10);if(typeof e!="undefined"&&e!==false){i.menuItemSelected(e)}})},menuItemSelected:function(e){if(this.moveHorizonal){return}UI.closeDialog();switch(e){case"projectexplorer":g_app.showProjectNavigator();break;case"dimensions":this.editor.showDimensionsDialog();break;case"screenmode":this.editor.showScreenModeDialog();break;case"referenceimage":this.editor.showReferenceImageDialog();break;case"tilesetpreset":this.editor.tileSetManager.showChoosePreset({});break;case"colorpalettepreset":this.editor.colorPaletteManager.showChoosePreset({});break;case"save":g_app.fileManager.save();break;case"saveas":g_app.fileManager.showSaveAs();break;case"savetogithub":g_app.github.save();break;case"download":g_app.fileManager.showDownload();break;case"exportimage":this.editor.exportImage();break;case"exportpng":this.editor.exportPng();break;case"exportgif":this.editor.exportGif();break;case"exporttileset":this.editor.exportTileset();break;case"importimage":this.editor.importImage.start();break;case"togglegrid":this.editor.setGridVisible(!this.editor.getGridVisible());break;case"toggleprev":this.editor.frames.setShowPrevFrame(!this.editor.frames.showPrevFrame);break;case"minimalinterface":if(g_app.getMobileInterfaceType()=="full"){g_app.mobileReduceInterface()}else{g_app.mobileRestoreInterface()}break;case"desktopview":if(confirm("Are you sure you want to switch to desktop mode?")){g_app.setDeviceType("desktop")}break}}};var Graphic=function(){this.editor=null;this.frames=[];this.frameCount=0;this.currentFrame=0;this.tileSetId=false;this.colorPaletteId=false;this.gridWidth=40;this.gridHeight=25;this.cellWidth=8;this.cellHeight=8;this.depth=1;this.onlyViewBoundsDrawn=true;this.tempCanvas=null;this.shapesCanvas=null;this.lastDrawnPrevFrame=false;this.drawEnabled=true;this.doc=null;this.type="screen";this.thumbnailCanvas=null};Graphic.prototype={init:function(e){this.editor=e},connectToDoc:function(){var e=this.editor.doc;if(e.data.frames==null){e.data.frames=[]}this.doc=e;this.frames=e.data.frames;this.frameCount=this.frames.length;this.editor.layers.load()},getFrameRanges:function(){if(typeof this.doc.data.frameRanges==="undefined"){this.doc.data.frameRanges=[{start:0,end:this.getFrameCount()}]}return this.doc.data.frameRanges},setFrameRanges:function(e){this.doc.data.frameRanges=e},getHasTileMaterials:function(){var e=this.doc.data.hasTileMaterials;if(typeof e==="undefined"){return false}return e},setHasTileMaterials:function(e){this.doc.data.hasTileMaterials=e},getHasTileFlip:function(){var e=this.editor.layers.getSelectedLayerObject();if(e&&e.getType()=="grid"){return e.getHasTileFlip()}return false},setHasTileFlip:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return}t.setHasTileFlip(e)},getHasTileRotate:function(){var e=this.editor.layers.getSelectedLayerObject();if(e&&e.getType()=="grid"){return e.getHasTileRotate()}return false},setHasTileRotate:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return}t.setHasTileRotate(e)},loadJSON:function(e){var t=e.frames;var i=e.layers;var r=e.name;var a=i[0].gridWidth;var s=i[0].gridHeight;this.doc.data.frames=t;this.frames=this.doc.data.frames;this.setGridDimensions({width:a,height:s});var o=this.editor.layers.getSelectedLayerObject();o.setFromJSON(i[0]);if(i.length>0){for(var l=1;l<i.length;l++){var n=this.editor.layers.newLayer({label:i[l].label,type:"grid"});o=this.editor.layers.getLayerObject(n);o.setFromJSON(i[l])}}},getJSON:function(e){var t=0;var i=this.getFrameCount();var r="all";var a="bottomtotop";if(typeof e!="undefined"){if(typeof e.fromFrame!="undefined"){t=e.fromFrame}if(typeof e.toFrame!="undefined"){i=e.toFrame}if(typeof e.layers!="undefined"){r=e.layers}if(typeof e.direction!="undefined"){a=e.direction}}var s={};var o=[];s.frames=[];for(var l=t;l<i;l++){s.frames.push(this.frames[l])}s.frameRanges=this.doc.data.frameRanges;s.layers=[];var n=this.editor.layers.getLayers();for(var l=0;l<n.length;l++){var h=this.editor.layers.getLayerObject(n[l].layerId);if(h){s.layers.push(h.getJSON(e))}}s.name=this.doc.name;return s},getType:function(){return this.type},getThumbnailCanvas:function(){var e=90;var t=90;if(this.thumbnailCanvas==null){this.thumbnailCanvas=document.createElement("canvas")}try{console.log("GET THUMBNAIL CANVAS!!!!!!");var i=this.thumbnailCanvas.getContext("2d");i.imageSmoothingEnabled=false;i.webkitImageSmoothingEnabled=false;i.mozImageSmoothingEnabled=false;i.msImageSmoothingEnabled=false;i.oImageSmoothingEnabled=false;var r=86;var a=86;var s=1;i.clearRect(0,0,e,t);i.fillStyle="#040404";i.fillRect(0,0,e,t);var e=this.getGraphicWidth();var t=this.getGraphicHeight();s=r/e;console.log(s);if(s<.1){s=.1}s=1;this.drawFrame({canvas:this.thumbnailCanvas,scale:s,context:i})}catch(e){console.error(e)}return this.thumbnailCanvas},getC64Multi1Color:function(e){var t=e;if(typeof t=="undefined"){t=this.currentFrame}var i=this.editor.layers.getSelectedLayerObject();var r=false;if(this.frames&&t!==false&&t<this.frames.length&&i&&i.getC64Multi1Color){r=i.getC64Multi1Color(t);if(typeof r!="undefined"){return r}}return 0},getC64Multi2Color:function(e){var t=e;if(typeof t=="undefined"){t=this.currentFrame}var i=this.editor.layers.getSelectedLayerObject();var r=false;if(this.frames&&t!==false&&t<this.frames.length&&i&&i.getC64Multi2Color){r=i.getC64Multi2Color(t);if(typeof r!="undefined"){return r}}return 0},getBackgroundColor:function(e){var t=e;if(typeof t=="undefined"){t=this.currentFrame}var i=this.editor.layers.getSelectedLayerObject();var r=false;if(this.frames&&t!==false&&t<this.frames.length&&i&&i.getBackgroundColor){r=i.getBackgroundColor(t);if(typeof r!="undefined"){return r}}var a=this.editor.colorPaletteManager.getCurrentColorPalette();r=a.getDefaultBackgroundColor();return r},setBackgroundColor:function(e,t){if(!this.frames||this.currentFrame===false){return}var i=this.editor.layers.getSelectedLayerObject();if(this.currentFrame!==false&&this.currentFrame<this.frames.length&&i&&i.setBackgroundColor){i.setBackgroundColor(e,this.currentFrame)}},getBorderColor:function(e){var t=e;if(typeof t=="undefined"){t=this.currentFrame}var i=this.editor.layers.getSelectedLayerObject();var r=false;if(this.frames&&t!==false&&t<this.frames.length&&i&&i.getBorderColor){r=i.getBorderColor(t);if(typeof r!="undefined"){return r}}var a=i.getColorPalette();r=a.getDefaultBorderColor();return r},setBorderColor:function(e,t){if(!this.frames||this.currentFrame===false){return}var i=this.editor.layers.getSelectedLayerObject();if(this.currentFrame!==false&&this.currentFrame<this.frames.length&&i&&i.setBorderColor){i.setBorderColor(e,this.currentFrame)}},insertFrame:function(e,t,i,r){if(typeof e=="undefined"){e=this.currentFrame}if(typeof t=="undefined"){t=this.frames[this.currentFrame].duration}var a=i;if(typeof a=="undefined"){a={duration:t}}this.frames.splice(e+1,0,a);var s=this.editor.layers.layers;for(var o=0;o<s.length;o++){if(s[o].type=="grid"){var l=this.editor.layers.getLayerObject(s[o].layerId);var i=null;if(typeof r!="undefined"){for(var n=0;n<r.length;n++){if(r[n].layerId==s[o].layerId){i=r[n].gridData}}}l.insertFrame(e,i)}}var h=this.getFrameRanges();var d=false;for(var o=0;o<h.length;o++){if(!d&&e+1>=h[o].start&&e+1<=h[o].end){d=true;h[o].end++}else if(d){h[o].start++;h[o].end++}}this.frameCount++;this.fixFrameRanges();this.editor.history.startEntry("insertframe");this.editor.history.addAction("insertframe",{position:e});this.editor.history.endEntry();return e+1},duplicateFrame:function(e){if(typeof e=="undefined"){e=this.currentFrame}var t=e+1;this.editor.history.startEntry("Duplicate");this.editor.history.setNewEntryEnabled(false);this.insertFrame(e);this.setCurrentFrame(t);var i=this.editor.layers.layers;for(var r=0;r<i.length;r++){if(i[r].type=="grid"){var a=this.editor.layers.getLayerObject(i[r].layerId);a.duplicateFrame(e,t)}}this.editor.history.setNewEntryEnabled(true);this.editor.history.endEntry();if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}return t},setViewBounds:function(e,t,i,r){this.viewMinX=e;this.viewMaxX=i;this.viewMinY=t;this.viewMaxY=r;this.viewBounds={x:e,y:t,width:i-e,height:r-t};var a=this.editor.layers.layers;for(var s=0;s<a.length;s++){if(a[s].type=="grid"){var o=this.editor.layers.getLayerObject(a[s].layerId);o.setViewBounds(e,t,i,r)}}},getViewBounds:function(){return this.viewBounds},deleteFrame:function(e){if(typeof e=="undefined"){e=this.currentFrame}if(this.frameCount<=1){return false}var t=this.frames.splice(e,1);var i=[];var r=this.editor.layers.layers;for(var a=0;a<r.length;a++){if(r[a].type=="grid"){var s=this.editor.layers.getLayerObject(r[a].layerId);var o=s.getFrameData(e);i.push({layerId:r[a].layerId,gridData:o});s.deleteFrame(e)}}var l=this.getFrameRanges();var n=false;for(var a=0;a<l.length;a++){if(!n&&e+1>l[a].start&&e<l[a].end){n=true;l[a].end--}else if(n){l[a].start--;l[a].end--}}var h=this.frameCount-1;this.setFrameCount(h);this.fixFrameRanges();this.editor.history.startEntry("deleteframe");this.editor.history.addAction("deleteframe",{position:e,frameData:t[0],layerFrameData:i});this.editor.history.endEntry();return true},fixFrameRanges:function(){var e=this.getFrameRanges();for(var t=0;t<e.length;t++){if(e[t].start==e[t].end){e.splice(t,1)}}e.sort(function(e,t){return e.start-t.start});var i=this.getFrameCount();if(e.length==0){e.push({start:0,end:i})}var r=0;for(var t=0;t<e.length;t++){if(e[t].start!==r){e[t].start=r}r=e[t].end}e[e.length-1].end=i},setFrameCount:function(e){while(e>this.frames.length){this.frames.push({duration:12})}if(e<this.frameCount){this.frames.length=e}var t=this.editor.layers.layers;for(var i=0;i<t.length;i++){if(t[i].type=="grid"){var r=this.editor.layers.getLayerObject(t[i].layerId);r.setFrameCount(e)}}this.frameCount=e},setCurrentFrame:function(e){if(this.currentFrame===e){return}this.currentFrame=e;var t=this.editor.layers.layers;for(var i=0;i<t.length;i++){if(t[i].type=="grid"){var r=this.editor.layers.getLayerObject(t[i].layerId);r.setCurrentFrame(e)}}this.redraw()},getCurrentFrame:function(){return this.currentFrame},getFrameCount:function(){return this.frameCount},setFrameDuration:function(e,t){var i=this.currentFrame;if(typeof t!=="undefined"){i=t}if(i<0||i>=this.frameCount){return}this.frames[i].duration=e},getFrameDuration:function(e){return this.frames[e].duration},getGridWidth:function(){return this.gridWidth},getGridHeight:function(){return this.gridHeight},getGraphicWidth:function(){if(this.doc){return this.doc.data.width}else{return 1}},getGraphicHeight:function(){if(this.doc){return this.doc.data.height}else{return 1}},setCellDimensionsFromTiles:function(){var e=8;var t=8;var i=this.gridWidth;var r=this.gridHeight;var a=this.editor.layers.layers;for(var s=0;s<a.length;s++){if(a[s].type=="grid"){var o=this.editor.layers.getLayerObject(a[s].layerId);var l=o.getTileSet();i=o.getGridWidth();r=o.getGridHeight();o.setGridDimensions({width:i,height:r,cellWidth:l.getTileWidth(),cellHeight:l.getTileHeight()});e=o.getCellWidth();t=o.getCellHeight()}}this.gridWidth=i;this.gridHeight=r;this.cellWidth=e;this.cellHeight=t;this.doc.data.width=this.gridWidth*this.cellWidth;this.doc.data.height=this.gridHeight*this.cellHeight},setGridDimensions:function(e){var t=this.gridWidth;var i=this.gridHeight;var r=0;var a=0;if(typeof e!="undefined"){if(typeof e.width!="undefined"){t=e.width}if(typeof e.height!="undefined"){i=e.height}if(typeof e.offsetX!="undefined"){r=e.offsetX}if(typeof e.offsetY!="undefined"){a=e.offsetY}}this.gridWidth=t;this.gridHeight=i;var s=this.editor.layers.layers;for(var o=0;o<s.length;o++){if(s[o].type=="grid"){var l=this.editor.layers.getLayerObject(s[o].layerId);l.setGridDimensions({width:t,height:i,offsetX:r,offsetY:a});this.cellWidth=l.getCellWidth();this.cellHeight=l.getCellHeight()}}this.doc.data.width=t*this.cellWidth;this.doc.data.height=i*this.cellHeight;this.invalidateAllCells();this.redraw({allCells:true});if(this.type=="sprite"){this.editor.tools.drawTools.tilePalette.drawTilePalette()}},invalidateAllCells:function(){var e=this.editor.layers.layers;for(var t=0;t<e.length;t++){if(e[t].type=="grid"){var i=this.editor.layers.getLayerObject(e[t].layerId);i.invalidateAllCells()}}},initFrameBlocks:function(e){var t=this.editor.layers.layers;for(var i=0;i<t.length;i++){if(t[i].type=="grid"){var r=this.editor.layers.getLayerObject(t[i].layerId);r.initFrameBlocks(e)}}},setBlockDimensions:function(e,t){var i=this.editor.layers.layers;for(var r=0;r<i.length;r++){if(i[r].type=="grid"){var a=this.editor.layers.getLayerObject(i[r].layerId);a.setBlockDimensions(e,t)}}},setOnlyViewBoundsDrawn:function(e){this.onlyViewBoundsDrawn=e},getOnlyViewBoundsDrawn:function(){return this.onlyViewBoundsDrawn},setDrawEnabled:function(e){this.drawEnabled=e},getDrawEnabled:function(){return this.drawEnabled},redraw:function(e){if(this.drawEnabled){if(!this.doc){return}this.onlyViewBoundsDrawn=false;if(g_newSystem){this.editor.gridView2d.draw(e)}else{this.editor.grid.grid2d.update(e)}this.editor.layers.updateLayerPreview()}},drawFrame:function(e){var t=this.getCurrentFrame();if(typeof e.frame!="undefined"){t=e.frame}var i=false;if(e.graphicOnly){i=e.graphicOnly}var r=e.canvas;var a=e.context;var s=0;var o=0;var l=0;var n=0;var h=this.getGraphicWidth();var d=this.getGraphicHeight();if(typeof e.srcX!="undefined"){s=e.srcX;o=e.srcY}if(typeof e.srcWidth!="undefined"){h=e.srcWidth;d=e.srcHeight}if(typeof e.dstX!="undefined"){l=e.dstX;n=e.dstY}else{e.dstX=l;e.dstY=n}var c=false;var f=false;if(typeof e.drawAtX!=="undefined"){c=e.drawAtX;f=e.drawAtY}var u=false;var p=1;if(typeof e.scale!="undefined"){p=e.scale}if(typeof e.dstWidth=="undefined"){e.dstWidth=h*p;e.dstHeight=d*p}if(typeof e.shapes!="undefined"){u=e.shapes}var v="visible";var g=false;if(typeof e.allCells!="undefined"){g=e.allCells}var m=this.editor.layers.isBackgroundVisible();if(typeof e.drawBackground!="undefined"){m=e.drawBackground}var y=true;if(typeof e.updateLayerCanvas!="undefined"){y=e.updateLayerCanvas}if(!y){if(this.tempCanvas==null){this.tempCanvas=document.createElement("canvas")}this.tempCanvas.width=screenWidth;this.tempCanvas.height=screenHeight;this.tempContext=this.tempCanvas.getContext("2d")}var b=false;if(typeof e.animatedTilesOnly!="undefined"){b=e.animatedTilesOnly}if(typeof e.layers!="undefined"){v=e.layers}var C=false;if(typeof e.drawPreviousFrame!="undefined"){C=e.drawPreviousFrame}else{C=this.editor.frames.getShowPrevFrame()}var x=t-1;if(x<0){x+=this.getFrameCount()}if(x===t){C=false}var S={x:0,y:0,width:r.width,height:r.height};var P=this.editor.layers.layers;for(var w=0;w<P.length;w++){var I=P[w];var k=false;var M=l-s*p;var T=n-o*p;if(c!==false){M=c;T=f}if((I.visible&&v=="visible"||v=="all"||v==I.layerId)&&(I.type=="grid"||I.type=="image")){var k=null;var D=null;var E=0;var $=0;var _=0;var B=0;k=this.editor.layers.getLayerObject(I.layerId);var R=k.getWidth();var A=k.getHeight();var F=m;if(k&&k.isCurrentLayer()&&C){F=false}if(I.type=="grid"){if(y){D=k.getCanvas()}else{D=this.tempCanvas}if(k.getMode()==TextModeEditor.Mode.VECTOR){var L=s;var U=o;var H=s+h;var O=o+d;if(L<0){E=-L*p;L=0}if(U<0){$=-U*p;U=0}if(H>R){H=R}if(O>A){O=A}if(u){u=this.editor.tools.drawTools.shapes.getCurrentShape()!==false}var G={canvas:D,frame:t,drawBackground:F,allCells:g,shapes:u,cursor:false,scale:p,drawFromX:L,drawFromY:U,drawToX:H,drawToY:O};if(!i&&!g){G.shapes=false;G.eraseCursor=true;G.cursor=false;G.dragPaste=false;G.eraseDragPaste=false;G.allCells=false;k.drawVector(G)}G.allCells=g;G.eraseCursor=false;G.cursor=false;G.dragPaste=false;G.eraseDragPaste=false;G.shapes=u;G.typingCursor=false;G.eraseTypingCursor=false;var z={canvas:D,frame:t,drawBackground:F,allCells:g,shapes:u,cursor:false,scale:p,drawFromX:L,drawFromY:U,drawToX:H,drawToY:O};var N=false;if(g){z.bgOnly=true;z.fgOnly=false;N=k.drawVector(z);z.bgOnly=false;z.fgOnly=true;N=k.drawVector(z)}else{z.bgOnly=true;z.fgOnly=false;N=k.drawVector(z);z.bgOnly=false;z.fgOnly=true;N=k.drawVector(z)}if(!i&&k.isCurrentLayer()){if(this.editor.gridView2d.getCursorVisible()&&!u&&!UI.isMobile.any()){G.shapes=false;G.eraseCursor=false;G.cursor=true;G.dragPaste=false;G.eraseDragPaste=false;G.allCells=false;k.drawVector(G)}if(this.editor.tools.drawTools.tool=="type"){if(this.editor.gridView2d.typingCursorBlink){G.shapes=false;G.eraseCursor=false;G.cursor=false;G.typingCursor=true;G.dragPaste=false;G.eraseDragPaste=false;G.allCells=false;k.drawVector(G)}else{G.shapes=false;G.eraseCursor=false;G.cursor=false;G.typingCursor=false;G.eraseTypingCursor=true;G.dragPaste=false;G.eraseDragPaste=false;G.allCells=false;k.drawVector(G)}}else{G.shapes=false;G.eraseCursor=false;G.cursor=false;G.typingCursor=false;G.eraseTypingCursor=true;G.dragPaste=false;G.eraseDragPaste=false;G.allCells=false;k.drawVector(G)}G.typingCursor=false;G.eraseTypingCursor=false;if(this.editor.tools.drawTools.select.isInPasteMove()){G.shapes=false;G.eraseCursor=false;G.cursor=false;G.dragPaste=false;G.eraseDragPaste=true;G.allCells=false;k.drawVector(G);G.shapes=false;G.eraseCursor=false;G.cursor=false;G.dragPaste=true;G.eraseDragPaste=false;G.allCells=false;k.drawVector(G)}}E+=N.offsetX+l;$+=N.offsetY+n;_=(H-L)*p;B=(O-U)*p}else{k.draw({canvas:D,frame:t,allCells:g,drawBackground:F,shapes:u})}}var W=1;if(typeof I.opacity!="undefined"){W=I.opacity}if(k&&k.isCurrentLayer()&&C&&I.type=="grid"){if(m){a.globalAlpha=W;var X=k.getColorPalette();var Y=k.getBackgroundColor();if(Y!==this.editor.colorPaletteManager.noColor){a.fillStyle="#"+X.getHexString(Y);a.fillRect(M,T,R*p,A*p)}}a.globalAlpha=.3;var V=k.getPrevFrameCanvas();if(k.getMode()==TextModeEditor.Mode.VECTOR){var L=s;var U=o;var H=s+h;var O=o+d;var q=0;var j=0;if(L<0){q=-L*p;L=0}if(U<0){j=-U*p;U=0}if(H>R){H=R}if(O>A){O=A}var G={canvas:V,frame:x,allCells:g,drawBackground:false,shapes:false,cursor:false,scale:p,drawFromX:L,drawFromY:U,drawToX:H,drawToY:O,draw:"prevgrid"};var N=k.drawVector(G);q+=N.offsetX+l;j+=N.offsetY+n;drawPrevLayerWidth=(H-L)*p;drawPrevLayerHeight=(O-U)*p;a.drawImage(V,0,0,drawPrevLayerWidth,drawPrevLayerHeight,q,j,drawPrevLayerWidth,drawPrevLayerHeight)}else{if(x!==this.lastDrawnPrevFrame){k.draw({canvas:V,frame:x,allCells:true,shapes:false,draw:"prevgrid"})}a.drawImage(V,M,T,R*p,A*p)}}a.globalAlpha=W;if(typeof I.compositeOperation!="undefined"){a.globalCompositeOperation=I.compositeOperation}else{a.globalCompositeOperation="source-over"}if(I.type=="grid"||I.type=="image"){if(D){if(k.getMode()==TextModeEditor.Mode.VECTOR){var K=D.width;var Z=D.height;if(E+K>M+R*p){K=M+R*p-E}if($+Z>T+A*p){Z=T+A*p-$}a.drawImage(D,0,0,K,Z,E,$,K,Z)}else{a.drawImage(D,s,o,h,d,l,n,h*p,d*p);if(!UI.isMobile.any()){var J=k.isCurrentLayer();if(this.editor.tools.drawTools.shapes.getCurrentShape()!==false){J=false}if(J){this.editor.gridView2d.drawCursor({context:a,offsetX:M,offsetY:T,scale:p})}}}}}else{a.drawImage(I.canvas,0,0)}var Q=this.editor.grid.border.visible&&this.getType()!="sprite";if(M>0||T>0||M+R*p<r.width||T+A*p<r.height){if(Q&&I.visible&&I.type=="grid"){var k=this.editor.layers.getLayerObject(I.layerId);if(k&&typeof k.getBorderColor!="undefined"){var X=k.getColorPalette();var ee=8*4;var te=k.getBorderColor();if(te!=this.editor.colorPaletteManager.noColor){a.fillStyle="#"+X.getHexString(te);if(M+ee*p>0){a.fillRect(M-ee*p,T-2,ee*p,A*p+4)}if(M+R*p<r.width){a.fillRect(M+R*p,T-2,ee*p,A*p+4)}if(T+ee*p>0){a.fillRect(M-ee*p,T-ee*p,(R+2*ee)*p,ee*p)}a.fillRect(M-ee*p,T+A*p,(R+2*ee)*p,ee*p)}}}}}if(k!==false&&k.isCurrentLayer()){var ie=this.editor.tools.drawTools;var re=ie.tool;if(re==="rect"||re==="line"||re==="oval"){if(ie.shapes.width==k.getGridWidth()&&ie.shapes.height==k.getGridHeight()){if(this.shapesCanvas===null){this.shapesCanvas=document.createElement("canvas")}var D=k.getCanvas();if(this.shapesCanvas.width!=D.width||this.shapesCanvas.height!=D.height){this.shapesCanvas.width=D.width;this.shapesCanvas.height=D.height}k.draw({canvas:this.shapesCanvas,allCells:true,draw:"shapes"});a.drawImage(this.shapesCanvas,0,0,this.shapesCanvas.width,this.shapesCanvas.height,M,T,this.shapesCanvas.width*p,this.shapesCanvas.height*p)}}if(I.type=="grid"){if(ie.select.isActive()){if(!ie.select.isInPasteMove()){if(this.shapesCanvas===null){this.shapesCanvas=document.createElement("canvas")}var D=k.getCanvas();if(this.shapesCanvas.width!=D.width||this.shapesCanvas.height!=D.height){this.shapesCanvas.width=D.width;this.shapesCanvas.height=D.height}k.draw({canvas:this.shapesCanvas,allCells:true,draw:"selection",frame:t});a.drawImage(this.shapesCanvas,0,0,this.shapesCanvas.width,this.shapesCanvas.height,M,T,this.shapesCanvas.width*p,this.shapesCanvas.height*p)}}if(ie.select.isInPasteMove()){a.translate(M,T);ie.select.drawClipboardImage(a,p);a.translate(-M,-T)}var ae=ie.pixelSelect;if(ae.isActive()){var se=ae.getSelection();if(se.maxX>se.minX&&se.maxY>se.minY){var A=k.getHeight();ae.drawSelection();var oe=se.minX;var le=se.minY;var ne=se.maxX-se.minX;var he=se.maxY-se.minY;var de=se.minX+ae.selectionOffsetX;var ce=se.minY+ae.selectionOffsetY;a.drawImage(ae.canvas,oe,le,ne,he,M+de*p,T+ce*p,ne*p,he*p)}}if(ae.isInPasteMove()){ae.drawPastedPixels();var oe=0;var le=0;var ne=ae.getPasteWidth();var he=ae.getPasteHeight();var de=ae.pasteOffsetX;var ce=ae.pasteOffsetY;a.drawImage(ae.canvas,oe,le,ne,he,M+de*p,T+ce*p,ne*p,he*p)}}}if(C){this.lastDrawnPrevFrame=false}else{this.lastDrawnPrevFrame=false}}}};var GridView3d=function(){this.editor=null;this.uiComponent=null;this.camera=null;this.cameraControls=null;this.viewIsPerspective=true;this.view="";this.viewType="";this.left=0;this.top=0;this.width=0;this.height=0;this.scale=30;this.lastX=0;this.lastY=0;this.raycaster=null;this.mouse=null;this.mouseInCanvas=false;this.foundCell={x:0,y:0,z:0};this.buttons=0;this.lastTouchEnded=true;this.touchMoved=false;this.touchZoom=false;this.touchCellDrawn=false;this.pinchStartScale=1};GridView3d.prototype={setViewType:function(e){this.viewType=e},getCamera:function(){return this.camera},setupCamera:function(){var e=this.editor.grid3d;var t=e.getCellSizeX();var i=e.getCellSizeY();var r=e.getCellSizeZ();var a=e.getGridWidth();var s=e.getGridHeight();var o=e.getGridDepth();switch(this.viewType){case"3d":this.viewIsPerspective=true;this.fov=30;if(this.camera==null){this.camera=new THREE.PerspectiveCamera(this.fov,window.innerWidth/window.innerHeight,.1,1e3);this.camera.position.x=t*a/2;this.camera.position.y=i*s/2;this.camera.position.z=100;this.cameraControls=new THREE.Camera3dControls(this.camera,UI.renderer.domElement);this.cameraControls.enableDamping=true;this.cameraControls.dampingFactor=.25;this.setCameraTarget(t*a/2,0,r*o/2);this.cameraControls.update()}break;case"front":this.viewIsPerspective=false;var l=1;var n=1e3;var h=40;var d=40;if(this.camera==null){this.camera=new THREE.OrthographicCamera(h/-2,h/2,d/2,d/-2,l,n);this.camera.position.x=Math.floor(a/2)*t;this.camera.position.y=Math.floor(s/2)*i;this.camera.position.z=100}break;case"top":this.viewIsPerspective=false;var l=1;var n=1e4;var h=40;var d=40;if(this.camera==null){this.camera=new THREE.OrthographicCamera(h/-2,h/2,d/2,d/-2,l,n);this.camera.position.x=Math.floor(a/2)*t;this.camera.position.y=2e3;this.camera.position.z=Math.floor(o/2)*r;this.camera.rotation.x=-Math.PI/2}break}this.background=new THREE.Color(.3,.3,.3)},toolChanged:function(){var e=this.editor.tools.drawTools.tool;var t=this.editor.grid3d;if(e!="type"){t.setTypingCursorMeshVisible(false)}if(e=="erase"||e=="eyedropper"){t.setCursorTile(this.editor.tileSetManager.noTile)}else{var i=this.editor.currentTile.getTiles();if(i.length>0){t.setCursorTile(i[0][0])}}},setCameraPosition:function(e,t,i){this.camera.position.x=e;this.camera.position.y=t;this.camera.position.z=i},setCameraTarget:function(e,t,i){this.cameraControls.target.x=e;this.cameraControls.target.y=t;this.cameraControls.target.z=i},init:function(e,t,i){var a=this;this.editor=e;this.uiComponent=t;var r="3d";if(typeof i.view!="undefined"){r=i.view}this.setViewType(r);this.raycaster=new THREE.Raycaster;this.mouse=new THREE.Vector2;t.on("resize",function(e,t,i,r){a.resize(e,t,i,r)});this.uiComponent.on("render",function(e,t,i,r){a.render(e,t,i,r)});UI.on("ready",function(){var e=a.uiComponent.id;$("#"+e).on("mouseenter",function(e){a.mouseEnter(e);a.mouseInCanvas=true});$("#"+e).on("mouseleave",function(e){a.mouseLeave(e);a.mouseInCanvas=false});$("#"+e).on("mousedown",function(e){a.mouseDown(e)});$("#"+e).on("mouseup",function(e){a.mouseUp(e)});$("#"+e).on("mousemove",function(e){a.mouseMove(e)});$("#"+e).on("contextmenu",function(e){console.log("context menu!!");e.preventDefault()});var t=document.getElementById(e);t.addEventListener("touchstart",function(e){a.touchStart(e)},false);t.addEventListener("touchmove",function(e){a.touchMove(e);return false},false);t.addEventListener("touchend",function(e){a.touchEnd(e)},false);document.getElementById(e).addEventListener("wheel",function(e){a.mouseWheel(e)},false)});return},mouseWheel:function(e){e.preventDefault();var t=normalizeWheel(e);if(this.viewType=="3d"){if(t.spinY<0){this.cameraControls.zoomSpeed=-t.spinY;this.cameraControls.dollyOut()}else{this.cameraControls.zoomSpeed=t.spinY;this.cameraControls.dollyIn()}this.cameraControls.update()}else{var i=this.scale-t.spinY;if(i<=0){return}this.scale=i}},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){if(UI.os=="Mac OS"){this.buttons=2}}},doEyedropper:function(){var e=this.editor.grid3d;var t=this.editor.tools.drawTools;var i=e.getCursorX();var r=e.getCursorY();var a=e.getCursorZ();var s=e.getCell(i,r,a);if(t.drawCharacter){this.editor.currentTile.setCharacters([[s.t]])}if(t.drawColor){this.editor.currentTile.setColor(s.fc)}if(t.drawBGColor){this.editor.currentTile.setBGColor(s.bc)}},toolStart:function(e){var t=this.editor.tools.drawTools.tool;var i=this.editor.grid3d;switch(t){case"type":this.editor.tools.drawTools.typing.setCursorPosition({x:i.getCursorX(),y:i.getCursorY(),z:i.getCursorZ()});break;case"eyedropper":this.doEyedropper();break;case"pen":case"erase":this.editor.history.startEntry("draw");i.setCellFromCursor();break;case"rect":case"oval":case"line":var r="xy";if(this.viewType=="top"){r="xz"}if(this.viewType=="3d"){if(i.getCursorZ()!==i.getXYPosition()&&i.getCursorY()==i.getXZPosition()){r="xz"}}i.shapes.startShape(t,i.getCursorX(),i.getCursorY(),i.getCursorZ(),r);break;case"select":if(this.buttons&1&&!this.leftMouseUp){i.selection.startSelection(i.getCursorX(),i.getCursorY(),i.getCursorZ())}break}},toolMove:function(e){var t=this.editor.tools.drawTools.tool;var i=this.editor.grid3d;switch(t){case"hand":break;case"eyedropper":break;case"pen":case"erase":if(this.buttons&1&&!this.leftMouseUp){i.setCellFromCursor()}break;case"rect":case"oval":case"line":if(this.buttons&1&&!this.leftMouseUp){i.shapes.setShapeTo(i.getCursorX(),i.getCursorY(),i.getCursorZ())}break;case"select":console.log("select move");if(this.buttons&1&&!this.leftMouseUp){i.selection.selectionTo(i.getCursorX(),i.getCursorY(),i.getCursorZ())}break}},toolEnd:function(e){var t=this.editor.tools.drawTools.tool;var i=this.editor.grid3d;switch(t){case"eyedropper":break;case"pen":case"erase":if(this.buttons&1&&!this.leftMouseUp){}break;case"rect":case"oval":case"line":i.shapes.endShape();break}this.editor.history.endEntry();i.lastCellSetX=false;i.lastCellSetY=false;i.lastCellSetZ=false},toolPan:function(e,t){var i=this.editor.grid3d;var r=i.getCellSizeX();var a=i.getCellSizeY();var s=i.getCellSizeZ();if(this.viewType=="3d"){this.cameraControls.pan(e,t);this.cameraControls.update()}else if(this.viewType=="top"){this.setCameraPosition(this.camera.position.x-e*r/this.scale,this.camera.position.y,this.camera.position.z-t*s/this.scale)}else if(this.viewType=="front"){this.setCameraPosition(this.camera.position.x-e*r/this.scale,this.camera.position.y+t*a/this.scale,this.camera.position.z)}},toolRotate:function(e,t){if(this.viewType=="3d"){this.cameraControls.rotateLeft(e/20);this.cameraControls.rotateUp(t/20);this.cameraControls.update()}else if(this.viewType=="top"){}else if(this.viewType=="front"){}},touchStart:function(e){if(e.cancelable){e.preventDefault()}var t=this.uiComponent.id;var i=this.editor.tools.drawTools;var r=this.editor.tools.drawTools.tool;var a=this.editor.grid3d;var s=e.touches;if(s.length==2){this.touchCount=2;if(!this.lastTouchEnded&&!this.touchMoved){if(this.touchCellDrawn){this.editor.history.endEntry();this.editor.history.undo();this.touchZoom=true}}this.touchStart0X=s[0].pageX-$("#"+t).offset().left;this.touchStart0Y=s[0].pageY-$("#"+t).offset().top;this.touchStart1X=s[1].pageX-$("#"+t).offset().left;this.touchStart1Y=s[1].pageY-$("#"+t).offset().top;this.touchStartDistance=(this.touchStart0X-this.touchStart1X)*(this.touchStart0X-this.touchStart1X)+(this.touchStart0Y-this.touchStart1Y)*(this.touchStart0Y-this.touchStart1Y);this.touchStartDistance=Math.sqrt(this.touchStartDistance);this.touchStartMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchStartMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.touchMoveMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchMoveMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.lastX=this.touchMoveMidX;this.lastY=this.touchMoveMidY;this.pinchStartScale=this.cameraControls.getScale()}if(s.length==1){this.touchCount=1;this.lastTouchEnded=false;this.touchCellDrawn=false;this.touchMoved=false;this.touchZoom=false;this.touchStartCellX=false;this.touchStartCellY=false;var o=s[0].pageX-$("#"+this.uiComponent.id).offset().left;var l=s[0].pageY-$("#"+this.uiComponent.id).offset().top;this.buttons=1;this.leftMouseUp=false;this.lastX=o;this.lastY=l;var n=true;if(r=="erase"||r=="eyedropper"){n=false}else{if(!i.drawCharacter){n=false}}if(this.findCellFromXY(o,l,n)){a.setCursorEnabled(true)}else{a.setCursorEnabled(false)}this.toolStart(e.touches[0])}},touchMove:function(e){var t=this.uiComponent.id;if(e.cancelable){e.preventDefault()}var i=this.editor.tools.drawTools;var r=this.editor.tools.drawTools.tool;var a=this.editor.grid3d;var s=e.touches;if(s.length==1){if(this.touchZoom){return}var o=s[0].pageX-$("#"+t).offset().left;var l=s[0].pageY-$("#"+t).offset().top;this.buttons=1;this.leftMouseUp=false;var n=o-this.lastX;var h=l-this.lastY;this.lastX=o;this.lastY=l;if(r=="hand"){this.toolPan(n,h)}else if(r=="rotate"){this.toolRotate(n,h)}else{var d=true;if(r=="erase"||r=="eyedropper"){d=false}else{if(!i.drawCharacter){d=false}}if(this.findCellFromXY(o,l,d)){a.setCursorEnabled(true);this.touchMoved=true}else{a.setCursorEnabled(false)}this.toolMove(s[0])}}if(s.length==2){if(this.touchStartDistance<80){this.touchStart0X=s[0].pageX-$("#"+t).offset().left;this.touchStart0Y=s[0].pageY-$("#"+t).offset().top;this.touchStart1X=s[1].pageX-$("#"+t).offset().left;this.touchStart1Y=s[1].pageY-$("#"+t).offset().top;this.touchStartDistance=(this.touchStart0X-this.touchStart1X)*(this.touchStart0X-this.touchStart1X)+(this.touchStart0Y-this.touchStart1Y)*(this.touchStart0Y-this.touchStart1Y);this.touchStartDistance=Math.sqrt(this.touchStartDistance);this.touchStartMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchStartMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.touchMoveMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchMoveMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.pinchStartScale=this.cameraControls.getScale()}else{this.touchMove0X=s[0].pageX-$("#"+t).offset().left;this.touchMove0Y=s[0].pageY-$("#"+t).offset().top;this.touchMove1X=s[1].pageX-$("#"+t).offset().left;this.touchMove1Y=s[1].pageY-$("#"+t).offset().top;this.touchMoveDistance=(this.touchMove0X-this.touchMove1X)*(this.touchMove0X-this.touchMove1X)+(this.touchMove0Y-this.touchMove1Y)*(this.touchMove0Y-this.touchMove1Y);this.touchMoveDistance=Math.sqrt(this.touchMoveDistance);var c=(this.touchMove0X+this.touchMove1X)/2;var f=(this.touchMove0Y+this.touchMove1Y)/2;var u=c-this.touchMoveMidX;var p=f-this.touchMoveMidY;this.touchMoveMidX=(this.touchMove0X+this.touchMove1X)/2;this.touchMoveMidY=(this.touchMove0Y+this.touchMove1Y)/2;var v=this.pinchStartScale+(this.touchStartDistance/this.touchMoveDistance-1)*this.pinchStartScale*.1;this.cameraControls.setScale(v);this.cameraControls.pan(u,p);this.cameraControls.update()}}},touchEnd:function(e){e.preventDefault();var t=this.editor.tools.drawTools;var i=this.editor.tools.drawTools.tool;var r=this.editor.grid3d;var a=this.uiComponent.id;this.lastTouchEnded=true;var s=e.changedTouches;this.pan=false;var o=false;if(s.length==1){var l=s[0].pageX-$("#"+a).offset().left;var n=s[0].pageY-$("#"+a).offset().top}if(this.touchCount==2&&(i=="oval"||i=="rect"||i=="line")){this.editor.tools.drawTools.shapes.cancelShape()}else{this.toolEnd()}if(UI.isMobile.any()){g_app.autosave()}},setMouseCursor:function(e){var t=this.editor.tools.drawTools.tool;var i=this.editor.grid3d;if(this.buttons&4){UI.setCursor("drag-scroll")}else if(false){if(this.mouseInCanvas){}}else{if(typeof e!="undefined"&&e.altKey&&t!="type"&&t!="select"){UI.setCursor("eyedropper");return}switch(t){case"pen":case"block":if(i.getCursorEnabled()){if(typeof e!="undefined"&&e.altKey){UI.setCursor("eyedropper")}else{UI.setCursor("draw")}}else{UI.setCursor("default")}break;case"erase":if(i.getCursorEnabled()){UI.setCursor("erase")}else{UI.setCursor("default")}break;case"fill":if(i.getCursorEnabled()){UI.setCursor("fill")}else{UI.setCursor("default")}break;case"eyedropper":UI.setCursor("eyedropper");break;case"line":case"rect":case"oval":case"pixelselect":UI.setCursor("crosshair");break;break;case"pixel":case"charpixel":UI.setCursor("pixel");break;case"type":UI.setCursor("text");break;case"hand":case"pixelhand":if(this.buttons&1||this.pan){UI.setCursor("drag-scroll")}else{UI.setCursor("can-drag-scroll")}break;case"zoom":case"pixelzoom":UI.setCursor("zoom");break;case"select":this.editor.tools.drawTools.select.setSelectCursor(e);break;case"move":case"pixelmove":if(i.getCursorEnabled()){UI.setCursor("move")}else{UI.setCursor("default")}break}}},mouseDown:function(e){var t=this.uiComponent.id;var i=e.pageX-$("#"+t).offset().left;var r=e.pageY-$("#"+t).offset().top;var a=this.editor.tools.drawTools.tool;var s=this.editor.grid3d;this.mouseDownX=i;this.mouseDownY=r;this.buttons=1;if(!UI.isMobile.any()){button=e.button;this.setButtons(e);if(this.buttons&2){return}if(this.buttons&1){this.leftMouseUp=false}UI.captureMouse(this);this.mouseIsDown=true}if(this.buttons&4){e.preventDefault()}this.setMouseCursor(e);if(this.buttons&1&&!e.metaKey){if(a=="select"){if(s.selection.mouseDown(i,r,this)){return}}this.toolStart()}},mouseUp:function(e){var t=this.uiComponent.id;var i=this.editor.tools.drawTools.tool;var r=this.editor.grid3d;var a=e.pageX-$("#"+t).offset().left;var s=e.pageY-$("#"+t).offset().top;this.mouseIsDown=false;if(i=="select"){r.selection.mouseUp(a,s,this)}if(!UI.isMobile.any()){this.setButtons(e)}else{this.buttons=0}this.toolEnd();this.setMouseCursor(e)},mouseMove:function(e){var t=this.uiComponent.id;var i=e.pageX-$("#"+t).offset().left;var r=e.pageY-$("#"+t).offset().top;var a=this.editor.tools.drawTools.tool;var s=i-this.lastX;var o=r-this.lastY;var l=this.editor.grid3d;var n=this.editor.tools.drawTools;this.lastX=i;this.lastY=r;var h=true;if(a=="erase"||a=="eyedropper"){h=false}else{if(!n.drawCharacter){h=false}}if(this.findCellFromXY(i,r,h)){l.setCursorEnabled(true)}else{l.setCursorEnabled(false)}if(this.buttons==0){this.setMouseCursor(e)}if(a=="select"){if(l.selection.mouseMove(i,r,this)){return}}if(a=="hand"&&this.buttons&1||this.buttons&1&&e.metaKey&&e.shiftKey||this.buttons&4&&(e.shiftKey||this.viewType!="3d")){this.toolPan(s,o)}else if(a=="rotate"&&this.buttons&1||this.buttons&1&&e.metaKey&&!e.shiftKey||this.buttons&4&&!e.shiftKey){this.toolRotate(s,o)}else if(this.buttons&1&&!e.metaKey){this.toolMove(e)}},mouseEnter:function(e){if(!this.mouseIsDown){this.setMouseCursor(e)}},mouseLeave:function(e){if(UI.getMouseIsCaptured()){return}UI.setCursor("default");this.editor.grid3d.setCursorEnabled(false)},setCameraPosition:function(e,t,i){if(!this.camera){return}this.camera.position.x=e;this.camera.position.y=t;this.camera.position.z=i},findCellFromXY:function(e,t,i){t=this.height-t;var r=this.editor.grid3d;var a=true;if(typeof i!="undefined"){a=i}this.mouse.x=e/this.width*2-1;this.mouse.y=t/this.height*2-1;var s=1e5;var o=false;this.raycaster.setFromCamera(this.mouse,this.camera);var l=r.getCurrentLayer();var n=r.getCellSizeX();var h=r.getCellSizeY();var d=r.getCellSizeZ();if(a){var c=this.raycaster.intersectObjects(l.planes);if(c.length>0){var f=c[0];var u=f.point;if(f.object.gridPlane=="xy"){if(this.viewType!="3d"||this.editor.grid3d.getXYGridVisible()){var e=Math.floor(u.x/n);var t=Math.floor(u.y/h);var p=r.getXYPosition();s=f.distance*f.distance;r.setCursorPosition(e,t,p);o=true}}if(f.object.gridPlane=="xz"){if(this.viewType!="3d"||this.editor.grid3d.getXZGridVisible()){var e=Math.floor(u.x/n);var t=r.getXZPosition();var p=Math.floor(u.z/d);s=f.distance*f.distance;r.setCursorPosition(e,t,p);o=true}}}}if(this.viewType=="3d"){var v=this.raycaster.ray;var g=this.editor.grid3d.getHolder();var m=null;var y=new THREE.Vector3;var b=new THREE.Vector3;for(var C=0;C<g.children.length;C++){if(v.intersectBox(g.children[C].box,b)){var x=(this.camera.position.x-b.x)*(this.camera.position.x-b.x)+(this.camera.position.y-b.y)*(this.camera.position.y-b.y)+(this.camera.position.z-b.z)*(this.camera.position.z-b.z);if(x<s){y.x=b.x;y.y=b.y;y.z=b.z;m=g.children[C].box;s=x}}}var S="pen";var P="both";if(m){if(a){if(r.lastCellSetX==m.gridPosition.x&&r.lastCellSetY==m.gridPosition.y&&r.lastCellSetZ==m.gridPosition.z){o=false}else{var w=0;var I=0;var k=1;var M="front";var T=(y.z-m.max.z)*(y.z-m.max.z);var s=T;var D=(y.z-m.min.z)*(y.z-m.min.z);if(D<s){M="back";w=0;I=0;k=-1;s=D}var E=(y.y-m.max.y)*(y.y-m.max.y);if(E<s){M="top";w=0;I=1;k=0;s=E}var $=(y.y-m.min.y)*(y.y-m.min.y);if($<s){M="bottom";w=0;I=-1;k=0;s=$}var _=(y.x-m.min.x)*(y.x-m.min.x);if(_<s){M="left";w=-1;I=0;k=0;s=_}var B=(y.x-m.max.x)*(y.x-m.max.x);if(B<s){M="right";w=1;I=0;k=0;s=B}var e=m.gridPosition.x+w;var t=m.gridPosition.y+I;var p=m.gridPosition.z+k;r.setCursorPosition(e,t,p);o=true}}else{var e=m.gridPosition.x;var t=m.gridPosition.y;var p=m.gridPosition.z;r.setCursorPosition(e,t,p);o=true}}}if(!o){}return o},getScale:function(){return this.scale},resize:function(e,t,i,r){if(this.viewType=="3d"){}this.width=i;this.height=r;this.left=e;this.top=t;if(!this.camera){return}if(this.viewIsPerspective){this.camera.aspect=i/r}else{this.camera.left=-i/this.scale;this.camera.right=i/this.scale;this.camera.top=r/this.scale;this.camera.bottom=-r/this.scale}this.camera.updateProjectionMatrix()},render:function(e,t,i,r){if(g_app.getMode()!="3d"){return}if(this.camera==null){this.setupCamera();this.uiComponent.resize()}this.scene=this.editor.grid3d.getScene();if(this.viewType!="3d"){this.camera.left=-this.width/this.scale;this.camera.right=this.width/this.scale;this.camera.top=this.height/this.scale;this.camera.bottom=-this.height/this.scale;this.camera.updateProjectionMatrix()}var a=this.editor.grid3d;if(this.viewType=="3d"){a.showAll()}else if(this.viewType=="front"){a.showOnlyXY()}else if(this.viewType=="top"){a.showOnlyXZ()}UI.renderer.setClearColor(a.getBackgroundColorRGB());UI.renderer.render(this.scene,this.camera)}};var g_newSystem=true;var GridView2d=function(){this.editor=null;this.uiComponent=null;this.camera=null;this.canvas=null;this.context=null;this.backBufferCanvas=null;this.backBufferContext=null;this.backgroundCanvas=null;this.view="2d front";this.left=0;this.top=0;this.width=0;this.height=0;this.scale=1;this.vScroll=false;this.vScrollBarWidth=styles.ui.scrollbarWidth;this.vScrollBarHeight=0;this.vScrollBarPosition=null;this.vScrollBarPositionMin=0;this.vScrollBarPositionMax=0;this.vScrollBarPositionMouseOffset=0;this.hScroll=false;this.hScrollBarHeight=styles.ui.scrollbarWidth;this.hScrollBarWidth=0;this.hScrollBarPosition=null;this.hScrollBarPositionMin=0;this.hScrollBarPositionMax=0;this.hScrollBarPositionMouseOffset=0;this.vPadding=200;this.hPadding=200;this.lastBlinkTime=0;this.typingCursorBlink=false;this.lastSelectAnimate=0;this.foundCell={x:0,y:0,z:0};this.previousScreen=null;this.previousScreenFrame=false;this.mouseInCanvas=false;this.pan=false;this.shiftLineDirection=false;this.mouseIsDown=false;this.zoomDownX=false;this.zoomDownY=false;this.zoomMouseX=false;this.zoomMouseY=false;this.buttons=0;this.leftMouseUp=true;this.cursorVisible=false;this.cursorBoxVisible=true;this.minCharX=0;this.maxCharX=0;this.minCharY=0;this.maxCharY=0;this.mousePageX=0;this.mousePageY=0;this.lastTouchEnded=true;this.touchMoved=false;this.touchZoom=false;this.touchCellDrawn=false;this.mouseOverHControl1=false;this.mouseOverHControl2=false;this.mouseDownOnHControl=false;this.mouseOverVControl1=false;this.mouseOverVControl2=false;this.mouseDownOnVControl=false;this.displayScale=1};GridView2d.prototype={init:function(e,t){this.editor=e;this.uiComponent=t;var a=this;UI.on("ready",function(){a.setupEvents()});t.on("resize",function(e,t,i,r){a.resize(e,t,i,r)});this.uiComponent.on("keydown",function(e){a.keyDown(e)});this.uiComponent.on("keyup",function(e){a.keyUp(e)});UI.on("focus",function(e){a.focus(e)});UI.on("blur",function(e){a.blur(e)});this.camera={};this.camera.position={x:0,y:0};this.previousScreen=new Grid2d;this.previousScreen.init(this.editor)},setupEvents:function(){var t=this;this.canvas=this.uiComponent.getCanvas();this.canvas.addEventListener("mousedown",function(e){t.mouseDown(e)},false);this.canvas.addEventListener("mousemove",function(e){t.mouseMove(e)},false);this.canvas.addEventListener("mouseup",function(e){t.mouseUp(e)},false);this.canvas.addEventListener("wheel",function(e){t.mouseWheel(e)},false);this.canvas.addEventListener("contextmenu",function(e){t.contextMenu(e)},false);this.canvas.addEventListener("touchstart",function(e){t.touchStart(e)},false);this.canvas.addEventListener("touchmove",function(e){t.touchMove(e);return false},false);this.canvas.addEventListener("touchend",function(e){t.touchEnd(e)},false);this.canvas.addEventListener("mouseleave",function(e){t.mouseLeave(e);t.mouseInCanvas=false},false);this.canvas.addEventListener("mouseenter",function(e){t.mouseEnter(e);t.mouseInCanvas=true},false);this.canvas.addEventListener("webglcontextlost",function(e){console.log("CONTEXT LOST!!!!!!");e.preventDefault()},false);this.canvas.addEventListener("webglcontextrestored",function(e){console.log("CONTEXT RESTORED!!!!!")},false)},xyToCellPercent:function(e,t){var i=this.displayScale;var r=this.xyToCell(e,t);var a=this.editor.layers.getSelectedLayerObject();if(!a||a.getType()!="grid"){return false}var s=a.getCellWidth();var o=a.getCellHeight();var l=a.getWidth();var n=a.getHeight();var h={};h.x=e-(this.width/2-l*i/2-this.camera.position.x*i);h.y=t-(this.height/2-n*i/2+this.camera.position.y*i);h.x=h.x/i-r.x*s;h.y=h.y/i-r.y*o;return h},xyToPixel:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){return false}var r=this.displayScale;var a=i.getWidth();var s=i.getHeight();var o={};o.x=e-(this.width/2-a*r/2-this.camera.position.x*r);o.y=t-(this.height/2-s*r/2+this.camera.position.y*r);o.x=Math.floor(o.x/r);o.y=Math.floor(o.y/r);return o},xToGridX:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return false}var i=this.displayScale;var r=t.getWidth();var a=this.editor.tileSetManager.getCurrentTileSet();var s=a.getTileWidth();e=e-(this.width/2-r*i/2-this.camera.position.x*i);var o=Math.round(e/(i*s));return o},yToGridY:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return false}var i=this.displayScale;var r=t.getHeight();var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return false}var a=t.getCellHeight();e=e-(this.height/2-r*i/2+this.camera.position.y*i);return Math.round(e/(i*a))},xyToCell:function(e,t,i){var r=this.displayScale;var a=false;if(typeof i!=="undefined"){a=i}var s=this.editor.layers.getSelectedLayerObject();if(!s||s.getType()!="grid"){return false}var o=s.getCellWidth();var l=s.getCellHeight();var n=s.getGridWidth();var h=s.getGridHeight();var d=s.getWidth();var c=s.getHeight();e=e-(this.width/2-d*r/2-this.camera.position.x*r);t=t-(this.height/2-c*r/2+this.camera.position.y*r);var f=Math.floor(e/(r*o));var u=Math.floor(t/(r*l));this.foundCell.x=f;this.foundCell.y=u;this.foundCell.z=0;if(i){this.foundCell.pixelX=Math.floor(e/r%o);this.foundCell.pixelY=Math.floor(t/r%l)}if(f<0||f>=n||f<0||u>=h){return false}return this.foundCell},xyToCellPixel:function(e,t,i,r){this.scale=this.displayScale;var a=this.editor.layers.getSelectedLayerObject();if(!a){return}var s=a.getCellWidth();var o=a.getCellHeight();var l=a.getGridWidth();var n=a.getGridHeight();var h=a.getWidth();var d=a.getHeight();e=e-(this.width/2-h*scale/2-this.camera.position.x*scale);t=t-(this.height/2-d*scale/2-this.camera.position.y*scale);var c=Math.floor(e/scale)%s;var f=Math.floor(t/scale)%o;var u=s/i;var p=o/r;c=Math.floor(c/u);if(o==20&&r==3){if(f<6){f=0}else if(f<14){f=1}else{f=2}}else{f=Math.floor(f/p)}var v=0;return{x:c,y:f,z:v}},xyToCharPixel:function(e,t,i,r){var a=this.displayScale;var s=this.editor.tileSetManager.getCurrentTileSet();var o=this.editor.grid.grid2d.canvas;var l=this.editor.layers.getSelectedLayerObject();if(!l){return}var n=l.getWidth();var h=l.getHeight();e=e-(this.width/2-n*a/2-this.camera.position.x*a);t=t-(this.height/2-h*a/2+this.camera.position.y*a);var d=Math.floor(e/a)%s.charWidth;var c=Math.floor(t/a)%s.charHeight;var f=s.charWidth/i;var u=s.charHeight/r;d=Math.floor(d/f);if(s.charHeight==20&&r==3){if(c<6){c=0}else if(c<14){c=1}else{c=2}}else{c=Math.floor(c/u)}var p=0;return{x:d,y:c,z:p}},mouseDownVScroll:function(e,t,i){i=this.height-i;this.mouseDownAtY=i;this.mouseDownAtScrollY=this.scrollY;if(i<this.vScrollBarPosition){this.setYScroll(this.scrollY-20)}else if(i>this.vScrollBarPosition+this.vScrollBarPositionHeight){this.setYScroll(this.scrollY+20)}else{this.vScroll=true}},mouseDownHScroll:function(e,t,i){this.mouseDownAtX=t;this.mouseDownAtScrollX=this.scrollX;if(t<this.hScrollBarPosition){this.setXScroll(this.scrollX-20)}else if(t>this.hScrollBarPosition+this.hScrollBarPositionWidth){this.setXScroll(this.scrollX+20)}else{this.hScroll=true}},contextMenu:function(e){e.preventDefault();var t=this.editor.layers.getSelectedLayerObject();if(t==null||t.getType()!="grid"){return}if(e.shiftKey){this.showColorPicker()}else{this.editor.gridView2d.showCharacterPicker()}return;var i=e.pageX-$("#"+this.canvas.id).offset().left;var r=e.pageY-$("#"+this.canvas.id).offset().top;var a=0;var s=0;var o=this.xyToCell(i,r);if(o){var l=t.getCell({x:o.x,y:o.y});a=l.t;s=l.fc}var n=this;this.editor.tools.drawTools.showPopup(i,r,a,s,function(){n.setMouseCursor()});return},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){if(UI.os=="Mac OS"){this.buttons=2}}},setLastCursorLocation:function(e){this.lastCursorX=e.x;this.lastCursorY=e.y;this.lastCursorZ=e.z},toolStart:function(e,t,i,r){var a=this.editor.tools.drawTools;var s=a.tool;var o=this.editor.grid.grid2d;var l=this.editor.tileSetManager.getCurrentTileSet();if(this.editor.layers.getSelectedLayerType()!="grid"){o.setCursorEnabled(false);UI.setCursor("not-allowed");return}var n=r.metaKey||r.ctrlKey;if(n){if(s!=="select"){s="hand"}}if(s=="pixel"){a.pixelDraw.mouseDown(this,r,t,i);return}if(s=="charpixel"){if(a.mirrorH){l.buildHFlipMap()}if(a.mirrorV){l.buildVFlipMap()}a.pixelCharacterDraw.mouseDown(this,t,i);return}if(s=="linesegment"){if(a.mirrorH){l.buildHFlipMap()}if(a.mirrorV){l.buildVFlipMap()}a.lineSegmentDraw.mouseDown(this,t,i);return}if(s=="invert"){a.invertTool.mouseDown(this,t,i);return}if(s=="corners"){a.cornersTool.mouseDown(this,t,i);return}if(s=="select"){a.select.mouseDown(this,r);return}if(s=="pixelselect"||s=="pixelmove"){a.pixelSelect.mouseDown(this,r)}if(s=="move"){a.select.mouseDown(this,r)}if(s=="hand"||s=="pixelhand"){this.pan=true;UI.setCursor("drag-scroll")}if(e===false){return}o.setCursor(e.x,e.y,0,this.editor.currentTile.color,this.editor.currentTile.bgColor);o.setCursorEnabled(true);if(typeof r.altKey!="undefined"&&r.altKey){o.eyedropperCursorCell();return}if(a.mirrorH){l.buildHFlipMap()}if(a.mirrorV){l.buildVFlipMap()}this.editor.history.startEntry("draw");this.editor.history.addAction("cursorLocation",{x:this.lastCursorX,y:this.lastCursorY,z:e.z});switch(s){case"pen":case"block":this.shiftLineDirection=false;if(typeof r!="undefined"&&typeof r.shiftKey!="undefined"&&r.shiftKey){var h=this.lastCursorX;var d=this.lastCursorY;var c=e.x;var f=e.y;this.drawLineWithCursor(h,d,c,f,e.z)}else{o.setCursorCells();if(a.drawCharacter){this.editor.currentTile.addToRecentCharacters()}if(a.drawColor){this.editor.currentTile.addToRecentColors()}}this.lastCursorX=e.x;this.lastCursorY=e.y;this.mouseDownCursorX=e.x;this.mouseDownCursorY=e.y;break;case"erase":o.eraseCursorCells();break;case"eyedropper":o.eyedropperCursorCell();this.editor.tools.drawTools.setDrawTool("pen");break;case"line":case"rect":case"oval":a.shapes.startShape(a.tool,this.foundCell.x,this.foundCell.y,this.foundCell.z,"xy",r.shiftKey);if(a.drawCharacter){this.editor.currentTile.addToRecentCharacters()}if(a.drawColor){this.editor.currentTile.addToRecentColors()}break;case"fill":var u=$("#contiguousFill").is(":checked");if(u){a.fill.floodFill(e.x,e.y)}else{a.fill.nonContiguousFill(e.x,e.y)}if(a.drawCharacter){this.editor.currentTile.addToRecentCharacters()}if(a.drawColor){this.editor.currentTile.addToRecentColors()}break;case"type":a.typing.setCursorPosition(o.cursor.position);break;case"hand":case"pixelhand":this.pan=true;break;case"zoom":case"pixelzoom":if(!r.metaKey){this.zoomMouseDown=true;if(e!==false){this.zoomDownX=e.x;this.zoomDownY=e.y;this.zoomMouseX=e.x;this.zoomMouseY=e.y}else{this.zoomDownX=false;this.zoomDownY=false;this.zoomMouseX=false;this.zoomMouseY=false}}break}this.lastX=e.x;this.lastY=e.y;this.lastZ=e.z},toolMove:function(e,t,i,r){var a=this.editor.tools.drawTools;var s=a.tool;var o=this.editor.grid.grid2d;switch(s){case"pixel":o.setCursorEnabled(false);UI.setCursor("pixel");a.pixelDraw.mouseMove(this,r,t,i);return;break;case"charpixel":a.pixelCharacterDraw.mouseMove(this,t,i);return;break;case"linesegment":a.lineSegmentDraw.mouseMove(this,t,i);return;break;case"invert":a.invertTool.mouseMove(this,t,i);return;break;case"corners":a.cornersTool.mouseMove(this,t,i);return;break;case"select":a.select.mouseMove(this,r);return;break;case"pixelselect":case"pixelmove":a.pixelSelect.mouseMove(this,r);break;case"move":a.select.mouseMove(this,r);return;break}var l=a.tool;var n=true;if(l==="pen"||l==="block"){if(typeof r.altKey!="undefined"&&r.altKey){n=false}}if(e!==false&&n){o.setCursor(e.x,e.y,0,this.editor.currentTile.color,this.editor.currentTile.bgColor);o.setCursorEnabled(true)}else{o.setCursorEnabled(false)}if(this.buttons&1&&!this.leftMouseUp){switch(l){case"pen":case"block":if(typeof r.altKey!="undefined"&&r.altKey){o.eyedropperCursorCell()}else{if(e!==false){if(this.lastCursorX!==false&&this.lastCursorY!==false){var h=this.lastCursorX;var d=this.lastCursorY;var c=e.x;var f=e.y;if(r.shiftKey){if(this.shiftLineDirection===false){var u=this.mouseDownCursorX-e.x;if(u<0){u=-u}var p=this.mouseDownCursorY-e.y;if(p<0){p=-p}if(u>p){this.shiftLineDirection="horizontal"}else if(p>u){this.shiftLineDirection="vertical"}}if(this.shiftLineDirection=="vertical"){h=this.mouseDownCursorX;c=this.mouseDownCursorX}else{d=this.mouseDownCursorY;f=this.mouseDownCursorY}}this.drawLineWithCursor(h,d,c,f,e.z);this.lastCursorX=c;this.lastCursorY=f}else{o.setCursorCells();this.lastCursorX=e.x;this.lastCursorY=e.y}}else{this.lastCursorX=false;this.lastCursorY=false}}break;case"erase":o.eraseCursorCells();break;case"eyedropper":o.eyedropperCursorCell();break;case"line":case"rect":case"oval":a.shapes.setShapeTo(this.foundCell.x,this.foundCell.y,this.foundCell.z);break;case"zoom":case"pixelzoom":if(e!==false){if(this.zoomDownX!==false&&this.zoomDownY!==false){this.zoomMouseX=e.x;this.zoomMouseY=e.y}}break}if(e){this.lastX=e.x;this.lastY=e.y;this.lastZ=e.z}}},toolEnd:function(e,t){var i=this.editor.tools.drawTools;var r=false;var a=this.editor.layers.getSelectedLayerObject();if(a&&a.getType()=="grid"){r=a.getBlockModeEnabled()}switch(i.tool){case"pen":if(r){this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})}break;case"line":case"rect":case"oval":i.shapes.endShape();if(r){this.editor.graphic.invalidateAllCells()}break;case"select":i.select.mouseUp(this,t);break;case"pixelselect":case"pixelmove":i.pixelSelect.mouseUp(this,t);break;case"move":i.select.mouseUp(this,t);if(r){this.editor.graphic.invalidateAllCells()}break;case"pixel":this.editor.graphic.invalidateAllCells();i.pixelDraw.mouseUp(this,t);break;case"zoom":case"pixelzoom":if(this.zoomMouseDown){if(this.zoomDownX!==false&&this.zoomDownY!==false&&this.zoomDownX!==this.zoomMouseX&&this.zoomDownY!=this.zoomMouseY){this.fitOnScreen({minX:this.zoomDownX,minY:this.zoomDownY,maxX:this.zoomMouseX,maxY:this.zoomMouseY})}else{var s=1;if(this.editor.getEditorMode()=="pixel"){s=3}if(typeof t.altKey!="undefined"&&t.altKey){this.zoom(-s)}else{this.zoomToXY(this.mouseDownAtX,this.mouseDownAtY,s)}}this.zoomDownX=false;this.zoomDownY=false;this.zoomMouseX=false;this.zoomMouseY=false}break}if(this.editor.layers.getSelectedLayerType()!="grid"){grid2d.setCursorEnabled(false);UI.setCursor("not-allowed")}else{this.setMouseCursor(t)}this.zoomMouseDown=false;this.hScroll=false;this.vScroll=false;this.shiftLineDirection=false;this.editor.history.endEntry();this.lastX=false;this.lastY=false;this.lastZ=false;this.pan=false;this.editor.layers.updateLayerPreview()},touchStart:function(e){e.preventDefault();var t=e.touches;var i=this.editor.tools.drawTools;if(t.length==2){this.touchCount=2;if(!this.lastTouchEnded&&!this.touchMoved){if(this.touchCellDrawn){this.editor.history.endEntry();this.editor.history.undo();this.touchZoom=true}}this.touchStart0X=t[0].pageX-$("#"+this.canvas.id).offset().left;this.touchStart0Y=t[0].pageY-$("#"+this.canvas.id).offset().top;this.touchStart1X=t[1].pageX-$("#"+this.canvas.id).offset().left;this.touchStart1Y=t[1].pageY-$("#"+this.canvas.id).offset().top;this.touchStartDistance=(this.touchStart0X-this.touchStart1X)*(this.touchStart0X-this.touchStart1X)+(this.touchStart0Y-this.touchStart1Y)*(this.touchStart0Y-this.touchStart1Y);this.touchStartDistance=Math.sqrt(this.touchStartDistance);this.touchStartMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchStartMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.touchMoveMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchMoveMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.pinchStartScale=this.displayScale}if(t.length==1){this.touchCount=1;this.lastTouchEnded=false;this.touchCellDrawn=false;this.touchMoved=false;this.touchZoom=false;this.touchStartCellX=false;this.touchStartCellY=false;var r=t[0].pageX-$("#"+this.canvas.id).offset().left;var a=t[0].pageY-$("#"+this.canvas.id).offset().top;this.buttons=1;this.lastMouseX=r;this.lastMouseY=a;this.mouseDownAtX=r;this.mouseDownAtY=a;this.mouseDownCameraX=this.camera.position.x;this.mouseDownCameraY=this.camera.position.y;if(i.tool=="hand"||i.tool=="pixelhand"){this.pan=true}var s=this.xyToCell(r,a);if(s!==false){this.touchCellDrawn=true;this.touchStartCellX=s.x;this.touchStartCellY=s.y}this.toolStart(s,r,a,e.touches[0])}},touchMove:function(e){e.preventDefault();var t=e.touches;var i=this.editor.grid.grid2d;var r=this.editor.graphic;var a=r.getGraphicWidth();var s=r.getGraphicHeight();if(t.length==1){if(this.touchZoom){return}var o=t[0].pageX-$("#"+this.canvas.id).offset().left;var l=t[0].pageY-$("#"+this.canvas.id).offset().top;this.mousePageX=e.pageX;this.mousePageY=e.pageY;this.buttons=1;this.leftMouseUp=false;if(this.pan){var n=this.mouseDownCameraX-(o-this.mouseDownAtX)/this.scale;var h=this.mouseDownCameraY-(-l+this.mouseDownAtY)/this.scale;this.setCameraPosition(n,h);return}var d=this.xyToCell(o,l);if(d===false){}if(d===false||d.x!==this.touchStartCellX||d.y!==this.touchStartCellY){this.touchMoved=true}if(d!==false){i.setCursor(d.x,d.y,0,this.editor.currentTile.color,this.editor.currentTile.bgColor);i.setCursorEnabled(true)}this.toolMove(d,o,l,t[0])}if(t.length==2){if(this.touchStartDistance<80){this.touchStart0X=t[0].pageX-$("#"+this.canvas.id).offset().left;this.touchStart0Y=t[0].pageY-$("#"+this.canvas.id).offset().top;this.touchStart1X=t[1].pageX-$("#"+this.canvas.id).offset().left;this.touchStart1Y=t[1].pageY-$("#"+this.canvas.id).offset().top;this.touchStartDistance=(this.touchStart0X-this.touchStart1X)*(this.touchStart0X-this.touchStart1X)+(this.touchStart0Y-this.touchStart1Y)*(this.touchStart0Y-this.touchStart1Y);this.touchStartDistance=Math.sqrt(this.touchStartDistance);this.touchStartMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchStartMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.touchMoveMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchMoveMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.pinchStartScale=this.displayScale}else{this.touchMove0X=t[0].pageX-$("#"+this.canvas.id).offset().left;this.touchMove0Y=t[0].pageY-$("#"+this.canvas.id).offset().top;this.touchMove1X=t[1].pageX-$("#"+this.canvas.id).offset().left;this.touchMove1Y=t[1].pageY-$("#"+this.canvas.id).offset().top;this.touchMoveDistance=(this.touchMove0X-this.touchMove1X)*(this.touchMove0X-this.touchMove1X)+(this.touchMove0Y-this.touchMove1Y)*(this.touchMove0Y-this.touchMove1Y);this.touchMoveDistance=Math.sqrt(this.touchMoveDistance);var c=(this.touchMove0X+this.touchMove1X)/2;var f=(this.touchMove0Y+this.touchMove1Y)/2;var u=c-this.touchMoveMidX;var p=f-this.touchMoveMidY;this.touchMoveMidX=(this.touchMove0X+this.touchMove1X)/2;this.touchMoveMidY=(this.touchMove0Y+this.touchMove1Y)/2;var v=this.displayScale;var g=this.touchMoveMidX/v-this.width/(2*v)+a/2+this.camera.position.x-u/v;var m=this.height/v-this.touchMoveMidY/v-this.height/(2*v)+s/2+this.camera.position.y+p/v;var y=this.touchMoveDistance/this.touchStartDistance*this.pinchStartScale;this.setScale(y);v=this.displayScale;var n=g-this.touchMoveMidX/v+this.width/(2*v)-a/2;var h=m-this.height/v+this.touchMoveMidY/v+this.height/(2*v)-s/2;this.setCameraPosition(n,h)}}},touchEnd:function(e){e.preventDefault();var t=this.editor.tools.drawTools;this.lastTouchEnded=true;var i=e.changedTouches;this.pan=false;var r=false;this.scale=this.displayScale;if(i.length==1){var a=i[0].pageX-$("#"+this.canvas.id).offset().left;var s=i[0].pageY-$("#"+this.canvas.id).offset().top;r=this.xyToCell(a,s);e=i[0]}var o=t.tool;if(this.touchCount==2&&(o=="oval"||o=="rect"||o=="line")){t.shapes.cancelShape()}else{this.toolEnd(r,e)}if(UI.isMobile.any()){g_app.autosave()}},mouseDown:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;var r=0;this.buttons=1;if(!UI.isMobile.any()){r=e.button;this.setButtons(e);if(this.buttons&2){return}if(this.buttons&1){this.leftMouseUp=false}UI.captureMouse(this);this.mouseIsDown=true}this.lastMouseX=t;this.lastMouseY=i;this.mouseDownAtX=t;this.mouseDownAtY=i;if(this.pan){return}if(this.mouseOverHControl1||this.mouseOverHControl2){this.mouseDownOnHControl=true;return}if(this.mouseOverVControl1||this.mouseOverVControl2){this.mouseDownOnVControl=true;return}this.mouseDownCameraX=this.camera.position.x;this.mouseDownCameraY=this.camera.position.y;if(t>this.width-this.vScrollBarWidth){return this.mouseDownVScroll(r,t,this.height-i)}else if(this.height-i<this.hScrollBarHeight){return this.mouseDownHScroll(r,t,i)}this.setMouseCursor(e);if(this.buttons&1){var a=this.xyToCell(t,i);this.toolStart(a,t,i,e)}},mouseMoveVScroll:function(e,t){t=this.height-t;var i=this.vScrollBarHeight/this.srcHeight;var r=(t-this.mouseDownAtY)/i;this.setYScroll(this.mouseDownAtScrollY+r)},mouseMoveHScroll:function(e,t){var i=this.hScrollBarWidth/this.srcWidth;var r=(e-this.mouseDownAtX)/i;this.setXScroll(this.mouseDownAtScrollX+r)},showCharacterPicker:function(){var i=this;var e={};e.mouseUp=function(e,t){i.setButtons(e);if(e.button!=2&&e.ctrlKey!==true){i.editor.setSelectedTiles(t.grid);i.editor.tools.drawTools.tilePalette.tileChosen();UI.hidePopup()}};e.mode="grid";var t=this.mousePageX-20;var r=this.mousePageY-20;this.editor.tileSetManager.showCharacterPicker(t,r,e)},showColorPicker:function(){var t=this;var e={};e.colorPickedCallback=function(e){t.editor.currentTile.setColor(e)};var i=this.mousePageX-20;var r=this.mousePageY-2;e.type="cellcolor";e.currentColor=this.editor.currentTile.getColor();t.editor.colorPaletteManager.showColorPicker(i,r,e)},focus:function(e){this.editor.graphic.redraw({allCells:true});this.uiComponent.resize({force:true})},blur:function(e){if(UI.isMobile.any()){g_app.autosave()}},keyDown:function(e){var t=e.keyCode;var i=String.fromCharCode(t).toUpperCase();this.setMouseCursor(e)},keyUp:function(e){this.setMouseCursor(e)},setMouseCursor:function(e){if(this.buttons&4){UI.setCursor("drag-scroll")}else if(false){if(this.mouseInCanvas){}}else{if(typeof e!="undefined"&&e.altKey&&this.editor.tools.drawTools.tool!="type"&&this.editor.tools.drawTools.tool!="select"){this.editor.grid.grid2d.setCursorEnabled(false);UI.setCursor("eyedropper");return}var t=this.editor.tools.drawTools.tool;if(typeof e!="undefined"&&(e.metaKey||e.ctrlKey)){if(t!=="select"){t="hand"}}switch(t){case"pen":case"block":case"invert":if(this.editor.grid.grid2d.getCursorEnabled()){if(typeof e!="undefined"&&e.altKey){this.editor.grid.grid2d.setCursorEnabled(false);UI.setCursor("eyedropper")}else{UI.setCursor("draw")}}else{UI.setCursor("default")}break;case"erase":if(this.editor.grid.grid2d.getCursorEnabled()){UI.setCursor("erase")}else{UI.setCursor("default")}break;case"fill":if(this.editor.grid.grid2d.getCursorEnabled()){UI.setCursor("fill")}else{UI.setCursor("default")}break;case"eyedropper":UI.setCursor("eyedropper");break;case"line":case"rect":case"oval":case"pixelselect":UI.setCursor("crosshair");break;break;case"pixel":case"charpixel":case"linesegment":case"corners":UI.setCursor("pixel");break;case"type":UI.setCursor("text");break;case"hand":case"pixelhand":if(this.pan){UI.setCursor("drag-scroll")}else{UI.setCursor("can-drag-scroll")}break;case"zoom":case"pixelzoom":UI.setCursor("zoom");break;case"select":this.editor.tools.drawTools.select.setSelectCursor(e);break;case"move":case"pixelmove":if(this.editor.grid.grid2d.getCursorEnabled()){UI.setCursor("move")}else{UI.setCursor("default")}break}}},drawLineWithCursor:function(e,t,i,r,a){if(e==i&&t==r){return}var s=this.editor.layers.getSelectedLayerObject();if(!s||s.getType()!="grid"){return}var o=s.getGridWidth();var l=s.getGridHeight();var n=e;var h=t;var d=i-e;if(d<0){d=-d}var c=r-t;if(c<0){c=-c}if(d>c){if(e>i){var f=i;i=e;e=f;f=r;r=t;t=f}for(var u=e;u<=i;u++){if(u>=0&&u<o){var p=Math.round(t+(r-t)*(u-e)/(i-e));if(p>=0&&p<l){if(u!=n||p!=h){this.editor.grid.grid2d.setCursor(u,p,0,this.editor.currentTile.color,this.editor.currentTile.bgColor);this.editor.grid.grid2d.setCursorEnabled(true);this.editor.grid.grid2d.setCursorCells({update:false})}}}}}else{if(t>r){var f=r;r=t;t=f;f=i;i=e;e=f}for(var p=t;p<=r;p++){if(p>=0&&p<l){var u=Math.round(e+(i-e)*(p-t)/(r-t));if(u>=0&&u<o){if(u!=n||p!=h){this.editor.grid.grid2d.setCursor(u,p,0,this.editor.currentTile.color,this.editor.currentTile.bgColor);this.editor.grid.grid2d.setCursorEnabled(true);this.editor.grid.grid2d.setCursorCells({update:false})}}}}}if(g_newSystem){this.draw()}else{this.editor.grid.update()}},mouseMove:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;this.mousePageX=e.pageX;this.mousePageY=e.pageY;if(!UI.isMobile.any()){this.setButtons(e)}if(this.hScroll){this.mouseMoveHScroll(t,i);return}if(this.vScroll){this.mouseMoveVScroll(t,this.height-i);return}if(t>this.width-this.vScrollBarWidth&&t<this.width){if(this.buttons==0){this.editor.grid.grid2d.setCursorEnabled(false);UI.setCursor("default");return}}if(this.height-i<this.hScrollBarHeight){if(this.buttons==0){this.editor.grid.grid2d.setCursorEnabled(false);UI.setCursor("default");return}}if(this.buttons==4||this.pan){var r=this.mouseDownCameraX-(t-this.mouseDownAtX)/this.scale;var a=this.mouseDownCameraY-(-i+this.mouseDownAtY)/this.scale;this.setCameraPosition(r,a);return}if(this.editor.layers.getSelectedLayerType()!="grid"){this.editor.grid.grid2d.setCursorEnabled(false);UI.setCursor("not-allowed");return}var s=0;var o=0;var l=this.editor.layers.getSelectedLayerObject();if(l&&l.getType()==="grid"){s=l.getGridWidth();o=l.getGridHeight()}if(this.mouseDownOnHControl){var n=this.xToGridX(t);if(n<1){n=1}if(n>=s){n=s-1}this.editor.tools.drawTools.mirrorHX=n;return}else{this.mouseOverHControl1=false;this.mouseOverHControl2=false;if(t>=this.mirrorHControlX&&t<this.mirrorHControlX+this.mirrorHControlSize){if(i>=this.mirrorHControl1Y&&i<this.mirrorHControl1Y+this.mirrorHControlSize){UI.setCursor("ew-resize");this.mouseOverHControl1=true;return}else if(i>=this.mirrorHControl2Y&&i<this.mirrorHControl2Y+this.mirrorHControlSize){UI.setCursor("ew-resize");this.mouseOverHControl2=true;return}}}if(this.mouseDownOnVControl){var h=this.yToGridY(i);if(h<1){h=1}if(h>=o){h=o-1}this.editor.tools.drawTools.mirrorVY=h;return}else{this.mouseOverVControl1=false;this.mouseOverVControl2=false;if(i>=this.mirrorVControlY&&i<this.mirrorVControlY+this.mirrorVControlSize){if(t>=this.mirrorVControl1X&&t<this.mirrorVControl1X+this.mirrorVControlSize){UI.setCursor("ns-resize");this.mouseOverVControl1=true;return}else if(t>=this.mirrorVControl2X&&t<this.mirrorVControl2X+this.mirrorVControlSize){UI.setCursor("ns-resize");this.mouseOverVControl2=true;return}}}var l=this.editor.layers.getSelectedLayerObject();var d=this.xyToCell(t,i);if(d.y<0){d=false}if(d!==false){if(l){var c=l.getCell(d);if(c!==false){if(l.getType()=="grid"&&l.getBlockModeEnabled()){this.editor.info.setBlock(c.b)}this.editor.info.setCharacter(c.t);this.editor.info.setFGColor(c.fc);this.editor.info.setBGColor(c.bc);this.editor.info.setCoordinates(d.x,d.y,d.z);if(this.editor.graphic.getType()!="sprite"){this.editor.gridInfo.setInfo(d.x,d.y,d.z,c.t,c.fc,c.bc)}if(this.editor.tools.drawTools.tool=="eyedropper"||e.altKey){this.editor.tools.drawTools.tilePalette.setHighlightCharacter(c.t);this.editor.tools.drawTools.tilePalette.drawTilePalette();this.editor.sideTilePalette.setHighlightCharacter(c.t);this.editor.sideTilePalette.drawTilePalette()}}}}else{this.editor.info.leaveGrid()}if(this.buttons==0){this.setMouseCursor(e)}this.toolMove(d,t,i,e)},mouseUp:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;this.mouseIsDown=false;this.mouseDownOnHControl=false;this.mouseDownOnVControl=false;if(!UI.isMobile.any()){this.setButtons(e)}else{this.buttons=0}if(this.buttons&1){this.leftMouseUp=false}else{this.leftMouseUp=true}var r=this.xyToCell(t,i);this.toolEnd(r,e)},mouseWheel:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;e.preventDefault();var r=normalizeWheel(e);this.zoomToXY(t,i,-r.spinY/4);this.editor.info.setZoom(this.displayScale);this.editor.gridInfo.setZoom(this.displayScale)},zoomToXY:function(e,t,i){var r=this.displayScale;var a=this.editor.graphic;var s=a.getGraphicWidth();var o=a.getGraphicHeight();var l=e/r-this.width/(2*r)+s/2+this.camera.position.x;var n=this.height/r-t/r-this.height/(2*r)+o/2+this.camera.position.y;if(this.scale<=.25&&i>0&&i<.5){i=.5;console.log(i)}this.zoom(i,false);r=this.displayScale;var h=l-e/r+this.width/(2*r)-s/2;var d=n-this.height/r+t/r+this.height/(2*r)-o/2;this.setCameraPosition(h,d)},zoom:function(e,t){var i=this.scale+e/2;if(i<=.01){i=.01}this.setScale(i,t)},fitOnScreen:function(e){var t=0;var i=0;var r=this.editor.graphic;var a=r.getGraphicWidth();var s=r.getGraphicHeight();if(typeof e!="undefined"&&typeof e.minX!="undefined"&&typeof e.minY!="undefined"){var o=this.editor.tileSetManager.getCurrentTileSet();var l=o.getTileWidth();var n=o.getTileHeight();var h=e.minX;var d=e.minY;var c=e.maxX;var f=e.maxY;var u=0;var p=this.editor.layers.getSelectedLayerObject();if(p&&p.getType()=="grid"){u=p.getGridHeight()}d=u-d;f=u-f;if(h>c){var v=h;h=c;c=v}if(d>f){var v=d;d=f;f=v}var g=l*(c-h);var m=n*(f-d);var y=this.width;var b=this.height;if(y==0){y=UI.getScreenWidth()-300}if(b==0){b=UI.getScreenHeight()-400}var C=y/g;var x=b/m;if(C>x){if(x<=0){x=1}this.setScale(x)}else{if(C<=0){C=1}this.setScale(C)}t=l*(h+c)/2;t=t-a/2;i=n*(d+f)/2;i=i-s/2}else{var y=this.width;var b=this.height;if(y==0){y=UI.getScreenWidth()-300}if(b==0){b=UI.getScreenHeight()-300}var S=40;var P=100;if(this.editor.graphic.getType()=="sprite"){S=20;P=40}var C=(y-S)/a;var x=(b-P)/s;var w=C;if(C>x){w=x}if(w<1){w=1}this.setScale(w)}if(typeof e!="undefined"){if(typeof e.minScale!="undefined"){if(this.scale<e.minScale){this.setScale(e.minScale)}}}this.setCameraPosition(t,i);if(this.editor.graphic.getOnlyViewBoundsDrawn()){this.findViewBounds();this.editor.graphic.redraw()}},fitWidth:function(){},setScale:function(e,t){if(e<.1){e=.1;this.displayScale=e}else{this.displayScale=Math.floor(e/.25)*.25;if(this.displayScale<.1){this.displayScale=.1;e=.1}}this.scale=e;var i=g_app.doc.getDocRecord("/settings");i.data.scale=e;if(typeof t=="undefined"||t===true){if(this.editor.graphic.getOnlyViewBoundsDrawn()){this.findViewBounds();this.editor.graphic.redraw()}}this.editor.info.setZoom(this.displayScale);this.editor.gridInfo.setZoom(this.displayScale)},getScale:function(){return this.displayScale},setCameraPosition:function(e,t){if(isNaN(e)||isNaN(t)){return}this.camera.position.x=e;this.camera.position.y=t;if(this.editor.graphic.getOnlyViewBoundsDrawn()){this.findViewBounds();this.editor.graphic.redraw()}},getCameraPosition:function(){return this.camera.position},actualPixels:function(){this.setScale(1)},mouseEnter:function(e){if(!this.mouseIsDown){this.editor.grid.grid2d.setCursorEnabled(true);this.setMouseCursor(e)}},mouseLeave:function(e){if(UI.getMouseIsCaptured()){return}UI.setCursor("default");this.editor.info.leaveGrid();this.editor.grid.grid2d.setCursorEnabled(false)},drawMirrorH:function(e,t,i,r){var a=0;var s=0;var o=this.editor.layers.getSelectedLayerObject();if(o&&o.getType()=="grid"){a=o.getGridWidth();s=o.getGridHeight()}var l=this.displayScale;var n=this.editor.tileSetManager.getCurrentTileSet();var h=this.editor.tools.drawTools.mirrorHX;if(h<0||h>=a){h=Math.floor(a/2);this.editor.tools.drawTools.mirrorHX=h}var d=e;var c=e+i*l;var f=t;gridYEnd=t+r*l;var u=n.charWidth*l;var p=n.charHeight*l;if(d<0){var v=-Math.ceil(-d/u);d+=v*u}if(f<0){var v=-Math.ceil(-f/p);f+=v*p}this.context.beginPath();var g=e+n.charWidth*l*h;this.context.moveTo(g,f);this.context.lineTo(g,gridYEnd);this.context.lineWidth=1;this.context.strokeStyle=styles.textMode.gridView2dGridLine;this.context.stroke();this.mirrorHControlX=g-this.mirrorHControlSize/2;this.mirrorHControlSize=9;this.mirrorHControl1Y=f-this.mirrorHControlSize;if(this.mirrorHControl1Y<0){this.mirrorHControl1Y=0}this.context.fillStyle="#dddddd";this.context.fillRect(this.mirrorHControlX,this.mirrorHControl1Y,this.mirrorHControlSize,this.mirrorHControlSize);this.mirrorHControl2Y=gridYEnd;if(this.mirrorHControl2Y<0){this.mirrorHControl2Y=0}if(this.mirrorHControl2Y>this.canvas.height-10-this.mirrorHControlSize){this.mirrorHControl2Y=this.canvas.height-10-this.mirrorHControlSize}this.context.fillStyle="#dddddd";this.context.fillRect(this.mirrorHControlX,this.mirrorHControl2Y,this.mirrorHControlSize,this.mirrorHControlSize)},drawMirrorV:function(e,t,i,r){var a=this.displayScale;var s=0;var o=0;var l=this.editor.layers.getSelectedLayerObject();if(l&&l.getType()=="grid"){s=l.getGridWidth();o=l.getGridHeight()}var n=this.editor.tileSetManager.getCurrentTileSet();var h=this.editor.tools.drawTools.mirrorVY;if(h<0||h>=o){h=Math.floor(o/2);this.editor.tools.drawTools.mirrorVY=h}var d=e;var c=e+i*a;var f=t;gridYEnd=t+r*a;var u=n.charWidth*a;var p=n.charHeight*a;if(d<0){var v=-Math.ceil(-d/u);d+=v*u}if(f<0){var v=-Math.ceil(-f/p);f+=v*p}this.context.beginPath();var g=t+n.charHeight*a*h;this.context.moveTo(e,g);this.context.lineTo(c,g);this.context.lineWidth=1;this.context.strokeStyle=styles.textMode.gridView2dGridLine;this.context.stroke();this.mirrorVControlSize=9;this.mirrorVControl1X=e-this.mirrorVControlSize;if(this.mirrorVControl1X<0){this.mirrorVControl1X=0}this.mirrorVControlY=g-this.mirrorVControlSize/2;this.context.fillStyle="#dddddd";this.context.fillRect(this.mirrorVControl1X,this.mirrorVControlY,this.mirrorVControlSize,this.mirrorVControlSize);this.mirrorVControl2X=c;if(this.mirrorVControl2X<0){this.mirrorVControl2X=0}if(this.mirrorVControl2X>this.canvas.width-10-this.mirrorVControlSize){this.mirrorVControl2X=this.canvas.width-10-this.mirrorVControlSize}this.context.fillStyle="#dddddd";this.context.fillRect(this.mirrorVControl2X,this.mirrorVControlY,this.mirrorVControlSize,this.mirrorVControlSize)},drawGrid:function(e,t,i,r){var a=this.displayScale;if(this.editor.getGridVisible()){var s=this.editor.layers.getSelectedLayerObject();if(!s||s.getType()!="grid"){return false}var o=8;var l=8;var n=false;var h=this.editor.layers.getSelectedLayerObject();if(h&&h.getType()=="grid"){o=h.getCellWidth();l=h.getCellHeight();n=h.getBlockModeEnabled()}var d=e;var c=e+i*a;var f=t;gridYEnd=t+r*a;var u=o*a;var p=l*a;if(d<0){var v=-Math.ceil(-d/u);d+=v*u}if(f<0){var v=-Math.ceil(-f/p);f+=v*p}if(a>6){if(this.editor.graphic.getType()=="sprite"&&this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){for(var g=d;g<c;g+=a*2){var m=g;this.context.moveTo(m,f);this.context.lineTo(m,gridYEnd)}}else{for(var g=d;g<c;g+=a){var m=g;this.context.moveTo(m,f);this.context.lineTo(m,gridYEnd)}}for(var y=f;y<gridYEnd;y+=a){var b=y;this.context.moveTo(e,b);this.context.lineTo(c,b)}this.context.strokeStyle=styles.textMode.gridView2dPixelGridLine;this.context.lineWidth=styles.textMode.gridView2dPixelGridLineWidth;if(this.editor.getEditorMode()=="pixel"){this.context.strokeStyle="#999999";this.context.lineWidth=.4}this.context.stroke()}this.context.beginPath();for(var g=d;g<c;g+=o*a){var m=g;this.context.moveTo(m,f);this.context.lineTo(m,gridYEnd)}for(var y=f;y<gridYEnd;y+=l*a){var b=y;this.context.moveTo(e,b);this.context.lineTo(c,b)}this.context.strokeStyle=styles.textMode.gridView2dGridLine;this.context.lineWidth=styles.textMode.gridView2dGridLineWidth;if(this.editor.getEditorMode()=="pixel"){this.context.strokeStyle="#888888";this.context.lineWidth=.6}this.context.stroke();if(n){this.context.setLineDash([]);this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var C=h.getBlockWidth();var x=h.getBlockHeight();var d=e;var c=e+i*a;var f=t;gridYEnd=t+r*a;var u=o*a;var p=l*a;if(d<0){var v=-Math.ceil(-d/(u*C));d+=v*(u*C)}if(f<0){var v=-Math.ceil(-f/(p*x));f+=v*(p*x)}this.context.beginPath();for(var g=d;g<c;g+=o*a*C){var m=g;this.context.moveTo(m,f);this.context.lineTo(m,gridYEnd)}for(var y=f;y<gridYEnd;y+=l*a*x){var b=y;this.context.moveTo(e,b);this.context.lineTo(c,b)}this.context.strokeStyle=styles.textMode.gridView2dGridBlockLine;this.context.lineWidth=styles.textMode.gridView2dGridBlockLineWidth*1;this.context.stroke()}}},drawPixelSelect:function(){var e=this.displayScale;var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}var i=this.editor.tools.drawTools.pixelSelect;var r=t.getWidth();var a=t.getHeight();var s=getTimestamp();var o=this.width/2-r*e/2-this.camera.position.x*e;var l=this.height/2-a*e/2+this.camera.position.y*e;var n=i.selectionOffsetX;var h=i.selectionOffsetY;var d=i.getSelection();this.context.beginPath();var c=d.minX+n;var f=d.maxX+n;var u=d.minY+h;var p=d.maxY+h;this.context.moveTo(o+c*e,l+u*e);this.context.lineTo(o+f*e,l+u*e);this.context.lineTo(o+f*e,l+p*e);this.context.lineTo(o+c*e,l+p*e);this.context.lineTo(o+c*e,l+u*e);this.context.setLineDash([]);this.context.strokeStyle=styles.textMode.gridView2dSelectLineDark;this.context.lineWidth=1;this.context.stroke();if(s-this.lastSelectAnimate>260){this.lastSelectAnimate=s;if(this.lastDashOffset==0){this.lastDashOffset=5}else{this.lastDashOffset=0}}if(this.lastDashOffset==0){this.context.setLineDash([5,5])}else{this.context.setLineDash([0,5,5,0])}this.context.strokeStyle=styles.textMode.gridView2dSelectLineLight;this.context.lineWidth=1;this.context.stroke();this.context.setLineDash([]);var v=120;var g=16;var m=o+c*e;var y=l+u*e-g;var b=f-c;var C=p-u;this.context.globalAlpha=.8;this.context.fillStyle="#111111";this.context.fillRect(m,y,v,g);m=m+4;y=y+g-4;var x="xy: ";x+=c+","+u;x+="   wh: ";x+=b+", "+C;this.context.font="10px Verdana";this.context.fillStyle="#cccccc";this.context.fillText(x,m,y);this.context.globalAlpha=1},drawCellInfo:function(e,t,i,r){var a=this.editor.gridInfo;var s=120;var o=32;var l=e;var n=t+r;this.context.globalAlpha=.8;this.context.fillStyle="#111111";this.context.fillRect(l,n,s,o);l=l+4;n=n+12;var h="XY:";h+=a.x+","+a.y;if(typeof a.tileIndex=="undefined"){return}h+=" Tile:"+a.tileIndex+"(0x"+("00"+a.tileIndex.toString(16)).substr(-2)+")";this.context.font="10px Verdana";this.context.fillStyle="#cccccc";this.context.fillText(h,l,n);h="FG:"+a.fc+"(0x"+("00"+a.fc.toString(16)).substr(-2)+")";if(a.bc!=-1){h+=" BG:"+a.bc+"(0x"+("00"+a.bc.toString(16)).substr(-2)+")"}this.context.font="10px Verdana";this.context.fillStyle="#cccccc";this.context.fillText(h,l,n+14);this.context.globalAlpha=1},drawPixelPasteMove:function(){var e=this.displayScale;var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}var i=this.editor.tools.drawTools.pixelSelect;var r=t.getWidth();var a=t.getHeight();var s=getTimestamp();var o=this.width/2-r*e/2-this.camera.position.x*e;var l=this.height/2-a*e/2+this.camera.position.y*e;this.context.beginPath();var n=i.pasteOffsetX;var h=i.pasteOffsetX+i.getPasteWidth();var d=i.pasteOffsetY;var c=i.pasteOffsetY+i.getPasteHeight();this.context.moveTo(o+n*e,l+d*e);this.context.lineTo(o+h*e,l+d*e);this.context.lineTo(o+h*e,l+c*e);this.context.lineTo(o+n*e,l+c*e);this.context.lineTo(o+n*e,l+d*e);this.context.setLineDash([]);this.context.strokeStyle=styles.textMode.gridView2dSelectLineDark;this.context.lineWidth=1;this.context.stroke();if(s-this.lastSelectAnimate>260){this.lastSelectAnimate=s;if(this.lastDashOffset==0){this.lastDashOffset=5}else{this.lastDashOffset=0}}if(this.lastDashOffset==0){this.context.setLineDash([5,5])}else{this.context.setLineDash([0,5,5,0])}this.context.strokeStyle=styles.textMode.gridView2dSelectLineLight;this.context.lineWidth=1;this.context.stroke();this.context.setLineDash([])},drawSelect:function(){var e=this.displayScale;var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}var i=t.getCellWidth();var r=t.getCellHeight();var a=t.getWidth();var s=t.getHeight();var o=getTimestamp();var l=this.width/2-a*e/2-this.camera.position.x*e;var n=this.height/2-s*e/2+this.camera.position.y*e;var h=this.editor.tools.drawTools.select.selectionOffsetX;var d=this.editor.tools.drawTools.select.selectionOffsetY;var c=this.editor.tools.drawTools.select.getSelection();this.context.beginPath();var f=(c.minX+h)*i;var u=(c.maxX+h)*i;var p=(c.minY+d)*r;var v=(c.maxY+d)*r;this.context.moveTo(l+f*e,n+p*e);this.context.lineTo(l+u*e,n+p*e);this.context.lineTo(l+u*e,n+v*e);this.context.lineTo(l+f*e,n+v*e);this.context.lineTo(l+f*e,n+p*e);this.context.setLineDash([]);this.context.strokeStyle=styles.textMode.gridView2dSelectLineDark;this.context.lineWidth=1;this.context.stroke();if(o-this.lastSelectAnimate>260){this.lastSelectAnimate=o;if(this.lastDashOffset==0){this.lastDashOffset=5}else{this.lastDashOffset=0}}if(this.lastDashOffset==0){this.context.setLineDash([5,5])}else{this.context.setLineDash([0,5,5,0])}this.context.strokeStyle=styles.textMode.gridView2dSelectLineLight;this.context.lineWidth=1;this.context.stroke();this.context.setLineDash([]);var g=120;var m=16-1;var y=l+f*e;var b=n+p*e-m;var C=c.minX+h;var u=c.maxX+h;var p=c.minY+d;var x=c.maxY+d;var S=u-C;var P=x-p;this.context.globalAlpha=.8;this.context.fillStyle="#111111";this.context.fillRect(y,b,g,m);y=y+4;b=b+m-4;var w="";w+="xy: "+f+","+u;this.context.font="10px Verdana";this.context.fillStyle="#cccccc";this.context.fillText(w,y,b);w="wh: "+S+", "+P;this.context.fillText(w,y+60,b);if(this.editor.tools.drawTools.select.isInPasteMove()){g=30;var I="Drag to place";g=76;y=l+f*e;b=n+v*e;this.context.globalAlpha=.8;this.context.fillStyle="#111111";this.context.fillRect(y,b,g,m);y=y+4;b=b+m-4;this.context.font="10px Verdana";this.context.fillStyle="#cccccc";this.context.fillText(I,y,b)}this.context.globalAlpha=1},drawZoom:function(){var e=this.displayScale;if(this.zoomDownX===false||this.zoomDownY===false||this.zoomMouseX===false||this.zoomMouseY===false||this.zoomDownX==this.zoomMouseX||this.zoomDownY==this.zoomMouseY){return}var t=this.editor.tileSetManager.getCurrentTileSet();var i=getTimestamp();var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!=="grid"){return}var a=r.getWidth();var s=r.getHeight();var o=this.width/2-a*e/2-this.camera.position.x*e;var l=this.height/2-s*e/2+this.camera.position.y*e;var n=this.zoomDownX;var h=this.zoomDownY;var d=this.zoomMouseX;var c=this.zoomMouseY;if(d>=n){d++}if(c>=h){c++}else{h++}this.context.beginPath();var f=n*t.charWidth;var u=d*t.charWidth;var p=h*t.charHeight;var v=c*t.charHeight;this.context.moveTo(o+f*e,l+p*e);this.context.lineTo(o+u*e,l+p*e);this.context.lineTo(o+u*e,l+v*e);this.context.lineTo(o+f*e,l+v*e);this.context.lineTo(o+f*e,l+p*e);this.context.setLineDash([]);this.context.strokeStyle=styles.textMode.gridView2dSelectLineDark;this.context.lineWidth=1;this.context.stroke();if(i-this.lastSelectAnimate>260){this.lastSelectAnimate=i;if(this.lastDashOffset==0){this.lastDashOffset=5}else{this.lastDashOffset=0}}if(this.lastDashOffset==0){this.context.setLineDash([5,5])}else{this.context.setLineDash([0,5,5,0])}this.context.strokeStyle=styles.textMode.gridView2dSelectLineLight;this.context.lineWidth=1;this.context.stroke();this.context.setLineDash([])},setYScroll:function(e){var t=this.displayScale;var i=this.editor.graphic;var r=i.getGraphicHeight();this.scrollY=e;var a=(-this.scrollY-this.canvas.height/(2*this.uiComponent.getScale())+r*t/2)/t;this.setCameraPosition(this.camera.position.x,a)},setXScroll:function(e){var t=this.displayScale;var i=this.editor.graphic;var r=i.getGraphicWidth();this.scrollX=e;var a=(this.scrollX+this.canvas.width/(2*this.uiComponent.getScale())-r*t/2)/t;this.setCameraPosition(a,this.camera.position.y)},calculateScroll:function(){var e=this.displayScale;this.vPadding=200*e;this.hPadding=300*e;this.srcHeight+=this.vPadding;this.srcWidth+=this.hPadding;this.vScrollBarHeight=this.viewHeight;this.vScrollBarPositionHeight=this.vScrollBarHeight*this.viewHeight/this.srcHeight;if(this.vScrollBarPositionHeight>this.vScrollBarHeight){this.vScrollBarPositionHeight=this.vScrollBarHeight;this.scrollY=-this.vPadding/2}this.vScrollBarPosition=(this.scrollY+this.vPadding/2)*this.vScrollBarHeight/this.srcHeight;this.hScrollBarWidth=this.viewWidth;this.hScrollBarPositionWidth=this.hScrollBarWidth*this.viewWidth/this.srcWidth;if(this.hScrollBarPositionWidth>this.hScrollBarWidth){this.hScrollBarPositionWidth=this.hScrollBarWidth;this.scrollX=-this.hPadding/2}this.hScrollBarPosition=(this.scrollX+this.hPadding/2)*this.hScrollBarWidth/this.srcWidth},typingCursor:function(){if(this.editor.tools.drawTools.tool=="type"){var e=getTimestamp();if(e-this.lastBlinkTime>600){this.lastBlinkTime=e;this.typingCursorBlink=!this.typingCursorBlink}var t=this.editor.currentTile.bgColor;if(this.typingCursorBlink){t=this.editor.currentTile.color}this.editor.grid.grid2d.setTypingCursor(this.editor.tools.drawTools.typing.cursor.x,this.editor.tools.drawTools.typing.cursor.y,t,true)}else{var t=this.editor.currentTile.bgColor;this.editor.grid.grid2d.setTypingCursor(this.editor.tools.drawTools.typing.cursor.x,this.editor.tools.drawTools.typing.cursor.y,t,true)}},setupPreviousFrame:function(){if(this.editor.graphic.getFrameCount()==1){this.previousScreenFrame=false;return}var e=this.editor.graphic.getCurrentFrame()-1;if(e===-1){e=this.editor.graphic.getFrameCount()-1}if(e!==this.previousScreenFrame){this.previousScreenFrame=e;this.previousScreen.update({frame:e,allCells:true,drawBackground:false,drawPreviousFrame:false})}},resize:function(e,t,i,r){this.width=i;this.height=r;this.left=e;this.top=t;this.canvas=this.uiComponent.getCanvas();this.context=this.canvas.getContext("2d");this.context.scale(this.uiComponent.getScale(),this.uiComponent.getScale());this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;if(this.editor.graphic.getOnlyViewBoundsDrawn()){this.findViewBounds();this.editor.graphic.redraw()}},setupBackgroundCanvas:function(){if(this.backgroundCanvas==null){this.backgroundCanvas=document.createElement("canvas")}if(this.backgroundCanvas.width<this.canvas.width||this.backgroundCanvas.height<this.canvas.height){this.backgroundCanvas.width=this.canvas.width;this.backgroundCanvas.height=this.canvas.height;this.backgroundContext=this.backgroundCanvas.getContext("2d");this.backgroundContext.fillStyle="#cccccc";this.backgroundContext.fillRect(0,0,this.backgroundCanvas.width,this.backgroundCanvas.height);var e=5;var t=Math.ceil(this.backgroundCanvas.width/e);var i=Math.ceil(this.backgroundCanvas.height/e);this.backgroundContext.fillStyle="#bbbbbb";for(var r=0;r<i;r++){for(var a=0;a<t;a++){if((a+r)%2){this.backgroundContext.fillRect(a*e,r*e,e,e)}}}}},getCursorVisible:function(){var e=this.editor.tools.drawTools;var t=e.tool;if(this.editor.grid.grid2d.getCursorEnabled()){switch(t){case"line":case"rect":case"oval":case"pen":case"block":case"fill":case"charpixel":case"linesegment":case"invert":case"corners":return true;default:return false}}return false},setCursorBoxVisible:function(e){this.cursorBoxVisible=e},drawCursorBox:function(e,t,i,r,a,s){if(this.cursorBoxVisible){e.beginPath();e.strokeStyle="red";e.moveTo(t,i);e.lineTo(t+1*s,i);e.moveTo(t,i);e.lineTo(t,i+1*s);e.moveTo(t+r,i);e.lineTo(t+r-1*s,i);e.moveTo(t+r,i);e.lineTo(t+r,i+1*s);e.moveTo(t,i+a);e.lineTo(t,i+a-1*s);e.moveTo(t,i+a);e.lineTo(t+1*s,i+a);e.moveTo(t+r,i+a);e.lineTo(t+r-1*s,i+a);e.moveTo(t+r,i+a);e.lineTo(t+r,i+a-1*s);e.stroke()}},drawCursor:function(e){if(this.editor.currentTile.characters==null||this.editor.currentTile.characters.length==0){return}var t=0;var i=0;var r=this.editor.layers.getSelectedLayerObject();if(r&&r.getType()=="grid"){i=r.getGridWidth();t=r.getGridHeight()}var a=r.getTileSet();var s=e.context;var o=e.scale;var l=e.offsetX;var n=e.offsetY;var h=a.getTileWidth();var d=a.getTileHeight();var c=this.editor.currentTile.getCursorWidth();var f=this.editor.currentTile.getCursorHeight();var u=this.editor.grid.grid2d.cursor.position.x+this.editor.grid.grid2d.cursor.offset.x;var p=this.editor.grid.grid2d.cursor.position.y+this.editor.grid.grid2d.cursor.offset.y;var v=0;var g=0;if(u+c>i){c=i-u}if(p+f>t){f=t-p}if(u<0){v=-u;c+=u;u=0}if(p<0){g=-p;f+=p;p=0}c*=h;f*=d;l=l+u*h*o;n=n+p*d*o;var m=this.editor.tools.drawTools;var y=m.tool;if(this.editor.grid.grid2d.getCursorEnabled()){switch(y){case"line":case"rect":case"oval":c=h;f=d;case"pen":case"block":case"fill":case"charpixel":case"linesegment":case"corners":case"invert":if(m.drawCharacter||m.tool=="charpixel"||m.tool=="linesegment"||m.tool=="corners"||m.tool=="invert"){if(c!=0&&f!=0){if(this.editor.getCursorTileTransparent()){s.globalAlpha=.7}var b=null;if(r.getMode()==TextModeEditor.Mode.VECTOR){b=this.editor.currentTile.getVectorCursorCanvas({scale:o});if(b){s.drawImage(b,v,g,c*o,f*o,l,n,c*o,f*o);this.drawCursorBox(s,l,n,c*o,f*o,o)}}else{b=this.editor.currentTile.getCursorCanvas();if(b){s.drawImage(b,v,g,c,f,l,n,c*o,f*o);this.drawCursorBox(s,l,n,c*o,f*o,o)}}s.globalAlpha=1}}else{if(this.editor.getCursorTileTransparent()){s.globalAlpha=.4}if(m.drawColor){var C=this.editor.colorPaletteManager.getCurrentColorPalette();s.fillStyle="#"+C.getHexString(this.editor.currentTile.getColor())}else{s.fillStyle="#cccccc"}s.fillRect(l,n,c*o,f*o);s.globalAlpha=1}break;case"eyedropper":case"type":case"erase":c=h;f=d;s.globalAlpha=.4;s.fillStyle="#cccccc";s.fillRect(l,n,c*o,f*o);s.globalAlpha=1;if(y=="eyedropper"){this.drawCellInfo(l,n,c*o,f*o)}break}}if(this.editor.tools.drawTools.tool=="pixel"){var x=this.editor.tools.drawTools.pixelDraw.highlightCell;if(typeof x!="undefined"&&x!==false&&typeof x.x!="undefined"){var u=x.x;var p=x.y;var S=x.pixelX;var P=x.pixelY;var w=1;var I=1;var C=this.editor.colorPaletteManager.getCurrentColorPalette();var k="#"+C.getHexString(this.editor.tools.drawTools.pixelDraw.highlightColor);if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){var M=r.getCell({x:x.x,y:x.y});if(typeof M.fc!="undefined"){var T=M.fc;if(T>=8||this.editor.graphic.getType()=="sprite"){w=2;S=Math.floor(S/2)}}}l=e.offsetX+u*h*o;n=e.offsetY+p*d*o;l+=S*w*o;n+=P*I*o;s.globalAlpha=.4;s.fillStyle=k;s.fillRect(l,n,o*w,o*I);s.globalAlpha=1}}if(this.editor.tools.drawTools.tool=="type"&&this.editor.grid.grid2d.typingCursor.isOn){var c=h*this.editor.currentTile.getCursorWidth();var f=d*this.editor.currentTile.getCursorHeight();var u=this.editor.grid.grid2d.typingCursor.position.x;var p=this.editor.grid.grid2d.typingCursor.position.y;var T=this.editor.grid.grid2d.typingCursor.color;if(T!==false&&T>=0){var C=this.editor.colorPaletteManager.getCurrentColorPalette();var k="#"+C.getHexString(T);l=e.offsetX+u*h*o;n=e.offsetY+p*d*o;s.fillStyle=k;s.fillRect(l,n,c*o,f*o)}}},findViewBounds:function(){var e=this.displayScale;var t=this.editor.graphic;var i=t.getGraphicWidth();var r=t.getGraphicHeight();var a=Math.floor(this.width/2-i*e/2-this.camera.position.x*e);var s=Math.floor(this.height/2-r*e/2+this.camera.position.y*e);var o=0;var l=0;var n=a;var h=s;var d=i*e;var c=r*e;if(a<0){o=-Math.floor(a/e)-1;if(o<0){o=0}n=a+o*e}if(s<0){l=-Math.floor(s/e)-1;if(l<0){l=0}h=s+l*e}srcWidth=Math.ceil((this.width-n)/e);if(o+srcWidth>i){srcWidth=i-o}d=srcWidth*e;srcHeight=Math.ceil((this.height-h)/e);if(l+srcHeight>r){srcHeight=r-l}c=srcHeight*e;this.editor.graphic.setViewBounds(o,l,o+srcWidth,l+srcHeight)},draw:function(e){var t=this.editor.graphic;var i=this.displayScale;var r=t.getGraphicWidth();var a=t.getGraphicHeight();var s=Math.floor(this.width/2-r*i/2-this.camera.position.x*i);var o=Math.floor(this.height/2-a*i/2+this.camera.position.y*i);var l=0;var n=0;var h=r;var d=a;var c=s;var f=o;var u=h*i;var p=d*i;if(s<0){l=-Math.floor(s/i)-1;if(l<0){l=0}c=s+l*i}if(o<0){n=-Math.floor(o/i)-1;if(n<0){n=0}f=o+n*i}h=Math.ceil((this.width-c)/i);if(l+h>r){h=r-l}u=h*i;d=Math.ceil((this.height-f)/i);if(n+d>a){d=a-n}p=d*i;this.findViewBounds();if(this.backBufferCanvas==null){this.backBufferCanvas=document.createElement("canvas")}if(this.backBufferContext==null||this.backBufferCanvas.width<this.width||this.backBufferCanvas.height<this.height){this.backBufferCanvas.width=this.width;this.backBufferCanvas.height=this.height;this.backBufferContext=UI.getContextNoSmoothing(this.backBufferCanvas)}this.backBufferContext.fillStyle="black";this.backBufferContext.fillRect(c,f,u,p);if(s>0||o>0||s+r*i<this.width||o+a*i<this.height){this.backBufferContext.fillStyle=styles.textMode.gridView2dBackground;this.backBufferContext.fillRect(0,0,this.width,this.height);if(true||!this.editor.layers.isBackgroundVisible()){var v=r*i;var g=a*i;var m=s;var y=o;if(y<0){g+=y;y=0}if(m<0){v+=m;m=0}this.setupBackgroundCanvas();this.backBufferContext.drawImage(this.backgroundCanvas,0,0,v,g,m,y,v,g)}}else{if(true||!this.editor.layers.isBackgroundVisible()){this.setupBackgroundCanvas();this.backBufferContext.drawImage(this.backgroundCanvas,0,0,this.width,this.height,0,0,this.width,this.height)}}var b=this.editor.graphic.getCurrentFrame();var C=false;var x=this.editor.layers.isBackgroundVisible();var S=this.editor.frames.getShowPrevFrame();var P=false;var w=this.editor.tools.drawTools.tool;var I=w=="line"||w=="rect"||w=="oval";if(typeof e!="undefined"){if(typeof e.allCells!="undefined"){C=e.allCells}}this.editor.graphic.drawFrame({canvas:this.backBufferCanvas,context:this.backBufferContext,frame:b,srcX:l,srcY:n,srcWidth:h,srcHeight:d,dstX:c,dstY:f,drawAtX:s,drawAtY:o,scale:i,dstWidth:u,dstHeight:p,allCells:C,drawBackground:x,drawPreviousFrame:S,animatedTilesOnly:P,shapes:I});this.context.drawImage(this.backBufferCanvas,0,0);this.viewWidth=this.width-this.vScrollBarWidth;this.viewHeight=this.height-this.hScrollBarHeight;this.srcWidth=r*i;this.srcHeight=a*i;this.scrollX=-s;this.scrollY=-o;this.drawGrid(s,o,r,a);var k=this.editor.tools.drawTools;if(k.select.isActive()){this.drawSelect()}if(k.pixelSelect.isActive()){this.drawPixelSelect()}if(k.pixelSelect.isInPasteMove()){this.drawPixelPasteMove()}this.drawZoom();if(k.mirrorH){this.drawMirrorH(s,o,r,a)}if(k.mirrorV){this.drawMirrorV(s,o,r,a)}this.calculateScroll();this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(0,this.height-this.hScrollBarHeight,this.viewWidth,this.hScrollBarHeight);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.hScrollBarPosition,this.height-this.hScrollBarHeight+1,this.hScrollBarPositionWidth,this.hScrollBarHeight-2);this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(this.width-this.vScrollBarWidth,0,this.vScrollBarWidth,this.viewHeight);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.width-this.vScrollBarWidth+1,this.vScrollBarPosition,this.vScrollBarWidth-2,this.vScrollBarPositionHeight)},render:function(){if(this.editor.type=="3d"){return}var e=this.editor.tools.drawTools;if(e.tool=="type"){this.typingCursor()}var t=this.editor.tileSetManager.getCurrentTileSet();var i=this.editor.colorPaletteManager.getCurrentColorPalette();if(this.canvas==null){this.uiComponent.resize()}else{}if(g_newSystem){this.draw();return}var r=this.editor.grid.grid2d.canvas;var a=Math.floor(this.width/2-r.width*this.scale/2-this.camera.position.x*this.scale);var s=Math.floor(this.height/2-r.height*this.scale/2+this.camera.position.y*this.scale);this.viewWidth=this.width-this.vScrollBarWidth;this.viewHeight=this.height-this.hScrollBarHeight;this.srcWidth=r.width*this.scale;this.srcHeight=r.height*this.scale;this.scrollX=-a;this.scrollY=-s;var o=this.editor.graphic;var l=this.editor.grid.border.visible&&o.getType()!="sprite";if(a>0||s>0||a+r.width*this.scale<this.width||s+r.height*this.scale<this.height){this.context.clearRect(0,0,this.width,this.height);this.context.fillStyle=styles.textMode.gridView2dBackground;this.context.fillRect(0,0,this.width,this.height);if(l){for(var n=0;n<this.editor.layers.layers.length;n++){var h=this.editor.layers.layers[n];if(h.visible&&h.type=="grid"){var d=null;d=this.editor.layers.getLayerObject(h.layerId);if(d&&typeof d.getBorderColor!="undefined"){var i=d.getColorPalette();var c=8*4;var f=d.getBorderColor();if(f!=this.editor.colorPaletteManager.noColor){this.context.fillStyle="#"+i.getHexString(f);if(a>0){this.context.fillRect(a-c*this.scale,s-2,c*this.scale,r.height*this.scale+4)}if(a+r.width*this.scale<this.width){this.context.fillRect(a+r.width*this.scale,s-2,c*this.scale,r.height*this.scale+4)}if(s>0){this.context.fillRect(a-c*this.scale,s-c*this.scale,(r.width+2*c)*this.scale,c*this.scale)}this.context.fillRect(a-c*this.scale,s+r.height*this.scale,(r.width+2*c)*this.scale,c*this.scale)}}}}}if(true||!this.editor.layers.isBackgroundVisible()){var u=r.width*this.scale;var p=r.height*this.scale;var v=a;var g=s;if(g<0){p+=g;g=0}if(v<0){u+=v;v=0}this.setupBackgroundCanvas();this.context.drawImage(this.backgroundCanvas,0,0,u,p,v,g,u,p)}}else{if(true||!this.editor.layers.isBackgroundVisible()){this.setupBackgroundCanvas();this.context.drawImage(this.backgroundCanvas,0,0,this.width,this.height,0,0,this.width,this.height)}}var m=0;var y=0;var b=r.width;var C=r.height;var x=a;var S=s;var P=b*this.scale;var w=C*this.scale;if(a<0){m=-Math.floor(a/this.scale)-1;if(m<0){m=0}x=a+m*this.scale}if(s<0){y=-Math.floor(s/this.scale)-1;if(y<0){y=0}S=s+y*this.scale}b=Math.ceil((this.width-x)/this.scale);if(m+b>r.width){b=r.width-m}P=b*this.scale;C=Math.ceil((this.height-S)/this.scale);if(y+C>r.height){C=r.height-y}w=C*this.scale;this.editor.graphic.setViewBounds(m,y,m+b,y+C);this.context.drawImage(r,m,y,b,C,x,S,P,w);if(!UI.isMobile.any()){this.drawCursor({context:this.context,offsetX:a,offsetY:s,scale:this.scale})}this.drawGrid(a,s,r.width,r.height);if(e.select.isActive()){this.drawSelect()}if(e.pixelSelect.isActive()){this.drawPixelSelect()}if(e.pixelSelect.isInPasteMove()){this.drawPixelPasteMove()}this.drawZoom();if(e.mirrorH){this.drawMirrorH(a,s,r.width,r.height)}if(e.mirrorV){this.drawMirrorV(a,s,r.width,r.height)}this.calculateScroll();this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(0,this.height-this.hScrollBarHeight,this.viewWidth,this.hScrollBarHeight);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.hScrollBarPosition,this.height-this.hScrollBarHeight+1,this.hScrollBarPositionWidth,this.hScrollBarHeight-2);this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(this.width-this.vScrollBarWidth,0,this.vScrollBarWidth,this.viewHeight);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.width-this.vScrollBarWidth+1,this.vScrollBarPosition,this.vScrollBarWidth-2,this.vScrollBarPositionHeight)}};var Layers=function(){this.editor=null;this.backgroundLayerPreview=null;this.selectedLayerId=false;this.layers=[];this.layerRefs=[];this.layerObjects={};this.nextLayerId=0;this.scrollbar=null;this.backgroundCanvas=null;this.backgroundEnabled=true;this.backgroundVisible=true;this.layerPropertiesDialog=null;this.refLayerId=false;this.compositeOperations=[{label:"Normal",operation:"source-over"},{label:"-"},{label:"Darken",operation:"darken"},{label:"Multiply",operation:"multiply"},{label:"Colour Burn",operation:"color-burn"},{label:"-"},{label:"Lighten",operation:"lighten"},{label:"Screen",operation:"screen"},{label:"Colour Dodge",operation:"color-dodge"},{label:"Lighter",operation:"lighter"},{label:"-"},{label:"Overlay",operation:"overlay"},{label:"Hard Light",operation:"hard-light"},{label:"Soft Light",operation:"soft-light"},{label:"-"},{label:"Difference",operation:"difference"},{label:"Exclusion",operation:"exclusion"}];this.mouseDownOnLayer=false;this.dragLayer=false;this.mouseDownX=0;this.mouseDownY=0;this.layerMerge=null;this.layesFrames=null;this.mobileLayersDialog=null};Layers.prototype={init:function(e){this.editor=e},initMobileLayersDialog:function(){if(this.mobileLayersDialog===null){var e=UI.getScreenWidth()-30;if(e>380){e=380}this.mobileLayersDialog=UI.create("UI.Dialog",{id:"mobileLayersDialog",title:"Layers",width:e});var t='<div class="panelFill">';t+='<div id="layersHolderMobileButtons" style="position: absolute; left: 10px; top: 10px; height: 30px; right: 10px">';t+='<div class="ui-button" id="addLayerMobileButton"><i class="halflings halflings-plus"></i> New Layer</div>';t+="&nbsp;";t+='<div class="ui-button" id="deleteLayerMobileButton"><i class="halflings halflings-trash"></i> Delete Layer</div>';t+="</div>";t+='<div id="layersHolderMobile" style="position: absolute; left: 10px; top: 60px; bottom: 60px; right: 10px"></div>';t+="</div>";t+='<div id="" style="position: absolute; left: 10px; bottom: 10px; height: 30px; right: 10px; display: flex">';t+='<div class="ui-button" id="layerPropertiesMobileButton">Properties</div>';t+="&nbsp;";t+='<div class="ui-button" id="layerMoveUpButton">Move Up</div>';t+="&nbsp;";t+='<div class="ui-button" id="layerMoveDownButton">Move Down</div>';t+="</div>";this.mobileLayersDialogHTML=UI.create("UI.HTMLPanel",{html:t});this.mobileLayersDialog.add(this.mobileLayersDialogHTML);var i=UI.create("UI.Button",{text:"Close",color:"secondary"});this.mobileLayersDialog.addButton(i);i.on("click",function(e){UI.closeDialog()});var r=this;$("#addLayerMobileButton").on("click",function(){r.showNewLayerDialog()});$("#deleteLayerMobileButton").on("click",function(){if(r.getLayerCount()<=1){alert("Sorry, you cannot delete this layer");return}if(confirm("Are you sure you want to delete this layer?")){r.deleteLayer()}});$("#layerPropertiesMobileButton").on("click",function(){var e=r.getSelectedLayerId();if(e!==false){r.editLayer(e)}});$("#layerMoveUpButton").on("click",function(){r.moveLayer(1)});$("#layerMoveDownButton").on("click",function(){r.moveLayer(-1)})}},showMobileLayerChooser:function(){console.log("show mobile layer chooser");UI.showDialog("mobileLayersDialog")},showLayerMerge:function(){if(this.layerMerge==null){this.layerMerge=new LayersMerge;this.layerMerge.init(this.editor)}this.layerMerge.show()},mergeLayers:function(e){var t=this.getSelectedLayerIndex();var i=this.layers[t];if(i.type!="grid"){alert("Can only merge into a grid layer")}var r=this.editor.tileSetManager.getCurrentTileSet();var a=r.getBlankCharacter();var s=this.editor.colorPaletteManager.noColor;var o=this.editor.frames.width;var l=this.editor.frames.height;this.editor.history.startEntry("Merge Layers");var n=[];for(var h=0;h<l;h++){n[h]=[];for(var d=0;d<o;d++){n[h][d]={};n[h][d].c=a;n[h][d].fc=0;n[h][d].bc=s;n[h][d].x=d;n[h][d].y=h;n[h][d].z=i.gridZ;n[h][d].update=false}}for(var h=0;h<l;h++){for(var d=0;d<o;d++){for(var c=0;c<this.layers.length;c++){var f=false;if(this.layers[c].visible){if(this.layers[c].type=="grid"){f=c}}if(f!==false){var u=this.layers[f].gridZ;var p=this.editor.grid.gridData[u][h][d];if(p.c!=a){n[h][d].c=p.c;n[h][d].fc=p.fc;n[h][d].bc=p.bc}if(f!=t){this.editor.grid.setCell({x:d,y:h,z:u,c:a,fc:p.fc,bc:s,update:false})}}}}}var u=i.gridZ;for(var h=0;h<l;h++){for(var d=0;d<o;d++){this.editor.grid.setCell(n[h][d])}}this.editor.history.endEntry();if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}this.updateAllLayerPreviews()},showLayersToFrames:function(){if(this.layersFrames==null){this.layersFrames=new LayersFrames;this.layersFrames.init(this.editor)}this.layersFrames.showLayersToFrames()},layersToFrames:function(){var e=12;var t=this.editor.frames.currentFrame;var i=this.editor.frames.width;var r=this.editor.frames.height;var a=this.getSelectedLayerIndex();var s=this.layers[a];if(s.type!="grid"){alert("Can only merge into a grid layer")}this.editor.history.startEntry("Layers To Frames");for(var o=0;o<this.layers.length;o++){var l=false;if(this.layers[o].visible){if(this.layers[o].type=="grid"){l=o}}if(l!==false){this.editor.frames.insertFrame(this.editor.frames.currentFrame,e);var n=this.layers[l].gridZ;for(var h=0;h<r;h++){for(var d=0;d<i;d++){var c=this.editor.frames.frames[t].data[n][h][d];this.editor.grid.setCell({x:d,y:h,z:s.gridZ,c:c.c,fc:c.fc,bc:c.bc,update:false})}}}}this.editor.history.endEntry();if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}},showFramesToLayers:function(){if(this.layersFrames==null){this.layersFrames=new LayersFrames;this.layersFrames.init(this.editor)}this.layersFrames.showFramesToLayers()},load:function(){this.initMobileLayersDialog();this.layerObjects={};this.layerRefs=[];var e=this.editor.doc;if(typeof e.data.layers=="undefined"){e.data.layers=[]}this.selectedLayerId=false;this.layers=e.data.layers;var t=this.dragLayerHTML();if(g_app.isMobile()){$("#layersHolderMobile").html(t)}else{$("#layersHolder").html(t)}if(this.layers.length==0){console.error("create layers");this.editor.history.setEnabled(false);var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=i.getDefaultBackgroundColor();var a=i.getDefaultBorderColor();this.newLayer({type:"grid",backgroundColor:r,borderColor:a});this.editor.history.setEnabled(true)}else{for(var s=0;s<this.layers.length;s++){var o=this.layers[s].type;var l=this.layers[s].layerId;switch(o){case"grid":var n=this.getLayerRef(l);var h=new LayerGrid;h.loadFromDoc(this.editor,l,n);this.layerObjects[l]=h;break;case"image":var n=this.getLayerRef(l);var d=new LayerRefImage;d.loadFromDoc(this.editor,l,n);this.layerObjects[l]=d;break}}this.refreshLayersHTML()}if(this.scrollbar){this.scrollbar.update()}},buildInterface:function(e){var t="";t+='<div id="layerTools" class="activeBackground panelFill">';t+='<div class="title" style="background-color: #111111; height: 18px; overflow: none; white-space: nowrap">';t+='  <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap">';t+="  Layers";t+="  </div>";t+='    <div style="position: absolute; top: 2px; right: 2px; width: 20px">';t+='       <div id="layerToolsCloseButton" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>';t+="    </div>";t+="</div>";t+='<div style="margin: 6px 0px 6px 2px; overflow: none; white-space: nowrap">';t+='<select id="layersCompositeOperation">';for(var i=0;i<this.compositeOperations.length;i++){if(this.compositeOperations[i].label=="-"){t+="<option disabled></option>"}else{t+='<option value="'+this.compositeOperations[i].operation+'">'+this.compositeOperations[i].label+"</option>"}}t+="</select>";t+="&nbsp;";t+='<span style="font-size: 10px">Opacity:&nbsp;</span>';t+='<input class="number" type="text" min="0" max="100" size="3" id="layerOpacity"/>';t+="</div>";t+='  <div style="background-color: #111111; margin: 2px; position: absolute; top: 52px; bottom: 28px; left:0; right: 0; overflow-y: auto; overflow-x: hidden" id="layersHolder">';t+="  </div>";t+='<div class="ui-button-holder" style="position: absolute; bottom: 0px; left: 0px; right: 0px; height: 24px; padding: 2px; background-color: #171717">';t+='<div class="ui-button" id="layersNewLayer"><i class="halflings halflings-plus"></i>&nbsp;New Layer</div>';t+='<div class="ui-button" id="layersDeleteLayer"><i class="halflings halflings-trash"></i>&nbsp;Delete</div>';t+="</div>";t+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{html:t});e.add(this.uiComponent);var r=this;UI.on("ready",function(){UI.number.initControls("#layerOpacity");if(!Modernizr.cssscrollbar){r.scrollbar=new PerfectScrollbar("#layersHolder")}r.initEvents()});this.uiComponent.on("resize",function(){r.layersPanelResize()})},layersPanelResize:function(){if(this.scrollbar){this.scrollbar.update()}},dragLayerHTML:function(){var e="";e+='<div id="layerDrag" style="display: none; opacity: 0.4; position: absolute; z-index: 500; width: 184px; height: 70px; background-color: #3344ff">';e+='<canvas width="80" height="50" id="dragLayerCanvas" style="margin: 6px"></canvas>';e+='<span style="display: inline-block; width: 80px; padding: 6px" id="dragLayerLabel" class="textModeLayerLabel">Layer 1</span>';e+="</div>";return e},initEvents:function(){var i=this;$("#layersNewLayer").on("click",function(){i.showNewLayerDialog()});$("#layersNewRefLayer").on("click",function(){i.newRefLayer()});$("#layersDeleteLayer").on("click",function(){if(confirm("Are you sure you want to delete this layer?")){i.deleteLayer()}});$("#layersCompositeOperation").on("change",function(e){var t=$(this).val();i.setSelectedLayerCompositeOperation(t)});$("#layerOpacity").on("change",function(e){var t=parseInt($(this).val(),10)/100;if(!isNaN(t)){i.setSelectedLayerOpacity(t)}});$("#layerOpacity").on("keyup",function(e){var t=parseInt($(this).val(),10)/100;if(!isNaN(t)){i.setSelectedLayerOpacity(t)}});$("#layersHolder").on("contextmenu",function(e){e.preventDefault()});$("#layersHolder").on("mousemove",function(e){i.mouseMove(e)});$("#layersHolder").on("mouseup",function(e){i.mouseUp(e)});$("#layerToolsCloseButton").on("click",function(){i.editor.setLayersPanelVisible(false)});this.setupLayersEvents()},toggleLayerVisible:function(e){var t=this.getLayerIndex(e);this.layers[t].visible=!this.layers[t].visible;var i="";if(this.layers[t].visible){i='<img src="icons/svg/glyphicons-halflings-25-eye.svg" class="layerVisibleIcon"/>'}else{i='<img src="icons/svg/glyphicons-halflings-26-eye-off.svg" class="layerHiddenIcon"/>'}$("#textModeLayerVisible"+this.layers[t].layerId).html(i);if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}},setVisibleLayers:function(){console.error("shouldnt get here??");if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}},isBackgroundVisible:function(){return this.backgroundVisible},setBackgroundVisible:function(e){if(!this.backgroundEnabled){return}this.backgroundVisible=e;UI("edit-showbackground").setChecked(e);this.editor.graphic.redraw({allCells:true})},setBackgroundEnabled:function(e){if(e){if(this.layers.length>0&&this.layers[0].type=="background"){$("#textModeLayer"+this.layers[0].layerId).show()}}else{this.setBackgroundVisible(false);if(this.layers.length>0&&this.layers[0].type=="background"){$("#textModeLayer"+this.layers[0].layerId).hide()}}this.backgroundEnabled=e},toggleBackground:function(){if(!this.backgroundEnabled){return}this.setBackgroundVisible(!this.isBackgroundVisible())},toggleVisible:function(){var e=this.getSelectedLayerIndex();if(e===false){return}var t=this.layers[e];this.toggleLayerVisible(t.layerId)},moveLayer:function(e){var t=this.getSelectedLayerIndex();if(this.layers[t].type=="background"){return}if(this.getLayerCount()==0){return}var i=this.layers[0].type=="background";t+=e;if((!i||t>0)&&t>=0&&t<this.layers.length){this.moveLayerTo(t)}},moveLayerTo:function(e){if(this.getLayerCount()==0){return}var t=this.getSelectedLayerIndex();var i=$("#textModeLayer"+this.layers[t].layerId).detach();if(e>t){var r=this.layers[e].layerId;$(i).insertBefore("#textModeLayer"+r)}else{var a=this.layers[e].layerId;$(i).insertAfter("#textModeLayer"+a)}this.layers.splice(e,0,this.layers.splice(t,1)[0]);if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}},getSelectedLayerLabel:function(){var e=this.getSelectedLayerIndex();if(e===false){return false}return this.layers[e].label},setSelectedLayerLabel:function(e){var t=this.getSelectedLayerId();var i=this.getSelectedLayerIndex();if(i===false){return}this.layers[i].label=e;this.updateLayerLabel(t)},updateLayerLabel:function(e){var t=this.getLayerObject(e);if(t){var i='<div class="layerLabelName">'+t.getLabel()+"</div>";if(t.getType()=="grid"){var r=t.getScreenMode();switch(r){case TextModeEditor.Mode.TEXTMODE:if(this.editor.graphic.getType()=="sprite"){r="Monochrome"}else{r="Text Mode"}break;case TextModeEditor.Mode.C64STANDARD:r="C64 Standard Colour Mode";break;case TextModeEditor.Mode.C64ECM:r="C64 Extended Colour Mode";break;case TextModeEditor.Mode.C64MULTICOLOR:r="C64 Multicolour";break;case TextModeEditor.Mode.NES:r="NES";break;case TextModeEditor.Mode.INDEXED:r="Indexed Colour";break;case TextModeEditor.Mode.RGB:r="RGB Colour";break;case TextModeEditor.Mode.VECTOR:r="Vector Mode";break}i+='<div class="layerLabelProperties">'+r+"</div>";if(t.getBlockModeEnabled()){i+='<div class="layerLabelProperties">Block Mode</div>'}i+='<div class="layerLabelProperties">';i+='<span style="color: #bbbbbb">Tile Flip</span> ';if(t.getHasTileFlip()){i+="Yes"}else{i+="No"}i+=",";i+=' <span style="color: #bbbbbb">Tile Rotate</span> ';if(t.getHasTileRotate()){i+="Yes"}else{i+="No"}i+="</div>"}if(t.getType()=="image"){i+='<div class="layerLabelProperties">Image</div>'}$("#"+e+"label").html(i)}},setSelectedLayerBackgroundColor:function(e){var t=this.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}t.setBackgroundColor(e)},setSelectedLayerBorderColor:function(e){var t=this.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}t.setBorderColor(e)},setSelectedLayerOpacity:function(e){var t=this.getSelectedLayerId();var i=this.getSelectedLayerIndex();if(i===false){return}this.layers[i].opacity=e;$("#layerOpacity").val(e*100);if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}},setSelectedLayerCompositeOperation:function(e){var t=this.getSelectedLayerId();var i=this.getSelectedLayerIndex();if(i===false){return}this.layers[i].compositeOperation=e;if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}$("#layersCompositeOperation").val(e)},setSelectedLayerScreenMode:function(e){var t=this.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}t.setScreenMode(e)},getSelectedLayerId:function(){return this.selectedLayerId},getSelectedLayerIndex:function(){var e=this.getSelectedLayerId;if(e===false){return false}return this.getLayerIndex(this.selectedLayerId)},getSelectedLayerType:function(){var e=this.getSelectedLayerIndex();if(e===false){return false}return this.layers[e].type},getLayers:function(){return this.layers},getLayerId:function(e){if(e<this.layers.length){return this.layers[e].layerId}return false},getLayerIndex:function(e){for(var t=0;t<this.layers.length;t++){if(this.layers[t].layerId===e){return t}}return false},getLayerZFromLabel:function(e){for(var t=0;t<this.layers.length;t++){if(this.layers[t].label===e){return this.layers[t].gridZ}}return false},newRefLayer:function(){if(this.layerPropertiesDialog==null){this.layerPropertiesDialog=new LayerPropertiesDialog;this.layerPropertiesDialog.init(this.editor)}this.refLayerId=false;this.layerPropertiesDialog.show()},showNewLayerDialog:function(){var e="Layer "+this.getLayerCount();if(this.layerPropertiesDialog==null){this.layerPropertiesDialog=new LayerPropertiesDialog;this.layerPropertiesDialog.init(this.editor)}this.refLayerId=false;this.layerPropertiesDialog.show()},setReferenceImage:function(e,t){if(this.refLayerId===false){this.newLayer({type:"image",image:e,imageData:e.toDataURL(),opacity:1,compositeOperation:"source-over",params:t})}else{var i=this.getLayerObject(this.refLayerId);i.setArgs({imageData:e.toDataURL(),image:e,params:t})}this.editor.graphic.redraw()},getLayerCount:function(){return this.layers.length},getLayerHTML:function(e,t){var i=32;var r=20;var a="";a+='<div class="textModeLayer" id="textModeLayer'+e+'" data-layer-id="'+e+'">';a+='<div style="display: inline-block; width: 18px" >';a+='<span class="textModeLayerVisible" data-layer-id="'+e+'" id="textModeLayerVisible'+e+'" style="cursor: pointer; padding: 1px">';a+='<img src="icons/svg/glyphicons-halflings-25-eye.svg" class="layerVisibleIcon" style="width: 16px; cursor: pointer"/>';a+="</span>";a+="</div>";a+='<div class="textModeLayerDetails" id="textModeLayerDetails'+e+'"  data-layer-id="'+e+'">';a+='<canvas id="layer'+e+'preview" width="'+i+'" height="'+r+'" style="background-color: #333333; margin: 6px"></canvas>';a+='<span style="display: inline-block; width: 200px; padding: 6px" data-layer-id="'+e+'" id="'+e+'label" class="textModeLayerLabel" id="textModeLayerLabel'+e+'">'+t+"</span>";a+="</div>";a+="</div>";return a},startDragLayer:function(e,t){var i=this.getLayerIndex(e);if(this.layers[i].type=="background"){return}this.dragLayer=e;var r=document.getElementById("dragLayerCanvas");if(r){var a=r.getContext("2d");var s=document.getElementById("layer"+this.dragLayer+"preview");if(s){var o=this.layers[i].label;$("#dragLayerLabel").html(o);a.drawImage(s,0,0)}}$("#layerDrag").show();UI.captureMouse(this)},mouseYToLayer:function(e){$(".textModeLayerDetails").css("border-top","0px solid black");$(".textModeLayerDetails").css("border-bottom","0px solid black");var t=false;for(var i=0;i<this.layers.length;i++){var r=this.layers[i].layerId;var a=$("#textModeLayerDetails"+r);if(typeof a!="undefined"&&a){var s=a.position().top;var o=a.height();if(e>s&&e<s+o){if(e-s<o/2){this.insertDragLayerAt=i+1;$("#textModeLayerDetails"+r).css("border-top","2px solid #ff0000")}else{if(t!==false){this.insertDragLayerAt=i;$("#textModeLayerDetails"+t).css("border-top","2px solid #ff0000")}else{this.insertDragLayerAt=i;$("#textModeLayerDetails"+r).css("border-bottom","2px solid #ff0000")}}}t=r}}},mouseMove:function(e){var t=e.pageX-$("#layersHolder").offset().left;var i=e.pageY-$("#layersHolder").offset().top;if(this.mouseDownOnLayer!==false){if(this.dragLayer===false){var r=(e.pageX-this.mouseDownX)*(e.pageX-this.mouseDownX)+(e.pageY-this.mouseDownY)*(e.pageY-this.mouseDownY);if(r>3){this.startDragLayer(this.mouseDownOnLayer)}}if(this.dragLayer!==false){var a=i-this.mouseOffsetY;$("#layerDrag").css("top",a+"px");$("#layerDrag").css("left","18px");this.mouseYToLayer(i)}}},mouseUp:function(e){if(this.dragLayer!==false){this.selectLayer(this.dragLayer);var t=this.getSelectedLayerIndex();if(t<this.insertDragLayerAt){this.insertDragLayerAt--}if(this.insertDragLayerAt!=this.getSelectedLayerIndex()){this.moveLayerTo(this.insertDragLayerAt)}$("#layerDrag").hide();$(".textModeLayerDetails").css("border-top","0px solid black");$(".textModeLayerDetails").css("border-bottom","0px solid black")}this.dragLayer=false;this.mouseDownOnLayer=false},setupLayersEvents:function(){var i=this;$("#layersHolder").on("mousedown",".textModeLayerDetails",function(e){var t=$(this).attr("data-layer-id");i.mouseDownOnLayer=t;i.mouseDownX=e.pageX;i.mouseDownY=e.pageY;i.mouseOffsetY=e.pageY-$(this).offset().top});$("#layersHolder").on("click",".textModeLayerDetails",function(){var e=$(this).attr("data-layer-id");i.selectLayer(e)});$("#layersHolder").on("dblclick",".textModeLayerDetails",function(e){var t=$(this).attr("data-layer-id");i.editLayer(t)});$("#layersHolder").on("click",".textModeLayerVisible",function(e){var t=$(this).attr("data-layer-id");i.toggleLayerVisible(t)})},refreshLayersHTML:function(){var e="layersHolder";if(g_app.isMobile()){e="layersHolderMobile"}var t=this.dragLayerHTML();$("#"+e).html(t);for(var i=this.layers.length-1;i>=0;i--){var r=this.layers[i].layerId;var a=this.layers[i].label;var s=this.getLayerHTML(r,a);$("#"+e).append(s);if(this.layers[i].type!="grid"&&this.layers[i].type!="image"){if(typeof this.layers[i].canvas=="undefined"||this.layers[i].canvas==null){this.layers[i].canvas=document.createElement("canvas")}var o=this.getLayerObject(this.layers[i].layerId);if(o){o.setPreviewCanvasElementId("layer"+r+"preview")}}else{var o=this.getLayerObject(this.layers[i].layerId);if(o){o.setPreviewCanvasElementId("layer"+r+"preview")}}this.updateLayerLabel(r)}if(this.scrollbar){this.scrollbar.update()}},getLayerObject:function(e){return this.layerObjects[e]},getLayerObjectFromIndex:function(e){if(e<0||e>=this.layers.length){return null}return this.getLayerObject(this.layers[e].layerId)},getLayerObjectFromRef:function(e){if(e<this.layerRefs.length){var t=this.layerRefs[e];return this.getLayerObject(t)}return null},getLayerObjectFromLabel:function(e){for(var t=0;t<this.layers.length;t++){if(this.layers[t].label==e){return this.getLayerObject(this.layers[t].layerId)}}return null},getSelectedLayerObject:function(){return this.layerObjects[this.selectedLayerId]},getLayerRef:function(e){var t=false;for(var i=0;i<this.layerRefs.length;i++){if(this.layerRefs[i]===e){return i}}if(t===false){t=this.layerRefs.length;this.layerRefs.push(e)}return t},setLayerTileSet:function(e,t,i,r){var a=this;if(i===false){r();return}t.setToPreset(i,function(){a.editor.tileSetManager.tileSetUpdated({updateBlankCells:true,updateSortMethods:true});a.editor.tools.drawTools.tilePalette.drawTilePalette();a.editor.sideTilePalette.drawTilePalette();r()})},setLayerColorPalette:function(e,t,i,r){var a=this;if(i===false){r();return}t.setToPreset(i,function(){r()})},newLayer:function(e){var t="grid";var i=false;var r="Layer "+this.getLayerCount();var a=false;var s=1;var o="source-over";var l=false;var n=this.editor.colorPaletteManager.noColor;var h=this.editor.colorPaletteManager.noColor;var d=TextModeEditor.Mode.TEXTMODE;var c=this.editor.colorPaletteManager.getCurrentColorPalette();var f=this.editor.tileSetManager.getCurrentTileSet();var u=f.getId();var p=false;if(typeof e.tileSet!="undefined"&&e.tileSet=="new"){var v=e.tileSetName;var g=8;var m=8;if(typeof e.tileSetCreated!="undefined"&&e.tileSetCreated){u=this.editor.tileSetManager.createTileSet({name:v,width:e.newTileSet.getTileWidth(),height:e.newTileSet.getTileHeight()});f=this.editor.tileSetManager.getTileSet(u);f.copyTileSet(e.newTileSet)}else{u=this.editor.tileSetManager.createTileSet({name:v,width:g,height:m});f=this.editor.tileSetManager.getTileSet(u);p=e.tileSetPresetId}}var y=c.getId();var b=false;if(typeof e.colorPalette!="undefined"&&e.colorPalette=="new"){var C=e.colorPaletteName;y=this.editor.colorPaletteManager.createColorPalette({name:C});c=this.editor.colorPaletteManager.getColorPalette(y);if(typeof e.colorPaletteCreated!="undefined"&&e.colorPaletteCreated){c.copyPalette(e.newColorPalette)}else{b=e.colorPalettePresetId}}var x=false;var S=false;if(typeof e!=="undefined"){if(typeof e.type!="undefined"){t=e.type}if(typeof e.tileFlip!="undefined"){x=e.tileFlip}if(typeof e.tileRotate!="undefined"){S=e.tileRotate}if(typeof e.label!="undefined"){r=e.label}if(typeof e.opacity!="undefined"){s=e.opacity}if(typeof e.compositeOperation!="undefined"){o=e.compositeOperation}if(typeof e.layerId!="undefined"){i=e.layerId}if(typeof e.layerPosition!="undefined"){a=e.layerPosition}if(typeof e.layerData!="undefined"){l=e.layerData;r=l.label,t=l.type}if(typeof e.backgroundColor!="undefined"){n=e.backgroundColor}if(typeof e.screenMode!="undefined"){d=e.screenMode}if(typeof e.borderColor!="undefined"){h=e.borderColor}}if(i===false){i=g_app.getGuid()}var P=this.getLayerRef(i);if(t=="background"){r="Background"}if(l===false){l={visible:true,label:r,layerId:i,type:t,opacity:s,compositeOperation:o}}var w=this.getLayerHTML(i,r);if(this.selectedLayerId===false){if(g_app.isMobile()){$("#layersHolderMobile").append(w)}else{$("#layersHolder").append(w)}}else{$(w).insertBefore("#textModeLayer"+this.selectedLayerId)}var I=this.getSelectedLayerIndex();if(I===false){I=-1}this.layers.splice(I+1,0,l);if(t=="grid"){var k=this.editor.graphic.getGridWidth();var M=this.editor.graphic.getGridHeight();var T=this.editor.graphic.getFrameCount();var D=new LayerGrid;D.init(this.editor,i,P);D.setGridDimensions({width:k,height:M});D.setColorPalette(y);D.setTileSet(u);D.setBackgroundColor(n);D.setBorderColor(h);D.setFrameCount(T);D.setPreviewCanvasElementId("layer"+i+"preview");D.setCurrentFrame(this.editor.graphic.getCurrentFrame());D.setHasTileFlip(x);D.setHasTileRotate(S);this.layerObjects[i]=D;var E=this;this.setLayerTileSet(D,f,p,function(){if(d=="vector"&&p&&typeof p.indexOf!="undefined"&&p.indexOf("vector:")===0){D._setMode("vector")}E.setLayerColorPalette(D,c,b,function(){D.setScreenMode(d,function(){D.setBlankTileId(f.getBlankTile());D.setToBlank();E.updateLayerInterface(i)})})})}if(t=="image"){var k=this.editor.graphic.getGraphicWidth();var M=this.editor.graphic.getGraphicHeight();var _=new LayerRefImage;_.init(this.editor,i,P);_.setDimensions(k,M);_.setArgs(e);_.setPreviewCanvasElementId("layer"+i+"preview");this.layerObjects[i]=_;this.updateLayerInterface(i)}if(t=="background"){var k=this.editor.graphic.getGraphicWidth();var M=this.editor.graphic.getGraphicHeight();var T=this.editor.graphic.getFrameCount();var B=new LayerBackground;B.init(this.editor,i,P);B.setDimensions(k,M);B.setPreviewCanvasElementId("layer"+i+"preview");this.layerObjects[i]=B;this.updateLayerInterface(i)}this.editor.history.startEntry("createlayer");this.editor.history.addAction("createlayer",{layerId:i,args:e});this.editor.history.endEntry();return i},updateLayerInterface:function(e){this.updateLayerPreview(e);this.selectLayer(e);this.updateLayerLabel(e)},deleteLayer:function(e){if(this.layers.length==1){alert("Cannot delete last layer");return}var t=false;var i=false;if(typeof e!=="undefined"){if(typeof e.layerId!=="undefined"){t=e.layerId}}if(t===false){i=this.getSelectedLayerIndex();if(i==-1){return}t=this.layers[i].layerId}if(i===false){for(var r=0;r<this.layers.length;r++){if(this.layers[r].layerId==t){i=r;break}}}if(this.layers[i].type=="background"){alert("Cannot delete background layer");return}if(this.layers[i].type=="grid"){}else if(this.layers[i].type=="image"){}this.editor.history.startEntry("deletelayer");this.editor.history.addAction("deletelayer",{layerId:t,layerData:this.layers[i],layerPosition:i});this.editor.history.endEntry();this.layerObjects[t]=null;$("#textModeLayer"+t).remove();this.layers.splice(i,1);if(i<this.layers.length){this.selectLayer(this.layers[i].layerId)}else{this.selectLayer(this.layers[i-1].layerId)}this.editor.graphic.redraw({allCells:true})},editLayer:function(e){var t=false;if(typeof e=="undefined"){t=this.getSelectedLayerId()}else{t=e}var i=this.getLayerIndex(t);if(i===false){return}if(this.layerPropertiesDialog==null){this.layerPropertiesDialog=new LayerPropertiesDialog;this.layerPropertiesDialog.init(this.editor)}this.refLayerId=t;this.layerPropertiesDialog.show(this.layers[i])},moveSelect:function(e){var t=this.getSelectedLayerIndex();t+=e;if(t<0||t>=this.layers.length){return}this.selectLayer(this.layers[t].layerId)},getSelectedLayer:function(){var e=this.getSelectedLayerIndex();var t=this.layers[e];return t},selectLayer:function(e){var t=this.editor.tools.drawTools.tilePalette;var i=this.editor.graphic;var r=this.editor.colorPalettePanel.colorPaletteDisplay;var a=this.editor.tools.drawTools.tilePalette.tilePaletteDisplay;var s=false;if(a){s=a.getDrawEnabled();a.setDrawEnabled(false)}var o=this.editor.sideTilePalette;var l=this.editor.sideTilePalette.tilePaletteDisplay;var n=false;if(l){n=l.getDrawEnabled();l.setDrawEnabled(false)}var h=false;if(r){h=r.getDrawEnabled();r.setDrawEnabled(false)}var d=i.getDrawEnabled();i.setDrawEnabled(false);if(typeof e=="undefined"){var c=this.editor.grid.getXYGridPosition();for(var f=0;f<this.layers.length;f++){if(this.layers[f].type=="grid"&&this.layers[f].gridZ==c){this.selectedLayerId=this.layers[f].layerId;break}}}else{this.selectedLayerId=e}var u=g_app.doc.getDocRecord("/settings");u.data.selectedLayerId=this.selectedLayerId;$(".textModeLayerDetails").removeClass("selectedTextModeLayer");var p="textModeLayerDetails"+this.selectedLayerId;$("#"+p).addClass("selectedTextModeLayer");for(var f=0;f<this.layers.length;f++){if(this.layers[f].layerId==this.selectedLayerId){var v=this.layers[f].compositeOperation;if(typeof v=="undefined"){v="source-over"}$("#layersCompositeOperation").val(v);$("#layerOpacity").val(Math.floor(this.layers[f].opacity*100));if(this.layers[f].type=="background"){$("#layersCompositeOperation").prop("disabled",true);$("#layerOpacity").prop("disabled",true)}else{$("#layersCompositeOperation").prop("disabled",false);$("#layerOpacity").prop("disabled",false)}break}}var g=this.getSelectedLayerObject();if(g){if(typeof g.getTileSet!="undefined"){var m=g.getTileSet();if(m){this.editor.tileSetManager.setCurrentTileSetFromId(m.getId())}}if(typeof g.getColorPalette!="undefined"){var y=g.getColorPalette();if(y){this.editor.colorPaletteManager.setCurrentColorPaletteFromId(y.getId())}}if(this.editor.graphic.getType()=="sprite"){this.editor.updateCurrentColorToSpriteColor();if(g_app.isMobile()){this.editor.spriteFramesMobile.highlightCurrentSprite()}else{this.editor.spriteFrames.highlightCurrentSprite()}}this.editor.tileSetManager.updateTileSetMenu();this.editor.colorPaletteManager.updateColorPaletteMenu();if(typeof g.getScreenMode!="undefined"){this.editor.setInterfaceScreenMode(g.getScreenMode())}if(typeof g.getBlockModeEnabled!="undefined"&&g.getBlockModeEnabled()){$("#infoTableBlock").show()}else{$("#infoTableBlock").hide()}if(typeof g.getColorPerMode!="undefined"){this.editor.setInterfaceColorPerMode(g.getColorPerMode())}this.editor.updateBlockModeInterface();this.editor.updateInterfaceTileOrientation()}i.setDrawEnabled(d);this.editor.gridView2d.findViewBounds();i.redraw({allCells:true});if(a){a.setDrawEnabled(s);t.drawTilePalette({redrawTiles:true})}if(l){l.setDrawEnabled(n);o.drawTilePalette({redrawTiles:true})}if(r){r.setDrawEnabled(h);r.draw()}},updateAllLayerPreviews:function(){if(this.editor.grid.getUpdateEnabled()){for(var e=0;e<this.layers.length;e++){this.updateLayerPreview(this.layers[e].layerId)}}},updateLayerPreview:function(e){if(typeof e=="undefined"){if(this.selectedLayerId===false){this.selectLayer()}e=this.selectedLayerId}var t=this.getLayerObject(e);if(!t){return}t.updatePreview()}};var LayerPropertiesDialog=function(){this.editor=null;this.layerType="grid";this.newLayer=false;this.tileSetMode=false;this.tileSetType=false;this.tileSetPresetId=false;this.colorPaletteCreated=false;this.newColorPalette=null;this.colorPalettePresetId=false};LayerPropertiesDialog.prototype={init:function(e){this.editor=e},setLayerType:function(e){this.layerType=e;var t=520;var i=400;switch(this.layerType){case"grid":if(g_app.isMobile()){t=490}else{if(this.newLayer){t=340}else{t=290}}i=380;$("#layerDialogStandardProperties").show();$("#layerDialogGridProperties").show();$("#layerDialogBackgroundProperties").hide();$("#layerDialogImageProperties").hide();break;case"background":t=140;i=310;$("#layerDialogStandardProperties").hide();$("#layerDialogBackgroundProperties").show();$("#layerDialogImageProperties").hide();break}if(i+20>UI.getScreenWidth()){i=UI.getScreenWidth()-20}this.uiComponent.setHeight(t);this.uiComponent.setWidth(i)},show:function(e){var t=this;if(this.uiComponent==null){var i=420;var r=580;if(g_app.isMobile()){r=490}if(i>UI.getScreenWidth()){i=UI.getScreenWidth()}this.uiComponent=UI.create("UI.Dialog",{id:"layerPropertiesDialog",title:"Layer Properties",width:i,height:r});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/layerPropertiesDialog.html",function(){UI.number.initControls("#refLayer .number");t.initCompositeDropdown();t.initContent(e);t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.setLayer();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent(e)}UI.showDialog("layerPropertiesDialog")},setLayer:function(){if(this.layerType=="background"){this.editor.frames.setBackgroundColor(this.backgroundColor);return}var e=$("#layersRefImageName").val();var t=$("input[name=layerDialogTileSet]:checked").val();var i=$("input[name=layerDialogColorPalette]:checked").val();var r=$("#layersScreenMode").val();var a=this.editor.layers;if(this.layerType=="grid"){var s=$("#layerTileFlip").is(":checked");var o=$("#layerTileRotate").is(":checked");if(this.newLayer){var l=1;var n="source-over";if(t=="new"){if(!this.tileSetPresetId){this.tileSetPresetId="petscii";this.tileSetName="Commodore 64"}}if(i=="new"){if(!this.colorPalettePresetId){this.colorPalettePresetId="c64_colodore";this.colorPaletteName="Commodore 64"}}a.newLayer({label:e,opacity:l,compositeOperation:n,backgroundColor:this.backgroundColor,borderColor:this.borderColor,screenMode:r,tileFlip:s,tileRotate:o,tileSet:t,tileSetMode:this.tileSetMode,tileSetPresetId:this.tileSetPresetId,tileSetCreated:this.tileSetCreated,newTileSet:this.tileSet,tileSetName:this.tileSetName,colorPalette:i,colorPaletteCreated:this.colorPaletteCreated,colorPalettePresetId:this.colorPalettePresetId,newColorPalette:this.newColorPalette,colorPaletteName:this.colorPaletteName});this.updateEditorInterface()}else{a.setSelectedLayerBackgroundColor(this.backgroundColor);a.setSelectedLayerBorderColor(this.borderColor);var h=a.getSelectedLayerObject();if(h&&h.getType()=="grid"){h.setHasTileFlip(s);h.setHasTileRotate(o)}var d=this;h.setScreenMode(r,function(){a.setSelectedLayerLabel(e);d.updateEditorInterface()})}return}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})},updateEditorInterface:function(){this.editor.updateInterfaceTileOrientation();this.editor.currentTile.refresh();this.editor.syncColorPickers();this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})},initCompositeDropdown:function(){var e="";for(var t=0;t<this.editor.layers.compositeOperations.length;t++){if(this.editor.layers.compositeOperations[t].label=="-"){e+="<option disabled></option>"}else{e+='<option value="'+this.editor.layers.compositeOperations[t].operation+'">';e+=this.editor.layers.compositeOperations[t].label;e+="</option>"}}$("#layersRefImageMode").html(e)},setScreenModeOptions:function(){var e=$("#layersScreenMode").val();if(e==TextModeEditor.Mode.C64STANDARD||e==TextModeEditor.Mode.C64MULTICOLOR||e==TextModeEditor.Mode.C64STANDARD){$("#layerDialogFlipRotateOptions").hide();$("#layerTileFlip").prop("checked",false);$("#layerTileRotate").prop("checked",false)}else{$("#layerDialogFlipRotateOptions").show()}},initContent:function(e){var t=$("#layersScreenMode").html();if(this.editor.graphic.getType()=="sprite"){t=t.replace("Text Mode","Monochrome");$("#layerDialogGridPropertiesBackgroundColor").hide();this.setBackgroundColor(this.editor.colorPaletteManager.noColor);this.setBorderColor(this.editor.colorPaletteManager.noColor)}else{$("#layerDialogGridPropertiesBackgroundColor").show();t=t.replace("Monochrome","Text Mode")}$("#layerTileSet").prop("checked",true);$("#layerColorPaletteCurrent").prop("checked",true);this.setChooseTileSetVisibility();this.setChooseColorPaletteVisibility();$("#layersScreenMode").html(t);document.getElementById("refLayerForm").reset();this.layerObject=null;if(typeof e!="undefined"){this.newLayer=false;if(typeof e.layerId!="undefined"){this.layerObject=this.editor.layers.getLayerObject(e.layerId)}$("#layerDialogLayerTypeRow").hide();this.setLayerType(e.type);switch(e.type){case"grid":$("#layersRefImageName").val(e.label);$("#layersRefImageOpacity").val(Math.floor(e.opacity*100));$("#layersRefImageMode").val(e.compositeOperation);$("#layersScreenMode").val(this.layerObject.getScreenMode());if(this.editor.graphic.getType()=="sprite"){$("#layerDialogGridPropertiesBackgroundColor").hide();this.setBackgroundColor(this.editor.colorPaletteManager.noColor);this.setBorderColor(this.editor.colorPaletteManager.noColor)}else{$("#layerDialogGridPropertiesBackgroundColor").show();this.setBackgroundColor(this.layerObject.getBackgroundColor());this.setBorderColor(this.layerObject.getBorderColor())}if(this.layerObject){$("#layerTileFlip").prop("checked",this.layerObject.getHasTileFlip());$("#layerTileRotate").prop("checked",this.layerObject.getHasTileRotate())}break;case"background":var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=this.editor.frames.getBackgroundColor();$("#layerPropertiesDialogBackgroundColor").css("background-color","#"+i.getHexString(r));break}}else{this.newLayer=true;$("#layerDialogLayerType_grid").prop("checked",true);this.setLayerType("grid");var a=this.editor.layers.getSelectedLayerObject();$("#layerDialogLayerTypeRow").hide();if(a){$("#layersScreenMode").val(a.getMode());$("#layerTileFlip").prop("checked",a.getHasTileFlip());$("#layerTileRotate").prop("checked",a.getHasTileRotate())}else{$("#layersScreenMode").val("textmode")}this.setBackgroundColor(this.editor.colorPaletteManager.noColor);this.setBorderColor(this.editor.colorPaletteManager.noColor);$("#layersRefImageName").val("Layer "+this.editor.layers.getLayerCount());$("#layersRefImageOpacity").val("100");$("#layersRefImageMode").val("source-over")}if(this.newLayer){$("#layerDialogTileSetGroup").show();$("#layerDialogColorPaletteGroup").show()}else{$("#layerDialogTileSetGroup").hide();$("#layerDialogColorPaletteGroup").hide()}this.setScreenModeOptions()},initEvents:function(){var a=this;$("#layerProperties-backgroundColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.setBackgroundColor(e)};t.hasNone=true;var i=e.pageX;var r=e.pageY;t.currentColor=a.backgroundColor;a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("#layerProperties-borderColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.setBorderColor(e)};t.hasNone=true;var i=e.pageX;var r=e.pageY;t.currentColor=a.borderColor;a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("input[name=layerDialogTileSet]").on("click",function(){a.setChooseTileSetVisibility()});$("input[name=layerDialogColorPalette]").on("click",function(){a.setChooseColorPaletteVisibility()});if($("#layerDialogChooseTileSetButton").length>0){$("#layerDialogChooseTileSetButton").on("click",function(){a.chooseTileSet()})}if($("#layerDialogChooseColourPaletteButton").length>0){$("#layerDialogChooseColourPaletteButton").on("click",function(){a.chooseColorPalette()})}$("#layersScreenMode").on("change",function(){a.setScreenModeOptions()})},setChooseTileSetVisibility:function(){var e=$("input[name=layerDialogTileSet]:checked").val();if(e=="new"){$("#layerDialogChooseTilesetHolder").show()}else{$("#layerDialogChooseTilesetHolder").hide()}},setChooseColorPaletteVisibility:function(){var e=$("input[name=layerDialogColorPalette]:checked").val();if(e=="new"){$("#layerDialogChooseColorPaletteHolder").show()}else{$("#layerDialogChooseColorPaletteHolder").hide()}},chooseTileSet:function(){var o=this;var e={};if(this.mode=="vector"){e.type="vector"}else{e.type="character"}e.createOnLoad=true;e.callback=function(e){var t=e.type;var i=e.presetId;var r=e.description;o.tileSetCreated=e.tileSetCreated;o.tileSet=e.tileSet;o.tileSetMode=e.mode;o.tileSetType=e.type;if(e.type=="vector"){o.tileSetPresetId="vector:"+e.presetId;$("#layersScreenMode").val("vector")}else{o.tileSetPresetId=e.presetId;if($("#layersScreenMode").val()=="vector"){$("#layersScreenMode").val("textmode")}}o.setScreenModeOptions();if(r&&r.name){o.tileSetName=r.name}else{o.tileSetName=e.presetId}if(r){var a=r.width;var s=r.height;$("#layerDialogNewTileSet").html(r.name)}else{$("#layerDialogNewTileSet").html(e.presetId)}};var t=g_app.textModeEditor.tileSetManager;var i=t.getChoosePresetDialog();i.show(e)},chooseColorPalette:function(){var i=this;var e={};e.setColorPalette=false;e.createOnLoad=true;e.callback=function(e){var t=e.description;i.colorPaletteCreated=e.colorPaletteCreated;if(!e.colorPaletteCreated){i.colorPalettePresetId=e.presetId;i.newColorPalette=null}else{i.colorPalettePresetId=false;i.newColorPalette=e.colorPalette}i.colorPaletteName=t.name;if(t){$("#layerDialogNewColorPalette").html(t.name)}};var t=g_app.textModeEditor.colorPaletteManager;var r=t.getChoosePresetDialog();r.show(e)},setBackgroundColor:function(e){this.backgroundColor=e;var t=this.editor.colorPaletteManager.getCurrentColorPalette();if(this.backgroundColor!==this.editor.colorPaletteManager.noColor){var i=this.backgroundColor+"&nbsp;&nbsp; 0x"+("00"+this.backgroundColor.toString(16)).substr(-2)+"&nbsp;&nbsp; #"+t.getHexString(this.backgroundColor);$("#layerPropertiesDialogBackgroundColorDescription").html(i);$("#layerProperties-backgroundColor").css("background-color","#"+t.getHexString(this.backgroundColor));$("#layerProperties-backgroundColor").css("background-image","none")}else{$("#layerProperties-backgroundColor").css("background-color","transparent");$("#layerProperties-backgroundColor").css("background-image","url('images/transparent.png')");$("#layerPropertiesDialogBackgroundColorDescription").html("Transparent")}},setBorderColor:function(e){this.borderColor=e;var t=this.editor.colorPaletteManager.getCurrentColorPalette();if(this.borderColor!==this.editor.colorPaletteManager.noColor){var i=this.borderColor+"&nbsp;&nbsp; 0x"+("00"+this.borderColor.toString(16)).substr(-2)+"&nbsp;&nbsp; #"+t.getHexString(this.borderColor);$("#layerPropertiesDialogBorderColorDescription").html(i);$("#layerProperties-borderColor").css("background-color","#"+t.getHexString(this.borderColor));$("#layerProperties-borderColor").css("background-image","none")}else{$("#layerProperties-borderColor").css("background-color","transparent");$("#layerProperties-borderColor").css("background-image","url('images/transparent.png')");$("#layerPropertiesDialogBorderColorDescription").html("Transparent")}}};var LayerGrid=function(){this.editor=null;this.frames=[];this.currentFrame=0;this.frameCount=0;this.type="grid";this.tileWidth=8;this.tileHeight=8;this.mode=false;this.hasCharRotation=false;this.hasCharFlip=false;this.doc=null;this.canvas=null;this.context=null;this.prevFrameCanvas=null;this.prevFrameContext=null;this.refImage=null;this.refImageParams=null;this.refImageCanvas=null;this.refImageContext=null;this.previewCanvas=null;this.previewContext=null;this.viewMinX=0;this.viewMinY=0;this.viewMaxX=0;this.viewMaxY=0;this.defaultBackgroundColor=-1;this.defaultBorderColor=-1;this.updatedCellRanges={minX:0,minY:0,maxX:40,maxY:25};this.drawnBounds={fromX:0,toX:0,fromY:0,toY:0};this.backgroundCanvas=null;this.blankTileId=32;this.createSpriteTiles=true;this.lastDrawFromGridX=false;this.lastDrawFromGridY=false;this.lastDrawToGridX=false;this.lastDrawToGridY=false;this.lastDrawScale=false;this.lastCursorFromX=0;this.lastCursorFromY=0;this.lastCursorToX=0;this.lastCursorToY=0;this.lastTypingCursorFromX=0;this.lastTypingCursorFromY=0;this.lastTypingCursorToX=0;this.lastTypingCursorToY=0;this.lastDragPasteFromX=0;this.lastDragPasteFromY=0;this.lastDragPasteToX=0;this.lastDragPasteToY=0};LayerGrid.prototype={setBlankTileId:function(e,t){if(this.blankTileId===false){this.blankTileId=e;return}if(this.blankTileId===e){return}if(t){var i=this.frames;var r=this.getFrameCount();var a=this.getGridWidth();var s=this.getGridHeight();for(var o=0;o<r;o++){var l=i[o].data;for(var n=0;n<s;n++){for(var h=0;h<a;h++){if(l[n][h].t==this.blankTileId){l[n][h].t=e}}}}}this.blankTileId=e},setToBlank:function(){var e=this.frames;var t=this.getFrameCount();var i=this.getGridWidth();var r=this.getGridHeight();for(var a=0;a<t;a++){var s=e[a].data;for(var o=0;o<r;o++){for(var l=0;l<i;l++){s[o][l].t=this.blankTileId}}}},init:function(e,t,i,r){this.editor=e;this.layerId=t;this.layerRef=i;this.defaultBackgroundColor=this.editor.colorPaletteManager.noColor;this.connectToDoc();if(typeof r!="undefined"){this.mode=r}switch(this.mode){case"monochrome":this.doc.screenMode=TextModeEditor.Mode.TEXTMODE;break;default:this.doc.screenMode=this.mode;break}},loadFromDoc:function(e,t,i){this.editor=e;this.layerId=t;this.layerRef=i;this.connectToDoc()},getType:function(){return"grid"},loadReferenceImageFromDoc:function(){if(this.refImage==null){this.refImage=new Image}var t=this;this.refImage.onload=function(){var e={originalImage:t.refImage,x:0,y:0,brightness:0,contrast:0,saturation:0,colorReductionMethod:"none",scale:100};t.setReferenceImage({image:t.refImage,imageData:t.doc.refImageData,params:e});t.editor.graphic.redraw({allCells:true})};this.refImage.src=this.doc.refImageData},connectToDoc:function(e){var t=null;if(typeof e!="undefined"){if(typeof e.doc!="undefined"){t=e.doc}if(typeof e.layerId!="undefined"){this.layerId=e.layerId}if(typeof e.editor!="undefined"){this.editor=e.editor}}if(t==null){t=this.editor.doc}var i=t.data.layers;for(var r=0;r<i.length;r++){if(i[r].layerId==this.layerId){if(typeof i[r].frames=="undefined"){i[r].frames=[]}this.frames=i[r].frames;this.doc=i[r];this.frameCount=this.frames.length;if(typeof this.doc.colorPerMode=="undefined"){this.doc.colorPerMode="cell"}if(typeof this.doc.screenMode=="undefined"){this.doc.screenMode="textmode"}if(typeof this.doc.blockMode=="undefined"){this.doc.blockMode=false}if(typeof this.doc.hasTileRotate=="undefined"){this.doc.hasTileRotate=false}if(typeof this.doc.hasTileFlip=="undefined"){this.doc.hasTileFlip=false}if(typeof this.doc.blockWidth=="undefined"){this.doc.blockWidth=2}if(typeof this.doc.blockHeight=="undefined"){this.doc.blockHeight=2}switch(this.doc.screenMode){case"monochrome":this.mode=TextModeEditor.Mode.TEXTMODE;break;default:this.mode=this.doc.screenMode;break}if(typeof this.doc.refImageData=="undefined"){this.refImageParams=null;this.refImage=null}else{this.loadReferenceImageFromDoc()}var a=this.getColorPalette();if(a){this.defaultBackgroundColor=a.getDefaultBackgroundColor();this.defaultBorderColor=a.getDefaultBorderColor()}}}},setPreviewCanvasElementId:function(e){this.previewCanvas=document.getElementById(e)},setReferenceImage:function(e){this.refImage=e.image;this.refImageParams=e.params;this.doc.refImageData=e.imageData;this.editor.modified();if(this.refImageCanvas==null){this.refImageCanvas=document.createElement("canvas")}this.refImageCanvas.width=this.getWidth();this.refImageCanvas.height=this.getHeight();this.refImageContext=this.refImageCanvas.getContext("2d");this.refImageContext.drawImage(this.refImage,0,0)},getReferenceImage:function(){return this.refImage},getReferenceImageData:function(){return this.doc.refImageData},getReferenceImageParams:function(){return this.refImageParams},setFromJSON:function(e){var t=this.doc;if(typeof e.blockMode!="undefined"){t.blockMode=e.blocMode}if(typeof e.cellHeight!="undefined"){t.cellHeight=e.cellHeight}if(typeof e.cellWidth!="undefined"){t.cellWidth=e.cellWidth}if(typeof e.colorPerMode!="undefined"){t.colorPerMode=e.colorPerMode}if(typeof e.gridHeight!="undefined"){t.gridHeight=e.gridHeight}if(typeof e.gridWidth!="undefined"){t.gridWidth=e.gridWidth}if(typeof e.label!="undefined"){t.label=e.label}if(typeof e.screenMode!="undefined"){t.screenMode=e.screenMode}t.frames=e.frames;return;this.frames=layers[i].frames;this.doc=layers[i];this.frameCount=e.frames.length;if(typeof this.doc.colorPerMode=="undefined"){this.doc.colorPerMode="cell"}if(typeof this.doc.screenMode=="undefined"){this.doc.screenMode="textmode"}if(typeof this.doc.blockMode=="undefined"){this.doc.blockMode=false}if(typeof this.doc.hasTileRotate=="undefined"){this.doc.hasTileRotate=false}if(typeof this.doc.hasTileFlip=="undefined"){this.doc.hasTileFlip=false}if(typeof this.doc.blockWidth=="undefined"){this.doc.blockWidth=2}if(typeof this.doc.blockHeight=="undefined"){this.doc.blockHeight=2}switch(this.doc.screenMode){case"monochrome":this.mode=TextModeEditor.Mode.TEXTMODE;break;default:this.mode=this.doc.screenMode;break}},getJSON:function(e){var t="bottomtotop";var i=0;var r=this.editor.graphic.getFrameCount();var a=this.getGridWidth();var s=this.getGridHeight();if(typeof e!="undefined"){if(typeof e.fromFrame!="undefined"){i=e.fromFrame}if(typeof e.toFrame!="undefined"){r=e.toFrame}if(typeof e.layers!="undefined"){includeLayers=e.layers}if(typeof e.direction!="undefined"){t=e.direction}}var o=[];var l=this.doc.screenMode;if(l!=="indexed color"){}else{o.push("fc");o.push("bc")}if(this.getHasTileFlip()){o.push("fh");o.push("fv")}if(this.getHasTileRotate()){o.push("rz")}var n=this.getColorPerMode();if(n=="character"||n=="block"||l=="indexed color"){o.push("fc");o.push("bc")}var h=0;var d=s;var c=1;if(t!="bottomtotop"){h=s-1;d=-1;c=-1}var f={};f.id=this.doc.layerId;f.label=this.doc.label;f.gridWidth=a;f.gridHeight=s;f.colorPerMode=n;f.screenMode=this.doc.screenMode;f.cellWidth=this.getCellWidth();f.cellHeight=this.getCellHeight();f.tileSetId=this.doc.tileSetId;f.colorPaletteId=this.doc.colorPaletteId;f.blockMode=this.getBlockModeEnabled();if(f.blockMode){f.blockWidth=this.getBlockWidth();f.blockHeight=this.getBlockHeight()}f.frames=[];for(var u=i;u<r;u++){if(u<this.frames.length){var p=[];for(var v=h;v!=d;v+=c){p[v]=[];for(var g=0;g<a;g++){var m={};var y=this.frames[u].data[v][g];for(var b in y){if(!o.includes(b)){var C=b;m[C]=y[b]}}p[v][g]=m}}var x=this.getBackgroundColor(u);var S=this.getBorderColor(u);f.frames.push({data:p,bgColor:x,borderColor:S})}}return f},getCanvas:function(){if(this.canvas==null){this.canvas=document.createElement("canvas")}var e=this.doc.gridWidth*this.doc.cellWidth;var t=this.doc.gridHeight*this.doc.cellHeight;var i=this.getMode();if(i!=TextModeEditor.Mode.VECTOR){if(this.canvas.width!=e||this.canvas.height!=t){this.canvas.width=e;this.canvas.height=t}}return this.canvas},getPrevFrameCanvas:function(){if(this.prevFrameCanvas==null){this.prevFrameCanvas=document.createElement("canvas")}var e=this.getMode();if(e!=TextModeEditor.Mode.VECTOR){var t=this.doc.gridWidth*this.doc.cellWidth;var i=this.doc.gridHeight*this.doc.cellHeight;if(this.prevFrameCanvas.width!=t||this.prevFrameCanvas.height!=i){this.prevFrameCanvas.width=t;this.prevFrameCanvas.height=i}}return this.prevFrameCanvas},getPreviewCanvas:function(){return this.previewCanvas},isCurrentLayer:function(){return this.layerId==this.editor.layers.getSelectedLayerId()},setScreenMode:function(e,t){return this.setMode(e,t)},getTransparentColorIndex:function(){if(typeof this.doc.transparentColorIndex=="undefined"){return 0}return this.doc.transparentColorIndex},setTransparentColorIndex:function(e){this.doc.transparentColorIndex=e;this.editor.modified()},setHasTileFlip:function(e){this.doc.hasTileFlip=e;this.editor.modified()},getHasTileFlip:function(){return this.doc.hasTileFlip},setHasTileRotate:function(e){this.doc.hasTileRotate=e;this.editor.modified()},getHasTileRotate:function(){return this.doc.hasTileRotate},setMode:function(i,r){var e=false;if(typeof i.tileSet!="undefined"){e=i.tileSet}if(typeof i.mode!="undefined"){i=i.mode}var t=false;var a=this.editor.layers.getLayerCount();for(var s=0;s<a;s++){var o=this.editor.layers.getLayerObjectFromIndex(s);if(o.getId()!=this.getId()){if(o.getTileSetId()==this.getTileSetId()){t=true;break}}}if(i=="vector"&&this.doc.screenMode!="vector"||this.doc.screenMode=="vector"&&i!="vector"){var l=this.getTileSet();if(t){var n=i+" Tile Set";n=n[0].toUpperCase()+n.substring(1);var h=this.editor.tileSetManager.createTileSet({name:n,width:8,height:8});l=this.editor.tileSetManager.getTileSet(h);l.setTileCount(256);this.setTileSet(l.getId())}}var d=this;if(i=="vector"){if(this.doc.screenMode=="vector"){if(typeof r!="undefined"){r()}}else{if(e==false){e="modular-shapes"}l.setToVector(e,function(){d._setMode(i);var e=d.editor.tools.drawTools.tilePalette.tilePaletteDisplay;var t=d.editor.sideTilePalette.tilePaletteDisplay;e.draw({redrawTiles:true});t.draw({redrawTiles:true});if(typeof r!="undefined"){r()}})}}else{if(this.doc.screenMode=="vector"){l.setToPreset("petscii",function(){d._setMode(i);if(typeof r!="undefined"){r()}})}else{this._setMode(i);if(typeof r!="undefined"){r()}}}},_setMode:function(e){var t=this.editor.grid.getUpdateEnabled();this.editor.grid.setUpdateEnabled(false);this.mode=e;switch(this.mode){case"monochrome":this.doc.screenMode=TextModeEditor.Mode.TEXTMODE;break;default:this.doc.screenMode=this.mode;break}this.editor.modified();if(e==TextModeEditor.Mode.C64STANDARD){if(this.editor.currentTile.getBGColor()!==this.editor.colorPaletteManager.noColor){this.editor.currentTile.setBGColor(this.editor.colorPaletteManager.noColor)}}if(e==TextModeEditor.Mode.C64ECM){var i=this.currentFrame;if(this.editor.currentTile.getBGColor()==this.editor.colorPaletteManager.noColor){this.editor.currentTile.setBGColor(0)}if(typeof this.frames[i].c64ECMColor1=="undefined"){this.frames[i].c64ECMColor1=0}if(typeof this.frames[i].c64ECMColor2=="undefined"){this.frames[i].c64ECMColor2=1}if(typeof this.frames[i].c64ECMColor3=="undefined"){this.frames[i].c64ECMColor3=2}}if(this.isCurrentLayer()){this.editor.tileSetManager.updateSortMethods();this.setAsCurrentLayer()}this.editor.grid.setUpdateEnabled(t);this.editor.graphic.redraw({allCells:true});if(this.type=="2d"){this.layers.updateAllLayerPreviews()}},getMode:function(){return this.mode},getScreenMode:function(){return this.mode},getColorPerMode:function(){return this.doc.colorPerMode},setColorPerMode:function(e){if(this.doc.colorPerMode=="character"&&e=="cell"){this.updateGridColorsFromTiles()}this.doc.colorPerMode=e;this.editor.modified()},getBlockSet:function(){return this.editor.blockSetManager.getCurrentBlockSet()},getBlockModeEnabled:function(){return this.doc.blockMode},setBlockModeEnabled:function(e){if(this.doc.blockMode&&!e){this.updateTilesFromBlocks()}this.doc.blockMode=e;this.editor.modified();if(this.isCurrentLayer()){this.editor.updateBlockModeInterface()}},initFrameBlocks:function(e){for(var t=0;t<this.frames.length;t++){var i=this.frames[t].data;if(i){for(var r=0;r<i.length;r++){for(var a=0;a<i[r].length;a++){if(typeof i[r][a].b==="undefined"){i[r][a].b=e}}}}}},setAsCurrentLayer:function(){this.editor.setInterfaceScreenMode(this.mode)},setBlockDimensions:function(e,t){this.doc.blockWidth=parseInt(e,10);this.doc.blockHeight=parseInt(t,10);this.editor.modified()},getId:function(){return this.doc.layerId},getLabel:function(){return this.doc.label},getWidth:function(){return this.getCellWidth()*this.getGridWidth()},getHeight:function(){return this.getCellHeight()*this.getGridHeight()},getCellWidth:function(){return this.doc.cellWidth},getCellHeight:function(){return this.doc.cellHeight},getGridWidth:function(){return this.doc.gridWidth},getGridHeight:function(){return this.doc.gridHeight},getGridDepth:function(){return this.depth},getBlockWidth:function(){return this.doc.blockWidth},getBlockHeight:function(){return this.doc.blockHeight},getXOffsetInBlock:function(e){var t=e%this.getBlockWidth();return t},getYOffsetInBlock:function(e){var t=e%this.getBlockHeight();return t},colorsUpdated:function(){if(this.isCurrentLayer()){this.editor.tileSetManager.redrawCharacters();this.editor.graphic.invalidateAllCells();if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update({allCells:true})}if(typeof this.editor.tools.drawTools.blockPalette&&this.editor.blockEditor){if(this.editor.blockEditor.visible){this.editor.blockEditor.draw()}}}if(this.editor.type=="2d"){this.editor.layers.updateAllLayerPreviews()}},setC64ECMColor:function(e,t,i,r){if(!this.frames||this.currentFrame===false){return}var a=this.currentFrame;if(typeof i!=="undefined"){a=i}if(e==0||e==this.editor.colorPaletteManager.noColor){return this.setBackgroundColor(t,a)}if(this.currentFrame!==false&&this.currentFrame<this.frames.length){switch(e){case 1:this.frames[a].c64ECMColor1=t;break;case 2:this.frames[a].c64ECMColor2=t;break;case 3:this.frames[a].c64ECMColor3=t;break}}this.editor.modified();if(this.isCurrentLayer()){}if(typeof r==="undefined"||r===true){this.colorsUpdated()}},getC64ECMColor:function(e,t){var i=this.currentFrame;if(typeof t!=="undefined"){i=t}if(!this.frames||i===false){return this.editor.colorPaletteManager.noColor}if(e===0||e===this.editor.colorPaletteManager.noColor){return this.getBackgroundColor(i)}if(this.currentFrame!==false&&this.currentFrame<this.frames.length){switch(e){case 1:return this.frames[i].c64ECMColor1;case 2:return this.frames[i].c64ECMColor2;case 3:return this.frames[i].c64ECMColor3}}return 0},getC64Multi1Color:function(e){var t=this.currentFrame;if(typeof e!=="undefined"){t=e}if(!this.frames||t===false){return this.editor.colorPaletteManager.noColor}if(t!==false&&t<this.frames.length){color=this.frames[t].c64Multi1Color;if(typeof color!="undefined"){return color}}color=11;var i=this.getColorPalette();if(color>=i.getColorCount()){return 0}return color},setC64Multi1Color:function(e,t){if(!this.frames||this.currentFrame===false){return}if(this.currentFrame!==false&&this.currentFrame<this.frames.length){if(this.frames[this.currentFrame].c64Multi1Color!==e){this.frames[this.currentFrame].c64Multi1Color=e;this.editor.modified()}}if(this.isCurrentLayer()){var i=this.getColorPalette();$(".c64Multi1Color").css("background-color","#"+i.getHexString(e));$(".c64Multi1ColorDisplay").css("background-color","#"+i.getHexString(e))}if(typeof t==="undefined"||t===true){this.colorsUpdated()}},getC64Multi2Color:function(e){var t=this.currentFrame;if(typeof e!=="undefined"){t=e}if(!this.frames||t===false){return this.editor.colorPaletteManager.noColor}if(t!==false&&t<this.frames.length){color=this.frames[t].c64Multi2Color;if(typeof color!="undefined"){return color}}color=12;var i=this.getColorPalette();if(color>=i.getColorCount()){return 1}return color},setC64Multi2Color:function(e,t){if(!this.frames||this.currentFrame===false){return}if(this.currentFrame!==false&&this.currentFrame<this.frames.length){if(this.frames[this.currentFrame].c64Multi2Color!==e){this.frames[this.currentFrame].c64Multi2Color=e;this.editor.modified()}}if(this.isCurrentLayer()){var i=this.editor.colorPaletteManager.getCurrentColorPalette();$(".c64Multi2Color").css("background-color","#"+i.getHexString(e));$(".c64Multi2ColorDisplay").css("background-color","#"+i.getHexString(e))}if(typeof t==="undefined"||t===true){this.colorsUpdated()}},setBackgroundColor:function(e,t){if(this.frames.length==0){this.defaultBackgroundColor=e}var i=this.currentFrame;if(typeof t!=="undefined"){i=t}if(i<this.frames.length){if(this.frames[i].bgColor!==e){this.frames[i].bgColor=e;this.editor.modified()}}},getBackgroundColor:function(e){var t=this.currentFrame;if(typeof e!=="undefined"){t=e}if(t<this.frames.length&&typeof this.frames[t].bgColor!="undefined"){return this.frames[t].bgColor}return this.defaultBackgroundColor},setBorderColor:function(e,t){if(this.frames.length==0){this.defaultBorderColor=e}var i=this.currentFrame;if(typeof t!=="undefined"){i=t}if(i<this.frames.length){this.frames[i].borderColor=e;this.editor.modified()}},getBorderColor:function(e){var t=this.editor.colorPaletteManager.noColor;var i=e;if(typeof i=="undefined"){i=this.currentFrame}if(this.frames&&i!==false&&i<this.frames.length){t=this.frames[i].borderColor;if(typeof t!="undefined"){return t}}return this.defaultBorderColor;var r=this.getColorPalette();t=r.getDefaultBorderColor();return t},clear:function(){if(this.playFrames){this.playFrames=false}for(var e=0;e<this.frames.length;e++){this.clearFrame(e)}this.frames=[];this.frameCount=0},clearFrame:function(e){if(e<0||e>=this.frames.length){return}if(this.frames[e].data){this.frames[e].data=null}this.editor.modified()},setColorPalette:function(e){this.doc.colorPaletteId=e;this.editor.modified()},getColorPalette:function(){var e=null;if(this.doc.colorPaletteId){return this.editor.colorPaletteManager.getColorPalette(this.doc.colorPaletteId)}else{return this.editor.colorPaletteManager.getCurrentColorPalette()}},setCellDimensions:function(e,t){},setTileSet:function(e){this.doc.tileSetId=e;this.editor.modified();if(this.isCurrentLayer()){this.editor.tileSetManager.setCurrentTileSetFromId(e)}},getTileSetId:function(){return this.doc.tileSetId},getTileSet:function(){if(this.doc.tileSetId){return this.editor.tileSetManager.getTileSet(this.doc.tileSetId)}else{return this.editor.tileSetManager.getCurrentTileSet()}},setCreateSpriteTiles:function(e){this.createSpriteTiles=e},setGridDimensions:function(e){var t=this.getTileSet();var i=this.doc;var r=i.gridWidth;var a=i.gridHeight;var s=0;var o=0;var l=this.getCellWidth();var n=this.getCellHeight();if(typeof e!="undefined"){if(typeof e.width!="undefined"){r=e.width}if(typeof e.height!="undefined"){a=e.height}if(typeof e.offsetX!="undefined"){s=e.offsetX}if(typeof e.offsetY!="undefined"){o=e.offsetY}if(typeof e.cellWidth!="undefined"){l=e.cellWidth}if(typeof e.cellHeight!="undefined"){n=e.cellHeight}}if(r==i.gridWidth&&a==i.gridHeight&&this.tileWidth==t.getTileWidth()&&this.tileHeight==t.getTileHeight()&&s==0&&o==0&&n==this.getCellHeight()&&l==this.getCellWidth()){return}this.tileWidth=t.getTileWidth();this.tileHeight=t.getTileHeight();this.doc.cellWidth=this.tileWidth;this.doc.cellHeight=this.tileHeight;if(i.gridWidth!==r||i.gridHeight!==a||s!==0||o!==0){var h=[];for(var d=0;d<this.frameCount;d++){h[d]={};h[d].holder=this.frames[d].holder;for(g in this.frames[d]){if(this.frames[d].hasOwnProperty(g)&&g!=="data"){h[d][g]=this.frames[d][g]}}h[d].data=null;var c=this.frames[0].data[0][0].fc;var f=this.editor.graphic.getType();var u=this.frames[d].data;s=-s;o=-o;if(u){h[d].data=[];for(var p=0;p<a;p++){h[d].data[p]=[];for(var v=0;v<r;v++){if(p+o<u.length&&p+o>=0&&v+s<u[p+o].length&&v+s>=0){h[d].data[p][v]={t:this.blankTileId,fc:c,bc:-1,rz:0,fh:0,fv:0};for(var g in u[p+o][v+s]){h[d].data[p][v][g]=u[p+o][v+s][g]}}else{var m=this.blankTileId;if(f=="sprite"&&this.createSpriteTiles){m=t.createTile()}h[d].data[p][v]={t:m,fc:c,bc:-1,rz:0,fh:0,fv:0}}}}}}this.doc.frames=h;this.frames=this.doc.frames;this.doc.gridWidth=r;this.doc.gridHeight=a;this.editor.modified();this.invalidateAllCells();this.gridWidth=r;this.gridHeight=a}},insertFrame:function(e,t){var i=this.editor.graphic.getType();var r=false;var a=0;var s=0;if(typeof e=="undefined"){e=this.currentFrame}var o=null;if(typeof t!="undefined"&&t){o=t}else{o={data:null}}o.bgColor=this.getBackgroundColor();o.c64Multi1Color=this.getC64Multi1Color();o.c64Multi2Color=this.getC64Multi2Color();if(this.getScreenMode()==TextModeEditor.Mode.C64ECM){o.c64ECMColor1=this.getC64ECMColor(1);o.c64ECMColor2=this.getC64ECMColor(2);o.c64ECMColor3=this.getC64ECMColor(3)}o.borderColor=this.getBorderColor();this.frames.splice(e+1,0,o);this.frameCount++;this.updateFrameInfo();this.setCurrentFrame(e+1);this.editor.modified()},updateFrameInfo:function(){if(this.isCurrentLayer()){var e=" / "+this.frameCount;$("#frameCountInfo").html(e);if(g_app.isMobile()){var t=this.currentFrame+1;e=t+" / "+this.frameCount;$("#frameCountInfoMobile").html(e)}}},createFrame:function(){this.insertFrame()},duplicateFrame:function(e,t){var i=this.getTileSet();if(e<0||e>=this.frames.length||t<0||t>=this.frames.length){return}var r=this.doc.gridHeight;var a=this.doc.gridWidth;var s={};s.z=0;for(s.y=0;s.y<r;s.y++){for(s.x=0;s.x<a;s.x++){var o=this.frames[e].data[s.y][s.x];for(var l in o){if(o.hasOwnProperty(l)){s[l]=o[l]}}if(this.editor.graphic.getType()=="sprite"){s.t=false;if(this.frames[t].data){s.t=this.frames[t].data[s.y][s.x].t}if(s.t===false){s.t=i.duplicateTile(o.t)}else{i.copyTile(o.t,s.t)}}s.frame=t;s.update=false;this.setCell(s)}}},deleteFrame:function(e){if(typeof e=="undefined"){e=this.currentFrame}if(this.frames.length<=1){return false}var t=this.frames.splice(e,1);var i=this.frameCount-1;this.setFrameCount(i)},setFrameCount:function(e){var t=0;if(this.frames.length>0){t=this.frames[this.frames.length-1].bgColor}else{var i=this.getColorPalette();if(i!=null){t=this.defaultBackgroundColor}}var r=this.editor.colorPaletteManager.noColor;if(this.frames.length>0){r=this.frames[this.frames.length-1].borderColor}else{r=this.defaultBorderColor}while(e>this.frames.length){if(this.frames.length==0){var a=this.getTileSet();if(a){this.setBlankTileId(a.getBlankCharacter(),false)}}this.frames.push({data:null,bgColor:t,borderColor:r});this.createFrameData(this.frames.length-1)}if(e<this.frameCount){for(var s=e;s<this.frameCount;s++){this.clearFrame(s)}}this.frameCount=e;this.updateFrameInfo();this.editor.modified()},getFrameCount:function(){return this.frameCount},getCurrentFrame:function(){return this.currentFrame},setFrameData:function(e,t,i){var r=this.doc;if(this.frames[e].data==null){this.frames[e].data=[]}var a=this.frames[e].data;var s=typeof t[0][0].rz!="undefined";var o=this.getBlockModeEnabled()&&t[0][0].b!="undefined";a=[];for(var l=0;l<r.gridHeight;l++){a[l]=[];for(var n=0;n<r.gridWidth;n++){if(l<t.length&&n<t[0].length){a[l][n]={t:t[l][n].t,fc:t[l][n].fc,bc:t[l][n].bc,rz:0,fh:0,fv:0};if(s){a[l][n].rz=t[l][n].rz;a[l][n].fh=t[l][n].fh;a[l][n].fv=t[l][n].fv}}else{a[l][n]={t:this.blankTileId,fc:1,bc:-1,rz:0,fh:0,fv:0};if(this.getBlockModeEnabled()){a[l][n].b=0}}}}},getFrames:function(){return this.frames},getFrameData:function(e){return this.frames[e]},createFrameData:function(e){var t=this.getTileSet();var i=this.doc;if(this.frames[e].data==null){var r=[];for(var a=0;a<i.gridHeight;a++){r[a]=[];for(var s=0;s<i.gridWidth;s++){var o=this.blankTileId;if(this.editor.graphic.getType()=="sprite"&&this.createSpriteTiles){o=t.createTile()}r[a][s]={t:o,fc:1,bc:-1,rz:0,fh:0,fv:0};if(this.getBlockModeEnabled()){r[a][s].b=0}}}this.frames[e].data=r}},updateTilesFromBlocks:function(){var e=this.getColorPerMode();for(var t=0;t<this.frames.length;t++){var i=this.getGridWidth();var r=this.getGridHeight();var a=this.frames[t].data;if(!a){return false}var s=this.editor.blockSetManager.getCurrentBlockSet();for(var o=0;o<r;o++){for(var l=0;l<i;l++){var n=a[o][l];if(this.getBlockModeEnabled()&&n.b!==false){var h=this.getXOffsetInBlock(l);var d=this.getYOffsetInBlock(o);n.t=s.getCharacterInBlock(n.b,h,d);if(e=="block"){n.fc=s.getBlockColor(n.b);n.bc=s.getBlockBGColor(n.b)}}}}}},updateGridColorsFromTiles:function(){var e=this.getColorPerMode();if(e!="character"){return}var t=this.getTileSet();for(var i=0;i<this.frames.length;i++){var r=this.getGridWidth();var a=this.getGridHeight();var s=this.frames[i].data;if(!s){return false}for(var o=0;o<a;o++){for(var l=0;l<r;l++){var n=s[o][l];n.fc=t.getTileColor(n.t);n.bc=t.getTileBGColor(n.t)}}}},invalidateAllCells:function(){var e=this.doc;this.updatedCellRanges.minX=0;this.updatedCellRanges.maxX=e.gridWidth;this.updatedCellRanges.minY=0;this.updatedCellRanges.maxY=e.gridHeight;this.drawnBounds.fromX=0;this.drawnBounds.fromY=0;this.drawnBounds.toX=0;this.drawnBounds.toY=0},setCurrentFrame:function(e){e=parseInt(e,10);if(isNaN(e)||e>=this.frameCount||e<0){return false}this.currentFrame=parseInt(e,10);this.createFrameData(this.currentFrame);this.invalidateAllCells();if(this.isCurrentLayer()){var t=this.getColorPalette();var i=this.frames[e].bgColor;var r=this.frames[e].borderColor;if(t){if(typeof i=="undefined"){i=t.getDefaultBackgroundColor();this.frames[e].bgColor=i}if(typeof r=="undefined"){r=t.getDefaultBorderColor();this.frames[e].borderColor=r}}this.editor.tools.currentBackgroundColor=i;if(i!==this.editor.colorPaletteManager.noColor&&i>=0){}if(r!==this.editor.colorPaletteManager.noColor&&r>=0){}}},getCell:function(e){var t=this.currentFrame;if(typeof e.frame!=="undefined"){t=e.frame}if(isNaN(t)||t<0||t>=this.frames.length){return false}var i=this.frames[t].data;if(!i){return false}var r=e.x;var a=e.y;if(a<0||a>=i.length||r<0||r>=i[0].length){return false}var s=i[a][r];if(this.getBlockModeEnabled()&&s.b!==false){var o=this.getXOffsetInBlock(r);var l=this.getYOffsetInBlock(a);var n=this.editor.blockSetManager.getCurrentBlockSet();s.t=n.getCharacterInBlock(s.b,o,l)}return s},getTile:function(e){var t=this.getCell(e);if(t===false){return false}return t.t},nesCheckAttributes:function(e,t,i){var r=this.frames[e].data;if(!r){return}var a=this.doc.gridWidth;var s=this.doc.gridHeight;var o=r[i][t];var l=t+1;if(t%2){l=t-1}var n=i+1;if(i%2){n=i-1}if(l>=0&&l<a){if(r[i][l].fc!=r[i][t].fc){var h={};h.x=l;h.y=i;h.checkNESAttributes=false;for(var d in r[i][l]){if(r[i][l].hasOwnProperty(d)){h[d]=r[i][l][d]}}h.fc=r[i][t].fc;this.setCell(h)}}if(n>=0&&n<s){if(r[n][t].fc!=r[i][t].fc){var h={};h.x=t;h.y=n;h.checkNESAttributes=false;for(var d in r[i][l]){if(r[n][t].hasOwnProperty(d)){h[d]=r[n][t][d]}}h.fc=r[i][t].fc;this.setCell(h)}}if(l>=0&&l<a&&n>=0&&n<s){if(r[n][l].fc!=r[i][t].fc){var h={};h.x=l;h.y=n;h.checkNESAttributes=false;for(var d in r[n][l]){if(r[n][l].hasOwnProperty(d)){h[d]=r[n][l][d]}}h.fc=r[i][t].fc;this.setCell(h)}}},setCell:function(e){if(typeof e.t=="undefined"){return}var t=this.currentFrame;if(typeof e.frame!=="undefined"){t=e.frame}if(t===false){return}if(isNaN(t)||t<0||t>=this.frames.length){return}var i=this.frames[t].data;if(!i){return}var r=this.doc;var a=e.x;var s=e.y;var o=0;var l=e.t;var n=false;if(typeof e.b!=="undefined"){n=e.b}var h=this.editor.currentTile.color;if(typeof e.fc!=="undefined"){h=e.fc}var d=this.editor.currentTile.rotX;if(typeof e.rx!=="undefined"){d=e.rx}var c=this.editor.currentTile.rotY;if(typeof e.ry!=="undefined"){c=e.ry}var f=this.editor.currentTile.rotZ;if(typeof e.rz!=="undefined"){f=e.rz}fh=0;if(typeof e.fh!=="undefined"){fh=e.fh}fv=0;if(typeof e.fv!=="undefined"){fv=e.fv}if(this.editor.tools.drawTools.select.isActive()){if(!this.editor.tools.drawTools.select.inSelection(a,s,o)){return}}if(a>=r.gridWidth||a<0||s>=r.gridHeight||s<0){return}var u=i[s][a];var p=this.editor.currentTile.bgColor;if(typeof e.bc!=="undefined"){p=e.bc}else{if(typeof u.bc!="undefined"){p=u.bc}}if(!r.blockMode){if(u.t==l&&u.fc==h&&u.rz==f&&u.fh==fh&&u.fv==fv&&u.bc===p){return}}if(t===this.currentFrame){if(a<this.updatedCellRanges.minX){this.updatedCellRanges.minX=a}if(a+1>this.updatedCellRanges.maxX){this.updatedCellRanges.maxX=a+1}if(s<this.updatedCellRanges.minY){this.updatedCellRanges.minY=s}if(s+1>this.updatedCellRanges.maxY){this.updatedCellRanges.maxY=s+1}if(a>=this.drawnBounds.fromX&&a<this.drawnBounds.toX){this.drawnBounds.fromX=a+1}if(s>=this.drawnBounds.fromY&&s<this.drawnBounds.toY){this.drawnBounds.fromY=s+1}}var v={x:a,y:s,layerRef:this.layerRef,oldCharacter:u.t,oldColor:u.fc,oldBgColor:u.bc,oldFh:u.fh,oldFv:u.fv,oldRz:u.rz,newCharacter:l,newColor:h,newBgColor:p,newFh:fh,newFv:fv,newRz:f,frame:t};if(this.getBlockModeEnabled()&&n!==false){v["oldB"]=u.b;v["newB"]=n}if(this.hasCharRotation){v["oldRx"]=u.rx;v["oldRy"]=u.ry;v["newRx"]=d;v["newRy"]=c}if(!this.getBlockModeEnabled()||n!==false){this.editor.history.addAction("setCell",v)}u.t=l;u.fc=h;u.bc=p;u.fh=fh;u.fv=fv;u.rz=f;if(this.getBlockModeEnabled()){if(n!==false){u.b=n}else{n=i[s][a].b;if(typeof n!=="undefined"){var g=this.getXOffsetInBlock(a);var m=this.getYOffsetInBlock(s);var y=this.editor.blockSetManager.getCurrentBlockSet();y.setCharacterInBlock(n,g,m,l)}}}if(this.getScreenMode()==TextModeEditor.Mode.NES){if(typeof e.checkNESAttributes=="undefined"||e.checkNESAttributes!==false){this.nesCheckAttributes(t,a,s)}}this.editor.modified()},updatePreview:function(){var e=this.doc.gridWidth*this.doc.cellWidth;var t=this.doc.gridHeight*this.doc.cellHeight;var i=80;var r=80;if(e>i){t=i/e*t;e=i}if(t>r){e=r/t*e;t=r}if(e<1){e=1}if(t<1){t=1}if(this.previewCanvas.width!=e||this.previewCanvas.height!=t){this.previewCanvas.width=e;this.previewCanvas.height=t}this.previewContext=this.previewCanvas.getContext("2d");if(this.backgroundCanvas==null){this.backgroundCanvas=document.createElement("canvas")}if(this.backgroundCanvas.width!=this.previewCanvas.width||this.backgroundCanvas.height!=this.previewCanvas.height){this.backgroundCanvas.width=this.previewCanvas.width;this.backgroundCanvas.height=this.previewCanvas.height;this.backgroundContext=this.backgroundCanvas.getContext("2d");this.backgroundContext.fillStyle="#cccccc";this.backgroundContext.fillRect(0,0,this.backgroundCanvas.width,this.backgroundCanvas.height);var a=5;var s=Math.ceil(this.backgroundCanvas.width/a);var o=Math.ceil(this.backgroundCanvas.height/a);this.backgroundContext.fillStyle="#bbbbbb";for(var l=0;l<o;l++){for(var n=0;n<s;n++){if((n+l)%2){this.backgroundContext.fillRect(n*a,l*a,a,a)}}}}this.previewContext.drawImage(this.backgroundCanvas,0,0,this.previewCanvas.width,this.previewCanvas.height);if(this.isCurrentLayer()&&this.editor.frames.getShowPrevFrame()){var h=this.getColorPalette();var d=this.getBackgroundColor();if(d!==this.editor.colorPaletteManager.noColor){this.previewContext.fillStyle="#"+h.getHexString(d);this.previewContext.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height)}}this.previewContext.drawImage(this.getCanvas(),0,0,this.previewCanvas.width,this.previewCanvas.height)},setViewBounds:function(e,t,i,r){this.viewMinX=Math.floor(e/this.doc.cellWidth);this.viewMaxX=Math.ceil(i/this.doc.cellWidth);this.viewMinY=Math.floor(t/this.doc.cellHeight);this.viewMaxY=Math.ceil(r/this.doc.cellHeight)},hasCellBackgroundColors:function(){var e=this.getGridHeight();var t=this.getGridWidth();var i=this.frameCount;if(i>10){i=10}for(var r=0;r<i;r++){if(this.frames[r].data){for(y=0;y<e;y++){for(x=0;x<t;x++){if(this.frames[r].data[y][x].bc!=this.editor.colorPaletteManager.noColor){return true}}}}}return false},setSpriteColor:function(e){var t=this.getGridWidth();var i=this.getGridHeight();for(var r=0;r<i;r++){for(var a=0;a<t;a++){var s=this.getCell({x:a,y:r});if(s.fc!==e){this.setCell({x:a,y:r,fc:e,t:s.t})}}}},drawPixels:function(e){var t=e.canvas;var i=e.pixelData;var r=i.length;var a=i[0].length;if(t.width<a){t.width=a}if(t.height<r){t.height=r}var s=0;if(typeof e.colorIndex!="undefined"){s=e.colorIndex}var o=this.currentFrame;if(typeof e.frame!=="undefined"){o=e.frame}var l=t.getContext("2d");var n=this.getColorPalette();var h=this.getScreenMode();var d=this.editor.graphic.getType()=="sprite";var c=[];if(h===TextModeEditor.Mode.C64MULTICOLOR){var f=this.getBackgroundColor(o);var u=this.editor.currentTile.color;var p=this.getC64Multi1Color(o);var v=this.getC64Multi2Color(o);c=[];if(this.editor.graphic.getType()=="sprite"){c.push(n.getColor(f));c.push(n.getColor(p));c.push(n.getColor(u));c.push(n.getColor(v))}else{c.push(n.getColor(f));c.push(n.getColor(p));c.push(n.getColor(v));c.push(n.getColor(u))}}var g=n.getHex(s);var m=g>>16&255;var y=g>>8&255;var b=g&255;l.clearRect(0,0,a,r);var C=l.getImageData(0,0,a,r);var h=this.getMode();if(h==TextModeEditor.Mode.C64MULTICOLOR){for(var x=0;x<r;x++){for(var S=0;S<a;S++){var P=(x*a+S)*4;if(S+1<i[r-1].length){var w=i[x][S];var I=0;if(w>0){I+=2}w=i[x][S+1];if(w>0){I+=1}var g=c[I];if(I==0){C.data[P+3]=0;C.data[P+7]=0}else if(!d&&I==3||d&&I==2){C.data[P]=m;C.data[P+1]=y;C.data[P+2]=b;C.data[P+3]=255;C.data[P+4]=m;C.data[P+5]=y;C.data[P+6]=b;C.data[P+7]=255}else{C.data[P]=g.r*255;C.data[P+1]=g.g*255;C.data[P+2]=g.b*255;C.data[P+3]=255;C.data[P+4]=g.r*255;C.data[P+5]=g.g*255;C.data[P+6]=g.b*255;C.data[P+7]=255}S++}}}}else{for(var x=0;x<r;x++){for(var S=0;S<a;S++){var w=i[x][S];if(w){var P=(x*a+S)*4;C.data[P++]=m;C.data[P++]=y;C.data[P++]=b;C.data[P++]=255}}}}l.putImageData(C,0,0)},replaceColor:function(e,t){var i=this.getGridWidth();var r=this.getGridHeight();for(var a=0;a<this.frames.length;a++){var s=this.frames[a].data;for(var o=0;o<r;o++){for(var l=0;l<i;l++){if(s[o][l].fc==e){s[o][l].fc=t}if(s[o][l].bc==e){s[o][l].bc=t}}}var n=this.frames[a].bgColor;if(n===e){this.frames[a].bgColor=t}var h=this.frames[a].borderColor;if(h===e){this.frames[a].borderColor=t}}},drawVector:function(e){var t=e.canvas;var i=t.getContext("2d");var r=this.getTileSet();var a=this.getColorPalette();var s=this.getGridWidth();var o=this.getGridHeight();var l=r.getTileWidth();var n=r.getTileHeight();var h=false;if(typeof e.allCells!="undefined"){h=e.allCells}var d=false;if(typeof e.shapes!="undefined"){d=e.shapes}if(d){h=true}var c=false;if(typeof e.fgOnly!="undefined"){c=e.fgOnly}var f=false;if(typeof e.bgOnly!="undefined"){f=e.bgOnly}var u=false;if(typeof e.cursor!="undefined"){u=e.cursor}var p=false;if(typeof e.eraseCursor!="undefined"){p=e.eraseCursor}var v=false;if(typeof e.typingCursor!="undefined"){v=e.typingCursor}var g=false;if(typeof e.eraseTypingCursor!="undefined"){g=e.eraseTypingCursor}var m=false;if(typeof e.dragPaste!="undefined"){m=e.dragPaste}var y=false;if(typeof e.eraseDragPaste!="undefined"){y=e.eraseDragPaste}var b=this.editor.layers.isBackgroundVisible();if(typeof e.drawBackground!="undefined"){b=e.drawBackground}var C="grid";if(typeof e.draw!="undefined"){C=e.draw}var x=0;var S=0;if(typeof e.drawFromX=="undefined"||typeof e.drawFromY=="undefined"){return{offsetX:x,offsetY:S}}var P=e.scale;var w=e.drawFromX;var I=e.drawFromY;var k=e.drawToX;var M=e.drawToY;if(w<0){w=0}if(I<0){I=0}var T=Math.floor(w/l);var D=Math.floor(I/n);var E=Math.ceil(k/l);var $=Math.ceil(M/n);if(T!=this.lastDrawFromGridX||D!=this.lastDrawFromGridY||E!=this.lastDrawToGridX||$!=this.lastDrawToGridY||P!=this.lastDrawScale){h=true;if(!f){if(!u&&!p&&!m&&!y&&!v&&!g){this.lastDrawFromGridX=T;this.lastDrawFromGridY=D;this.lastDrawToGridX=E;this.lastDrawToGridY=$;this.lastDrawScale=P}}}x=(T*l-w)*P;S=(D*n-I)*P;if(E>s){E=s}if($>o){$=o}var _=E-T;var B=$-D;l=l*P;n=n*P;var R=Math.ceil(_*l);var A=Math.ceil(B*n);if(t.width<R||t.height<A){t.width=R;t.height=A;i=t.getContext("2d");h=true}if(typeof P=="undefined"){return{offsetX:x,offsetY:S}}var F=this.currentFrame;if(typeof e.frame!=="undefined"){F=e.frame}var L=this.getHasTileFlip();var U=this.getHasTileRotate();if(F>=this.frames.length){return{offsetX:x,offsetY:S}}var H=this.getColorPerMode();var O=this.frames[F].data;var G=this.editor.tools.drawTools.shapes.getGrid();var z=this.getTransparentColorIndex();var N=0;var W=0;var X=0;var Y=false;var V=false;var q=false;var j=false;var K=this.getBackgroundColor(F);if(!b){K=this.editor.colorPaletteManager.noColor}var Z=T;var J=E;var Q=D;var ee=$;var te=0;var ie=0;var re=false;var ae=this.editor.tools.drawTools.select.selection.minX;var se=this.editor.tools.drawTools.select.selection.minY;var oe=this.editor.tools.drawTools.select.selectionOffsetX;var le=this.editor.tools.drawTools.select.selectionOffsetY;var ne=this.editor.tools.drawTools.select.selection.maxX-this.editor.tools.drawTools.select.selection.minX;var he=this.editor.tools.drawTools.select.selection.maxY-this.editor.tools.drawTools.select.selection.minY;if(h){}var de=0;var ce=0;var fe=false;var ue=false;if(y){Z=this.lastDragPasteFromX-1;Q=this.lastDragPasteFromY-1;J=this.lastDragPasteToX+1;ee=this.lastDragPasteToY+1;if(J>s){J=s}if(ee>o){ee=o}if(Z<0){Z=0}if(Q<0){Q=0}te=(Z-T)*l;ie=(Q-D)*n}else if(m){ue=this.editor.tools.drawTools.select.getPasteData();if(ue.length==0){return}var pe=ae+oe;var ve=se+le;var ge=ue[0].length;var me=ue.length;Z=pe;Q=ve;J=Z+ge;ee=Q+me;te=(Z-T)*l;ie=(Q-D)*n;this.lastDragPasteFromX=Z;this.lastDragPasteFromY=Q;this.lastDragPasteToX=J;this.lastDragPasteToY=ee}else if(p){Z=this.lastCursorFromX;Q=this.lastCursorFromY;J=this.lastCursorToX;ee=this.lastCursorToY;if(J>s){J=s}if(ee>o){ee=o}if(Z<0){Z=0}if(Q<0){Q=0}te=(Z-T)*l;ie=(Q-D)*n}else if(u){fe=this.editor.currentTile.getTiles();var ye=this.editor.grid.grid2d.cursor.position.x+this.editor.grid.grid2d.cursor.offset.x;var be=this.editor.grid.grid2d.cursor.position.y+this.editor.grid.grid2d.cursor.offset.y;var Ce=this.editor.currentTile.getCursorWidth();var xe=this.editor.currentTile.getCursorHeight();Z=ye;Q=be;J=Z+Ce;ee=Q+xe;te=(Z-T)*l;ie=(Q-D)*n;this.lastCursorFromX=Z;this.lastCursorFromY=Q;this.lastCursorToX=J;this.lastCursorToY=ee}else if(v){Z=this.editor.tools.drawTools.typing.cursor.x;Q=this.editor.tools.drawTools.typing.cursor.y;if(this.lastTypingCursorFromX!==false&&(this.lastTypingCursorFromX!=Z||this.lastTypingCursorFromY!=Q)){Z=this.lastTypingCursorFromX;Q=this.lastTypingCursorFromY;J=this.lastTypingCursorToX;ee=this.lastTypingCursorToY;if(J>s){J=s}if(ee>o){ee=o}if(Z<0){Z=0}if(Q<0){Q=0}te=(Z-T)*l;ie=(Q-D)*n;this.lastTypingCursorFromX=false;this.lastTypingCursorFromY=false;g=true;v=false}else{J=Z+1;ee=Q+1;te=(Z-T)*l;ie=(Q-D)*n;this.lastTypingCursorFromX=Z;this.lastTypingCursorFromY=Q;this.lastTypingCursorToX=J;this.lastTypingCursorToY=ee}}else if(g){if(this.lastTypingCursorFromX===false){return}Z=this.lastTypingCursorFromX;Q=this.lastTypingCursorFromY;J=this.lastTypingCursorToX;ee=this.lastTypingCursorToY;if(J>s){J=s}if(ee>o){ee=o}if(Z<0){Z=0}if(Q<0){Q=0}te=(Z-T)*l;ie=(Q-D)*n;this.lastTypingCursorFromX=false;this.lastTypingCursorFromY=false}else if(h===false&&C!="shapes"&&C!="prevgrid"){if(this.updatedCellRanges.minX>=this.updatedCellRanges.maxX||this.updatedCellRanges.minY>=this.updatedCellRanges.maxY){return{offsetX:x,offsetY:S}}Z=this.updatedCellRanges.minX;if(Z<T){Z=T}J=this.updatedCellRanges.maxX;if(J>E){J=E}Q=this.updatedCellRanges.minY;if(Q<D){Q=D}ee=this.updatedCellRanges.maxY;if(ee>$){ee=$}te=(Z-T)*l;ie=(Q-D)*n}var Se=0;var Pe=0;var we=R;var Ie=A;Se=te;Pe=ie;we=(J-Z)*l;Ie=(ee-Q)*n;if(h){}if(!h&&!u&&!m){var ke=(Z-T)*l;var Me=(Q-D)*n;var Te=we;var De=Ie;if(Z>0){Z-=1;ke-=l/2;Te+=l/2;te=(Z-T)*l}if(J<s){J+=1;Te+=l/2}if(Q>0){Q-=1;Me-=n/2;De+=n/2;ie=(Q-D)*n}if(ee<o){ee+=1;De+=n/2}re=true;i.save();i.beginPath();i.rect(ke,Me,Te,De);i.clip();Se=te;Pe=ie;we=(J-Z)*l;Ie=(ee-Q)*n}if(!c&&!v){if(K!=this.editor.colorPaletteManager.noColor){i.fillStyle="#"+a.getHexString(K);i.fillRect(Se,Pe,we,Ie)}else{i.clearRect(Se,Pe,we,Ie)}}var Ee=l;var $e=r.getFontScale();var P=Ee*$e;var _e=r.getFontAscent();if(v){Z=this.editor.tools.drawTools.typing.cursor.x;Q=this.editor.tools.drawTools.typing.cursor.y;J=Z+1;ee=Q+1;te=(Z-T)*l;ie=(Q-D)*n;var N=this.editor.currentTile.getColor();i.fillStyle="#"+a.getHexString(N);i.fillRect(te,ie,l,n);this.lastTypingCursorFromX=Z;this.lastTypingCursorFromY=Q;this.lastTypingCursorToX=J;this.lastTypingCursorToY=ee}else{for(var Be=Q;Be<ee;Be++,ie+=n,ce++){if(Be>=0&&Be<O.length){te=(Z-T)*l;de=0;for(var Re=Z;Re<J;Re++,te+=l,de++){if(Re>=0&&Re<O[Be].length){N=O[Be][Re].fc;W=O[Be][Re].bc;j=true;charIndex=O[Be][Re].t;Y=O[Be][Re].fv;V=O[Be][Re].fh;q=O[Be][Re].rz;if(Re>=ae+oe&&Re<ae+oe+ne&&Be>=se+le&&Be<se+le+he){var Ae=Re-oe;var Fe=Be-le;if(Fe>=0&&Fe<O.length&&Ae>=0&&Ae<O[Fe].length){N=O[Fe][Ae].fc;W=O[Fe][Ae].bc;j=true;charIndex=O[Fe][Ae].t;Y=O[Fe][Ae].fv;V=O[Fe][Ae].fh;q=O[Fe][Ae].rz}}if(d){if(G[Be][Re].t!==false){charIndex=G[Be][Re].t;V=G[Be][Re].fh;Y=G[Be][Re].fv;q=G[Be][Re].rz}if(G[Be][Re].fc!==false){N=G[Be][Re].fc}}if(u){charIndex=fe[ce][de];N=this.editor.currentTile.getColor();W=this.editor.currentTile.getBGColor();V=this.editor.currentTile.flipH;Y=this.editor.currentTile.flipV;q=this.editor.currentTile.rotZ}if(m){var Le=ue[ce][de];charIndex=Le.t;N=Le.fc;W=Le.bc;V=Le.fh;Y=Le.fv;q=Le.rz}var Ue=r.getGlyphPath(charIndex);if(Ue!=null){if(!c){if(W!==-1){var K="#"+a.getHexString(W);i.fillStyle=K;i.fillRect(te,ie,l,n)}else{if(u&&K==this.editor.colorPaletteManager.noColor){i.clearRect(te,ie,l,n)}}}i.fillStyle="#"+a.getHexString(N);i.strokeStyle=i.fillStyle;if(!f){i.setTransform(P,0,0,-P,te,ie+_e*P);if(L&&V){i.translate(1/(2*$e),-1/(2*$e)+_e);i.scale(-1,1);i.translate(-1/(2*$e),1/(2*$e)-_e)}if(L&&Y){i.translate(1/(2*$e),-1/(2*$e)+_e);i.scale(1,-1);i.translate(-1/(2*$e),1/(2*$e)-_e)}if(U&&q!=0){i.translate(1/(2*$e),-1/(2*$e)+_e);i.rotate(q*90*Math.PI/180);i.translate(-1/(2*$e),1/(2*$e)-_e)}i.fill(Ue);i.setTransform(1,0,0,1,0,0)}}}}}}}if(re){i.restore()}if(u){te=(Z-T)*l;ie=(Q-D)*n;this.editor.gridView2d.drawCursorBox(i,te,ie,(J-Z)*l,(ee-Q)*n,5)}if(!p&&!u&&!y&&!m&&!v&&!g){if(!f){this.updatedCellRanges.minX=this.doc.gridWidth;this.updatedCellRanges.maxX=0;this.updatedCellRanges.minY=this.doc.gridHeight;this.updatedCellRanges.maxY=0}}return{offsetX:x,offsetY:S}},draw:function(e){var t=e.canvas;var i=t.getContext("2d");var r=false;if(typeof e.allCells!="undefined"){r=e.allCells}var a=this.editor.layers.isBackgroundVisible();if(typeof e.drawBackground!="undefined"){a=e.drawBackground}var s="grid";if(typeof e.draw!="undefined"){s=e.draw}var o=false;if(typeof e.shapes!="undefined"){o=e.shapes}if(o){r=true}var l=this.getMode();if(l==TextModeEditor.Mode.VECTOR){return this.drawVector(e)}var n=this.currentFrame;if(typeof e.frame!=="undefined"){n=e.frame}var h=this.getHasTileFlip();var d=this.getHasTileRotate();if(n>=this.frames.length){return}var c=this.frames[n];var f=this.getTileSet();var u=this.getColorPalette();this.tileData=f.getData();var p=f.getTileWidth();var v=f.getTileHeight();var g=this.getBlockModeEnabled();var m=null;if(g){m=this.editor.blockSetManager.getCurrentBlockSet()}var y=this.getGridWidth();var b=this.getGridHeight();var C=0;var x=0;var S=y;var P=b;var w=false;if(r===false){C=this.viewMinX;x=this.viewMinY;S=this.viewMaxX;P=this.viewMaxY;if(s!="shapes"&&s!="prevgrid"){C=this.updatedCellRanges.minX;S=this.updatedCellRanges.maxX;x=this.updatedCellRanges.minY;P=this.updatedCellRanges.maxY}if(C<this.viewMinX){C=this.viewMinX}if(x<this.viewMinY){x=this.viewMinY}if(S>this.viewMaxX){S=this.viewMaxX}if(P>this.viewMaxY){P=this.viewMaxY}}if(typeof e.fromX!="undefined"){C=e.fromX}if(typeof e.fromY!="undefined"){x=e.fromY}if(typeof e.toX!="undefined"){S=e.toX}if(typeof e.toY!="undefined"){P=e.toY}if(s!="prevgrid"){w=C>this.updatedCellRanges.minX||x>this.updatedCellRanges.minY||S<this.updatedCellRanges.maxX||P<this.updatedCellRanges.maxY}if(C>=S||x>=P){return}if(C<0){C=0}if(S>=y){S=y}if(P>=b){P=b}if(P<0){P=0}var I=C*p;var k=x*v;var M=S*p;var T=P*v;var D=M-I;var E=T-k;var $=this.editor.tools.drawTools.shapes.getGrid();var _=this.editor.graphic.getType()=="sprite";var B=[];if(this.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){var R=this.getBackgroundColor(n);var A=this.editor.currentTile.color;var F=this.getC64Multi1Color(n);var L=this.getC64Multi2Color(n);B=[];if(this.editor.graphic.getType()=="sprite"){B.push(u.getColor(R));B.push(u.getColor(F));B.push(u.getColor(A));B.push(u.getColor(L))}else{B.push(u.getColor(R));B.push(u.getColor(F));B.push(u.getColor(L));B.push(u.getColor(A))}}var U=[];if(this.getScreenMode()==TextModeEditor.Mode.C64ECM){U[0]=this.getC64ECMColor(0);U[1]=this.getC64ECMColor(1);U[2]=this.getC64ECMColor(2);U[3]=this.getC64ECMColor(3)}var H=this.getColorPerMode();var O=this.frames[n].data;var G=this.getBackgroundColor(n);if(!a){G=this.editor.colorPaletteManager.noColor}if(this.getScreenMode()==TextModeEditor.Mode.NES){G=this.editor.colorPaletteManager.colorSubPalettes.getPaletteColor(0,0)}var z=this.getTransparentColorIndex();if(s!="selection"&&s!="prevgrid"&&this.drawnBounds.toX>this.drawnBounds.fromX&&this.drawnBounds.toY>this.drawnBounds.fromY){if(G!=this.editor.colorPaletteManager.noColor){i.fillStyle="#"+u.getHexString(G)}var N=this.drawnBounds.fromX*p;var W=this.drawnBounds.toX*p;var X=this.drawnBounds.fromY*v;var Y=this.drawnBounds.toY*v;if(I<N){var V=N-I;if(M<N){V=M-I}if(G!==this.editor.colorPaletteManager.noColor&&s!="selection"&&s!="shapes"){i.fillRect(I,k,V,E)}else{i.clearRect(I,k,V,E)}if(this.refImageCanvas&&s!="selection"&&s!="shapes"){i.drawImage(this.refImageCanvas,I,k,V,E,I,k,V,E)}}if(M>W){var q=W;var V=M-q;if(G!==this.editor.colorPaletteManager.noColor&&s!="selection"&&s!="shapes"){i.fillRect(q,k,V,E)}else{i.clearRect(q,k,V,E)}if(this.refImageCanvas&&s!="selection"&&s!="shapes"){i.drawImage(this.refImageCanvas,q,k,V,E,q,k,V,E)}}if(k<X){var j=X-k;if(T<X){j=T-k}if(G!==this.editor.colorPaletteManager.noColor&&s!="selection"&&s!="shapes"){i.fillRect(I,k,D,j)}else{i.clearRect(I,k,D,j)}if(this.refImageCanvas&&s!="selection"&&s!="shapes"){i.drawImage(this.refImageCanvas,I,k,D,j,I,k,D,j)}}if(T>Y){var K=Y;var j=T-K;if(G!==this.editor.colorPaletteManager.noColor&&s!="selection"&&s!="shapes"){i.fillRect(I,K,D,j)}else{i.clearRect(I,K,D,j)}if(this.refImageCanvas&&s!="selection"&&s!="shapes"){i.drawImage(this.refImageCanvas,I,K,D,j,I,K,D,j)}}}else{if(G!==this.editor.colorPaletteManager.noColor&&s!="selection"&&s!="shapes"){i.fillStyle="#"+u.getHexString(G);i.fillRect(I,k,D,E)}else{i.clearRect(I,k,D,E)}if(this.refImageCanvas&&s!="selection"&&s!="shapes"){i.drawImage(this.refImageCanvas,I,k,D,E,I,k,D,E)}}var Z=i.getImageData(I,k,D,E);var J=Z.width;var Q=this.blankTileId;var l=this.getMode();var ee=this.isCurrentLayer()&&this.editor.tools.drawTools.select.isActive()&&!this.editor.tools.drawTools.select.isInPasteMove();for(var te=x;te<P;te++){for(var ie=C;ie<S;ie++){if(ie<this.drawnBounds.fromX||ie>=this.drawnBounds.toX||te<this.drawnBounds.fromY||te>=this.drawnBounds.toY||s=="selection"||s=="prevgrid"){var re=false;var ae=false;var se=false;var oe=0;switch(s){case"selection":var le=this.editor.tools.drawTools.select;var ne=le.getSelection();var he=le.selectionOffsetX;var de=le.selectionOffsetY;re=false;charIndex=Q;bgColorIndex=this.editor.colorPaletteManager.noColor;if(ie>=ne.minX+he&&ie<ne.maxX+he){if(te>=ne.minY+de&&te<ne.maxY+de){if(te-de>=0&&te-de<O.length&&ie-he>=0&&ie-he<O[te-de].length){var ce=te-de;var fe=ie-he;if(g){var ue=O[ce][fe].b;Fe=O[ce][fe].fc;bgColorIndex=O[ce][fe].bc;if(ue!=="undefined"){var pe=this.getXOffsetInBlock(fe);var ve=this.getYOffsetInBlock(te);charIndex=m.getCharacterInBlock(ue,pe,ve);re=true;if(charIndex===false){charIndex=Q}if(H=="block"){Fe=m.getBlockColor(ue);bgColorIndex=m.getBlockBGColor(ue)}}else{charIndex=Q;re=true}}else{re=true;charIndex=O[te-de][ie-he].t;Fe=O[te-de][ie-he].fc;bgColorIndex=O[te-de][ie-he].bc;ae=O[te-de][ie-he].fh;se=O[te-de][ie-he].fv;oe=O[te-de][ie-he].rz}}}}break;case"shapes":re=true;charIndex=$[te][ie].t;if(charIndex===false){re=false;charIndex=Q}Fe=$[te][ie].fc;bgColorIndex=$[te][ie].bc;ae=$[te][ie].fh;se=$[te][ie].fv;oe=$[te][ie].rz;if(Fe===false){re=false}break;default:Fe=O[te][ie].fc;bgColorIndex=O[te][ie].bc;if(g){var ue=O[te][ie].b;if(ue!=="undefined"){var pe=this.getXOffsetInBlock(ie);var ve=this.getYOffsetInBlock(te);charIndex=m.getCharacterInBlock(ue,pe,ve);re=true;if(charIndex===false){charIndex=Q}if(H=="block"){Fe=m.getBlockColor(ue);bgColorIndex=m.getBlockBGColor(ue)}}else{charIndex=Q;re=true}}else{re=true;charIndex=O[te][ie].t}if(H=="character"){if(charIndex!==false){Fe=f.getTileColor(charIndex);bgColorIndex=f.getCharacterBGColor(charIndex)}}se=O[te][ie].fv;ae=O[te][ie].fh;oe=O[te][ie].rz;if(ee&&this.editor.tools.drawTools.select.inSelection(ie,te,0)){re=false;charIndex=Q;bgColorIndex=this.editor.colorPaletteManager.noColor}break}if(this.getMode()==TextModeEditor.Mode.C64MULTICOLOR){bgColorIndex=this.editor.colorPaletteManager.noColor}if(this.getMode()==TextModeEditor.Mode.C64ECM){if(bgColorIndex!==this.editor.colorPaletteManager.noColor){if(bgColorIndex<U.length){bgColorIndex=U[bgColorIndex]}}}var ge=false;var me=false;var ye=false;if(re){var l=this.getMode();if(l==TextModeEditor.Mode.C64MULTICOLOR){if(this.editor.graphic.getType()!=="sprite"){if(Fe<8){l=TextModeEditor.Mode.TEXTMODE}else{Fe-=8}}}var be=u.getHex(Fe);var Ce=be>>16&255;var xe=be>>8&255;var Se=be&255;var Pe=Fe;if(Pe>=4){Pe=0}if(bgColorIndex!==-1){var G=u.getHex(bgColorIndex);ge=G>>16&255;me=G>>8&255;ye=G&255}var we=charIndex%32;var Ie=Math.floor(charIndex/32);if(charIndex!==false&&charIndex<this.tileData.length){if(this.getScreenMode()==TextModeEditor.Mode.C64ECM){if(charIndex>=64||bgColorIndex===this.editor.colorPaletteManager.noColor||bgColorIndex===false){var ke=Math.floor(charIndex/64)%4;bgColorIndex=U[ke];var G=u.getHex(bgColorIndex);ge=G>>16&255;me=G>>8&255;ye=G&255}var Me=Math.floor(charIndex/256);charIndex=charIndex%64+Me*256}var Te=this.tileData[charIndex];for(var De=0;De<v;De++){for(var Ee=0;Ee<p;Ee++){var $e=Ee;var _e=De;if(h){if(ae){$e=p-$e-1}if(se){_e=v-_e-1}}if(d){if(oe!=0&&p===v){var Be=$e;var Re=_e;if(oe===1){_e=p-Be-1;$e=Re}if(oe===2){$e=p-Be-1;_e=v-Re-1}if(oe===3){_e=Be;$e=v-Re-1}}}var Ae=$e+_e*p;var Fe=Te[Ae];var Le=(ie*p-I+Ee+(te*v-k+De)*J)*4;if(l===TextModeEditor.Mode.TEXTMODE||l===TextModeEditor.Mode.C64ECM||l===TextModeEditor.Mode.C64STANDARD){if(Fe>0){Z.data[Le]=Ce;Z.data[Le+1]=xe;Z.data[Le+2]=Se;Z.data[Le+3]=255}else if(bgColorIndex!==-1){Z.data[Le]=ge;Z.data[Le+1]=me;Z.data[Le+2]=ye;Z.data[Le+3]=255}}else if(l==TextModeEditor.Mode.INDEXED){if(Fe===z){Z.data[Le]=0;Z.data[Le+1]=0;Z.data[Le+2]=0;Z.data[Le+3]=0}else{var be=u.getHex(Fe);Ce=be>>16&255;xe=be>>8&255;Se=be&255;Z.data[Le]=Ce;Z.data[Le+1]=xe;Z.data[Le+2]=Se;Z.data[Le+3]=255}}else if(l==TextModeEditor.Mode.RGB){Ce=Fe>>>16&255;xe=Fe>>>8&255;Se=Fe&255;colorA=Fe>>>24&255;Z.data[Le]=Ce;Z.data[Le+1]=xe;Z.data[Le+2]=Se;Z.data[Le+3]=colorA}else if(l==TextModeEditor.Mode.C64MULTICOLOR){var Ue=0;if(Fe>0){Ue+=2}Fe=Te[Ae+1];if(Fe>0){Ue+=1}var be=B[Ue];if(Ue==0&&f.backgroundIsTransparent){}else if(!_&&Ue==3||_&&Ue==2){Z.data[Le]=Ce;Z.data[Le+1]=xe;Z.data[Le+2]=Se;Z.data[Le+3]=255;Z.data[Le+4]=Ce;Z.data[Le+5]=xe;Z.data[Le+6]=Se;Z.data[Le+7]=255}else{Z.data[Le]=be.r*255;Z.data[Le+1]=be.g*255;Z.data[Le+2]=be.b*255;Z.data[Le+3]=255;Z.data[Le+4]=be.r*255;Z.data[Le+5]=be.g*255;Z.data[Le+6]=be.b*255;Z.data[Le+7]=255}Ee++}else if(l==TextModeEditor.Mode.NES){if(Fe>=4){Fe=1}if(Fe==0){}else{var He=this.editor.colorPaletteManager.colorSubPalettes.getPaletteColor(Pe,Fe);var be=u.getHex(He);Z.data[Le]=be>>16&255;Z.data[Le+1]=be>>8&255;Z.data[Le+2]=be&255;Z.data[Le+3]=255}}}}}}}}}if(this.getMode()!==TextModeEditor.Mode.VECTOR){i.putImageData(Z,I,k)}if(this.isCurrentLayer()&&this.editor.tools.drawTools.pixelSelect.isActive()&&s=="grid"){var ne=this.editor.tools.drawTools.pixelSelect.getSelection();var Oe=this.getWidth();var Ge=this.getHeight();var ze=ne.minX;var Ne=ne.minY;var We=ne.maxX;var Xe=ne.maxY;var D=We-ze;var E=Xe-Ne;var I=ze;var k=Ne;if(G!==this.editor.colorPaletteManager.noColor){i.fillStyle="#"+u.getHexString(G);i.fillRect(I,k,D,E)}else{i.clearRect(I,k,D,E)}}if(s=="grid"){if(!w){this.updatedCellRanges.minX=this.doc.gridWidth;this.updatedCellRanges.maxX=0;this.updatedCellRanges.minY=this.doc.gridHeight;this.updatedCellRanges.maxY=0;this.drawnBounds.fromX=0;this.drawnBounds.toX=0;this.drawnBounds.fromY=0;this.drawnBounds.toY=0}else{this.editor.graphic.setOnlyViewBoundsDrawn(true);this.drawnBounds.fromX=C;this.drawnBounds.toX=S;this.drawnBounds.fromY=x;this.drawnBounds.toY=P}}}};var LayerBackground=function(){this.editor=null;this.frames=[];this.currentFrame=0;this.doc=null;this.canvas=null;this.context=null;this.previewCanvas=null;this.previewContext=null;this.backgroundCanvas=null;this.width=0;this.height=0};LayerBackground.prototype={init:function(e,t,i){this.editor=e;this.layerId=t;this.layerRef=i;this.connectToDoc()},getType:function(){return"background"},connectToDoc:function(){var e=this.editor.doc;var t=e.data.layers;for(var i=0;i<t.length;i++){this.doc=t[i]}},setDimensions:function(e,t){this.width=e;this.height=t},getCanvas:function(){if(this.canvas==null){this.canvas=document.createElement("canvas")}var e=this.width;var t=this.height;if(this.canvas.width!=e||this.canvas.height!=t){this.canvas.width=e;this.canvas.height=t}return this.canvas},updatePreview:function(){var e=this.width;var t=this.height;var i=80;var r=80;if(e>i){t=i/e*t;e=i}if(t>r){e=r/t*e;t=r}if(this.previewCanvas.width!=e||this.previewCanvas.height!=t){this.previewCanvas.width=e;this.previewCanvas.height=t}this.previewContext=this.previewCanvas.getContext("2d");this.previewContext.drawImage(this.getCanvas(),0,0,this.previewCanvas.width,this.previewCanvas.height)},setPreviewCanvasElementId:function(e){this.previewCanvas=document.getElementById(e)},getColor:function(){return 4},setColor:function(e,t){var i=t;if(typeof i=="undefined"){i=this.currentFrame}this.frames[i]=e;200},draw:function(e){var t=e.canvas;var i=t.getContext("2d");var r=this.editor.colorPaletteManager.getCurrentColorPalette();var a=this.getColor();i.fillStyle="#"+r.getHexString(a);i.fillRect(x,y,srcCanvas.width*this.scale,srcCanvas.height*this.scale)}};var LayerRefImage=function(){this.editor=null;this.doc=null;this.canvas=null;this.context=null;this.image=null;this.imageCanvas=null;this.imageContext=null;this.previewCanvas=null;this.previewContext=null;this.backgroundCanvas=null;this.width=0;this.height=0};LayerRefImage.prototype={init:function(e,t,i){this.editor=e;this.layerId=t;this.layerRef=i;this.connectToDoc()},getId:function(){return this.doc.layerId},getLabel:function(){return this.doc.label},getType:function(){return"image"},isCurrentLayer:function(){return this.layerId==this.editor.layers.getSelectedLayerId()},connectToDoc:function(){var e=this.editor.doc;var t=e.data.layers;for(var i=0;i<t.length;i++){if(t[i].layerId==this.layerId){this.doc=t[i]}}if(typeof this.doc.width=="undefined"){this.doc.width=1}if(typeof this.doc.height=="undefined"){this.doc.height=1}},loadFromDoc:function(e,t,i){this.editor=e;this.layerId=t;this.layerRef=i;this.connectToDoc();var r=new Image;r.src=this.doc.imageData;var a=this;r.onload=function(){a.doc.width=r.naturalWidth;a.doc.height=r.naturalHeight;var e={};e.image=r;e.params={x:0,y:0,brightness:0,contrast:0,saturation:0,colorReductionMethod:"none",scale:100};e.imageData=a.doc.imageData;a.setArgs(e);a.editor.graphic.redraw();a.updatePreview()}},setDimensions:function(e,t){this.doc.width=e;this.doc.height=t},setArgs:function(e){this.image=e.image;this.originalImage=e.image;this.params=e.params;if(typeof this.params.originalImage=="undefined"){this.params.originalImage=this.image}this.doc.imageData=e.imageData;if(this.imageCanvas==null){this.imageCanvas=document.createElement("canvas")}this.imageCanvas.width=this.doc.width;this.imageCanvas.height=this.doc.height;this.imageContext=this.imageCanvas.getContext("2d");this.imageContext.drawImage(this.image,0,0);var t=this.getCanvas();var i=t.getContext("2d");i.drawImage(this.image,0,0)},getParams:function(){return this.params},getOriginalImage:function(){return this.originalImage},setPreviewCanvasElementId:function(e){this.previewCanvas=document.getElementById(e)},getCanvas:function(){if(this.canvas==null){this.canvas=document.createElement("canvas")}if(this.image!==null){var e=this.doc.width;var t=this.doc.height;if(e==0){e=1}if(t==0){t=1}if(this.canvas.width!=e||this.canvas.height!=t){if(e!=0){this.canvas.width=e}if(t!=0){this.canvas.height=t}}}return this.canvas},updatePreview:function(){console.log("update preview!!!");var e=this.doc.width;var t=this.doc.height;var i=80;var r=80;if(e>i){t=i/e*t;e=i}if(t>r){e=r/t*e;t=r}if(this.previewCanvas.width!=e||this.previewCanvas.height!=t){this.previewCanvas.width=e;this.previewCanvas.height=t}this.previewContext=this.previewCanvas.getContext("2d");if(this.backgroundCanvas==null){this.backgroundCanvas=document.createElement("canvas")}if(this.backgroundCanvas.width!=this.previewCanvas.width||this.backgroundCanvas.height!=this.previewCanvas.height){this.backgroundCanvas.width=this.previewCanvas.width;this.backgroundCanvas.height=this.previewCanvas.height;this.backgroundContext=this.backgroundCanvas.getContext("2d");this.backgroundContext.fillStyle="#cccccc";this.backgroundContext.fillRect(0,0,this.backgroundCanvas.width,this.backgroundCanvas.height);var a=5;var s=Math.ceil(this.backgroundCanvas.width/a);var o=Math.ceil(this.backgroundCanvas.height/a);this.backgroundContext.fillStyle="#bbbbbb";for(var l=0;l<o;l++){for(var n=0;n<s;n++){if((n+l)%2){this.backgroundContext.fillRect(n*a,l*a,a,a)}}}}this.previewContext.drawImage(this.backgroundCanvas,0,0,this.previewCanvas.width,this.previewCanvas.height);this.previewContext.drawImage(this.getCanvas(),0,0,this.previewCanvas.width,this.previewCanvas.height)},draw:function(e){console.log("draw!!");var t=e.canvas;var i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);if(this.imageCanvas){i.drawImage(this.imageCanvas,0,0)}}};var ReferenceImageDialog=function(){this.editor=null;this.prefix="";this.scale=1;this.brightness=0;this.contrast=0;this.saturation=0;this.hue=0;this.colorReductionMethod="dither";this.ditherThreshold=0;this.mouseDownAtX=0;this.mouseDownAtY=0;this.currentOffsetX=0;this.currentOffsetY=0;this.mouseIsDown=false;this.canvas=null;this.previewCanvas=null;this.previewCanvasMaxWidth=320;this.previewCanvasMaxHeight=320;this.context=null;this.image=null;this.imageDataURL=null;this.x=0;this.y=0;this.drawWidth=0;this.drawHeight=0;this.canvasWidth=0;this.canvasHeight=0;this.imageParametersEffect=null;this.backgroundCanvas=null;this.layerType="grid";this.newLayer=false;this.useColors="all";this.ditherMethod="FloydSteinberg";this.imageLib=null;this.touchCount=0;this.previewScale=1;this.colorPickerMobile=null};ReferenceImageDialog.prototype={init:function(e){this.editor=e;this.imageLib=new ImageLib},show:function(e){var t=this;this.dialogReadyCallback=false;if(typeof e!="undefined"){if(typeof e.dialogReadyCallback!="undefined"){this.dialogReadyCallback=e.dialogReadyCallback}}if(g_app.isMobile()){this.prefix="mobile_";if(this.uiComponent==null){var i=640;var r=460;if(g_app.isMobile()){r=490}if(i>UI.getScreenWidth()){i=UI.getScreenWidth()}this.uiComponent=UI.create("UI.MobilePanel",{id:"referenceImageDialogMobile",title:"Reference Image",fullScreen:true,maxWidth:640,maxHeight:800});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/referenceImageDialogMobile.html",function(){UI.number.initControls("#"+this.prefix+"refLayer .number");t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.setLayerRefImage();UI.closeDialog()})}else{this.initContent(e)}UI.showDialog("referenceImageDialogMobile")}else{if(this.uiComponent==null){var i=640;var r=460;if(g_app.isMobile()){r=490}if(i>UI.getScreenWidth()){i=UI.getScreenWidth()}this.uiComponent=UI.create("UI.Dialog",{id:"referenceImageDialog",title:"Reference Image",width:i,height:r});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/referenceImageDialog.html",function(){UI.number.initControls("#"+this.prefix+"refLayer .number");t.initContent();t.initEvents();if(t.dialogReadyCallback!==false){t.dialogReadyCallback()}});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.setLayerRefImage();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent();if(t.dialogReadyCallback!==false){t.dialogReadyCallback()}}UI.showDialog("referenceImageDialog")}},initBackgroundCanvas:function(){if(this.backgroundCanvas==null){this.backgroundCanvas=document.createElement("canvas")}if(this.backgroundCanvas.width!=this.previewCanvas.width||this.backgroundCanvas.height!=this.previewCanvas.height){this.backgroundCanvas.width=this.previewCanvas.width;this.backgroundCanvas.height=this.previewCanvas.height;this.backgroundContext=this.backgroundCanvas.getContext("2d")}this.backgroundContext.fillStyle="#cccccc";this.backgroundContext.fillRect(0,0,this.backgroundCanvas.width,this.backgroundCanvas.height);var e=5;var t=Math.ceil(this.backgroundCanvas.width/e);var i=Math.ceil(this.backgroundCanvas.height/e);this.backgroundContext.fillStyle="#bbbbbb";for(var r=0;r<i;r++){for(var a=0;a<t;a++){if((a+r)%2){this.backgroundContext.fillRect(a*e,r*e,e,e)}}}},initContent:function(e){var t=this;if(g_app.isMobile()){this.previewCanvasMaxWidth=320;this.previewCanvasMaxHeight=200}var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){return}var r=i.getReferenceImageParams();this.image=i.getReferenceImage();this.x=0;this.y=0;this.brightness=0;this.contrast=0;this.saturation=0;this.hue=0;this.colorReductionMethod="dither";this.useColors="all";this.ditherMethod="FloydSteinberg";if(r!=null){this.brightness=r.brightness;this.contrast=r.contrast;this.saturation=r.saturation;this.colorReductionMethod=r.colorReductionMethod;this.useColors=r.useColors;this.ditherMethod=r.ditherMethod;this.scale=r.scale;this.x=r.x;this.y=r.y;if(typeof r.originalImage!="undefined"&&r.originalImage){this.image=r.originalImage}}$("#"+this.prefix+"refImageBrightness").val(this.brightness);$("#"+this.prefix+"refImageBrightnessValue").val(this.brightness);$("#"+this.prefix+"refImageContrast").val(this.contrast);$("#"+this.prefix+"refImageContrastValue").val(this.contrast);$("#"+this.prefix+"refImageSaturation").val(this.saturation);$("#"+this.prefix+"refImageSaturationValue").val(this.saturation);$("#"+this.prefix+"refImageColorReduction").val(this.colorReductionMethod);$("#"+this.prefix+"refImageUseColors").val(this.useColors);$("#"+this.prefix+"refImageDither").val(this.ditherMethod);$("#"+this.prefix+"refImageX").val(this.x);$("#"+this.prefix+"refImageY").val(this.y);$("#"+this.prefix+"refImageScale").val(this.scale);this.initCanvas();if(this.imageParametersEffect==null){this.imageParametersEffect=new ImageParametersEffect}this.initBackgroundCanvas();this.setColorReductionParams();this.previewContext.drawImage(this.backgroundCanvas,0,0);if(this.image){this.showImage()}},initCanvas:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){reutrn}var t=e.getTileSet();this.layerWidth=e.getGridWidth()*e.getCellWidth();this.layerHeight=e.getGridHeight()*e.getCellHeight();if(!this.canvas){this.canvas=document.createElement("canvas")}this.canvasWidth=this.layerWidth;this.canvasHeight=this.layerHeight;this.canvas.width=this.canvasWidth;this.canvas.height=this.canvasHeight;this.context=this.canvas.getContext("2d");this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;var i=this;if(!this.previewCanvas){this.previewCanvas=document.getElementById(this.prefix+"refImageCanvas");this.previewCanvas.addEventListener("touchstart",function(e){i.touchStart(e)},false);this.previewCanvas.addEventListener("touchmove",function(e){i.touchMove(e);return false},false);this.previewCanvas.addEventListener("touchend",function(e){i.touchEnd(e)},false)}this.previewScale=1;var r=this.layerWidth;var a=this.layerHeight;if(r>this.previewCanvasMaxWidth||a>this.previewCanvasMaxHeight){if(this.previewCanvasMaxWidth/this.previewCanvasMaxHeight>r/a){this.previewScale=this.previewCanvasMaxHeight/a;r=r*this.previewCanvasMaxHeight/a;a=this.previewCanvasMaxHeight}else{this.previewScale=this.previewCanvasMaxWidth/r;a=a*this.previewCanvasMaxWidth/r;r=this.previewCanvasMaxWidth}}if(this.previewCanvas.width!=r||this.previewCanvas.height!=a){this.previewCanvas.width=r;this.previewCanvas.height=a}this.previewContext=this.previewCanvas.getContext("2d")},setLayerRefImage:function(){var e=this.editor.layers.getSelectedLayerObject();if(e&&e.getType()=="grid"){e.setReferenceImage({image:this.canvas,imageData:this.canvas.toDataURL(),params:{originalImage:this.image,x:this.x,y:this.y,scale:this.scale,brightness:this.brightness,contrast:this.contrast,saturation:this.saturation,colorReductionMethod:this.colorReductionMethod,ditherMethod:this.ditherMethod,useColors:this.useColors,colors:this.colors}});this.editor.graphic.redraw({allCells:true})}},initEvents:function(){var a=this;var e=0;var t=0;var i=false;var r=0;var s=0;$("#"+this.prefix+"refLayerSourceChooseFile").on("click",function(){$("#"+a.prefix+"refLayerSourceFile").click()});$("#"+this.prefix+"refLayerClearImage").on("click",function(){a.clearImage()});$("#"+this.prefix+"refImageX").on("keyup",function(){a.showImage()});$("#"+this.prefix+"refImageY").on("keyup",function(){a.showImage()});$("#"+this.prefix+"refImageScale").on("keyup",function(){$("#"+this.prefix+"refImageScaleRange").val($(this).val());a.showImage()});$("#"+this.prefix+"refImageScaleRange").on("change",function(){var e=$(this).val();$("#"+a.prefix+"refImageScale").val($(this).val());a.showImage()});$("#"+this.prefix+"refImageScaleRange").on("input",function(){$("#"+a.prefix+"refImageScale").val($(this).val());a.showImage()});$("#"+this.prefix+"refImageRotation").on("keyup",function(){$("#"+this.prefix+"refImageScaleRotation").val($(this).val());a.showImage()});$("#"+this.prefix+"refImageRotationRange").on("change",function(){var e=$(this).val();$("#"+a.prefix+"refImageRotation").val($(this).val());a.showImage()});$("#"+this.prefix+"refImageRotationRange").on("input",function(){$("#"+a.prefix+"refImageRotation").val($(this).val());a.showImage()});$("#"+this.prefix+"refImageRotation90").on("click",function(){a.rotate90()});$("#"+this.prefix+"refImageScaleToFit").on("click",function(){a.scaleToFit()});$("#"+this.prefix+"refImageCanvas").on("wheel",function(e){a.imageMouseWheel(e.originalEvent)});$("#"+this.prefix+"refImageCanvas").on("mousedown",function(e){var t=e.offsetX;var i=e.offsetY;a.mouseDownAtX=e.clientX;a.mouseDownAtY=e.clientY;a.currentOffsetX=parseInt($("#"+a.prefix+"refImageX").val());a.currentOffsetY=parseInt($("#"+a.prefix+"refImageY").val());a.mouseIsDown=true;UI.setCursor("drag");UI.captureMouse(a)});$("#"+this.prefix+"refImageScaleDecrease").on("click",function(){var e=parseInt($("#"+a.prefix+"refImageScale").val(),10);e-=5;if(e>0){$("#"+a.prefix+"refImageScale").val(e,10)}a.showImage()});$("#"+this.prefix+"refImageCanvas").on("mouseenter",function(e){UI.setCursor("can-drag")});$("#"+this.prefix+"refImageScaleIncrease").on("click",function(){var e=parseInt($("#"+a.prefix+"refImageScale").val());e+=5;if(e>0){$("#"+a.prefix+"refImageScale").val(e,10)}a.showImage()});$("#"+this.prefix+"refImageBrightness").on("change",function(){a.brightness=$(this).val();$("#"+a.prefix+"refImageBrightnessValue").val(a.brightness);a.showImage()});$("#"+this.prefix+"refImageBrightness").on("input",function(){a.brightness=$(this).val();$("#"+a.prefix+"refImageBrightnessValue").val(a.brightness);a.showImage()});$("#"+this.prefix+"refImageBrightnessValue").on("change",function(){a.brightness=$(this).val();$("#"+a.prefix+"refImageBrightness").val(a.brightness);a.showImage()});$("#"+this.prefix+"refImageBrightnessReset").on("click",function(){a.brightness=0;$("#"+a.prefix+"refImageBrightnessValue").val(0);$("#"+a.prefix+"refImageBrightness").val(0);a.showImage()});$("#"+this.prefix+"refImageContrast").on("change",function(){a.contrast=$(this).val();$("#"+a.prefix+"refImageContrastValue").val(a.contrast);a.showImage()});$("#"+this.prefix+"refImageContrast").on("input",function(){a.contrast=$(this).val();$("#"+a.prefix+"refImageContrastValue").val(a.contrast);a.showImage()});$("#"+this.prefix+"refImageContrastValue").on("change",function(){a.contrast=$(this).val();$("#"+a.prefix+"refImageContrast").val(a.contrast);a.showImage()});$("#"+this.prefix+"refImageContrastReset").on("click",function(){a.contrast=0;$("#"+a.prefix+"refImageContrast").val(0);$("#"+a.prefix+"refImageContrastValue").val(0);a.showImage()});$("#"+this.prefix+"refImageSaturation").on("change",function(){a.saturation=$(this).val();$("#"+a.prefix+"refImageSaturationValue").val(a.saturation);a.showImage()});$("#"+this.prefix+"refImageSaturation").on("input",function(){a.saturation=$(this).val();$("#"+a.prefix+"refImageSaturationValue").val(a.saturation);a.showImage()});$("#"+this.prefix+"refImageSaturationValue").on("change",function(){a.saturation=$(this).val();$("#"+a.prefix+"refImageSaturation").val(a.saturation);a.showImage()});$("#"+this.prefix+"refImageSaturationReset").on("click",function(){a.saturation=0;$("#"+a.prefix+"refImageSaturationValue").val(0);$("#"+a.prefix+"refImageSaturation").val(0);a.showImage()});$("#"+this.prefix+"refImageColorReduction").on("change",function(){a.setColorReductionParams();a.showImage()});$("#"+this.prefix+"refImageLimitPerCell").on("click",function(){a.setColorReductionParams();a.showImage()});$("#"+this.prefix+"refImageDither").on("change",function(){a.setColorReductionParams();a.showImage()});$("#"+this.prefix+"refImageDitherThreshold").on("change",function(){a.setColorReductionParams();a.showImage()});$("#"+this.prefix+"refImageDitherThreshold").on("keyup",function(){a.setColorReductionParams();a.showImage()});$("#"+this.prefix+"refImageUseColors").on("change",function(e){a.useColors=$(this).val();if(a.useColors=="all"){$("#"+a.prefix+"refImageChooseColorsRow").hide();$("#"+a.prefix+"refImageCreatePalette").hide()}else if(a.useColors=="greyscale"){$("#"+a.prefix+"refImageChooseColorsRow").hide();$("#"+a.prefix+"refImageCreatePalette").hide()}else if(a.useColors=="choose"){$("#"+a.prefix+"refImageChooseColorsRow").show();$("#"+a.prefix+"refImageCreatePalette").hide();$("#mobile_refImageUseColorsRow").css("border-bottom","0");a.chooseColors()}else{$("#"+a.prefix+"refImageChooseColorsRow").hide();$("#"+a.prefix+"refImageCreatePalette").hide()}a.showImage()});$("#"+this.prefix+"refImageChooseColors").on("click",function(){a.chooseColors()});document.getElementById(this.prefix+"refLayerSourceFile").addEventListener("change",function(e){var t=document.getElementById(a.prefix+"refLayerSourceFile").files[0];a.chooseImage(t)});$("#layerProperties-backgroundColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.setBackgroundColor(e)};t.hasNone=true;var i=e.pageX;var r=e.pageY;t.currentColor=a.backgroundColor;a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("#layerProperties-borderColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.setBorderColor(e)};t.hasNone=true;var i=e.pageX;var r=e.pageY;t.currentColor=a.borderColor;a.editor.colorPaletteManager.showColorPicker(i,r,t)})},chooseColors:function(){var a=this;var t=function(e){a.customColorSet=[];var t=e.length;for(var i=0;i<t;i++){a.customColorSet.push(e[i])}var r=t;r+=" Colour";if(t!=1){r+="s"}r+=" Chosen";$("#"+a.prefix+"refImageChooseColorsCount").html(r);a.showImage()};if(g_app.isMobile()){if(this.colorPickerMobile==null){var a=this;this.colorPickerMobile=new ColorPickerMobile;this.colorPickerMobile.init(this.editor,{canSelectMultiple:true,id:"RefPicker"});this.colorPickerMobile.on("close",function(){var e=a.colorPickerMobile.getSelectedColors();t(e)})}if(typeof this.customColorSet=="undefined"){this.customColorSet=[]}this.colorPickerMobile.show({colors:this.customColorSet})}else{this.editor.chooseColorsDialog.show({callback:t})}},setColorReductionParams:function(){this.useColors=$("#"+this.prefix+"refImageUseColors").val();this.colorReductionMethod=$("#"+this.prefix+"refImageColorReduction").val();if(this.colorReductionMethod=="dither"){$("#"+this.prefix+"refImageDitherGroup").show()}else{$("#"+this.prefix+"refImageDitherGroup").hide()}if(this.colorReductionMethod=="edge"){$("#"+this.prefix+"refImageEdgeDetectionGroup").show()}else{$("#"+this.prefix+"refImageEdgeDetectionGroup").hide()}this.ditherMethod=$("#"+this.prefix+"refImageDither").val();this.limitColorsPerCell=$("#"+this.prefix+"refImageLimitPerCell").is(":checked");if(this.colorReductionMethod=="none"){$("#"+this.prefix+"refImageUseColorsRow").hide()}else{$("#"+this.prefix+"refImageUseColorsRow").show()}},setColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();if(this.useColors=="choose"&&typeof this.customColorSet!="undefined"){this.colors=[];for(var t=0;t<this.customColorSet.length;t++){this.colors.push(this.customColorSet[t])}}else if(this.useColors=="greyscale"){this.colors=[];for(var t=0;t<e.getColorCount();t++){if(e.getIsGrey(t)){this.colors.push(t)}}}else{this.colors=[];for(var t=0;t<e.getColorCount();t++){this.colors.push(t)}}},chooseImage:function(e){var t=this;var i=new Image;i.onload=function(){t.image=i;t.scaleToFit();t.showImage()};if(this.prefix=="mobile_"){$("#mobile_refImageControlsContainer").show()}var r=window.URL||window.webkitURL;var a=r.createObjectURL(e);i.src=a},scaleToFit:function(){var e=0;var t=0;var i=1;var e=this.image.naturalWidth;var t=this.image.naturalHeight;if(e>this.canvasWidth){i=this.canvasWidth/this.image.naturalWidth}if(t>this.canvasHeight){i=this.canvasHeight/this.image.naturalHeight}if(e<this.canvasWidth&&i==1){i=this.canvasWidth/this.image.naturalWidth}if(t<this.canvasHeight&&i==1){i=this.canvasHeight/this.image.naturalHeight}var r=(this.canvasWidth-e)/2;$("#"+this.prefix+"refImageX").val(r);var a=(this.canvasHeight-t)/2;$("#"+this.prefix+"refImageY").val(a);i=i*100;$("#"+this.prefix+"refImageScale").val(i);this.showImage()},clearImage:function(){this.image=null;this.showImage()},rotate90:function(){this.rotation=parseInt($("#"+this.prefix+"refImageRotation").val());if(isNaN(this.rotation)){this.rotation=0}this.rotation=(this.rotation+90)%360;$("#"+this.prefix+"refImageRotation").val(this.rotation);this.showImage()},showImage:function(e){var t=true;var i=false;if(typeof e!="undefined"){if(typeof e.drawBackground!="undefined"){t=e.drawBackground}if(typeof e.ignoreColorReduction!="undefined"){i=e.ignoreColorReduction}}this.setColorReductionParams();var r=this.editor.colorPaletteManager.getCurrentColorPalette();this.crosshairX=this.canvas.width/2;this.crosshairY=this.canvas.height/2;this.scale=parseInt($("#"+this.prefix+"refImageScale").val());this.rotation=parseInt($("#"+this.prefix+"refImageRotation").val());if(isNaN(this.rotation)){this.rotation=0}this.x=parseInt($("#"+this.prefix+"refImageX").val());this.y=parseInt($("#"+this.prefix+"refImageY").val());var r=this.editor.colorPaletteManager.getCurrentColorPalette();if(t){this.previewContext.drawImage(this.backgroundCanvas,0,0)}else{this.previewContext.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height)}this.context.clearRect(0,0,this.canvas.width,this.canvas.height);if(this.image){this.context.save();this.context.translate(this.crosshairX,this.crosshairY);this.context.scale(this.scale/100,this.scale/100);this.context.rotate(this.rotation*Math.PI*2/360);var a=this.x-this.crosshairX;var s=this.y-this.crosshairY;var o=this.image.naturalWidth;var l=this.image.naturalHeight;var n=a;var h=s;this.context.drawImage(this.image,n,h,o,l);this.context.translate(-this.crosshairX,-this.crosshairY);this.context.restore();this.imageParametersEffect.setParameters({brightness:this.brightness});this.imageParametersEffect.setParameters({contrast:this.contrast});this.imageParametersEffect.setParameters({saturation:this.saturation});this.imageParametersEffect.setSource(this.canvas);this.imageParametersEffect.setDestination(this.canvas);this.imageParametersEffect.update();if(!i&&(this.colorReductionMethod=="closest"||this.colorReductionMethod=="dither")){this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);this.setColors();var d=[];for(var c=0;c<this.colors.length;c++){d.push(r.getRGBA(this.colors[c]))}this.imageLib.palette=d;this.imageLib.setImageData(this.imageData);if(this.colorReductionMethod=="dither"){this.imageData=this.imageLib.reduceDither({kernel:this.ditherMethod})}else{this.imageData=this.imageLib.reduceNearest()}if(this.limitColorsPerCell){this.imageLib.setImageData(this.imageData);this.imageData=this.imageLib.reducePerCell();this.context.putImageData(this.imageData,0,0,0,0,this.canvas.width,this.canvas.height)}else{this.context.putImageData(this.imageData,0,0,0,0,this.canvas.width,this.canvas.height)}}this.previewContext.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.previewCanvas.width,this.previewCanvas.height)}},imageMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);this.scale=parseInt($("#"+this.prefix+"refImageScale").val());var i=this.scale-t.spinY*8;this.scale=i;$("#"+this.prefix+"refImageScale").val(this.scale);this.showImage()},mouseDown:function(e){},mouseMove:function(e){if(this.mouseIsDown){var t=this.scale;var i=e.clientX;var r=e.clientY;var a=i-this.mouseDownAtX;var s=r-this.mouseDownAtY;a=a*100/t;s=s*100/t;var o=this.currentOffsetX+a;$("#"+this.prefix+"refImageX").val(o);var l=this.currentOffsetY+s;$("#"+this.prefix+"refImageY").val(l);this.showImage()}},mouseUp:function(e){this.mouseIsDown=false},setScale:function(e,t){e=parseFloat(e);if(isNaN(e)){return}this.scale=e;$("#"+this.prefix+"refImageScale").val(this.scale);$("#"+this.prefix+"refImageScaleRange").val(this.scale);if(typeof t=="undefined"||t){this.showImage()}},touchStart:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1){this.touchCount=1;var s=t[0].pageX-r;var o=t[0].pageY-a;this.mouseDownAtX=s;this.mouseDownAtY=o;this.currentOffsetX=parseFloat($("#"+this.prefix+"refImageX").val());this.currentOffsetY=parseFloat($("#"+this.prefix+"refImageY").val());this.mouseIsDown=true}if(t.length==2){this.touchCount=2;this.touchStart0X=t[0].pageX-r;this.touchStart0Y=t[0].pageY-a;this.touchStart1X=t[1].pageX-r;this.touchStart1Y=t[1].pageY-a;this.touchStartDistance=(this.touchStart0X-this.touchStart1X)*(this.touchStart0X-this.touchStart1X)+(this.touchStart0Y-this.touchStart1Y)*(this.touchStart0Y-this.touchStart1Y);this.touchStartDistance=Math.sqrt(this.touchStartDistance);this.touchStartMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchStartMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.touchMoveMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchMoveMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.pinchStartScale=this.scale}this.colorReductionMethod="none"},touchMove:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1&&this.touchCount==1){var s=t[0].pageX-r;var o=t[0].pageY-a;var l=this.scale;var n=s-this.mouseDownAtX;var h=o-this.mouseDownAtY;n=n*100/l/this.previewScale;h=h*100/l/this.previewScale;if(n>2||h>2){this.movingImage=true}var d=Math.cos(this.rotation*Math.PI/180)*n+Math.sin(this.rotation*Math.PI/180)*h;var c=Math.cos(this.rotation*Math.PI/180)*h-Math.sin(this.rotation*Math.PI/180)*n;var f=this.currentOffsetX+d;$("#"+this.prefix+"refImageX").val(f);var u=this.currentOffsetY+c;$("#"+this.prefix+"refImageY").val(u);this.showImage({ignoreColorReduction:true})}if(t.length==2){this.touchMove0X=t[0].pageX-r;this.touchMove0Y=t[0].pageY-a;this.touchMove1X=t[1].pageX-r;this.touchMove1Y=t[1].pageY-a;this.touchMoveDistance=(this.touchMove0X-this.touchMove1X)*(this.touchMove0X-this.touchMove1X)+(this.touchMove0Y-this.touchMove1Y)*(this.touchMove0Y-this.touchMove1Y);this.touchMoveDistance=Math.sqrt(this.touchMoveDistance);var p=this.touchMoveMidX;var v=this.touchMoveMidY;var g=(this.touchMove0X+this.touchMove1X)/2;var m=(this.touchMove0Y+this.touchMove1Y)/2;this.touchMoveMidX=g;this.touchMoveMidY=m;var y=this.touchMoveDistance/this.touchStartDistance*this.pinchStartScale;this.setScale(y,false);var l=this.scale;this.showImage({ignoreColorReduction:true})}},touchEnd:function(e){var t=$("#importImageColorReductionMobile").val();this.showImage()}};var LayersMerge=function(){this.editor=null;this.uiComponent=null};LayersMerge.prototype={init:function(e){this.editor=e},initContent:function(){},initEvents:function(){},show:function(){var i=this;if(this.uiComponent==null){var e='<div class="formGroup">';e+='<label class="controlLabel">Merge:</label>';e+='<div class="checkboxGroup">';e+='<label class="rb-container">All<input type="radio" name="layersMergeLayers" value="all" checked="checked"><span class="checkmark"></span> </label>';e+='&nbsp;&nbsp;<label class="rb-container">Visible<input type="radio" name="layersMergeLayers" value="all"> <span class="checkmark"></span></label>';e+="</div>";e+="</div>";this.uiComponent=UI.create("UI.Dialog",{id:"layerMergeDialog",title:"Merge Layers",width:200,height:100});this.htmlComponent=UI.create("UI.HTMLPanel",{html:e});this.uiComponent.add(this.htmlComponent);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){var t="visible";i.editor.layers.mergeLayers(t);UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.initContent();this.initEvents()}UI.showDialog("layerMergeDialog")}};var LayersFrames=function(){this.editor=null};LayersFrames.prototype={init:function(e){this.editor=e},initContent:function(){},initEvents:function(){},showFramesToLayers:function(){var e=this;if(this.framesToLayersComponent==null){var t='<div class="formGroup">';t+='<label class="controlLabel">Frames To Layers:</label>';t+='<div class="checkboxGroup">';t+='<label class="rb-container"> All<input type="radio" name="layersMergeLayers" value="all" checked="checked"><span class="checkmark"></span></label>';t+='<label class="rb-container"> Visible<input type="radio" name="layersMergeLayers" value="all"><span class="checkmark"></span></label>';t+="</div>";t+="</div>";this.framesToLayersComponent=UI.create("UI.Dialog",{id:"framesToLayersComponent",title:"Frames To Layers",width:200,height:100});this.htmlComponent=UI.create("UI.HTMLPanel",{html:t});this.framesToLayersComponent.add(this.htmlComponent);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.framesToLayersComponent.addButton(this.okButton);this.okButton.on("click",function(e){UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.framesToLayersComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}UI.showDialog("framesToLayersComponent")},showLayersToFrames:function(){var i=this;if(this.layersToFramesComponent==null){var e='<div class="formGroup">';e+='<label class="controlLabel">Frames To Layers:</label>';e+='<div class="checkboxGroup">';e+='<label class="rb-container">All<input type="radio" name="layersToFramesLayers" value="all"> <span class="checkmark"></span></label>';e+="&nbsp;";e+='<label class="rb-container">Visible<input type="radio" name="layersToFramesLayers" value="visible" checked="checked"><span class="checkmark"></span> </label>';e+="</div>";e+="</div>";this.layersToFramesComponent=UI.create("UI.Dialog",{id:"layersToFramesDialog",title:"Layers To Frames",width:220,height:110});this.htmlComponent=UI.create("UI.HTMLPanel",{html:e});this.layersToFramesComponent.add(this.htmlComponent);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.layersToFramesComponent.addButton(this.okButton);this.okButton.on("click",function(e){var t=$("input[name=layersToFramesLayers]:checked").val();i.editor.layers.layersToFrames(t);UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.layersToFramesComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}UI.showDialog("layersToFramesDialog")}};var BackgroundImage=function(){this.editor=null;this.scale=1;this.canvas=null;this.context=null;this.bgImage=null;this.x=0;this.y=0;this.drawWidth=0;this.drawHeight=0};BackgroundImage.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"backgroundImageDialog",title:"Background Image",width:640});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/backgroundImage.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.setBackgroundImage();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("backgroundImageDialog")},initContent:function(){console.log("setup canvas!!!");var e=this.editor.tileSetManager.getCurrentTileSet();if(!this.canvas){this.canvas=document.getElementById("bgImageCanvas")}this.canvas.width=e.charWidth*this.editor.grid.width;this.canvas.height=e.charHeight*this.editor.grid.height;this.context=this.canvas.getContext("2d");this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;if(this.bgImage){this.showImage()}},initEvents:function(){var l=this;var n=0;var h=0;var d=false;var c=0;var f=0;$("#bgImageX").on("keyup",function(){l.showImage()});$("#bgImageY").on("keyup",function(){l.showImage()});$("#bgImageScale").on("keyup",function(){l.showImage()});$("#bgImageCanvas").on("mousedown",function(e){n=e.clientX;h=e.clientY;c=parseInt($("#bgImageX").val());f=parseInt($("#bgImageY").val());d=true});$("#bgImageCanvas").on("mousemove",function(e){if(d){var t=e.clientX;var i=e.clientY;var r=t-n;var a=i-h;var s=c+r;$("#bgImageX").val(s);var o=f+a;$("#bgImageY").val(o);l.showImage()}});$("#bgImageCanvas").on("mouseup",function(e){d=false});$("#bgImageScaleDecrease").on("click",function(){var e=parseInt($("#bgImageScale").val());e-=5;if(e>0){$("#bgImageScale").val(e)}l.showImage()});$("#bgImageScaleIncrease").on("click",function(){var e=parseInt($("#bgImageScale").val());e+=5;if(e>0){$("#bgImageScale").val(e)}l.showImage()});document.getElementById("bgImageSourceFile").addEventListener("change",function(e){var t=document.getElementById("bgImageSourceFile").files[0];l.chooseImage(t)})},setBackgroundImage:function(){this.editor.grid.setBackgroundImage(this.bgImage,this.x,this.y,this.drawWidth,this.drawHeight)},chooseImage:function(e){if(!this.bgImage){this.bgImage=new Image}var t=window.URL||window.webkitURL;var i=t.createObjectURL(e);this.bgImage.src=i;var r=this;this.bgImage.onload=function(){r.showImage()}},showImage:function(){var e=this.bgImage.naturalWidth;var t=this.bgImage.naturalHeight;var i=100;if(e>320){i=320/this.bgImage.naturalWidth;e=this.bgImage.naturalWidth*i;t=this.bgImage.naturalHeight*i}if(t>200){i=200/this.bgImage.naturalHeight;e=this.bgImage.naturalWidth*i;t=this.bgImage.naturalHeight*i}i=parseInt($("#bgImageScale").val());e=e*i/100;t=t*i/100;this.x=parseInt($("#bgImageX").val());this.y=parseInt($("#bgImageY").val());this.drawWidth=e;this.drawHeight=t;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.drawImage(this.bgImage,this.x,this.y,this.drawWidth,this.drawHeight)}};var CurrentTile=function(){this.camera=null;this.scene=null;this.type="";this.scale=1;this.character=false;this.characters=[];this.characterSelected=[];this.blockId=false;this.color=1;this.bgColor=false;this.rotX=0;this.rotY=0;this.rotZ=0;this.canvas=null;this.context=null;this.tilePaletteCanvas=null;this.tilePaletteContext=null;this.tileSettingsTileCanvas=null;this.tileSettingsTileContext=null;this.cursorCanvas=null;this.cursorContext=null;this.recentCharacters=[];this.recentColors=[];this.characterMesh=null;this.tileMaterial=null;this.tileBGMaterial=null;this.tilePaletteChooserMobile=null;this.useCells=false;this.flipH=false;this.flipV=false;this.mobileCanvasEventsInit=false;this.desktopCanvasEventsInit=false;this.tileMaterialsCanvas=null;this.tileMaterials=null;this.cursorImageData=null;this.backgroundColor3d=new THREE.Color(.1,.1,.1)};CurrentTile.prototype={init:function(e){this.editor=e;this.init3d()},init3d:function(){this.noBGMaterial=new THREE.MeshBasicMaterial({transparent:true,opacity:0});this.tileBGMaterial=new THREE.MeshPhongMaterial({color:16777215});this.scene=new THREE.Scene;var e=150;var t=150;var i=55;this.camera=new THREE.PerspectiveCamera(i,e/t,1,1e4);this.camera.position.x=1;this.camera.position.y=1;this.camera.position.z=4;this.axisHelper=new THREE.AxesHelper(1500);this.scene.add(this.axisHelper);var r=new THREE.DirectionalLight(16777215,1);r.position.set(1e3,1e3,1500);r.target.position.set(0,0,0);this.scene.add(r);var a=new THREE.AmbientLight(10066329);this.scene.add(a)},initRotationToolEvents:function(){var e=this;$("#currentTileRotateLeft").on("click",function(){e.rotate("left")});$("#currentTileRotateRight").on("click",function(){e.rotate("right")});$("#currentTileRotateUp").on("click",function(){e.rotate("up")});$("#currentTileRotateDown").on("click",function(){e.rotate("down")});$("#currentTileRotateClockwise").on("click",function(){e.rotate("clockwise")});$("#currentTileRotateAntiClockwise").on("click",function(){e.rotate("anticlockwise")});$("#currentTileRotateReset").on("click",function(){e.rotateReset()})},initOrientationToolEvents:function(){var e=this;$("#currentTileOrientation2dReset").on("click",function(){e.resetOrientation2d()});$("#currentTileOrientation2dFlipH").on("click",function(){e.flipH2d()});$("#currentTileOrientation2dFlipV").on("click",function(){e.flipV2d()});$("#currentTileOrientation2dRotate").on("click",function(){e.rotate2d()})},update2dOrientationInfo:function(){var e=this.rotZ*90;$("#currentTileRotate").html(e);$(".tile-rotation-amount").html(e);var t="N";if(this.flipH){t="Y"}$("#currentTileFlipH").html(t);$(".tile-flipped-x").html(t);var i="N";if(this.flipV){i="Y"}$("#currentTileFlipV").html(i);$(".tile-flipped-y").html(i)},setTileMaterialsVisible:function(e){if(e){$("#tileMaterialControls").show()}else{$("#tileMaterialControls").hide()}if(this.editor.sideTilePalette){this.editor.sideTilePalette.setMaterialsVisible(e)}},setSouthPanelSize:function(){if(g_app.getMode()=="3d"){UI("currentTileSplitPanel").setPanelVisible("south",true);UI("currentTileSplitPanel").resizeThePanel({panel:"south",size:56});UI("tileControlsSplitPanel").setPanelVisible("north",true);UI("tileControlsSplitPanel").resizeThePanel({panel:"north",size:56});this.setTileMaterialsVisible(false);$("#charRotationTools3d").show();$("#charOrientationTools2d").hide()}else{var e=this.editor.graphic.getHasTileFlip();var t=this.editor.graphic.getHasTileRotate();var i=e||t;var r=this.editor.graphic.getHasTileMaterials();$("#charRotationTools3d").hide();$("#charOrientationTools2d").show();if(!i&&!r){UI("currentTileSplitPanel").setPanelVisible("south",false);this.setTileMaterialsVisible(false)}else{UI("currentTileSplitPanel").setPanelVisible("south",true);if(i&&!r){UI("currentTileSplitPanel").resizeThePanel({panel:"south",size:56});UI("tileControlsSplitPanel").setPanelVisible("north",true);UI("tileControlsSplitPanel").resizeThePanel({panel:"north",size:56});this.setTileMaterialsVisible(false);$("#charRotationTools3d").hide();$("#charOrientationTools2d").show()}else if(!i&&r){UI("currentTileSplitPanel").resizeThePanel({panel:"south",size:60});this.setTileMaterialsVisible(true);UI("tileControlsSplitPanel").setPanelVisible("north",false)}else{UI("currentTileSplitPanel").resizeThePanel({panel:"south",size:116});this.setTileMaterialsVisible(true);UI("tileControlsSplitPanel").setPanelVisible("north",true);UI("tileControlsSplitPanel").resizeThePanel({panel:"north",size:56})}}if(i){$("#drawToolSettings-tileOrientation").show();if(e){$("#currentTileFlipHolder").show();$("#tileFlipH").show();$("#tileFlipV").show();$(".tile-fliph").show();$(".tile-flipv").show()}else{$("#currentTileFlipHolder").hide();$("#tileFlipH").hide();$("#tileFlipV").hide();$(".tile-fliph").hide();$(".tile-flipv").hide()}if(t){$("#currentTileRotateHolder").show();$("#tileRotate").show();$(".tile-rotation").show()}else{$("#currentTileRotateHolder").hide();$("#tileRotate").hide();$(".tile-rotation").hide()}}else{$("#drawToolSettings-tileOrientation").hide();$(".tile-rotation").hide();$(".tile-fliph").hide();$(".tile-flipv").hide()}}},setMaterialsVisibility:function(){this.setSouthPanelSize()},setOrientationToolsVisibility:function(){var e=this.editor.graphic.getHasTileFlip();var t=this.editor.graphic.getHasTileRotate();if(e||t){$("#charOrientationTools2d").show();if(e){$("#tileOrientationFlipControls").show()}else{$("#tileOrientationFlipControls").hide()}if(t){$("#tileOrientationRotateControls").show()}else{$("#tileOrientationRotateControls").hide()}}else{$("#charOrientationTools2d").hide()}this.setSouthPanelSize()},flipH2d:function(){this.flipH=!this.flipH;this.canvasDrawCharacters();this.update2dOrientationInfo();if(this.editor.sideTilePalette){this.editor.sideTilePalette.drawTilePalette({redrawTiles:true})}if(this.editor.tools.drawTools.tilePalette){this.editor.tools.drawTools.tilePalette.drawTilePalette({redrawTiles:true})}},flipV2d:function(){this.flipV=!this.flipV;this.canvasDrawCharacters();this.update2dOrientationInfo();if(this.editor.sideTilePalette){this.editor.sideTilePalette.drawTilePalette({redrawTiles:true})}if(this.editor.tools.drawTools.tilePalette){this.editor.tools.drawTools.tilePalette.drawTilePalette({redrawTiles:true})}},rotate2d:function(){this.rotZ=Math.floor(this.rotZ+1)%4;this.canvasDrawCharacters();this.update2dOrientationInfo();if(this.editor.sideTilePalette){this.editor.sideTilePalette.drawTilePalette({redrawTiles:true})}if(this.editor.tools.drawTools.tilePalette){this.editor.tools.drawTools.tilePalette.drawTilePalette({redrawTiles:true})}},resetOrientation2d:function(){this.flipH=false;this.flipV=false;this.rotZ=0;this.canvasDrawCharacters();this.update2dOrientationInfo()},buildInterface:function(e){var a=this;var t=UI.create("UI.SplitPanel",{id:"currentTileSplitPanel"});e.add(t);this.holderPanel=UI.create("UI.Panel");t.add(this.holderPanel);this.holderPanel.on("mousemove",function(e){UI.setCursor("default")});this.canvasPanel=UI.create("UI.CanvasPanel",{id:"currentTileCanvasPanel"});this.canvasPanel.on("contextmenu",function(e){e.preventDefault()});this.canvasPanel.on("resize",function(e,t,i,r){a.resize(e,t,i,r);a.refresh()});UI.on("ready",function(){a.initEvents();a.resize()});this.holderPanel.add(this.canvasPanel);var i=UI.create("UI.WebGLPanel",{id:"currentTileWebGLPanel"});i.on("render",function(e,t,i,r){a.render(e,t,i,r)});this.holderPanel.add(i);var r=80;var s=UI.create("UI.SplitPanel",{id:"tileControlsSplitPanel"});t.addSouth(s,r,false);this.tileMaterials=new TileMaterials;this.tileMaterials.init(this.editor,"currentTile");this.tileMaterials.buildInterface(s);var o=UI.create("UI.HTMLPanel");o.on("loaded",function(){a.initRotationToolEvents();a.initOrientationToolEvents()});var l=24;s.addNorth(o,l,false);UI.on("ready",function(){o.load("html/textMode/charRotationTools.html")})},initEvents:function(){var e=this},setMaterial:function(e){var t=this.editor.tileSetManager.getCurrentTileSet();if(this.useCells){for(var i=0;i<this.cells.length;i++){for(var r=0;r<this.cells[i].length;r++){var a=this.cells[i][r].t;if(a!=this.editor.tileSetManager.noTile){t.setTileMaterial(a,e)}}}}else{for(var i=0;i<this.characters.length;i++){for(var r=0;r<this.characters[i].length;r++){var a=this.characters[i][r];if(a!=this.editor.tileSetManager.noTile){t.setTileMaterial(a,e)}}}}this.drawTileMaterials()},drawTileMaterials:function(){this.tileMaterials.drawTileMaterials();if(this.editor.sideTilePalette){this.editor.sideTilePalette.tileMaterials.drawTileMaterials()}},chooseCharacterMobile:function(){if(this.tilePaletteChooserMobile==null){this.tilePaletteChooserMobile=new TilePaletteChooserMobile;this.tilePaletteChooserMobile.init(this.editor)}var e=0;if(this.characters.length>0&&this.characters[0].length>0){e=this.characters[0][0]}this.tilePaletteChooserMobile.show({character:e})},characterClick:function(e){},characterDoubleClick:function(e){this.editor.tileEditor.toggleVisible()},getRx:function(){return this.rotX},getRy:function(){return this.rotY},getRz:function(){return this.rotZ},getCharacters:function(){return this.characters},getTiles:function(){return this.characters},getColor:function(){return this.color},switchColors:function(){var e=this.color;var t=this.bgColor;if(t==this.editor.colorPaletteManager.noColor){var i=this.editor.layers.getSelectedLayerObject();if(i&&i.getType()=="grid"){var t=i.getBackgroundColor()}}if(t!=this.editor.colorPaletteManager.noColor){this.setColor(t)}this.setBGColor(e)},setColor:function(e,t){var i=false;var r=true;this.useCells=false;if(typeof t!="undefined"){if(typeof t.force!="undefined"){i=t.force}if(typeof t.update!="undefined"){r=t.update}}if(e===this.color&&!i){return}var a=this.editor.colorPaletteManager.getCurrentColorPalette();if(!a){return}this.color=e;if(this.characterMesh){this.characterMesh.material=a.getMaterial(this.color)}if(this.type=="2d"){this.canvasDrawCharacter()}this.editor.grid.setCursorColor(this.color);var s=g_app.doc.getDocRecord("/settings");s.data.currentFGColor=e;if(this.editor.getColorPerMode()=="character"){var o=this.editor.tileSetManager.getCurrentTileSet();for(var l=0;l<this.characters.length;l++){for(var n=0;n<this.characters[l].length;n++){o.setTileColor(this.characters[l][n],e)}}if(this.editor.tools.drawTools.tool=="block"&&this.editor.tools.drawTools.blockPalette!=null){this.editor.tools.drawTools.blockPalette.drawBlockPalette();if(this.editor.sideBlockPalette){this.editor.sideBlockPalette.drawBlockPalette()}}}if(this.editor.getColorPerMode()=="block"){if(this.editor.tools.drawTools.tool=="block"){var h=this.editor.tools.drawTools.blockPalette.getSelectedBlockId();if(h!==false){var d=this.editor.blockSetManager.getCurrentBlockSet();d.setBlockColor(h,e)}this.editor.tools.drawTools.blockPalette.drawBlockPalette();this.editor.sideBlockPalette.drawBlockPalette()}}if(this.editor.graphic.type=="sprite"){var c=this.editor.layers.getSelectedLayerObject();if(c&&c.getType()=="grid"){c.setSpriteColor(e);this.editor.graphic.redraw({allCells:true})}}if(r){this.editor.colorsUpdated()}var f=e;if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR&&f>=8&&this.editor.graphic.getType()!=="sprite"){f-=8}if(this.editor.getScreenMode()===TextModeEditor.Mode.INDEXED||this.editor.getScreenMode()===TextModeEditor.Mode.RGB){this.editor.tools.drawTools.pixelDraw.setColor(e);this.editor.tileEditor.selectColorIndex(e)}if(this.editor.colorEditor){this.editor.colorEditor.setColor(e)}if(g_app.getMode()=="3d"){this.editor.grid3d.setCursorColor(e)}this.editor.info.setFGColor(e);this.editor.colorPalettePanel.setSelectedColor(0,e);var u=a.getHexString(f);$(".foregroundColor").css("background-color","#"+u);$(".foregroundColorMobile").css("background-color","#"+u);$(".foregroundColorDisplay").css("background-color","#"+u)},setScreenMode:function(e){this.screenMode=e},getBGColor:function(){return this.bgColor},setBGColor:function(e,t){if(e===false){e=this.editor.colorPaletteManager.noColor}var i=false;var r=true;if(typeof t!="undefined"){if(typeof t.force!="undefined"){i=t.force}if(typeof t.update!="undefined"){r=t.update}}if(this.bgColor===e&&!i){return}if(this.editor.getScreenMode()==TextModeEditor.Mode.C64STANDARD){this.bgColor=this.editor.colorPaletteManager.noColor;return}var a=this.editor.colorPaletteManager.getCurrentColorPalette();this.bgColor=e;if(this.type=="2d"){this.canvasDrawCharacter()}if(this.characterMesh){if(this.bgColor!==this.editor.colorPaletteManager.noColor){this.tileBGMaterial.color.set(a.getHex(this.bgColor));this.characterBGMesh.material=this.tileBGMaterial}else{this.characterBGMesh.material=this.noBGMaterial}}var s=e;if(this.editor.getScreenMode()==TextModeEditor.Mode.C64ECM){s=this.editor.getC64ECMColor(e);if(s===this.editor.colorPaletteManager.noColor){s=0}if(e!==this.editor.colorPaletteManager.noColor){var o=this.getTiles();for(var l=0;l<o.length;l++){for(var n=0;n<o[l].length;n++){var h=Math.floor(o[l][n]/256);o[l][n]=o[l][n]%256%64+h*256+e*64}}this.editor.setSelectedTiles(o)}}this.editor.info.setBGColor(e);this.editor.colorPalettePanel.setSelectedColor(1,s);var d=g_app.doc.getDocRecord("/settings");d.data.currentBGColor=e;this.editor.grid.setCursorBGColor(this.bgColor);if(s!==this.editor.colorPaletteManager.noColor){$(".cellBackgroundColor").html("");$(".cellBackgroundColor").css("background-color","#"+a.getHexString(s));$(".cellBackgroundColor").css("background-image","none");$(".cellBackgroundColorMobile").html("");$(".cellBackgroundColorMobile").css("background-color","#"+a.getHexString(s));$(".cellBackgroundColorMobile").css("background-image","none")}else{$(".cellBackgroundColor").css("background-color","#000000");$(".cellBackgroundColor").html('<i style="margin-left: 1px" class="halflings halflings-remove"></i>');$(".cellBackgroundColorMobile").css("background-color","#000000");$(".cellBackgroundColorMobile").html('<i style="font-size: 32px; margin-top: 1px" class="halflings halflings-remove"></i>')}if(this.editor.getColorPerMode()=="character"){var c=this.editor.tileSetManager.getCurrentTileSet();var f=c.getTileCount();for(var l=0;l<this.characters.length;l++){for(var n=0;n<this.characters[l].length;n++){var u=this.characters[l][n];if(u<f){c.setCharacterBGColor(u,e)}}}}if(r){this.editor.colorsUpdated()}},getBlock:function(){return this.blockId},setBlock:function(e){this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var t=this.blockSet.getBlockData(e);if(t.length==0){this.blockId=false;return}var i=[];for(var r=0;r<t.data.length;r++){i[r]=[];for(var a=0;a<t.data[r].length;a++){i[r][a]=t.data[r][a].t}}this.setCharacters(i);if(t.colorMode=="none"){var i=[];for(var r=0;r<t.data.length;r++){i[r]=[];for(var a=0;a<t.data[r].length;a++){i[r][a]=t.data[r][a].t}}this.setCharacters(i);this.useCells=false}else{this.setCells(t.data);this.useCells=true}var s=this.editor.layers.getSelectedLayerObject();if(s){var o=s.getColorPerMode();if(o=="block"){var l=t.fc;this.setColor(l,{update:false})}}this.blockId=e},setCells:function(e){this.useCells=true;this.cells=[];for(var t=0;t<e.length;t++){this.cells[t]=[];for(var i=0;i<e[t].length;i++){this.cells[t][i]={};for(var r in e[t][i]){if(e[t][i].hasOwnProperty(r)){this.cells[t][i][r]=e[t][i][r]}}}}this.canvasDrawCharacter();this.drawTileMaterials()},setToFirstBlankTile:function(){var e=this.editor.tileSetManager.getCurrentTileSet();if(!e){return}var t=e.getTileCount();if(t==0){return}for(var i=0;i<t;i++){if(!e.isBlank(i)){this.setTiles([[i]]);return}}this.setTiles([[0]])},setCharacters:function(e){this.setTiles(e)},setTiles:function(e){if(typeof e=="undefined"||e.length==0||e[0].length==0){return}this.useCells=false;var t=false;this.blockId=false;if(e.length!=this.characters.length){t=true}if(!t){for(var i=0;i<e.length;i++){if(e[i].length!=this.characters[i].length){t=true}if(!t){for(var r=0;r<e[i].length;r++){if(e[i][r]!=this.characters[i][r]){t=true;r=e[i].length;i=e.length;break}}}}}if(!t){return}var a=this.editor.tileSetManager;var s=a.getTileCount();this.characterSelected=[];for(var o=0;o<s;o++){this.characterSelected[o]=false}this.characters=[];for(var i=0;i<e.length;i++){this.characters.push([]);for(var r=0;r<e[i].length;r++){this.characterSelected[e[i][r]]=true;this.characters[i].push(e[i][r])}}if(this.editor.tileEditor){this.editor.tileEditor.setCharacters(e)}this.canvasDrawCharacters();if(this.type==="3d"){this.setCharacter3d(e)}if(e.length>0&&e[0].length>0){this.character3d=e[0][0]}this.editor.info.setCharacter(this.editor.currentTile.getCharacters());var l=g_app.doc.getDocRecord("/settings");l.data.currentTile=e[0][0];var n=this.editor.getColorPerMode();if(n=="character"){if(e.length==1&&e[0].length==1){var h=this.editor.tileSetManager.getCurrentTileSet();var d=h.getTileColor(e[0][0]);var c=h.getCharacterBGColor(e[0][0]);this.setColor(d,{update:false});if(this.editor.getScreenMode()!=TextModeEditor.Mode.C64ECM){this.setBGColor(c,{update:false})}}}if(this.editor.getScreenMode()==TextModeEditor.Mode.C64ECM){var c=Math.floor(e[0][0]/64)%4;this.setBGColor(c,{update:false})}this.editor.tilesUpdated();this.setMobileCharacterInfo();this.update2dOrientationInfo();this.drawTileMaterials()},setMobileCharacterInfo:function(){if(this.characters.length==0||this.characters[0].length==0){return}var e="";var t=this.characters[0][0];if(typeof t=="undefined"){return}e=t;var i=("00"+t.toString(16)).substr(-2);e+=" (0x"+i+")";$("#toolsMobileCurrentTileInfo").html(e)},isCharacterSelected:function(e){return this.characterSelected[e]},setCharacter:function(e){this.useCells=false;this.blockId=false;if(this.character===e){return}if(this.type==="3d"){}this.character=e;this.setCharacters([[e]]);if(this.editor.tileEditor){this.editor.tileEditor.setCharacters([[e]])}this.editor.grid.setCursorCharacter(e)},addToRecentCharacters:function(){if(typeof this.characters=="undefined"||this.characters.length==0){return}var e=this.characters[0][0];var t=false;for(var i=0;i<this.recentCharacters.length;i++){if(this.recentCharacters[i]==e){t=true;break}}if(!t){this.recentCharacters.push(e);if(this.recentCharacters.length>16){this.recentCharacters.shift()}}},addToRecentColors:function(){var e=this.color;var t=false;for(var i=0;i<this.recentColors.length;i++){if(this.recentColors[i]==e){t=true;break}}if(!t){this.recentColors.push(e);if(this.recentColors.length>16){this.recentColors.shift()}}},setCharacter3d:function(e){var t=e[0][0];if(this.character3d!==t){this.character=t;var i=this.editor.tileSetManager.getCurrentTileSet();var r=this.editor.colorPaletteManager.getCurrentColorPalette();var a=0;var s=0;var o=0;if(this.characterMesh!==null){a=this.characterMesh.rotation.x;s=this.characterMesh.rotation.y;o=this.characterMesh.rotation.z;this.scene.remove(this.characterMesh);this.characterMesh=null}if(t!==this.editor.tileSetManager.blankCharacter){if(this.tileMaterial==null){this.tileMaterial=new THREE.MeshPhongMaterial({color:r.getHex(this.color)})}else{this.tileMaterial.color.set(r.getHex(this.color))}var l=i.getGeometry(t);this.characterMesh=new THREE.Mesh(l,this.tileMaterial);this.characterMesh.rotation.order="YXZ";this.characterMesh.rotation.x=a;this.characterMesh.rotation.y=s;this.characterMesh.rotation.z=o;this.characterMesh.position.x=1;this.characterMesh.position.y=1;this.characterMesh.position.z=1;this.scene.add(this.characterMesh);if(this.bgColor!==this.editor.colorPaletteManager.noColor){material=this.tileBGMaterial}else{material=this.noBGMaterial}material.flatShading=true;if(this.bgColor===-1){material.opacity=0}var l=i.getBackgroundGeometry(t);this.characterBGMesh=new THREE.Mesh(l,material);this.characterMesh.add(this.characterBGMesh)}this.editor.gridView3d.toolChanged()}},update3dOrientationInfo:function(){var e=Math.round(this.rotX*360);$("#currentTileRX").html(e);var t=Math.round(this.rotY*360);$("#currentTileRY").html(t);var i=Math.round(this.rotZ*360);$("#currentTileRZ").html(i)},rotateReset:function(){this.rotX=0;this.rotY=0;this.rotZ=0;this.editor.grid3d.setCursorRotation(this.rotX,this.rotY,this.rotZ);this.updateCharacterMeshOrientation();this.update3dOrientationInfo()},rotate:function(e){var t=this.rotX*Math.PI*2;var i=this.rotY*Math.PI*2;var r=this.rotZ*Math.PI*2;var a=new THREE.Euler(t,i,r,"YXZ");var s=new THREE.Matrix4;s.makeRotationFromEuler(a);var o=new THREE.Matrix4;if(e=="left"){o.makeRotationY(-Math.PI/2)}if(e=="right"){o.makeRotationY(Math.PI/2)}if(e=="up"){o.makeRotationX(-Math.PI/2)}if(e=="down"){o.makeRotationX(Math.PI/2)}if(e=="clockwise"){o.makeRotationZ(-Math.PI/2)}if(e=="anticlockwise"){o.makeRotationZ(Math.PI/2)}s.premultiply(o);a.setFromRotationMatrix(s,"YXZ");var l=Math.round(a.x*2/Math.PI)/4;var n=Math.round(a.y*2/Math.PI)/4;var h=Math.round(a.z*2/Math.PI)/4;this.rotX=l;this.rotY=n;this.rotZ=h;this.editor.grid3d.setCursorRotation(this.rotX,this.rotY,this.rotZ);this.rotateCharacterMesh(t,i,r,e);this.update3dOrientationInfo()},rotateCharacterMesh:function(e,t,i,r){this.characterMesh.rotation.x=e;this.characterMesh.rotation.y=t;this.characterMesh.rotation.z=i;var a=new THREE.Euler(e,t,i,"YXZ");var s=new THREE.Matrix4;s.makeRotationFromEuler(a);var o=new THREE.Matrix4;var l={x:0};var n={x:1};if(this.rotationTween!=null){this.rotationTween.stop()}this.rotationTween=new TWEEN.Tween(l).to(n,500);var h=this;this.rotationTween.onUpdate(function(){a.set(e,t,i,"YXZ");s.makeRotationFromEuler(a);if(r=="left"){o.makeRotationY(l.x*-Math.PI/2)}if(r=="right"){o.makeRotationY(l.x*Math.PI/2)}if(r=="up"){o.makeRotationX(l.x*-Math.PI/2)}if(r=="down"){o.makeRotationX(l.x*Math.PI/2)}if(r=="clockwise"){o.makeRotationZ(l.x*-Math.PI/2)}if(r=="anticlockwise"){o.makeRotationZ(l.x*Math.PI/2)}s.premultiply(o);a.setFromRotationMatrix(s,"YXZ");h.characterMesh.rotation.x=a.x;h.characterMesh.rotation.y=a.y;h.characterMesh.rotation.z=a.z});this.rotationTween.onComplete(function(){});this.rotationTween.easing(TWEEN.Easing.Cubic.InOut);this.rotationTween.start()},updateCharacterMeshOrientation:function(){var e=this.rotX*Math.PI*2;var t=this.rotX*Math.PI*2;var i=this.rotX*Math.PI*2;if(this.characterMesh.rotation.x==e&&this.characterMesh.rotation.y==t&&this.characterMesh.rotation.z==i){return}var r={x:this.characterMesh.rotation.x,y:this.characterMesh.rotation.y,z:this.characterMesh.rotation.z};var a={x:e,y:t,z:i};var s=new TWEEN.Tween(r).to(a,400);var o=this;s.onUpdate(function(){o.characterMesh.rotation.x=r.x;o.characterMesh.rotation.y=r.y;o.characterMesh.rotation.z=r.z});s.onComplete(function(){o.characterMesh.rotation.x=o.rotX*Math.PI*2;o.characterMesh.rotation.y=o.rotY*Math.PI*2;o.characterMesh.rotation.z=o.rotZ*Math.PI*2});s.easing(TWEEN.Easing.Cubic.InOut);s.start()},getVectorCursorCanvas:function(e){var t=e.scale;this.drawCursor({scale:t});return this.cursorCanvas},getCursorCanvas:function(){return this.cursorCanvas},getCursorWidth:function(){return this.characters[0].length},getCursorHeight:function(){return this.characters.length},drawCursor:function(e){if(this.type!="2d"){}var t=1;if(typeof e!="undefined"){if(typeof e.scale!="undefined"){t=e.scale}}if(this.useCells){if(this.cells.length===0){return}if(this.cells[0].length==0){return}}else{if(this.characters.length===0){return}if(this.characters[0].length==0){return}}if(this.cursorCanvas==null){this.cursorCanvas=document.createElement("canvas")}var i=this.editor.layers.getSelectedLayerObject();var r=this.editor.tileSetManager.getCurrentTileSet();var a=r.getTileCount();var s=this.editor.colorPaletteManager.getCurrentColorPalette();var o=r.getTileWidth();var l=r.getTileHeight();var n=0;var h=0;if(this.useCells){n=this.cells[0].length;h=this.cells.length}else{n=this.characters[0].length;h=this.characters.length}var d=o*n*t;var c=l*h*t;var f=false;if(this.cursorCanvas.width<d){this.cursorCanvas.width=d;f=true}if(this.cursorCanvas.height<c){this.cursorCanvas.height=c;f=true}var u=this.editor.getColorPerMode();var s=this.editor.colorPaletteManager.getCurrentColorPalette();var p=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg);if(f||this.cursorImageData==null){this.cursorContext=this.cursorCanvas.getContext("2d");this.cursorContext.clearRect(0,0,this.cursorCanvas.width,this.cursorCanvas.height);this.cursorImageData=this.cursorContext.getImageData(0,0,this.cursorCanvas.width,this.cursorCanvas.height)}var v=this.cursorCanvas;var g=this.cursorContext;var m=this.cursorImageData;if(typeof e!="undefined"){if(typeof e.canvas!="undefined"){v=e.canvas}if(typeof e.context!="undefined"){g=e.context}if(typeof e.imageData!="undefined"){m=e.imageData}}var y=v.width*v.height*4;var b=3;while(b<y){this.cursorImageData.data[b]=0;b+=4}var e={};e["imageData"]=m;e["context"]=g;if(i&&typeof i.getScreenMode!="undefined"){e["screenMode"]=i.getScreenMode();if(e["screenMode"]===TextModeEditor.Mode.INDEXED){e["transparentColorIndex"]=i.getTransparentColorIndex()}if(e["screenMode"]===TextModeEditor.Mode.C64MULTICOLOR){p=s.getHex(i.getBackgroundColor());e["backgroundColor"]=i.getBackgroundColor();e["c64Multi1Color"]=i.getC64Multi1Color();e["c64Multi2Color"]=i.getC64Multi2Color()}}var C=this.bgColor;for(var x=0;x<h;x++){for(var S=0;S<n;S++){if(this.useCells){e["color"]=this.cells[x][S].fc;e["bgColor"]=this.cells[x][S].bc;e["character"]=this.cells[x][S].t}else{e["character"]=this.characters[x][S];if(u=="character"){var P=e["character"];if(typeof P!="undefined"&&P!==false&&P<a){var w=r.getTileColor(P);if(this.editor.getColorPerMode()=="character"){C=r.getCharacterBGColor(P)}e["colorRGB"]=s.getHex(w);e["color"]=w;if(C!=this.editor.colorPaletteManager.noColor){e["bgColor"]=C}else{e["bgColor"]=this.editor.colorPaletteManager.noColor}}}else{e["color"]=this.color;e["bgColor"]=this.bgColor}}if(e["screenMode"]===TextModeEditor.Mode.C64STANDARD){e["bgColor"]=this.editor.colorPaletteManager.noColor}if(e["screenMode"]===TextModeEditor.Mode.C64ECM){if(i&&typeof i.getC64ECMColor!="undefined"){var I=Math.floor(e["character"]/64)%4;e["character"]=e["character"]%64;e["bgColor"]=i.getC64ECMColor(I)}}if(typeof e["character"]!="undefined"&&e["character"]!==false){if(this.editor.graphic.getHasTileFlip()){e["flipH"]=this.flipH;e["flipV"]=this.flipV}if(this.editor.graphic.getHasTileRotate()){e["rotZ"]=this.rotZ}e["x"]=S*o;e["y"]=x*l;e["scale"]=t;e["select"]=false;e["highlight"]=false;if(this.editor.getCursorTileTransparent()){e["backgroundIsTransparent"]=true}else{if(e["bgColor"]==this.editor.colorPaletteManager.noColor){e["bgColor"]=this.editor.graphic.getBackgroundColor()}}r.drawCharacter(e)}}}if(i&&i.getMode()!=TextModeEditor.Mode.VECTOR){g.putImageData(m,0,0)}},setDeviceType:function(e){var t=this;if(e=="mobile"){this.canvas=document.getElementById("toolsMobileCurrentTile");if(!this.mobileCanvasEventsInit){if(this.canvas){this.mobileCanvasEventsInit=true;this.canvas.addEventListener("click",function(e){t.characterClick(e)},false)}}this.tilePaletteCanvas=document.getElementById("tilePaletteMobileCurrentTile")}else{this.canvas=this.canvasPanel.getCanvas();if(!this.desktopCanvasEventsInit){this.desktopCanvasEventsInit=true;this.canvas.addEventListener("dblclick",function(e){t.characterDoubleClick(e)},false)}this.tileSettingsTileCanvas=document.getElementById("toolSettingsCurrentTile");this.tileSettingsTileCanvas.width=24*UI.devicePixelRatio;this.tileSettingsTileCanvas.height=24*UI.devicePixelRatio;$("#toolSettingsCurrentTile").on("mouseenter",function(){UI.setCursor("pointer")});$("#toolSettingsCurrentTile").on("mouseleave",function(){UI.setCursor("default")})}},canvasDrawCharacters:function(){if(this.type!="2d"){}if(this.characters.length===0){return}if(this.characters[0].length==0){return}var e=this.editor.tileSetManager.getCurrentTileSet();if(!e){return}var t=e.getTileWidth();var i=e.getTileHeight();var r=0;var a=0;if(this.useCells){r=this.cells[0].length;a=this.cells.length}else{r=this.characters[0].length;a=this.characters.length}var s=t*r;var o=i*a;this.drawCursor();if(this.canvas==null){if(g_app.isMobile()){this.setDeviceType("mobile")}else{this.setDeviceType("desktop")}}if(this.canvas==null){return}this.context=UI.getContextNoSmoothing(this.canvas);this.context.fillStyle="#222222";this.context.fillRect(0,0,this.canvas.width,this.canvas.height);this.tilePaletteContext=null;if(this.tilePaletteCanvas!=null){this.tilePaletteContext=UI.getContextNoSmoothing(this.tilePaletteCanvas);this.tilePaletteContext.fillStyle="#222222";this.tilePaletteContext.fillRect(0,0,this.tilePaletteCanvas.width,this.tilePaletteCanvas.height)}this.tileSettingsTileContext=null;if(this.tileSettingsTileCanvas!=null){this.tileSettingsTileContext=UI.getContextNoSmoothing(this.tileSettingsTileCanvas);this.tileSettingsTileContext.fillStyle="#222222";this.tileSettingsTileContext.fillRect(0,0,this.tileSettingsTileCanvas.width,this.tileSettingsTileCanvas.height);this.tileSettingsImageData=this.tileSettingsTileContext.getImageData(0,0,this.tileSettingsTileCanvas.width,this.tileSettingsTileCanvas.height)}var l=1;var n=1;var h=1;if(this.canvas.width>s){n=this.canvas.width/s}var h=1;if(this.canvas.height>o){h=this.canvas.height/o}if(n>h){l=h}else{l=n}var d=this.editor.layers.getSelectedLayerObject();if(d.getMode()==TextModeEditor.Mode.VECTOR){this.drawCursor({scale:l,canvas:this.canvas,context:this.context,imageData:null})}else{var c=0;var f=0;var u=Math.floor(s*l);var p=Math.floor(o*l);c=Math.floor((this.canvas.width-u)/2);f=Math.floor((this.canvas.height-p)/2);this.context.drawImage(this.cursorCanvas,0,0,s,o,c,f,u,p)}if(this.tilePaletteContext){var l=1;var n=1;var h=1;if(this.tilePaletteCanvas.width>s){n=this.tilePaletteCanvas.width/s}var h=1;if(this.tilePaletteCanvas.height>o){h=this.tilePaletteCanvas.height/o}if(n>h){l=h}else{l=n}var d=this.editor.layers.getSelectedLayerObject();if(d.getMode()==TextModeEditor.Mode.VECTOR){this.drawCursor({scale:l,canvas:this.tilePaletteCanvas,context:this.tilePaletteContext,imageData:null})}else{var c=0;var f=0;var u=Math.floor(s*l);var p=Math.floor(o*l);c=Math.floor((this.tilePaletteCanvas.width-u)/2);f=Math.floor((this.tilePaletteCanvas.height-p)/2);this.tilePaletteContext.drawImage(this.cursorCanvas,0,0,s,o,c,f,u,p)}}if(this.tileSettingsTileContext){var l=1;var n=1;var h=1;if(this.tileSettingsTileCanvas.width>s){n=this.tileSettingsTileCanvas.width/s}var h=1;if(this.tileSettingsTileCanvas.height>o){h=this.tileSettingsTileCanvas.height/o}if(n>h){l=h}else{l=n}var d=this.editor.layers.getSelectedLayerObject();if(d.getMode()==TextModeEditor.Mode.VECTOR){this.drawCursor({scale:l,canvas:this.tileSettingsTileCanvas,context:this.tileSettingsTileContext,imageData:this.tileSettingsImageData})}else{var c=0;var f=0;var u=Math.floor(s*l);var p=Math.floor(o*l);c=Math.floor((this.tileSettingsTileCanvas.width-u)/2);f=Math.floor((this.tileSettingsTileCanvas.height-p)/2);this.tileSettingsTileContext.drawImage(this.cursorCanvas,0,0,s,o,c,f,u,p)}if(this.editor.sideTilePalette){this.editor.sideTilePalette.setCharacterInfoToCurrent()}if(this.editor.tools.drawTools.tilePalette){this.editor.tools.drawTools.tilePalette.setCharacterInfoToCurrent()}}},canvasDrawCharacter:function(){this.canvasDrawCharacters();return},resize:function(e,t,i,r){this.width=i;this.height=r;this.left=e;this.top=t;this.camera.aspect=i/r;this.camera.updateProjectionMatrix()},setType:function(e){this.type=e;if(this.type=="2d"){this.holderPanel.showOnly("currentTileCanvasPanel");this.canvasDrawCharacter()}else if(this.type=="3d"){this.holderPanel.showOnly("currentTileWebGLPanel")}},refresh:function(){if(this.editor.type=="2d"){this.canvasDrawCharacters()}},render:function(e,t,i,r){if(this.editor.type!=this.type){this.setType(this.editor.type)}if(this.width!=i||this.height!=r||this.left!=e||this.top!=t){this.resize(e,t,i,r)}if(this.editor.type=="3d"){UI.renderer.setClearColor(this.backgroundColor3d);UI.renderer.render(this.scene,this.camera)}else if(this.editor.type=="2d"){this.canvasDrawCharacters()}}};var AnimationPreview=function(){this.editor=null;this.visible=false;this.currentCanvasElementId="";this.canvasElementId="";this.canvasHolderElementId="";this.screenCanvas=null;this.screenContext=null;this.lastFrameTime=0;this.currentFrame=0;this.scale=1;this.scaleFit=false;this.fromFrame=0;this.toFrame=0};AnimationPreview.prototype={init:function(e){this.editor=e},buildInterface:function(e){var t=this;var i="";i+='<div class="panelFill">';i+='  <div style="position: absolute; top: 10px; left: 0; right: 0; bottom: 40px" id="animationPreviewHolder">';i+='    <canvas id="animationPreviewCanvas" style=""></canvas>';i+="  </div>";i+='<div style="position: absolute; bottom: 0px; height: 40px; left: 0; right: 0">';i+="<div>";i+='  <select id="animationFrameRange">';i+='    <option value="" selected="selected">All Frames</option>';i+="  </select>";i+="</div>";i+='<div class="ui-button">Play</div>';i+='<select id="animationPreviewScale">';i+='<option value="0" selected="selected">Fit</option>';i+='<option value="1">100%</option>';i+='<option value="2">200%</option>';i+='<option value="3">300%</option>';i+='<option value="4">400%</option>';i+='<option value="5">500%</option>';i+='<option value="6">600%</option>';i+="</select>";i+="</div>";i+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.on("resize",function(){t.resize()});e.add(this.uiComponent);this.canvasElementId="animationPreviewCanvas";this.canvasHolderElementId="animationPreviewHolder";UI.on("ready",function(){var e=parseInt($("#animationPreviewScale").val());t.setScale(e);$("#animationPreviewScale").on("change",function(){var e=parseInt($(this).val());t.setScale(e)});t.resize();t.initEvents()})},show:function(){this.visible=true;this.resize()},hide:function(){this.visible=false},getVisible:function(){return this.visible},initEvents:function(){var t=this;$("#animationFrameRange").on("change",function(){var e=$(this).val();t.setFrameRange(e)})},updateFrameRanges:function(){var e=$("#animationFrameRange").val();if(e!==""){e=parseInt(e,10)}var t="";t+='<option value="">All Frames</option>';var i=this.editor.graphic.getFrameRanges();for(var r=0;r<i.length;r++){var a=r+1;var s="Range "+a;t+='<option value="'+r+'" ';if(r===e){t+=' selected="selected" '}t+=">"+s+"</option>"}$("#animationFrameRange").html(t);var o=$("#animationFrameRange").val();this.setFrameRange(o)},setFrameRange:function(e){if(e!==""){e=parseInt(e,10);if(isNaN(e)){return}}this.frameRange=e;var t=this.editor.graphic.getFrameRanges();this.fromFrame=0;this.toFrame=this.editor.graphic.getFrameCount();if(e!==""&&e>=0&&e<t.length){this.fromFrame=t[e].start;this.toFrame=t[e].end}if(currentFrame<this.fromFrame||currentFrame>=this.toFrame){this.currentFrame=this.fromFrame}var i=$("#animationFrameRange").val();if(i!==""){i=parseInt(i,10)}if(i!==e){$("#animationFrameRange").val(e)}this.editor.spriteFrames.drawRange({rangesChanged:false});this.editor.spriteFrames.draw({framesChanged:false})},getFrameRange:function(){return this.frameRange},setScale:function(e){this.scaleFit=e==0;this.scale=e},setCanvasElementId:function(e,t){this.canvasElementId=e;this.canvasHolderElementId=t},sizeCanvas:function(){var e=$("#"+this.canvasHolderElementId);if(this.canvas==null||this.canvasElementId!=this.currentCanvasElementId){this.canvas=document.getElementById(this.canvasElementId);this.currentCanvasElementId=this.canvasElementId}var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}if(this.width!=this.canvas.style.width||this.height!=this.canvas.style.height){if(this.width!=0&&this.height!=0){this.canvasScale=Math.floor(UI.devicePixelRatio);this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvas.width=this.width*this.canvasScale;this.canvas.height=this.height*this.canvasScale}}this.context=this.canvas.getContext("2d");this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false},resize:function(){if(!this.visible){return}this.sizeCanvas();this.draw()},draw:function(){if(!this.visible){return}var e=this.editor.graphic.getGraphicWidth();var t=this.editor.graphic.getGraphicHeight();if(this.screenCanvas==null){this.screenCanvas=document.createElement("canvas")}if(this.screenContext==null||this.screenCanvas.width!=e||this.screenCanvas.height!=t){this.screenCanvas.width=e;this.screenCanvas.height=t;this.screenContext=this.screenCanvas.getContext("2d");this.screenContext.imageSmoothingEnabled=false;this.screenContext.webkitImageSmoothingEnabled=false;this.screenContext.mozImageSmoothingEnabled=false;this.screenContext.msImageSmoothingEnabled=false;this.screenContext.oImageSmoothingEnabled=false}this.layers="visible";this.screenContext.clearRect(0,0,this.screenCanvas.width,this.screenCanvas.height);var i=this.editor.tools.drawTools.pixelSelect.isActive();this.editor.tools.drawTools.pixelSelect.setActive(false);this.editor.grid.grid2d.drawFrame({allCells:true,updateLayerCanvas:false,canvas:this.screenCanvas,context:this.screenContext,frame:this.currentFrame,layers:this.layers});this.editor.tools.drawTools.pixelSelect.setActive(i);var r=this.scale*this.canvasScale;if(r===0){var a=Math.floor((this.canvas.width-10)/e);var s=Math.floor((this.canvas.height-10)/t);if(s>a){r=a}else{r=s}}var o=this.screenCanvas.width*r;var l=this.screenCanvas.height*r;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.drawImage(this.screenCanvas,(this.canvas.width-o)/2,(this.canvas.height-l)/2,this.screenCanvas.width*r,this.screenCanvas.height*r)},update:function(){if(this.editor.frames.playFrames){var e=this.editor.graphic.getCurrentFrame();if(e!==this.currentFrame){this.currentFrame=e;this.draw()}}else{this.playDirection=1;var t=getTimestamp();var i=this.editor.graphic.getFrameCount();var r=this.editor.graphic.getFrameRanges();this.fromFrame=0;this.toFrame=i;if(this.frameRange!==""&&this.frameRange>=0&&this.frameRange<r.length){this.fromFrame=r[this.frameRange].start;this.toFrame=r[this.frameRange].end}if(this.currentFrame>=this.toFrame){this.currentFrame=this.fromFrame;if(i==0){return}}if(t-this.lastFrameTime>this.editor.graphic.frames[this.currentFrame].duration*FRAMERATE){var e=this.currentFrame;e+=this.playDirection;if(e>=this.toFrame){e=this.fromFrame}this.currentFrame=e;this.lastFrameTime=t;this.draw()}}}};var TileEditor=function(){this.character=false;this.characters=[];this.clipboardCanvas=null;this.canvas=null;this.tileEditorGrid=null;this.frame=0;this.frameCount=1;this.mixedAnimation=false;this.visible=false;this.tileSet=null;this.tileIndex=false;this.glyphEditor=null};TileEditor.prototype={init:function(e){this.editor=e;this.tileEditorGrid=new TileEditorGrid;this.tileEditorGrid.init(e,{canvasElementId:"tileEditorCanvas",setMouseCursor:true});this.glyphEditor=new GlyphEditor},getVisible:function(){return this.visible},setVisible:function(e){var t=this.editor.tileSetManager.getCurrentTileSet();if(!t){return}this.visible=e;var i=t.getType();if(i=="vector"){if(this.visible){this.uiComponent.showOnly("vectorModeTileEditorPanel");this.glyphEditor.setTile(this.tileIndex)}}if(i!="vector"){var r="";if(g_app.mode=="2d"){var a=this.editor.layers.getSelectedLayerObject();if(a&&a.getType()=="grid"){r=a.getScreenMode()}}if(this.visible){if(e){this.uiComponent.showOnly("textModeTileEditorPanel")}if(r===TextModeEditor.Mode.C64MULTICOLOR){this.editor.tools.drawTools.pixelDraw.initC64MulticolorControl()}}}UI("gridSplitPanel").setPanelVisible("west",this.visible)},toggleVisible:function(){this.setVisible(!this.visible)},setScreenMode:function(e){switch(e){case TextModeEditor.Mode.TEXTMODE:case TextModeEditor.Mode.C64ECM:case TextModeEditor.Mode.C64STANDARD:$("#tileEditorC64Colors").hide();$("#tileEditorSubPaletteColors").hide();$("#tileEditorMultiColors").hide();break;case TextModeEditor.Mode.C64MULTICOLOR:$("#tileEditorC64Colors").show();$("#tileEditorSubPaletteColors").hide();$("#tileEditorMultiColors").hide();break;case TextModeEditor.Mode.NES:$("#tileEditorC64Colors").hide();$("#tileEditorSubPaletteColors").show();$("#tileEditorMultiColors").hide();break;case TextModeEditor.Mode.INDEXED:case TextModeEditor.Mode.RGB:$("#tileEditorC64Colors").hide();$("#tileEditorSubPaletteColors").hide();$("#tileEditorMultiColors").show();break}},initEvents:function(){var a=this;$("#tileEditorFlipH").on("click",function(){a.tileEditorGrid.flipH()});$("#tileEditorFlipV").on("click",function(){a.tileEditorGrid.flipV()});$("#tileEditorLeft").on("click",function(){a.tileEditorGrid.rotatePixels(1,0)});$("#tileEditorRight").on("click",function(){a.tileEditorGrid.rotatePixels(-1,0)});$("#tileEditorUp").on("click",function(){a.tileEditorGrid.rotatePixels(0,1)});$("#tileEditorDown").on("click",function(){a.tileEditorGrid.rotatePixels(0,-1)});$("#tileEditorRotate").on("click",function(){a.tileEditorGrid.rotate()});$("#tileEditorInvert").on("click",function(){a.tileEditorGrid.invert()});$("#tileEditorCopy").on("click",function(){a.tileEditorGrid.copyCharacter()});$("#tileEditorPaste").on("click",function(){a.tileEditorGrid.pasteCharacter()});$("#tileEditorClear").on("click",function(){a.tileEditorGrid.copyCharacter();a.tileEditorGrid.clearCharacter()});$("#tileEditorAnimatedType").on("change",function(){var e=$(this).val();a.setAnimatedType(e)});$("#tileEditorAnimatedTicksPerFrame").on("keyup",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){a.setTicksPerFrame(e)}});$("#tileEditorAnimatedTicksPerFrame").on("change",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){a.setTicksPerFrame(e)}});$("#tileEditorCloseButton").on("click",function(){a.toggleVisible()});$("#tileEditorFrame").on("change",function(){var e=parseInt($(this).val());if(!isNaN(e)){a.setFrame(e-1)}});$("#tileEditorFrame").on("keyup",function(){var e=parseInt($(this).val());if(!isNaN(e)){a.setFrame(e-1)}});$("#tileEditorNextFrame").on("click",function(){a.nextFrame()});$("#tileEditorPrevFrame").on("click",function(){a.prevFrame()});$("#tileEditorInsertFrame").on("click",function(){a.insertFrame()});$("#tileEditorDeleteFrame").on("click",function(){a.deleteFrame()});$("#tileEditorControls .ui-button").on("mouseleave",function(e){$("#tileEditorControlLabel").html("&nbsp;")});$("#tileEditorControls .ui-button").on("mouseenter",function(e){var t=$(this).attr("data-label");$("#tileEditorControlLabel").html(t)});$("#tileEditorMultiColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.selectColorIndex(e);a.editor.currentTile.setColor(e)};var i=e.pageX;var r=e.pageY;t.currentColor=a.editor.currentTile.getColor();a.editor.colorPaletteManager.showColorPicker(i,r,t)});$(".tileEditorSubPaletteColor").on("click",function(e){var t=$(this).attr("data-index");a.selectColorSubPaletteColorIndex(t)})},buildInterface:function(e){this.uiComponent=UI.create("UI.Panel");e.add(this.uiComponent);var t="vector editor";this.vectorModePanel=UI.create("UI.HTMLPanel",{id:"vectorModeTileEditorPanel",html:t});this.uiComponent.add(this.vectorModePanel);this.textModePanel=UI.create("UI.HTMLPanel",{id:"textModeTileEditorPanel"});this.uiComponent.add(this.textModePanel);var i=this;UI.on("ready",function(){i.textModePanel.load("html/textMode/tileEditor.html",function(){i.c64MulticolorTypeControl=new C64MulticolorTypeControl;i.c64MulticolorTypeControl.init(i.editor,{elementId:"tileEditorC64Colors"});i.initEvents()});i.vectorModePanel.load("html/textMode/glyphEditor.html",function(){i.glyphEditor.init(i.editor);i.glyphEditor.initEvents(i.editor)})});this.textModePanel.on("contextmenu",function(e){e.preventDefault()});this.uiComponent.on("resize",function(e){i.resize()});this.uiComponent.showOnly("textModeTileEditorPanel")},setupTileEditor:function(){if(document.getElementById("tileEditorControls")){var e=this.tileEditorGrid.getHeight();+10+10;document.getElementById("tileEditorControls").style.top=e+"px"}},resize:function(){if(!this.visible){return}if(this.canvas==null){this.canvas=document.getElementById("tileEditorCanvas")}var e=$("#tileEditorCanvasHolder");var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}var i=1;var r=1;if(this.characters.length>0&&this.characters[0].length>0){i=this.characters[0].length;r=this.characters.length}var a=this.width-20;var s=this.width-20;if(i>r){s=Math.ceil(r*(a/i))}this.tileEditorGrid.setSize(a,s);$("#tileEditorCanvas").css("top","10px");$("#tileEditorCanvas").css("left","10px")},setCharacters:function(e){var t=false;this.tileIndex=e[0][0];if(this.visible){this.glyphEditor.setTile(e[0][0])}if(e.length!=this.characters.length){t=true}if(!t){for(var i=0;i<e.length;i++){if(e[i].length!=this.characters[i].length){t=true}if(!t){for(var r=0;r<e[i].length;r++){if(e[i][r]!=this.characters[i][r]){t=true;r=e[i].length;i=e.length;break}}}}}if(!t){return}this.tileSet=this.editor.tileSetManager.getCurrentTileSet();if(!this.tileSet){return}var a=this.tileSet.getTileCount();this.setupTileEditor();this.characters=[];var s=true;var o=true;this.animated=false;this.ticksPerFrame=0;this.animatedType="";this.frames=0;var l=0;var n=false;for(var i=0;i<e.length;i++){this.characters.push([]);for(var r=0;r<e[i].length;r++){var h=e[i][r];if(h>=a){h=false}this.characters[i].push(h);l++;n=h;if(h!==false&&h!==this.editor.tileSetManager.noTile){var d=this.tileSet.getTileProperties(e[i][r]);if(typeof d.animated!="undefined"&&d.animated!==false){console.log("animated!!!");if(this.animated&&this.ticksPerFrame==d.ticksPerFrame&&this.animatedType==d.animated&&this.frameCount==d.frameCount||s){this.animated=true;this.ticksPerFrame=d.ticksPerFrame;this.animatedType=d.animated;this.frameCount=d.frameCount}else{if(!s){o=false}}}else{if(!this.animated||s){this.animated=false}else{if(!s){o=false}}}}s=false}}this.frame=0;var c="";if(l==1){var f=("00"+n.toString(16)).substr(-2);c="Tile: "+n;c+=" (0x"+f+")"}else{c=a+" Tiles Selected"}$("#tileEditorTileInfo").html(c);$("#tileEditorFrame").val(1);if(!o){this.mixedAnimation=true;this.updateAnimationOptions({hasMixed:true,selected:"mixed"});$("#tileEditorAnimatedType").val("mixed")}else{this.mixedAnimation=false;this.updateAnimationOptions({hasMixed:false});if(this.animated){$("#tileEditorAnimatedTicksPerFrame").val(this.ticksPerFrame);$("#tileEditorAnimatedType").val(this.animatedType);$("#tileEditorFrames").html(this.frameCount);$("#tileEditorFrame").attr("max",this.frameCount);$("#tileEditorAnimatedTicksPerFrameRow").show();if(this.animatedType=="frames"){$("#tileEditorFrameControls").show()}else{$("#tileEditorFrameControls").hide()}}else{$("#tileEditorAnimatedType").val("");$("#tileEditorFrameControls").hide();$("#tileEditorAnimatedTicksPerFrameRow").hide();$("#tileEditorFrames").html(1);$("#tileEditorFrame").attr("max",1)}}this.frame=0;$("#tileEditorFrame").val(1);this.resize();this.tileEditorGrid.setCharacters(e);this.editor.currentTile.refresh()},updateAnimationOptions:function(e){var t=false;if(typeof e.hasMixed!="undefined"){t=e.hasMixed}var i="";if(typeof e.selected!="undefined"){i=e.selected}var r=[{value:"",label:"No"},{value:"mixed",label:"Mixed"},{value:"left",label:"Scroll Left"},{value:"right",label:"Scroll Right"},{value:"up",label:"Scroll Up"},{value:"down",label:"Scroll Down"},{value:"blink",label:"Blink"},{value:"frames",label:"Frames"}];var a="";for(var s=0;s<r.length;s++){if(r[s].value!="mixed"||t){a+='<option value="'+r[s].value+'" ';if(r[s]==="selected"){a+=' selected="selected" '}a+=">"+r[s].label+"</option>"}}$("#tileEditorAnimatedType").html(a)},setFrame:function(e){if(e>=this.frameCount){return}this.frame=e;$("#tileEditorFrame").val(this.frame+1);this.tileEditorGrid.setFrame(this.frame)},prevFrame:function(){var e=this.frame-1;if(e>=0){this.setFrame(e);$("#tileEditorFrame").val(e+1)}},nextFrame:function(){var e=this.frame+1;if(e<this.frameCount){this.setFrame(e);$("#tileEditorFrame").val(e+1)}},insertFrame:function(){for(var e=0;e<this.characters.length;e++){for(var t=0;t<this.characters[e].length;t++){this.tileSet.insertFrame(this.characters[e][t],this.frame);var i=this.tileSet.getTileProperties(this.characters[e][t]);frameCount=i.frameCount}}this.frameCount=frameCount;$("#tileEditorFrames").html(frameCount);$("#tileEditorFrame").attr("max",frameCount);this.setFrame(this.frame+1)},deleteFrame:function(){for(var e=0;e<this.characters.length;e++){for(var t=0;t<this.characters[e].length;t++){this.tileSet.deleteFrame(this.characters[e][t],this.frame);var i=this.tileSet.getTileProperties(this.characters[e][t]);frameCount=i.frameCount}}this.frameCount=frameCount;$("#tileEditorFrames").html(frameCount);$("#tileEditorFrame").attr("max",frameCount);if(this.frameCount==1||this.frame==0){this.setFrame(0)}else{this.setFrame(this.frame-1)}},setAnimated:function(e){console.error("shouldnt get here");var t=$("#tileEditorAnimatedType").val();var i=parseInt($("#tileEditorAnimatedTicksPerFrame").val(),10);if(isNaN(i)){i=6}for(var r=0;r<this.characters.length;r++){for(var a=0;a<this.characters[r].length;a++){this.tileSet.setAnimated(this.characters[r][a],e);this.tileSet.setAnimatedType(this.characters[r][a],t);this.tileSet.setAnimatedTicksPerFrame(this.characters[r][a],i)}}if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}},setTicksPerFrame:function(e){for(var t=0;t<this.characters.length;t++){for(var i=0;i<this.characters[t].length;i++){this.tileSet.setAnimatedTicksPerFrame(this.characters[t][i],e)}}},setAnimatedType:function(e){var t=true;if(e==""){t=false}var i=parseInt($("#tileEditorAnimatedTicksPerFrame").val(),10);if(isNaN(i)){i=6}var r=0;for(var a=0;a<this.characters.length;a++){for(var s=0;s<this.characters[a].length;s++){this.tileSet.setAnimated(this.characters[a][s],t);if(t){this.tileSet.setAnimatedType(this.characters[a][s],e);this.tileSet.setAnimatedTicksPerFrame(this.characters[a][s],i)}var o=this.tileSet.getTileProperties(this.characters[a][s]);r=o.frameCount}}if(this.mixedAnimation){this.updateAnimationOptions({hasMixed:false,selected:e});$("#tileEditorAnimatedType").val(e);this.mixedAnimation=false}if(e=="frames"){this.frameCount=r;$("#tileEditorFrames").html(r);$("#tileEditorFrame").attr("max",r);$("#tileEditorFrameControls").show()}else{$("#tileEditorFrameControls").hide()}this.setFrame(0);this.tileEditorGrid.updateCharacter();for(var a=0;a<this.characters.length;a++){for(var s=0;s<this.characters[a].length;s++){this.tileSet.updateCharacterCurrentData(this.characters[a][s])}}if(t===false){$("#tileEditorAnimatedTicksPerFrameRow").hide()}else{$("#tileEditorAnimatedTicksPerFrameRow").show()}if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}this.editor.currentTile.refresh()},selectC64ColorType:function(e,t){this.tileEditorGrid.setC64ColorType(e);this.tileEditorGrid.setColorIndex(t)},selectColorIndex:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();$("#tileEditorMultiColor").css("background-color","#"+t.getHexString(e));this.tileEditorGrid.setColorIndex(e)},selectColorSubPaletteColorIndex:function(e){this.editor.colorPaletteManager.colorSubPalettes.selectPaletteColor(e)},drawSelectedSubPaletteColor:function(){var e=this.tileEditorGrid.getColorIndex();$(".tileEditorSubPaletteColor").css({"border-width":"1px"});$("#tileEditorSubPaletteColor-"+e).css({"border-width":"2px"})},draw:function(){this.tileEditorGrid.draw()}};var TileEditorMobile=function(){this.character=false;this.characters=[];this.clipboardCanvas=null;this.canvas=null;this.uiComponent=null;this.tileEditorMobileGrid=null;this.frame=0;this.frameCount=1;this.mixedAnimation=false;this.visible=false;this.tileSet=null};TileEditorMobile.prototype={init:function(e){this.editor=e},show:function(t){if(this.uiComponent==null){var e=500;var i=100;var r=UI.getScreenWidth();var a=UI.getScreenHeight();e=r-10;i=a-10;if(e>640){e=640}if(i>800){i=800}var s=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.MobilePanel",{id:"tileEditorMobile",title:"Tile Editor",width:e,height:i});var o=UI.create("UI.HTMLPanel",{id:"tileEditorMobileHTML"});this.uiComponent.add(o);o.load("html/textMode/tileEditorMobile.html",function(){s.c64MulticolorTypeControl=new C64MulticolorTypeControl;s.c64MulticolorTypeControl.init(s.editor,{elementId:"tileEditorMobileC64Colors"});s.initEvents();s.tileEditorMobileGrid=new TileEditorGrid;s.tileEditorMobileGrid.init(s.editor,{canvasElementId:"tileEditorMobileCanvas",setMouseCursor:true});s.tileEditorMobileGrid.setupTileEditor();if(typeof t!="undefined"){if(typeof t.character!="undefined"){s.setCharacters([[t.character]])}}else{s.setCharacters([[0]])}s.setScreenMode(s.editor.getScreenMode());if(s.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){s.editor.setBackgroundColor(s.editor.graphic.getBackgroundColor(),false);s.editor.setC64Multi1Color(s.editor.graphic.getC64Multi1Color(),false);s.editor.setC64Multi2Color(s.editor.graphic.getC64Multi2Color(),false);var e=s.editor.currentTile.getColor();s.editor.currentTile.setColor(e,{force:true})}UI.showDialog("tileEditorMobile");s.resize();s.draw();s.editor.tools.drawTools.pixelDraw.setC64MultiColorType(s.editor.tools.drawTools.pixelDraw.c64MultiColorType);if(s.editor.colorPaletteManager.colorSubPalettes){s.editor.colorPaletteManager.colorSubPalettes.selectPalette()}})}}else{if(typeof t!="undefined"){if(typeof t.character!="undefined"){this.setCharacters([[t.character]])}}UI.showDialog("tileEditorMobile");this.resize();this.draw();if(this.editor.colorPaletteManager.colorSubPalettes){this.editor.colorPaletteManager.colorSubPalettes.selectPalette()}}},setScreenMode:function(e){switch(e){case TextModeEditor.Mode.TEXTMODE:case TextModeEditor.Mode.C64ECM:case TextModeEditor.Mode.C64STANDARD:$("#tileEditorMobileC64Colors").hide();$("#tileEditorMobileSubPaletteColors").hide();$("#tileEditorMobileMultiColors").hide();break;case TextModeEditor.Mode.C64MULTICOLOR:$("#tileEditorMobileC64Colors").show();$("#tileEditorMobileSubPaletteColors").hide();$("#tileEditorMobileMultiColors").hide();break;case TextModeEditor.Mode.NES:$("#tileEditorMobileC64Colors").hide();$("#tileEditorMobileSubPaletteColors").show();$("#tileEditorMobileMultiColors").hide();break;case TextModeEditor.Mode.INDEXED:case TextModeEditor.Mode.RGB:$("#tileEditorMobileC64Colors").hide();$("#tileEditorMobileSubPaletteColors").hide();$("#tileEditorMobileMultiColors").show();break}},initEvents:function(){var a=this;$("#tileEditorMobileFlipH").on("click",function(){a.tileEditorMobileGrid.flipH()});$("#tileEditorMobileFlipV").on("click",function(){a.tileEditorMobileGrid.flipV()});$("#tileEditorMobileLeft").on("click",function(){a.tileEditorMobileGrid.rotatePixels(1,0)});$("#tileEditorMobileRight").on("click",function(){a.tileEditorMobileGrid.rotatePixels(-1,0)});$("#tileEditorMobileUp").on("click",function(){a.tileEditorMobileGrid.rotatePixels(0,1)});$("#tileEditorMobileDown").on("click",function(){a.tileEditorMobileGrid.rotatePixels(0,-1)});$("#tileEditorMobileRotate").on("click",function(){a.tileEditorMobileGrid.rotate()});$("#tileEditorMobileInvert").on("click",function(){a.tileEditorMobileGrid.invert()});$("#tileEditorMobileCopy").on("click",function(){a.tileEditorMobileGrid.copyCharacter()});$("#tileEditorMobilePaste").on("click",function(){a.tileEditorMobileGrid.pasteCharacter()});$("#tileEditorMobileClear").on("click",function(){a.tileEditorMobileGrid.copyCharacter();a.tileEditorMobileGrid.clearCharacter()});$("#tileEditorMobileAnimatedType").on("change",function(){var e=$(this).val();a.setAnimatedType(e)});$("#tileEditorMobileAnimatedTicksPerFrame").on("keyup",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){a.setTicksPerFrame(e)}});$("#tileEditorMobileAnimatedTicksPerFrame").on("change",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){a.setTicksPerFrame(e)}});$("#tileEditorMobileCloseButton").on("click",function(){a.toggleVisible()});$("#tileEditorMobileFrame").on("change",function(){var e=parseInt($(this).val());if(!isNaN(e)){a.setFrame(e-1)}});$("#tileEditorMobileFrame").on("keyup",function(){var e=parseInt($(this).val());if(!isNaN(e)){a.setFrame(e-1)}});$("#tileEditorMobileNextFrame").on("click",function(){a.nextFrame()});$("#tileEditorMobilePrevFrame").on("click",function(){a.prevFrame()});$("#tileEditorMobileInsertFrame").on("click",function(){a.insertFrame()});$("#tileEditorMobileDeleteFrame").on("click",function(){a.deleteFrame()});$("#tileEditorMobileControls .ui-button").on("mouseleave",function(e){$("#tileEditorMobileControlLabel").html("")});$("#tileEditorMobileControls .ui-button").on("mouseenter",function(e){var t=$(this).attr("data-label");$("#tileEditorMobileControlLabel").html(t)});$("#tileEditorMobileMultiColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.selectColorIndex(e);a.editor.currentTile.setColor(e)};var i=e.pageX;var r=e.pageY;t.currentColor=a.editor.currentTile.getColor();a.editor.colorPaletteManager.showColorPicker(i,r,t)});$(".tileEditorMobileSubPaletteColor").on("click",function(e){var t=$(this).attr("data-index");console.log("select colour "+t);a.selectSubPaletteColorIndex(t)})},setupTileEditor:function(){var e=this.tileEditorMobileGrid.getHeight();+10+10;document.getElementById("tileEditorMobileControls").style.top=e+"px"},resize:function(){if(this.canvas==null){this.canvas=document.getElementById("tileEditorMobileCanvas")}var e=$("#tileEditorMobileCanvasHolder");var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}if(this.width>UI.getScreenHeight()/2){this.width=Math.ceil(UI.getScreenHeight()/2)}var i=1;var r=1;if(this.characters.length>0&&this.characters[0].length>0){i=this.characters[0].length;r=this.characters.length}var a=this.width-20;var s=this.width-20;if(i>r){s=Math.ceil(r*(a/i))}this.tileEditorMobileGrid.setSize(a,s);$("#tileEditorMobileCanvas").css("top","10px");$("#tileEditorMobileCanvas").css("left","10px")},setCharacters:function(e){var t=false;if(e.length!=this.characters.length){t=true}if(!t){for(var i=0;i<e.length;i++){if(e[i].length!=this.characters[i].length){t=true}if(!t){for(var r=0;r<e[i].length;r++){if(e[i][r]!=this.characters[i][r]){t=true;r=e[i].length;i=e.length;break}}}}}this.tileSet=this.editor.tileSetManager.getCurrentTileSet();this.setupTileEditor();this.characters=[];var a=true;var s=true;this.animated=false;this.ticksPerFrame=0;this.animatedType="";this.frames=0;for(var i=0;i<e.length;i++){this.characters.push([]);for(var r=0;r<e[i].length;r++){this.characters[i].push(e[i][r]);var o=this.tileSet.getTileProperties(e[i][r]);if(typeof o.animated!="undefined"&&o.animated!==false){if(this.animated&&this.ticksPerFrame==o.ticksPerFrame&&this.animatedType==o.animated&&this.frameCount==o.frameCount||a){this.animated=true;this.ticksPerFrame=o.ticksPerFrame;this.animatedType=o.animated;this.frameCount=o.frameCount}else{if(!a){s=false}}}else{if(!this.animated||a){this.animated=false}else{if(!a){s=false}}}a=false}}this.frame=0;$("#tileEditorMobileFrame").val(1);if(!s){this.mixedAnimation=true;this.updateAnimationOptions({hasMixed:true,selected:"mixed"});$("#tileEditorMobileAnimatedType").val("mixed")}else{this.mixedAnimation=false;this.updateAnimationOptions({hasMixed:false});if(this.animated){$("#tileEditorMobileAnimatedTicksPerFrame").val(this.ticksPerFrame);$("#tileEditorMobileAnimatedType").val(this.animatedType);$("#tileEditorMobileFrames").val(this.frameCount);$("#tileEditorMobileFrame").attr("max",this.frameCount);if(this.animatedType=="frames"){$("#tileEditorMobileFrameControls").show()}else{$("#tileEditorMobileFrameControls").hide()}}else{$("#tileEditorMobileAnimatedType").val("");$("#tileEditorMobileFrameControls").hide();$("#tileEditorMobileFrames").val(1);$("#tileEditorMobileFrame").attr("max",1)}}this.frame=0;$("#tileEditorMobileFrame").val(1);this.resize();this.tileEditorMobileGrid.setCharacters(e);this.editor.currentTile.refresh()},updateAnimationOptions:function(e){var t=false;if(typeof e.hasMixed!="undefined"){t=e.hasMixed}var i="";if(typeof e.selected!="undefined"){i=e.selected}var r=[{value:"",label:"No"},{value:"mixed",label:"Mixed"},{value:"left",label:"Scroll Left"},{value:"right",label:"Scroll Right"},{value:"up",label:"Scroll Up"},{value:"down",label:"Scroll Down"},{value:"blink",label:"Blink"},{value:"frames",label:"Frames"}];var a="";for(var s=0;s<r.length;s++){if(r[s].value!="mixed"||t){a+='<option value="'+r[s].value+'" ';if(r[s]==="selected"){a+=' selected="selected" '}a+=">"+r[s].label+"</option>"}}$("#tileEditorMobileAnimatedType").html(a)},setFrame:function(e){if(e>=this.frameCount){return}this.frame=e;$("#tileEditorMobileFrame").val(this.frame+1);this.tileEditorMobileGrid.setFrame(this.frame)},prevFrame:function(){var e=this.frame-1;if(e>=0){this.setFrame(e);$("#tileEditorMobileFrame").val(e+1)}},nextFrame:function(){var e=this.frame+1;if(e<this.frameCount){this.setFrame(e);$("#tileEditorMobileFrame").val(e+1)}},insertFrame:function(){for(var e=0;e<this.characters.length;e++){for(var t=0;t<this.characters[e].length;t++){this.tileSet.insertFrame(this.characters[e][t],this.frame);var i=this.tileSet.getTileProperties(this.characters[e][t]);frameCount=i.frameCount}}this.frameCount=frameCount;$("#tileEditorMobileFrames").val(frameCount);$("#tileEditorMobileFrame").attr("max",frameCount);this.setFrame(this.frame+1)},deleteFrame:function(){for(var e=0;e<this.characters.length;e++){for(var t=0;t<this.characters[e].length;t++){this.tileSet.deleteFrame(this.characters[e][t],this.frame);var i=this.tileSet.getTileProperties(this.characters[e][t]);frameCount=i.frameCount}}this.frameCount=frameCount;$("#tileEditorMobileFrames").val(frameCount);$("#tileEditorMobileFrame").attr("max",frameCount);if(this.frameCount==1||this.frame==0){this.setFrame(0)}else{this.setFrame(this.frame-1)}},setAnimated:function(e){console.error("shouldnt get here");var t=$("#tileEditorMobileAnimatedType").val();var i=parseInt($("#tileEditorMobileAnimatedTicksPerFrame").val(),10);if(isNaN(i)){i=6}for(var r=0;r<this.characters.length;r++){for(var a=0;a<this.characters[r].length;a++){this.tileSet.setAnimated(this.characters[r][a],e);this.tileSet.setAnimatedType(this.characters[r][a],t);this.tileSet.setAnimatedTicksPerFrame(this.characters[r][a],i)}}if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}},setTicksPerFrame:function(e){for(var t=0;t<this.characters.length;t++){for(var i=0;i<this.characters[t].length;i++){this.tileSet.setAnimatedTicksPerFrame(this.characters[t][i],e)}}},setAnimatedType:function(e){var t=true;if(e==""){t=false}var i=parseInt($("#tileEditorMobileAnimatedTicksPerFrame").val(),10);if(isNaN(i)){i=6}var r=0;for(var a=0;a<this.characters.length;a++){for(var s=0;s<this.characters[a].length;s++){this.tileSet.setAnimated(this.characters[a][s],t);if(t){this.tileSet.setAnimatedType(this.characters[a][s],e);this.tileSet.setAnimatedTicksPerFrame(this.characters[a][s],i)}var o=this.tileSet.getTileProperties(this.characters[a][s]);r=o.frameCount}}if(this.mixedAnimation){this.updateAnimationOptions({hasMixed:false,selected:e});$("#tileEditorMobileAnimatedType").val(e);this.mixedAnimation=false}if(e=="frames"){this.frameCount=r;$("#tileEditorMobileFrames").val(r);$("#tileEditorMobileFrame").attr("max",r);$("#tileEditorMobileFrameControls").show()}else{$("#tileEditorMobileFrameControls").hide()}this.setFrame(0);this.tileEditorMobileGrid.updateCharacter();for(var a=0;a<this.characters.length;a++){for(var s=0;s<this.characters[a].length;s++){this.tileSet.updateCharacterCurrentData(this.characters[a][s])}}if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}this.editor.currentTile.refresh()},selectC64ColorType:function(e,t){this.tileEditorMobileGrid.setC64ColorType(e);this.tileEditorMobileGrid.setColorIndex(t)},selectColorIndex:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();$("#tileEditorMobileMultiColor").css("background-color","#"+t.getHexString(e));this.tileEditorMobileGrid.setColorIndex(e)},selectSubPaletteColorIndex:function(e){this.editor.colorPaletteManager.colorSubPalettes.selectPaletteColor(e)},drawSelectedSubPaletteColor:function(){var e=this.tileEditorMobileGrid.getColorIndex();$(".tileEditorMobileSubPaletteColor").css({"border-width":"1px"});$("#tileEditorMobileSubPaletteColor-"+e).css({"border-width":"2px"})},draw:function(){this.tileEditorMobileGrid.draw()}};var TileEditorGrid=function(){this.character=false;this.characters=[];this.cells=[];this.canvas=null;this.context=null;this.clipboardCanvas=null;this.checkerboardCanvas=null;this.characterCanvas=null;this.characterContext=null;this.characterCursorCanvas=null;this.characterCursorContext=null;this.charsAcross=1;this.charsDown=1;this.pixelWidth=22;this.pixelHeight=22;this.charWidth=false;this.charHeight=false;this.cursorPositionX=-1;this.cursorPositionY=-1;this.lastPixelX=-1;this.lastPixelY=-1;this.frame=0;this.frameCount=1;this.mixedAnimation=false;this.visible=false;this.tileSet=null;this.drawCharacter=false;this.drawFGColor=0;this.drawBGColor=0;this.c64ColorType="cell";this.colorIndex=0;this.mode="pixelEdit";this.screenMode="";this.buttons=0;this.characterSelected=false;this.cellSelected=false;this.mouseOverCharacter=false;this.gridMouseEnter=false;this.gridMouseLeave=false;this.useCells=false;this.setMouseCursor=false;this.useCurrentTileColor=true;this.currentColor=2;this.drawPixelLines=true;this.scale=1};TileEditorGrid.prototype={init:function(e,t){this.editor=e;this.canvasElementId=t.canvasElementId;if(typeof t!="undefined"){if(typeof t.useCells){this.useCells=t.useCells}if(typeof t.setMouseCursor!="undefined"){this.setMouseCursor=t.setMouseCursor}if(typeof t.useCurrentTileColor!="undefined"){this.useCurrentTileColor=t.useCurrentTileColor}}},on:function(e,t){if(e=="characterselected"){this.characterSelected=t}if(e=="cellselected"){this.cellSelected=t}if(e=="mouseovercharacter"){this.mouseOverCharacter=t}if(e=="mouseenter"){this.gridMouseEnter=t}if(e=="mouseleave"){this.gridMouseLeave=t}},setMode:function(e){switch(e){case"pixelEdit":this.mode="pixelEdit";break;case"characterEdit":this.mode="characterEdit";break;case"characterEyedropper":this.mode="characterEyedropper";break;break}},setCurrentColor:function(e){this.currentColor=e},initEvents:function(){var t=this;this.canvas.addEventListener("touchstart",function(e){t.touchStart(e);e.preventDefault()},false);this.canvas.addEventListener("touchmove",function(e){t.touchMove(e);e.preventDefault()},false);this.canvas.addEventListener("touchend",function(e){t.touchEnd(e);e.preventDefault()},false);$("#"+this.canvasElementId).on("mousedown",function(e){t.mouseDown(e)});$("#"+this.canvasElementId).on("mousemove",function(e){t.mouseMove(e)});$("#"+this.canvasElementId).on("mouseup",function(e){t.mouseUp(e)});$("#"+this.canvasElementId).on("mouseleave",function(e){t.mouseLeave(e)});$("#"+this.canvasElementId).on("contextmenu",function(e){e.preventDefault()});$("#"+this.canvasElementId).on("mouseenter",function(e){t.mouseEnter(e)})},buildInterface:function(e){},setupTileEditor:function(){var e=this.editor.tileSetManager.getCurrentTileSet();if(this.canvas===null){this.canvas=document.getElementById(this.canvasElementId);if(this.canvas==null){return}this.initEvents()}if(this.charWidth==e.charWidth&&this.charHeight==e.charHeight){return}var t=220;var i=280;this.charWidth=e.charWidth;this.charHeight=e.charHeight;this.pixelWidth=Math.floor(t/this.charWidth);this.pixelHeight=Math.floor(i/this.charHeight);if(this.pixelWidth<this.pixelHeight){this.pixelHeight=this.pixelWidth}if(this.pixelHeight<this.pixelWidth){this.pixelWidth=this.pixelHeight}this.canvasScale=Math.floor(UI.devicePixelRatio);var r=this.pixelWidth*this.charWidth+1;var a=this.pixelHeight*this.charHeight+1;this.canvas.width=r*this.canvasScale;this.canvas.height=a*this.canvasScale;this.canvas.style.width=r+"px";this.canvas.style.height=a+"px";this.context=this.canvas.getContext("2d");this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;var s=(240-this.canvas.width)/2;this.canvas.style.left=s+"px";var o=this.canvas.height+10+10;document.getElementById("tileEditorControls").style.top=o+"px";this.characterCanvas=document.createElement("canvas")},setSize:function(e,t){if(!this.canvas){return}this.pixelWidth=Math.floor(e/this.charWidth);this.pixelHeight=Math.floor(t/this.charHeight);if(this.pixelWidth<this.pixelHeight){this.pixelHeight=this.pixelWidth}if(this.pixelHeight<this.pixelWidth){this.pixelWidth=this.pixelHeight}this.canvasScale=Math.floor(UI.devicePixelRatio);this.canvas.width=e*this.canvasScale;this.canvas.height=t*this.canvasScale;this.canvas.style.width=e+"px";this.canvas.style.height=t+"px";this.context=this.canvas.getContext("2d");this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;this.draw()},getHeight:function(){if(this.canvas==null){return 0}else{return this.canvas.height}},setDrawCharacter:function(e){this.drawCharacter=e},setDrawColor:function(e){this.drawFGColor=e},setCellColors:function(e){for(var t=0;t<this.cells.length;t++){for(var i=0;i<this.cells[t].length;i++){this.cells[t][i].fc=e}}this.draw()},setDrawBGColor:function(e){this.drawBGColor=e},setCellBGColors:function(e){for(var t=0;t<this.cells.length;t++){for(var i=0;i<this.cells[t].length;i++){this.cells[t][i].bc=e}}this.draw()},getCharacters:function(){return this.characters},getCells:function(){return this.cells},setCells:function(e){this.useCells=true;this.cells=[];for(var t=0;t<e.length;t++){this.cells[t]=[];for(var i=0;i<e[t].length;i++){this.cells[t][i]={};for(var r in e[t][i]){if(e[t][i].hasOwnProperty(r)){this.cells[t][i][r]=e[t][i][r]}}}}this.tileSet=this.editor.tileSetManager.getCurrentTileSet();this.setupTileEditor();this.draw()},setCharacters:function(e){var t=false;if(e.length!=this.characters.length){t=true}if(!t){for(var i=0;i<e.length;i++){if(e[i].length!=this.characters[i].length){t=true}if(!t){for(var r=0;r<e[i].length;r++){if(e[i][r]!=this.characters[i][r]){t=true;r=e[i].length;i=e.length;break}}}}}if(!t){return}this.tileSet=this.editor.tileSetManager.getCurrentTileSet();this.setupTileEditor();this.characters=[];var a=true;var s=true;this.animated=false;this.ticksPerFrame=0;this.animatedType="";this.frames=0;for(var i=0;i<e.length;i++){this.characters.push([]);for(var r=0;r<e[i].length;r++){var o=e[i][r];this.characters[i].push(o);if(o!=this.editor.tileSetManager.noTile){var l=this.tileSet.getTileProperties(e[i][r]);if(l!==false&&typeof l.animated!="undefined"&&l.animated!==false){if(this.animated&&this.ticksPerFrame==l.ticksPerFrame&&this.animatedType==l.animated&&this.frameCount==l.frameCount||a){this.animated=true;this.ticksPerFrame=l.ticksPerFrame;this.animatedType=l.animated;this.frameCount=l.frameCount}else{if(!a){s=false}}}else{if(!this.animated||a){this.animated=false}else{if(!a){s=false}}}}a=false}}this.frame=0;$("#tileEditorFrame").val(1);this.draw()},setFrame:function(e){this.frame=e;this.draw()},mouseEnter:function(e){if(this.gridMouseEnter){this.gridMouseEnter(e)}},mouseLeave:function(e){this.cursorPositionX=-1;this.cursorPositionY=-1;if(this.gridMouseLeave){this.gridMouseLeave(e)}this.draw()},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){this.buttons=2}if(e.metaKey&&this.buttons==1){this.buttons=4}},getCellColor:function(e,t){var i=this.editor.tileSetManager.getCurrentTileSet();var r=i.getTileCount();var a=this.editor.currentTile.color;if(this.useCells){if(t<this.cells.length&&e<this.cells[t].length){a=this.cells[t][e].fc}if(this.editor.getColorPerMode()=="character"){if(t<this.cells.length&&e<this.cells[t].length){var s=this.cells[t][e].t;if(s<r){a=i.getTileColor(s)}}}}else{if(this.editor.getColorPerMode()=="character"){if(t<this.characters.length&&e<this.characters[t].length){var s=this.characters[t][e];if(s<r){a=i.getTileColor(s)}}}}return a},toolStart:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;t=Math.floor(t*this.canvasScale/this.pixelWidth);i=Math.floor(i*this.canvasScale/this.pixelHeight);this.cursorCharacterX=Math.floor(t/this.charWidth);this.cursorCharacterY=Math.floor(i/this.charHeight);var r=this.editor.getScreenMode();var a=this.getCellColor(this.cursorCharacterX,this.cursorCharacterY);if(r==TextModeEditor.Mode.C64MULTICOLOR){if(a<8&&this.editor.graphic.getType()!=="sprite"){r=TextModeEditor.Mode.TEXTMODE}}if(t<0||t>=this.charWidth*this.charsAcross||i<0||i>=this.charHeight*this.charsDown){return}var s=this.mode;if(typeof e.altKey!="undefined"&&e.altKey){s="characterEyedropper"}if(s=="characterEdit"){if(this.drawCharacter!==false){if(this.useCells){this.cells[this.cursorCharacterY][this.cursorCharacterX].t=this.drawCharacter;this.cells[this.cursorCharacterY][this.cursorCharacterX].fc=this.drawFGColor;this.cells[this.cursorCharacterY][this.cursorCharacterX].bc=this.drawBGColor}else{this.characters[this.cursorCharacterY][this.cursorCharacterX]=this.drawCharacter}this.draw()}}else if(s=="characterEyedropper"){if(this.useCells){var o=this.cells[this.cursorCharacterY][this.cursorCharacterX];if(this.cellSelected){this.cellSelected(o)}}else{var l=this.characters[this.cursorCharacterY][this.cursorCharacterX];if(this.characterSelected){this.characterSelected(l)}}}else{if(r==TextModeEditor.Mode.TEXTMODE||r==TextModeEditor.Mode.C64ECM||r==TextModeEditor.Mode.C64STANDARD){if(this.getPixel(t,i)){this.mouseMode="erase"}else{this.mouseMode="draw"}if(this.mouseMode=="erase"){this.editor.history.startEntry("erase char pixels");this.erasePixel(t,i,r)}else if(this.mouseMode=="draw"){this.editor.history.startEntry("draw char pixels");this.drawPixel(t,i,r)}}if(r==TextModeEditor.Mode.C64MULTICOLOR){this.mouseMode="draw";this.editor.history.startEntry("draw char pixels");var n=Math.floor(t/2);var h=i;this.drawPixel(n,h,r)}if(r==TextModeEditor.Mode.NES||r==TextModeEditor.Mode.INDEXED||r==TextModeEditor.Mode.RGB){this.mouseMode="draw";var n=t;var h=i;this.drawPixel(n,h,r)}}},toolMove:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;t=Math.floor(t*this.canvasScale/this.pixelWidth);i=Math.floor(i*this.canvasScale/this.pixelHeight);var r=Math.floor(t/this.charWidth);var a=Math.floor(i/this.charHeight);var s=this.editor.getScreenMode();var o=this.getCellColor(r,a);if(s===TextModeEditor.Mode.C64MULTICOLOR){if(o<8&&this.editor.graphic.getType()!=="sprite"){s=TextModeEditor.Mode.TEXTMODE}}if(this.useCells){if(t<0||i<0||a>=this.cells.length||r>=this.cells[a].length){return}}else{if(t<0||i<0||a>=this.characters.length||r>=this.characters[a].length){return}}if(this.cursorCharacterX==r&&this.cursorCharacterY==a&&this.cursorPositionX==t&&this.cursorPositionY==i){}this.cursorCharacterX=r;this.cursorCharacterY=a;this.cursorPositionY=i%this.charHeight;this.cursorPositionX=t%this.charWidth;if(this.mouseOverCharacter){if(this.useCells){if(this.cursorCharacterY<this.characters.length&&this.cursorCharacterX<this.characters[this.cursorCharacterY].length){this.mouseOverCharacter(this.characters[this.cursorCharacterY][this.cursorCharacterX])}}else{if(this.cursorCharacterY<this.cells.length&&this.cursorCharacterX<this.cells[this.cursorCharacterY].length){this.mouseOverCharacter(this.cells[this.cursorCharacterY][this.cursorCharacterX].c)}}}if(this.mode=="characterEdit"){if(this.buttons&1){if(this.drawCharacter!==false){if(this.useCells){this.cells[this.cursorCharacterY][this.cursorCharacterX].t=this.drawCharacter;this.cells[this.cursorCharacterY][this.cursorCharacterX].fc=this.drawFGColor;this.cells[this.cursorCharacterY][this.cursorCharacterX].bc=this.drawBGColor}else{this.characters[this.cursorCharacterY][this.cursorCharacterX]=this.drawCharacter}}}this.draw()}if(this.mode=="pixelEdit"){if(t<0||t>=this.charWidth*this.charsAcross||i<0||i>=this.charHeight*this.charsDown){this.drawCursor(-1,-1);return}if(this.mouseMode=="erase"){if(this.setMouseCursor){UI.setCursor("erase")}if(t!=this.lastPixelX||i!=this.lastPixelY){this.lastPixelX=t;this.lastPixelY=i;this.erasePixel(t,i)}}else if(this.mouseMode=="draw"){if(this.setMouseCursor){UI.setCursor("draw")}if(s==TextModeEditor.Mode.TEXTMODE||s==TextModeEditor.Mode.C64ECM||s==TextModeEditor.Mode.C64STANDARD){if(t!=this.lastPixelX||i!=this.lastPixelY){this.lastPixelX=t;this.lastPixelY=i;this.drawPixel(t,i,s)}}if(s==TextModeEditor.Mode.C64MULTICOLOR){t=Math.floor(t/2);this.cursorPositionY=i;this.cursorPositionX=t;if(t!=this.lastPixelX||i!=this.lastPixelY){this.lastPixelX=t;this.lastPixelY=i;this.drawPixel(t,i,s)}}if(s==TextModeEditor.Mode.NES||s==TextModeEditor.Mode.INDEXED||s==TextModeEditor.Mode.RGB){if(t!=this.lastPixelX||i!=this.lastPixelY){this.lastPixelX=t;this.lastPixelY=i;this.drawPixel(t,i)}}}else{if(this.setMouseCursor){if(s===TextModeEditor.Mode.TEXTMODE||s===TextModeEditor.Mode.C64ECM||s===TextModeEditor.Mode.C64STANDARD){if(this.getPixel(t,i)){UI.setCursor("erase")}else{UI.setCursor("draw")}}else{UI.setCursor("draw")}}this.cursorPositionY=i%this.charHeight;this.cursorPositionX=t%this.charWidth;if(s==TextModeEditor.Mode.C64MULTICOLOR){this.cursorPositionX=Math.floor(t/2)%(this.charWidth/2)}this.draw()}}},toolEnd:function(e){if(this.useCells===false&&(this.characters.length==0||this.characters[0].length==0)){return}if(this.useCells&&(this.cells.length==0||this.cells[0].length==0)){return}if(this.editor.graphic.getOnlyViewBoundsDrawn()){this.editor.graphic.redraw({allCells:true})}this.editor.history.endEntry();this.lastPixelX=-1;this.lastPixelY=-1;this.mouseMode=false},touchStart:function(e){var t=e.touches;if(t.length==1){this.buttons=1;this.toolStart(t[0])}},touchMove:function(e){var t=e.touches;if(t.length==1){this.buttons=1;this.toolMove(t[0])}},touchEnd:function(e){},mouseDown:function(e){var t=0;this.buttons=1;if(!UI.isMobile.any()){t=e.button;this.setButtons(e);if(this.buttons&2){return}if(this.buttons&1){this.leftMouseUp=false}this.mouseIsDown=true;UI.captureMouse(this)}if(this.useCells===false&&(this.characters.length==0||this.characters[0].length==0)){return}if(this.useCells&&(this.cells.length==0||this.cells[0].length==0)){return}var i=e.clientX;var r=e.clientY;var a=$("#"+this.canvasElementId).offset();var s=$("#"+this.canvasElementId).width();var o=$("#"+this.canvasElementId).height();if(i>a.left&&i<a.left+s&&r>a.top&&r<a.top+o){this.toolStart(e)}},mouseMove:function(e){if(!UI.isMobile.any()){this.setButtons(e)}if(this.useCells===false&&(this.characters.length==0||this.characters[0].length==0)){return}if(this.useCells&&(this.cells.length==0||this.cells[0].length==0)){return}var t=e.clientX;var i=e.clientY;var r=$("#"+this.canvasElementId).offset();var a=$("#"+this.canvasElementId).width();var s=$("#"+this.canvasElementId).height();if(t>r.left&&t<r.left+a&&i>r.top&&i<r.top+s){this.toolMove(e)}else{this.drawCursor(-1,-1)}},mouseUp:function(e){this.toolEnd(e)},rotatePixels:function(e,t,i){var r=i;if(typeof i=="undefined"){r=this.editor.getScreenMode()}var a=[];for(var s=0;s<this.charHeight*this.charsDown;s++){a[s]=[];for(var o=0;o<this.charWidth*this.charsAcross;o++){a[s][o]=this.getPixel(o,s)}}if(r==TextModeEditor.Mode.C64MULTICOLOR){if(t==0&&e!=0){e*=2}}for(var s=0;s<this.charHeight*this.charsDown;s++){for(var o=0;o<this.charWidth*this.charsAcross;o++){var l=(o+e+this.charWidth*this.charsAcross)%(this.charWidth*this.charsAcross);var n=(s+t+this.charHeight*this.charsDown)%(this.charHeight*this.charsDown);this.setPixel(o,s,a[n][l],false)}}this.updateCharacter()},rotate:function(e,t){var i=[];for(var r=0;r<this.charHeight*this.charsDown;r++){i[r]=[];for(var a=0;a<this.charWidth*this.charsAcross;a++){i[r][a]=this.getPixel(a,r)}}this.editor.history.startEntry("rotate char pixels");for(var r=0;r<this.charHeight*this.charsDown;r++){for(var a=0;a<this.charWidth*this.charsAcross;a++){var s=r%(this.charWidth*this.charsAcross);var o=this.charHeight*this.charsDown-1-a;this.setPixel(a,r,i[o][s],false)}}this.editor.history.endEntry();this.updateCharacter()},flipH:function(e){var t=[];this.editor.history.startEntry("flip h pixels");var i=e;if(typeof e=="undefined"){i=this.editor.getScreenMode()}if(i==TextModeEditor.Mode.C64MULTICOLOR){for(var r=0;r<this.charHeight*this.charsDown;r++){for(var a=0;a<this.charWidth*this.charsAcross;a++){t[a]=this.getPixel(a,r)}for(var a=0;a<this.charWidth*this.charsAcross;a+=2){this.setPixel(this.charWidth*this.charsAcross-a-2,r,t[a],false);this.setPixel(this.charWidth*this.charsAcross-a-1,r,t[a+1],false)}}}else{for(var r=0;r<this.charHeight*this.charsDown;r++){for(var a=0;a<this.charWidth*this.charsAcross;a++){t[a]=this.getPixel(a,r)}for(var a=0;a<this.charWidth*this.charsAcross;a++){this.setPixel(this.charWidth*this.charsAcross-a-1,r,t[a],false)}}}this.editor.history.endEntry();this.updateCharacter()},flipV:function(){var e=[];this.editor.history.startEntry("flip v pixels");for(var t=0;t<this.charWidth*this.charsAcross;t++){for(var i=0;i<this.charHeight*this.charsDown;i++){e[i]=this.getPixel(t,i)}for(var i=0;i<this.charHeight*this.charsDown;i++){this.setPixel(t,this.charHeight*this.charsDown-i-1,e[i],false)}}this.editor.history.endEntry();this.updateCharacter()},invert:function(){this.editor.history.startEntry("invert pixels");for(var e=0;e<this.charHeight*this.charsDown;e++){for(var t=0;t<this.charWidth*this.charsAcross;t++){this.togglePixel(t,e,false)}}this.editor.history.endEntry();this.updateCharacter()},copyCharacter:function(){this.clipboard=[];for(var e=0;e<this.charHeight;e++){this.clipboard[e]=[];for(var t=0;t<this.charWidth;t++){this.clipboard[e][t]=this.getPixel(t,e)}}this.updateClipboardPreview()},setupClipboardCanvas:function(){if(!this.clipboardCanvas){this.clipboardCanvas=document.getElementById("tileEditorClipboard")}this.clipboardCanvas.width=this.charWidth*2;this.clipboardCanvas.height=this.charHeight*2;this.clipboardContext=this.clipboardCanvas.getContext("2d");this.clipboardImageData=this.clipboardContext.getImageData(0,0,this.clipboardCanvas.width,this.clipboardCanvas.height)},updateClipboardPreview:function(){this.setupClipboardCanvas();var e=2;for(var t=0;t<this.charHeight*e;t++){for(var i=0;i<this.charWidth*e;i++){var r=Math.floor(i/e);var a=Math.floor(t/e);var s=t*this.clipboardImageData.width*4+i*4;if(this.clipboard[a][r]){this.clipboardImageData.data[s]=255;this.clipboardImageData.data[s+1]=255;this.clipboardImageData.data[s+2]=255;this.clipboardImageData.data[s+3]=255}else{this.clipboardImageData.data[s]=0;this.clipboardImageData.data[s+1]=0;this.clipboardImageData.data[s+2]=0;this.clipboardImageData.data[s+3]=0}}}this.clipboardContext.putImageData(this.clipboardImageData,0,0)},pasteCharacter:function(){this.editor.history.startEntry("paste char pixels");for(var e=0;e<this.charHeight;e++){for(var t=0;t<this.charWidth;t++){this.setPixel(t,e,this.clipboard[e][t],false)}}this.editor.history.endEntry();this.updateCharacter()},clearCharacter:function(){this.editor.history.startEntry("clear char pixels");for(var e=0;e<this.charHeight*this.charsDown;e++){for(var t=0;t<this.charWidth*this.charsAcross;t++){this.setPixel(this.charWidth*this.charsAcross-t-1,e,0,false)}}this.editor.history.endEntry();this.updateCharacter()},getPixel:function(e,t){var i=Math.floor(e/this.charWidth);var r=Math.floor(t/this.charHeight);if(i>=this.charsAcross||r>=this.charsDown){return false}e=e%this.charWidth;t=t%this.charHeight;var a=0;if(this.useCells){a=this.cells[r][i].t}else{a=this.characters[r][i]}return this.tileSet.getPixel(a,e,t,this.frame)},setPixel:function(e,t,i,r){if(typeof r=="undefined"){r=true}var a=Math.floor(e/this.charWidth);var s=Math.floor(t/this.charHeight);if(a>=this.charsAcross||s>=this.charsDown){return false}e=e%this.charWidth;t=t%this.charHeight;var o=0;if(this.useCells){o=this.cells[s][a].t}else{o=this.characters[s][a]}this.tileSet.setPixel(o,e,t,i,false,this.frame);if(r){this.updateCharacter(o)}this.draw();return},setC64ColorType:function(e){this.c64ColorType=e},setColorIndex:function(e){this.colorIndex=e},getColorIndex:function(){return this.colorIndex},updateCharacter:function(e){var t=false;var i=this.editor.layers.getSelectedLayerObject();if(i&&i.getType()=="grid"&&i.getScreenMode()==TextModeEditor.Mode.C64ECM){t=true}if(typeof e=="undefined"){for(var r=0;r<this.characters.length;r++){for(var a=0;a<this.characters[r].length;a++){if(t){var s=Math.floor(this.characters[r][a]/256);var o=this.characters[r][a]%64+s*256;this.tileSet.updateCharacter(o);this.tileSet.updateCharacter(o+64);this.tileSet.updateCharacter(o+128);this.tileSet.updateCharacter(o+192)}else{this.tileSet.updateCharacter(this.characters[r][a])}}}}else{if(t){var s=Math.floor(e/256);e=e%64+s*256;this.tileSet.updateCharacter(e);this.tileSet.updateCharacter(e+64);this.tileSet.updateCharacter(e+128);this.tileSet.updateCharacter(e+192)}else{this.tileSet.updateCharacter(e)}}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true});this.editor.currentTile.canvasDrawCharacter();if(this.editor.tools.drawTools.tool=="type"){this.editor.tools.drawTools.typing.updateTypeCanvas()}},drawPixel:function(e,t,i){var r=i;if(typeof i=="undefined"){r=this.editor.getScreenMode()}else{}if(r==TextModeEditor.Mode.TEXTMODE||r==TextModeEditor.Mode.C64ECM||r==TextModeEditor.Mode.C64STANDARD){this.setPixel(e,t,1)}if(r==TextModeEditor.Mode.C64MULTICOLOR){if(this.editor.graphic.getType()=="sprite"){switch(this.c64ColorType){case"cell":this.setPixel(e*2,t,1);this.setPixel(e*2+1,t,0,true);break;case"background":this.setPixel(e*2,t,0);this.setPixel(e*2+1,t,0,true);break;case"multi1":this.setPixel(e*2,t,0);this.setPixel(e*2+1,t,1,true);break;case"multi2":this.setPixel(e*2,t,1);this.setPixel(e*2+1,t,1,true);break}}else{switch(this.c64ColorType){case"cell":this.setPixel(e*2,t,1);this.setPixel(e*2+1,t,1,true);break;case"background":this.setPixel(e*2,t,0);this.setPixel(e*2+1,t,0,true);break;case"multi1":this.setPixel(e*2,t,0);this.setPixel(e*2+1,t,1,true);break;case"multi2":this.setPixel(e*2,t,1);this.setPixel(e*2+1,t,0,true);break}}}if(r==TextModeEditor.Mode.RGB){var a=this.editor.colorPaletteManager.getCurrentColorPalette();var s=a.getARGB(this.colorIndex);this.setPixel(e,t,s)}if(r==TextModeEditor.Mode.NES||r==TextModeEditor.Mode.INDEXED){this.setPixel(e,t,this.colorIndex)}},togglePixel:function(e,t,i){if(this.getPixel(e,t)===1){this.setPixel(e,t,0,i)}else{this.setPixel(e,t,1,i)}},erasePixel:function(e,t){this.setPixel(e,t,0)},drawCursor:function(e,t,i,r){if(e!=this.cursorPositionX||t!=this.cursorPositionY){this.cursorPositionY=t%this.charHeight;this.cursorPositionX=e%this.charWidth;this.cursorCharacterX=i;this.cursorCharacterY=r;this.draw()}},setupCharacterCanvas:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i=e.getTileWidth();var r=e.getTileHeight();var a=i*this.charsAcross;var s=r*this.charsDown;var o=this.editor.layers.getSelectedLayerObject();if(o&&o.getType()=="grid"&&o.getScreenMode()==TextModeEditor.Mode.VECTOR){a=a*this.scale;s=s*this.scale}if(!this.characterCanvas){return}if(this.characterCanvas.width<a||this.characterCanvas.height<s||this.characterContext==null){this.characterCanvas.width=a;this.characterCanvas.height=s;this.characterContext=this.characterCanvas.getContext("2d")}},setupCheckerboardCanvas:function(){if(!this.checkerboardCanvas){this.checkerboardCanvas=document.createElement("canvas")}if(this.checkerboardContext==null||this.checkerboardCanvas.width!=this.canvas.width||this.checkerboardCanvas.height!=this.canvas.height){this.checkerboardCanvas.width=this.canvas.width;this.checkerboardCanvas.height=this.canvas.height;this.checkerboardContext=this.checkerboardCanvas.getContext("2d");var e=5;this.checkerboardContext.fillStyle="#cccccc";this.checkerboardContext.fillRect(0,0,this.checkerboardCanvas.width,this.checkerboardCanvas.height);var t=5;var i=Math.ceil(this.checkerboardCanvas.width/e);var r=Math.ceil(this.checkerboardCanvas.height/e);this.checkerboardContext.fillStyle="#bbbbbb";for(var a=0;a<r;a++){for(var s=0;s<i;s++){if((s+a)%2){this.checkerboardContext.fillRect(s*e,a*e,e,e)}}}}},drawCharCursor:function(){if(this.cursorPositionX<0||this.cursorPositionY<0){return}var e=this.editor.layers.getSelectedLayerObject();var t=this.cursorCharacterX;var i=this.cursorCharacterY;var r=this.editor.tileSetManager.getCurrentTileSet();var a=r.getTileWidth();var s=r.getTileHeight();if(this.characterCursorCanvas==null){this.characterCursorCanvas=document.createElement("canvas")}if(this.characterCursorContext==null||this.characterCursorCanvas.width!=a||this.characterCursorCanvas.height!=s){this.characterCursorCanvas.width=a;this.characterCursorCanvas.height=s;this.characterCursorContext=this.characterCursorCanvas.getContext("2d");this.characterCursorImageData=this.characterCursorContext.getImageData(0,0,this.characterCursorCanvas.width,this.characterCursorCanvas.height)}var o=this.characterCursorCanvas.width*this.characterCursorCanvas.height*4;var l=3;while(l<o){this.characterCursorImageData.data[l]=0;l+=4}var n={};n["imageData"]=this.characterCursorImageData;var h=this.editor.currentTile.getBGColor();n["color"]=this.getCellColor(t,i);n["bgColor"]=this.drawBGColor;if(this.editor.getColorPerMode()=="character"){n["color"]=r.getTileColor(this.drawCharacter);n["bgColor"]=r.getCharacterBGColor(this.drawCharacter)}n["character"]=this.drawCharacter;n["x"]=0;n["y"]=0;n["scale"]=1;n["select"]=false;n["highlight"]=false;n["backgroundIsTransparent"]=true;if(e.getScreenMode()==TextModeEditor.Mode.C64ECM){n["bgColor"]=e.getC64ECMColor(n["bgColor"]);var d=Math.floor(n["character"]/256);n["character"]=n["character"]%64+d*256}if(e.getScreenMode()===TextModeEditor.Mode.INDEXED){n["transparentColorIndex"]=e.getTransparentColorIndex()}if(e.getScreenMode()==TextModeEditor.Mode.VECTOR){n["context"]=this.context;n["x"]=t*a;n["y"]=i*s;n["scale"]=this.scale;r.drawCharacter(n)}else{r.drawCharacter(n);this.characterCursorContext.putImageData(this.characterCursorImageData,0,0);var c=t*a*this.scale;var f=i*s*this.scale;var u=a*this.scale;var p=s*this.scale;this.context.globalAlpha=.5;this.context.drawImage(this.characterCursorCanvas,0,0,a,s,c,f,u,p);this.context.globalAlpha=1}},drawTileCanvas:function(){if(!this.characterContext){return}var e=this.editor.getColorPerMode();var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i=this.editor.tileSetManager.getCurrentTileSet();var r=i.getTileCount();this.characterContext.clearRect(0,0,this.characterCanvas.width,this.characterCanvas.height);var a={};this.characterImageData=this.characterContext.getImageData(0,0,this.characterCanvas.width,this.characterCanvas.height);a["imageData"]=this.characterImageData;a["characterFrame"]=this.frame;a["backgroundIsTransparent"]=false;var s=this.editor.currentTile.getColor();if(!this.useCurrentTileColor){currentColor=this.currentColor}var o=this.editor.currentTile.getBGColor();var l=TextModeEditor.Mode.TEXTMODE;var n=this.editor.layers.getSelectedLayerObject();if(n&&n.getType()=="grid"){l=n.getScreenMode()}if(g_app.getMode()=="3d"){}else{if(l==TextModeEditor.Mode.C64MULTICOLOR){a["bgColorRGB"]="#ff0000";a["backgroundColor"]=n.getBackgroundColor();o=a["bgColor"];a["c64Multi1Color"]=n.getC64Multi1Color();a["c64Multi2Color"]=n.getC64Multi2Color()}if(l===TextModeEditor.Mode.INDEXED){a["transparentColorIndex"]=n.getTransparentColorIndex();a["backgroundIsTransparent"]=false}}for(var h=0;h<this.charsDown;h++){for(var d=0;d<this.charsAcross;d++){var c=0;var s=this.getCellColor(d,h);if(this.useCells){c=this.cells[h][d].t;a["color"]=s;a["bgColor"]=this.cells[h][d].bc}else{c=this.characters[h][d];if(this.screenMode==TextModeEditor.Mode.TEXTMODE||this.screenMode==TextModeEditor.Mode.C64STANDARD||this.screenMode==TextModeEditor.Mode.C64ECM||this.screenMode==TextModeEditor.Mode.C64MULTICOLOR&&s<8&&this.editor.graphic.getType()!=="sprite"){a["colorRGB"]=14540253;a["bgColor"]=this.editor.colorPaletteManager.noColor}else{a["color"]=s;a["bgColor"]=o}}if(typeof c!="undefined"&&c!==false&&c<r){if(e=="character"){var f=i.getTileColor(c);var o=i.getCharacterBGColor(c);a["colorRGB"]=t.getHex(f);a["color"]=f;a["bgColor"]=o}a["character"]=c;if(l==TextModeEditor.Mode.C64ECM){var u=Math.floor(a["character"]/64)%4;var p=Math.floor(a["character"]/256);a["bgColor"]=n.getC64ECMColor(u);a["character"]=a["character"]%64+p*256}a["x"]=d*this.charWidth;a["y"]=h*this.charHeight;a["scale"]=1;a["select"]=false;a["highlight"]=false;if(l==TextModeEditor.Mode.VECTOR){a["scale"]=this.scale;a["context"]=this.characterContext}i.drawCharacter(a)}}}if(l!=TextModeEditor.Mode.VECTOR){this.characterContext.putImageData(this.characterImageData,0,0)}},drawGrid:function(){var e=false;var t=this.editor.getColorPerMode();var i=this.editor.tileSetManager.getCurrentTileSet();var r=i.getTileCount();if(this.useCells){if(this.cells.length==0||this.cells[0].length==0){return}this.screenMode=this.editor.getScreenMode();if(this.screenMode==TextModeEditor.Mode.C64MULTICOLOR){var a=TextModeEditor.Mode.C64MULTICOLOR;if(this.cells[0][0].fc<8&&this.editor.graphic.getType()!=="sprite"){a=TextModeEditor.Mode.TEXTMODE}for(var s=0;s<this.cells.length;s++){for(var o=0;o<this.cells[0].length;o++){var l=this.cells[s][o].fc;if(t=="character"){var n=this.cells[s][o].t;l=i.getTileColor(n)}if(this.editor.graphic.getType()!=="sprite"){if(a==TextModeEditor.Mode.TEXTMODE&&l>=8){a=TextModeEditor.Mode.C64MULTICOLOR;e=true}if(a==TextModeEditor.Mode.C64MULTICOLOR&&l<8){a=TextModeEditor.Mode.TEXTMODE;e=true}}}}this.screenMode=a}}else{this.screenMode=this.editor.getScreenMode();if(this.screenMode==TextModeEditor.Mode.C64MULTICOLOR){var a=TextModeEditor.Mode.C64MULTICOLOR;var l=this.editor.currentTile.getColor();if(t=="character"){a=false;for(var s=0;s<this.characters.length;s++){for(var o=0;o<this.characters[0].length;o++){var h=this.characters[s][o];if(typeof h!="undefined"&&h!==false&&h<r){var l=i.getTileColor(h);if(a===false){if(l>=8){a=TextModeEditor.Mode.C64MULTICOLOR}else{a=TextModeEditor.Mode.TEXTMODE}}else if(a==TextModeEditor.Mode.TEXTMODE&&l>=8){a=TextModeEditor.Mode.C64MULTICOLOR;e=true}else if(a==TextModeEditor.Mode.C64MULTICOLOR&&l<8){a=TextModeEditor.Mode.TEXTMODE;e=true}}}}}else{if(l<8){a=TextModeEditor.Mode.TEXTMODE}}this.screenMode=a}}var d=1;if(this.screenMode==TextModeEditor.Mode.C64MULTICOLOR){d=2}if(e){this.context.strokeStyle=styles.textMode.tileEditorGridLines;this.context.beginPath();for(var c=0;c<=this.charHeight*this.charsDown;c++){this.context.moveTo(this.offsetX+0,this.offsetY+c*this.pixelHeight+.5);this.context.lineTo(this.offsetX+this.charWidth*this.charsAcross*this.pixelWidth,this.offsetY+c*this.pixelHeight+.5)}var a="";if(this.useCells){for(var s=0;s<this.cells.length;s++){for(var o=0;o<this.cells[0].length;o++){var f=this.offsetX+o*this.charWidth*this.pixelWidth;var u=this.offsetY+s*this.charHeight*this.pixelHeight;var l=this.cells[s][o].fc;if(t=="character"){var n=this.cells[s][o].t;l=i.getTileColor(n)}if(l>=8){a=TextModeEditor.Mode.C64MULTICOLOR;d=2}if(l<8){a=TextModeEditor.Mode.TEXTMODE;d=1}if(this.drawPixelLines){for(var c=0;c<this.charWidth;c+=d){this.context.moveTo(f+c*this.pixelWidth+.5,u+0);this.context.lineTo(f+c*this.pixelWidth+.5,u+this.charHeight*this.pixelHeight)}}}}}else{for(var s=0;s<this.characters.length;s++){for(var o=0;o<this.characters[0].length;o++){var f=this.offsetX+o*this.charWidth*this.pixelWidth;var u=this.offsetY+s*this.charHeight*this.pixelHeight;var l=i.getTileColor(this.characters[s][o]);if(l>=8){a=TextModeEditor.Mode.C64MULTICOLOR;d=2}if(l<8){a=TextModeEditor.Mode.TEXTMODE;d=1}if(this.drawPixelLines){for(var c=0;c<this.charWidth;c+=d){this.context.moveTo(f+c*this.pixelWidth+.5,u+0);this.context.lineTo(f+c*this.pixelWidth+.5,u+this.charHeight*this.pixelHeight)}}}}}this.context.stroke();this.context.strokeStyle=styles.textMode.tileEditorGridBorder;this.context.beginPath();for(var c=0;c<=this.charsAcross;c++){this.context.moveTo(this.offsetX+c*this.pixelWidth*this.charWidth+.5,this.offsetY+0);this.context.lineTo(this.offsetX+c*this.pixelWidth*this.charWidth+.5,this.offsetY+this.charHeight*this.charsDown*this.pixelHeight)}for(var c=0;c<=this.charsDown;c++){this.context.moveTo(this.offsetX+0,this.offsetY+c*this.pixelHeight*this.charHeight+.5);this.context.lineTo(this.offsetX+this.charWidth*this.charsAcross*this.pixelWidth,this.offsetY+c*this.pixelHeight*this.charHeight+.5)}this.context.stroke()}else{if(this.drawPixelLines){this.context.strokeStyle=styles.textMode.tileEditorGridLines;this.context.beginPath();for(var c=0;c<=this.charWidth*this.charsAcross;c+=d){this.context.moveTo(this.offsetX+c*this.pixelWidth+.5,this.offsetY+0);this.context.lineTo(this.offsetX+c*this.pixelWidth+.5,this.offsetY+this.charHeight*this.charsDown*this.pixelHeight)}for(var c=0;c<=this.charHeight*this.charsDown;c++){this.context.moveTo(this.offsetX+0,this.offsetY+c*this.pixelHeight+.5);this.context.lineTo(this.offsetX+this.charWidth*this.charsAcross*this.pixelWidth,this.offsetY+c*this.pixelHeight+.5)}this.context.stroke()}this.context.strokeStyle=styles.textMode.tileEditorGridBorder;this.context.beginPath();for(var c=0;c<=this.charsAcross;c++){this.context.moveTo(this.offsetX+c*this.pixelWidth*this.charWidth+.5,this.offsetY+0);this.context.lineTo(this.offsetX+c*this.pixelWidth*this.charWidth+.5,this.offsetY+this.charHeight*this.charsDown*this.pixelHeight)}for(var c=0;c<=this.charsDown;c++){this.context.moveTo(this.offsetX+0,this.offsetY+c*this.pixelHeight*this.charHeight+.5);this.context.lineTo(this.offsetX+this.charWidth*this.charsAcross*this.pixelWidth,this.offsetY+c*this.pixelHeight*this.charHeight+.5)}this.context.stroke()}},draw:function(){if(!this.characterCanvas||!this.canvas){return}var e=this.editor.tileSetManager.getCurrentTileSet();if(!e){return}this.offsetX=0;this.offsetY=0;var t=this.editor.colorPaletteManager.getCurrentColorPalette();this.charWidth=e.getTileWidth();this.charHeight=e.getTileHeight();this.screenMode=this.editor.getScreenMode();var i=this.editor.currentTile.color;if(!this.useCurrentTileColor){i=this.currentColor}if(this.screenMode==TextModeEditor.Mode.C64MULTICOLOR){if(i<8){this.screenMode=TextModeEditor.Mode.TEXTMODE}}if(this.useCells){if(this.cells==null||this.cells.length==0){return}this.charsAcross=this.cells[0].length;this.charsDown=this.cells.length}else{if(this.characters==null||this.characters.length==0){return}this.charsAcross=this.characters[0].length;this.charsDown=this.characters.length}var r=this.editor.layers.getSelectedLayerObject();this.setupCharacterCanvas();this.drawTileCanvas();var a=this.charWidth*this.charsAcross;var s=this.charHeight*this.charsDown;var o=Math.floor((this.canvas.width-1)/a);var l=Math.floor((this.canvas.height-1)/s);if(o>l){o=l}else{l=o}if(o<1||l<1){o=1;l=1}this.pixelWidth=o;this.pixelHeight=l;this.scale=o;var n=0;var h=0;var d=this.scale*a;var c=this.scale*s;if(this.screenMode==TextModeEditor.Mode.TEXTMODE||this.screenMode==TextModeEditor.Mode.C64ECM||this.screenMode==TextModeEditor.Mode.C64STANDARD){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}else if(this.screenMode==TextModeEditor.Mode.INDEXED||this.screenMode==TextModeEditor.Mode.RGB){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.setupCheckerboardCanvas();this.context.drawImage(this.checkerboardCanvas,0,0,d,c,0,0,d,c)}else{this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var f=r.getBackgroundColor();var u=t.getHexString(f);this.context.fillStyle="#"+u;this.context.fillRect(n,h,d,c)}if(this.screenMode==TextModeEditor.Mode.VECTOR){this.context.drawImage(this.characterCanvas,0,0)}else{this.context.drawImage(this.characterCanvas,0,0,a,s,n,h,d,c)}if(!UI.isMobile.any()){if(this.mode=="pixelEdit"){var p=(this.cursorPositionX+this.cursorCharacterX*this.charWidth)*o;var v=(this.cursorPositionY+this.cursorCharacterY*this.charHeight)*l;this.screenMode=this.editor.getScreenMode();if(this.screenMode==TextModeEditor.Mode.C64MULTICOLOR){if(typeof this.cursorCharacterX!="undefined"&&typeof this.cursorCharacterY!="undefined"){var g=this.getCellColor(this.cursorCharacterX,this.cursorCharacterY);if(g<8){this.screenMode=TextModeEditor.Mode.TEXTMODE}}}if(this.screenMode==TextModeEditor.Mode.C64MULTICOLOR){p=(this.cursorPositionX*2+this.cursorCharacterX*this.charWidth)*o;o=o*2}var m=o;var y=this.pixelHeight;if(this.screenMode==TextModeEditor.Mode.RGB){var b=this.colorIndex>>>16&255;var C=this.colorIndex>>>8&255;var x=this.colorIndex&255;var S=(this.colorIndex>>>24&255)/255;this.context.fillStyle="rgba("+b+","+C+","+x+","+S+")"}else if(this.screenMode==TextModeEditor.Mode.INDEXED){this.context.fillStyle="#"+t.getHexString(this.colorIndex)}else if(this.screenMode==TextModeEditor.Mode.C64MULTICOLOR&&r&&typeof r.getC64Multi1Color!="undefined"){var P=0;switch(this.c64ColorType){case"cell":P=this.editor.currentTile.getColor();break;case"background":P=r.getBackgroundColor();break;case"multi1":P=r.getC64Multi1Color();break;case"multi2":P=r.getC64Multi2Color();break}this.context.fillStyle="#"+t.getHexString(P)}else{this.context.fillStyle="#ffffff"}this.context.globalAlpha=.5;this.context.fillRect(this.offsetX+p,this.offsetY+v,m,y);this.context.globalAlpha=1}}if(this.mode=="characterEdit"){this.drawCharCursor()}this.drawGrid()}};var GlyphEditor=function(){this.character=false;this.characters=[];this.clipboardCanvas=null;this.canvas=null;this.tile=false;this.tileSet=null};GlyphEditor.prototype={init:function(e){this.editor=e;this.glyphEditorCanvas=new GlyphEditorCanvas;this.glyphEditorCanvas.init(e,{canvasElementId:"glyphEditorCanvas",setMouseCursor:true})},initEvents:function(){var e=this;$("#glyphEditorCloseButton").on("click",function(){e.editor.tileEditor.toggleVisible()})},setTile:function(e){this.tile=e;var t=this.editor.tileSetManager.getCurrentTileSet();if(!t){return}var i=t.getType();if(i!="vector"){return}console.log("vector set tile = "+this.tile);this.glyphEditorCanvas.setTile(e)}};var GlyphEditorCanvas=function(){this.canvasElementId=false;this.canvas=null;this.tile=false};GlyphEditorCanvas.prototype={init:function(e,t){this.editor=e;this.canvasElementId=t.canvasElementId;this.setupGlyphEditor()},setupGlyphEditor:function(){if(this.canvas===null){this.canvas=document.getElementById(this.canvasElementId);if(this.canvas==null){return}this.initEvents();this.resize()}},initEvents:function(){var t=this;$("#"+this.canvasElementId).on("mousedown",function(e){t.mouseDown(e)});$("#"+this.canvasElementId).on("mousemove",function(e){t.mouseMove(e)});$("#"+this.canvasElementId).on("mouseup",function(e){t.mouseUp(e)});$("#"+this.canvasElementId).on("mouseleave",function(e){t.mouseLeave(e)});$("#"+this.canvasElementId).on("contextmenu",function(e){e.preventDefault()});$("#"+this.canvasElementId).on("mouseenter",function(e){t.mouseEnter(e)})},resize:function(){this.context=this.canvas.getContext("2d")},setTile:function(e){this.tile=e;this.draw()},draw:function(){if(this.tile===false){return}if(this.context==null){return}var e=this.editor.tileSetManager.getCurrentTileSet();if(!e){return}var t=0;var i=0;var r=this.canvas.width;var a=this.canvas.height;this.context.fillStyle="#111111";this.context.fillRect(t,i,r,a);var s=e.getGlyphPath(this.tile);if(s!==null){var o=r;var l=e.getFontScale();var n=o*l;var h=e.getFontAscent();this.context.setTransform(n,0,0,-n,t,i+h*n);this.context.fillStyle="#eeeeee";this.context.fill(s);this.context.setTransform(1,0,0,1,0,0)}},mouseDown:function(e){},mouseMove:function(e){},mouseUp:function(e){},mouseEnter:function(e){},mouseLeave:function(e){}};var Tools=function(){this.editor=null;this.mode="draw";this.drawTools=null};Tools.prototype={init:function(e){this.editor=e},buildInterface:function(e){var t=UI.create("UI.Panel");e.add(t);this.drawTools=new DrawTools;this.drawTools.init(this.editor);this.drawTools.buildInterface(t);this.pixelDrawTools=new PixelDrawTools;this.pixelDrawTools.init(this.editor);this.pixelDrawTools.buildInterface(t)},keyDown:function(e){var t=this.drawTools.tool;var i=e.altKey;if(i){var r=false;if(e.keyCode>=49&&e.keyCode<=56){r=e.keyCode-49;if(e.shiftKey){r+=8}}if(r!==false){this.editor.currentTile.setColor(r);return}}this.drawTools.keyDown(e)},keyUp:function(e){if(typeof this.editor.gridView2d!="undefined"){this.editor.gridView2d.keyUp(e)}if(this.drawTools.tool=="type"){this.drawTools.typing.keyUp(e)}if(this.drawTools.tool!="type"){this.drawTools.keyUp(e)}},keyPress:function(e){if(this.drawTools.tool=="type"){this.drawTools.typing.keyPress(e)}if(this.drawTools.tool!="type"){this.drawTools.keyPress(e)}}};var DrawTools=function(){this.editor=null;this.tool="pen";this.shapes=null;this.typing=null;this.pixelCharacterDraw=null;this.lineSegmentDraw=null;this.pixelDraw=null;this.invertTool=null;this.cornersTool=null;this.fill=null;this.select=null;this.pixelSelect=null;this.drawCharacter=true;this.drawColor=true;this.drawBGColor=true;this.drawToolsPopup=null;this.mirrorH=false;this.mirrorHX=20;this.mirrorV=false;this.mirrorVY=false;this.saveCurrentTiles=false;this.debugVisible=false};DrawTools.prototype={init:function(e){this.editor=e;this.shapes=new Shapes;this.shapes.init(e);this.typing=new Typing;this.typing.init(e);this.pixelCharacterDraw=new PixelCharacterDraw;this.pixelCharacterDraw.init(e);this.lineSegmentDraw=new LineSegmentDraw;this.lineSegmentDraw.init(e);this.cornersTool=new CornersTool;this.cornersTool.init(e);this.invertTool=new InvertTool;this.invertTool.init(e);this.pixelDraw=new PixelDraw;this.pixelDraw.init(e);this.fill=new Fill;this.fill.init(e);this.select=new Select;this.select.init(e);this.pixelSelect=new PixelSelect;this.pixelSelect.init(e)},initToolSettingEvents:function(){var t=this;this.initToolSettingsCurrentTileEvents();var e=g_app.getPref("textmode.toolsPanelVisible")!=="no";if(e){$("#tileToolsOpenButtonHolder").hide()}$("#tileFlipH").on("click",function(){t.editor.currentTile.flipH2d()});$("#tileFlipV").on("click",function(){t.editor.currentTile.flipV2d()});$("#tileRotate").on("click",function(){t.editor.currentTile.rotate2d()});$("#currentDrawToolHolder").on("click",function(){t.showDrawToolsPopup()});$("#tileToolsOpenButton").on("click",function(){t.editor.setToolsVisible(true)});$("input[name=drawChanges]").on("click",function(e){t.setDrawMode()});$("input[name=drawMirror]").on("click",function(e){t.setDrawMode()});$("#spriteFlipH").on("click",function(){t.pixelDraw.flipH()});$("#spriteFlipV").on("click",function(){t.pixelDraw.flipV()});$("#spriteRotate").on("click",function(){t.pixelDraw.rotate()});$("#spriteInvert").on("click",function(){t.pixelDraw.invert()});this.pixelDraw.c64MulticolorTypeControl=new C64MulticolorTypeControl;this.pixelDraw.c64MulticolorTypeControl.init(t.editor,{elementId:"pixelToolSettings-c64multicolor"});$("input[name=charPixelToolMode]").on("click",function(e){t.pixelCharacterDraw.setMode($("input[name=charPixelToolMode]:checked").val())});$("input[name=lineSegmentToolMode]").on("click",function(e){t.lineSegmentDraw.setMode($("input[name=lineSegmentToolMode]:checked").val())});$("#lineSegmentToolInvert").on("click",function(e){t.lineSegmentDraw.setInvert($(this).is(":checked"))})},showDrawToolsPopup:function(){var e=110;var t=60;if(g_app.isMobile()){var i=$("#mobileMenuCurrentTools").offset();e=i.left-10;t=i.top+42}else{var i=$("#currentDrawToolHolder").offset();e=i.left-8;t=i.top+30}var r=0;var a=0;var s=function(e){};if(this.drawToolsPopup==null){this.drawToolsPopup=new DrawToolsPopup;var o=this;this.drawToolsPopup.init(this.editor,function(){o.drawToolsPopup.show(e,t,r,a,s)})}else{this.drawToolsPopup.show(e,t,r,a,s)}},initMobileToolSettingEvents:function(){var i=this;this.pixelDraw.c64MulticolorTypeMobileControl=new C64MulticolorTypeControl;this.pixelDraw.c64MulticolorTypeMobileControl.init(i.editor,{elementId:"pixelToolSettingsMobile-c64multicolor"});$("input[name=drawChangesMobile]").on("click",function(e){i.setDrawMode()});$("input[name=drawMirrorMobile]").on("click",function(e){i.setDrawMode()});$("#pixelToolSettingsMobile-monochrome .mobileRadio").on("click",function(){var e=$(this).parent();e.children(".mobileRadio").removeClass("mobileRadioSelected");$(this).addClass("mobileRadioSelected");var t=$(this).attr("data-value");i.pixelDraw.setTool(t)});$("#selectMobileDrawUsingSelection").on("click",function(){i.select.selectionToPen();i.select.unselectAll();i.setDrawTool("pen")});$("#selectMobileDeselect").on("click",function(){i.select.unselectAll()});$("#selectMobileClear").on("click",function(){i.select.clear()});$("#selectMobileFlipHButton").on("click",function(){i.select.flipH()});$("#selectMobileFlipVButton").on("click",function(){i.select.flipV()});$("#selectMobileMoveButton").on("click",function(){i.setDrawTool("move")});$("#pixelselectMobileDeselect").on("click",function(){i.pixelSelect.unselectAll()});$("#pixelselectMobileClear").on("click",function(){i.pixelSelect.clear()});$("#pixelselectMobileCut").on("click",function(){i.pixelSelect.cut()});$("#pixelselectMobileCopy").on("click",function(){i.pixelSelect.copy()});$("#pixelselectMobilePaste").on("click",function(){i.pixelSelect.paste()});$("#pixelselectMobileFlipV").on("click",function(){i.pixelDraw.flipV()});$("#pixelselectMobileFlipH").on("click",function(){i.pixelDraw.flipH()});$("#pixelDrawShapeFillMobile").on("click",function(){i.pixelDraw.setFillShape($(this).is(":checked"))})},getTools:function(){this.toolMap={pen:{label:TextStore.get("Pencil"),isMobileTool:true,icon:"icons/pen@2x.png",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsPencil.key},erase:{label:TextStore.get("Blank"),isMobileTool:true,icon:"icons/erase@2x.png",mobileIcon:"icons/svg/glyphicons-basic-250-eraser.svg",key:keys.textMode.toolsErase.key},fill:{label:TextStore.get("Fill Bucket"),isMobileTool:true,icon:"icons/fill@2x.png",mobileIcon:"icons/svg/glyphicons-basic-245-fill.svg",key:keys.textMode.toolsBucket.key},eyedropper:{label:TextStore.get("Eyedropper"),isMobileTool:true,icon:"icons/eyedropper@2x.png",mobileIcon:"icons/svg/glyphicons-basic-91-eyedropper.svg",key:keys.textMode.toolsEyedropper.key},line:{label:TextStore.get("Line"),isMobileTool:true,icon:"icons/line@2x.png",mobileIcon:"icons/svg/slash.svg",key:keys.textMode.toolsShape.key},rect:{label:TextStore.get("Rect"),isMobileTool:true,icon:"icons/rect@2x.png",mobileIcon:"icons/svg/square.svg",key:keys.textMode.toolsShape.key},oval:{label:TextStore.get("Oval"),isMobileTool:true,icon:"icons/oval@2x.png",mobileIcon:"icons/svg/circle.svg",key:keys.textMode.toolsShape.key},select:{label:TextStore.get("Marquee"),isMobileTool:true,icon:"icons/select@2x.png",mobileIcon:"icons/select@2x.png",key:keys.textMode.toolsMarquee.key},charpixel:{label:TextStore.get("Char Pixel"),isMobileTool:true,icon:"icons/charpixel@2x.png",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsCharPixel.key},linesegment:{label:TextStore.get("Line Segment"),isMobileTool:false,icon:"icons/linesegment@2x.png",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:false},type:{label:TextStore.get("Type"),isMobileTool:false,icon:"icons/type@2x.png",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsType.key},pixel:{label:TextStore.get("Pixel"),isMobileTool:true,icon:"icons/pixel@2x.png",mobileIcon:"icons/pixel.png",key:keys.textMode.toolsPixel.key},block:{label:TextStore.get("Meta Tile"),isMobileTool:true,icon:"icons/block@2x.png",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsBlock.key},zoom:{label:TextStore.get("Zoom"),isMobileTool:false,icon:"icons/zoom@2x.png",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsZoom.key},hand:{label:TextStore.get("Hand"),isMobileTool:true,icon:"icons/hand@2x.png",mobileIcon:"icons/svg/glyphicons-basic-457-hand-open.svg",key:keys.textMode.toolsHand.key},move:{label:TextStore.get("Move"),isMobileTool:true,icon:"icons/move@2x.png",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsMove.key},rotate:{label:TextStore.get("Rotate"),isMobileTool:false,icon:"",mobileIcon:"icons/svg/glyphicons-basic-494-rotate-horizontal.svg"},pixelselect:{label:TextStore.get("Marquee"),isMobileTool:false,icon:"",mobileIcon:"icons/select@2x.png",key:false},pixelzoom:{label:TextStore.get("Zoom"),isMobileTool:false,icon:"",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsZoom.key},pixelhand:{label:TextStore.get("Hand"),isMobileTool:false,icon:"",mobileIcon:"icons/svg/glyphicons-basic-457-hand-open.svg",key:keys.textMode.toolsHand.key},pixelmove:{label:TextStore.get("Move"),isMobileTool:false,icon:"",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsMove.key}};return this.toolMap},getToolLabel:function(e){this.getTools();if(this.toolMap.hasOwnProperty(e)){var t=this.toolMap[e].label;if(this.toolMap[e].key!==false){t+=" ("+this.toolMap[e].key+")"}return t}return e},initMobileSidePanelContent:function(){var e="toolsMobileCurrentTile";var t=document.getElementById(e);var i=60;var r=60;var a=Math.floor(UI.devicePixelRatio);t.width=i*a;t.height=r*a;t.style.width=i+"px";t.style.height=r+"px";var s=this;t.addEventListener("click",function(e){s.editor.currentTile.chooseCharacterMobile(e)},false);$("#"+e).on("contextmenu",function(e){var t=s.editor.currentTile.getCharacters();if(t.length>0&&t[0].length>0){s.editor.showTileEditor({character:t[0][0]})}e.preventDefault()});this.checkMobileToolScroll()},initMobileSidePanelEvents:function(){var i=this;$(".drawToolMobileSide").on("click",function(){var e=$(this).attr("data-type");i.setDrawTool(e)});$(".nesPalettePickerMobile").on("click",function(e){var t={};i.editor.colorPaletteManager.colorSubPalettes.showMobilePicker(t)});$(".foregroundColorMobile").on("click",function(e){var t={};t.colorPickedCallback=function(e){i.editor.currentTile.setColor(e.color)};t.mode=i.editor.getScreenMode();t.currentColor=i.editor.currentTile.getColor();t.type="cellcolor";i.editor.colorPaletteManager.showColorPickerMobile(t)});$(".cellBackgroundColorMobile").on("click",function(e){var t={};t.colorPickedCallback=function(e){i.editor.currentTile.setColor(e.color)};t.mode=i.editor.getScreenMode();t.currentColor=i.editor.currentTile.getColor();t.type="cellbg";i.editor.colorPaletteManager.showColorPickerMobile(t)});$(".backgroundColorMobile").on("click",function(e){var t={};t.colorPickedCallback=function(e){i.editor.setBackgroundColor(e.color)};t.mode=i.editor.getScreenMode();t.currentColor=i.editor.graphic.getBackgroundColor();t.type="background";i.editor.colorPaletteManager.showColorPickerMobile(t)});$("#toolIconHolderMobile").on("scroll",function(e){i.checkMobileToolScroll()});$("#drawToolsMobileSide").on("contextmenu",function(e){e.preventDefault()});$("#layersButtonMobile").on("click",function(){i.editor.layers.showMobileLayerChooser()})},initMobileEvents:function(){var t=this;$(".drawToolMobile").on("click",function(){var e=$(this).attr("data-type");t.setDrawTool(e)})},checkMobileToolScroll:function(){var e=$("#toolIconHolderMobile").height();var t=$("#toolIconsMobile").height();var i=$("#toolIconsMobile").position();if(typeof i=="undefined"){return}var r=i.top;if(r<-2){$("#toolIconsScrollTop").show()}else{$("#toolIconsScrollTop").hide()}if(r+t-2>e){$("#toolIconsScrollBottom").show()}else{$("#toolIconsScrollBottom").hide()}},initEvents:function(){var l=this;$("#tileToolsCloseButton").on("click",function(){l.editor.setToolsVisible(false)});$(".drawTool").on("click",function(){var e=$(this).attr("id");var t=e.lastIndexOf("_");e=e.substring(t+1);l.setDrawTool(e)});$(".drawTool").on("mouseover",function(){var e=$(this).attr("id");e=e.substring("drawTool_".length);var t=l.getToolLabel(e);$("#currentTool").html(t)});$(".drawTool").on("mouseleave",function(){var e=l.getToolLabel(l.tool);$("#currentTool").html(e)});$("#switchColors").on("click",function(e){l.editor.currentTile.switchColors()});$("#background3dColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){console.log("colour chosen:"+e);l.editor.grid3d.setBackgroundColor(e)};t.mode=l.editor.getScreenMode();var i=e.pageX;var r=e.pageY;t.currentColor=l.editor.currentTile.getColor();t.type="cellcolor";l.editor.colorPaletteManager.showColorPicker(i,r,t)});$(".foregroundColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){l.editor.currentTile.setColor(e)};t.mode=l.editor.getScreenMode();var i=e.pageX;var r=e.pageY;var a=$(this).offset();i=a.left;r=a.top;var s=$(this).attr("data-popupx");if(typeof s!="undefined"){i=parseInt(s,10)}var o=$(this).attr("data-popupy");if(typeof o!="undefined"){r=parseInt(o,10)}t.currentColor=l.editor.currentTile.getColor();t.type="cellcolor";l.editor.colorPaletteManager.showColorPicker(i,r,t)});$(".cellBackgroundColor").on("click",function(e){console.log("colour picked!");var t={};t.colorPickedCallback=function(e){l.editor.currentTile.setBGColor(e)};t.c64ECMColorSetCallback=function(e,t){l.editor.setC64ECMColor(e,t);l.editor.currentTile.setBGColor(e,{force:true})};t.isCellBG=true;t.screenMode=l.editor.getScreenMode();var i=e.pageX;var r=e.pageY;var a=$(this).offset();i=a.left;r=a.top;t.currentColor=l.editor.currentTile.getBGColor();l.editor.colorPaletteManager.showColorPicker(i,r,t)});$(".backgroundColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){l.editor.setBackgroundColor(e)};var i=e.pageX;var r=e.pageY;var a=$(this).offset();i=a.left;r=a.top;t.hasNone=true;t.currentColor=l.editor.graphic.getBackgroundColor();l.editor.colorPaletteManager.showColorPicker(i,r,t)});$(".borderColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){l.editor.setBorderColor(e)};var i=e.pageX;var r=e.pageY;var a=$(this).offset();i=a.left;r=a.top;t.hasNone=true;t.currentColor=l.editor.graphic.getBorderColor();l.editor.colorPaletteManager.showColorPicker(i,r,t)});$(".c64Multi1Color").on("click",function(e){var t=l.editor.layers.getSelectedLayerObject();if(!t){return}var i={};i.colorPickedCallback=function(e){t.setC64Multi1Color(e)};var r=e.pageX;var a=e.pageY;i.currentColor=t.getC64Multi1Color();l.editor.colorPaletteManager.showColorPicker(r,a,i)});$(".c64Multi2Color").on("click",function(e){var t=l.editor.layers.getSelectedLayerObject();if(!t){return}var i={};i.colorPickedCallback=function(e){t.setC64Multi2Color(e)};var r=e.pageX;var a=e.pageY;i.currentColor=t.getC64Multi2Color();l.editor.colorPaletteManager.showColorPicker(r,a,i)});$(".colorSubPalette").on("click",function(e){var t=e.pageX;var i=e.pageY;var r={};l.editor.colorPaletteManager.showColorSubPalettePicker(t,i,r)});$(".colorSubPaletteColor").on("click",function(e){var t=parseInt($(this).attr("data-paletteIndex"));var i={};i.colorPickedCallback=function(e){l.editor.colorPaletteManager.colorSubPalettes.setColor(t,e)};var r=e.pageX;var a=e.pageY;l.editor.colorPaletteManager.showColorPicker(r,a,i)});$("#mobileMenuCurrentTools").on("click",function(){l.showDrawToolsPopup()})},setScreenMode:function(e){UI("eastInfoPanel").setPanelVisible("south",true);if(g_app.getMode()=="3d"){$("#drawTools-frameColors").hide();$("#drawTool_charpixel").hide();$("#drawTool_pixel").hide();$("#drawTool_linesegment").hide();$("#drawTool_block").hide();$("#drawTools-3dBackgroundColor").show()}else{$(".drawTool").show();$("#drawTools-3dBackgroundColor").hide();switch(e){case TextModeEditor.Mode.TEXTMODE:case TextModeEditor.Mode.C64ECM:$("#drawTools-cellBgColor").show();$("#drawTools-cellColor").show();$(".cellBackgroundColor").show();$("#switchColors").show();$("#drawTools-c64multicolor").hide();$("#drawTools-colorSubPalettes").hide();$("#drawTools-frameColors").show();$("#pixelToolSettings-multicolor").hide();$("#pixelToolSettings-c64multicolor").hide();$("#pixelToolSettings-nes").hide();$("#pixelToolSettings-colorLabel").hide();$("#pixelToolSettingsMobile-c64multicolor").hide();if(this.editor.getEditorMode()=="pixel"){$("#pixelToolSettingsMobile-monochrome").hide()}else{$("#pixelToolSettingsMobile-monochrome").show()}$("#pixelToolSettingsMobile-multicolor").hide();$("#cellForegroundColorMobile").show();$("#cellForegroundColorMobile").css("width","34px");$("#cellForegroundColorMobile").css("height","34px");$("#cellBackgroundColorMobile").show();break;case TextModeEditor.Mode.C64STANDARD:$("#drawTools-cellBgColor").hide();$("#drawTools-cellColor").show();$(".cellBackgroundColor").hide();$("#switchColors").hide();$("#drawTools-c64multicolor").hide();$("#drawTools-colorSubPalettes").hide();$("#drawTools-frameColors").show();$("#pixelToolSettings-multicolor").hide();$("#pixelToolSettings-c64multicolor").hide();$("#pixelToolSettings-nes").hide();$("#pixelToolSettings-colorLabel").hide();$("#pixelToolSettingsMobile-c64multicolor").hide();if(this.editor.getEditorMode()=="pixel"){$("#pixelToolSettingsMobile-monochrome").hide()}else{$("#pixelToolSettingsMobile-monochrome").show()}$("#pixelToolSettingsMobile-multicolor").hide();$("#cellForegroundColorMobile").show();$("#cellForegroundColorMobile").css("width","34px");$("#cellForegroundColorMobile").css("height","34px");$("#cellBackgroundColorMobile").show();break;case TextModeEditor.Mode.C64MULTICOLOR:$("#drawTools-cellBgColor").hide();$("#drawTools-cellColor").show();$(".cellBackgroundColor").hide();$("#switchColors").hide();$("#drawTools-c64multicolor").show();$("#drawTools-colorSubPalettes").hide();$("#drawTools-frameColors").show();$("#pixelToolSettings-multicolor").hide();$("#pixelToolSettings-nes").hide();$("#pixelToolSettings-c64multicolor").show();$("#pixelToolSettings-colorLabel").show();$("#pixelToolSettingsMobile-c64multicolor").show();$("#pixelToolSettingsMobile-monochrome").hide();$("#pixelToolSettingsMobile-multicolor").hide();$("#cellForegroundColorMobile").show();$("#cellForegroundColorMobile").css("width","42px");$("#cellForegroundColorMobile").css("height","42px");$("#cellBackgroundColorMobile").hide();break;case TextModeEditor.Mode.NES:$("#drawTools-cellColor").hide();$("#drawTools-cellBgColor").hide();$("#drawTools-c64multicolor").hide();$("#drawTools-frameColors").hide();$("#drawTools-colorSubPalettes").show();$("#pixelToolSettings-multicolor").hide();$("#pixelToolSettings-c64multicolor").hide();$("#pixelToolSettings-nes").show();$("#pixelToolSettingsMobile-c64multicolor").hide();$("#pixelToolSettingsMobile-monochrome").hide();$("#pixelToolSettingsMobile-multicolor").hide();break;case TextModeEditor.Mode.VECTOR:$("#drawTool_linesegment").hide();$("#drawTool_pixel").hide();$("#drawTool_charpixel").hide();break;case TextModeEditor.Mode.INDEXED:case TextModeEditor.Mode.RGB:$("#drawTools-cellBgColor").hide();$("#drawTools-c64multicolor").hide();$("#drawTools-colorSubPalettes").hide();$("#drawTools-frameColors").hide();$("#pixelToolSettings-multicolor").show();$("#pixelToolSettings-c64multicolor").hide();$("#pixelToolSettings-nes").hide();$("#pixelToolSettings-colorLabel").show();$("#pixelToolSettingsMobile-c64multicolor").hide();$("#pixelToolSettingsMobile-monochrome").hide();$("#pixelToolSettingsMobile-multicolor").show();$("#cellForegroundColorMobile").hide();$("#cellBackgroundColorMobile").hide();if(this.editor.getEditorMode()=="pixel"||this.tool=="pixel"){UI("eastInfoPanel").setPanelVisible("south",true);$("#drawTools-cellColor").show();$("#cellForegroundColor").show();$("#cellBackgroundColor").hide();$("#switchColors").hide()}else{$("#drawTools-cellColor").hide();UI("eastInfoPanel").setPanelVisible("south",false)}break}if(this.editor.getEditorMode()=="pixel"){$("#pixelToolSettings-c64multicolor").hide()}}},getToolIconHTML:function(e){var t="icons/"+e+"@2x.png";return'<img src="'+t+'" style="width: 20px">'},setDrawTool:function(e){if(e=="pixel"&&this.tool!="pixel"){this.saveCurrentTiles=this.editor.currentTile.getTiles()}if(this.tool=="pixel"&&e!="pixel"){if(this.saveCurrentTiles){this.editor.currentTile.setTiles(this.saveCurrentTiles)}}this.tool=e;var t=this.editor.graphic.getType();this.toolDisplayName=this.getToolLabel(e);$(".toolSettings").hide();$(".toolSettingsMobile").hide();this.editor.tools.drawTools.select.endPasteDrag();this.editor.tools.drawTools.tilePalette.clearHighlightCharacter();this.editor.tools.drawTools.tilePalette.drawTilePalette();this.editor.sideTilePalette.clearHighlightCharacter();this.editor.sideTilePalette.drawTilePalette();if(this.editor.graphic.getType()!="sprite"){if(this.editor.spriteFrames.getVisible()){this.editor.spriteFrames.hide()}if(g_app.isMobile()){UI("textEditorMobileToolsHolder").showOnly("tilePaletteMobile")}}switch(e){case"pen":case"eyedropper":case"line":case"rect":case"oval":case"erase":case"fill":$("#drawToolSettings").show();$("#drawToolSettingsMobile").show();this.setDrawMode();this.editor.currentTile.drawCursor();UI("toolControls").showOnly("tilePaletteSplitPanel");UI("previewPanel").showOnly("currentTilePanel");this.editor.animationPreview.hide();break;case"block":this.editor.startBlockTool();this.blockPalette.start();this.editor.sideBlockPalette.start();if(this.editor.currentTile.getBlock()===false){this.editor.currentTile.setBlock(0)}break;case"select":$("#selectToolSettings").show();this.select.show();UI("toolControls").showOnly("selectControls");$("#selectToolSettingsMobile").show();break;case"pixelselect":$("#pixelselectToolSettingsMobile").show();break;case"type":UI("toolControls").showOnly("typeControls");this.editor.currentTile.setCharacter(0);$("#drawToolSettings").show();this.typing.show();break;case"charpixel":UI("toolControls").showOnly("tilePaletteSplitPanel");UI("previewPanel").showOnly("currentTilePanel");$("#charPixelToolSettings").show();this.pixelCharacterDraw.initCharset();break;case"linesegment":UI("toolControls").showOnly("tilePaletteSplitPanel");UI("previewPanel").showOnly("currentTilePanel");$("#lineSegmentToolSettings").show();this.lineSegmentDraw.initCharset();break;case"invert":this.invertTool.toolSelected();UI("toolControls").showOnly("tilePaletteSplitPanel");UI("previewPanel").showOnly("currentTilePanel");break;case"corners":this.cornersTool.toolSelected();UI("toolControls").showOnly("tilePaletteSplitPanel");UI("previewPanel").showOnly("currentTilePanel");break;case"pixel":this.pixelDraw.show();$("#pixelToolSettings").show();$("#pixelToolSettingsMobile").show();if(t!="sprite"){UI("toolControls").showOnly("tilePaletteSplitPanel");UI("previewPanel").showOnly("currentTilePanel");$("#pixelToolSettings_pixelTool").show();this.editor.animationPreview.hide();if(g_app.isMobile()){UI("textEditorMobileToolsHolder").showOnly("tilePaletteMobile")}}else{UI("toolControls").showOnly("spriteFramesPanel");$("#pixelToolSettings_pixelTool").hide();UI("previewPanel").showOnly("animationPreview");if(g_app.isMobile()){UI("textEditorMobileToolsHolder").showOnly("spriteFramesMobile");this.editor.animationPreview.setCanvasElementId("animationPreviewCanvasMobile","animationPreviewHolderMobile");this.editor.spriteFramesMobile.show()}else{this.editor.animationPreview.setCanvasElementId("animationPreviewCanvas","animationPreviewHolder");this.editor.spriteFrames.show()}this.editor.animationPreview.show()}break;case"hand":case"zoom":case"move":UI("toolControls").showOnly("tilePaletteSplitPanel");break}if(e!="type"){if(this.editor.grid.typingCursor){this.editor.grid.typingCursor.visible=false}}if(e=="rect"){$("#smartRect").show()}else{$("#smartRect").hide()}if(e=="type"){$(".drawAffects").hide()}else{$(".drawAffects").show()}if(e=="eyedropper"||e=="pixel"){$("#drawTools-mirrorH").hide();$("#drawTools-mirrorV").hide()}else{$("#drawTools-mirrorH").show();$("#drawTools-mirrorV").show()}if(e=="rect"||e=="oval"){$("#shapeFillSetting").show();if($("#drawToolSettingsMobile").width()>300){$("#drawFillMobileContainer").show()}}else{$("#shapeFillSetting").hide();$("#drawFillMobileContainer").hide()}if(e=="eyedropper"){}if(e=="erase"){this.editor.grid.setCursorCharacter(this.editor.tileSetManager.blankCharacter)}else{}if(e=="fill"){$(".drawFillSettings").show();$("#drawTools-mirrorH").hide();$("#drawTools-mirrorV").hide()}else{$(".drawFillSettings").hide()}$(".drawTool").removeClass("drawToolSelected");$("#drawTool_"+e).addClass("drawToolSelected");$(".drawToolMobile").removeClass("drawToolMobileSelected");$("#drawToolMobile_"+e).addClass("drawToolMobileSelected");$(".drawToolMobileSide").removeClass("drawToolMobileSideSelected");$("#drawToolMobileSide_"+e).addClass("drawToolMobileSideSelected");$("#walk_drawTool_"+e).addClass("drawToolSelected");$("#currentTool").html(this.toolDisplayName);$(".drawPopupTool").removeClass("drawPopupToolSelected");$("#drawPopupTool_"+e).addClass("drawPopupToolSelected");$("#currentPopupTool").html(this.toolDisplayName);$("#toolSettingsCurrentTool").html(this.toolDisplayName);$(".currentDrawTool").html(this.getToolIconHTML(this.tool));if(g_app.isMobile()){var i="";i+='<div class="mobileToolIconHolder"><img src="'+this.toolMap[e].mobileIcon+'"/></div>';i+="<span>"+this.toolMap[e].label+"</span>";$("#mobileMenuCurrentTools").html(i)}if(this.editor.getScreenMode()==TextModeEditor.Mode.INDEXED||this.editor.getScreenMode()==TextModeEditor.Mode.RGB){if(this.editor.getEditorMode()=="pixel"||this.tool=="pixel"){UI("eastInfoPanel").setPanelVisible("south",true);$("#drawTools-cellColor").show();$("#cellForegroundColor").show();$("#cellBackgroundColor").hide();$("#switchColors").hide()}else{UI("eastInfoPanel").setPanelVisible("south",false);$("#drawTools-cellColor").hide()}}else{UI("eastInfoPanel").setPanelVisible("south",true)}if(g_app.mode=="3d"){this.editor.gridView3d.toolChanged()}},toggleDrawCharacter:function(){this.drawCharacter=!$("#drawChangesCharacter").is(":checked");$("#drawChangesCharacter").prop("checked",this.drawCharacter)},toggleDrawFGColor:function(){this.drawColor=!$("#drawChangesColor").is(":checked");$("#drawChangesColor").prop("checked",this.drawColor)},toggleDrawBGColor:function(){this.drawBgColor=!$("#drawChangesBGColor").is(":checked");$("#drawChangesBGColor").prop("checked",this.drawBgColor)},setDrawMode:function(){if(g_app.isMobile()){this.drawCharacter=$("#drawChangesCharacterMobile").is(":checked");this.drawColor=$("#drawChangesColorMobile").is(":checked");this.drawBgColor=$("#drawChangesBGColorMobile").is(":checked");this.mirrorH=$("#drawMirrorHMobile").is(":checked");this.mirrorV=$("#drawMirrorVMobile").is(":checked")}else{this.drawCharacter=$("#drawChangesCharacter").is(":checked");this.drawColor=$("#drawChangesColor").is(":checked");this.drawBgColor=$("#drawChangesBGColor").is(":checked");this.mirrorH=$("#drawMirrorH").is(":checked");this.mirrorV=$("#drawMirrorV").is(":checked")}if(this.mirrorV&&this.mirrorVY===false){var e=this.editor.graphic.getGridHeight();this.mirrorVY=Math.floor(e/2)}if(this.mirrorH&&this.mirrorHX===false){var t=this.editor.graphic.getGridWidth();this.mirrorHX=Math.floor(t/2)}},initSelectEvents:function(){var e=this;$("#selectX1").on("keyup",function(){e.select.setSelectionFromInput()});$("#selectY1").on("keyup",function(){e.select.setSelectionFromInput()});$("#selectX1").on("blur",function(){});$("#selectZ1").on("keyup",function(){e.select.setSelectionFromInput()});$("#selectX2").on("keyup",function(){e.select.setSelectionFromInput()});$("#selectY2").on("keyup",function(){e.select.setSelectionFromInput()});$("#selectZ2").on("keyup",function(){e.select.setSelectionFromInput()});$("#selectFillButton").on("click",function(){e.select.fill()});$("#selectInvertButton").on("click",function(){e.select.invert()});$("#selectSwitchFCBC").on("click",function(){e.select.switchColors()});$("#selectFlipHButton").on("click",function(){e.select.flipH()});$("#selectFlipVButton").on("click",function(){e.select.flipV()});$("#selectNudgeLeft").on("click",function(){e.select.nudgeSelection(-1,0,0,{moveCut:true})});$("#selectNudgeRight").on("click",function(){e.select.nudgeSelection(1,0,0,{moveCut:true})});$("#selectNudgeUp").on("click",function(){e.select.nudgeSelection(0,-1,0,{moveCut:true})});$("#selectNudgeDown").on("click",function(){e.select.nudgeSelection(0,1,0,{moveCut:true})});$("#selectRotateLeft").on("click",function(){e.select.rotateSelection(-1,0,0)});$("#selectRotateRight").on("click",function(){e.select.rotateSelection(1,0,0)});$("#selectRotateUp").on("click",function(){e.select.rotateSelection(0,-1,0)});$("#selectRotateDown").on("click",function(){e.select.rotateSelection(0,1,0)});$("#selectReplaceColorsButton").on("click",function(){e.editor.replaceColor()});$("#selectReplaceCharactersButton").on("click",function(){e.editor.replaceCharacter()});$("#selectDrawUsingSelection").on("click",function(){e.select.selectionToPen();e.select.unselectAll();e.setDrawTool("pen")})},buildInterface:function(e){var a=this;var t=UI.create("UI.SplitPanel",{id:"textModeBottomPanel"});e.add(t);var i=UI.create("UI.Panel",{id:"previewPanel"});var r=UI.create("UI.Panel",{id:"animationPreview",visible:false});var s=UI.create("UI.Panel",{id:"currentTilePanel"});i.add(r);i.add(s);t.addWest(i,180);this.editor.currentTile.buildInterface(s);this.editor.animationPreview.buildInterface(r);var o=UI.create("UI.SplitPanel");var l=UI.create("UI.Panel",{id:"toolSettingsDesktopPanel"});var n=UI.create("UI.SplitPanel",{id:"toolSettingsSplitPanel"});l.add(n);var h=UI.create("UI.HTMLPanel",{id:"toolSettingsDesktop"});n.add(h);UI.on("ready",function(){var e=UI.isMobile.any();if(e){UI("toolSettingsPanel").showOnly("toolsSettingsMobileHTMLPanel")}else{UI("toolSettingsPanel").showOnly("toolSettingsDesktopPanel")}h.load("html/textMode/toolSettings.html",function(){a.initToolSettingEvents()})});UI("toolSettingsPanel").add(l);var d=UI.create("UI.Panel",{id:"toolControls"});o.add(d);t.add(o);var c=UI.create("UI.HTMLPanel",{id:"typeControls",visible:false,html:'<div class="panelFill"><canvas width="421" height="141" id="typeKeyboard" style="background-color: white; cursor: default;"></canvas> <div>Hold \'Shift\' or \'Alt\' to select alternate character ranges</div></div>'});d.add(c);UI.on("ready",function(){UI("typeControls").setVisible(false)});var f=UI.create("UI.HTMLPanel",{id:"selectControls"});d.add(f);UI.on("ready",function(){UI("selectControls").setVisible(false);f.load("html/textMode/selectTools.html",function(){a.initSelectEvents()})});var u=UI.create("UI.HTMLPanel",{id:"pixelControls"});d.add(u);UI.on("ready",function(){UI("pixelControls").setVisible(false);u.load("html/textMode/pixelTools.html",function(){})});var p=UI.create("UI.Panel",{id:"spriteFramesPanel"});d.add(p);this.editor.spriteFrames=new SpriteFrames;this.editor.spriteFrames.init(this.editor);this.editor.spriteFrames.buildInterface(p);UI.on("ready",function(){UI("spriteFramesPanel").setVisible(false)});this.tilePaletteSplitPanel=UI.create("UI.SplitPanel",{id:"tilePaletteSplitPanel"});d.add(this.tilePaletteSplitPanel);var v=UI.create("UI.Panel",{id:"tilePaletteHolder"});this.tilePaletteSplitPanel.add(v);this.tilePalette=new TilePalette;this.tilePalette.init(this.editor);this.tilePalette.buildInterface(v);var g=UI.create("UI.Panel",{id:"blockPaletteHolder"});this.tilePaletteSplitPanel.addEast(g,300);this.blockPalette=new BlockPalette;this.blockPalette.init(this.editor);this.blockPalette.buildInterface(g);UI.on("ready",function(){});UI.on("ready",function(){var e=UI("toolsDesktopPanel");e.on("loaded",function(){a.initEvents()});e.on("contextmenu",function(e){e.preventDefault()});e.load("html/textMode/drawTools.html");var t=UI("toolsMobileSidePanel");t.on("loaded",function(){a.initMobileSidePanelContent();a.initMobileSidePanelEvents();a.checkMobileToolScroll()});t.load("html/textMode/drawToolsMobileSide.html");t.on("resize",function(){a.checkMobileToolScroll()});var i=UI("toolsMobileHTMLPanel");i.on("loaded",function(){a.initMobileEvents()});i.on("contextmenu",function(e){e.preventDefault()});i.load("html/textMode/drawToolsMobile.html");var r=UI("toolsSettingsMobileHTMLPanel");r.on("loaded",function(){a.initMobileToolSettingEvents()});r.load("html/textMode/toolSettingsMobile.html")})},initToolSettingsCurrentTileEvents:function(){var i=this;$("#toolSettingsCurrentTile").on("click",function(e){var t=$(this).offset();i.editor.gridView2d.mousePageX=t.left+20;i.editor.gridView2d.mousePageY=t.top+26+20;i.editor.gridView2d.showCharacterPicker()})},toggleShape:function(){switch(this.tool){case"line":this.setDrawTool("rect");break;case"rect":this.setDrawTool("oval");break;case"oval":this.setDrawTool("line");break;default:this.setDrawTool("line");break}},keyDown:function(e){var t=e.key.toLowerCase();var i=e.keyCode;var r=String.fromCharCode(i).toUpperCase();var a=String.fromCharCode(i).toLowerCase();var s=this.tool;var o=this.editor.grid.grid2d;var l=this.editor.layers.getSelectedLayerObject();if(this.editor.spriteFrames.getVisible()){if(this.editor.spriteFrames.keyDown(e)){return}}if(s!="type"){this.editor.colorPalettePanel.keyDown(e)}if(this.editor.getEditorMode()=="pixel"){this.editor.tools.pixelDrawTools.keyDown(e);return}if(s=="pixel"){this.pixelDraw.keyDown(e)}if(s=="type"){e.preventDefault();this.typing.keyDown(e);return}if(!e.shiftKey){switch(r){case keys.textMode.toolsPencil.key:this.setDrawTool("pen");return;break;case keys.textMode.toolsErase.key:this.setDrawTool("erase");return;break;case keys.textMode.toolsBucket.key:this.setDrawTool("fill");return;break;case keys.textMode.toolsEyedropper.key:this.setDrawTool("eyedropper");return;break;case keys.textMode.toolsPixel.key:this.setDrawTool("pixel");return;break;case keys.textMode.toolsCharPixel.key:this.setDrawTool("charpixel");return;break;case keys.textMode.toolsMarquee.key:this.setDrawTool("select");return;break;case keys.textMode.toolsType.key:this.setDrawTool("type");return;break;case keys.textMode.toolsShape.key:this.toggleShape();return;break;case keys.textMode.toolsZoom.key:this.setDrawTool("zoom");return;break;case keys.textMode.toolsHand.key:this.setDrawTool("hand");return;break;case keys.textMode.toolsMove.key:this.setDrawTool("move");return;break;case keys.textMode.toolsBlock.key:this.setDrawTool("block");return;break}}if(this.tool=="pen"||this.tool=="erase"||this.tool=="fill"||this.tool=="eyedropper"||this.tool=="line"||this.tool=="rect"||this.tool=="oval"){switch(r){case keys.textMode.drawTileFlipH.key:this.editor.currentTile.flipH2d();break;case keys.textMode.drawTileFlipV.key:this.editor.currentTile.flipV2d();break;case keys.textMode.drawCharacter.key:this.toggleDrawCharacter();break;case keys.textMode.drawFGColor.key:this.toggleDrawFGColor();break;case keys.textMode.drawBGColor.key:this.toggleDrawBGColor();break}this.tilePalette.keyDown(e)}if(this.tool=="pen"||this.tool=="block"){var n=1;var h=1;if(l&&l.getType()=="grid"){if(l.getBlockModeEnabled()){n=l.getBlockWidth();h=l.getBlockHeight()}}switch(t){case"arrowup":o.moveCursor(0,-h);o.setCursorEnabled(true);break;case"arrowdown":o.moveCursor(0,h);o.setCursorEnabled(true);break;case"arrowleft":o.moveCursor(-n,0);o.setCursorEnabled(true);break;case"arrowright":o.moveCursor(n,0);o.setCursorEnabled(true);break;case"enter":case"insert":o.setCursorCells();break}}if(this.tool=="linesegment"){switch(r){case keys.textMode.lineSegmentHorizontal.key:this.lineSegmentDraw.setMode("horizontal");break;case keys.textMode.lineSegmentVertical.key:this.lineSegmentDraw.setMode("vertical");break}}if(this.tool=="block"){if(this.blockPalette){this.blockPalette.keyDown(e)}if(this.editor.sideTilePalette){this.editor.sideTilePalette.keyDown(e)}}if(this.tool!="type"){switch(e.key){case keys.textMode.showColorPicker.key:this.editor.gridView2d.showColorPicker();break;case keys.textMode.showTilePicker.key:this.editor.gridView2d.showCharacterPicker();break}switch(e.key.toLowerCase()){case keys.textMode.switchColors.key:this.editor.currentTile.switchColors();break}}if(this.tool=="select"){if(!e.shiftKey&&!e.altKey&&!e.metaKey){switch(r){case keys.textMode.selectDrawWithSelection.key:this.select.selectionToPen();this.select.unselectAll();this.setDrawTool("pen");break;case keys.textMode.selectFlipSelectionH.key:this.select.flipH();break;case keys.textMode.selectFlipSelectionV.key:this.select.flipV();break;case keys.textMode.selectFillSelection.key:this.select.fill();break}}}if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){switch(r){case keys.textMode.c64MultiFG.key:this.pixelDraw.setC64MultiColorType("cell");break;case keys.textMode.c64MultiBG.key:this.pixelDraw.setC64MultiColorType("background");break;case keys.textMode.c64MultiMC1.key:this.pixelDraw.setC64MultiColorType("multi1");break;case keys.textMode.c64MultiMC2.key:this.pixelDraw.setC64MultiColorType("multi2");break}}if(this.select.isActive()){this.selectToolKeypress(e)}else{this.screenMoveKeypress(e)}this.editor.gridView2d.setMouseCursor(e)},keyUp:function(e){if(this.tool=="type"){e.preventDefault()}},keyPress:function(e){if(this.tool=="type"){e.preventDefault()}},selectToolKeypress:function(e){var t=this.select;var i=e.metaKey||e.ctrlKey;var r={moveCut:i,moveCopy:e.altKey};switch(e.keyCode){case 46:case 8:t.clear();break;case 38:t.nudgeSelection(0,-1,0,r);e.preventDefault();break;case 40:t.nudgeSelection(0,1,0,r);e.preventDefault();break;case 39:t.nudgeSelection(1,0,0,r);e.preventDefault();break;case 37:t.nudgeSelection(-1,0,0,r);e.preventDefault();break}},screenMoveKeypress:function(e){var t=this.select;var i=e.metaKey||e.ctrlKey;var r={moveCut:i,moveCopy:e.altKey};if(!r.moveCut&&!r.moveCopy){return}var a=0;var s=0;var o=0;switch(e.keyCode){case 38:s=1;break;case 40:s=-1;break;case 39:a=1;break;case 37:a=-1;break}if(a!=0||s!=0||a!=0){t.selectAll();t.nudgeSelection(a,s,o,r);t.unselectAll();e.preventDefault()}},showPopup:function(e,t,i,r,a){if(this.drawToolsPopup==null){this.drawToolsPopup=new DrawToolsPopup;var s=this;this.drawToolsPopup.init(this.editor,function(){s.drawToolsPopup.show(e,t,i,r,a)})}else{this.drawToolsPopup.show(e,t,i,r,a)}}};var PixelDrawTools=function(){this.editor=null;this.tool="pen"};PixelDrawTools.prototype={init:function(e){this.editor=e},initEvents:function(){var r=this;$(".pixelDrawTool").on("click",function(){var e=$(this).attr("id");var t=e.lastIndexOf("_");e=e.substring(t+1);r.setDrawTool(e)});$(".pixelDrawTool").on("mouseover",function(){var e=$(this).attr("id");e=e.substring("drawTool_".length);var t=r.getToolLabel(e);$("#currentTool").html(t)});$(".pixelDrawTool").on("mouseleave",function(){var e=r.getToolLabel(r.tool);$("#currentTool").html(e)});$("#pixelDrawCellForegroundColor").on("click",function(){var e={};e.colorPickedCallback=function(e){r.editor.currentTile.setColor(e)};e.mode=r.editor.getScreenMode();var t=event.pageX;var i=event.pageY;e.currentColor=r.editor.currentTile.getColor();e.type="cellcolor";r.editor.colorPaletteManager.showColorPicker(t,i,e)});$("#pixelDrawTools-colors"+" .colorSetting").on("click",function(e){var t=$(this).attr("data-type");r.showColorPicker(e,t);e.preventDefault()});$(".pixelDrawToolsColor").on("click",function(){var e=$(this).attr("data-type");$(".pixelDrawToolsColor").removeClass("pixelDrawToolsColorSelected");$(this).addClass("pixelDrawToolsColorSelected");r.selectC64ColorType(e)})},setScreenMode:function(e){switch(e){case TextModeEditor.Mode.TEXTMODE:case TextModeEditor.Mode.C64ECM:case TextModeEditor.Mode.C64STANDARD:$("#pixelDrawToolsColor-cell").show();$("#pixelDrawToolsColor-background").show();$("#pixelDrawTools-c64multicolor").hide();$("#pixelDrawTools-nes").hide();$("#pixelDrawTools-indexed").hide();break;case TextModeEditor.Mode.C64MULTICOLOR:$("#pixelDrawToolsColor-cell").show();$("#pixelDrawToolsColor-background").show();$("#pixelDrawTools-c64multicolor").show();$("#pixelDrawTools-nes").hide();$("#pixelDrawTools-indexed").hide();break;case TextModeEditor.Mode.NES:$("#pixelDrawToolsColor-cell").hide();$("#pixelDrawToolsColor-background").hide();$("#pixelDrawTools-c64multicolor").hide();$("#pixelDrawTools-nes").show();$("#pixelDrawTools-indexed").hide();break;case TextModeEditor.Mode.INDEXED:$("#pixelDrawToolsColor-cell").show();$("#pixelDrawToolsColor-background").hide();$("#pixelDrawTools-c64multicolor").hide();$("#pixelDrawTools-nes").hide();$("#pixelDrawTools-indexed").hide();break;case TextModeEditor.Mode.RGB:$("#pixelDrawToolsColor-cell").show();$("#pixelDrawToolsColor-background").hide();$("#pixelDrawTools-c64multicolor").hide();$("#pixelDrawTools-nes").hide();$("#pixelDrawTools-indexed").hide();break}},showColorPicker:function(e,t){var i={};var r=this.editor.layers.getSelectedLayerObject();if(!r){return}i.currentColor=0;switch(t){case"cell":i.currentColor=this.editor.currentTile.getColor();i.type="cellcolor";break;case"background":i.hasNone=true;i.currentColor=r.getBackgroundColor();i.type="background";break;case"multi1":i.currentColor=r.getC64Multi1Color();i.type="multi1";break;case"multi2":i.currentColor=r.getC64Multi2Color();i.type="multi2";break}i.colorPickedCallback=function(e){switch(t){case"background":this.editor.setBackgroundColor(e);break;case"cell":this.editor.currentTile.setColor(e);break;case"multi1":this.editor.setC64Multi1Color(e);break;case"multi2":this.editor.setC64Multi2Color(e);break}};if(UI.isMobile.any()){this.editor.colorPaletteManager.showColorPickerMobile(i)}else{var a=e.pageX;var s=e.pageY;this.editor.colorPaletteManager.showColorPicker(a,s,i)}},selectC64ColorType:function(e){this.editor.tools.drawTools.pixelDraw.setC64MultiColorType(e)},buildInterface:function(e){var i=this;UI.on("ready",function(){var e=UI("pixelToolsDesktopPanel");e.on("loaded",function(){i.initEvents()});e.on("contextmenu",function(e){e.preventDefault()});e.load("html/textMode/pixelDrawTools.html");var t=UI("pixelToolsMobileSidePanel");t.on("loaded",function(){i.initMobileSidePanelContent();i.initMobileSidePanelEvents();i.checkMobileToolScroll()});t.load("html/textMode/pixelDrawToolsMobileSide.html");t.on("resize",function(){})})},initMobileSidePanelContent:function(){},initMobileSidePanelEvents:function(){var t=this;$("#pixelLayersButtonMobile").on("click",function(){t.editor.layers.showMobileLayerChooser()});$(".pixelDrawToolMobileSide").on("click",function(){var e=$(this).attr("data-type");t.setDrawTool(e)})},checkMobileToolScroll:function(){var e=$("#pixelToolIconHolderMobile").height();var t=$("#pixelToolIconsMobile").height();var i=$("#pixelToolIconsMobile").position();var r=i.top;if(r<-2){$("#pixelToolIconsScrollTop").show()}else{$("#pixelToolIconsScrollTop").hide()}if(r+t-2>e){$("#pixelToolIconsScrollBottom").show()}else{$("#pixelToolIconsScrollBottom").hide()}},getToolLabel:function(e){this.toolMap={pen:{label:"Pencil",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsPencil.key},erase:{label:"Blank",mobileIcon:"icons/svg/glyphicons-basic-250-eraser.svg",key:keys.textMode.toolsErase.key},fill:{label:"Fill Bucket",mobileIcon:"icons/svg/glyphicons-basic-245-fill.svg",key:keys.textMode.toolsBucket.key},eyedropper:{label:"Eyedropper",mobileIcon:"icons/svg/glyphicons-basic-91-eyedropper.svg",key:keys.textMode.toolsEyedropper.key},line:{label:"Line",mobileIcon:"icons/svg/slash.svg",key:keys.textMode.toolsShape.key},rect:{label:"Rect",mobileIcon:"icons/svg/square.svg",key:keys.textMode.toolsShape.key},oval:{label:"Oval",mobileIcon:"icons/svg/circle.svg",key:keys.textMode.toolsShape.key},pixelselect:{label:"Marquee",mobileIcon:"icons/select@2x.png",key:keys.textMode.toolsMarquee.key},charpixel:{label:"Char Pixel",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsCharPixel.key},type:{label:"Type",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsType.key},pixel:{label:"Pixel",mobileIcon:"icons/pixel.png",key:keys.textMode.toolsPixel.key},block:{label:"Block",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsBlock.key},zoom:{label:"Zoom",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsZoom.key},hand:{label:"Hand",mobileIcon:"icons/svg/glyphicons-basic-457-hand-open.svg",key:keys.textMode.toolsHand.key},move:{label:"Move",mobileIcon:"icons/svg/glyphicons-basic-31-pencil.svg",key:keys.textMode.toolsMove.key}};if(this.toolMap.hasOwnProperty(e)){return this.toolMap[e].label+" ("+this.toolMap[e].key+")"}return e},setDrawTool:function(e){switch(e){case"pen":this.editor.tools.drawTools.setDrawTool("pixel");this.editor.tools.drawTools.pixelDraw.setTool("draw");break;case"erase":this.editor.tools.drawTools.setDrawTool("pixel");this.editor.tools.drawTools.pixelDraw.setTool("erase");break;case"line":this.editor.tools.drawTools.setDrawTool("pixel");this.editor.tools.drawTools.pixelDraw.setTool("line");break;case"rect":this.editor.tools.drawTools.setDrawTool("pixel");this.editor.tools.drawTools.pixelDraw.setTool("rect");$("#pixelshapeToolSettingsMobile").show();$("#pixelShapeFillSetting").show();break;case"oval":this.editor.tools.drawTools.setDrawTool("pixel");this.editor.tools.drawTools.pixelDraw.setTool("oval");$("#pixelshapeToolSettingsMobile").show();$("#pixelShapeFillSetting").show();break;case"fill":this.editor.tools.drawTools.setDrawTool("pixel");this.editor.tools.drawTools.pixelDraw.setTool("fill");break;case"pixelselect":case"select":this.editor.tools.drawTools.setDrawTool("pixelselect");break;case"zoom":this.editor.tools.drawTools.setDrawTool("pixelzoom");break;case"hand":this.editor.tools.drawTools.setDrawTool("pixelhand");break;case"move":this.editor.tools.drawTools.setDrawTool("pixelmove");break}$(".pixelDrawTool").removeClass("pixelDrawToolSelected");$("#pixelDrawTool_"+e).addClass("pixelDrawToolSelected");$(".pixelDrawToolMobile").removeClass("pixelDrawToolMobileSelected");$("#pixelDrawToolMobile_"+e).addClass("pixelDrawToolMobileSelected");$(".pixelDrawToolMobileSide").removeClass("pixelDrawToolMobileSideSelected");$("#pixelDrawToolMobileSide_"+e).addClass("pixelDrawToolMobileSideSelected");if(this.editor.tools.drawTools.pixelSelect.isInPasteMove()){this.editor.tools.drawTools.pixelSelect.endPasteDrag()}},toggleShape:function(){},keyDown:function(e){var t=e.keyCode;var i=String.fromCharCode(t).toUpperCase();var r=this.editor.tools.drawTools.tool;if(!e.shiftKey){switch(i){case keys.textMode.toolsPencil.key:this.setDrawTool("pen");return;break;case keys.textMode.toolsErase.key:this.setDrawTool("erase");return;break;case keys.textMode.toolsBucket.key:this.setDrawTool("fill");return;break;case keys.textMode.toolsEyedropper.key:this.setDrawTool("eyedropper");return;break;case keys.textMode.toolsMarquee.key:this.setDrawTool("select");return;break;case keys.textMode.toolsShape.key:this.toggleShape();return;break;case keys.textMode.toolsZoom.key:this.setDrawTool("zoom");return;break;case keys.textMode.toolsHand.key:this.setDrawTool("hand");return;break;case keys.textMode.toolsMove.key:this.setDrawTool("move");return;break}}this.selectToolKeypress(e);if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){switch(i){case keys.textMode.c64MultiFG.key:this.editor.tools.drawTools.pixelDraw.setC64MultiColorType("cell");break;case keys.textMode.c64MultiBG.key:this.editor.tools.drawTools.pixelDraw.setC64MultiColorType("background");break;case keys.textMode.c64MultiMC1.key:this.editor.tools.drawTools.pixelDraw.setC64MultiColorType("multi1");break;case keys.textMode.c64MultiMC2.key:this.editor.tools.drawTools.pixelDraw.setC64MultiColorType("multi2");break}}this.editor.gridView2d.setMouseCursor(e)},selectToolKeypress:function(e){var t=this.editor.tools.drawTools.pixelSelect;var i=e.metaKey||e.ctrlKey;var r={moveCut:i,moveCopy:e.altKey};switch(e.keyCode){case 46:case 8:t.clear();break;case 38:t.nudgeSelection(0,-1,r);e.preventDefault();break;case 40:t.nudgeSelection(0,1,r);e.preventDefault();break;case 39:t.nudgeSelection(1,0,r);e.preventDefault();break;case 37:t.nudgeSelection(-1,0,r);e.preventDefault();break}}};var TilePalette=function(){this.editor=null;this.tilePaletteDisplay=null;this.charRecentIndex=0;this.canvas=null;this.width=0;this.height=0;this.tileWidth=false;this.tileHeight=false;this.prefix="";this.blockStacking="horizontal";this.tileMaterials=null;this.tileInfoTile=false};TilePalette.prototype={init:function(e,t){if(typeof t!="undefined"){if(typeof t.prefix!="undefined"){this.prefix=t.prefix}if(typeof t.blockStacking!="undefined"){this.blockStacking=t.blockStacking}}this.editor=e},buildInterface:function(e){var a=this;this.tileMaterials=new TileMaterials;this.tileMaterials.init(this.editor,this.prefix);var t='<div class="panelFill" id="'+this.prefix+'charPalette">';t+='<div class="title" style="background-color: #111111; height: 18px; overflow: none; white-space: nowrap">';t+='  <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap">';t+="  Tiles";t+="  </div>";t+='  <div style="position: absolute; top: 2px; right: 2px; width: 20px">';t+='    <div id="'+this.prefix+'charPaletteCloseButton" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>';t+="  </div>";t+="</div>";t+='<div style=" position: absolute; left: 0px; right: 0px; top: 18px; height: 24px; display: flex; align-items: center; background-color: #222222; padding: 0px;">';t+='<div style="margin-left: 2px; display: flex; align-items: center">';t+='<canvas style="background-color: #222222; border: 1px solid #333333" width="16" height="16" id="'+this.prefix+'tilepalette-tileinfocanvas"></canvas>';t+='<div id="'+this.prefix+'charpalette-charinfo" style="display: flex; width: 60px; margin-left: 4px;  overflow: hidden; white-space: nowrap; text-overflow: ellipsis">0x32</div>';t+='<div class="tile-rotation" id="'+this.prefix+'charpalette-rotationinfo" style="display: flex; align-items: center;  margin-right: 8px">';t+='<div id="'+this.prefix+'charpalette-rotation" class="tile-rotation-amount" style="width: 30px; text-align: right; margin-right: 10px"></div>';t+='<div id="'+this.prefix+'charpalette-rotatebutton" class="ui-button ui-button-small"  data-label="Tile Rotate" title="Tile Rotate (R)"><img src="icons/svg/glyphicons-basic-493-rotate.svg"></div>';t+="</div>";t+='<div class="tile-fliph" id="'+this.prefix+'charpalette-fliphinfo" style="display: flex; align-items: center; margin-right: 8px">';t+='<div class="gridinfo-label">Flip&nbsp;H</div>';t+='<div id="'+this.prefix+'charpalette-fliph" class="tile-flipped-x" style="width: 10px; text-align: center"></div>';t+='<div id="'+this.prefix+'charpalette-fliphbutton" class="ui-button ui-button-small" style="margin-left: 4px" data-label="Tile Flip X" title="Tile Flip X (F)"><img src="icons/svg/glyphicons-basic-747-reflect-y.svg"></div>';t+="</div>";t+='<div class="tile-flipv" id="'+this.prefix+'charpalette-flipvinfo" style="display:flex; align-items: center;">';t+='<div class="gridinfo-label">Flip&nbsp;V</div>';t+='<div id="'+this.prefix+'charpalette-flipv"  class="tile-flipped-y" style="width: 10px; text-align: center"></div>';t+='<div id="'+this.prefix+'charpalette-flipvbutton" class="ui-button ui-button-small"  style="margin-left: 4px" data-label="Tile Flip Y" title="Tile Flip Y (G)"><img src="icons/svg/glyphicons-basic-748-reflect-x.svg"></div>';t+="</div>";t+="</div>";t+="</div>";if(this.prefix=="side"){t+='<div style="position: absolute; left: 2px; right: 0px; top: 44px; bottom: 56px; overflow: hidden" id="'+this.prefix+'tilePaletteHolder">'}else{t+='<div style="position: absolute; left: 2px; right: 0px; top: 44px; bottom: 28px; overflow: hidden" id="'+this.prefix+'tilePaletteHolder">'}t+='<canvas id="'+this.prefix+'charPaletteCanvas" style="position: absolute; top: 0; bottom: 0; left: 0; right: 0;" ></canvas>';t+="</div>";if(this.prefix=="side"){t+='<div  id="'+this.prefix+'tilePaletteMaterials" style="position: absolute; display: none; left: 0px; right: 0; bottom: 56px; height: 0px; background-color: #111111; padding: 0px;">';t+=this.tileMaterials.getHTML();t+="</div>";t+='<div style=" position: absolute; left: 0px; right: 0px; bottom: 0px; height: 56px; background-color: #222222; padding: 0px; display: flex; flex-direction: column;">';t+='<div style="white-space: nowrap; height: 28px; display: flex; align-items: center">'}else{t+='<div style="white-space: nowrap; position: absolute; left: 0px; right: 0px; bottom: 0px; height: 28px; background-color: #222222; padding: 0px; display: flex; align-items: center">'}t+='<select id="'+this.prefix+'charPaletteSortOrder" style="margin-right: 20px">';t+='<option value="source">Tile Index</option>';t+='<option value="similar" selected="selected">Group Similar</option>';t+="</select>";t+='<div style="display: flex">';t+='<div class="ui-button tilePaletteScale-dec">-</div>';t+='<select id="'+this.prefix+'tilePaletteScale">';t+='<option value="1">100%</option>';t+='<option value="2" selected="selected">200%</option>';t+='<option value="3">300%</option>';t+='<option value="4">400%</option>';t+="</select>";t+='<div class="ui-button tilePaletteScale-inc">+</div>';t+="</div>";t+='<span style="margin-left: 20px">';t+='<label class="gridinfo-label" for="tilePaletteTileMargin">Spacing</label>';t+='<span id="'+this.prefix+'tilePaletteTileMargin" style="white-space: nowrap; margin-right: 10px">1</span>';t+="</span>";t+="<span>";t+='<div class="ui-button" id="'+this.prefix+'tilePaletteTileMarginDec">-</div>';t+="&nbsp;";t+='<div class="ui-button" id="'+this.prefix+'tilePaletteTileMarginInc">+</div>';t+="</span>";if(this.prefix=="side"){t+="</div>";t+='<div style="white-space: nowrap; height: 28px; display: flex; align-items: center">'}t+='<span style="margin-right: 0px">';t+='<label class="gridinfo-label" for="tilePaletteTileSize">Size</label>';t+='<span id="'+this.prefix+'tilePaletteTileSize" style="white-space: nowrap; margin-right: 10px"> 8x8</span>';t+="</span>";t+="<span>";t+='<label class="gridinfo-label" for="tilePaletteTileCount">Count</label>';t+='<span id="'+this.prefix+'tilePaletteTileCount" style="white-space: nowrap; margin-right: 10px"> 256</span>';t+="</span>";t+='<span style="margin-right: 16px">';t+='<div class="ui-button" id="'+this.prefix+'tilePaletteTileCountDec">-</div>';t+="&nbsp;";t+='<div class="ui-button" id="'+this.prefix+'tilePaletteTileCountInc">+</div>';t+="</span>";t+='<div class="ui-button" id="'+this.prefix+'tilePaletteChooseTileSet">Choose Tile Set...<div class="rippleJS"></div></div>';t+='<div class="ui-button" style="margin-left: 6px" id="'+this.prefix+'sortTilePalette">Rearrange...</div>';if(this.prefix=="side"){t+="</div>"}else{}t+="</div>";t+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{id:this.prefix+"charPalette",html:t});UI.on("ready",function(){a.canvas=document.getElementById(a.prefix+"charPaletteCanvas");a.uiComponent.on("resize",function(){a.resize()});if(a.prefix=="side"&&a.tileMaterials!=null){a.tileMaterials.initEvents()}});e.add(this.uiComponent);this.tilePaletteDisplay=new TilePaletteDisplay;this.tilePaletteDisplay.init(this.editor,{canvasElementId:this.prefix+"charPaletteCanvas",resizeCanvas:false,blockStacking:this.blockStacking});var a=this;this.tilePaletteDisplay.on("selectedgridchanged",function(e){a.tileChosen();a.editor.currentTile.setCharacters(e);var t=a.editor.tools.drawTools.tilePalette;var i=a.editor.sideTilePalette;if(a.prefix=="side"){var r=i.tilePaletteDisplay.getCharPaletteMapType();if(r=="source"){t.tilePaletteDisplay.clearSelectedGridCells();t.tilePaletteDisplay.setSelected(i.tilePaletteDisplay.getSelectedCharacters())}else{t.tilePaletteDisplay.setSelectedGridCells(i.tilePaletteDisplay.selectedGridCells)}t.drawTilePalette()}else{var r=t.tilePaletteDisplay.getCharPaletteMapType();if(r=="source"){i.tilePaletteDisplay.clearSelectedGridCells();i.tilePaletteDisplay.setSelected(t.tilePaletteDisplay.getSelectedCharacters())}else{i.tilePaletteDisplay.setSelectedGridCells(t.tilePaletteDisplay.selectedGridCells)}i.drawTilePalette()}});this.tilePaletteDisplay.on("charactertouch",function(e){console.log("character touch");a.editor.currentTile.setTiles([[e]])});this.tilePaletteDisplay.on("highlightchanged",function(e){a.setCharacterInfo(e)});this.tilePaletteDisplay.on("dblclick",function(e){this.editor.currentTile.setCharacters([[e]]);this.editor.tileEditor.setVisible(true)});UI.on("ready",function(){a.setupEvents()})},tileChosen:function(){var e=this.editor.tools.drawTools.tool;if(e=="block"||e=="erase"||e=="eyedropper"||e=="type"||e=="select"||e=="charpixel"||e=="zoom"||e=="move"||e=="pixel"||e=="hand"){this.editor.tools.drawTools.setDrawTool("pen")}},setMaterialsVisible:function(e){if(e){$("#"+this.prefix+"tilePaletteMaterials").show();$("#"+this.prefix+"tilePaletteMaterials").css("height","60px");$("#"+this.prefix+"tilePaletteHolder").css("bottom","116px")}else{$("#"+this.prefix+"tilePaletteMaterials").hide();$("#"+this.prefix+"tilePaletteMaterials").css("height","0px");$("#"+this.prefix+"tilePaletteHolder").css("bottom","56px")}},selectedGridChanged:function(e){this.tilePaletteDisplay.clearSelectedGridCells();this.tilePaletteDisplay.setSelectedGrid(e)},selectTilePaletteMapType:function(e){var t=this.editor.tileSetManager.getCurrentTileSet();if(t&&t.isPetscii()){g_app.setPref("textmode.petsciisortmethod",e)}else{}this.setCharPaletteMapType(e);var i=this.editor.tools.drawTools.tilePalette;var r=this.editor.sideTilePalette;i.setCharPaletteMapType(e);r.setCharPaletteMapType(e);if(this.prefix=="side"){$("#charPaletteSortOrder").val(e)}else{$("#sidecharPaletteSortOrder").val(e)}},setupEvents:function(){var s=this;$("#"+this.prefix+"charPaletteCloseButton").on("click",function(){s.editor.setTilePalettePanelVisible(s.prefix,false)});$("#"+this.prefix+"charPaletteSortOrder").on("change",function(e){var t=$(this).val();s.selectTilePaletteMapType(t)});$("#"+this.prefix+"tilePaletteChooseTileSet").on("click",function(e){s.editor.tileSetManager.showChoosePreset({})});$("#"+this.prefix+"tilePaletteScale").on("change",function(e){var t=parseFloat($(this).val());if(!isNaN(t)){s.setScale(t)}});$(".tilePaletteScale-dec").on("click",function(){var e=$("#"+s.prefix+"tilePaletteScale").val();var t=$("#"+s.prefix+"tilePaletteScale").get(0);var i=t.options;var r=false;for(var a=0;a<i.length;a++){if(i[a].value==e){break}r=i[a].value}if(r!==false){s.setScale(r)}});$(".tilePaletteScale-inc").on("click",function(){var e=$("#"+s.prefix+"tilePaletteScale").val();var t=$("#"+s.prefix+"tilePaletteScale").get(0);var i=t.options;var r=false;for(var a=0;a<i.length;a++){if(i[a].value==e&&a<i.length-1){r=i[a+1].value}}if(r!==false){s.setScale(r)}});$("#"+this.prefix+"tilePaletteTileCountInc").on("click",function(){s.tileCountChange(1)});$("#"+this.prefix+"tilePaletteTileCountDec").on("click",function(){s.tileCountChange(-1)});$("#"+this.prefix+"tilePaletteTileMarginInc").on("click",function(){s.tileMarginChange(1)});$("#"+this.prefix+"tilePaletteTileMarginDec").on("click",function(){s.tileMarginChange(-1)});$("#"+this.prefix+"sortTilePalette").on("click",function(){var e=$(this).is(":checked");s.editor.editTilePalette()});$("#"+this.prefix+"charpalette-rotatebutton").on("click",function(){s.editor.currentTile.rotate2d()});$("#"+this.prefix+"charpalette-fliphbutton").on("click",function(){s.editor.currentTile.flipH2d()});$("#"+this.prefix+"charpalette-flipvbutton").on("click",function(){s.editor.currentTile.flipV2d()})},setSortTilePalette:function(e){var t=this.editor.tileSetManager.noTile;if(e){this.tilePaletteDisplay.setMode("sort");var i=this.editor.tileSetManager.getCurrentTileSet();var r=i.getPaletteMap("custom");var a=[];if(r===false){a=this.tilePaletteDisplay.getCharPaletteMap()}else{a=r.data}var s=[];this.tileSortMap=[];for(var o=0;o<a.length;o++){this.tileSortMap[o]=[];for(var l=0;l<a[o].length;l++){this.tileSortMap[o][l]=a[o][l];s.push(a[o][l])}}console.log(s);console.log(JSON.stringify(s));if(a.length<32){for(var o=a.length;o<32;o++){this.tileSortMap[o]=[];for(var l=0;l<a[0].length;l++){this.tileSortMap[o][l]=t}}}$("#"+this.prefix+"charPaletteSortOrder").val("custom");this.tilePaletteDisplay.setCharPaletteMap(this.tileSortMap,"custom");this.tilePaletteDisplay.draw({redrawTiles:true})}else{var i=this.editor.tileSetManager.getCurrentTileSet();var n=this.tilePaletteDisplay.getCharPaletteMap();var h=0;for(var o=0;o<n.length;o++){var d=false;for(var l=0;l<n[o].length;l++){if(n[o][l]!==t){d=true}}if(d&&o>h){h=o}}n.length=h+1;i.setPaletteMap("custom",{data:n,rowsPerColumn:8});this.tilePaletteDisplay.setMode("grid");this.tilePaletteDisplay.draw({redrawTiles:true})}},tileMarginChange:function(e){var t=8;var i=8;var r=this.editor.tileSetManager.getCurrentTileSet();if(r!=null){t=r.getTileWidth();i=r.getTileHeight()}var a="tilepalette.margin_"+t+"x"+i;var s=1;if(typeof e!="undefined"){s=this.tilePaletteDisplay.getTileMargin();s+=e}else{if(!UI.isMobile.any()){s=g_app.getPref(a);if(typeof s=="undefined"||s===null){s=1}}}s=parseInt(s,10);if(isNaN(s)){s=1}if(s>=0){g_app.setPref(a,s);this.tilePaletteDisplay.setTileMargin(s);this.tilePaletteDisplay.draw({redrawTiles:true});$("#"+this.prefix+"tilePaletteTileMargin").html(s)}},tileCountChange:function(e){var t=this.editor.tileSetManager.getCurrentTileSet();var i=t.getTileCount();i+=e;if(i>0){t.setTileCount(i)}this.tilePaletteDisplay.draw({redrawTiles:true});this.updateTileCountHTML()},updateTileCountHTML:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileCount();$("#"+this.prefix+"tilePaletteTileCount").html(t)},setCharPaletteMapType:function(e){this.tilePaletteDisplay.setCharPaletteMapType(e);$("#charPaletteSortOrder").val(e);$("#sidecharPaletteSortOrder").val(e)},getTilePaletteMapType:function(){return this.tilePaletteDisplay.charPaletteMapType},setScale:function(e){var t=8;var i=8;var r=this.editor.tileSetManager.getCurrentTileSet();if(r!=null){t=r.getTileWidth();i=r.getTileHeight()}var a="tilepalette.scale_"+t+"x"+i;var s=2;if(typeof e!="undefined"){s=e}else{if(!UI.isMobile.any()){s=g_app.getPref(a);if(typeof s=="undefined"||s==null){s=2}}}s=parseInt(s,10);if(isNaN(s)||s>100){s=2}g_app.setPref(a,s);this.tilePaletteDisplay.setScale(s);this.tilePaletteDisplay.draw({redrawTiles:true});$("#"+this.prefix+"tilePaletteScale").val(s)},setCharPaletteScale:function(e,t){this.tilePaletteDisplay.setCharPaletteScale(e,t)},resize:function(){if(!this.canvas){return}var e=$("#"+this.prefix+"tilePaletteHolder");this.width=e.width();this.height=e.height();if(this.width!=this.canvas.style.width||this.height!=this.canvas.style.height){if(this.width!=0&&this.height!=0){this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvas.width=this.width*UI.devicePixelRatio;this.canvas.height=this.height*UI.devicePixelRatio}}this.tilePaletteDisplay.draw()},initCharPalette:function(){this.tilePaletteDisplay.initCharPalette();if(!UI.isMobile.any()){}this.initCharInfoCanvas()},drawCharPalette:function(){console.error("draw char palette!!");this.tilePaletteDisplay.draw()},drawTilePalette:function(e){var t=this.editor.tileSetManager.getCurrentTileSet();if(t==null){return}var i=t.getTileWidth();var r=t.getTileHeight();if(i!==this.tileWidth||r!==this.tileHeight){this.tileWidth=i;this.tileHeight=r;this.tileMarginChange();this.setScale()}if(this.editor.graphic.getType()=="sprite"){if(g_app.isMobile()){this.editor.spriteFramesMobile.draw()}else{this.editor.spriteFrames.draw()}}else{if(g_app.isMobile()){this.editor.tilePaletteMobile.draw()}else{if(typeof e!="undefined"&&typeof e.redrawTiles!="undefined"&&e.redrawTiles){if(t.getTileHeight()>32){var a="";var s=$("#"+this.prefix+"tilePaletteScale").val();a+='<option value="0.25" ';if(s==.25){a+=' selected="selected"'}a+=">25%</option>";a+='<option value="0.5" ';if(s==.5){a+=' selected="selected"'}a+=">50%</option>";a+='<option value="1" ';if(s==1){a+=' selected="selected"'}a+=">100%</option>";$("#"+this.prefix+"tilePaletteScale").html(a);if(s>1){this.tilePaletteDisplay.setScale(.5);$("#"+this.prefix+"tilePaletteScale").val(.5)}}else{var a="";var s=$("#"+this.prefix+"tilePaletteScale").val();a+='<option value="0.5">50%</option>';for(var o=1;o<=4;o++){a+='<option value="'+o+'" ';if(o==s){a+=' selected="selected" '}a+=">";a+=o+"00%</option>"}$("#"+this.prefix+"tilePaletteScale").html(a)}}this.tilePaletteDisplay.draw(e)}}},selectRecent:function(e){if(this.editor.currentTile.recentCharacters.length==0){return}var t=this.charRecentIndex-e;if(t<0){t=0}if(t>=this.editor.currentTile.recentCharacters.length){t=this.editor.currentTile.recentCharacters.length-1}this.charRecentIndex=t;var i=this.editor.currentTile.recentCharacters[this.editor.currentTile.recentCharacters.length-1-t];this.editor.setSelectedTiles([[i]])},rotateCharacter:function(){var e=this.editor.currentTile.getCharacters();if(e.length==0){return}var t=e[0][0];var i=this.editor.tileSetManager.getCurrentTileSet();var r=i.getCharNextRotation(t);if(t===r){r=false}if(r!==false){this.editor.setSelectedTiles([[r]]);return}if(this.editor.getHasTileRotate()){this.editor.currentTile.rotate2d()}},keyDown:function(e){switch(e.keyCode){case keys.textMode.tilePaletteLeft.keyCode:if(keys.textMode.tilePaletteLeft.shift==e.shiftKey){this.tilePaletteDisplay.moveSelection(-1,0)}break;case keys.textMode.tilePaletteRight.keyCode:if(keys.textMode.tilePaletteRight.shift==e.shiftKey){this.tilePaletteDisplay.moveSelection(1,0)}break;case keys.textMode.tilePaletteUp.keyCode:if(keys.textMode.tilePaletteRight.shift==e.shiftKey){this.tilePaletteDisplay.moveSelection(0,-1)}break;case keys.textMode.tilePaletteDown.keyCode:if(keys.textMode.tilePaletteDown.shift==e.shiftKey){this.tilePaletteDisplay.moveSelection(0,1)}break;case keys.textMode.characterRecentNext.keyCode:if(keys.textMode.characterRecentNext.shift==e.shiftKey){this.selectRecent(1)}break;case keys.textMode.characterRecentPrev.keyCode:if(keys.textMode.characterRecentPrev.shift==e.shiftKey){this.selectRecent(-1)}break;case keys.textMode.characterRotate.keyCode:this.rotateCharacter();break}},keyUp:function(e){},keyPress:function(e){},charPaletteTouch:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;var r=this.charPaletteXYToChar(t,i);if(r!==false){this.editor.currentTile.setCharacter(r);UI.closeDialog()}},initCharInfoCanvas:function(){if(this.characterCanvas==null){this.characterCanvas=document.getElementById(this.prefix+"tilepalette-tileinfocanvas")}var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileWidth();var i=e.getTileHeight();this.characterCanvasScale=Math.floor(UI.devicePixelRatio);var r=2;if(i>=10){r=1}if(r*i>26){r=26/i}this.characterCanvas.width=16*UI.devicePixelRatio;this.characterCanvas.height=16*UI.devicePixelRatio;this.characterCanvas.style.width="16px";this.characterCanvas.style.height="16px";this.characterCanvasScale*=r;this.characterContext=this.characterCanvas.getContext("2d");this.characterImageData=this.characterContext.getImageData(0,0,this.characterCanvas.width,this.characterCanvas.height)},setHighlightCharacter:function(e){this.tilePaletteDisplay.setHighlightCharacter(e);this.setCharacterInfo(e)},clearHighlightCharacter:function(){this.tilePaletteDisplay.clearHighlightCharacter()},setCharacterInfoToCurrent:function(){if(this.tileInfoTile!==false){return}var e=this.editor.currentTile;tiles=e.getTiles();var t="";if(tiles.length==1&&tiles[0].length==1){var i=("00"+tiles[0][0].toString(16)).substr(-2);t+=tiles[0][0]+" (0x"+i+")"}$("#"+this.prefix+"charpalette-charinfo").html(t);var r=e.tileSettingsTileCanvas;if(r&&this.characterContext){this.characterContext.clearRect(0,0,this.characterCanvas.width,this.characterCanvas.height);this.characterContext.drawImage(r,0,0,r.width,r.height,0,0,this.characterCanvas.width,this.characterCanvas.height)}},setCharacterInfo:function(e){this.tileInfoTile=e;if(e===false){this.setCharacterInfoToCurrent();return}var t=("00"+e.toString(16)).substr(-2);var i="";i+=e+" (0x"+t+")";$("#"+this.prefix+"charpalette-charinfo").html(i);var r=this.editor.tileSetManager.getCurrentTileSet();var a=this.characterCanvas.width/r.getTileWidth();var s=parseInt(e);if(isNaN(s)){return}var o=false;var l=false;var n=0;var h=this.editor.layers.getSelectedLayerObject();if(h&&h.getType()=="grid"){if(h.getHasTileFlip()){l=this.editor.currentTile.flipH;o=this.editor.currentTile.flipV}if(h.getHasTileRotate()){n=this.editor.currentTile.rotZ}}if(h.getScreenMode()==TextModeEditor.Mode.C64ECM){var d=Math.floor(s/256);s=s%64+d*256}if(r.getType()=="vector"){this.characterContext.clearRect(0,0,this.characterCanvas.width,this.characterCanvas.height)}r.drawCharacter({character:s,x:0,y:0,scale:a,imageData:this.characterImageData,context:this.characterContext,colorRGB:14540253,bgColorRGB:1118481,flipV:o,flipH:l,rotZ:n});if(r.getType()!="vector"){this.characterContext.putImageData(this.characterImageData,0,0)}}};var TilePaletteEditor=function(){this.editor=null;this.tilePaletteDisplay=null;this.uiComponent=null};TilePaletteEditor.prototype={init:function(e){this.editor=e},show:function(){var t=this;var e=600;var i=600;if(!this.uiComponent){var r="";this.canvasElementId="tilePaletteEditorCanvas";r='<div class="panelFill">';r+='<div id="'+this.canvasElementId+'Holder" style="position: absolute; top: 0; bottom: 0; left: 0; right: 0">';r+='<canvas id="'+this.canvasElementId+'" style="position: absolute; top: 0; bottom: 0; left: 0; right: 0;"></canvas>';r+="</div>";r+="</div>";this.htmlPanel=UI.create("UI.HTMLPanel",{id:"tilePaletteEditor",html:r});this.uiComponent=UI.create("UI.Dialog",{id:"tilePaletteEditorDialog",title:"Edit Tile Palette",width:e,height:i});this.uiComponent.add(this.htmlPanel);this.uiComponent.on("resize",function(){t.resize()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.endSortTilePalette(true);UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){t.endSortTilePalette(false);UI.closeDialog()});UI.showDialog("tilePaletteEditorDialog");this.tilePaletteDisplay=new TilePaletteDisplay;this.tilePaletteDisplay.init(this.editor,{canvasElementId:this.canvasElementId,resizeCanvas:false,blockStacking:"vertical"});this.canvas=document.getElementById(this.canvasElementId)}else{UI.showDialog("tilePaletteEditorDialog")}this.resize();this.draw();this.startSortTilePalette()},startSortTilePalette:function(){var e=this.editor.tileSetManager.noTile;this.tilePaletteDisplay.setMode("sort");var t=this.editor.tileSetManager.getCurrentTileSet();var i=t.getPaletteMap("custom");var r=[];if(i===false){r=this.editor.tools.drawTools.tilePalette.tilePaletteDisplay.getCharPaletteMap()}else{r=i.data}var a=[];this.tileSortMap=[];for(var s=0;s<r.length;s++){this.tileSortMap[s]=[];for(var o=0;o<r[s].length;o++){this.tileSortMap[s][o]=r[s][o];a.push(r[s][o])}}if(r.length<32){for(var s=r.length;s<32;s++){this.tileSortMap[s]=[];for(var o=0;o<r[0].length;o++){this.tileSortMap[s][o]=e}}}$("#"+this.prefix+"charPaletteSortOrder").val("custom");this.tilePaletteDisplay.setCharPaletteMap(this.tileSortMap,"custom");this.tilePaletteDisplay.draw({redrawTiles:true})},debugDownload:function(e){var t=this.editor.tileSetManager.getCurrentTileSet();var i=[];console.log(e);console.log(JSON.stringify(e));for(var r=0;r<e.length;r++){if(t.vectorData[e[r]]){i.push({name:t.vectorData[e[r]].name,unicode:t.vectorData[e[r]].unicode,path:t.vectorData[e[r]].path})}}var a={};a.data=i;a.unitsPerEm=t.unitsPerEm;a.ascent=t.ascent;a.descent=t.descent;a.blankTile=t.blankCharacter;a.filledTile=t.filledCharacter;console.log(a);download(JSON.stringify(a),"tileset.json","application/json")},endSortTilePalette:function(e){var t=this.editor.tileSetManager.noTile;if(e){var i=this.editor.tileSetManager.getCurrentTileSet();var r=this.tilePaletteDisplay.getCharPaletteMap();var a=0;for(var s=0;s<r.length;s++){var o=false;for(var l=0;l<r[s].length;l++){if(r[s][l]!==t){o=true}}if(o&&s>a){a=s}}r.length=a+1;i.setPaletteMap("custom",{data:r,rowsPerColumn:8});this.editor.tools.drawTools.tilePalette.selectTilePaletteMapType("custom")}this.tilePaletteDisplay.setMode("grid")},resize:function(){if(!this.canvas){return}var e=$("#"+this.canvasElementId+"Holder");this.width=e.width();this.height=e.height();if(this.width!=this.canvas.style.width||this.height!=this.canvas.style.height){if(this.width!=0&&this.height!=0){this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvas.width=this.width*UI.devicePixelRatio;this.canvas.height=this.height*UI.devicePixelRatio}}this.tilePaletteDisplay.draw()},draw:function(){this.tilePaletteDisplay.draw({redrawTiles:true})}};var TilePaletteMobile=function(){this.editor=null;this.uiComponent=null;this.canvas=null;this.context=null;this.paletteCanvas=null;this.paletteContext=null;this.scale=1;this.tileVPadding=1;this.tileHPadding=1;this.paletteTiles=[];this.tileWidth=8;this.tileHeight=8;this.blockWidth=1;this.blockHeight=1;this.touchOnTile=false;this.highlightTouchOnTile=false;this.touchVelocity=null;this.xScroll=0;this.velocityTween=null};TilePaletteMobile.prototype={setPaletteTiles:function(){var e=this.editor.tileSetManager.getCurrentTileSet();if(!e){return}if(this.editor.graphic.getType()=="sprite"){}else{this.paletteTiles=[];if(this.editor.tools.drawTools.tool=="block"){var t=this.editor.blockSetManager.getCurrentBlockSet();this.tileCount=t.getBlockCount();for(var i=0;i<this.tileCount;i++){this.paletteTiles.push({b:i})}}else{this.tileCount=e.getTileCount();for(var i=0;i<this.tileCount;i++){this.paletteTiles.push({t:i})}}}},init:function(e,t){this.editor=e;this.touchVelocity=new TouchVelocity},setCurrentTileVisible:function(e){this.splitpanel.setPanelVisible("west",e)},buildInterface:function(e){this.splitpanel=UI.create("UI.SplitPanel");var t="";t='<div id="tilePaletteMobileHolder" style="position: absolute; top: 0; bottom: 0; left: 0; right: 0; overflow-x: auto; overflow-y: hidden">';t+='<canvas id="tilePaletteMobileCanvas" style="background-color: black"></canvas>';t+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{html:t});this.splitpanel.add(this.uiComponent);this.currentTilePanel=UI.create("UI.Panel");this.splitpanel.addWest(this.currentTilePanel,70,false);var t="";t+='<canvas id="tilePaletteMobileCurrentTile" style="padding: 6px 6px 6px 8px" ></canvas>';var i=UI.create("UI.HTMLPanel",{html:t});this.currentTilePanel.add(i);e.add(this.splitpanel);var r=this;UI.on("ready",function(){r.initCurrentTileContent();r.initEvents()})},initCurrentTileContent:function(){var e="tilePaletteMobileCurrentTile";var t=document.getElementById(e);var i=48;var r=48;var a=Math.floor(UI.devicePixelRatio);t.width=i*a;t.height=r*a;t.style.width=i+"px";t.style.height=r+"px";var s=this;t.addEventListener("click",function(e){s.editor.currentTile.chooseCharacterMobile(e)},false);$("#"+e).on("contextmenu",function(e){var t=s.editor.currentTile.getCharacters();if(t.length>0&&t[0].length>0){s.editor.showTileEditor({character:t[0][0]})}e.preventDefault()})},initEvents:function(){var t=this;this.canvas=document.getElementById("tilePaletteMobileCanvas");if(!this.canvas){return}$("#tilePaletteMobileCanvas").on("contextmenu",function(e){e.preventDefault();if(t.touchOnTile!==false){t.editor.showTileEditor({character:t.touchOnTile})}});this.canvas.addEventListener("touchstart",function(e){t.touchStart(e)},false);this.canvas.addEventListener("touchmove",function(e){t.touchMove(e)},false);this.canvas.addEventListener("touchend",function(e){t.touchEnd(e)},false)},tileFromXY:function(e,t){e=e-this.tileHPadding*this.scale-this.xScroll;var i=Math.floor(e/((this.tileWidth*this.blockWidth+this.tileHPadding)*this.scale));if(isNaN(i)||i>=this.tileCount||i<0){return false}return i},touchStart:function(e){this.touchVelocity.touchStart(e);if(this.velocityTween!==null){this.velocityTween.stop();this.velocityTween=null}e.preventDefault();var t=e.touches;if(t.length==1){var i=t[0].pageX-$("#"+this.canvas.id).offset().left;var r=t[0].pageY-$("#"+this.canvas.id).offset().top;this.highlightTouchOnTile=true;this.touchOnTile=this.tileFromXY(i,r);this.touchStartX=i;this.touchStartScollX=this.xScroll;this.scrollLeftStart=this.xScroll;this.draw()}},touchMove:function(e){this.touchVelocity.touchMove(e);e.preventDefault();var t=e.touches;if(t.length==1){var i=t[0].pageX-$("#"+this.canvas.id).offset().left;var r=t[0].pageY-$("#"+this.canvas.id).offset().top;this.xScroll=this.touchStartScollX+(i-this.touchStartX);if(this.xScroll>0){this.xScroll=0}if(this.xScroll<-this.xScrollMax){this.xScroll=-this.xScrollMax}this.touchOnTile=this.tileFromXY(i,r);this.draw({redrawTileset:false})}},setXScroll:function(e){this.xScroll=e;if(this.xScroll>0){this.xScroll=0}if(this.xScroll<-this.xScrollMax){this.xScroll=-this.xScrollMax}},startVelocityTween:function(e){var r={vx:e.vx};var a=getTimestamp();var s=this;this.velocityTween=new TWEEN.Tween(r).to({vx:0},800).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){var e=getTimestamp();var t=e-a;a=e;var i=t*r.vx;s.setXScroll(s.xScroll+i);s.draw({redrawTileset:false})}).onComplete(function(){s.velocityTween=null}).start()},touchEnd:function(e){e.preventDefault();this.scrollLeftEnd=this.xScroll;var t=this.scrollLeftEnd-this.scrollLeftStart;if(t<10&&t>-10){if(this.touchOnTile!==false){if(this.editor.tools.drawTools.tool=="block"){this.editor.currentTile.setBlock(this.touchOnTile)}else{this.editor.currentTile.setCharacters([[this.touchOnTile]])}}}else{this.touchVelocity.touchEnd(e);var i=this.touchVelocity.getVelocity();if(i.vx<-.07||i.vx>.07){this.startVelocityTween(i)}}this.highlightTouchOnTile=false;this.draw({redrawTileset:false})},drawPalette:function(){var e=false;var t=TextModeEditor.Mode.TEXTMODE;var i=this.editor.tileSetManager.getCurrentTileSet();var r=this.editor.blockSetManager.getCurrentBlockSet();var a=this.editor.currentTile;var s=this.editor.colorPaletteManager;if(g_app.mode=="2d"){var o=this.editor.layers.getSelectedLayerObject();if(!o||o.getType()!=="grid"){return}t=o.getScreenMode()}if(this.paletteCanvas==null){this.paletteCanvas=document.createElement("canvas")}this.blockWidth=1;this.blockHeight=1;if(this.editor.tools.drawTools.tool=="block"){e=r.getBlocks();var l=0;var n=0;for(var h=0;h<e.length;h++){var d=e[h].data;if(d.length>0){var c=d[0].length;var f=d.length;if(c>l){l=c}if(f>n){n=f}}}this.blockWidth=l;this.blockHeight=n}var u=this.xScroll;this.tileWidth=i.getTileWidth();this.tileHeight=i.getTileHeight();this.tileHPadding=1;this.tileVPadding=1;if(t==TextModeEditor.Mode.VECTOR){this.tileHPadding=2;this.tileVPadding=2}this.scale=Math.floor(this.canvas.height/(this.tileHeight*this.blockHeight));if(t==TextModeEditor.Mode.VECTOR){this.tileHeight=this.canvas.height-2;this.tileWidth=this.tileHeight;this.scale=1}var p=(this.tileWidth*this.blockWidth+this.tileHPadding)*this.scale;this.xScrollMax=p*this.paletteTiles.length-this.canvas.width;if(this.xScrollMax<0){this.xScrollMax=0}if(-u>this.xScrollMax){u=-this.xScrollMax}if(-u<0){u=0}var v=Math.ceil(this.canvas.width/p);var g=Math.floor(-u/p);var m=g+v+1;if(m>this.paletteTiles.length){m=this.paletteTiles.length}v=m-g;this.offscreenOffsetX=g*p+u;this.offscreenHeight=this.canvas.height;this.offscreenWidth=v*(p/this.scale);if(this.paletteCanvas.width<this.offscreenWidth||this.paletteCanvas.height<this.offscreenHeight||this.paletteContext==null){this.paletteCanvas.width=this.offscreenWidth;this.paletteCanvas.height=this.offscreenHeight;this.paletteContext=this.paletteCanvas.getContext("2d");this.paletteContext.clearRect(0,0,this.paletteCanvas.width,this.paletteCanvas.height);this.paletteImageData=this.paletteContext.getImageData(0,0,this.paletteCanvas.width,this.paletteCanvas.height)}if(t==TextModeEditor.Mode.VECTOR){this.paletteContext.clearRect(0,0,this.paletteCanvas.width,this.paletteCanvas.height)}var y={};y["screenMode"]=t;if(t===TextModeEditor.Mode.INDEXED){y["transparentColorIndex"]=o.getTransparentColorIndex()}y["imageData"]=this.paletteImageData;y["context"]=this.paletteContext;y["color"]=a.getColor();y["bgColor"]=a.getBGColor();if(t==TextModeEditor.Mode.C64ECM){y["bgColor"]=this.editor.getC64ECMColor(y["bgColor"])}if(y["bgColor"]===this.editor.colorPaletteManager.noColor){y["bgColorRGB"]=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg)}var b=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg);if(t==TextModeEditor.Mode.C64MULTICOLOR){y["bgColorRGB"]="#ff0000";y["backgroundColor"]=o.getBackgroundColor();y["c64Multi1Color"]=o.getC64Multi1Color();y["c64Multi2Color"]=o.getC64Multi2Color()}var C=this.editor.getColorPerMode();var x=s.getCurrentColorPalette();if(!x){return}if(t==TextModeEditor.Mode.VECTOR){y["scale"]=this.tileHeight/i.getTileHeight()}else{y["scale"]=1}for(var h=0;h<v;h++){var S=this.tileHPadding+h*(this.tileWidth*this.blockWidth+this.tileHPadding);var P=this.tileVPadding;var w=h+g;if(w<0||w>=this.paletteTiles.length){break}if(this.editor.tools.drawTools.tool=="block"){var I=this.paletteTiles[w].b;var d=e[I].data;for(var k=0;k<d.length;k++){for(var M=0;M<d[k].length;M++){var T=d[k][M].t;y["character"]=T;if(C=="character"){var D=i.getTileColor(T);var E=i.getCharacterBGColor(T);y["colorRGB"]=x.getHex(D);y["color"]=D;if(E!=this.editor.colorPaletteManager.noColor){y["bgColorRGB"]=x.getHex(E)}else{y["bgColorRGB"]=b}}y["x"]=S+M*this.tileWidth;y["y"]=P+k*this.tileHeight;i.drawCharacter(y)}}}else{var T=this.paletteTiles[w].t;if(S+this.tileWidth>this.paletteCanvas.width){console.log("x greater than canvas size");break}y["character"]=T;if(C=="character"){var D=i.getTileColor(T);var E=i.getCharacterBGColor(T);y["colorRGB"]=x.getHex(D);y["color"]=D;if(E!=this.editor.colorPaletteManager.noColor){y["bgColorRGB"]=x.getHex(E)}else{y["bgColorRGB"]=b}}y["x"]=S/y["scale"];y["y"]=P/y["scale"];i.drawCharacter(y)}}if(t!==TextModeEditor.Mode.VECTOR){this.paletteContext.putImageData(this.paletteImageData,0,0)}return;if(g_app.mode=="2d"){var o=this.editor.layers.getSelectedLayerObject();if(!o||o.getType()!=="grid"){return}t=o.getScreenMode()}if(this.paletteCanvas==null){this.paletteCanvas=document.createElement("canvas")}this.tileWidth=i.getTileWidth();this.tileHeight=i.getTileHeight();if(t==TextModeEditor.Mode.VECTOR){this.tileHeight=this.canvas.height-10;this.tileWidth=this.tileHeight}this.blockWidth=1;this.blockHeight=1;if(this.editor.tools.drawTools.tool=="block"){e=r.getBlocks();var l=0;var n=0;for(var h=0;h<e.length;h++){var d=e[h].data;if(d.length>0){var c=d[0].length;var f=d.length;if(c>l){l=c}if(f>n){n=f}}}this.blockWidth=l;this.blockHeight=n}var _=this.tileVPadding*2+this.tileHeight*this.blockHeight;this.tileHPadding=1;var B=$("#tilePaletteMobileHolder").height();if(_>B){this.tileHPadding=Math.ceil(_/B)}var R=this.tileHPadding+this.paletteTiles.length*(this.tileHPadding+this.tileWidth*this.blockWidth);if(R>this.canvasMaxWidth){R=this.canvasMaxWidth}this.paletteCanvas.width=R;this.paletteCanvas.height=_;this.paletteContext=this.paletteCanvas.getContext("2d");this.paletteContext.clearRect(0,0,this.paletteCanvas.width,this.paletteCanvas.height);this.paletteImageData=this.paletteContext.getImageData(0,0,this.paletteCanvas.width,this.paletteCanvas.height);var a=this.editor.currentTile;var s=this.editor.colorPaletteManager;var y={};y["screenMode"]=t;if(t===TextModeEditor.Mode.INDEXED){y["transparentColorIndex"]=o.getTransparentColorIndex()}y["imageData"]=this.paletteImageData;y["context"]=this.paletteContext;y["color"]=a.getColor();y["bgColor"]=a.getBGColor();if(t==TextModeEditor.Mode.C64ECM){y["bgColor"]=this.editor.getC64ECMColor(y["bgColor"])}if(y["bgColor"]===this.editor.colorPaletteManager.noColor){y["bgColorRGB"]=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg)}var b=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg);if(t==TextModeEditor.Mode.C64MULTICOLOR){y["bgColorRGB"]="#ff0000";y["backgroundColor"]=o.getBackgroundColor();y["c64Multi1Color"]=o.getC64Multi1Color();y["c64Multi2Color"]=o.getC64Multi2Color()}var C=this.editor.getColorPerMode();var x=s.getCurrentColorPalette();if(!x){return}if(t==TextModeEditor.Mode.VECTOR){y["scale"]=this.tileHeight/i.getTileHeight()}else{y["scale"]=1}for(var h=0;h<this.paletteTiles.length;h++){var S=this.tileHPadding+h*(this.tileWidth*this.blockWidth+this.tileHPadding);var P=this.tileVPadding;if(this.editor.tools.drawTools.tool=="block"){var I=this.paletteTiles[h].b;var d=e[I].data;if(S+M*this.tileWidth>this.canvasMaxWidth){break}for(var k=0;k<d.length;k++){for(var M=0;M<d[k].length;M++){var T=d[k][M].t;y["character"]=T;if(C=="character"){var D=i.getTileColor(T);var E=i.getCharacterBGColor(T);y["colorRGB"]=x.getHex(D);y["color"]=D;if(E!=this.editor.colorPaletteManager.noColor){y["bgColorRGB"]=x.getHex(E)}else{y["bgColorRGB"]=b}}y["x"]=S+M*this.tileWidth;y["y"]=P+k*this.tileHeight;y["scale"]=1;i.drawCharacter(y)}}}else{var T=this.paletteTiles[h].t;if(S+this.tileWidth>this.canvasMaxWidth){break}y["character"]=T;if(C=="character"){var D=i.getTileColor(T);var E=i.getCharacterBGColor(T);y["colorRGB"]=x.getHex(D);y["color"]=D;if(E!=this.editor.colorPaletteManager.noColor){y["bgColorRGB"]=x.getHex(E)}else{y["bgColorRGB"]=b}}y["x"]=S/y["scale"];y["y"]=P/y["scale"];i.drawCharacter(y)}}if(t!==TextModeEditor.Mode.VECTOR){this.paletteContext.putImageData(this.paletteImageData,0,0)}},resize:function(){var e=$("#tilePaletteMobileHolder").width();var t=$("#tilePaletteMobileHolder").height();this.canvas.width=e;this.canvas.height=t;this.context=UI.getContextNoSmoothing(this.canvas);this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},draw:function(e){var t=this.editor.tools.drawTools.tool;var i=true;if(typeof e!="undefined"){if(typeof e.redrawTileset!="undefined"){i=e.redrawTileset}}if(this.paletteCanvas==null){i=true}this.resize();if(i){this.setPaletteTiles()}this.drawPalette();var r=0;var a=0;var s=this.offscreenWidth;var o=this.offscreenHeight;var l=0;var n=0;dstWidth=s*this.scale;dstHeight=o*this.scale;l=this.offscreenOffsetX;this.context.drawImage(this.paletteCanvas,r,a,s,o,l,n,dstWidth,dstHeight);if(this.editor.tools.drawTools.tool=="block"){var h=this.editor.currentTile.getBlock();this.context.fillStyle=styles.tilePalette.selectOutline;this.context.strokeStyle=styles.tilePalette.selectOutline;this.context.beginPath();this.context.lineWidth=2;var d=this.tileHPadding*this.scale+h*this.scale*(this.tileWidth*this.blockWidth+this.tileHPadding)+this.xScroll;var c=this.tileVPadding*this.scale;var f=this.tileWidth*this.blockWidth*this.scale;var u=this.tileHeight*this.blockHeight*this.scale;this.context.rect(d,c,f,u);this.context.stroke()}else{var p=this.editor.currentTile.getCharacters();this.context.fillStyle=styles.tilePalette.selectOutline;this.context.strokeStyle=styles.tilePalette.selectOutline;this.context.beginPath();this.context.lineWidth=2;for(var v=0;v<p.length;v++){for(var g=0;g<p[v].length;g++){var m=p[v][g];var d=this.tileHPadding*this.scale+m*this.scale*(this.tileWidth+this.tileHPadding)+this.xScroll;var c=this.tileVPadding*this.scale;var f=this.tileWidth*this.scale;var u=this.tileHeight*this.scale;this.context.rect(d,c,f,u)}}this.context.stroke()}if(this.touchOnTile!==false&&this.highlightTouchOnTile){this.context.fillStyle=styles.tilePalette.highlightOutline;this.context.strokeStyle=styles.tilePalette.highlightOutline;this.context.beginPath();this.context.lineWidth=2;var m=this.touchOnTile;var d=this.tileHPadding*this.scale+m*this.scale*(this.tileWidth*this.blockWidth+this.tileHPadding)+this.xScroll;var c=this.tileVPadding*this.scale;var f=this.tileWidth*this.blockWidth*this.scale;var u=this.tileHeight*this.blockHeight*this.scale;this.context.rect(d,c,f,u);this.context.stroke()}}};var TilePaletteChooserMobile=function(){this.editor=null;this.tilePaletteDisplay=null;this.charRecentIndex=0;this.uiComponent=null;this.highlightCharacter=false;this.previewCanvas=null;this.selectedCanvas=null;this.mapType=false;this.mode="single";this.id="Choose";this.closeHandler=false};TilePaletteChooserMobile.prototype={init:function(e,t){this.editor=e;if(typeof t!="undefined"){if(typeof t.mode!="undefined"){this.mode=t.mode}if(typeof t.id!="undefined"){this.id=t.id}}},on:function(e,t){if(e=="close"){this.closeHandler=t}},show:function(e){if(this.uiComponent==null){var t=this;this.uiComponent=UI.create("UI.MobilePanel",{id:"tilePaletteMobile"+this.id,title:"Choose Tile",fullScreen:true,maxWidth:640,maxHeight:800});var i="";i+='<div class="panelFill" id="tilePaletteMobileDialog'+this.id+'">';var r="background-color: #222222";i+='<div style="position: absolute; left: 10px; top: 14px; width: 100px; height: 100px">';i+='<canvas id="tilePaletteMobileCanvasPreview'+this.id+'" style="'+r+'"></canvas>';i+="</div>";i+='<div id="tilePaletteMobileTileOrientation" style="position: absolute; left: 140px; top: 10px; width: 100px; height: 100px">';i+='<span id="tilePaletteMobileTileFlipControls">';i+='  <div class="ui-button" style="margin-top: 0px" id="tilePaletteMobileFlipH">Flip H</div>';i+='  <div class="ui-button" style="margin-top: 6px" id="tilePaletteMobileFlipV">Flip V</div>';i+="</span>";i+='<span id="tilePaletteMobileTileRotateControls">';i+='  <div class="ui-button" style="margin-top: 6px" id="tilePaletteMobileRotate">Rotate</div>';i+="</span>";i+="</div>";i+='<div id="tilePaletteMobileTileInfoPanel" style="position: absolute; left: 290px; top: 10px; right: 10px; height: 100px">';i+='  <div style="font-size: 22px" id="tilePaletteMobileInfo'+this.id+'"></div>';i+='  <div class="ui-button" style="margin-top: 20px" id="tilePaletteMobileEdit'+this.id+'">Edit Tile</div>';i+="</div>";i+='<div style="position: absolute; left: 0px; right: 0px; top: 134px; bottom: 45px; text-align: center; overflow-y: auto; overflow-x: hidden" id="tilePaletteMobileCanvasHolder'+this.id+'"><canvas id="tilePaletteMobileCanvas'+this.id+'" style="'+r+'"></canvas></div>';i+='<div style="position: absolute; left: 10px; right: 10px; bottom: 5px; height: 40px;  display: flex;  align-items: center; justify-content: space-between;">';i+='<select id="charPaletteSortOrderMobile'+this.id+'" style="min-width: calc(80% - 140px)">';i+="</select>";i+='<div class="ui-button" id="charPaletteMobileClearSelection'+this.id+'" style="margin-left: 8px;">Clear Selection</div>';i+='<div class="ui-button" id="charPaletteMobilePrevPage'+this.id+'" style="margin-left: 8px;">&lt;</div>';i+='<span id="charPaletteMobilePageInfo'+this.id+'"></span>';i+='<div class="ui-button" id="charPaletteMobileNextPage'+this.id+'" style="margin-left: 8px;">&gt;</div>';i+="</div>";i+="</div>";var a=UI.create("UI.HTMLPanel",{id:"tilePaletteMobileHTML"+this.id,html:i});this.uiComponent.add(a);if(this.mode=="multiple"){this.okButton=UI.create("UI.Button",{text:"OK"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){if(t.closeHandler){t.closeHandler()}UI.closeDialog()});$("#charPaletteMobileClearSelection"+this.id).show()}else{$("#charPaletteMobileClearSelection"+this.id).hide()}this.uiComponent.on("close",function(){});this.previewCanvas=document.getElementById("tilePaletteMobileCanvasPreview"+this.id);this.previewCanvasScale=Math.floor(UI.devicePixelRatio);this.selectedCanvas=document.createElement("canvas");this.tilePaletteDisplay=new TilePaletteDisplay;this.tilePaletteDisplay.init(this.editor,{canvasElementId:"tilePaletteMobileCanvas"+this.id,blockStacking:"vertical",mode:this.mode,colors:"monochrome",charMargin:3});this.tilePaletteDisplay.draw({redrawTiles:true});var t=this;this.tilePaletteDisplay.on("charactertouch",function(e){t.setCharacter(e)});this.tilePaletteDisplay.on("charactertouchend",function(e){if(t.mode==="single"){t.editor.currentTile.setCharacters([[e]]);UI.closeDialog()}});this.initEvents()}UI.showDialog("tilePaletteMobile"+this.id);this.initContent()},initTilePaletteDisplay:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileWidth();var i=e.getTileHeight();this.selectedCanvas.width=t;this.selectedCanvas.height=i;this.previewWidth=100;this.previewHeight=100;this.previewCanvas.width=this.previewWidth*this.previewCanvasScale;this.previewCanvas.height=this.previewHeight*this.previewCanvasScale;this.previewCanvas.style.width=this.previewWidth+"px";this.previewCanvas.style.height=this.previewHeight+"px";if(this.mapType!==false){this.setCharPaletteMapType(this.mapType)}var r=$("#tilePaletteMobileDialog"+this.id).width();var a=$("#tilePaletteMobileCanvasHolder"+this.id).height();console.log("dialog dimensions = "+r+","+a);var s=16;var o=16;this.tilePaletteDisplay.setColumnWidthMax(16);this.tilePaletteDisplay.setColumnHeightMax(16);var l=this.tilePaletteDisplay.getPage();var n=this.tilePaletteDisplay.getMaxPages();if(l>=n){l=0;this.tilePaletteDisplay.setPage(l)}var h=2;if(t>=16||i>=16){var d=s*t;var c=[2,1,.5,.25,.125];var f=0;for(f=0;f<c.length;f++){h=c[f];if(d*h<r){break}}}this.tilePaletteDisplay.setScale(h);if(i*h*o>a){h=1;this.tilePaletteDisplay.setScale(h)}console.log("tile palette scale is "+h);var u=Math.floor((r-s*t*h)/(s+1));var p=Math.floor((a-o*i*h)/(o+1));console.log("h spacing = "+u+", v spacing = "+p);var v=u;if(v>p){v=p}if(v<=0){v=1}console.log("margin = "+v);this.tilePaletteDisplay.setTileMargin(v);if(typeof args!="undefined"){if(typeof args.character!="undefined"){this.setCharacter(args.character);this.tilePaletteDisplay.setSelected([args.character])}if(typeof args.characters!="undefined"){this.tilePaletteDisplay.setSelected(args.characters)}}this.tilePaletteDisplay.draw({redrawTiles:true});this.editor.tileSetManager.tileSetUpdated({updateSortMethods:true});this.editor.tileSetManager.updateSortMethods();this.updatePageInfo();var g=this.editor.currentTile.getCharacters();if(g&&g.length>0){this.setCharacter(g[0][0])}this.drawSelectedTilePreview()},updatePageInfo:function(){var e="";var t=this.tilePaletteDisplay.getPage()+1;var i=this.tilePaletteDisplay.getMaxPages();e+=t+"/"+i;$("#charPaletteMobilePageInfo"+this.id).html(e)},nextPage:function(){var e=this.tilePaletteDisplay.getPage()+1;var t=this.tilePaletteDisplay.getMaxPages();if(e<t){this.tilePaletteDisplay.setPage(e);this.tilePaletteDisplay.draw({redrawTiles:true})}this.updatePageInfo()},prevPage:function(){var e=this.tilePaletteDisplay.getPage()-1;if(e>=0){this.tilePaletteDisplay.setPage(e);this.tilePaletteDisplay.draw({redrawTiles:true})}this.updatePageInfo()},initContent:function(){this.initTilePaletteDisplay();var e=this.editor.getHasTileFlip();var t=this.editor.getHasTileRotate();if(this.mode=="single"&&(e||t)){$("#tilePaletteMobileTileOrientation").show();$("#tilePaletteMobileTileInfoPanel").css("left","290px");if(e){$("#tilePaletteMobileTileFlipControls").show()}else{$("#tilePaletteMobileTileFlipControls").hide()}if(t){$("#tilePaletteMobileTileRotateControls").show()}else{$("#tilePaletteMobileTileRotateControls").hide()}}else{$("#tilePaletteMobileTileOrientation").hide();$("#tilePaletteMobileTileInfoPanel").css("left","170px")}},initEvents:function(){var i=this;$("#tilePaletteMobileEdit"+this.id).on("click",function(){UI.closeDialog();i.editor.showTileEditor({character:i.highlightCharacter})});$("#charPaletteSortOrderMobile"+this.id).on("change",function(e){var t=$(this).val();i.setCharPaletteMapType(t)});$("#charPaletteMobileClearSelection"+this.id).on("click",function(e){i.tilePaletteDisplay.setSelected([])});$("#charPaletteMobilePrevPage"+this.id).on("click",function(e){i.prevPage()});$("#charPaletteMobileNextPage"+this.id).on("click",function(e){i.nextPage()});$("#tilePaletteMobileFlipH").on("click",function(){i.editor.currentTile.flipH2d();i.drawSelectedTilePreview()});$("#tilePaletteMobileFlipV").on("click",function(){i.editor.currentTile.flipV2d();i.drawSelectedTilePreview()});$("#tilePaletteMobileRotate").on("click",function(){i.editor.currentTile.rotate2d();i.drawSelectedTilePreview()})},setCharPaletteMapType:function(e){this.mapType=e;this.tilePaletteDisplay.setCharPaletteMapType(this.mapType)},drawSelectedVector:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i=this.editor.getColorPerMode();var t=this.editor.colorPaletteManager.getCurrentColorPalette();var r=e.getTileWidth();var a=e.getTileHeight();var s=1;var o=1;var l=1;if(this.previewCanvas.width>r){o=this.previewCanvas.width/r}var l=1;if(this.previewCanvas.height>a){l=this.previewCanvas.height/a}if(o>l){s=l}else{s=o}var n=0;var h=0;var d=Math.floor(r*s);var c=Math.floor(a*s);n=Math.floor((this.previewCanvas.width-d)/2);h=Math.floor((this.previewCanvas.height-c)/2);var f={};f["character"]=this.highlightCharacter;if(i=="character"){var u=e.getTileColor(f["character"]);var p=e.getCharacterBGColor(f["character"]);f["colorRGB"]=t.getHex(u);f["color"]=u;if(p!=this.editor.colorPaletteManager.noColor){f["bgColorRGB"]=t.getHex(p)}else{}}else{f["color"]=this.editor.currentTile.color;f["bgColor"]=this.editor.currentTile.bgColor}f["x"]=n;f["y"]=h;f["scale"]=s;if(this.editor.getHasTileFlip()){f["flipH"]=this.editor.currentTile.flipH;f["flipV"]=this.editor.currentTile.flipV}if(this.editor.getHasTileRotate()){f["rotZ"]=this.editor.currentTile.rotZ}f["select"]=false;f["highlight"]=false;f["backgroundIsTransparent"]=true;f["context"]=this.previewCanvas.getContext("2d");e.drawCharacter(f);e.drawCharacter({})},drawSelected:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i=this.editor.getColorPerMode();var t=this.editor.colorPaletteManager.getCurrentColorPalette();this.selectedContext=this.selectedCanvas.getContext("2d");this.selectedContext.clearRect(0,0,this.selectedCanvas.width,this.selectedCanvas.height);var r={};this.selectedImageData=this.selectedContext.getImageData(0,0,this.selectedCanvas.width,this.selectedCanvas.height);r["imageData"]=this.selectedImageData;r["character"]=this.highlightCharacter;if(i=="character"){var a=e.getTileColor(r["character"]);var s=e.getCharacterBGColor(r["character"]);r["colorRGB"]=t.getHex(a);r["color"]=a;if(s!=this.editor.colorPaletteManager.noColor){r["bgColorRGB"]=t.getHex(s)}else{}}else{r["color"]=this.editor.currentTile.color;r["bgColor"]=this.editor.currentTile.bgColor}r["x"]=0;r["y"]=0;r["scale"]=1;if(this.editor.getHasTileFlip()){r["flipH"]=this.editor.currentTile.flipH;r["flipV"]=this.editor.currentTile.flipV}if(this.editor.getHasTileRotate()){r["rotZ"]=this.editor.currentTile.rotZ}r["select"]=false;r["highlight"]=false;r["backgroundIsTransparent"]=true;e.drawCharacter(r);this.selectedContext.putImageData(this.selectedImageData,0,0)},getSelectedCharacters:function(){return this.tilePaletteDisplay.getSelectedCharacters()},drawSelectedTilePreview:function(){var e=this.editor.tileSetManager.getCurrentTileSet();if(e.getType()=="vector"){this.drawSelectedVector();return}this.drawSelected();var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileWidth();var i=e.getTileHeight();this.context=this.previewCanvas.getContext("2d");this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;this.context.fillStyle="#222222";this.context.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height);var r=1;var a=1;var s=1;if(this.previewCanvas.width>t){a=this.previewCanvas.width/t}var s=1;if(this.previewCanvas.height>i){s=this.previewCanvas.height/i}if(a>s){r=s}else{r=a}var o=0;var l=0;var n=Math.floor(t*r);var h=Math.floor(i*r);o=Math.floor((this.previewCanvas.width-n)/2);l=Math.floor((this.previewCanvas.height-h)/2);this.context.drawImage(this.selectedCanvas,0,0,t,i,o,l,n,h)},setCharacter:function(e){this.highlightCharacter=e;this.drawSelectedTilePreview();var t=("00"+e.toString(16)).substr(-2);var i="";i+=e+" (0x"+t+")";$("#tilePaletteMobileInfo"+this.id).html(i)}};var BlockPalette=function(){this.canvas=null;this.scale=2;this.blocksAcross=4;this.blockSpacing=2;this.highlightBlock=false;this.highlightBlockX=false;this.highlightBlockY=false;this.selectedBlock=false;this.selectedBlockX=false;this.selectedBlockY=false;this.editBlockId=false;this.mouseDownOnBlock=false;this.blockSpacing=2;this.blockPositions=[];this.prefix=""};BlockPalette.prototype={init:function(e,t){this.editor=e;if(typeof t!="undefined"){if(typeof t.prefix!="undefined"){this.prefix=t.prefix}}},start:function(){console.log("start block palette!");this.drawBlockPalette()},buildInterface:function(e){var t=this;var i=UI.create("UI.Panel",{id:this.prefix+"blockPalette"});e.add(i);var r=UI.create("UI.SplitPanel");i.add(r);var a="";a+='<span id="'+this.prefix+'blockPaletteBlockInfo" style="display: inline-block; width: 80px; margin-left: 4px;  overflow: hidden; white-space: nowrap; text-overflow: ellipsis">0</span>';a+='<span style="margin-right: 20px">';a+='<label for="blockPaletteBlockCount">Meta Tile Count</label>:&nbsp;';a+='<span id="'+this.prefix+'blockPaletteBlockCount" style="margin-right: 10px">0</span>';a+='<div class="ui-button" id="'+this.prefix+'blockPaletteBlockCountDec">-</div>';a+="&nbsp;";a+='<div class="ui-button" id="'+this.prefix+'blockPaletteBlockCountInc">+</div>';a+="</span>";var s=UI.create("UI.HTMLPanel",{id:this.prefix+"blockPaletteControls",html:a});r.addSouth(s,26,false);var o="";o+='<div class="panelFill" id="'+this.prefix+'blockPalette" style="overflow-x: hidden; overflow-y: auto;">';o+='  <div class="title" style="background-color: #111111; height: 18px; overflow: none; white-space: nowrap">';o+='    <div style="position: absolute; font-size: 10px; top: 2px; left: 6px; right: 30px; overflow: hidden; white-space: nowrap">';o+="    Meta Tiles";o+="    </div>";o+='    <div style="position: absolute; top: 2px; right: 2px; width: 20px">';o+='      <div id="'+this.prefix+'blockPaletteCloseButton" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>';o+="    </div>";o+="  </div>";o+='  <canvas id="'+this.prefix+'blockPaletteCanvas" style="position: absolute; top: 18px; left: 0; background-color: #111111"></canvas>';o+="</div>";var l=UI.create("UI.HTMLPanel",{id:this.prefix+"blockPaletteBlocks",html:o});r.add(l);e.on("resize",function(){t.drawBlockPalette()});UI.on("ready",function(){t.initEvents()})},initEvents:function(){var t=this;$("#"+this.prefix+"blockPaletteCloseButton").on("click",function(){if(t.prefix=="side"){t.editor.setSideBlockPanelVisible(false)}else{t.editor.setBottomBlockPanelVisible(false)}});$("#"+this.prefix+"createBlock").on("click",function(){t.createBlock()});$("#"+this.prefix+"blockPaletteBlockCountInc").on("click",function(){t.blockCountChange(1)});$("#"+this.prefix+"blockPaletteBlockCountDec").on("click",function(){t.blockCountChange(-1)});this.canvas=document.getElementById(this.prefix+"blockPaletteCanvas");this.canvas.addEventListener("dblclick",function(e){t.doubleClick(e)},false);this.canvas.addEventListener("mousedown",function(e){t.mouseDown(e)},false);this.canvas.addEventListener("mousemove",function(e){t.mouseMove(e)},false);this.canvas.addEventListener("mouseleave",function(e){t.mouseLeave(e)},false);this.canvas.addEventListener("mouseup",function(e){t.mouseUp(e)},false)},editBlock:function(i){var r=this;this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var e={};e.blockId=i;e.blockData=this.blockSet.getBlockData(i);e.callback=function(e,t){r.blockSet.setBlock(i,t);r.drawBlockPalette();r.selectBlock(i);r.editor.graphic.redraw({allCells:true})};this.editor.blockEditor.show(e)},blockCountChange:function(e){if(this.editor.tools.drawTools.tool!="block"){this.editor.tools.drawTools.setDrawTool("block")}if(e>0){this.createBlock()}else if(e<0){this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var t=this.blockSet.getBlockCount();t+=e;if(t<0){return}var i=this.editor.layers.getSelectedLayerObject();if(i&&i.getBlockModeEnabled()){if(t<1){return}}this.blockSet.setBlockCount(t);while(this.selectedBlock>=t){this.selectedBlock--}if(this.selectedBlock<0){this.selectedBlock=false}this.drawBlockPalette()}},updateBlockCountHTML:function(){var e=this.editor.blockSetManager.getCurrentBlockSet();var t=e.getBlockCount();$("#"+this.prefix+"blockPaletteBlockCount").html(t)},createBlock:function(){var r=this;this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var e={};e.block=false;e.blockWidth=4;e.blockHeight=4;e.callback=function(e,t){var i=r.blockSet.createBlock(t);if(i!==false){r.selectBlock(i)}r.drawBlockPalette()};this.editor.blockEditor.show(e)},blockPaletteXYToBlock:function(e,t){for(var i=0;i<this.blockPositions.length;i++){if(e>this.blockPositions[i].left&&e<this.blockPositions[i].right&&t>this.blockPositions[i].top&&t<this.blockPositions[i].bottom){return i}}return false},doubleClick:function(e){if(this.selectedBlock!==false){this.editBlock(this.selectedBlock)}},mouseLeave:function(e){this.setBlockInfo(this.selectedBlock)},mouseDown:function(e){if(this.highlightBlock!==false){this.mouseDownOnBlock=this.highlightBlock;if(this.highlightBlock===this.mouseDownOnBlock){if(this.editor.tools.drawTools.tool!="block"){this.editor.tools.drawTools.setDrawTool("block")}this.selectBlock(this.highlightBlock)}}},mouseMove:function(e){var t=e.pageX-$("#"+this.prefix+"blockPaletteCanvas").offset().left;var i=e.pageY-$("#"+this.prefix+"blockPaletteCanvas").offset().top;var r=false;var a=this.editor.tileSetManager.getCurrentTileSet();var s=this.highlightBlock;this.highlightBlock=this.blockPaletteXYToBlock(t,i);if(this.highlightBlock!==s){this.setBlockInfo(this.highlightBlock);this.drawBlockPalette()}},mouseUp:function(e){},setBlockInfo:function(e){if(e===false){return}var t=("00"+e.toString(16)).substr(-2);var i="";i+=e+" (0x"+t+")";$("#"+this.prefix+"blockPaletteBlockInfo").html(i)},selectBlock:function(e){if(typeof e!=="undefined"){this.selectedBlock=e}else{if(this.selectedBlock===false){return}}this.drawBlockPalette();this.setBlockInfo(this.selectedBlock);this.editor.currentTile.setBlock(this.selectedBlock)},getSelectedBlockId:function(){return this.selectedBlock},canvasDimensions:function(e){if(!this.editor.blockSetManager){return}this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();if(this.blockSet===null){return}var t=this.editor.tileSetManager.getCurrentTileSet();var i=t.charWidth;var r=t.charHeight;var a=this.blockSet.getBlocks();var s=500;var o=200;s=$("#"+this.prefix+"blockPalette").width();if(isNaN(s)||s<200){s=200}this.canvasScale=Math.floor(UI.devicePixelRatio);var l=0;var n=0;var h=0;for(var d=0;d<a.length;d++){var c=a[d].data;if(c.length>0){var f=c[0].length*i*this.scale;var u=c.length*r*this.scale;if(l+f>s){l=0;n+=h+this.blockSpacing;h=0}if(u>h){h=u}l+=f+this.blockSpacing}}o=n+h;if(o==0){o=r}if(this.canvas==null){this.canvas=document.getElementById(this.prefix+"blockPaletteCanvas")}if(isNaN(s)||s<=0){console.log("invalid block palette canvas width");s=8}if(isNaN(o)||o<=0){console.log("invalid block palette canvas height");o=8}if(this.context==null||this.canvas.width!=s*this.canvasScale||this.canvas.height!=o*this.canvasScale){this.canvas.style.width=s+"px";this.canvas.style.height=o+"px";this.canvas.width=s*this.canvasScale;this.canvas.height=o*this.canvasScale;this.context=this.canvas.getContext("2d")}},moveSelection:function(e,t){if(this.selectedBlock!==false){var i=this.blockPositions[this.selectedBlock];var r=i.gridX+e;var a=i.gridY+t;var s=false;for(var o=0;o<this.blockPositions.length;o++){if(this.blockPositions[o].gridX==r&&this.blockPositions[o].gridY==a){s=o;break}}if(s!==false){this.selectBlock(s)}}},keyDown:function(e){switch(e.keyCode){case keys.textMode.tilePaletteLeft.keyCode:if(keys.textMode.tilePaletteLeft.shift==e.shiftKey){this.moveSelection(-1,0)}break;case keys.textMode.tilePaletteRight.keyCode:if(keys.textMode.tilePaletteRight.shift==e.shiftKey){this.moveSelection(1,0)}break;case keys.textMode.tilePaletteUp.keyCode:if(keys.textMode.tilePaletteRight.shift==e.shiftKey){this.moveSelection(0,-1)}break;case keys.textMode.tilePaletteDown.keyCode:if(keys.textMode.tilePaletteDown.shift==e.shiftKey){this.moveSelection(0,1)}break}},keyUp:function(e){},keyPress:function(e){},drawBlockPalette:function(){if(!this.editor.blockSetManager||!this.editor.tools){return}var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return}var t=e.getScreenMode();if(this.editor.tools.drawTools.tool!="block"){}this.canvasDimensions();this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();if(this.blockSet===null){return}var i=this.editor.tileSetManager.getCurrentTileSet();var r=i.charWidth;var a=i.charHeight;var s=this.blockSet.getBlocks();var o=this.canvas.width;var l=this.canvas.height;if(o===0||l===0){return}this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var n=this.editor.getColorPerMode();var h=this.editor.colorPaletteManager.getCurrentColorPalette();if(!h){return}args={};args["imageData"]=this.imageData;args["colorRGB"]=ColorUtils.hexStringToInt(styles.textMode.tilePaletteFg);args["bgColorRGB"]=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg);var d=args["bgColorRGB"];if(t==TextModeEditor.Mode.C64MULTICOLOR){d=h.getHex(e.getBackgroundColor());args["backgroundColor"]=e.getBackgroundColor();args["c64Multi1Color"]=e.getC64Multi1Color();args["c64Multi2Color"]=e.getC64Multi2Color()}var c=0;var f=0;var u=0;var p=0;var v=0;this.blockPositions=[];this.blockGrid=[];this.blockGrid.push([]);var g=this.editor.currentTile.getColor();var m=this.editor.currentTile.getBGColor();for(var y=0;y<s.length;y++){var b=s[y].data;var C=s[y].colorMode;var x=s[y].fc;var S=s[y].bc;if(b.length>0){var P=b[0].length*r*this.scale*this.canvasScale;var w=b.length*a*this.scale*this.canvasScale;if(c+P>o){c=0;f+=v+this.blockSpacing;v=0;u=0;p++;if(f>l){return}}if(w>v){v=w}this.blockPositions.push({gridX:u,gridY:p,top:f/this.canvasScale,left:c/this.canvasScale,bottom:(f+w)/this.canvasScale,right:(c+P)/this.canvasScale});for(var I=0;I<b.length;I++){for(var k=0;k<b[I].length;k++){var M=b[I][k].t;if(n=="character"){var T=i.getTileColor(M);var D=i.getCharacterBGColor(M);args["colorRGB"]=h.getHex(T);args["color"]=T;args["bgColor"]=D}else if(n=="block"){args["color"]=x;args["bgColor"]=S}else{if(C=="percell"){args["color"]=b[I][k].fc;args["bgColor"]=b[I][k].bc}if(C=="perblock"){args["color"]=x;args["bgColor"]=S}if(C=="none"){args["colorRGB"]=14540253;args["bgColor"]=this.editor.colorPaletteManager.noColor}}if(t==TextModeEditor.Mode.C64ECM){var E=Math.floor(M/64)%4;var $=Math.floor(M/256);M=M%64+$*256;args["bgColor"]=e.getC64ECMColor(E)}if(args["bgColor"]!=this.editor.colorPaletteManager.noColor){args["bgColorRGB"]=d}args["character"]=M;args["x"]=c+k*r*this.scale*this.canvasScale;args["y"]=f+I*a*this.scale*this.canvasScale;args["scale"]=this.scale*this.canvasScale;if(t==TextModeEditor.Mode.VECTOR){args["context"]=this.context;args["x"]=c/(this.canvasScale*this.scale)+k*r;args["y"]=f/(this.canvasScale*this.scale)+I*a}else{args["x"]=c+k*r*this.scale*this.canvasScale;args["y"]=f+I*a*this.scale*this.canvasScale}i.drawCharacter(args)}}c+=b[0].length*r*this.scale*this.canvasScale+this.blockSpacing;f+=0;u++}}if(t!=TextModeEditor.Mode.VECTOR){this.context.putImageData(this.imageData,0,0)}if(this.highlightBlock!==false){this.context.fillStyle=styles.tilePalette.highlightOutline;this.context.strokeStyle=styles.tilePalette.highlightOutline;this.context.beginPath();this.context.lineWidth=3;this.context.rect(this.blockPositions[this.highlightBlock].left*this.canvasScale,this.blockPositions[this.highlightBlock].top*this.canvasScale,(this.blockPositions[this.highlightBlock].right-this.blockPositions[this.highlightBlock].left)*this.canvasScale,(this.blockPositions[this.highlightBlock].bottom-this.blockPositions[this.highlightBlock].top)*this.canvasScale);this.context.stroke()}if(this.selectedBlock!==false){this.context.fillStyle=styles.tilePalette.selectOutline;this.context.strokeStyle=styles.tilePalette.selectOutline;this.context.beginPath();this.context.lineWidth=3;this.context.rect(this.blockPositions[this.selectedBlock].left*this.canvasScale,this.blockPositions[this.selectedBlock].top*this.canvasScale,(this.blockPositions[this.selectedBlock].right-this.blockPositions[this.selectedBlock].left)*this.canvasScale,(this.blockPositions[this.selectedBlock].bottom-this.blockPositions[this.selectedBlock].top)*this.canvasScale);this.context.stroke()}this.updateBlockCountHTML()}};var DrawToolsPopup=function(){this.editor=null;this.character=0;this.color=0;this.drawPopupCanvas=null;this.drawPopupContext=null;this.drawPopupGrid=null;this.highlightX=0;this.highlightY=0;this.charScale=2;this.relatedCharacters=null;this.uiComponent=null;this.shiftDown=false;this.callback=null;this.elements=[]};DrawToolsPopup.prototype={getHTML:function(){var e=this.editor.tools.drawTools.getTools();var t='<div style="background-color: #111111">';if(g_app.isMobile()){for(var i in e){if(e.hasOwnProperty(i)){var r=e[i];var a=r.label;if(r.isMobileTool){if((i.indexOf("pixel")!=0||i=="pixel")&&i!="rotate"){t+='<div class="mobile-popup-tool" data-tool="'+i+'">';t+='<img  src="'+r.mobileIcon+'"/>';t+='<span class="mobile-popup-tool-label">'+r.label+"</span>";t+="</div>"}}}}}else{for(var i in e){if(e.hasOwnProperty(i)){var r=e[i];var a=r.label;if((i.indexOf("pixel")!=0||i=="pixel")&&i!="rotate"){t+='<div class="popup-tool" id="popup-tool-'+i+'" data-tool="'+i+'">';t+='<img width="20" src="'+r.icon+'"/>';t+='<span class="popup-tool-label">'+r.label+"</span>";if(r.key!==false){t+='<span class="popup-tool-shortcut">('+r.key+")</span>"}t+="</div>"}}}}t+="</div>";return t},setScreenMode:function(){var e=this.editor.getScreenMode();if(e=="vector"){$("#popup-tool-charpixel").hide();$("#popup-tool-linesegment").hide();$("#popup-tool-pixel").hide()}else{$("#popup-tool-charpixel").show();$("#popup-tool-linesegment").show();$("#popup-tool-pixel").show()}},init:function(e,t){this.editor=e;this.relatedCharacters=[];this.drawPopupGrid=[];for(var i=0;i<30;i++){this.drawPopupGrid[i]=[];for(var r=0;r<30;r++){this.drawPopupGrid[i][r]=null}}var a=this;this.uiComponent=UI.create("UI.Popup",{id:"drawToolsPopup",width:180,height:200});var s=this.getHTML();this.htmlComponent=UI.create("UI.HTMLPanel",{html:s});this.uiComponent.add(this.htmlComponent);this.uiComponent.on("keydown",function(e){a.keyDown(e)});this.uiComponent.on("keyup",function(e){a.keyUp(e)});this.initEvents();if(typeof t!="undefined"){t()}},doCallback:function(){if(typeof this.callback!="undefined"&&this.callback){this.callback()}},initEvents:function(){var i=this;$(".popup-tool").on("click",function(e){var t=$(this).attr("data-tool");i.editor.tools.drawTools.setDrawTool(t);UI.hidePopup()});$(".mobile-popup-tool").on("click",function(e){var t=$(this).attr("data-tool");i.editor.tools.drawTools.setDrawTool(t);UI.hidePopup()})},xyToElement:function(e,t){this.highlightRecentCharacter=false;this.highlightRightClickCharacter=false;this.highlightRightClickColor=false;this.highlightRecentColor=false;for(var i=0;i<this.elements.length;i++){if(e>=this.elements[i].x&&e<this.elements[i].x+this.elements[i].width&&t>=this.elements[i].y&&t<this.elements[i].y+this.elements[i].height){switch(this.elements[i].type){case"rightclicktile":this.highlightRightClickCharacter=true;break;case"rightclickcolor":this.highlightRightClickColor=true;break;case"recenttile":this.highlightRecentCharacter=this.elements[i].index;break;case"recentcolor":this.highlightRecentColor=this.elements[i].index;break}return true}}return false;var r=(this.charWidth*this.charScale+this.charMargin)*2;var a=this.editor.currentTile.recentCharacters;var s=this.highlightRightClickCharacter;var o=this.highlightCharacter;var l=this.highlightRecentCharacter;var n=this.highlightRightClickColor;var h=this.highlightColor;this.highlightRightClickCharacter=-1;this.highlightRecentCharacter=-1;this.highlightColor=-1;this.highlightCharacter=-1;this.highlightRightClickColor=-1;if(t>=this.recentCharactersY&&t<this.recentCharactersY+this.charHeight*this.charScale){if(e>=this.recentCharactersX&&e<this.recentCharactersX+this.charWidth*this.charScale){this.highlightRightClickCharacter=this.character;return this.highlightRightClickCharacter!=s}if(e>=this.recentCharactersX+r){e=e-(this.recentCharactersX+r);var d=Math.floor(e/(this.charWidth*this.charScale+this.charMargin));if(d<a.length){this.highlightRecentCharacter=d;return this.highlightRecentCharacter!=l}}}if(t>=this.rightClickColorY&&t<this.rightClickColorY+this.colorHeight+this.colorMargin){if(e>=this.rightClickColorX&&e<this.rightClickColorX+this.colorWidth+this.colorMargin){this.highlightRightClickColor=this.color;return this.highlightRightClickColor!=h}}var c=Math.ceil(this.colorCount/this.colorsAcross)*(this.colorHeight+this.colorMargin);var f=this.colorsAcross*(this.colorWidth+this.colorMargin);if(t>=this.colorPaletteY&&t<this.colorPaletteY+c){if(e>=this.colorPaletteX&&e<this.colorPaletteX+f){var u=Math.floor((e-this.colorPaletteX)/(this.colorWidth+this.colorMargin));var p=Math.floor((t-this.colorPaletteY)/(this.colorHeight+this.colorMargin));var d=u+p*this.colorsAcross;if(d<this.colorCount){this.highlightColor=d;return this.highlightColor!=h}}}var v=this.charactersDown*(this.charHeight*this.charScale+this.charMargin);var g=this.charactersAcross*(this.charWidth*this.charScale+this.charMargin);if(t>=this.charPaletteY&&t<this.charPaletteY+v){if(e>=this.charPaletteX&&e<=this.charPaletteX+g){var u=Math.floor((e-this.charPaletteX)/(this.charWidth*this.charScale+this.charMargin));var p=Math.floor((t-this.charPaletteY)/(this.charHeight*this.charScale+this.charMargin));var d=u+p*this.charactersAcross;this.highlightCharacter=d;return this.highlightCharacter!=o}}return this.highlightRecentCharacter!=l||this.highlightRightClickColor!=h||this.highlightRightClickCharacter!=s||this.highlightCharacter!=o||this.highlightColor!=h},drawCanvas:function(){if(this.drawPopupCanvas==null){this.drawPopupCanvas=document.getElementById("drawPopupCanvas")}if(!this.drawPopupCanvas){return}var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i=e.getTileWidth();var r=e.getTileHeight();var a=this.editor.currentTile.recentCharacters;var s=this.editor.currentTile.recentColors;var o=r*this.charScale+this.charMargin+this.colorHeight+20+24;var l=170;if(this.drawPopupContext==null||this.drawPopupCanvas.height!=o||this.drawPopupCanvas.width!=l){this.drawPopupCanvas.height=o;this.drawPopupContext=this.drawPopupCanvas.getContext("2d")}this.drawPopupContext.clearRect(0,0,this.drawPopupCanvas.width,this.drawPopupCanvas.height);var n=this.drawPopupContext.getImageData(0,0,this.drawPopupCanvas.width,this.drawPopupCanvas.height);var h=30;var d=30;x=1;y=0;var c=this.editor.currentTile.bgColor;if(c===false){c=this.editor.frames.getBackgroundColor()}var f={};f["imageData"]=n;f["color"]=this.editor.currentTile.color;f["bgColor"]=c;f["scale"]=this.charScale;var u=x+(i*this.charScale+this.charMargin)*2;var p=y;y+=12;this.recentCharactersY=y;this.recentCharactersX=x;var v=this.character;f["character"]=v;f["x"]=x;f["y"]=y;f["highlight"]=this.highlightRightClickCharacter!==false;e.drawCharacter(f);this.elements.push({x:x,y:y,width:i*this.charScale,height:r*this.charScale,type:"rightclicktile"});x+=(i*this.charScale+this.charMargin)*2;var g=a.length;if(g>7){g=7}for(var m=g-1;m>=0;m--){var v=a[m];f["character"]=v;f["x"]=x;f["y"]=y;f["highlight"]=this.highlightRecentCharacter===g-1-m;e.drawCharacter(f);this.elements.push({x:x,y:y,width:i*this.charScale,height:r*this.charScale,type:"recenttile",index:g-1-m});x+=i*this.charScale+this.charMargin}y+=r*this.charScale+this.charMargin;y+=10;x=1;var b={};b["imageData"]=n;b["character"]=-1;b["charWidth"]=this.colorWidth;b["charHeight"]=this.colorHeight;b["scale"]=1;var C=x+(i*this.charScale+this.charMargin)*2;var S=y;y+=12;this.rightClickColorX=x;this.rightClickColorY=y;b["color"]=this.color;b["x"]=x;b["y"]=y;b["highlight"]=this.highlightRightClickColor!==false;e.drawCharacter(b);this.elements.push({x:x,y:y,width:this.colorWidth,height:this.colorHeight,type:"rightclickcolor"});x+=(i*this.charScale+this.charMargin)*2;var P=s.length;if(P>7){P=7}for(var m=P-1;m>=0;m--){var w=s[m];b["color"]=w;b["x"]=x;b["y"]=y;b["highlight"]=this.highlightRecentColor===P-1-m;e.drawCharacter(b);this.elements.push({x:x,y:y,width:this.colorWidth,height:this.colorHeight,type:"recentcolor",index:P-1-m});x+=this.colorWidth+this.charMargin}this.drawPopupContext.putImageData(n,0,0);this.drawPopupContext.font="8px Verdana";this.drawPopupContext.fillStyle="#eeeeee";this.drawPopupContext.fillText("Recent Tiles",u,p+6);this.drawPopupContext.font="8px Verdana";this.drawPopupContext.fillStyle="#eeeeee";this.drawPopupContext.fillText("Recent Colours",C,S+6)},keyDown:function(e){this.shiftDown=e.shiftKey},keyUp:function(e){this.shiftDown=e.shiftKey},show:function(e,t,i,r,a){this.callback=a;var s=180;o=210;this.uiComponent.setDimensions(s,o);UI.showPopup("drawToolsPopup",e,t);this.setScreenMode();return;console.error("show popup");this.editor.grid.setCursorEnabled(false);this.character=i;this.color=r;var o=0;var l=this.editor.tileSetManager.getCurrentTileSet();var n=this.editor.colorPaletteManager.getCurrentColorPalette();this.charWidth=l.getTileWidth();this.charHeight=l.getTileHeight();this.charactersAcross=16;this.charactersDown=8;this.charScale=2;if(this.charHeight>=16){this.charScale=1}this.charMargin=2;this.colorCount=n.getColorCount();this.colorWidth=16;this.colorHeight=16;this.colorMargin=2;this.colorsAcross=n.getColorsAcross();this.colorsDown=n.getColorsDown();o+=72;o+=this.charHeight*this.charScale+this.charMargin;o+=10;o+=this.colorHeight+this.colorMargin;o+=10;o+=this.colorsDown*(this.colorHeight+this.colorMargin);o+=this.charactersDown*(this.charHeight*this.charScale+this.charMargin);o+=20;var s=180;o=210;this.uiComponent.setDimensions(s,o);UI.showPopup("drawToolsPopup",e,t);this.highlightRecentCharacter=false;this.highlightRightClickCharacter=false;this.highlightRightClickColor=false;this.highlightRecentColor=false;this.drawCanvas()},hide:function(){this.editor.grid.setCursorEnabled(true)},makeSelection:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i=this.editor.currentTile;if(typeof this.highlightRightClickCharacter=="undefined"){return}if(this.highlightRightClickCharacter!==false){var r=this.character;i.setCharacters([[r]]);this.doCallback();UI.hidePopup();return}if(this.highlightRightClickColor!==false){i.setColor(this.color);this.doCallback();UI.hidePopup();return}if(this.highlightRecentCharacter!==false){var a=i.recentCharacters;var s=this.highlightRecentCharacter;if(s<a.length){s=a.length-1-s;var r=a[s];this.editor.currentTile.setCharacters([[r]]);this.doCallback();UI.hidePopup();return}}if(this.highlightRecentColor!==false){var o=this.editor.currentTile.recentColors;var s=this.highlightRecentColor;s=o.length-1-s;if(s>=0&&s<o.length){var l=o[s];this.editor.currentTile.setColor(l);this.doCallback();UI.hidePopup();return}}if(this.highlightColor!=-1){if(this.highlightColor<t.getColorCount()){this.editor.currentTile.setColor(this.highlightColor);this.doCallback();UI.hidePopup();return}}if(this.highlightCharacter!=-1){if(this.highlightCharacter<128){r=this.highlightCharacter;charIndexX=r%this.charactersAcross;charIndexY=Math.floor(r/this.charactersAcross);this.editor.currentTile.setCharacters([[r]]);this.doCallback();UI.hidePopup();return}}},mouseDown:function(e){this.makeSelection()},mouseMove:function(e){var t=e.pageX-$("#drawPopupCanvas").offset().left;var i=e.pageY-$("#drawPopupCanvas").offset().top},mouseUp:function(e){}};var Shapes=function(){this.editor=null;this.grid=null;this.width=0;this.height=0;this.depth=0;this.fill=false;this.shape=false;this.fromX=false;this.fromY=false;this.fromZ=false;this.holder=null;this.meshes=[];this.expandFromMiddle=false};Shapes.prototype={init:function(e){this.editor=e;this.width=40;this.height=25;this.depth=1;var t=this;UI.on("ready",function(){return;t.holder=new THREE.Object3D;scene.add(t.holder)})},setFill:function(e){this.fill=e},getGrid:function(){if(this.grid==null){this.resizeGrid()}return this.grid},resizeGrid:function(){this.grid=[];for(var e=0;e<this.height;e++){var t=[];for(var i=0;i<this.width;i++){t.push({t:false,fc:false,bc:this.editor.colorPaletteManager.noColor})}this.grid.push(t)}},clearGrid:function(){if(this.grid==null){this.resizeGrid()}for(var e=0;e<this.height;e++){for(var t=0;t<this.width;t++){this.grid[e][t].t=false;this.grid[e][t].fc=false;this.grid[e][t].bc=this.editor.colorPaletteManager.noColor;this.grid[e][t].rx=0;this.grid[e][t].ry=0;this.grid[e][t].rz=0;this.grid[e][t].fh=0;this.grid[e][t].fv=0}}},startShape:function(e,t,i,r,a,s){var o=this.editor.layers.getSelectedLayerObject();if(!o||o.getType()!="grid"){return}var l=o.getGridWidth();var n=o.getGridHeight();this.expandFromMiddle=false;if(typeof s!="undefined"){this.expandFromMiddle=s}this.plane="xy";if(typeof a!="undefined"){this.plane=a}if(this.plane=="xy"){if(l!=this.width||n!=this.height){this.width=l;this.height=n;this.resizeGrid()}}else if(this.plane=="xz"){console.error("start shape in 3d bit");if(l!=this.width||this.editor.grid.depth!=this.height){this.width=this.editor.grid.width;this.height=this.editor.grid.depth;this.resizeGrid()}}this.editor.grid.setCursorEnabled(false);this.clearGrid();this.shape=e;this.fromX=t;this.fromY=i;this.fromZ=r;this.toX=-1;this.toY=-1;this.toZ=-1;this.setShapeTo(this.fromX,this.fromY,this.fromZ);this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})},endShape:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return}this.editor.history.startEntry("draw shape");var t={};for(var i=0;i<this.height;i++){for(var r=0;r<this.width;r++){if(this.grid[i][r].t!==this.editor.tileSetManager.blankCharacter&&this.grid[i][r].t!==false){t.x=r;t.t=this.grid[i][r].t;t.fc=this.grid[i][r].fc;t.bc=this.grid[i][r].bc;t.rx=this.grid[i][r].rx;t.ry=this.grid[i][r].ry;t.rz=this.grid[i][r].rz;t.fh=this.grid[i][r].fh;t.fv=this.grid[i][r].fv;t.update=false;t.y=i;t.z=0;e.setCell(t);this.editor.grid.grid2d.setMirrorCells(e,t);if(false){if(this.plane=="xz"){t.y=gridY;t.z=i;this.editor.grid.setCell(t)}else{t.y=i;t.z=z;this.editor.grid.setCell(t)}}}}}this.editor.history.endEntry();this.clearGrid();if(e.getBlockModeEnabled()){this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})}else{this.editor.graphic.redraw({allCells:true})}this.clearMeshes();this.editor.grid.setCursorEnabled(true);this.shape=false},cancelShape:function(){this.clearGrid();if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}this.clearMeshes();this.editor.grid.setCursorEnabled(true);this.shape=false},getCurrentShape:function(){return this.shape},addCharacter:function(e,t,i,r,a,s,o,l,n,h,d){var c=this.editor.layers.getSelectedLayerObject();if(!c||c.getType()!="grid"){return}var f=c.getGridWidth();var u=c.getGridHeight();var p=c.getCellWidth();var v=c.getCellHeight();var g=this.editor.colorPaletteManager.getCurrentColorPalette();var m=this.editor.tileSetManager.getCurrentTileSet();if(typeof o=="undefined"){o=this.editor.currentTile.rotX}if(typeof l=="undefined"){l=this.editor.currentTile.rotY}if(typeof n=="undefined"){n=this.editor.currentTile.rotZ}if(typeof h=="undefined"){h=this.editor.currentTile.flipH}if(typeof d=="undefined"){d=this.editor.currentTile.flipV}var y=this.editor.grid;var b=t*p+p/2;var C=i*v+v/2;var x=r*y.cellSizeZ+y.cellSizeZ/2;if(t>=f||t<0||i>=u||i<0){return false}if(false&&g_app.getEnabled("textmode3d")){if(e!=96&&(e!=this.editor.tileSetManager.blankCharacter||s!==-1)){var S=null;var P=null;if(s===-1){var S=m.getGeometry(e);if(typeof S=="undefined"){}var P=new THREE.Mesh(S,g.getMaterial(a))}else{var S=m.getBackgroundGeometry(e);var P=new THREE.Mesh(S,g.getMaterial(s));var S=m.getGeometry(e);var w=new THREE.Mesh(S,g.getMaterial(a));P.add(w)}P.rotation.order="YXZ";P.rotation.x=o*Math.PI*2;P.rotation.y=l*Math.PI*2;P.rotation.z=n*Math.PI*2;P.position.x=b;P.position.y=C;P.position.z=x;P.castShadow=true;P.receiveShadow=true;this.holder.add(P);this.meshes.push(P)}}return true},clearMeshes:function(){for(var e=0;e<this.meshes.length;e++){this.holder.remove(this.meshes[e])}this.meshes=[]},setShapeTo:function(e,t,i){if(this.toX!=e||this.toY!=t||this.toZ!=i){this.toX=e;this.toY=t;this.toZ=i;this.clearMeshes();var r=this.fromX;var a=this.toX;var s=this.fromY;var o=this.toY;var l=this.fromZ;var n=this.toZ;if(this.expandFromMiddle){r=Math.floor(r-(a-r));s=Math.floor(s-(o-s))}switch(this.shape){case"rect":this.rect(r,s,l,a,o,l);break;case"oval":this.oval(r,s,l,a,o,n);break;case"line":this.line(r,s,l,a,o,n);break}}},rect:function(e,t,i,r,a,s){var o=this.editor.layers.getSelectedLayerObject();if(!o||o.getType()!="grid"){return}var l=o.getGridWidth();var n=o.getGridHeight();this.clearGrid();var h=this.editor.grid.xyPosition;var d=this.editor.grid.xzPosition;if(e==r&&t==a&&i==s){if(this.plane=="xy"){this.singleCell(e,t,h)}if(this.plane=="xz"){this.singleCell(e,d,i)}return}if(this.plane=="xz"){var c=t;t=i;a=s;i=c;s=c}if(this.plane=="xz"){n=this.editor.grid.depth}var f=this.editor.currentTile.getCharacters();var u=this.editor.currentTile.character;if(f.length>0&&f[0].length>0){u=f[0][0]}var p=this.editor.currentTile.color;var v=this.editor.currentTile.bgColor;this.rectCharacters={amstrad:[[141,140,142,133,-1,138,135,131,139],[137,140,134,133,-1,138,134,131,137],[147,154,153,149,-1,149,150,154,156],[213,143,212,143,-1,143,214,143,215],[221,207,220,207,-1,207,222,207,223],[217,218,219,217,-1,219,217,216,219]],atascii:[[26,18,3,124,-1,124,17,18,5],[138,160,136,160,-1,160,8,160,10],[11,149,12,153,-1,25,9,21,15],[7,14,6,22,-1,2,6,13,7],[154,146,131,252,-1,252,145,146,133],[139,21,140,25,-1,153,137,149,143]],ibm:[[192,196,217,179,-1,179,218,196,191],[200,205,188,186,-1,186,201,205,187],[211,196,189,186,-1,186,214,196,183],[212,205,190,179,-1,179,213,205,184],[222,220,221,222,-1,221,222,223,221]],sharpmz700_1:[[50,60,51,113,-1,61,114,112,115],[59,58,123,59,-1,123,59,122,123],[66,67,86,67,-1,67,78,67,77],[91,58,108,123,-1,59,108,122,91],[119,60,118,113,-1,61,118,112,119],[209,212,210,209,-1,210,209,211,210],[214,208,213,208,-1,208,216,208,215],[253,252,254,245,-1,250,247,243,251]],petscii:[[124,226,126,225,-1,97,108,98,123],[109,64,125,93,-1,93,112,64,110],[76,111,122,116,-1,103,79,119,80],[74,64,75,93,-1,93,85,64,73],[77,111,78,116,-1,103,78,119,77],[95,160,105,160,-1,160,233,160,223],[252,98,254,97,-1,225,236,226,251],[237,192,253,221,-1,221,240,192,238],[204,239,250,244,-1,231,207,247,208],[202,192,203,221,-1,221,213,192,201],[205,239,206,244,-1,231,206,247,205],[127,98,255,97,-1,225,255,226,127]],petscii_shifted:[[124,226,126,225,-1,97,108,98,123],[109,64,125,93,-1,93,112,64,110],[127,98,255,97,-1,225,255,226,127],[225,98,97,225,-1,97,225,226,97],[252,98,254,97,-1,225,236,226,251],[237,192,253,221,-1,221,240,192,238]]};var g=this.editor.tileSetManager.getCurrentTileSet();var m=g.preset;var y=true;if(typeof m=="undefined"){y=false}if(!this.editor.tools.drawTools.drawCharacter){y=false}if(!$("#drawChangesSmartRect").is(":checked")){y=false}if(g_app.isMobile()){this.setFill($("#drawShapeFillMobile").is(":checked"))}else{this.setFill($("#shapeFill").is(":checked"))}var b=null;if(y){if(m.indexOf("ibm")!=-1){b=this.rectCharacters["ibm"]}else if(m.indexOf("amstrad")!=-1){b=this.rectCharacters["amstrad"]}else if(m.indexOf("atascii")!=-1){b=this.rectCharacters["atascii"]}else if(m=="petscii"){b=this.rectCharacters["petscii"]}else if(m=="petscii_shifted"){b=this.rectCharacters["petscii_shifted"]}else if(m=="sharpmz700_1"||m=="sharpmz700_1_japanese"||m=="sharpmz80a"){b=this.rectCharacters["sharpmz700_1"]}y=false;if(b!=null){for(var C=0;C<b.length;C++){for(var x=0;x<b[C].length;x++){if(b[C][x]==u){y=C;break}}}}}var S=this.editor.currentTile.rotX;var P=this.editor.currentTile.rotY;var w=this.editor.currentTile.rotZ;var I=this.editor.currentTile.flipH;var k=this.editor.currentTile.flipV;if(e>r){var c=r;r=e;e=c}for(var M=e;M<=r;M++){if(M>=0&&M<l){var T=t;var D=u;if(T>=0&&T<n){var E=o.getCell({x:M,y:T});if(!this.editor.tools.drawTools.drawCharacter){u=E.t;y=false}if(!this.editor.tools.drawTools.drawColor){p=E.fc}if(!this.editor.tools.drawTools.drawBgColor){v=E.bc}if(y!==false){if(a<t){if(M==e){u=b[y][0]}else if(M==r){u=b[y][2]}else{u=b[y][1]}}else{if(M==e){u=b[y][6]}else if(M==r){u=b[y][8]}else{u=b[y][7]}}}else{}this.grid[T][M].bc=v;this.grid[T][M].fc=p;this.grid[T][M].t=u;this.grid[T][M].rx=S;this.grid[T][M].ry=P;this.grid[T][M].rz=w;this.grid[T][M].fh=I;this.grid[T][M].fv=k;if(this.plane=="xz"){this.addCharacter(u,M,d,T,p,v,S,P,w)}else{this.addCharacter(u,M,T,h,p,v,S,P,w)}}var T=a;if(T>=0&&T<n){var E=o.getCell({x:M,y:T});if(!this.editor.tools.drawTools.drawCharacter){u=E.t;y=false}if(!this.editor.tools.drawTools.drawColor){p=E.fc}if(!this.editor.tools.drawTools.drawBgColor){v=E.bc}if(y!==false){if(a>t){if(M==e){u=b[y][0]}else if(M==r){u=b[y][2]}else{u=b[y][1]}}else{if(M==e){u=b[y][6]}else if(M==r){u=b[y][8]}else{u=b[y][7]}}}else{}if(this.plane=="xz"){this.addCharacter(u,M,d,T,p,v,S,P,w)}else{this.addCharacter(u,M,T,h,p,v,S,P,w)}this.grid[T][M].bc=v;this.grid[T][M].fc=p;this.grid[T][M].t=u;this.grid[T][M].rx=S;this.grid[T][M].ry=P;this.grid[T][M].rz=w;this.grid[T][M].fh=I;this.grid[T][M].fv=k}}}if(t>a){var c=a;a=t;t=c}else{}for(var T=t;T<=a;T++){if(T>=0&&T<n){var M=e;if(M>=0&&M<l){var E=o.getCell({x:M,y:T});if(!this.editor.tools.drawTools.drawCharacter){u=E.t;y=false}if(!this.editor.tools.drawTools.drawColor){p=E.fc}if(!this.editor.tools.drawTools.drawBgColor){v=E.bc}if(y!==false){if(r>e){if(T==t){u=b[y][6]}else if(T==a){u=b[y][0]}else{u=b[y][3]}}else{if(T==t){u=b[y][8]}else if(T==a){u=b[y][2]}else{u=b[y][5]}}}else{}if(this.plane=="xz"){this.addCharacter(u,M,d,T,p,v,S,P,w)}else{this.addCharacter(u,M,T,h,p,v,S,P,w)}this.grid[T][M].bc=v;this.grid[T][M].fc=p;this.grid[T][M].t=u;this.grid[T][M].rx=S;this.grid[T][M].ry=P;this.grid[T][M].rz=w;this.grid[T][M].fh=I;this.grid[T][M].fv=k}var M=r;if(M>=0&&M<l){var E=o.getCell({x:M,y:T});if(!this.editor.tools.drawTools.drawCharacter){u=E.t;y=false}if(!this.editor.tools.drawTools.drawColor){p=E.fc}if(!this.editor.tools.drawTools.drawBgColor){v=E.bc}if(y!==false){if(r<e){if(T==t){u=b[y][6]}else if(T==a){u=b[y][0]}else{u=b[y][3]}}else{if(T==t){u=b[y][8]}else if(T==a){u=b[y][2]}else{u=b[y][5]}}}else{}if(this.plane=="xz"){this.addCharacter(u,M,d,T,p,v,S,P,w)}else{this.addCharacter(u,M,T,h,p,v,S,P,w)}this.grid[T][M].bc=v;this.grid[T][M].fc=p;this.grid[T][M].t=u;this.grid[T][M].rx=S;this.grid[T][M].ry=P;this.grid[T][M].rz=w;this.grid[T][M].fh=I;this.grid[T][M].fv=k}}}if(this.fill){var f=this.editor.currentTile.getCharacters();var u=this.editor.currentTile.character;if(f.length>0&&f[0].length>0){u=f[0][0]}var p=this.editor.currentTile.color;var v=this.editor.currentTile.bgColor;for(var M=e+1;M<r;M++){for(var T=t+1;T<a;T++){if(M>=0&&M<l&&T>=0&&T<n){var E=o.getCell({x:M,y:T});if(!this.editor.tools.drawTools.drawCharacter){u=E.t;y=false}if(!this.editor.tools.drawTools.drawColor){p=E.fc}if(!this.editor.tools.drawTools.drawBgColor){v=E.bc}this.addCharacter(u,M,T,h,p,v,S,P,w);this.grid[T][M].bc=v;this.grid[T][M].fc=p;this.grid[T][M].t=u;this.grid[T][M].rz=w;this.grid[T][M].fh=I;this.grid[T][M].fv=k}}}}this.editor.graphic.redraw()},line:function(e,t,i,r,a,s){var o=this.editor.layers.getSelectedLayerObject();if(!o||o.getType()!="grid"){return}var l=o.getGridWidth();var n=o.getGridHeight();this.clearGrid();var h=this.editor.grid.xyPosition;var d=this.editor.grid.xzPosition;if(e==r&&t==a&&i==s){if(this.plane=="xy"){this.singleCell(e,t,h)}if(this.plane=="xz"){this.singleCell(e,d,i)}return}if(this.plane=="xz"){var c=t;t=i;a=s;i=c;s=c}if(this.plane=="xz"){n=this.editor.grid.depth}if(this.plane=="xz"){n=this.editor.grid.depth}var f=this.editor.currentTile.getCharacters();var u=this.editor.currentTile.character;if(f.length>0&&f[0].length>0){u=f[0][0]}var p=this.editor.currentTile.color;var v=this.editor.currentTile.bgColor;var g=this.editor.currentTile.rotX;var m=this.editor.currentTile.rotY;var y=this.editor.currentTile.rotZ;var b=this.editor.currentTile.flipH;var C=this.editor.currentTile.flipV;var x=r-e;if(x<0){x=-x}var S=a-t;if(S<0){S=-S}if(x>S){if(e>r){var c=r;r=e;e=c;c=a;a=t;t=c}for(var P=e;P<=r;P++){if(P>=0&&P<l){var w=Math.round(t+(a-t)*(P-e)/(r-e));if(w>=0&&w<n){var I=o.getCell({x:P,y:w});if(!this.editor.tools.drawTools.drawCharacter){u=I.t}if(!this.editor.tools.drawTools.drawColor){p=I.fc}if(!this.editor.tools.drawTools.drawBgColor){v=I.bc}if(this.plane=="xz"){this.addCharacter(u,P,d,w,p,v)}else{this.addCharacter(u,P,w,h,p,v)}this.grid[w][P].t=u;this.grid[w][P].bc=v;this.grid[w][P].fc=p;this.grid[w][P].rx=g;this.grid[w][P].ry=m;this.grid[w][P].rz=y;this.grid[w][P].fh=b;this.grid[w][P].fv=C}}}}else{if(t>a){var c=a;a=t;t=c;c=r;r=e;e=c}for(var w=t;w<=a;w++){if(w>=0&&w<n){var P=Math.round(e+(r-e)*(w-t)/(a-t));if(P>=0&&P<l){var I=o.getCell({x:P,y:w});if(!this.editor.tools.drawTools.drawCharacter){u=I.t}if(!this.editor.tools.drawTools.drawColor){p=I.fc}if(!this.editor.tools.drawTools.drawBgColor){v=I.bc}if(this.plane=="xz"){this.addCharacter(u,P,d,w,p,v)}else{this.addCharacter(u,P,w,h,p,v)}this.grid[w][P].t=u;this.grid[w][P].bc=v;this.grid[w][P].fc=p;this.grid[w][P].rx=g;this.grid[w][P].ry=m;this.grid[w][P].rz=y;this.grid[w][P].fh=b;this.grid[w][P].fv=C}}}}this.editor.graphic.redraw()},singleCell:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!="grid"){return}var a=r.getGridWidth();var s=r.getGridHeight();if(e<0||e>=a||t<0||t>=s){return}var o=this.editor.currentTile.getCharacters();var l=this.editor.currentTile.character;if(o.length>0&&o[0].length>0){l=o[0][0]}var n=this.editor.currentTile.color;var h=this.editor.currentTile.bgColor;var d=this.editor.currentTile.rotX;var c=this.editor.currentTile.rotY;var f=this.editor.currentTile.rotZ;var u=this.editor.currentTile.flipH;var p=this.editor.currentTile.flipV;var v=r.getCell({x:e,y:t});if(!this.editor.tools.drawTools.drawCharacter){l=cell.t}if(!this.editor.tools.drawTools.drawColor){n=cell.fc}if(!this.editor.tools.drawTools.drawBgColor){h=cell.bc}this.addCharacter(l,e,t,i,n,h);this.grid[t][e].bc=h;this.grid[t][e].fc=n;this.grid[t][e].t=l;this.grid[t][e].rx=d;this.grid[t][e].ry=c;this.grid[t][e].rz=f;this.grid[t][e].fh=u;this.grid[t][e].fv=p;this.editor.graphic.redraw()},oval:function(e,t,i,r,a,s){var o=this.editor.layers.getSelectedLayerObject();if(!o||o.getType()!="grid"){return}var l=o.getGridWidth();var n=o.getGridHeight();this.clearGrid();var h=this.editor.grid.xyPosition;var d=this.editor.grid.xzPosition;if(e==r&&t==a&&i==s){if(this.plane=="xy"){this.singleCell(e,t,h)}if(this.plane=="xz"){this.singleCell(e,d,i)}return}if(g_app.isMobile()){this.setFill($("#drawShapeFillMobile").is(":checked"))}else{this.setFill($("#shapeFill").is(":checked"))}if(this.plane=="xz"){n=this.editor.grid.depth}var c=this.editor.currentTile.getCharacters();var f=this.editor.currentTile.character;if(c.length>0&&c[0].length>0){f=c[0][0]}var u=this.editor.currentTile.color;var p=this.editor.currentTile.bgColor;var v=this.editor.currentTile.rotX;var g=this.editor.currentTile.rotY;var m=this.editor.currentTile.rotZ;var y=this.editor.currentTile.flipH;var b=this.editor.currentTile.flipV;if(e==r&&t==a){this.singleCell(e,t,h);return}if(e>r){var C=r;r=e;e=C}if(t>a){var C=a;a=t;t=C}if(this.plane=="xz"){var C=t;t=i;a=s;i=C;s=C}var x=(a+t)/2;var S=(r+e)/2;var x=t+(a-t)/2;var S=e+(r-e)/2;var P=r-e;var w=a-t;var I=1;var k=1;if(P>w){k=w/P;radius=P/2}else{I=P/w;radius=w/2}var M=[];var T=300;var D=0;for(var E=0;E<T;E++){D=2*Math.PI*E/T;var _=Math.round(S+I*radius*Math.cos(D));var B=Math.round(x+k*radius*Math.sin(D));var R=false;for(var A=0;A<M.length;A++){if(M[A].y===B){R=true;if(M[A].x1!==_){M[A].x2=_}break}}if(!R){M.push({y:B,x1:_,x2:false})}var F=o.getCell({x:_,y:B});if(!this.editor.tools.drawTools.drawCharacter){f=F.t}if(!this.editor.tools.drawTools.drawColor){u=F.fc}if(!this.editor.tools.drawTools.drawBgColor){p=F.bc}if(_>=0&&_<l&&B>=0&&B<n){if(this.plane=="xz"){this.addCharacter(f,_,d,B,u,p)}else{this.addCharacter(f,_,B,h,u,p)}this.grid[B][_].bc=p;this.grid[B][_].fc=u;this.grid[B][_].t=f;this.grid[B][_].rx=v;this.grid[B][_].ry=g;this.grid[B][_].rz=m;this.grid[B][_].fh=y;this.grid[B][_].fv=b}}if(this.fill){for(var A=0;A<M.length;A++){var e=M[A].x1;var r=M[A].x2;if(r!==false){if(e>r){var C=r;r=e;e=C}B=M[A].y;for(var _=e+1;_<r;_++){var F=o.getCell({x:_,y:B});if(!this.editor.tools.drawTools.drawCharacter){f=F.t}if(!this.editor.tools.drawTools.drawColor){u=F.fc}if(!this.editor.tools.drawTools.drawBgColor){p=F.bc}if(_>=0&&_<l&&B>=0&&B<n){this.addCharacter(f,_,B,h,u,p);this.grid[B][_].bc=p;this.grid[B][_].fc=u;this.grid[B][_].t=f;this.grid[B][_].rx=v;this.grid[B][_].ry=g;this.grid[B][_].rz=m;this.grid[B][_].fh=y;this.grid[B][_].fv=b}}}}}this.editor.graphic.redraw()}};var Shapes3d=function(){this.editor=null;this.grid=null;this.width=0;this.height=0;this.depth=0;this.shape="";this.fromX=false;this.fromY=false;this.fromZ=false;this.holder=null;this.meshes=[]};Shapes3d.prototype={init:function(e,t){this.editor=e;this.width=40;this.height=25;this.depth=1;this.resizeGrid();this.holder=new THREE.Object3D;t.add(this.holder)},resizeGrid:function(){this.grid=[];for(var e=0;e<this.height;e++){var t=[];for(var i=0;i<this.width;i++){t.push({character:false,color:false,bgColor:false})}this.grid.push(t)}},clearGrid:function(){for(var e=0;e<this.height;e++){for(var t=0;t<this.width;t++){this.grid[e][t].character=false;this.grid[e][t].color=false;this.grid[e][t].bgColor=false;this.grid[e][t].rotX=0;this.grid[e][t].rotY=0;this.grid[e][t].rotZ=0}}},startShape:function(e,t,i,r,a){var s=this.editor.grid3d;var o=s.getGridWidth();var l=s.getGridHeight();var n=s.getGridDepth();if(typeof a=="undefined"){a="xy"}console.log("start shape, plane = "+a+",:"+t+","+i+","+r);this.plane=a;if(a=="xy"){if(o!=this.width||l!=this.height){this.width=o;this.height=l;this.resizeGrid()}}else if(a=="xz"){if(o!=this.width||n!=this.height){this.width=o;this.height=n;this.resizeGrid()}}this.clearGrid();this.shape=e;this.fromX=t;this.fromY=i;this.fromZ=r;this.toX=-1;this.toY=-1;this.toZ=-1;this.setShapeTo(this.fromX,this.fromY,this.fromZ)},endShape:function(){var e=this.editor.grid3d;this.editor.history.startEntry("draw shape");for(var t=0;t<this.height;t++){for(var i=0;i<this.width;i++){if(this.grid[t][i].character!==false){var r=e.getXYPosition();var a=e.getXZPosition();if(this.plane=="xz"){e.setCell({t:this.grid[t][i].character,x:i,y:a,z:t,bc:this.grid[t][i].color,rx:this.grid[t][i].rotX,ry:this.grid[t][i].rotY,rz:this.grid[t][i].rotZ,bc:this.grid[t][i].bgColor})}else{e.setCell({t:this.grid[t][i].character,x:i,y:t,z:r,fc:this.grid[t][i].color,rx:this.grid[t][i].rotX,ry:this.grid[t][i].rotY,rz:this.grid[t][i].rotZ,bc:this.grid[t][i].bgColor})}}}}this.editor.history.endEntry();this.clearGrid();if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}this.clearMeshes();this.editor.grid.setCursorEnabled(true)},addCharacter:function(e,t,i,r,a,s,o,l,n){var h=this.editor.colorPaletteManager;var d=this.editor.tileSetManager;var c=this.editor.currentTile;var f=this.editor.grid3d;var u=f.getColorPalette();if(typeof o=="undefined"){o=c.getRx()}if(typeof l=="undefined"){l=c.getRy()}if(typeof n=="undefined"){n=c.getRz()}var p=f.getGridWidth();var v=f.getGridHeight();var g=f.getGridDepth();var m=f.getTileSet();var y=f.getCellSizeX();var b=f.getCellSizeY();var C=f.getCellSizeZ();var x=t*y+y/2;var S=i*b+b/2;var P=r*C+C/2;if(t>=p||t<0||i>=v||i<0||r>=g||r<0){return false}if(e!=96&&(e!=32||s!==h.noColor)){var w=null;var I=null;if(s===h.noColor){var w=m.getGeometry(e);if(typeof w=="undefined"){console.log("no geometry!!!!")}var I=new THREE.Mesh(w,u.getMaterial(a))}else{var w=m.getBackgroundGeometry(e);var I=new THREE.Mesh(w,u.getMaterial(s));var w=m.getGeometry(e);var k=new THREE.Mesh(w,u.getMaterial(a));I.add(k)}I.rotation.order="YXZ";I.rotation.x=o*Math.PI*2;I.rotation.y=l*Math.PI*2;I.rotation.z=n*Math.PI*2;I.position.x=x;I.position.y=S;I.position.z=P;I.castShadow=true;I.receiveShadow=true;this.holder.add(I);this.meshes.push(I)}return true},clearMeshes:function(){for(var e=0;e<this.meshes.length;e++){this.holder.remove(this.meshes[e])}this.meshes=[]},setShapeTo:function(e,t,i){if(this.toX!=e||this.toY!=t||this.toZ!=i){this.toX=e;this.toY=t;this.toZ=i;this.clearMeshes();switch(this.shape){case"rect":this.rect(this.fromX,this.fromY,this.fromZ,this.toX,this.toY,this.toZ);break;case"oval":this.oval(this.fromX,this.fromY,this.fromZ,this.toX,this.toY,this.toZ);break;case"line":this.line(this.fromX,this.fromY,this.fromZ,this.toX,this.toY,this.toZ);break}}},rect:function(e,t,i,r,a,s){this.clearGrid();var o=this.editor.grid3d;var l=o.getXYPosition();var n=o.getXZPosition();var h=this.editor.tools.drawTools;var d=o.getGridWidth();var c=o.getGridHeight();var f=this.editor.currentTile;if(e==r&&t==a&&i==s){if(this.plane=="xy"){this.singleCell(e,t,l)}if(this.plane=="xz"){this.singleCell(e,n,i)}return}if(this.plane=="xz"){var u=t;t=i;a=s;i=u;s=u}if(this.plane=="xz"){c=o.getGridDepth()}var p=f.getCharacters();var v=p[0][0];var g=f.getColor();var m=f.getBGColor();this.rectCharacters={amstrad:[[135,131,139,133,-1,138,141,140,142],[134,131,137,133,-1,138,137,140,134],[150,154,156,149,-1,149,147,154,153],[214,143,215,143,-1,143,213,143,212],[222,207,223,207,-1,207,221,207,220],[217,216,219,217,-1,219,217,218,219]],atascii:[[17,18,5,124,-1,124,26,18,3],[8,160,10,160,-1,160,138,160,136],[9,21,15,153,-1,25,11,149,12],[6,13,7,22,-1,2,7,14,6],[145,146,133,252,-1,252,154,146,131],[137,149,143,25,-1,153,139,21,140]],ibm:[[218,196,191,179,-1,179,192,196,217],[201,205,187,186,-1,186,200,205,188],[214,196,183,186,-1,186,211,196,189],[213,205,184,179,-1,179,212,205,190],[222,223,221,222,-1,221,222,220,221]],sharpmz700_1:[[114,112,115,113,-1,61,50,60,51],[59,122,123,59,-1,123,59,58,123],[78,67,77,67,-1,67,66,67,86],[108,122,91,123,-1,59,91,58,108],[118,112,119,113,-1,61,119,60,118],[209,211,210,209,-1,210,209,212,210],[216,208,215,208,-1,208,214,208,213],[247,243,251,245,-1,250,253,252,254]],petscii:[[108,98,123,225,-1,97,124,226,126],[112,64,110,93,-1,93,109,64,125],[79,119,80,116,-1,103,76,111,122],[85,64,73,93,-1,93,74,64,75],[78,119,77,116,-1,103,77,111,78],[233,160,223,160,-1,160,95,160,105],[236,226,251,97,-1,225,252,98,254],[240,192,238,221,-1,221,237,192,253],[207,247,208,244,-1,231,204,239,250],[213,192,201,221,-1,221,202,192,203],[206,247,205,244,-1,231,205,239,206],[255,226,127,97,-1,225,127,98,255]],petscii_shifted:[[108,98,123,225,-1,97,124,226,126],[112,64,110,93,-1,93,109,64,125],[255,226,127,97,-1,225,127,98,255],[225,226,97,225,-1,97,225,98,97],[236,226,251,97,-1,225,252,98,254],[240,192,238,221,-1,221,237,192,253]]};var y="";var b=false;console.log("preset name = "+y);if(typeof y=="undefined"){b=false}if(!this.editor.drawCharacter){b=false}if(!$("#drawChangesSmartRect").is(":checked")){b=false}var C=null;if(b){if(y.indexOf("ibm")!=-1){C=this.rectCharacters["ibm"]}else if(y.indexOf("amstrad")!=-1){C=this.rectCharacters["amstrad"]}else if(y.indexOf("atascii")!=-1){C=this.rectCharacters["atascii"]}else if(y=="petscii"){console.log("use petscrii rect characters");C=this.rectCharacters["petscii"]}else if(y=="petscii_shifted"){C=this.rectCharacters["petscii_shifted"]}else if(y=="sharpmz700_1"){C=this.rectCharacters["sharpmz700_1"]}b=false;if(C!=null){for(var x=0;x<C.length;x++){for(var S=0;S<C[x].length;S++){if(C[x][S]==v){b=x;break}}}}}var P=f.getRx();var w=f.getRy();var I=f.getRz();if(e>r){var u=r;r=e;e=u}for(var k=e;k<=r;k++){if(k>=0&&k<this.editor.grid.width){var M=t;if(M>=0&&M<c){var T=o.getCell(k,M,l);if(!h.drawCharacter){b=false;v=T.t}if(!h.drawColor){g=T.fc}if(!h.drawBgColor){m=T.bc}if(b!==false){if(a<t){if(k==e){v=C[b][0]}else if(k==r){v=C[b][2]}else{v=C[b][1]}}else{if(k==e){v=C[b][6]}else if(k==r){v=C[b][8]}else{v=C[b][7]}}}else{}this.grid[M][k].bgColor=m;this.grid[M][k].color=g;this.grid[M][k].character=v;this.grid[M][k].rotX=P;this.grid[M][k].rotY=w;this.grid[M][k].rotZ=I;if(this.plane=="xz"){this.addCharacter(v,k,n,M,g,m,P,w,I)}else{this.addCharacter(v,k,M,l,g,m,P,w,I)}}var M=a;if(M>=0&&M<c){var T=o.getCell(k,M,l);if(!h.drawCharacter){b=false;v=T.t}if(!h.drawColor){g=T.fc}if(!h.drawBgColor){m=T.bc}if(b!==false){if(a>t){if(k==e){v=C[b][0]}else if(k==r){v=C[b][2]}else{v=C[b][1]}}else{if(k==e){v=C[b][6]}else if(k==r){v=C[b][8]}else{v=C[b][7]}}}else{}if(this.plane=="xz"){this.addCharacter(v,k,n,M,g,m,P,w,I)}else{this.addCharacter(v,k,M,l,g,m,P,w,I)}this.grid[M][k].bgColor=m;this.grid[M][k].color=g;this.grid[M][k].character=v;this.grid[M][k].rotX=P;this.grid[M][k].rotY=w;this.grid[M][k].rotZ=I}}}if(t>a){var u=a;a=t;t=u}else{}for(var M=t;M<=a;M++){console.log("!!");if(M>=0&&M<c){var k=e;if(k>=0&&k<this.editor.grid.width){var T=o.getCell(k,M,l);if(!h.drawCharacter){b=false;v=T.t}if(!h.drawColor){g=T.fc}if(!h.drawBgColor){m=T.bc}if(b!==false){if(r>e){if(M==t){v=C[b][6]}else if(M==a){v=C[b][0]}else{v=C[b][3]}}else{if(M==t){v=C[b][8]}else if(M==a){v=C[b][2]}else{v=C[b][5]}}}else{}if(this.plane=="xz"){this.addCharacter(v,k,n,M,g,m,P,w,I)}else{this.addCharacter(v,k,M,l,g,m,P,w,I)}this.grid[M][k].bgColor=m;this.grid[M][k].color=g;this.grid[M][k].character=v;this.grid[M][k].rotX=P;this.grid[M][k].rotY=w;this.grid[M][k].rotZ=I}var k=r;if(k>=0&&k<this.editor.grid.width){var T=o.getCell(k,M,l);if(!h.drawCharacter){b=false;v=T.t}if(!h.drawColor){g=T.fc}if(!h.drawBgColor){m=T.bc}if(b!==false){if(r<e){if(M==t){v=C[b][6]}else if(M==a){v=C[b][0]}else{v=C[b][3]}}else{if(M==t){v=C[b][8]}else if(M==a){v=C[b][2]}else{v=C[b][5]}}}else{}if(this.plane=="xz"){this.addCharacter(v,k,n,M,g,m,P,w,I)}else{this.addCharacter(v,k,M,l,g,m,P,w,I)}this.grid[M][k].bgColor=m;this.grid[M][k].color=g;this.grid[M][k].character=v;this.grid[M][k].rotX=P;this.grid[M][k].rotY=w;this.grid[M][k].rotZ=I}}}},line:function(e,t,i,r,a,s){this.clearGrid();var o=this.editor.grid3d;var l=o.getXYPosition();var n=o.getXZPosition();var h=this.editor.tools.drawTools;var d=o.getGridWidth();var c=o.getGridHeight();if(this.plane=="xz"){c=o.getGridDepth()}var f=this.editor.currentTile;var u=f.getCharacters();var p=u[0][0];var v=f.getColor();var g=f.getBGColor();var m=f.getRx();var y=f.getRy();var b=f.getRz();if(e==r&&t==a&&i==s){if(this.plane=="xy"){this.singleCell(e,t,l)}if(this.plane=="xz"){this.singleCell(e,n,i)}return}if(this.plane=="xz"){var C=t;t=i;a=s;i=C;s=C}var x=r-e;if(x<0){x=-x}var S=a-t;if(S<0){S=-S}if(x>S){if(e>r){var C=r;r=e;e=C;C=a;a=t;t=C}for(var P=e;P<=r;P++){if(P>=0&&P<d){var w=Math.round(t+(a-t)*(P-e)/(r-e));if(w>=0&&w<c){if(!h.drawCharacter){p=cell.t}if(!h.drawColor){v=cell.fc}if(!h.drawBgColor){g=cell.bc}if(this.plane=="xz"){this.addCharacter(p,P,n,w,v,g,m,y,b)}else{this.addCharacter(p,P,w,l,v,g,m,y,b)}this.grid[w][P].character=p;this.grid[w][P].bgColor=g;this.grid[w][P].color=v;this.grid[w][P].rotX=m;this.grid[w][P].rotY=y;this.grid[w][P].rotZ=b}}}}else{if(t>a){var C=a;a=t;t=C;C=r;r=e;e=C}for(var w=t;w<=a;w++){if(w>=0&&w<c){var P=Math.round(e+(r-e)*(w-t)/(a-t));if(P>=0&&P<d){if(!h.drawCharacter){p=cell.t}if(!h.drawColor){v=cell.fc}if(!h.drawBgColor){g=cell.bc}if(this.plane=="xz"){this.addCharacter(p,P,n,w,v,g,m,y,b)}else{this.addCharacter(p,P,w,l,v,g,m,y,b)}this.grid[w][P].character=p;this.grid[w][P].bgColor=g;this.grid[w][P].color=v;this.grid[w][P].rotX=m;this.grid[w][P].rotY=y;this.grid[w][P].rotZ=b}}}}},singleCell:function(e,t,i){var r=this.editor.currentTile;var a=this.editor.tools.drawTools;var s=this.editor.grid3d;var o=r.getCharacters();var l=0;if(o.length>0&&o[0].length>0){l=o[0][0]}var n=r.getColor();var h=r.getBGColor();var d=r.getRx();var c=r.getRy();var f=r.getRz();var u=s.getCell(e,t,i);if(!a.drawCharacter){l=u.t}if(!a.drawColor){n=u.fc}if(!a.drawBGColor){h=u.bc}this.addCharacter(l,e,t,i,n,h,d,c,f);this.grid[t][e].bgColor=h;this.grid[t][e].color=n;this.grid[t][e].character=l;this.grid[t][e].rotX=d;this.grid[t][e].rotY=c;this.grid[t][e].rotZ=f},oval:function(e,t,i,r,a,s){this.clearGrid();var o=this.editor.tools.drawTools;var l=this.editor.grid3d;var n=this.editor.currentTile;var h=n.getRx();var d=n.getRy();var c=n.getRz();var f=l.getXYPosition();var u=l.getXZPosition();if(e==r&&t==a&&i==s){if(this.plane=="xy"){this.singleCell(e,t,f)}if(this.plane=="xz"){this.singleCell(e,u,i)}return}var p=l.getGridWidth();var v=l.getGridHeight();if(this.plane=="xz"){v=l.getGridDepth()}var g=n.getCharacters();var m=g[0][0];var y=n.getColor();var b=n.getBGColor();if(e==r&&t==a){this.singleCell(e,t,f);return}if(e>r){var C=r;r=e;e=C}if(t>a){var C=a;a=t;t=C}if(this.plane=="xz"){var C=t;t=i;a=s;i=C;s=C}var x=(a+t)/2;var S=(r+e)/2;var x=t+(a-t)/2;var S=e+(r-e)/2;var P=r-e;var w=a-t;var I=1;var k=1;if(P>w){k=w/P;radius=P/2}else{I=P/w;radius=w/2}var M=300;var T=0;for(var D=0;D<M;D++){T=2*Math.PI*D/M;var E=Math.round(S+I*radius*Math.cos(T));var $=Math.round(x+k*radius*Math.sin(T));var _=l.getCell(E,$,f);if(!o.drawCharacter){m=_.t}if(!o.drawColor){y=_.fc}if(!o.drawBgColor){b=_.bc}if(E>=0&&E<p&&$>=0&&$<v){if(this.plane=="xz"){this.addCharacter(m,E,u,$,y,b,h,d,c)}else{this.addCharacter(m,E,$,f,y,b,h,d,c)}this.grid[$][E].bgColor=b;this.grid[$][E].color=y;this.grid[$][E].character=m;this.grid[$][E].rotX=h;this.grid[$][E].rotY=d;this.grid[$][E].rotZ=c}}}};var Typing=function(){this.editor=null;this.keyboardImage=null;this.canvas=null;this.context=null;this.keyboardRows=[];this.keyCodeDown=-1;this.reverse=false;this.keyboard=[];this.shiftDown=false;this.ctrlDown=false;this.altDown=false;this.cursor={x:0,y:0,z:0}};Typing.prototype={setCursorPosition:function(e){this.cursor.x=e.x;this.cursor.y=e.y;if(typeof e.z!="undefined"){this.cursor.z=e.z}if(g_app.mode=="3d"){this.editor.grid3d.setTypingCursorPosition(this.cursor.x,this.cursor.y,this.cursor.z)}},initKeyboard:function(){this.asciiKeyboard=[[{width:1,keyCode:223,charCode:96,shiftedCode:126,altCode:-1},{width:1,keyCode:49,charCode:49,shiftedCode:33,altCode:-1,colorCode:0},{width:1,keyCode:50,charCode:50,shiftedCode:64,altCode:-1,colorCode:1},{width:1,keyCode:51,charCode:51,shiftedCode:35,altCode:-1,colorCode:2},{width:1,keyCode:52,charCode:52,shiftedCode:36,altCode:-1,colorCode:3},{width:1,keyCode:53,charCode:53,shiftedCode:37,altCode:-1,colorCode:4},{width:1,keyCode:54,charCode:54,shiftedCode:94,altCode:-1,colorCode:5},{width:1,keyCode:55,charCode:55,shiftedCode:38,altCode:-1,colorCode:6},{width:1,keyCode:56,charCode:56,shiftedCode:42,altCode:-1,colorCode:7},{width:1,keyCode:57,charCode:57,shiftedCode:40,altCode:-1},{width:1,keyCode:48,charCode:48,shiftedCode:41,altCode:-1},{width:1,keyCode:189,charCode:45,shiftedCode:95,altCode:-1},{width:1,keyCode:187,charCode:61,shiftedCode:43,altCode:-1},{width:2,keyCode:8,charCode:-1,shiftedCode:-1}],[{width:1.5,keyCode:9,charCode:-1,shiftedCode:-1,altCode:-1},{width:1,keyCode:81,charCode:113,shiftedCode:81,altCode:195},{width:1,keyCode:87,charCode:119,shiftedCode:87,altCode:180},{width:1,keyCode:69,charCode:101,shiftedCode:69,altCode:193},{width:1,keyCode:82,charCode:114,shiftedCode:82,altCode:194},{width:1,keyCode:84,charCode:116,shiftedCode:84,altCode:204},{width:1,keyCode:89,charCode:121,shiftedCode:89,altCode:185},{width:1,keyCode:85,charCode:117,shiftedCode:85,altCode:202},{width:1,keyCode:73,charCode:105,shiftedCode:73,altCode:203},{width:1,keyCode:79,charCode:111,shiftedCode:79,altCode:-1},{width:1,keyCode:80,charCode:112,shiftedCode:80,altCode:-1},{width:1,keyCode:219,charCode:91,shiftedCode:123,altCode:-1},{width:1,keyCode:221,charCode:93,shiftedCode:125,altCode:-1},{width:1.5,keyCode:220,charCode:92,shiftedCode:124,altCode:-1}],[{width:1.75,keyCode:20,charCode:-1,shiftedCode:-1},{width:1,keyCode:65,charCode:97,shiftedCode:65,altCode:218},{width:1,keyCode:83,charCode:115,shiftedCode:83,altCode:191},{width:1,keyCode:68,charCode:100,shiftedCode:68,altCode:179},{width:1,keyCode:70,charCode:102,shiftedCode:70,altCode:196},{width:1,keyCode:71,charCode:103,shiftedCode:71,altCode:201},{width:1,keyCode:72,charCode:104,shiftedCode:72,altCode:187},{width:1,keyCode:74,charCode:106,shiftedCode:74,altCode:186},{width:1,keyCode:75,charCode:107,shiftedCode:75,altCode:205},{width:1,keyCode:76,charCode:108,shiftedCode:76,altCode:195},{width:1,keyCode:186,charCode:59,shiftedCode:58,altCode:195},{width:1,keyCode:222,charCode:39,shiftedCode:34,altCode:195},{width:2.25,keyCode:13,charCode:-1,shiftedCode:-1}],[{width:2.25,keyCode:16,charCode:-1,shiftedCode:-1},{width:1,keyCode:90,charCode:122,shiftedCode:90,altCode:192},{width:1,keyCode:88,charCode:120,shiftedCode:88,altCode:217},{width:1,keyCode:67,charCode:99,shiftedCode:67,altCode:197},{width:1,keyCode:86,charCode:118,shiftedCode:86,altCode:195},{width:1,keyCode:66,charCode:98,shiftedCode:66,altCode:200},{width:1,keyCode:78,charCode:110,shiftedCode:78,altCode:188},{width:1,keyCode:77,charCode:109,shiftedCode:77,altCode:206},{width:1,keyCode:188,charCode:44,shiftedCode:60,altCode:195},{width:1,keyCode:190,charCode:46,shiftedCode:62,altCode:195},{width:1,keyCode:191,charCode:47,shiftedCode:63,altCode:195},{width:2.75,keyCode:16,charCode:-1,shiftedCode:-1}],[{width:1.5,keyCode:17},{width:1.25,keyCode:91},{width:1.5,keyCode:18},{width:6.5,keyCode:32,charCode:32,shiftedCode:32,altCode:32},{width:1.5,keyCode:18},{width:1.25,keyCode:92},{width:1.5,keyCode:17}]];this.keypad=[];this.petsciiKeyboard=[];for(var e=0;e<this.asciiKeyboard.length;e++){this.petsciiKeyboard.push([]);for(var t=0;t<this.asciiKeyboard[e].length;t++){var i={};i.width=this.asciiKeyboard[e][t].width;i.keyCode=this.asciiKeyboard[e][t].keyCode;i.colorCode=this.asciiKeyboard[e][t].colorCode;i.charCode=this.keyCodeToPetscii(i.keyCode,false,false);i.shiftedCode=this.keyCodeToPetscii(i.keyCode,true,false);i.altCode=this.keyCodeToPetscii(i.keyCode,false,true);this.petsciiKeyboard[e].push(i)}}this.keyboard=this.petsciiKeyboard},init:function(e){this.editor=e;this.initKeyboard();var t={offsetX:13,offsetY:13,keyCodes:[192,49,50,51,52,53,54,55,56,57,48,189,187]};this.keyboardRows.push(t);var t={offsetX:50,offsetY:40,keyCodes:[81,87,69,82,84,89,85,73,79,80,219,221,220]};this.keyboardRows.push(t);var t={offsetX:61,offsetY:67,keyCodes:[65,83,68,70,71,72,74,75,76,186,222]};this.keyboardRows.push(t);var t={offsetX:73,offsetY:94,keyCodes:[90,88,67,86,66,78,77,188,190,191]};this.keyboardRows.push(t)},keyUp:function(e){var t=e.keyCode;this.shiftDown=e.shiftKey;this.ctrlDown=e.ctrlKey;this.altDown=e.altKey;this.cmdDown=e.metaKey;if(this.keyCodeDown==t){this.keyCodeDown=-1}this.updateTypeCanvas()},keyPress:function(e){},keyCodeToPetscii:function(e,t,i){if(typeof t=="undefined"){t=this.shiftDown}if(typeof i=="undefined"){i=this.altDown}var r=-1;if(e==192){r=31;if(t){r=94}}if(e>=65&&e<=90){r=e-65+1;if(t){r+=64}else if(i){switch(r){case 1:r=112;break;case 2:r=127;break;case 3:r=124;break;case 4:r=108;break;case 5:r=113;break;case 6:r=123;break;case 7:r=101;break;case 8:r=116;break;case 9:r=98;break;case 10:r=117;break;case 11:r=97;break;case 12:r=118;break;case 13:r=103;break;case 14:r=106;break;case 15:r=121;break;case 16:r=111;break;case 17:r=107;break;case 18:r=114;break;case 19:r=110;break;case 20:r=99;break;case 21:r=120;break;case 22:r=126;break;case 23:r=115;break;case 24:r=125;break;case 25:r=119;break;case 26:r=109;break}}}if(e>=48&&e<=57){if(i){return-1}r=e;if(t){if(r==50){r=0}else if(r==54){r=30}else if(r==55){r=38}else if(r==56){r=42}else if(r==57){r=40}else if(r==48){r=41}else{r-=49-33}}}if(e==186){r=59;if(t){r=58}}if(e==188){if(!i){r=44}if(t){r=60}}if(e==190){if(!i){r=46}if(t){r=62}}if(e==191){if(!i){r=47}if(t){r=63}}if(e==32){r=32}if(e==187){r=61;if(t){r=43}else if(i){r=92}}if(e==189){r=45;if(i){r=102}if(t){r=91}}if(e==219){r=27;if(t){r=122}else if(i){r=100}}if(e==220){r=28;if(t){r=105}else if(i){r=104}}if(e==221){r=29;if(t){r=95}else if(i){r=64}}if(e==222){r=39;if(t){r=34}}if(this.reverse&&r!=-1){r+=128}return r},updateTypeCanvas:function(){var e=this.keyboard;var t=this.editor.tileSetManager.getCurrentTileSet();var i=this.editor.colorPaletteManager.getCurrentColorPalette();if(t.type=="petscii"||t.getType()=="vector"){this.keyboard=this.petsciiKeyboard}else{this.keyboard=this.asciiKeyboard}var r=t.charHeight;var a=t.charWidth;var s=2;if(r>14){s=1}var o=Math.floor(r*1.8);var l=Math.floor(a*1.8);if(s==1){o=Math.floor(r*1.4);l=Math.floor(a*1.4)}if(o>l){l=o}var n=o*5;var h=l*15;this.canvas.height=n*s+1;this.canvas.width=h*s+1;this.context=this.canvas.getContext("2d");this.context.fillStyle=styles.textMode.typingKeyboardBackground;this.context.fillRect(0,0,this.canvas.width*s,this.canvas.height*s);this.context.fillStyle=styles.textMode.typingKeyboardKeyHighlight;this.context.moveTo(0,0);for(var d=0;d<5;d++){this.context.moveTo(0,Math.floor(d*o*s)+.5);this.context.lineTo(h*s+1,Math.floor(d*o*s)+.5);var c=0;for(var f=0;f<e[d].length;f++){e[d][f].top=Math.floor(d*o*s)+.5;e[d][f].left=Math.floor(c*l*s)+.5;if(e[d][f].keyCode==this.keyCodeDown){this.context.fillRect(e[d][f].left,e[d][f].top,l*e[d][f].width*s,o*s)}this.context.moveTo(Math.floor(c*l*s)+.5,Math.floor(d*o*s)+.5);this.context.lineTo(Math.floor(c*l*s)+.5,Math.floor((d+1)*o*s)+.5);c+=e[d][f].width}this.context.moveTo(Math.floor(c*l*s)+.5,Math.floor(d*o*s)+.5);this.context.lineTo(Math.floor(c*l*s)+.5,Math.floor((d+1)*o*s)+.5)}this.context.moveTo(0,Math.floor(d*o*s)+.5);this.context.lineTo(h*s+1,Math.floor(d*o*s)+.5);this.context.strokeStyle=styles.textMode.typingKeyboardLines;this.context.lineWidth=.5;this.context.stroke();var u=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var c=13;var d=13;var p=4;var c=0;var d=0;for(var v=0;v<e.length;v++){c=0;d=v;for(var f=0;f<e[v].length;f++){var g=e[v][f].keyCode;var m=Math.floor(c*l*s+(l*s-a*s)/2);var y=Math.floor(d*o*s+(o*s-r*s)/2);var p=this.keyboard[v][f].charCode;if(this.shiftDown){p=this.keyboard[v][f].shiftedCode}var b=false;if(this.altDown){p=this.keyboard[v][f].altCode;if(p==-1&&typeof this.keyboard[v][f].colorCode!="undefined"){b=this.keyboard[v][f].colorCode;if(this.shiftDown){b+=8}}}if(typeof p=="undefined"){p=-1}var C=false;if(p>=0){t.drawCharacter({imageData:u,x:m,y:y,character:p,colorRGB:6710886,highlight:C,scale:s})}else if(b!==false){var x=i.getHex(b);t.drawCharacter({imageData:u,x:m,y:y,character:-1,colorRGB:x,highlight:C,scale:s})}c+=e[v][f].width}}this.context.putImageData(u,0,0)},show:function(){this.canvas=document.getElementById("typeKeyboard");this.context=this.canvas.getContext("2d");this.updateTypeCanvas()},moveCursor:function(e,t){var i=0;var r=0;var a=0;if(g_app.mode=="3d"){var s=this.editor.grid3d;i=s.getGridWidth();r=s.getGridHeight();t=-t;a=s.getXYPosition()}else{var o=this.editor.layers.getSelectedLayerObject();if(!o||o.getType()!="grid"){return}i=o.getGridWidth();r=o.getGridHeight()}var l=this.cursor.x;var n=this.cursor.y;l+=e;if(l>=i){l=l-i;if(g_app.mode=="3d"){t--}else{t++}}if(l<0){l=l+i;if(g_app.mode=="3d"){t++}else{t--}}n+=t;if(n>=r||n<0){n-=t}this.setCursorPosition({x:l,y:n,z:a})},keycodeToCharCode:function(e){for(var t=0;t<this.keyboard.length;t++){for(var i=0;i<this.keyboard[t].length;i++){if(this.keyboard[t][i].keyCode==e){if(this.shiftDown){return this.keyboard[t][i].shiftedCode}if(this.altDown){return this.keyboard[t][i].altCode}return this.keyboard[t][i].charCode}}}return-1},keyDown:function(e){var t=e.keyCode;this.shiftDown=e.shiftKey;this.ctrlDown=e.ctrlKey;this.altDown=e.altKey;this.cmdDown=e.metaKey;if(e.getModifierState("CapsLock")){this.shiftDown=true}this.editor.grid.setCursorEnabled(false);var i=undefined;var r=this.cursor.x;var a=this.cursor.y;var s=0;if(g_app.mode=="3d"){s=this.editor.grid3d.getXYPosition()}if(typeof r=="undefined"||typeof a=="undefined"||typeof s=="undefined"){var r=0;var a=this.editor.frames.height-1;this.setCursorPosition({x:r,y:a,z:s})}i=this.keycodeToCharCode(t);if(typeof i!="undefined"&&i>=0){this.keyCodeDown=t;if(this.reverse){i+=128}this.editor.history.startEntry("type");s=0;var o={t:i,fc:this.editor.currentTile.color,bc:this.editor.currentTile.bgColor,x:r,y:a,z:s};if(g_app.mode=="3d"){var l=this.editor.grid3d;o.z=l.getXYPosition();l.setCell(o)}else{var n=this.editor.layers.getSelectedLayerObject();if(n==null||n.getType()!="grid"){return}n.setCell(o);this.editor.grid.grid2d.setMirrorCells(n,o)}this.editor.history.endEntry();if(this.editor.frames.getBlockModeEnabled()){this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})}else{if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}}this.moveCursor(1,0)}this.updateTypeCanvas();if(t==48&&this.altDown){this.reverse=false}if(t==57&&this.altDown){this.reverse=true}switch(t){case 37:this.moveCursor(-1,0);break;case 39:this.moveCursor(1,0);break;case 38:this.moveCursor(0,-1);break;case 40:this.moveCursor(0,1);break;case 13:this.moveCursor(-r,1);break;case 8:this.moveCursor(-1,0);var r=this.cursor.x;var a=this.cursor.y;var s=0;this.editor.history.startEntry("type");if(g_app.mode=="3d"){var l=this.editor.grid3d;s=l.getXYPosition();l.setCell({t:this.editor.tileSetManager.noTile,x:r,y:a,z:s})}else{var n=this.editor.layers.getSelectedLayerObject();if(n==null||n.getType()!="grid"){return}s=0;n.setCell({t:this.editor.tileSetManager.blankCharacter,x:r,y:a,z:s})}this.editor.history.endEntry();if(this.editor.frames.getBlockModeEnabled()){if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}}break}}};var PixelCharacterDraw=function(){this.editor=null;this.mode="draw"};PixelCharacterDraw.prototype={init:function(e){this.editor=e},setMode:function(e){this.mode=e},characterToNumber:function(e){var t=0;var i=0;for(var r=0;r<this.vPixels;r++){for(var a=0;a<this.hPixels;a++){var s=a*this.pixelWidth;var o=r*this.pixelHeight;var l=this.pixelHeight;var n=this.pixelWidth;if(this.charHeight==20&&this.vPixels==3){switch(r){case 0:o=0;l=6;break;case 1:o=6;l=8;break;case 2:o=14;l=6;break}}var h=this.tileSet.preset;if(h=="sharpmz700_1"||h=="sharpmz700_1_japanese"||h=="sharpmz80a"){if(this.tileSet.getPixel(e,s,o)){return false}if(this.tileSet.getPixel(e,s+1,o)){return false}if(this.tileSet.getPixel(e,s,o+1)){return false}l=3;n=3;s+=1;o+=1}var d=this.tileSet.getPixel(e,s,o);for(var c=0;c<l;c++){for(var f=0;f<n;f++){var u=this.tileSet.getPixel(e,s+f,o+c);if(u!=d){return false}}}if(d){t=t+(1<<i)}i++}}return t},initCharset:function(){var e=this.editor.tileSetManager.getCurrentTileSet();this.tileSet=e;this.charWidth=this.tileSet.charWidth;this.charHeight=this.tileSet.charHeight;this.hPixels=2;this.vPixels=2;if(this.charWidth==8){this.hPixels=2}if(this.charWidth==8){this.vPixels=2}if(this.charWidth==12&&this.charHeight==20){this.hPixels=2;this.vPixels=3}var t=1<<this.hPixels*this.vPixels;this.pixelWidth=this.charWidth/this.hPixels;this.pixelHeight=this.charHeight/this.vPixels;this.pixelCharacters=[];this.characterPixelCharacter=[];for(var i=0;i<t;i++){this.pixelCharacters.push(false)}var r=0;for(var i=0;i<256;i++){var a=this.characterToNumber(i);if(a!==false){if(this.pixelCharacters[a]===false){r++;this.pixelCharacters[a]=i}}this.characterPixelCharacter[i]=a}},drawPixel:function(e,t,i){var r=e.xyToCell(t,i);if(r===false){return}var a=this.editor.currentTile.color;var s=this.xyToPixel(e,t,i);this.setPixel(e,a,r.x,r.y,r.z,s.x,s.y,s.z);return},erasePixel:function(e,t,i){var r=e.xyToCell(t,i);if(r===false){return}var a=this.editor.currentTile.color;var s=this.xyToPixel(e,t,i);this.removePixel(e,r.x,r.y,r.z,s.x,s.y,s.z);return},xyToPixel:function(e,t,i){return e.xyToCharPixel(t,i,this.hPixels,this.vPixels)},setPixel:function(e,t,i,r,a,s,o,l){var n=this.editor.layers.getSelectedLayerObject();if(!n||n.getType()!="grid"){return}var h=n.getGridWidth();var d=n.getGridHeight();var c=0;var f=0;var u=0;if(e.view=="front"||e.view=="2d front"){c=0;f=0}if(e.view=="top"){c=.25;f=0}if(e.view=="front"||e.view=="top"||e.view=="2d front"){if(i<0||i>=h||r<0||r>=d){return}var p=n.getCell({x:i,y:r});var v=p.t;if(p.fc!=t){v=this.editor.tileSetManager.blankCharacter}if(this.editor.frames.hasCharRotation){if(p.rx!=c||p.ry!=f){v=this.editor.tileSetManager.blankCharacter}}var g=o*this.hPixels+s;var m=1<<g;var y=this.characterPixelCharacter[v];var b=y|m;var C=this.pixelCharacters[b];var x={t:C,x:i,y:r,z:a,fc:t,rx:c,ry:f,rz:u};n.setCell(x);this.editor.grid.grid2d.setMirrorCells(n,x);this.editor.graphic.redraw()}},removePixel:function(e,t,i,r,a,s,o){var l=this.editor.layers.getSelectedLayerObject();if(!l||l.getType()!="grid"){return}var n=l.getGridWidth();var h=l.getGridHeight();var d=0;var c=0;var f=0;if(e.view=="front"||e.view=="2d front"){d=0;c=0}if(e.view=="top"){d=.25;c=0}if(e.type=="front"||e.type=="top"||e.view=="2d front"){var u=l.getCell({x:t,y:i});if(u===false){return}var p=u.t;var v=u.fc;var g=s*this.hPixels+a;var m=1<<g;var y=this.characterPixelCharacter[p];var b=y&~m;var C=this.pixelCharacters[b];var x={t:C,x:t,y:i,z:r,fc:v,rx:d,ry:c,rz:f};l.setCell(x);this.editor.grid.grid2d.setMirrorCells(l,x);this.editor.graphic.redraw()}},isPixelCharacter:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!="grid"){return false}var a=r.getTile({x:e,y:t});if(a>=256||a<0){return false}return this.characterPixelCharacter[a]!==false},mouseDown:function(e,t,i){this.editor.history.startEntry("draw pixel");if(this.mode=="draw"){console.log("draw pixel");this.drawPixel(e,t,i)}else if(this.mode=="erase"){console.log("erase pixel");this.erasePixel(e,t,i)}else if(this.mode=="fill"||this.mode=="fillerase"){}},mouseMove:function(e,t,i){if(e.buttons&1){if(this.mode=="draw"){this.drawPixel(e,t,i)}else if(this.mode=="erase"){this.erasePixel(e,t,i)}}this.updateCursor(e,t,i)},mouseUp:function(e,t,i){},updateCursor:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!="grid"){return}var a=r.getGridWidth();var s=r.getGridHeight();var o=123;var l=this.xyToPixel(e,t,i);var n=e.xyToCell(t,i);var h=0;var d=0;if(e.view=="front"){h=0;d=0}if(e.view=="top"){h=.25;d=0}this.editor.currentTile.rotY=d;this.editor.currentTile.rotX=h;this.editor.currentTile.rotZ=0;var c=l.y*this.hPixels+l.x;var f=1<<c;o=this.pixelCharacters[f];var u=this.editor.currentTile.color;if(this.editor.shiftDown||this.mode=="erase"){u=this.editor.currentTile.bgColor}if(n.x>=0&&n.x<a&&n.y>=0&&n.y<s){var p=r.getTile({x:n.x,y:n.y});var v=this.characterPixelCharacter[p];var g=v|f;var o=this.pixelCharacters[g];this.editor.currentTile.setCharacter(o);this.editor.grid.setCursorCharacterAndPosition(o,n.x,n.y,n.z,u);if(e.view=="2d front"){var o=o;var u=u;var m=false;this.editor.grid.grid2d.setCursor(n.x,n.y,o,u,m)}this.editor.grid.setCursorEnabled(true)}else{this.editor.grid.setCursorEnabled(false)}}};var LineSegmentDraw=function(){this.editor=null;this.mode="horizontal";this.invert=false;this.segments=[];this.segmentType=[]};LineSegmentDraw.prototype={init:function(e){this.editor=e},setMode:function(e){console.log("set mode to "+e);this.mode=e;$("#lineSegmentToolMode_"+e+" input").prop("checked",true)},setInvert:function(e){this.invert=e},isCharacter:function(e,t,i){if(t=="horizontalsingle"){for(var r=0;r<this.tileWidth;r++){if(!this.tileSet.getPixel(e,r,i)){return false}}for(var r=0;r<this.tileWidth;r++){for(var a=0;a<this.tileHeight;a++){if(a!=i){if(this.tileSet.getPixel(e,r,a)){return false}}}}return true}if(t=="horizontal"){if(i>=this.tileHeight-1){return false}for(var r=0;r<this.tileWidth;r++){if(!this.tileSet.getPixel(e,r,i)){return false}if(!this.tileSet.getPixel(e,r,i+1)){return false}}for(var r=0;r<this.tileWidth;r++){for(var a=0;a<this.tileHeight;a++){if(a!=i&&a!=i+1){if(this.tileSet.getPixel(e,r,a)){return false}}}}return true}if(t=="fromtop"){for(var r=0;r<this.tileWidth;r++){for(var a=0;a<this.tileHeight;a++){if(this.tileSet.getPixel(e,r,a)){if(a>i){return false}}else{if(a<=i){return false}}}}return true}if(t=="frombottom"){for(var r=0;r<this.tileWidth;r++){for(var a=0;a<this.tileHeight;a++){if(this.tileSet.getPixel(e,r,a)){if(a<i){return false}}else{if(a>=i){return false}}}}return true}if(t=="fromright"){for(var r=0;r<this.tileWidth;r++){for(var a=0;a<this.tileHeight;a++){if(this.tileSet.getPixel(e,r,a)){if(r<i){return false}}else{if(r>=i){return false}}}}return true}if(t=="fromleft"){for(var r=0;r<this.tileWidth;r++){for(var a=0;a<this.tileHeight;a++){if(this.tileSet.getPixel(e,r,a)){if(r>i){return false}}else{if(r<=i){return false}}}}return true}if(t=="verticalsingle"){for(var a=0;a<this.tileHeight;a++){if(!this.tileSet.getPixel(e,i,a)){return false}}for(var a=0;a<this.tileHeight;a++){for(var r=0;r<this.tileWidth;r++){if(r!=i){if(this.tileSet.getPixel(e,r,a)){return false}}}}return true}if(t=="vertical"){if(i>=this.tileWidth-1){return false}for(var a=0;a<this.tileHeight;a++){if(!this.tileSet.getPixel(e,i,a)){return false}if(!this.tileSet.getPixel(e,i+1,a)){return false}}for(var r=0;r<this.tileWidth;r++){for(var a=0;a<this.tileHeight;a++){if(r!=i&&r!=i+1){if(this.tileSet.getPixel(e,r,a)){return false}}}}return true}},findCharacters:function(){for(var e=0;e<this.tileCount;e++){}},initCharset:function(){console.log("init charset!");var e=this.editor.tileSetManager.getCurrentTileSet();this.tileSet=e;this.charWidth=this.tileSet.getTileWidth();this.charHeight=this.tileSet.getTileHeight();this.tileCount=256;this.tileHeight=8;this.tileWidth=8;this.hPixels=2;this.vPixels=2;var t=["horizontal","vertical","fromleft","fromright","fromtop","frombottom"];this.segmentType["horizontal"]="y";this.segments["horizontal"]=[];this.segments["vertical"]=[];this.segmentType["vertical"]="x";this.segments["fromleft"]=[];this.segmentType["fromleft"]="x";this.segments["fromright"]=[];this.segmentType["fromright"]="x";this.segments["fromtop"]=[];this.segmentType["fromtop"]="y";this.segments["frombottom"]=[];this.segmentType["frombottom"]="y";if(e.getType()=="petscii"){console.log("use petscii tiles");this.segments["horizontal"]=[99,119,69,68,64,70,82,111,100];this.segments["vertical"]=[101,84,71,93,72,89,106];this.segments["fromleft"]=[101,116,117,97,246,231,231,160];this.segments["fromright"]=[160,229,244,245,225,118,106,103];this.segments["fromtop"]=[99,119,120,226,249,239,228,160];this.segments["frombottom"]=[160,227,247,248,98,121,111,100]}else{console.log("find segments");for(var i=0;i<this.tileHeight;i++){var r=false;var a=false;for(var s=0;s<this.tileCount;s++){if(r===false&&this.isCharacter(s,"horizontalsingle",i)){r=s}if(a===false&&this.isCharacter(s,"horizontal",i)){a=s}if(r!==false&&a!==false){break}}if(r!==false){this.segments["horizontal"].push(r)}if(a!==false){this.segments["horizontal"].push(a)}}for(var i=0;i<this.tileWidth;i++){var o=false;var l=false;for(var s=0;s<this.tileCount;s++){if(o===false&&this.isCharacter(s,"verticalsingle",i)){o=s}if(l===false&&this.isCharacter(s,"vertical",i)){l=s}if(o!==false&&l!==false){break}}if(o!==false){this.segments["vertical"].push(o)}if(l!==false){this.segments["vertical"].push(l)}}for(var i=0;i<this.tileHeight;i++){for(var s=0;s<this.tileCount;s++){if(this.isCharacter(s,"fromleft",i)){this.segments["fromleft"].push(s);break}}}for(var i=0;i<this.tileHeight;i++){for(var s=0;s<this.tileCount;s++){if(this.isCharacter(s,"fromright",i)){this.segments["fromright"].push(s);break}}}for(var i=0;i<this.tileHeight;i++){for(var s=0;s<this.tileCount;s++){if(this.isCharacter(s,"fromtop",i)){this.segments["fromtop"].push(s);break}}}for(var i=0;i<this.tileHeight;i++){for(var s=0;s<this.tileCount;s++){if(this.isCharacter(s,"frombottom",i)){this.segments["frombottom"].push(s);break}}}for(var i=0;i<t.length;i++){if(this.segments[t[i]].length>0){$("#lineSegmentToolMode_"+t[i]).show()}else{$("#lineSegmentToolMode_"+t[i]).hide()}}}},mouseDown:function(e,t,i){if(e.buttons&1){this.editor.grid.grid2d.setCursorCells({})}},mouseMove:function(e,t,i){if(e.buttons&1){this.editor.grid.grid2d.setCursorCells({})}this.updateCursor(e,t,i)},mouseUp:function(e,t,i){},updateCursor:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!="grid"){return}var a=e.xyToCell(t,i);var s=r.getCellWidth();var o=r.getCellHeight();var l=e.xyToPixel(t,i);var n=l.x%s;var h=l.y%o;var d=this.segments[this.mode];if(n>=d.length){n=d.length-1}var c=0;var f=h;if(this.segmentType[this.mode]=="x"){f=n}if(this.segmentType[this.mode]=="y"){var u=e.xyToCellPercent(t,i);var p=u.y/this.tileHeight*this.segments[this.mode].length;f=Math.floor(p);if(f>=this.segments["horizontal"].length){f=this.segments["horizontal"].length-1}}if(this.segmentType[this.mode]=="x"){var u=e.xyToCellPercent(t,i);var v=u.x/this.tileWidth*this.segments[this.mode].length;f=Math.floor(v);if(f>=this.segments[this.mode].length){f=this.segments[this.mode].length-1}}c=this.segments[this.mode][f];if(typeof c=="undefined"){return}if(this.invert){c=(c+128)%256}var g=this.editor.currentTile.color;var m=this.editor.grid.grid2d;this.editor.currentTile.setCharacter(c);this.editor.grid.setCursorCharacterAndPosition(c,a.x,a.y,a.z,g);m.setCursor(a.x,a.y,c,this.editor.currentTile.color,this.editor.currentTile.bgColor);m.setCursorEnabled(true)}};var InvertTool=function(){this.editor=null;this.lastSetX=false;this.lastSetY=false};InvertTool.prototype={init:function(e){this.editor=e},toolSelected:function(){console.log("invert tool selected")},mouseDown:function(e,t,i){if(e.buttons&1){var r=e.xyToCell(t,i);if(!r){return}if(r.x!=this.lastSetX||r.y!=this.lastSetY){this.lastSetX=r.x;this.lastSetY=r.y;this.editor.grid.grid2d.setCursorCells({})}}},mouseMove:function(e,t,i){var r=e.xyToCell(t,i);if(!r){return}if(r.x!=this.lastSetX||r.y!=this.lastSetY){this.updateCursor(e,t,i);if(e.buttons&1){this.lastSetX=r.x;this.lastSetY=r.y;this.editor.grid.grid2d.setCursorCells({})}else{this.lastSetX=false;this.lastSetY=false}}},mouseUp:function(e,t,i){this.lastSetX=false;this.lastSetY=false},updateCursor:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!="grid"){return}var a=e.xyToCell(t,i);if(!a){return}var s=r.getCellWidth();var o=r.getCellHeight();var l=r.getCell(a);if(!l){return}var n=l.t;n=(n+128)%256;var h=l.fc;var d=l.bc;var c=this.editor.grid.grid2d;this.editor.currentTile.setCharacter(n);this.editor.currentTile.setColor(h);this.editor.grid.setCursorCharacterAndPosition(n,a.x,a.y,a.z,h);c.setCursor(a.x,a.y,n,h,d);c.setCursorEnabled(true)}};var CornersTool=function(){this.editor=null};CornersTool.prototype={init:function(e){this.editor=e},toolSelected:function(){console.log("corners tool selected")},mouseDown:function(e,t,i){if(e.buttons&1){this.editor.grid.grid2d.setCursorCells({})}},mouseMove:function(e,t,i){if(e.buttons&1){this.editor.grid.grid2d.setCursorCells({})}this.updateCursor(e,t,i)},mouseUp:function(e,t,i){},updateCursor:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!="grid"){return}var a=r.getTileSet();var s=e.xyToCell(t,i);var o=r.getCellWidth();var l=r.getCellHeight();var n=e.xyToPixel(t,i);var h=n.x%o;var d=n.y%l;var c=0;if(h<o/2&&d<l/2){c=0}else if(h>=o/2&&d<l/2){c=1}else if(h>=o/2&&d>=l/2){c=2}else{c=3}var f=this.editor.currentTile;var u=f.getTiles();if(u.length==0||u[0].length==0){return}var p=u[0][0];p=a.getTileRotation(p,c);var v=f.getColor();var g=f.getBGColor();var m=this.editor.grid.grid2d;this.editor.currentTile.setCharacter(p);this.editor.grid.setCursorCharacterAndPosition(p,s.x,s.y,s.z,color);m.setCursor(s.x,s.y,p,this.editor.currentTile.color,this.editor.currentTile.bgColor);m.setCursorEnabled(true)}};var PixelDraw=function(){this.editor=null;this.mode="draw";this.highlightCell=false;this.highlightColor=false;this.c64MultiColorType="cell";this.alteredCharacters=[];this.lastX=false;this.lastY=false;this.toolType="draw";this.color=0;this.shiftLineDirection=false;this.eventsSetup=false;this.lastHighlightTile=false;this.fillShape=false;this.stack=[]};PixelDraw.prototype={init:function(e){this.editor=e},show:function(){this.initC64MulticolorControl();var e=this.getToolLabel(this.toolType);$("#pixelToolLabel").html(e);if(!this.eventsSetup){this.initEvents();this.eventsSetup=true}},setFillShape:function(e){this.fillShape=e},initEvents:function(){var a=this;$(".pixelTool").on("mouseover",function(){var e=$(this).attr("data-toolType");var t=a.getToolLabel(e);$("#pixelToolLabel").html(t)});$(".pixelTool").on("mouseleave",function(){var e=a.getToolLabel(a.toolType);$("#pixelToolLabel").html(e)});$(".pixelTool").on("click",function(e){var t=$(this).attr("data-toolType");a.setTool(t)});$(".pixelToolSubPaletteColor").on("click",function(){var e=$(this).attr("data-index");a.selectColorSubPaletteColorIndex(e)});$("#pixelToolMulticolor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.setColor(e)};if(a.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){t.mode=TextModeEditor.Mode.C64MULTICOLOR}var i=e.pageX;var r=e.pageY;t.currentColor=a.getColor();a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("#pixelShapeFill").on("click",function(){a.setFillShape($(this).is(":checked"))})},selectColorSubPaletteColorIndex:function(e){this.editor.colorPaletteManager.colorSubPalettes.selectPaletteColor(e)},drawSelectedSubPaletteColor:function(){var e=this.color;$(".pixelToolSubPaletteColor").css({"border-width":"1px"});$("#pixelToolSettingsSubPaletteColor-"+e).css({"border-width":"2px"})},getToolLabel:function(e){var t={draw:{label:"Pencil",key:keys.textMode.toolsPencil.key},pen:{label:"Pencil",key:keys.textMode.toolsPencil.key},erase:{label:"Blank",key:keys.textMode.toolsErase.key},fill:{label:"Fill Bucket",key:keys.textMode.toolsBucket.key},eyedropper:{label:"Eyedropper",key:keys.textMode.toolsEyedropper.key},line:{label:"Line",key:keys.textMode.toolsShape.key},rect:{label:"Rect",key:keys.textMode.toolsShape.key},oval:{label:"Oval",key:keys.textMode.toolsShape.key},select:{label:"Marquee",key:keys.textMode.toolsMarquee.key},charpixel:{label:"Char Pixel",key:keys.textMode.toolsCharPixel.key},type:{label:"Type",key:keys.textMode.toolsType.key},pixel:{label:"Pixel",key:keys.textMode.toolsPixel.key},block:{label:"Block",key:keys.textMode.toolsBlock.key},zoom:{label:"Zoom",key:keys.textMode.toolsZoom.key},hand:{label:"Hand",key:keys.textMode.toolsHand.key},move:{label:"Move",key:keys.textMode.toolsMove.key}};if(t.hasOwnProperty(e)){return t[e].label+" (Shift + "+t[e].key+")"}return e},setTool:function(e){this.toolType=e;if(this.toolType=="erase"){this.mode="erase";this.setC64MultiColorType("background")}else{this.mode="draw";if(this.c64MultiColorType=="background"){this.setC64MultiColorType("cell")}}$(".pixelTool").removeClass("pixelToolSelected");$("#pixelTool_"+e).addClass("pixelToolSelected")},toggleShape:function(){switch(this.toolType){case"line":this.setTool("rect");break;case"rect":this.setTool("oval");break;case"oval":this.setTool("line");break;default:this.setTool("line");break}},setColor:function(e){this.color=e;var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i="#"+t.getHexString(e);$("#pixelToolMulticolor").css("background-color",i);$("#tileEditorMultiColor").css("background-color",i);this.editor.currentTile.setColor(e)},getColor:function(){return this.color},initC64MulticolorControl:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return}this.setC64MultiColorType(this.c64MultiColorType);e.setC64Multi1Color(e.getC64Multi1Color());e.setC64Multi2Color(e.getC64Multi2Color());this.editor.graphic.setBackgroundColor(this.editor.graphic.getBackgroundColor());this.editor.currentTile.setColor(this.editor.currentTile.getColor())},setC64MultiColorType:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return}this.c64MultiColorType=e;$(".tileEditorC64ColorType").removeClass("tileEditorC64ColorTypeSelected");$(".tileEditorC64ColorType_"+e).addClass("tileEditorC64ColorTypeSelected");var i=0;switch(e){case"cell":i=this.editor.currentTile.getColor();break;case"background":i=this.editor.graphic.getBackgroundColor();break;case"multi1":i=t.getC64Multi1Color();break;case"multi2":i=t.getC64Multi2Color();break}if(e!="background"&&this.mode=="erase"){this.setTool("draw")}if(this.editor.tileEditor){this.editor.tileEditor.selectC64ColorType(e,i)}if(this.editor.tileEditorMobile){this.editor.tileEditorMobile.selectC64ColorType(e,i)}if(this.editor.tools.drawTools.blockPalette&&this.editor.blockEditor){this.editor.blockEditor.selectC64ColorType(e,i)}},keyDown:function(e){var t=e.keyCode;var i=String.fromCharCode(t).toUpperCase();if(e.shiftKey){switch(i){case keys.textMode.toolsPencil.key:this.setTool("draw");break;case keys.textMode.toolsErase.key:this.setTool("erase");break;case keys.textMode.toolsEyedropper.key:this.setTool("eyedropper");break;case keys.textMode.toolsMarquee.key:this.setTool("select");break;case keys.textMode.toolsShape.key:this.toggleShape();break}}},addToAlteredCharacters:function(e){if(this.alteredCharacters.indexOf(e)!==-1){return}this.alteredCharacters.push(e)},resetAlteredCharacters:function(){this.alteredCharacters=[]},startShape:function(){var e=this.editor.tileSetManager.getCurrentTileSet();this.characterDataCopy=e.getCharacterDataCopy();this.resetAlteredCharacters()},endShape:function(){},updateShape:function(e,t){var i=this.editor.tileSetManager.getCurrentTileSet();i.restoreCharacterDataFor(this.characterDataCopy,this.alteredCharacters);for(var r=0;r<this.alteredCharacters.length;r++){i.updateCharacterCurrentData(this.alteredCharacters[r])}this.resetAlteredCharacters();if(this.toolType=="line"){this.drawLine(e,this.mouseDownAtX,this.mouseDownAtY,t.x,t.y)}else if(this.toolType=="rect"){this.drawRect(e,this.mouseDownAtX,this.mouseDownAtY,t.x,t.y)}else if(this.toolType=="oval"){this.drawOval(e,this.mouseDownAtX,this.mouseDownAtY,t.x,t.y)}},drawPixelTextmode:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return}var i=t.getTile(e);var r=this.editor.tileSetManager.getCurrentTileSet();var a=this.editor.getScreenMode();if(a==TextModeEditor.Mode.NES){if(this.toolType=="eyedropper"){var s=r.getPixel(i,e.pixelX,e.pixelY);this.selectColorSubPaletteColorIndex(s)}else{if(this.mode=="erase"){r.setPixel(i,e.pixelX,e.pixelY,0,false)}else{r.setPixel(i,e.pixelX,e.pixelY,this.color,false)}}}else if(a==TextModeEditor.Mode.INDEXED){if(this.mode=="erase"){r.setPixel(i,e.pixelX,e.pixelY,0,false)}else{r.setPixel(i,e.pixelX,e.pixelY,this.color,false)}}else if(a==TextModeEditor.Mode.RGB){if(this.mode=="erase"){r.setPixel(i,e.pixelX,e.pixelY,0,false)}else{r.setPixel(i,e.pixelX,e.pixelY,this.color,false)}}else{if(this.mode=="draw"){if(this.editor.graphic.getType()=="sprite"){switch(this.editor.tools.drawTools.pixelDraw.c64MultiColorType){case"background":r.setPixel(i,e.pixelX,e.pixelY,0,false);break;default:r.setPixel(i,e.pixelX,e.pixelY,1,false);break}}else{r.setPixel(i,e.pixelX,e.pixelY,1,false)}}else if(this.mode=="erase"){r.setPixel(i,e.pixelX,e.pixelY,0,false)}}},drawPixelC64Multicolor:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return}var i=t.getCell(e);var r=i.t;var a=i.fc;var s=this.editor.tileSetManager.getCurrentTileSet();if(a>=8||this.editor.graphic.getType()=="sprite"){var o=Math.floor(e.pixelX/2)*2;if(this.editor.graphic.getType()=="sprite"){switch(this.editor.tools.drawTools.pixelDraw.c64MultiColorType){case"background":s.setPixel(r,o,e.pixelY,0,false);s.setPixel(r,o+1,e.pixelY,0,false);break;case"multi1":s.setPixel(r,o,e.pixelY,0,false);s.setPixel(r,o+1,e.pixelY,1,false);break;case"multi2":s.setPixel(r,o,e.pixelY,1,false);s.setPixel(r,o+1,e.pixelY,1,false);break;default:case"cell":s.setPixel(r,o,e.pixelY,1,false);s.setPixel(r,o+1,e.pixelY,0,false);break}}else{switch(this.editor.tools.drawTools.pixelDraw.c64MultiColorType){case"background":s.setPixel(r,o,e.pixelY,0,false);s.setPixel(r,o+1,e.pixelY,0,false);break;case"multi1":s.setPixel(r,o,e.pixelY,0,false);s.setPixel(r,o+1,e.pixelY,1,false);break;case"multi2":s.setPixel(r,o,e.pixelY,1,false);s.setPixel(r,o+1,e.pixelY,0,false);break;default:case"cell":s.setPixel(r,o,e.pixelY,1,false);s.setPixel(r,o+1,e.pixelY,1,false);break}}}else{if(this.mode=="draw"){s.setPixel(r,e.pixelX,e.pixelY,1,false)}else if(this.mode=="erase"){s.setPixel(r,e.pixelX,e.pixelY,0,false)}}},isValidPixel:function(e,t,i){var r=e.getTileWidth();var a=e.getTileHeight();if(t>=0&&t<r&&i>=0&&i<a){return true}return false},stackPush:function(e){var t=this.editor.tileSetManager.getCurrentTileSet();if(!this.isValidPixel(t,e.x,e.y)){return}for(var i=0;i<this.stack.length;i++){if(this.stack[i].x==e.x&&this.stack[i].y==e.y){return}}this.stack.push(e)},stackPop:function(){var e=this.stack[this.stack.length-1];this.stack=this.stack.slice(0,-1);return e},fill:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){return}var r=i.getScreenMode();var a=this.editor.tileSetManager.getCurrentTileSet();var s=a.getTileWidth();var o=a.getTileHeight();var l={x:Math.floor(t.x/s),y:Math.floor(t.y/o)};l.pixelX=t.x%s;l.pixelY=t.y%o;if(r==TextModeEditor.Mode.C64MULTICOLOR){l.pixelX=Math.floor(l.pixelX/2)*2}var n=l.pixelX;var h=l.pixelY;var d=i.getTile(l);var c=a.getPixel(d,n,h);if(r==TextModeEditor.Mode.C64MULTICOLOR){c=(c<<1)+a.getPixel(d,n+1,h)}var f=this.editor.currentTile.getColor();var u=this.editor.currentTile.getBGColor();var p=1;if(r==TextModeEditor.Mode.INDEXED||r==TextModeEditor.RGB){p=f}if(c==p){return}this.stack=[];this.stackPush({x:n,y:h});var v=0;while(this.stack.length>0){v++;if(v>1e4){return}var g=this.stackPop();var m={x:g.x,y:g.y};var y={x:g.x,y:g.y};while(this.isValidPixel(a,m.x,m.y)){var b=a.getPixel(d,m.x,m.y);if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){b=(b<<1)+a.getPixel(d,m.x+1,m.y)}if(b!=c){break}a.setPixel(d,m.x,m.y,p,false);var C={x:m.x,y:m.y+1};var x=a.getPixel(d,C.x,C.y);if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){x=(x<<1)+a.getPixel(d,C.x+1,C.y)}if(this.isValidPixel(a,C.x,C.y)&&x===c){this.stackPush(C)}var S={x:m.x,y:m.y-1};var P=a.getPixel(d,S.x,S.y);if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){P=(P<<1)+a.getPixel(d,S.x+1,S.y)}if(this.isValidPixel(a,S.x,S.y)&&P===c){this.stackPush(S)}m.x--}m.x++;y.x++;while(this.isValidPixel(a,y.x,y.y)){var b=a.getPixel(d,y.x,y.y);if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){b=(b<<1)+a.getPixel(d,y.x+1,y.y)}if(b!=c){break}a.setPixel(d,y.x,y.y,p,false);var C={x:y.x,y:y.y+1};var x=a.getPixel(d,C.x,C.y);if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){x=a.getPixel(d,C.x+1,C.y)}if(this.isValidPixel(a,C.x,C.y)&&x===c){this.stackPush(C)}var S={x:y.x,y:y.y-1};var P=a.getPixel(d,S.x,S.y);if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){P=a.getPixel(d,S.x+1,S.y)}if(this.isValidPixel(a,S.x,S.y)&&P===c){this.stackPush(S)}y.x++;if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){y.x++}}y.x--;if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){y.x--}}a.updateCharacterCurrentData(d);this.editor.graphic.redraw({allCells:true})},drawPixel:function(e,t){console.log("draw pixel");var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){return}var r=i.getTileSet();var a=r.getTileWidth();var s=r.getTileHeight();var o={x:Math.floor(t.x/a),y:Math.floor(t.y/s)};o.pixelX=t.x%a;o.pixelY=t.y%s;var l=i.getTile(o);var n=this.editor.tools.drawTools.pixelSelect;var h=n.isActive();if(h){var d=n.getSelection();if(t.x<d.minX||t.x>=d.maxX){return}if(t.y<d.minY||t.y>=d.maxY){return}}if(l!==false){if(this.editor.graphic.getHasTileFlip()||this.editor.graphic.getHasTileRotate()){this.adjustForOrientation(o)}this.addToAlteredCharacters(l);if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){this.drawPixelC64Multicolor(o)}else{this.drawPixelTextmode(o)}r.updateCharacter(l);this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw();if(this.editor.tileEditor.visible){this.editor.tileEditor.draw()}if(this.editor.animationPreview.getVisible()){this.editor.animationPreview.draw()}}},drawRect:function(e,t,i,r,a){var s=this.editor.layers.getSelectedLayerObject();if(!s||s.getType()!="grid"){return}if(t==r&&i==a){return}var o=this.editor.tools.drawTools.pixelSelect;var l=o.isActive();var n=this.editor.tileSetManager.getCurrentTileSet();var h=n.getTileWidth();var d=n.getTileHeight();if(t>r){var c=r;r=t;t=c}if(i>a){var c=a;a=i;i=c}var f={};var u=s.getGridWidth();var p=s.getGridHeight();for(var v=t;v<=r;v++){for(var g=i;g<=a;g++){var m=g===i||g===a||v===t||v===r||this.fillShape;if(m){var f={x:Math.floor(v/h),y:Math.floor(g/d)};f.pixelX=v%h;f.pixelY=g%d;var y=true;if(l){var b=o.getSelection();if(v<b.minX||v>=b.maxX){y=false}if(g<b.minY||g>=b.maxY){y=false}}if(y&&f.x>=0&&f.x<u&&f.y>=0&&f.y<p){var C=s.getTile(f);if(this.editor.graphic.getHasTileFlip()||this.editor.graphic.getHasTileRotate()){this.adjustForOrientation(f)}this.addToAlteredCharacters(C);if(f){if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){this.drawPixelC64Multicolor(f)}else{this.drawPixelTextmode(f)}}}}}}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw();if(this.editor.tileEditor.visible){this.editor.tileEditor.draw()}if(this.editor.animationPreview.getVisible()){this.editor.animationPreview.draw()}},drawOval:function(e,t,i,r,a){var s=this.editor.layers.getSelectedLayerObject();if(!s||s.getType()!="grid"){return}if(t==r&&i==a){return}var o=this.editor.tools.drawTools.pixelSelect;var l=o.isActive();var n=this.editor.tileSetManager.getCurrentTileSet();var h=n.getTileWidth();var d=n.getTileHeight();if(t>r){var c=r;r=t;t=c}if(i>a){var c=a;a=i;i=c}var f=i+(a-i)/2;var u=t+(r-t)/2;var p=r-t;var v=a-i;var g=1;var m=1;if(p>v){m=v/p;radius=p/2}else{g=p/v;radius=v/2}var y={};var b=s.getGridWidth();var C=s.getGridHeight();var x=[];var S=300;var P=0;for(var w=0;w<S;w++){P=2*Math.PI*w/S;var I=Math.round(u+g*radius*Math.cos(P));var k=Math.round(f+m*radius*Math.sin(P));var M=false;for(var T=0;T<x.length;T++){if(x[T].y===k){M=true;if(x[T].x1!==I){x[T].x2=I}break}}if(!M){x.push({y:k,x1:I,x2:false})}var y={x:Math.floor(I/h),y:Math.floor(k/d)};y.pixelX=I%h;y.pixelY=k%d;var D=true;if(l){var E=o.getSelection();if(I<E.minX||I>=E.maxX){D=false}if(k<E.minY||k>=E.maxY){D=false}}if(D&&y.x>=0&&y.x<b&&y.y>=0&&y.y<C){var $=s.getTile(y);if(this.editor.graphic.getHasTileFlip()||this.editor.graphic.getHasTileRotate()){this.adjustForOrientation(y)}this.addToAlteredCharacters($);if(y){if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){this.drawPixelC64Multicolor(y)}else{this.drawPixelTextmode(y)}}}}if(this.fillShape){for(var T=0;T<x.length;T++){var t=x[T].x1;var r=x[T].x2;if(r!==false){if(t>r){var c=r;r=t;t=c}k=x[T].y;for(var I=t+1;I<r;I++){var y={x:Math.floor(I/h),y:Math.floor(k/d)};y.pixelX=I%h;y.pixelY=k%d;var D=true;if(l){var E=o.getSelection();if(I<E.minX||I>=E.maxX){D=false}if(k<E.minY||k>=E.maxY){D=false}}if(D&&y.x>=0&&y.x<b&&y.y>=0&&y.y<C){var $=s.getTile(y);if(this.editor.graphic.getHasTileFlip()||this.editor.graphic.getHasTileRotate()){this.adjustForOrientation(y)}this.addToAlteredCharacters($);if(y){if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){this.drawPixelC64Multicolor(y)}else{this.drawPixelTextmode(y)}}}}}}}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw();if(this.editor.tileEditor.visible){this.editor.tileEditor.draw()}if(this.editor.animationPreview.getVisible()){this.editor.animationPreview.draw()}},adjustForOrientation:function(e){var t=this.editor.layers.getSelectedLayerObject();var i=t.getCellHeight();var r=t.getCellWidth();var a=t.getCell(e);if(a.fh){e.pixelX=r-1-e.pixelX}if(a.fv){e.pixelY=i-1-e.pixelY}if(a.rz){var s=e.pixelX;var o=e.pixelY;if(a.rz==1){e.pixelX=o;e.pixelY=r-1-s}if(a.rz==2){e.pixelX=r-1-s;e.pixelY=i-1-o}if(a.rz==3){e.pixelX=i-1-o;e.pixelY=s}}},drawLine:function(e,t,i,r,a){var s=this.editor.layers.getSelectedLayerObject();if(!s||s.getType()!="grid"){return}if(t==r&&i==a){return}var o=this.editor.tools.drawTools.pixelSelect;var l=o.isActive();var n=this.editor.tileSetManager.getCurrentTileSet();var h=n.getTileWidth();var d=n.getTileHeight();var c=t;var f=i;var u=r-t;if(u<0){u=-u}var p=a-i;if(p<0){p=-p}var v={};var g=s.getGridWidth();var m=s.getGridHeight();if(u>p){if(t>r){var y=r;r=t;t=y;y=a;a=i;i=y}for(var b=t;b<=r;b++){var C=Math.round(i+(a-i)*(b-t)/(r-t));var v={x:Math.floor(b/h),y:Math.floor(C/d)};var x=true;if(l){var S=o.getSelection();if(b<S.minX||b>=S.maxX){x=false}if(C<S.minY||C>=S.maxY){x=false}}v.pixelX=b%h;v.pixelY=C%d;if(x&&v.x>=0&&v.x<g&&v.y>=0&&v.y<m){var P=s.getTile(v);if(this.editor.graphic.getHasTileFlip()||this.editor.graphic.getHasTileRotate()){this.adjustForOrientation(v)}this.addToAlteredCharacters(P);if(v){if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){this.drawPixelC64Multicolor(v)}else{this.drawPixelTextmode(v)}}}}}else{if(i>a){var y=a;a=i;i=y;y=r;r=t;t=y}for(var C=i;C<=a;C++){var b=Math.round(t+(r-t)*(C-i)/(a-i));var v={x:Math.floor(b/h),y:Math.floor(C/d)};v.pixelX=b%h;v.pixelY=C%d;var x=true;if(l){var S=o.getSelection();if(b<S.minX||b>=S.maxX){x=false}if(C<S.minY||C>=S.maxY){x=false}}if(x&&v.x>=0&&v.x<g&&v.y>=0&&v.y<m){var P=s.getTile(v);if(this.editor.graphic.getHasTileFlip()||this.editor.graphic.getHasTileRotate()){this.adjustForOrientation(v)}this.addToAlteredCharacters(P);if(v){if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){this.drawPixelC64Multicolor(v,b,C)}else{this.drawPixelTextmode(v,b,C)}}}}}for(var w=0;w<this.alteredCharacters.length;w++){}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw();if(this.editor.tileEditor.visible){this.editor.tileEditor.draw()}if(this.editor.animationPreview.getVisible()){this.editor.animationPreview.draw()}},rotate:function(){var e=this.editor.tools.drawTools.pixelSelect;var t=e.isActive();if(!t){e.selectAll()}else{}e.cut();e.paste({rotate:true,allowMove:false});if(!t){e.unselectAll()}},invert:function(){var e=this.editor.tools.drawTools.pixelSelect;var t=e.isActive();if(!t){e.selectAll()}else{}e.cut();e.paste({invert:true,allowMove:false});if(!t){e.unselectAll()}},flipH:function(){var e=this.editor.tools.drawTools.pixelSelect;var t=e.isActive();if(!t){e.selectAll()}else{}e.cut();e.paste({hflip:true,allowMove:false});if(!t){e.unselectAll()}},flipV:function(){var e=this.editor.tools.drawTools.pixelSelect;var t=e.isActive();if(!t){e.selectAll()}else{}e.cut();e.paste({vflip:true,allowMove:false});if(!t){e.unselectAll()}},setLastCursorPixelLocation:function(e){this.lastX=e.x;this.lastY=e.y;this.lastZ=e.z},mouseDown:function(e,t,i,r){var a=e.xyToPixel(i,r);this.resetAlteredCharacters();if(this.toolType=="line"||this.toolType=="rect"||this.toolType=="oval"){this.startShape()}this.editor.history.startEntry("draw pixel");this.editor.history.addAction("cursorPixelLocation",{x:this.lastX,y:this.lastY,z:a.z});this.shiftLineDirection=false;if(this.toolType=="fill"){this.fill(e,a)}else{if(typeof t!="undefined"&&typeof t.shiftKey!="undefined"&&t.shiftKey&&this.lastX!==false&&this.lastY!==false){this.drawLine(e,this.lastX,this.lastY,a.x,a.y)}else{this.drawPixel(e,a)}}this.lastX=a.x;this.lastY=a.y;this.mouseDownAtX=a.x;this.mouseDownAtY=a.y;this.editor.currentTile.canvasDrawCharacters()},mouseMove:function(e,t,i,r){var a=this.editor.layers.getSelectedLayerObject();if(!a||a.getType()!="grid"){return}var s=a.getScreenMode();this.highlightCell=e.xyToCell(i,r,true);var o=a.getCellWidth();var l=a.getCellHeight();var n=false;var h=false;var d=false;var c=false;if(this.highlightCell!==false){n=a.getCell(this.highlightCell);h=n.fh;d=n.fv;c=n.rz}if(n!==false&&!g_app.isMobile()){if(this.lastHighlightTile!==n.t){this.lastHighlightTile=n.t;if(!this.editor.tileEditor.getVisible()){this.editor.currentTile.setTiles([[n.t]]);var f=this.editor.tools.drawTools;if(f.tilePalette){this.editor.tools.drawTools.tilePalette.setHighlightCharacter(n.t);this.editor.tools.drawTools.tilePalette.drawTilePalette();this.editor.sideTilePalette.setHighlightCharacter(n.t);this.editor.sideTilePalette.drawTilePalette()}}}}if(n===false){}var u=e.xyToPixel(i,r);if(this.editor.graphic.getType()=="sprite"){var p=0;var v=0;var g=0;this.editor.gridInfo.setSpriteInfo(u.x,u.y,0,p,v,g)}if(e.buttons&1&&!e.leftMouseUp){var m=this.lastX;var y=this.lastY;var b=u.x;var C=u.y;if(typeof t!="undefined"&&typeof t.shiftKey!="undefined"&&t.shiftKey){if(this.shiftLineDirection===false){var x=this.mouseDownAtX-u.x;if(x<0){x=-x}var S=this.mouseDownAtY-u.y;if(S<0){S=-S}if(x>S){this.shiftLineDirection="horizontal"}else if(S>x){this.shiftLineDirection="vertical"}}if(this.shiftLineDirection=="vertical"){m=this.mouseDownAtX;b=this.mouseDownAtX}else{y=this.mouseDownAtY;C=this.mouseDownAtY}}if(this.toolType=="line"||this.toolType=="rect"||this.toolType=="oval"){this.updateShape(e,u)}else{this.drawLine(e,m,y,b,C);this.lastX=u.x;this.lastY=u.y}this.editor.currentTile.canvasDrawCharacters()}else{if(this.highlightCell===false||n===false){return}var P=this.editor.tileSetManager.getCurrentTileSet();var w=n.t;var I=n.fc;if(s==TextModeEditor.Mode.C64MULTICOLOR){switch(this.c64MultiColorType){case"cell":this.highlightColor=I;if(this.editor.graphic.getType()!=="sprite"){if(I>=8){this.highlightColor-=8}}break;case"background":this.highlightColor=this.editor.graphic.getBackgroundColor();break;case"multi1":this.highlightColor=a.getC64Multi1Color();break;case"multi2":this.highlightColor=a.getC64Multi2Color();break}}else if(s==TextModeEditor.Mode.INDEXED){this.highlightColor=this.color}else if(s==TextModeEditor.Mode.RGB){this.highlightColor=this.color}else if(P.getPixel(w,this.highlightCell.pixelX,this.highlightCell.pixelY)==0){var I=n.fc;this.highlightColor=I}else{this.highlightColor=n.bc;if(this.highlightColor==this.editor.colorPaletteManager.noColor){this.highlightColor=this.editor.graphic.getBackgroundColor()}}}},mouseUp:function(e,t){if(this.editor.graphic.getOnlyViewBoundsDrawn()){this.editor.graphic.redraw({allCells:true})}this.editor.tools.drawTools.tilePalette.drawTilePalette({redrawTiles:true,tiles:this.alteredCharacters});this.editor.sideTilePalette.drawTilePalette({redrawTiles:true,tiles:this.alteredCharacters});this.resetAlteredCharacters()}};var Fill=function(){this.editor=null;this.stack=[]};Fill.prototype={init:function(e){this.editor=e},nonContiguousFill:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){return false}var r=this.editor.tools.drawTools;this.gridWidth=i.getGridWidth();this.gridHeight=i.getGridHeight();var a=i.getCell({x:e,y:t});var s={};for(key in a){s[key]=a[key]}var o=this.editor.currentTile.getCharacters();if(o.length==0){return}var l=o[0][0];var n=this.editor.currentTile.getColor();var h=this.editor.currentTile.getBGColor();for(var t=0;t<this.gridHeight;t++){for(var e=0;e<this.gridWidth;e++){var d=i.getCell({x:e,y:t});if(this.cellsAreEqual(s,d)){var c={x:e,y:t,t:l,fc:n,bc:h,update:false};if(!r.drawCharacter){c.t=d.t}if(!r.drawColor){c.fc=d.fc}if(!r.drawBGColor){c.bc=cellData.bc}i.setCell(c)}}}if(i.getBlockModeEnabled()){this.editor.graphic.invalidateAllCells()}this.editor.graphic.redraw()},floodFill:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){return false}var r=this.editor.tools.drawTools;this.gridWidth=i.getGridWidth();this.gridHeight=i.getGridHeight();var a=i.getCell({x:e,y:t});var s={};for(key in a){s[key]=a[key]}var o=this.editor.currentTile.getCharacters();if(o.length==0){return}var l=o[0][0];var n=this.editor.currentTile.getColor();var h=this.editor.currentTile.getBGColor();if(s.t===l.t&&s.fc===n&&s.bc===h){return}this.stack=[];this.stackPush({x:e,y:t});var d=0;while(this.stack.length>0){d++;if(d>1e4){return}var c=this.stackPop();var f={x:c.x,y:c.y};var u={x:c.x,y:c.y};while(this.isValidCell(f)){var p=i.getCell({x:f.x,y:f.y});if(!this.cellsAreEqual(s,p)){break}var v={x:f.x,y:f.y,t:l,fc:n,bc:h,update:false};if(!r.drawCharacter){v.t=p.t}if(!r.drawColor){v.fc=p.fc}if(!r.drawBGColor){v.bc=cellData.bc}i.setCell(v);var g={x:f.x,y:f.y+1};if(this.isValidCell(g)&&this.cellsAreEqual(s,i.getCell(g))){this.stackPush(g)}var m={x:f.x,y:f.y-1};if(this.isValidCell(m)&&this.cellsAreEqual(s,i.getCell(m))){this.stackPush(m)}f.x--}f.x++;u.x++;while(this.isValidCell(u)){var p=i.getCell({x:u.x,y:u.y});if(!this.cellsAreEqual(s,p)){break}var v={x:u.x,y:u.y,t:l,fc:n,bc:h,update:false};if(!r.drawCharacter){v.t=p.t}if(!r.drawColor){v.fc=p.fc}if(!r.drawBGColor){v.bc=cellData.bc}i.setCell(v);var g={x:u.x,y:u.y+1};if(this.isValidCell(g)&&this.cellsAreEqual(s,i.getCell(g))){this.stackPush(g)}var m={x:u.x,y:u.y-1};if(this.isValidCell(m)&&this.cellsAreEqual(s,i.getCell(m))){this.stackPush(m)}u.x++}u.x--}if(i.getBlockModeEnabled()){this.editor.graphic.invalidateAllCells()}this.editor.graphic.redraw()},cellsAreEqual:function(e,t){var i=this.editor.tools.drawTools;if(i.drawCharacter){if(e.t!==t.t){return false}}if(i.drawColor){if(e.fc!==t.fc){return false}}if(i.drawBGColor){if(e.bc!==t.bc){return false}}return true},isValidCell:function(e){if(this.editor.tools.drawTools.select.isActive()){if(!this.editor.tools.drawTools.select.inSelection(e.x,e.y)){return false}}if(e.x<0||e.x>=this.gridWidth||e.y<0||e.y>=this.gridHeight){return false}return true},stackPush:function(e){if(!this.isValidCell(e)){return}for(var t=0;t<this.stack.length;t++){if(this.stack[t].x==e.x&&this.stack[t].y==e.y){return}}this.stack.push(e)},stackPop:function(){var e=this.stack[this.stack.length-1];this.stack=this.stack.slice(0,-1);return e},fill:function(e,t,i,r){console.error("FULL!!!");var a=this.editor.grid;var s=this.editor.grid.gridData;var o=this.editor.currentTile.getCharacters();if(o.length==0){return}var l=o[0][0];var n=this.editor.currentTile.getColor();var h=this.editor.currentTile.getBGColor();var d=this.editor.currentTile.rotX;var c=this.editor.currentTile.rotY;var f=this.editor.currentTile.rotZ;var u=this.editor.currentTile.flipH;var p=this.editor.currentTile.flipV;var v=s[r][i][t].c;var g=s[r][i][t].fc;var m=s[r][i][t].bc;this.fillStack=[];if(v!=l||g!=n||m!=h){this.stackPush({x:t,y:i,z:r})}var y={};var b=0;while(this.stack.length>0){var C=this.stackPop();b++;if(b>1e4){alert("reached max!");break}var x=true;if(s[C.z][C.y][C.x].c!=v){x=false}if(s[C.z][C.y][C.x].fc!=g){x=false}if(s[C.z][C.y][C.x].bc!=m){x=false}if(x){if(!this.editor.tools.drawTools.drawCharacter){l=s[C.z][C.y][C.x].c}if(!this.editor.tools.drawTools.drawColor){n=s[C.z][C.y][C.x].fc}if(!this.editor.tools.drawTools.drawBGColor){h=s[C.z][C.y][C.x].bc}y.t=l;y.x=C.x;y.y=C.y;y.z=C.z;y.fc=n;y.rx=d;y.ry=c;y.rz=f;y.fh=u;y.fv=p;y.bc=h;y.update=false;a.setCell(y);var S={x:C.x-1,y:C.y,z:C.z};if(S.x>=0){this.stackPush(S)}var S={x:C.x+1,y:C.y,z:C.z};if(S.x<a.width){this.stackPush(S)}if(e=="xz"){var S={x:C.x,y:C.y,z:C.z-1};if(S.z>=0){this.stackPush(S)}var S={x:C.x,y:C.y,z:C.z+1};if(S.z<a.depth){this.stackPush(S)}}else{var S={x:C.x,y:C.y-1,z:C.z};if(S.y>=0){this.stackPush(S)}var S={x:C.x,y:C.y+1,z:C.z};if(S.y<a.height){this.stackPush(S)}}}}if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}}};var Select=function(){this.editor=null;this.inSelect=false;this.inDragSelect=false;this.inDragSelectedCharacters=false;this.mouseDownOnCell={x:0,y:0,z:0};this.mouseDownOnBlock={x:0,y:0};this.selectSave={minX:0,maxX:0,minY:0,maxY:0,minZ:0,maxZ:0};this.data=[];this.replaceColor=0;this.replaceWithColor=0;this.invertY=true;this.lastSelection={from:{x:0,y:0,z:0},to:{x:0,y:0,z:0}};this.selectionEnabled=false;this.expandFromMiddle=false;this.mouseDownX=false;this.mouseDownY=false;this.selection={visible:false,minX:0,minY:0,minZ:0,maxX:0,maxY:0,maxZ:0};this.selectionOffsetX=0;this.selectionOffsetY=0;this.lastCell={x:0,y:0};this.clipboardCanvas=null;this.clipboardImageData=null;this.clipboardContext=null;this.inPasteMove=false;this.inDragPastedContent=false;this.copiedFromFrame=false;this.copiedFromLayer=false;this.selectionChangedAfterCopy=false};Select.prototype={init:function(e){this.editor=e},show:function(){if(this.editor.type=="2d"){$(".selectZControl").hide()}},isActive:function(){if(this.editor.getEditorMode()=="pixel"){return false}return this.selection.visible},isInPasteMove:function(){return this.inPasteMove},getEnabled:function(){return this.selectionEnabled},drawClipboardImage:function(e,t){var i=1;if(typeof t!="undefined"){i=t}if(this.clipboardCanvas==null||this.clipboardImageWidth==0||this.clipboardImageHeight==0){return}var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!=="grid"){return}var a=this.editor.tileSetManager.getCurrentTileSet();var s=a.getTileWidth();var o=a.getTileHeight();var l=(this.selection.minX+this.selectionOffsetX)*s;var n=(this.selection.minY+this.selectionOffsetY)*o;e.drawImage(this.clipboardCanvas,0,0,this.clipboardImageWidth,this.clipboardImageHeight,l*i,n*i,this.clipboardImageWidth*i,this.clipboardImageHeight*i)},getPasteData:function(){return this.data},clipboardToCanvas:function(){if(this.data.length==0||this.data[0].length==0){this.clipboardImageWidth=0;this.clipboardImageHeight=0;return}if(this.clipboardCanvas==null){this.clipboardCanvas=document.createElement("canvas")}var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getTileSet();var i=t.getTileCount();var r=e.getColorPalette();var a=t.getTileWidth();var s=t.getTileHeight();var o=0;var l=0;o=this.data[0].length;l=this.data.length;var n=a*o;var h=s*l;var d=false;this.clipboardImageWidth=n;this.clipboardImageHeight=h;if(this.clipboardCanvas.width<n){this.clipboardCanvas.width=n;d=true}if(this.clipboardCanvas.height<h){this.clipboardCanvas.height=h;d=true}var c=this.editor.getColorPerMode();var r=this.editor.colorPaletteManager.getCurrentColorPalette();var f=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg);if(d||this.clipboardImageData==null){this.clipboardContext=this.clipboardCanvas.getContext("2d");this.clipboardContext.clearRect(0,0,this.clipboardCanvas.width,this.clipboardCanvas.height);this.clipboardImageData=this.clipboardContext.getImageData(0,0,this.clipboardCanvas.width,this.clipboardCanvas.height)}var u=this.clipboardCanvas.width*this.clipboardCanvas.height*4;var p=3;while(p<u){this.clipboardImageData.data[p]=0;p+=4}var v={};v["imageData"]=this.clipboardImageData;if(e&&typeof e.getScreenMode!="undefined"){v["screenMode"]=e.getScreenMode();if(v["screenMode"]===TextModeEditor.Mode.INDEXED){v["transparentColorIndex"]=e.getTransparentColorIndex()}if(v["screenMode"]===TextModeEditor.Mode.C64MULTICOLOR){f=r.getHex(e.getBackgroundColor());v["backgroundColor"]=e.getBackgroundColor();v["c64Multi1Color"]=e.getC64Multi1Color();v["c64Multi2Color"]=e.getC64Multi2Color()}}for(var g=0;g<l;g++){for(var m=0;m<o;m++){v["color"]=this.data[g][m].fc;v["bgColor"]=this.data[g][m].bc;v["character"]=this.data[g][m].t;if(v["screenMode"]===TextModeEditor.Mode.C64ECM){if(e&&typeof e.getC64ECMColor!="undefined"){v["bgColor"]=e.getC64ECMColor(v["bgColor"])}}if(typeof v["character"]!="undefined"&&v["character"]!==false){if(this.editor.graphic.getHasTileFlip()){v["flipH"]=this.data[g][m].fh;v["flipV"]=this.data[g][m].fv}if(this.editor.graphic.getHasTileRotate()){v["rotZ"]=this.data[g][m].rz}v["x"]=m*a;v["y"]=g*s;v["scale"]=1;v["select"]=false;v["highlight"]=false;v["backgroundIsTransparent"]=true;t.drawCharacter(v)}}}this.clipboardContext.putImageData(this.clipboardImageData,0,0)},getSelection:function(){return this.selection},cropToSelection:function(){if(this.selection.minX==this.selection.maxX||this.selection.minY==this.selection.maxY){return}var e=this.selection.maxX-this.selection.minX;var t=this.selection.maxY-this.selection.minY;var i=-this.selection.minX;var r=-this.selection.minY;this.editor.graphic.setGridDimensions({width:e,height:t,offsetX:i,offsetY:r});this.unselectAll()},setSelection:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}this.selectionChangedAfterCopy=true;var i=t.getGridWidth();var r=t.getGridHeight();var a=true;var s={x:this.lastSelection.from.x,y:this.lastSelection.from.y,z:this.lastSelection.from.z};var o={x:this.lastSelection.to.x,y:this.lastSelection.to.y,z:this.lastSelection.to.z};var l=true;if(typeof e!="undefined"){if(typeof e.from!="undefined"){s=e.from}if(typeof e.to!="undefined"){o=e.to}if(typeof e.enabled!="undefined"){l=e.enabled}if(typeof e.saveInHistory!="undefined"){a=e.saveInHistory}}if(t.getBlockModeEnabled()){this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var n=t.getBlockWidth();var h=t.getBlockHeight();var d=0;if(s.x>o.x){d=s.x;s.x=o.x;o.x=d}if(s.y>o.y){d=o.y;o.y=s.y;s.y=d}s.x=Math.floor(s.x/n)*n;s.y=Math.floor(s.y/h)*h;var c=o.x-s.x;if(c==0){c=n-1}else if((c+1)%n!=0){c+=1;c=n-1+Math.floor(c/n)*n}o.x=s.x+c;var f=o.y-s.y;if(f==0){f=h-1}else if((f+1)%h!=0){f+=1;f=h-1+Math.floor(f/h)*h}o.y=s.y+f}if(s.x==this.lastSelection.from.x&&s.y==this.lastSelection.from.y&&s.z==this.lastSelection.from.z&&o.x==this.lastSelection.to.x&&o.y==this.lastSelection.to.y&&o.z==this.lastSelection.to.z&&l===this.selectionEnabled){return}if(a){var u={lastEnabled:this.selectionEnabled,lastFrom:{x:this.lastSelection.from.x,y:this.lastSelection.from.y,z:this.lastSelection.from.z},lastTo:{x:this.lastSelection.to.x,y:this.lastSelection.to.y,z:this.lastSelection.to.z},enabled:l,from:{x:s.x,y:s.y,z:s.z},to:{x:o.x,y:o.y,z:o.z}};this.editor.history.startEntry("selectionChange");this.editor.history.addAction("setSelection",u);this.editor.history.endEntry();this.lastSelection.from.x=s.x;this.lastSelection.from.y=s.y;this.lastSelection.from.z=s.z;this.lastSelection.to.x=o.x;this.lastSelection.to.y=o.y;this.lastSelection.to.z=o.z;this.selectionEnabled=l}this.selectionActive=true;var p=s.x;var v=s.y;var g=s.z;var m=o.x;var y=o.y;var b=o.z;if(p>m){p=m;m=s.x}if(v>y){v=y;y=s.y}if(g==b){b+=1}if(g>b){g=o.z-1;if(b-g==1){}b=s.z}else{b-=1}var C=false;if(C){if(p<0){p=0}if(p>=i){p=i-1}if(m>=i){m=i-1}if(m<0){m=0}if(v<0){v=0}if(v>=r){v=r-1}if(y>=r){y=r-1}if(y<0){y=0}}if(g<0){g=0}this.selection.minX=p;this.selection.minY=v;this.selection.minZ=g;this.selection.maxX=m+1;this.selection.maxY=y+1;this.selection.maxZ=b+1;this.selection.visible=true;if(!l){this.selection.visible=false}},recordSelectionChangeHistory:function(){this.editor.history.startEntry("selectionChange");this.editor.history.endEntry()},mouseDown:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){return}var r=i.getGridWidth();var a=i.getGridHeight();var s=e.buttons;var o=t.pageX-$("#"+e.canvas.id).offset().left;var l=t.pageY-$("#"+e.canvas.id).offset().top;this.mouseDownX=o;this.mouseDownY=l;this.selectionOffsetX=0;this.selectionOffsetY=0;var n=e.xyToCell(o,l);if(!n){this.unselectAll();this.inSelect=false;return}if(i.getBlockModeEnabled()){this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var h=i.getBlockWidth();var d=i.getBlockHeight();n.x=Math.floor(n.x/h)*h;n.y=Math.floor(n.y/d)*d;this.mouseDownOnBlock.x=n.x/h;this.mouseDownOnBlock.y=n.y/d}this.mouseDownOnCell.x=n.x;this.mouseDownOnCell.y=n.y;this.mouseDownOnCell.z=n.z;if(this.cellInSelection2d(n)&&this.selection.visible){if(s&1&&(typeof t.metaKey!="undefined"&&t.metaKey||typeof t.ctrlKey!="undefined"&&t.ctrlKey)||this.editor.tools.drawTools.tool=="move"){UI.setCursor("move");this.inDragSelectedCharacters=true;this.selectionOffsetX=0;this.selectionOffsetY=0;this.selectionDragMode="2d";this.editor.graphic.invalidateAllCells();return}else if(s&1&&this.inPasteMove){this.inDragPastedContent=true;UI.setCursor("move");return}else if(s&1){UI.setCursor("drag-selection-outline");var c=this.selection;this.inDragSelect=true;this.selectSave.minX=c.minX;this.selectSave.minY=c.minY;this.selectSave.maxX=c.maxX;this.selectSave.maxY=c.maxY;this.selectSave.minZ=c.minZ;this.selectSave.maxZ=c.maxZ;return}}this.expandFromMiddle=typeof t.shiftKey!="undefined"&&t.shiftKey;this.inSelect=true;this.setSelection({from:n,to:n,enabled:false,saveInHistory:false});if(g_newSystem){this.editor.graphic.invalidateAllCells();this.editor.gridView2d.render()}},cellInSelection2d:function(e){if(e.x>=this.selection.minX&&e.x<this.selection.maxX){if(e.y>=this.selection.minY&&e.y<this.selection.maxY){return true}}return false},inSelection:function(e,t){if(this.selection.visible==false){return true}if(e>=this.selection.minX&&e<this.selection.maxX){if(t>=this.selection.minY&&t<this.selection.maxY){return true}}return false},marqueeSelectToMouse:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!=="grid"){return}var a=r.getGridWidth();var s=r.getGridHeight();var o=0;var l=0;if(t===false||typeof t.pageX=="undefined"||typeof t.pageY=="undefined"){o=e.mousePageX-$("#"+e.canvas.id).offset().left;l=e.mousePageY-$("#"+e.canvas.id).offset().top}else{o=t.pageX-$("#"+e.canvas.id).offset().left;l=t.pageY-$("#"+e.canvas.id).offset().top}e.xyToCell(o,l);var n=e.foundCell;if(n.x<0){n.x=0}if(n.x>=a){n.x=a-1}if(n.y<0){n.y=0}if(n.y>=s){n.y=s-1}var h=this.mouseDownOnCell.x;var d=this.mouseDownOnCell.y;var c=this.mouseDownOnCell.z;var f=n.x;var u=n.y;var p=n.z;if(this.expandFromMiddle){h=Math.floor(h-(f-h));d=Math.floor(d-(u-d))}this.setSelection({from:{x:h,y:d,z:c},to:{x:f,y:u,z:p},saveInHistory:i})},mouseMove:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){return}var r=i.getGridWidth();var a=i.getGridHeight();var s=t.pageX-$("#"+e.canvas.id).offset().left;var o=t.pageY-$("#"+e.canvas.id).offset().top;e.xyToCell(s,o);var l=e.foundCell;if(l){this.lastCell.x=l.x;this.lastCell.y=l.y}if(this.inSelect){this.marqueeSelectToMouse(e,t,false)}else if(this.inDragPastedContent){UI.setCursor("move");this.selectionOffsetX=l.x-this.mouseDownOnCell.x;this.selectionOffsetY=l.y-this.mouseDownOnCell.y;if(i.getBlockModeEnabled()){var n=i.getBlockWidth();var h=i.getBlockHeight();var n=i.getBlockWidth();var h=i.getBlockHeight();l.x=Math.floor(l.x/n)*n;l.y=Math.floor(l.y/h)*h;var d={x:0,y:0};d.x=l.x/n;d.y=l.y/h;this.selectionOffsetX=(d.x-this.mouseDownOnBlock.x)*n;this.selectionOffsetY=(d.y-this.mouseDownOnBlock.y)*h}if(g_newSystem){this.editor.gridView2d.render()}else{this.editor.graphic.redraw()}}else if(this.inDragSelect){UI.setCursor("drag-selection-outline");var c=l.x-this.mouseDownOnCell.x;var f=l.y-this.mouseDownOnCell.y;if(i.getBlockModeEnabled()){var n=i.getBlockWidth();var h=i.getBlockHeight();l.x=Math.floor(l.x/n)*n;l.y=Math.floor(l.y/h)*h;var d={x:0,y:0};d.x=l.x/n;d.y=l.y/h;c=(d.x-this.mouseDownOnBlock.x)*n;f=(d.y-this.mouseDownOnBlock.y)*h}var u={x:this.selectSave.minX+c,y:this.selectSave.minY+f,z:this.selectSave.minZ};var p={x:this.selectSave.maxX+c-1,y:this.selectSave.maxY+f-1,z:this.selectSave.maxZ};this.setSelection({from:u,to:p,saveInHistory:false});this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})}else if(this.inDragSelectedCharacters){UI.setCursor("move");this.selectionOffsetX=l.x-this.mouseDownOnCell.x;this.selectionOffsetY=l.y-this.mouseDownOnCell.y;if(i.getBlockModeEnabled()){var n=i.getBlockWidth();var h=i.getBlockHeight();var n=i.getBlockWidth();var h=i.getBlockHeight();l.x=Math.floor(l.x/n)*n;l.y=Math.floor(l.y/h)*h;var d={x:0,y:0};d.x=l.x/n;d.y=l.y/h;this.selectionOffsetX=(d.x-this.mouseDownOnBlock.x)*n;this.selectionOffsetY=(d.y-this.mouseDownOnBlock.y)*h}if(g_newSystem){this.editor.graphic.invalidateAllCells();this.editor.gridView2d.render()}else{this.editor.graphic.redraw()}}else{if(this.editor.type=="2d"){this.setSelectCursor(t)}}},setSelectCursor:function(e){if(this.inDragSelectedCharacters){UI.setCursor("move");return}if(this.cellInSelection2d(this.lastCell)&&this.selection.visible){if(typeof e.ctrlKey!="undefined"&&e.ctrlKey||typeof e.metaKey!="undefined"&&e.metaKey||this.editor.tools.drawTools.tool=="move"||this.inPasteMove){UI.setCursor("move")}else{UI.setCursor("can-drag-selection-outline")}}else{UI.setCursor("box-select")}},endPasteDrag:function(){if(!this.inPasteMove){return}this.inDragPastedContent=false;this.inPasteMove=false;var e={x:this.selection.minX+this.selectionOffsetX,y:this.selection.minY+this.selectionOffsetY,z:this.selection.minZ};var t={x:this.selection.maxX+this.selectionOffsetX-1,y:this.selection.maxY+this.selectionOffsetY-1,z:this.selection.maxZ};this.setSelection({from:e,to:t,enabled:true});this.paste(this.pasteMoveArgs);this.setSelection({from:e,to:t,enabled:false});this.selectionOffsetX=0;this.selectionOffsetY=0;this.unselectAll()},end2dSelectionDrag:function(){if(this.selectionOffsetX!=0||this.selectionOffsetY!=0){this.editor.history.startEntry("Drag");this.editor.history.setNewEntryEnabled(false);this.cut();var e={x:this.selection.minX+this.selectionOffsetX,y:this.selection.minY+this.selectionOffsetY,z:this.selection.minZ};var t={x:this.selection.maxX+this.selectionOffsetX-1,y:this.selection.maxY+this.selectionOffsetY-1,z:this.selection.maxZ};this.setSelection({from:e,to:t});this.paste();this.editor.history.setNewEntryEnabled(true);this.editor.history.endEntry()}this.selectionOffsetX=0;this.selectionOffsetY=0;this.editor.graphic.redraw()},mouseUp:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){return}var r=i.getGridWidth();var a=i.getGridHeight();var s=t.pageX-$("#"+e.canvas.id).offset().left;var o=t.pageY-$("#"+e.canvas.id).offset().top;if(this.inDragSelect){e.xyToCell(s,o);var l=e.foundCell;var n=l.x-this.mouseDownOnCell.x;var h=l.y-this.mouseDownOnCell.y;if(i.getBlockModeEnabled()){var d=i.getBlockWidth();var c=i.getBlockHeight();l.x=Math.floor(l.x/d)*d;l.y=Math.floor(l.y/c)*c;var f={x:0,y:0};f.x=l.x/d;f.y=l.y/c;n=(f.x-this.mouseDownOnBlock.x)*d;h=(f.y-this.mouseDownOnBlock.y)*c}var u={x:this.selectSave.minX+n,y:this.selectSave.minY+h,z:this.selectSave.minZ};var p={x:this.selectSave.maxX+n-1,y:this.selectSave.maxY+h-1,z:this.selectSave.maxZ};this.setSelection({from:u,to:p,saveInHistory:true});if(typeof t.altKey!="undefined"&&t.altKey){UI.setCursor("can-drag")}else{UI.setCursor("can-drag-selection-outline")}this.editor.graphic.redraw({allCells:true})}if(this.inSelect){if(s==this.mouseDownX&&o==this.mouseDownY){this.unselectAll();e.xyToCell(s,o);var l=e.foundCell;this.setSelection({from:l,to:l,enabled:false,saveInHistory:false})}else{this.marqueeSelectToMouse(e,t,true)}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})}if(this.inPasteMove){this.endPasteDrag()}this.inSelect=false;this.inDragSelect=false;if(this.inDragSelectedCharacters){if(typeof t.altKey!="undefined"&&t.altKey||this.editor.tools.drawTools.tool=="move"){UI.setCursor("move")}else{UI.setCursor("can-drag-selection-outline")}this.end2dSelectionDrag();this.editor.graphic.redraw({allCells:true});this.inDragSelectedCharacters=false}this.selectionOffsetX=0;this.selectionOffsetY=0},selectAll:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getGridWidth();var i=e.getGridHeight();var r={x:0,y:0,z:0};var a={x:t-1,y:i-1,z:1};this.setSelection({from:r,to:a})},unselectAll:function(){this.setSelection({enabled:false});this.editor.graphic.redraw({allCells:true})},clear:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}var i=true;if(typeof e!="undefined"&&typeof e.history!="undefined"){i=e.history}if(i){this.editor.history.startEntry("Clear")}var r=this.selection;var e={};for(e.y=r.minY;e.y<r.maxY;e.y++){for(e.x=r.minX;e.x<r.maxX;e.x++){if(t.getBlockModeEnabled()){e.t=this.editor.tileSetManager.blankCharacter;e.bc=this.editor.colorPaletteManager.noColor;e.b=0}else{e.t=this.editor.tileSetManager.blankCharacter;e.bc=this.editor.colorPaletteManager.noColor}e.update=false;t.setCell(e)}}if(i){this.editor.history.endEntry()}this.editor.graphic.redraw()},selectionToPen:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getGridWidth();var i=e.getGridHeight();var r=this.selection;this.data=[];var a=r.maxX-r.minX;var s=r.maxY-r.minY;var o=[];var l=[];var n=0;for(var h=0;h<s;h++){o[h]=[];l[h]=[];for(var d=0;d<a;d++){if(r.minY+h>=0&&r.minY+h<i&&r.minX+d>=0&&r.minX+d<t){var c=e.getCell({x:r.minX+d,y:r.minY+h});o[h][d]=c.t;l[h][d]={};for(var f in c){if(c.hasOwnProperty(f)){l[h][d][f]=c[f]}}}}}this.editor.currentTile.setCharacters(o);this.editor.currentTile.setCells(l)},clearAll:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}var i=true;if(typeof e!="undefined"&&typeof e.history!="undefined"){i=e.history}if(i){this.editor.history.startEntry("Clear")}var r=this.selection;var e={};e.t=this.editor.tileSetManager.blankCharacter;e.bc=this.editor.colorPaletteManager.noColor;e.update=false;for(e.y=r.minY;e.y<r.maxY;e.y++){for(e.x=r.minX;e.x<r.maxX;e.x++){t.setCell(e)}}if(i){this.editor.history.endEntry()}this.editor.graphic.redraw()},cut:function(e){this.copy();this.clear(e)},copy:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getGridWidth();var i=e.getGridHeight();var r=this.selection;this.data=[];var a=r.maxX-r.minX;var s=r.maxY-r.minY;for(var o=0;o<s;o++){this.data[o]=[];for(var l=0;l<a;l++){if(r.minY+o>=0&&r.minY+o<i&&r.minX+l>=0&&r.minX+l<t){var n=e.getCell({y:r.minY+o,x:r.minX+l});this.data[o][l]={};for(var h in n){if(n.hasOwnProperty(h)){this.data[o][l][h]=n[h]}}}else{this.data[o][l]={t:this.editor.tileSetManager.blankCharacter,fc:0,ry:0,rx:0,rz:0,bc:-1,fh:0,fv:0};if(e.getBlockModeEnabled()){this.data[o][l].b=0}}}}this.clipboardToCanvas();this.selectionChangedAfterCopy=false;this.copiedFromLayer=e.getId();this.copiedFromFrame=e.getCurrentFrame()},paste:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}if(t.getId()!=this.copiedFromLayer||t.getCurrentFrame()!=this.copiedFromFrame){this.selectionChangedAfterCopy=true}if(!this.selection.visible||!this.selectionChangedAfterCopy){if(!this.selectionChangedAfterCopy){this.unselectAll()}this.editor.tools.drawTools.setDrawTool("select");var i=t.getTileSet();var r=i.getTileWidth();var a=i.getTileHeight();this.editor.gridView2d.findViewBounds();var s=this.editor.graphic.getViewBounds();var o=Math.floor(s.x/r)+2;var l=Math.floor(s.y/a)+2;this.setSelection({from:{x:o,y:l},to:{x:o+this.data[0].length-1,y:l+this.data.length-1},enabled:true});this.selectionOffsetX=0;this.selectionOffsetY=0;this.inPasteMove=true;this.pasteMoveArgs=e;this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true});UI.captureMouse(this.editor.gridView2d,true);return}this.inPasteMove=false;var n=t.getGridWidth();var h=t.getGridHeight();var i=t.getTileSet();var d=false;var c=false;var f=true;if(typeof e!="undefined"){if(typeof e.hflip!="undefined"){d=e.hflip}if(typeof e.vflip!="undefined"){c=e.vflip}if(typeof e.history!="undefined"){f=e.history}}var u=true;u=$("#pasteWhitespace").is(":checked");var p=$("#pasteOnWhitespace").is(":checked");if(f){this.editor.history.startEntry("Paste")}var v=this.selection;var g=parseInt($("#pasteRotation").val());var m=v.minX;var y=v.minY;if(typeof e!="undefined"){if(typeof e.pasteAtX!="undefined"){m=e.pasteAtX}if(typeof e.pasteAtY!="undefined"){y=e.pasteAtY}}for(var b=0;b<this.data.length;b++){for(var C=0;C<this.data[b].length;C++){var x=this.data[b][C].t;var S=this.data[b][C].fc;var P=this.data[b][C].rx;var w=this.data[b][C].ry;var I=this.data[b][C].rz;var k=this.data[b][C].bc;var M=this.data[b][C].fh;var T=this.data[b][C].fv;var D=false;if(t.getBlockModeEnabled()){D=this.data[b][C].b}if(d){var E=this.data[b].length-1-C;x=this.data[b][E].t;x=i.getFlipHChar(x);S=this.data[b][E].fc;P=this.data[b][E].rx;w=this.data[b][E].ry;I=this.data[b][E].rz;k=this.data[b][E].bc;if(t.getBlockModeEnabled()){D=this.data[b][E].b}}if(c){var _=this.data.length-1-b;x=this.data[_][C].t;x=i.getFlipVChar(x);S=this.data[_][C].color;P=this.data[_][C].rx;w=this.data[_][C].ry;I=this.data[_][C].rz;k=this.data[_][C].bc;if(t.getBlockModeEnabled()){D=this.data[_][C].b}}var B=C;var R=b;switch(g){case 90:w+=.75;B=z;pasteZ=C;break;case 180:w+=.5;B=-C;pasteZ=z;break;case 270:w+=.75;B=z;pasteZ=-C;break}while(w>=1){w-=1}while(w<0){w+=1}B+=m;R+=y;var e={};if(B>=0&&R>=0&&B<n&&R<h){var A=t.getCell({x:B,y:R});var F=A.t;if(F==this.editor.tileSetManager.blankCharacter||!p){e.t=x;e.x=B;e.y=R;e.fc=S;e.rx=P;e.ry=w;e.rz=I;e.bc=k;e.fh=M;e.fv=T;if(t.getBlockModeEnabled()){e.b=D}e.update=false;if(x!=this.editor.tileSetManager.blankCharacter||u||k!==-1){t.setCell(e)}}}}}if(f){this.editor.history.endEntry()}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})},replaceColors:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getGridWidth();var i=e.getGridHeight();this.editor.history.startEntry("Replace Colors");var r=this.selection;var a={};for(a.y=r.minY;a.y<r.maxY;a.y++){for(a.x=r.minX;a.x<r.maxX;a.x++){var s=e.getCell({x:x,y:y});if(s){a.t=s.t;a.fc=s.fc;a.update=false;if(a.fc==this.replaceColor){e.setCell(a)}}}}this.editor.history.endEntry();this.editor.graphic.redraw({allCells:this.editor.graphic.getOnlyViewBoundsDrawn()})},fill:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getGridWidth();var i=e.getGridHeight();this.editor.history.startEntry("Fill");var r=this.selection;var a=parseInt($("#pasteRotation").val());var s={};var o=this.editor.currentTile.getCharacters();if(o.length==0||o[0].length==0){return}s.fc=this.editor.currentTile.getColor();s.bc=this.editor.currentTile.getBGColor();s.rz=this.editor.currentTile.rotZ;s.fh=this.editor.currentTile.flipH;s.fv=this.editor.currentTile.flipV;var l=0;var n=r.maxY-r.minY-1;for(s.y=r.minY;s.y<r.maxY;s.y++){l=0;for(s.x=r.minX;s.x<r.maxX;s.x++){var h=l%o[0].length;var d=n%o.length;s.t=o[d][h];e.setCell(s);l++}n--}this.editor.history.endEntry()},switchColors:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=this.selection;var i=!this.isActive()||t.minX==t.maxX&&t.minY==t.maxY;if(i){this.selectAll()}this.editor.history.startEntry("Switch Colors");var r={};for(var a=t.minY;a<t.maxY;a++){for(var s=t.minX;s<t.maxX;s++){r.x=s;r.y=a;var o=e.getCell({x:s,y:a});if(o){r.t=o.t;if(o.bc!=this.editor.colorPaletteManager.noColor){r.fc=o.bc}else{r.fc=o.fc}r.bc=o.fc;r.update=false;e.setCell(r)}}}this.editor.history.endEntry();this.editor.graphic.redraw();if(i){this.unselectAll()}},invert:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=this.selection;var i=!this.isActive()||t.minX==t.maxX&&t.minY==t.maxY;if(i){this.selectAll()}this.editor.history.startEntry("Invert");var r=parseInt($("#pasteRotation").val());var a={};for(var s=t.minY;s<t.maxY;s++){for(var o=t.minX;o<t.maxX;o++){a.x=o;a.y=s;var l=e.getCell({x:o,y:s});if(l){a.t=l.t;a.fc=l.fc;a.bc=l.bc;a.update=false;if(a.t==this.editor.tileSetManager.blankCharacter){}if(a.t<128){a.t+=128}else{a.t-=128}e.setCell(a)}}}this.editor.history.endEntry();this.editor.graphic.redraw();if(i){this.unselectAll()}},flipH:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getTileSet();t.buildHFlipMap();var i=this.selection;var r=!this.isActive()||i.minX==i.maxX&&i.minY==i.maxY;if(r){this.selectAll()}var a=[];var s=i.maxX-i.minX;var o=i.maxY-i.minY;this.editor.history.startEntry("Flip H");for(var l=0;l<o;l++){a[l]=[];for(var n=0;n<s;n++){var h=e.getCell({x:i.minX+n,y:i.minY+l});if(h){a[l][n]={t:h.t,fc:h.fc,ry:h.ry,rx:h.rx,rz:h.rz,fh:h.fh,fv:h.fv,bc:h.bc};if(e.getBlockModeEnabled()){a[l][n].b=h.b}}}}var d=this.editor.graphic.getHasTileFlip();var c={};for(var l=0;l<a.length;l++){for(var n=0;n<a[l].length;n++){var f=a[l][n].rotY;c.x=n;c.y=-a.length+l;c.x=i.maxX-n-1;c.y+=i.maxY;var u=a[l][n].t;if(d){if(a[l][n].fh){c.fh=0}else{c.fh=1}}else{u=t.getHFlip(u);c.fh=a[l][n].fh}c.t=u;c.fc=a[l][n].fc;c.rx=a[l][n].rx;c.ry=a[l][n].ry;c.rz=a[l][n].rz;c.fv=a[l][n].fv;c.bc=a[l][n].bc;if(e.getBlockModeEnabled()){c.b=a[l][n].b}c.update=false;e.setCell(c)}}this.editor.history.endEntry();this.editor.graphic.redraw();if(r){this.unselectAll()}},flipV:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getTileSet();t.buildVFlipMap();var i=this.selection;var r=!this.isActive()||i.minX==i.maxX&&i.minY==i.maxY;if(r){this.selectAll()}var a=[];var s=i.maxX-i.minX;var o=i.maxY-i.minY;var l=this.editor.graphic.getHasTileFlip();this.editor.history.startEntry("Flip H");for(var n=0;n<o;n++){a[n]=[];for(var h=0;h<s;h++){var d=e.getCell({y:i.minY+n,x:i.minX+h});a[n][h]={t:d.t,fc:d.fc,ry:d.ry,rx:d.rx,rz:d.rz,fh:d.fh,fv:d.fv,bc:d.bc};if(e.getBlockModeEnabled()){a[n][h].b=d.b}}}var c={};for(var n=0;n<a.length;n++){for(var h=0;h<a[n].length;h++){var f=a[n][h].rotY;c.x=h;c.y=n;c.x+=i.minX;c.y=i.maxY-n-1;var u=a[n][h].t;if(l){if(a[n][h].fv){c.fv=0}else{c.fv=1}}else{u=t.getVFlip(u);c.fv=a[n][h].fv}c.t=u;c.fc=a[n][h].fc;c.rx=a[n][h].rx;c.ry=a[n][h].ry;c.rz=a[n][h].rz;c.bc=a[n][h].bc;c.fh=a[n][h].fh;if(e.getBlockModeEnabled()){c.b=a[n][h].b}c.update=false;e.setCell(c)}}this.editor.history.endEntry();this.editor.graphic.redraw();if(r){this.unselectAll()}},rotateSelection:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!=="grid"){return}var a=this.selection;var s=true;var o=!this.isActive||a.minX==a.maxX&&a.minY==a.maxY;if(o){this.selectAll()}var l={x:0,y:0,z:0};var n={x:0,y:0,z:0};l.x=a.minX;l.y=a.minY;n.x=a.maxX;n.y=a.maxY;var h=[];for(var d=l.y;d<n.y;d++){h.push([]);for(var c=l.x;c<n.x;c++){h[d-l.y].push({})}}if(r.getBlockModeEnabled()){this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var f=this.editor.frames.getBlockWidth();var u=this.editor.frames.getBlockHeight();if(e>0){e=Math.ceil(e/f)*f}else{e=Math.floor(e/u)*u}if(t>0){t=Math.ceil(t/u)*u}else{t=Math.floor(t/u)*u}}for(var d=l.y;d<n.y;d++){h.push([]);for(var c=l.x;c<n.x;c++){var p=c;var v=d;var g=l.z;var m=c+e;var y=d+t;var b=l.z+i;if(m<a.minX){m=a.maxX+(m-a.minX)}if(y<a.minY){y=a.maxY+(y-a.minY)}if(m>=a.maxX){m=a.minX+(m-a.maxX)}if(y>=a.maxY){y=a.minY+(y-a.maxY)}var C=r.getCell({x:p,y:v});var x=m-a.minX;var S=y-a.minY;if(C){h[S][x]={t:C.t,fc:C.fc,ry:C.ry,rx:C.rx,rz:C.rz,fh:C.fh,fv:C.fv,bc:C.bc};if(this.editor.frames.getBlockModeEnabled()){h[S][x].b=C.b}}else{h[S][x].t=this.editor.tileSetManager.blankCharacter}}}if(s){this.editor.history.startEntry("Paste")}for(var d=l.y;d<n.y;d++){for(var c=l.x;c<n.x;c++){var P=h[d-l.y][c-l.x];P.x=c;P.y=d;P.z=l.z;P.update=false;r.setCell(P)}}this.editor.graphic.redraw();if(s){this.editor.history.endEntry()}if(o){this.unselectAll()}},nudgeSelection:function(e,t,i,r){var a=this.editor.layers.getSelectedLayerObject();if(!a||a.getType()!=="grid"){return}if(a.getBlockModeEnabled()){this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var s=a.getBlockWidth();var o=a.getBlockHeight();e*=s;t*=o}var l=false;var n=false;var h=this.selection;var d=!this.isActive()||h.minX==h.maxX&&h.minY==h.maxY;if(d){this.selectAll()}if(typeof r!="undefined"){if(typeof r.moveCopy!="undefined"){n=r.moveCopy}if(typeof r.moveCut!="undefined"){l=r.moveCut}}var c={x:0,y:0,z:0};var f={x:0,y:0,z:0};c.x=h.minX+e;c.y=h.minY+t;f.x=h.maxX+e-1;f.y=h.maxY+t-1;if(l||n){this.editor.history.startEntry("nudgeSelection");this.editor.history.setNewEntryEnabled(false);if(l){this.cut()}if(n){this.copy()}this.setSelection({from:c,to:f,saveInHistory:true});var r={};this.paste(r);this.editor.history.setNewEntryEnabled(true);this.editor.history.endEntry();if(n){this.editor.graphic.invalidateAllCells()}}else{this.setSelection({from:c,to:f,saveInHistory:true});this.editor.graphic.redraw({allCells:true})}if(d){this.unselectAll()}}};var Select3d=function(){this.selectionMesh=null;this.selectionDragControls=null;this.selectionDragArrows=null;this.selectionDragMode="";this.selectionOffsetX=0;this.selectionOffsetY=0;this.clipboardData=[];this.enabled=true};Select3d.prototype={init:function(e){this.editor=e;this.raycaster=new THREE.Raycaster;this.mouse=new THREE.Vector2},createMesh:function(){var e=this.editor.grid3d;var t=e.scene;var i=new THREE.BoxGeometry(1,1,1);var r=new THREE.MeshPhongMaterial({color:16777215,specular:0,shininess:0,transparent:true,opacity:.3});r.flatShading=true;this.selectionMesh=new THREE.Mesh(i,r);this.selectionMesh.frustumCulled=false;this.selectionMesh.visible=false;t.add(this.selectionMesh);this.setupSelectionDragControls()},setupSelectionDragControls:function(){var e=this.editor.grid3d;var t=e.scene;this.selectionDragArrows=[];this.selectionDragControls=new THREE.Object3D;this.selectionDragControls.position.x=20;this.selectionDragControls.position.y=20;this.selectionDragControls.position.z=30;t.add(this.selectionDragControls);var i=new THREE.CylinderGeometry(0,.8,2,4,1);var r=new THREE.MeshPhongMaterial({color:16711680,specular:0,shininess:0,transparent:false,opacity:.6});r.flatShading=true;this.dragUpControl=new THREE.Mesh(i,r);this.dragUpControl.position.y=5;this.dragUpControl.dragType="dragUp";this.selectionDragArrows.push(this.dragUpControl);var a=new THREE.CylinderGeometry(.2,.2,5,3,1);var s=new THREE.Mesh(a,r);s.position.y=2.5;this.selectionDragControls.add(s);this.selectionDragControls.add(this.dragUpControl);var o=new THREE.CylinderGeometry(0,.8,2,4,1);var r=new THREE.MeshPhongMaterial({color:65280,specular:0,shininess:0,transparent:false,opacity:.6});r.flatShading=true;this.dragRightControl=new THREE.Mesh(i,r);this.dragRightControl.rotation.z=-Math.PI/2;this.dragRightControl.position.x=5;this.dragRightControl.dragType="dragRight";this.selectionDragArrows.push(this.dragRightControl);this.selectionDragControls.add(this.dragRightControl);var l=new THREE.CylinderGeometry(.2,.2,5,3,1);var n=new THREE.Mesh(l,r);n.position.x=2.5;n.rotation.z=-Math.PI/2;this.selectionDragControls.add(n);var h=new THREE.CylinderGeometry(0,.8,2,4,1);var r=new THREE.MeshPhongMaterial({color:255,specular:0,shininess:0,transparent:false,opacity:.6});r.flatShading=true;this.dragForwardControl=new THREE.Mesh(h,r);this.dragForwardControl.rotation.x=Math.PI/2;this.dragForwardControl.position.z=5;this.dragForwardControl.dragType="dragForward";this.selectionDragArrows.push(this.dragForwardControl);this.selectionDragControls.add(this.dragForwardControl);var d=new THREE.CylinderGeometry(.2,.2,5,3,1);var c=new THREE.Mesh(d,r);c.position.z=2.5;c.rotation.x=Math.PI/2;this.selectionDragControls.add(c);this.selectionDragControls.visible=false},setSelectionFromInput:function(){var e=new THREE.Vector3;var t=new THREE.Vector3;e.x=parseInt($("#selectX1").val());e.y=parseInt($("#selectY1").val());e.z=parseInt($("#selectZ1").val());if(isNaN(e.x)||isNaN(e.y)||isNaN(e.z)){return}t.x=parseInt($("#selectX2").val());t.y=parseInt($("#selectY2").val());t.z=parseInt($("#selectZ2").val());if(isNaN(t.x)||isNaN(t.y)||isNaN(t.z)){return}if(t.z>e.z){t.z++}if(e.z>t.z){e.z++}this.setSelection(e,t,false)},nudgeSelection:function(e,t,i){var r=new THREE.Vector3;var a=new THREE.Vector3;r.x=this.selectionMesh.minX+e;r.y=this.selectionMesh.minY+t;r.z=this.selectionMesh.minZ+i;a.x=this.selectionMesh.maxX+e-1;a.y=this.selectionMesh.maxY+t-1;a.z=this.selectionMesh.maxZ+i;this.setSelection(r,a)},selectAll:function(){var e={x:0,y:0,z:0};var t={x:this.width,y:this.height,z:this.depth};if(this.editor.layoutType=="2d"){e.z=this.xyPosition;t.z=this.xyPosition+1}this.setSelection(e,t,true)},unselectAll:function(){var e={x:0,y:0,z:0};var t={x:0,y:0,z:0};this.setSelection(e,t,true);this.enabled=false;this.selectionMesh.visible=false;this.selectionDragControls.visible=false},startSelection:function(e,t,i){console.log("start selection: "+e+","+t+","+i);if(!this.selectionMesh){this.createMesh()}this.setSelection({x:e,y:t,z:i},{x:e,y:t,z:i});this.selectionStartX=e;this.selectionStartY=t;this.selectionStartZ=i},selectionTo:function(e,t,i){this.setSelection({x:this.selectionStartX,y:this.selectionStartY,z:this.selectionStartZ},{x:e,y:t,z:i})},setSelection:function(e,t,i){var r=this.editor.grid3d;var a=e.x;var s=e.y;var o=e.z;var l=t.x;var n=t.y;var h=t.z;if(a>l){a=l;l=e.x}if(s>n){s=n;n=e.y}if(o==h){h+=1}if(o>h){o=t.z-1;if(h-o==1){}h=e.z}else{h-=1}if(a<0){a=0}if(a>=this.width){a=this.width-1}if(l>=this.width){l=this.width-1}if(l<0){l=0}if(s<0){s=0}if(s>=this.height){s=this.height-1}if(n>=this.height){n=this.height-1}if(n<0){n=0}if(o<0){o=0}if(o>=this.depth){o=this.depth-1}if(h<0){h=0}if(h>=this.depth){h=this.depth-1}this.selectionMesh.minX=a;this.selectionMesh.minY=s;this.selectionMesh.minZ=o;this.selectionMesh.maxX=l+1;this.selectionMesh.maxY=n+1;this.selectionMesh.maxZ=h+1;var d=.1;n+=1;l+=1;h+=1;var c=n;a*=r.getCellSizeX();s*=r.getCellSizeY();o*=r.getCellSizeZ();l*=r.getCellSizeX();n*=r.getCellSizeY();h*=r.getCellSizeZ();a-=d;s-=d;o-=d;l+=d;n+=d;h+=d;var f=this.selectionMesh.geometry;var u=this.selectionMesh;f.vertices[0].x=l;f.vertices[0].y=n;f.vertices[0].z=h;f.vertices[1].x=l;f.vertices[1].y=n;f.vertices[1].z=o;f.vertices[2].x=l;f.vertices[2].y=s;f.vertices[2].z=h;f.vertices[3].x=l;f.vertices[3].y=s;f.vertices[3].z=o;f.vertices[4].x=a;f.vertices[4].y=n;f.vertices[4].z=o;f.vertices[5].x=a;f.vertices[5].y=n;f.vertices[5].z=h;f.vertices[6].x=a;f.vertices[6].y=s;f.vertices[6].z=o;f.vertices[7].x=a;f.vertices[7].y=s;f.vertices[7].z=h;f.verticesNeedUpdate=true;if(typeof i=="undefined"||i==true){$("#selectX1").val(u.minX);$("#selectY1").val(u.minY);$("#selectZ1").val(u.minZ);$("#selectX2").val(u.maxX-1);$("#selectY2").val(u.maxY-1);$("#selectZ2").val(u.maxZ-1)}u.position.x=0;u.position.y=0;u.position.z=0;if(this.editor.mode!=="type"){this.selectionDragControls.visible=true}else{this.selectionDragControls.visible=false}this.selectionDragControls.position.x=(a+l)/2;this.selectionDragControls.position.y=(s+n)/2;this.selectionDragControls.position.z=h;this.selectionDragControls.originalPosition={};this.selectionDragControls.originalPosition.x=this.selectionDragControls.position.x;this.selectionDragControls.originalPosition.y=this.selectionDragControls.position.y;this.selectionDragControls.originalPosition.z=this.selectionDragControls.position.z;this.enabled=true;this.selectionMesh.visible=true;this.selectionDragControls.visible=true},offsetSelectionBy:function(e,t,i){console.log("offset selectin by "+t);var r=this.editor.grid3d;var a=r.getCellSizeX();var s=r.getCellSizeY();var o=r.getCellSizeZ();var l=this.selectionMesh;l.position.x=e*a;l.position.y=t*s;l.position.z=i*o;l.offsetX=e;l.offsetY=t;l.offsetZ=i;this.selectionDragControls.position.x=this.selectionDragControls.originalPosition.x+e*a;this.selectionDragControls.position.y=this.selectionDragControls.originalPosition.y+t*s;this.selectionDragControls.position.z=this.selectionDragControls.originalPosition.z+i*o;var n=l.maxX-l.minX;var h=l.maxZ-l.minZ;var d=l.maxY-l.minY;for(var c=0;c<h;c++){for(var f=0;f<d;f++){for(var u=0;u<n;u++){var p=r.getCell(l.minX+u,l.minY+f,l.minZ+c);if(p&&p.t>=0){var v=r.getCellMesh(l.minX+u,l.minY+f,l.minZ+c);v.position.x=v.originalPosition.x+e*a;v.position.y=v.originalPosition.y+t*s;v.position.z=v.originalPosition.z+i*o}}}}},mouseDown:function(e,t,i){if(!this.selectionDragControls){return false}this.mouseDownX=e;this.mouseDownY=t;var r=this.editor.grid3d;t=i.height-t;var r=this.editor.grid3d;this.mouse.x=e/i.width*2-1;this.mouse.y=t/i.height*2-1;this.raycaster.setFromCamera(this.mouse,i.camera);this.dragUpControl.scale.x=1;this.dragUpControl.scale.y=1;this.dragUpControl.scale.z=1;this.dragRightControl.scale.x=1;this.dragRightControl.scale.y=1;this.dragRightControl.scale.z=1;var a=Array();a=this.raycaster.intersectObjects(this.selectionDragArrows);if(a.length>0){var s=a[0].object;s.scale.x=1.2;s.scale.y=1.2;s.scale.z=1.2;this.dragArrowsMouseDownX=e;this.dragArrowsMouseDownY=t;this.selectionDragMode=s.dragType;if(s.dragType=="dragRight"||s.dragType=="dragUp"){var o=this.selectionDragControls.position.z;var l=this.raycaster.ray;var n=(o-l.origin.z)/l.direction.z;var e=l.origin.x+l.direction.x*n;var t=l.origin.y+l.direction.y*n;this.dragArrowsMouseDownX=e;this.dragArrowsMouseDownY=t;this.selectPositionX=this.selectionMesh.position.x;this.selectPositionY=this.selectionMesh.position.y}if(s.dragType=="dragForward"){var h=this.selectionDragControls.position.y;var l=this.raycaster.ray;var n=(h-l.origin.y)/l.direction.y;var d=l.origin.z+l.direction.z*n;var e=l.origin.x+l.direction.x*n;this.dragArrowsMouseDownZ=d;this.dragArrowsMouseDownX=e;this.selectPositionZ=this.selectionMesh.position.z;this.selectPositionX=this.selectionMesh.position.x}return true}this.selectionDragMode="";return false},mouseMove:function(e,t,i){if(!this.selectionDragControls){return}t=i.height-t;var r=this.editor.grid3d;this.mouse.x=e/i.width*2-1;this.mouse.y=t/i.height*2-1;if(this.selectionDragMode!=""){if(this.selectionDragMode=="dragUp"){this.raycaster.setFromCamera(this.mouse,i.camera);var a=this.selectionDragControls.position.z;var s=this.raycaster.ray;var o=(a-s.origin.z)/s.direction.z;var e=s.origin.x+s.direction.x*o;var t=s.origin.y+s.direction.y*o;var l=Math.floor(t/r.getCellSizeY())-Math.floor(this.dragArrowsMouseDownY/r.getCellSizeY());this.offsetSelectionBy(0,l,0);return true}if(this.selectionDragMode=="dragRight"){this.raycaster.setFromCamera(this.mouse,i.camera);var a=this.selectionDragControls.position.z;var s=this.raycaster.ray;var o=(a-s.origin.z)/s.direction.z;var e=s.origin.x+s.direction.x*o;var t=s.origin.y+s.direction.y*o;var n=Math.floor(e/r.getCellSizeX())-Math.floor(this.dragArrowsMouseDownX/r.getCellSizeX());this.offsetSelectionBy(n,0,0);return true}if(this.selectionDragMode=="dragForward"){this.raycaster.setFromCamera(this.mouse,i.camera);var h=this.selectionDragControls.position.y;var s=this.raycaster.ray;var o=(h-s.origin.y)/s.direction.y;var d=s.origin.z+s.direction.z*o;var e=s.origin.x+s.direction.x*o;var c=Math.floor(d/r.getCellSizeZ())-Math.floor(this.dragArrowsMouseDownZ/r.getCellSizeZ());this.offsetSelectionBy(0,0,c);return true}}this.raycaster.setFromCamera(this.mouse,i.camera);this.dragUpControl.scale.x=1;this.dragUpControl.scale.y=1;this.dragUpControl.scale.z=1;this.dragRightControl.scale.x=1;this.dragRightControl.scale.y=1;this.dragRightControl.scale.z=1;this.dragForwardControl.scale.x=1;this.dragForwardControl.scale.y=1;this.dragForwardControl.scale.z=1;var f=Array();f=this.raycaster.intersectObjects(this.selectionDragArrows);if(f.length>0){var u=f[0].object;u.scale.x=1.2;u.scale.y=1.2;u.scale.z=1.2;this.selectionDragMode=u.dragType+"Over"}return false},mouseUp:function(e,t,i){if(!this.selectionDragControls){return}if(e==this.mouseDownX&&t==this.mouseDownY){this.unselectAll()}t=i.height-t;var r=this.editor.grid3d;this.mouse.x=e/i.width*2-1;this.mouse.y=t/i.height*2-1;this.raycaster.setFromCamera(this.mouse,i.camera);if(this.selectionDragMode=="dragRight"||this.selectionDragMode=="dragUp"||this.selectionDragMode=="dragForward"){var a=this.selectionMesh.offsetX;var s=this.selectionMesh.offsetY;var o=this.selectionMesh.offsetZ;if(a!=0||s!=0||o!=0){this.offsetSelectionBy(0,0,0);this.cut();this.nudgeSelection(a,s,o);this.paste()}}this.selectionDragMode="";return},clear:function(){var e=this.editor.tileSetManager.noTile;var t=this.editor.grid3d;this.editor.history.startEntry("Clear");var i=this.selectionMesh;for(var r=i.minZ;r<i.maxZ;r++){for(var a=i.minY;a<i.maxY;a++){for(var s=i.minX;s<i.maxX;s++){t.setCell({x:s,y:a,z:r,t:e})}}}this.editor.history.endEntry()},cut:function(){this.copy();this.clear()},copy:function(){var e=this.editor.tileSetManager.noTile;var t=this.selectionMesh;var i=this.editor.grid3d;var r=i.getGridWidth();var a=i.getGridHeight();var s=i.getGridDepth();this.clipboardData=[];var o=t.maxX-t.minX;var l=t.maxZ-t.minZ;var n=t.maxY-t.minY;for(var h=0;h<l;h++){this.clipboardData[h]=[];for(var d=0;d<n;d++){this.clipboardData[h][d]=[];for(var c=0;c<o;c++){if(t.minZ+h>=0&&t.minZ+h<s&&t.minY+d>=0&&t.minY+d<a&&t.minX+c>=0&&t.minX+c<r){var f=i.getCell(t.minX+c,t.minY+d,t.minZ+h);this.clipboardData[h][d][c]={t:f.t,fc:f.fc,bc:f.bc,rx:f.rx,ry:f.ry,rz:f.rz}}else{this.clipboardData[h][d][c]={t:e,fc:0,bc:0,rx:0,ry:0,rz:0}}}}}},paste:function(e){if(typeof e=="undefined"){e={}}var t=this.editor.tileSetManager.noTile;var i=this.editor.grid3d;var r=i.getGridWidth();var a=i.getGridHeight();var s=i.getGridDepth();var o=true;var l=false;this.editor.history.startEntry("Paste");var n=this.selectionMesh;var h=false;var d=this.clipboardData;console.log(d);for(var c=0;c<d.length;c++){for(var f=0;f<d[c].length;f++){for(var u=0;u<d[c][f].length;u++){var p=d[c][f][u].t;var v=d[c][f][u].fc;var g=d[c][f][u].bc;var m=d[c][f][u].rx;var y=d[c][f][u].ry;var b=d[c][f][u].rz;var C=u;var x=f-d[c].length;var S=c;C+=n.minX;x+=n.maxY;S+=n.minZ;if(C>=0&&x>=0&&S>=0&&C<r&&x<a&&S<s){var P=i.getCell(C,x,S);if(P.t==t||!l){if(p!=t||o){i.setCell({x:C,y:x,z:S,t:p,fc:v,bc:g,rx:m,ry:y,rz:b})}}}}}}this.editor.history.endEntry()}};var PixelSelect=function(){this.editor=null;this.active=false;this.selection={minX:0,minY:0,maxX:0,maxY:0};this.selectSave={minX:0,maxX:0,minY:0,maxY:0};this.mouseDownOnPixel={x:0,y:0};this.selectionOffsetX=0;this.selectionOffsetY=0;this.copyAtX=false;this.copyAtY=false;this.pasteOffsetX=0;this.pasteOffsetY=0;this.lastSelection={from:{x:0,y:0},to:{x:0,y:0}};this.inDragSelectedPixels=false;this.canvas=null;this.inPasteMove=false;this.inDragPaste=false;this.data=[];this.nudgeData=false};PixelSelect.prototype={init:function(e){this.editor=e},setActive:function(e){this.active=e},isActive:function(){if(this.editor.getEditorMode()!="pixel"){return false}return this.active},isInPasteMove:function(){if(this.editor.getEditorMode()!="pixel"){return false}return this.inPasteMove},getSelection:function(){return this.selection},getPasteWidth:function(){if(this.data.length==0){return 0}return this.data[0].length},getPasteHeight:function(){return this.data.length},drawPastedPixels:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getWidth();var i=e.getHeight();var r=this.editor.currentTile.getColor();var a={canvas:this.canvas,colorIndex:r,pixelData:this.data};e.drawPixels(a)},drawSelection:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getWidth();var i=e.getHeight();var r=e.getCellWidth();var a=e.getCellHeight();if(this.canvas==null){this.canvas=document.createElement("canvas")}this.canvas.width=t;this.canvas.height=i;var s=Math.floor(this.selection.minX/r);var o=this.selection.minY;if(o<0){o=0}var l=Math.floor(o/a);var n=Math.ceil(this.selection.maxX/r)+1;var h=Math.ceil(this.selection.maxY/a)+1;if(n>t){n=t}if(h>i){h=i}if(s<0){s=0}if(l<0){l=0}if(n<0){n=0}h=i/a;var d={draw:"pixelselection",canvas:this.canvas,fromX:s,fromY:l,toX:n,toY:h};e.draw(d)},setSelection:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}var i=true;var r=t.getGridWidth();var a=t.getGridHeight();var s=t.getCellWidth();var o=t.getCellHeight();var l=r*s;var n=a*o;var h=true;var d={x:this.lastSelection.from.x,y:this.lastSelection.from.y};var c={x:this.lastSelection.to.x,y:this.lastSelection.to.y};var f=true;if(typeof e!="undefined"){if(typeof e.from!="undefined"){d=e.from}if(typeof e.to!="undefined"){c=e.to}if(typeof e.enabled!="undefined"){f=e.enabled}if(typeof e.saveInHistory!="undefined"){h=e.saveInHistory}if(typeof e.resetNudgeData!="undefined"){i=e.resetNudgeData}}if(i){this.nudgeData=false}if(d.x==this.lastSelection.from.x&&d.y==this.lastSelection.from.y&&c.x==this.lastSelection.to.x&&c.y==this.lastSelection.to.y&&f===this.selectionEnabled){return}if(h){var u={lastEnabled:this.selectionEnabled,lastFrom:{x:this.lastSelection.from.x,y:this.lastSelection.from.y},lastTo:{x:this.lastSelection.to.x,y:this.lastSelection.to.y},enabled:f,from:{x:d.x,y:d.y},to:{x:c.x,y:c.y}};this.editor.history.startEntry("pixelSelectionChange");this.editor.history.addAction("pixelSetSelection",u);this.editor.history.endEntry();this.lastSelection.from.x=d.x;this.lastSelection.from.y=d.y;this.lastSelection.to.x=c.x;this.lastSelection.to.y=c.y;this.selectionEnabled=f}this.selectionActive=true;var p=d.x;var v=d.y;var g=c.x;var m=c.y;if(p>g){p=g;g=d.x}if(v>m){v=m;m=d.y}this.selection.minX=p;this.selection.minY=v;this.selection.maxX=g+1;this.selection.maxY=m+1;if(t.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){if(this.selection.minX%2){this.selection.minX-=1}if(this.selection.maxX%2){this.selection.maxX+=1}}this.active=true;if(!f){this.active=false}},recordSelectionChangeHistory:function(){this.editor.history.startEntry("pixelSelectionChange");this.editor.history.endEntry()},selectAll:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}var t=e.getWidth();var i=e.getHeight();this.setSelection({from:{x:0,y:0},to:{x:t-1,y:i-1}})},unselectAll:function(){this.setSelection({enabled:false});this.editor.graphic.redraw({allCells:true})},mouseDown:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){return}var r=i.getWidth();var a=i.getHeight();var s=e.buttons;var o=t.pageX-$("#"+e.canvas.id).offset().left;var l=t.pageY-$("#"+e.canvas.id).offset().top;this.mouseDownX=o;this.mouseDownY=l;this.selectionOffsetX=0;this.selectionOffsetY=0;var n=e.xyToPixel(o,l);if(i.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){n.x=Math.floor(n.x/2)*2}if(n.x<0||n.y<0||n.x>=r||n.y>=a){this.unselectAll();this.inSelect=false;this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true});return}this.mouseDownOnPixel.x=n.x;this.mouseDownOnPixel.y=n.y;if(this.inPasteMove){this.inDragPaste=true;return}if(this.pixelInSelection(n)&&this.isActive()){if(s&1&&(typeof t.metaKey!="undefined"&&t.metaKey||typeof t.ctrlKey!="undefined"&&t.ctrlKey)||this.editor.tools.drawTools.tool=="pixelmove"){UI.setCursor("move");this.inDragSelectedPixels=true;this.selectionOffsetX=0;this.selectionOffsetY=0;this.selectionDragMode="2d";this.editor.graphic.invalidateAllCells();return}else if(s&1){UI.setCursor("drag-selection-outline");var h=this.selection;this.inDragSelect=true;this.selectSave.minX=h.minX;this.selectSave.minY=h.minY;this.selectSave.maxX=h.maxX;this.selectSave.maxY=h.maxY;return}}this.expandFromMiddle=typeof t.shiftKey!="undefined"&&t.shiftKey;this.inSelect=true;this.setSelection({from:n,to:n,enabled:false,saveInHistory:false});this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})},pixelInSelection:function(e){if(e.x>=this.selection.minX&&e.x<this.selection.maxX){if(e.y>=this.selection.minY&&e.y<this.selection.maxY){return true}}return false},marqueeSelectToMouse:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!=="grid"){return}var a=r.getWidth();var s=r.getHeight();var o=0;var l=0;if(t===false||typeof t.pageX=="undefined"||typeof t.pageY=="undefined"){o=e.mousePageX-$("#"+e.canvas.id).offset().left;l=e.mousePageY-$("#"+e.canvas.id).offset().top}else{o=t.pageX-$("#"+e.canvas.id).offset().left;l=t.pageY-$("#"+e.canvas.id).offset().top}var n=e.xyToPixel(o,l);if(r.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){}if(n.x<0){n.x=0}if(n.x>=a){n.x=a-1}if(n.y<0){n.y=0}if(n.y>=s){n.y=s-1}var h=this.mouseDownOnPixel.x;var d=this.mouseDownOnPixel.y;var c=n.x;var f=n.y;if(this.expandFromMiddle){h=Math.floor(h-(c-h));d=Math.floor(d-(f-d))}this.setSelection({from:{x:h,y:d},to:{x:c,y:f},saveInHistory:i})},mouseMove:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){return}var r=i.getWidth();var a=i.getHeight();var s=t.pageX-$("#"+e.canvas.id).offset().left;var o=t.pageY-$("#"+e.canvas.id).offset().top;var l=e.xyToPixel(s,o);if(i.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){l.x=Math.floor(l.x/2)*2}if(this.inDragPaste){UI.setCursor("move");this.pasteOffsetX=l.x-this.mouseDownOnPixel.x;this.pasteOffsetY=l.y-this.mouseDownOnPixel.y;this.editor.graphic.redraw()}else if(this.inPasteMove){UI.setCursor("move")}else if(this.inSelect){this.marqueeSelectToMouse(e,t,false)}else if(this.inDragSelect){UI.setCursor("drag-selection-outline");var n=l.x-this.mouseDownOnPixel.x;var h=l.y-this.mouseDownOnPixel.y;var d={x:this.selectSave.minX+n,y:this.selectSave.minY+h};var c={x:this.selectSave.maxX+n-1,y:this.selectSave.maxY+h-1};this.setSelection({from:d,to:c,saveInHistory:false});this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})}else if(this.inDragSelectedPixels){UI.setCursor("move");this.selectionOffsetX=l.x-this.mouseDownOnPixel.x;this.selectionOffsetY=l.y-this.mouseDownOnPixel.y;this.editor.graphic.redraw()}else{if(this.pixelInSelection(l)&&this.isActive()){if(typeof t.metaKey!="undefined"&&t.metaKey||typeof t.ctrlKey!="undefined"&&t.ctrlKey||this.editor.tools.drawTools.tool=="pixelmove"){UI.setCursor("move")}else{UI.setCursor("can-drag-selection-outline")}}else{UI.setCursor("box-select")}}},mouseUp:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){return}var r=i.getWidth();var a=i.getHeight();var s=t.pageX-$("#"+e.canvas.id).offset().left;var o=t.pageY-$("#"+e.canvas.id).offset().top;if(this.inDragSelect){var l=e.xyToPixel(s,o);if(i.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){l.x=Math.floor(l.x/2)*2}var n=l.x-this.mouseDownOnPixel.x;var h=l.y-this.mouseDownOnPixel.y;var d={x:this.selectSave.minX+n,y:this.selectSave.minY+h};var c={x:this.selectSave.maxX+n-1,y:this.selectSave.maxY+h-1};this.setSelection({from:d,to:c,saveInHistory:true});if(typeof t.altKey!="undefined"&&t.altKey){UI.setCursor("can-drag")}else{UI.setCursor("can-drag-selection-outline")}}if(this.inSelect){if(s==this.mouseDownX&&o==this.mouseDownY){this.unselectAll();e.xyToCell(s,o);var f=e.foundCell;this.setSelection({from:f,to:f,enabled:false,saveInHistory:false})}else{this.marqueeSelectToMouse(e,t,true)}this.selectionOffsetX=0;this.selectionOffsetY=0;this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})}if(this.inPasteMove){this.endPasteDrag()}this.inPasteMove=false;this.inSelect=false;this.inDragSelect=false;if(this.inDragSelectedPixels){if(typeof t.altKey!="undefined"&&t.altKey||this.editor.tools.drawTools.tool=="move"){UI.setCursor("move")}else{UI.setCursor("can-drag-selection-outline")}this.endSelectionDrag();this.inDragSelectedPixels=false}},endPasteDrag:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){return}this.inDragPaste=false;this.inPasteMove=false;this.paste({allowMove:false,pasteAtX:this.pasteOffsetX,pasteAtY:this.pasteOffsetY})},endSelectionDrag:function(){if(this.selectionOffsetX!=0||this.selectionOffsetY!=0){this.editor.history.startEntry("PixelDrag");this.editor.history.setNewEntryEnabled(false);this.cut();var e={x:this.selection.minX+this.selectionOffsetX,y:this.selection.minY+this.selectionOffsetY};var t={x:this.selection.maxX+this.selectionOffsetX-1,y:this.selection.maxY+this.selectionOffsetY-1};this.setSelection({from:e,to:t});this.selectionOffsetX=0;this.selectionOffsetY=0;this.paste({allowMove:false});this.editor.history.setNewEntryEnabled(true);this.editor.history.endEntry()}this.selectionOffsetX=0;this.selectionOffsetY=0},clear:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}if(this.inPasteMove){this.endPasteDrag()}var i=t.getCellWidth();var r=t.getCellHeight();var a=t.getWidth();var s=t.getHeight();var o=t.getTileSet();var l=true;if(typeof e!="undefined"&&typeof e.history!="undefined"){l=e.history}if(l){this.editor.history.startEntry("PixelClear")}var n=this.selection;var h=[];for(var d=n.minY;d<n.maxY;d++){for(var c=n.minX;c<n.maxX;c++){if(d<s){var f=Math.floor(c/i);var u=Math.floor(d/r);var p=c%i;var v=d%r;var g=t.getTile({x:f,y:u});if(g!==false){o.setPixel(g,p,v,0,false);if(h.indexOf(g)===-1){h.push(g)}}}}}if(this.editor.tileEditor.visible){this.editor.tileEditor.draw()}if(l){this.editor.history.endEntry()}for(var m=0;m<h;m++){o.updateCharacter(h[m])}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw()},cut:function(e){if(this.inPasteMove){this.endPasteDrag()}this.copy(e);this.clear(e)},copy:function(e){if(this.inPasteMove){this.endPasteDrag()}var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}var i=false;if(typeof e!="undefined"){if(typeof e.useNudgeData!="undefined"){i=e.useNudgeData}}var r=t.getWidth();var a=t.getHeight();var s=t.getCellWidth();var o=t.getCellHeight();var l=t.getTileSet();var n=this.selection;var h=[];this.copyAtX=n.minX;this.copyAtY=n.minY;var d=n.maxX-n.minX;var c=n.maxY-n.minY;for(var f=0;f<c;f++){h[f]=[];for(var u=0;u<d;u++){if(n.minY+f>=0&&n.minY+f<a&&n.minX+u>=0&&n.minX+u<r){var p=n.minX+u;var v=n.minY+f;var g=Math.floor(p/s);var m=Math.floor(v/o);var y=p%s;var b=v%o;var C=t.getTile({x:g,y:m});if(C!==false){h[f][u]=l.getPixel(C,y,b,0)}}else{h[f][u]=0}}}if(i){this.nudgeData=h}else{this.data=h}},pasteAsMovable:function(){this.pasteOffsetY=0;this.pasteOffsetX=0;this.unselectAll();this.inPasteMove=true;this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw()},paste:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){return}if(!this.inPasteMove){var i=this.selection;var r=[];var a=i.maxX-i.minX;var s=i.maxY-i.minY;if(this.data.length>0&&this.data.length==s&&this.data[0].length==a){if(i.minX!==this.copyAtX&&this.selection.minY!==this.copyAtY){this.inPasteMove=false;this.inDragPaste=false;if(typeof e=="undefined"){e={}}e.allowMove=false;e.pasteAtX=i.minX;e.pasteAtY=i.minY}}}if(this.inPasteMove){this.endPasteDrag()}var o=false;var l=t.getWidth();var n=t.getHeight();var h=t.getCellWidth();var d=t.getCellHeight();var c=true;var f=t.getTileSet();var u=false;var p=false;var v=false;var g=false;var m=true;var i=this.selection;var y=[];var b=i.minX;var C=i.minY;if(typeof e!="undefined"){if(typeof e.hflip!="undefined"){u=e.hflip}if(typeof e.vflip!="undefined"){p=e.vflip}if(typeof e.invert!="undefined"){v=e.invert}if(typeof e.rotate!="undefined"){g=e.rotate}if(typeof e.allowMove){c=e.allowMove}if(typeof e.history!="undefined"){m=e.history}if(typeof e.pasteAtX!="undefined"){b=e.pasteAtX}if(typeof e.pasteAtY!="undefined"){C=e.pasteAtY}if(typeof e.useNudgeData!="undefined"){o=e.useNudgeData}}if(c){this.pasteAsMovable();return}if(m){this.editor.history.startEntry("PixelPaste")}var x=false;if(typeof e!="undefined"){if(typeof e.pasteAtX!="undefined"){b=e.pasteAtX}if(typeof e.pasteAtY!="undefined"){C=e.pasteAtY}if(typeof e.pasteTransparent){x=e.pasteTransparent}}var S=t.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR;var r=this.data;if(o&&this.nudgeData!==false){r=this.nudgeData}for(var P=0;P<r.length;P++){for(var w=0;w<r[P].length;w++){var I=w;var k=P;if(p){k=r.length-1-P}if(u){if(S){I=r[0].length-1-w;if(w%2){I+=1}else{I-=1}}else{I=r[0].length-1-w}}var M=r[k][I];if(v){if(M>0){M=0}else{M=1}}var T=w;var D=P;if(g){T=r.length-P;D=w}T+=b;D+=C;if(T>=0&&D>=0&&T<l&&D<n){var E=Math.floor(T/h);var $=Math.floor(D/d);var _=T%h;var B=D%d;var R=t.getTile({x:E,y:$});if(R!==false){if(M||x){f.setPixel(R,_,B,M,false);if(y.indexOf(R)===-1){y.push(R)}}}}}}if(m){this.editor.history.endEntry()}for(var A=0;A<y;A++){f.updateCharacter(y[A])}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw();if(this.editor.animationPreview.getVisible()){this.editor.animationPreview.draw()}},nudgeSelection:function(e,t,i){var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!=="grid"){return}var a=r.getWidth();var s=r.getHeight();var o=false;var l=false;var n=this.selection;var h=!this.isActive()||n.minX==n.maxX&&n.minY==n.maxY;if(h){this.selectAll();if(e<0){this.selection.minX-=e}if(t<0){this.selection.minY-=t}if(t>0){this.selection.maxY-=t}}if(typeof i!="undefined"){if(typeof i.moveCopy!="undefined"){l=i.moveCopy}if(typeof i.moveCut!="undefined"){o=i.moveCut}}if(r.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){if(e==1||e==-1){e*=2}}var d={x:0,y:0};var c={x:0,y:0};d.x=n.minX+e;d.y=n.minY+t;c.x=n.maxX+e-1;c.y=n.maxY+t-1;if(!h){if(d.x<0){}if(d.y<0){}if(c.y>=s){}if(c.x>=a){}}if(o||l){this.editor.history.startEntry("pixelNudgeSelection");this.editor.history.setNewEntryEnabled(false);if(this.nudgeData!==false){this.clear()}else{if(o){this.cut({useNudgeData:true})}if(l){this.copy({useNudgeData:true})}}this.setSelection({from:d,to:c,resetNudgeData:false,saveInHistory:true});var i={pasteTransparent:true,allowMove:false,useNudgeData:true};this.paste(i);this.editor.history.setNewEntryEnabled(true);this.editor.history.endEntry();if(l){}}else{this.setSelection({from:d,to:c,saveInHistory:true})}if(h){this.unselectAll()}}};var ReplaceColorDialog=function(){this.uiComponent=null;this.replaceColor=false;this.replaceWithColor=false;this.replaceFG=true;this.replaceBG=false;this.frames="current"};ReplaceColorDialog.prototype={init:function(e){this.editor=e},show:function(){if(this.uiComponent==null){var t=this;this.uiComponent=UI.create("UI.Dialog",{id:"replaceColorDialog",title:"Replace Color",width:300,height:240});this.uiComponent.on("close",function(){t.editor.colorPaletteManager.closeColorPicker()});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/replaceColor.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.doReplaceColor();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}UI.showDialog("replaceColorDialog")},setReplaceColor:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();this.replaceColor=e;$("#replaceColor").css("background-color","#"+t.getHexString(e))},setReplaceWithColor:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();this.replaceWithColor=e;$("#replaceWithColor").css("background-color","#"+t.getHexString(e))},initContent:function(){var e=this.editor.currentTile.getColor();this.setReplaceColor(e);this.setReplaceWithColor(e)},initEvents:function(){var a=this;$("#replaceColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.setReplaceColor(e)};var i=e.pageX;var r=e.pageY;a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("#replaceWithColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.setReplaceWithColor(e)};t.hasNone=true;var i=e.pageX;var r=e.pageY;a.editor.colorPaletteManager.showColorPicker(i,r,t)})},readSettings:function(){this.replaceFG=$("#replaceColorFG").is(":checked");this.replaceBG=$("#replaceColorBG").is(":checked");this.frames=$("input[name=replaceColorFrame]:checked").val()},doReplaceColor:function(){this.readSettings();var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return false}var t=0;var i=e.getGridWidth();var r=0;var a=e.getGridHeight();var s=0;var o=this.editor.graphic.getFrameCount();console.log("frames = "+this.frames);if(this.frames=="current"){s=this.editor.graphic.getCurrentFrame();o=this.editor.graphic.getCurrentFrame()+1}var l={};this.editor.history.startEntry("Replace Colour");for(var n=s;n<o;n++){for(var h=r;h<a;h++){for(var d=t;d<i;d++){var c=e.getCell({x:d,y:h,frame:n});if(this.replaceFG&&c.fc==this.replaceColor&&this.replaceWithColor!==false||this.replaceBG&&c.bc==this.replaceColor){var l={};l.x=d;l.y=h;l.frame=n;for(var f in c){if(c.hasOwnProperty(f)){l[f]=c[f]}}if(this.replaceFG&&c.fc==this.replaceColor&&this.replaceWithColor!==false){l.fc=this.replaceWithColor}if(this.replaceBG&&c.bc==this.replaceColor){l.bc=this.replaceWithColor}e.setCell(l)}}}}this.editor.history.endEntry();this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw()}};var ReplaceCharacterDialog=function(){this.uiComponent=null;this.replaceTile=false;this.replaceWithTile=false;this.replaceTileCanvas=null;this.replaceTileWithCanvas=null};ReplaceCharacterDialog.prototype={init:function(e){this.editor=e},show:function(){if(this.uiComponent==null){var t=this;this.uiComponent=UI.create("UI.Dialog",{id:"replaceCharacterDialog",title:"Replace Tile",width:300,height:200});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/replaceCharacter.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.doReplaceTile();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}UI.showDialog("replaceCharacterDialog")},initContent:function(){if(this.replaceTileCanvas==null){this.replaceTileCanvas=document.getElementById("replaceCharacterCanvas")}if(this.replaceTileWithCanvas==null){this.replaceTileWithCanvas=document.getElementById("replaceWithCharacterCanvas")}this.canvasScale=Math.floor(UI.devicePixelRatio);var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileWidth();var i=e.getTileHeight();this.characterScale=2;var r=t*this.characterScale;var a=i*this.characterScale;this.replaceTileCanvas.height=a*this.canvasScale;this.replaceTileCanvas.width=r*this.canvasScale;this.replaceTileCanvas.style.height=a+"px";this.replaceTileCanvas.style.width=r+"px";this.replaceTileWithCanvas.height=a*this.canvasScale;this.replaceTileWithCanvas.width=r*this.canvasScale;this.replaceTileWithCanvas.style.height=a+"px";this.replaceTileWithCanvas.style.width=r+"px";var s=this.editor.currentTile.getCharacters();var o=0;if(s.length>0){o=s[0][0]}if(this.replaceTile===false){this.setReplaceTile(o)}if(this.replaceWithTile===false){this.setReplaceWithTile(o)}},setReplaceTile:function(e){this.replaceTile=e;this.drawReplaceCharacter()},setReplaceWithTile:function(e){this.replaceWithTile=e;this.drawReplaceCharacter()},initEvents:function(){var a=this;$("#replaceCharacterCanvas").on("click",function(){var e={};e.characterPickedCallback=function(e){a.setReplaceTile(e)};e.mode="single";e.selected=0;var t=event.pageX;var i=event.pageY;a.editor.tileSetManager.showCharacterPicker(t,i,e)});$("#replaceWithCharacterCanvas").on("click",function(e){var t={};t.characterPickedCallback=function(e){a.setReplaceWithTile(e)};t.mode="single";t.selected=0;var i=e.pageX;var r=e.pageY;a.editor.tileSetManager.showCharacterPicker(i,r,t)})},drawReplaceCharacter:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileWidth();var i=e.getTileHeight();var r=2;if(i>10){r=1}console.log("scale = "+r);this.replaceTileContext=this.replaceTileCanvas.getContext("2d");this.replaceTileContext.clearRect(0,0,this.replaceTileCanvas.width,this.replaceTileCanvas.height);var a=this.replaceTileContext.getImageData(0,0,this.replaceTileCanvas.width,this.replaceTileCanvas.height);var s={};s["scale"]=r*this.canvasScale;s["imageData"]=a;s["character"]=this.replaceTile;s["colorRGB"]=16777215;s["bgColorRGB"]=3355443;s["x"]=0;s["y"]=0;e.drawCharacter(s);this.replaceTileContext.putImageData(a,0,0);this.replaceTileWithContext=this.replaceTileWithCanvas.getContext("2d");this.replaceTileWithContext.clearRect(0,0,this.replaceTileWithCanvas.width,this.replaceTileWithCanvas.height);var a=this.replaceTileWithContext.getImageData(0,0,this.replaceTileWithCanvas.width,this.replaceTileWithCanvas.height);var s={};s["scale"]=r*this.canvasScale;s["imageData"]=a;s["character"]=this.replaceWithTile;s["colorRGB"]=16777215;s["bgColorRGB"]=3355443;s["x"]=0;s["y"]=0;e.drawCharacter(s);this.replaceTileWithContext.putImageData(a,0,0)},doReplaceTile:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return false}this.frames=$("input[name=replaceCharacterFrame]:checked").val();var t=0;var i=e.getGridWidth();var r=0;var a=e.getGridHeight();var s=0;var o=this.editor.graphic.getFrameCount();if(this.frames=="current"){s=this.editor.graphic.getCurrentFrame();o=this.editor.graphic.getCurrentFrame()+1}var l={};this.editor.history.startEntry("Replace Tiles");for(var n=s;n<o;n++){for(var h=r;h<a;h++){for(var d=t;d<i;d++){var c=e.getCell({x:d,y:h,frame:n});if(c.t==this.replaceTile){var l={};l.x=d;l.y=h;l.frame=n;for(var f in c){if(c.hasOwnProperty(f)){l[f]=c[f]}}l.t=this.replaceWithTile;e.setCell(l)}}}}this.editor.history.endEntry();this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw()}};var ClearHiddenTilesDialog=function(){this.uiComponent=null;this.replaceWithTile=false;this.replaceTileWithCanvas=null};ClearHiddenTilesDialog.prototype={init:function(e){this.editor=e},show:function(){if(this.uiComponent==null){var t=this;this.uiComponent=UI.create("UI.Dialog",{id:"clearHiddenTilesDialog",title:"Clear Hidden Tiles",width:300,height:200});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/clearHiddenTiles.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.doReplaceTile();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}UI.showDialog("clearHiddenTilesDialog")},initContent:function(){},setReplaceWithTile:function(e){this.replaceWithTile=e;this.drawReplaceCharacter()},initEvents:function(){var e=this},drawReplaceCharacter:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileWidth();var i=e.getTileHeight();var r=2;if(i>10){r=1}console.log("scale = "+r);this.replaceTileContext=this.replaceTileCanvas.getContext("2d");this.replaceTileContext.clearRect(0,0,this.replaceTileCanvas.width,this.replaceTileCanvas.height);var a=this.replaceTileContext.getImageData(0,0,this.replaceTileCanvas.width,this.replaceTileCanvas.height);var s={};s["scale"]=r*this.canvasScale;s["imageData"]=a;s["character"]=this.replaceTile;s["colorRGB"]=16777215;s["bgColorRGB"]=3355443;s["x"]=0;s["y"]=0;e.drawCharacter(s);this.replaceTileContext.putImageData(a,0,0);this.replaceTileWithContext=this.replaceTileWithCanvas.getContext("2d");this.replaceTileWithContext.clearRect(0,0,this.replaceTileWithCanvas.width,this.replaceTileWithCanvas.height);var a=this.replaceTileWithContext.getImageData(0,0,this.replaceTileWithCanvas.width,this.replaceTileWithCanvas.height);var s={};s["scale"]=r*this.canvasScale;s["imageData"]=a;s["character"]=this.replaceWithTile;s["colorRGB"]=16777215;s["bgColorRGB"]=3355443;s["x"]=0;s["y"]=0;e.drawCharacter(s);this.replaceTileWithContext.putImageData(a,0,0)},doReplaceTile:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return false}this.frames=$("input[name=clearHiddenTilesFrame]:checked").val();var t=0;var i=e.getGridWidth();var r=0;var a=e.getGridHeight();var s=0;var o=this.editor.graphic.getFrameCount();if(this.frames=="current"){s=this.editor.graphic.getCurrentFrame();o=this.editor.graphic.getCurrentFrame()+1}var l={};this.editor.history.startEntry("Replace Tiles");var n=e.getBackgroundColor();var h=e.getTileSet();var d=h.getBlankCharacter();var c=this.editor.colorPaletteManager.noColor;for(var f=s;f<o;f++){for(var u=r;u<a;u++){for(var p=t;p<i;p++){var v=e.getCell({x:p,y:u,frame:f});if(v.fc==v.bc||v.bc==c&&v.fc==n){var l={};l.x=p;l.y=u;l.frame=f;for(var g in v){if(v.hasOwnProperty(g)){l[g]=v[g]}}l.t=d;e.setCell(l)}}}}this.editor.history.endEntry();this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw()}};var GridDimensionsDialog=function(){this.editor=null;this.canvas=null;this.currentWidth=0;this.currentHeight=0;this.dimensionsDialog=null;this.draggingScreen=false;this.bigger=true};GridDimensionsDialog.prototype={init:function(e){this.editor=e},initEvents:function(){var t=this;if(this.canvas==null){this.canvas=document.getElementById("settingsDimensionsOffsetCanvas")}$(".dimensionsNumber").on("change",function(e){t.updateDimensions()});$(".dimensionsNumber").on("keyup",function(e){t.updateDimensions()});this.canvas.addEventListener("mousedown",function(e){t.mouseDown(e)},false);this.canvas.addEventListener("mousemove",function(e){t.mouseMove(e)},false);this.canvas.addEventListener("mouseup",function(e){t.mouseUp(e)},false);this.canvas.addEventListener("touchstart",function(e){t.touchStart(e)},false);this.canvas.addEventListener("touchmove",function(e){t.touchMove(e);return false},false);this.canvas.addEventListener("touchend",function(e){t.touchEnd(e)},false)},showDimensions:function(){var n=this;if(this.dimensionsDialog==null){var e=330;var t=465;if(UI.isMobile.any()){e=280;t=550}this.dimensionsDialog=UI.create("UI.Dialog",{id:"dimensionsDialog",title:"Dimensions",width:e,height:t});this.dimensionsHTML=UI.create("UI.HTMLPanel");this.dimensionsDialog.add(this.dimensionsHTML);this.dimensionsHTML.load("html/textMode/dimensionsDialog.html",function(){n.initEvents();n.initContent()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.dimensionsDialog.addButton(this.okButton);this.okButton.on("click",function(e){var t={};var i=n.editor.graphic;if(i.getType()=="sprite"){var r=n.editor.layers.getSelectedLayerObject();if(r&&r.getType()=="grid"){var a=r.getTileSet();var s=a.getTileWidth();var o=a.getTileHeight();t={};t.width=parseInt($("#settingsDimensionsTileWidth").val(),10);t.height=parseInt($("#settingsDimensionsTileHeight").val(),10);t.offsetX=0;t.offsetY=0;if(t.tileWidth!=s||t.tileHeight!=o){a.setTileDimensions(t)}}}t={};t.width=parseInt($("#settingsDimensionsWidth").val(),10);t.height=parseInt($("#settingsDimensionsHeight").val(),10);var l=$("#settingsDimensionsDepth").val();t.offsetX=parseInt($("#settingsDimensionsOffsetX").val(),10);t.offsetY=parseInt($("#settingsDimensionsOffsetY").val(),10);n.editor.graphic.setGridDimensions(t);UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.dimensionsDialog.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("dimensionsDialog")},initContent:function(){var e=this.editor.graphic;if(e.getType()=="sprite"){$("#settingsDimensionsTile").show()}else{$("#settingsDimensionsTile").hide()}this.currentWidth=e.getGridWidth();this.currentHeight=e.getGridHeight();var t=8;var i=8;var r=this.editor.layers.getSelectedLayerObject();if(r&&r.getType()=="grid"){var a=r.getTileSet();t=a.getTileWidth();i=a.getTileHeight()}$("#settingsDimensionsTileWidth").val(t);$("#settingsDimensionsTileHeight").val(i);$("#settingsDimensionsWidth").val(this.currentWidth);$("#settingsDimensionsHeight").val(this.currentHeight);$("#settingsDimensionsOffsetX").val(0);$("#settingsDimensionsOffsetY").val(0);this.updateDimensions()},updateDimensions:function(){this.context=this.canvas.getContext("2d");this.width=parseInt($("#settingsDimensionsWidth").val(),10);this.height=parseInt($("#settingsDimensionsHeight").val(),10);this.offsetX=parseInt($("#settingsDimensionsOffsetX").val(),10);this.offsetY=parseInt($("#settingsDimensionsOffsetY").val(),10);this.bigger=true;if(this.currentHeight>this.height){this.bigger=false}if(this.currentWidth>this.width){this.bigger=false}this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.scale=this.canvas.width/this.width;if(this.canvas.height/this.height<this.scale){this.scale=this.canvas.height/this.height}if(this.canvas.height/this.currentHeight<this.scale){this.bigger=false;this.scale=this.canvas.height/this.currentHeight}if(this.canvas.width/this.currentWidth<this.scale){this.bigger=false;this.scale=this.canvas.width/this.currentWidth}var e=0;var t=0;this.context.fillStyle="#333333";this.context.fillRect(e,t,this.width*this.scale,this.height*this.scale);this.currentScreenX=this.offsetX*this.scale;this.currentScreenY=this.offsetY*this.scale;this.currentScreenWidth=this.currentWidth*this.scale;this.currentScreenHeight=this.currentHeight*this.scale;this.context.fillStyle="#999999";this.context.fillRect(this.currentScreenX,this.currentScreenY,this.currentScreenWidth,this.currentScreenHeight);if(!this.bigger){this.context.strokeStyle="#333333";this.context.beginPath();this.context.lineWidth=2;this.context.rect(e,t,this.width*this.scale,this.height*this.scale);this.context.stroke()}},toolStart:function(e,t,i){this.mouseDownX=e;this.mouseDownY=t;this.mouseDownOffsetX=this.offsetX;this.mouseDownOffsetY=this.offsetY;if(e>this.currentScreenX&&e<this.currentScreenX+this.currentScreenWidth){if(t>this.currentScreenY&&t<this.currentScreenY+this.currentScreenHeight){console.log("mouse down on current screen");this.draggingScreen=true}}},toolMove:function(e,t,i){var r=e;var a=t;if(this.draggingScreen){console.log("drag screen"+this.scale);var s=Math.round(this.mouseDownOffsetX+(r-this.mouseDownX)/this.scale);$("#settingsDimensionsOffsetX").val(s);var o=Math.round(this.mouseDownOffsetY+(a-this.mouseDownY)/this.scale);$("#settingsDimensionsOffsetY").val(o);this.updateDimensions()}},toolEnd:function(e){this.draggingScreen=false},touchStart:function(e){e.preventDefault();var t=e.touches;if(t.length==1){var i=t[0].pageX-$("#"+this.canvas.id).offset().left;var r=t[0].pageY-$("#"+this.canvas.id).offset().top;this.toolStart(i,r,t[0]);UI.captureMouse(this)}},touchMove:function(e){var t=e.touches;if(t.length==1){var i=t[0].pageX-$("#"+this.canvas.id).offset().left;var r=t[0].pageY-$("#"+this.canvas.id).offset().top;this.toolMove(i,r,t[0])}},touchEnd:function(e){this.toolEnd(e)},mouseDown:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;this.toolStart(t,i,e);UI.captureMouse(this)},mouseMove:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;this.toolMove(t,i,e)},mouseUp:function(e){this.toolEnd(e)}};var Grid=function(){this.editor=null;this.width=40;this.height=25;this.depth=25;this.gridData=null;this.holder=null;this.ghostHolder=null;this.changingGridData=false;this.pixelTo3dUnits=.25;this.pixelSizeX=1;this.pixelSizeY=1;this.pixelSizeZ=1;this.cellSizeX=8*this.pixelSizeX*this.pixelTo3dUnits;this.cellSizeY=8*this.pixelSizeX*this.pixelTo3dUnits;this.cellSizeZ=8*this.pixelSizeX*this.pixelTo3dUnits;this.handedness="right";this.cursorCharacter=null;this.cursorEnabled=true;this.cursor=null;this.typingCursor=null;this.selection=null;this.selectionActive=false;this.selectionDragControls=null;this.selectionDragArrows=null;this.selectionDragMode="";this.selectionOffsetX=0;this.selectionOffsetY=0;this.grid2d=null;this.border=new THREE.Object3D;this.border.visible=true;this.borderEnabled=true;this.backgroundImageSet=false;this.background=new THREE.Object3D;this.background.visible=true;this.backgroundImage=new THREE.Object3D;this.backgroundImage.visible=false;this.backgroundImageCanvas=null;this.backgroundImageTexture=null;this.backgroundImageMaterial=null;this.updateEnabled=true};Grid.prototype={init:function(e){this.editor=e;this.grid2d=new Grid2d;this.grid2d.init(e)},initTypingCursor:function(){var e=new THREE.BoxGeometry(this.cellSizeX,this.cellSizeY,this.cellSizeZ);var t=new THREE.MeshPhongMaterial({color:16777215,specular:0,shininess:0});t.flatShading=true;if(this.typingCursor){scene.remove(this.typingCursor);this.typingCursor=null}this.typingCursor=new THREE.Mesh(e,t);this.typingCursor.frustumCulled=false;this.typingCursor.visible=false;this.typingCursor.gridX=0;this.typingCursor.gridY=0;this.typingCursor.gridZ=0;this.typingCursor.lastChangeTime=0;scene.add(this.typingCursor)},setTypingCursorPosition:function(e,t,i){if(typeof e=="undefined"){e=this.cursorCharacter.gridX;t=this.cursorCharacter.gridY;i=this.cursorCharacter.gridZ}this.typingCursor.position.x=e*this.cellSizeX+this.cellSizeX/2;this.typingCursor.position.y=t*this.cellSizeY+this.cellSizeY/2;this.typingCursor.position.z=i*this.cellSizeZ+this.cellSizeZ/2;this.typingCursor.gridX=e;this.typingCursor.gridY=t;this.typingCursor.gridZ=i},setupSelectionDragControls:function(){this.selectionDragArrows=[];this.selectionDragControls=new THREE.Object3D;this.selectionDragControls.position.x=20;this.selectionDragControls.position.y=20;this.selectionDragControls.position.z=30;scene.add(this.selectionDragControls);var e=new THREE.CylinderGeometry(0,.8,2,4,1);var t=new THREE.MeshPhongMaterial({color:16711680,specular:0,shininess:0,transparent:false,opacity:.6});t.flatShading=true;this.dragUpControl=new THREE.Mesh(e,t);this.dragUpControl.position.y=5;this.dragUpControl.dragType="dragUp";this.selectionDragArrows.push(this.dragUpControl);var i=new THREE.CylinderGeometry(.2,.2,5,3,1);var r=new THREE.Mesh(i,t);r.position.y=2.5;this.selectionDragControls.add(r);this.selectionDragControls.add(this.dragUpControl);var a=new THREE.CylinderGeometry(0,.8,2,4,1);var t=new THREE.MeshPhongMaterial({color:65280,specular:0,shininess:0,transparent:false,opacity:.6});t.flatShading=true;this.dragRightControl=new THREE.Mesh(e,t);this.dragRightControl.rotation.z=-Math.PI/2;this.dragRightControl.position.x=5;this.dragRightControl.dragType="dragRight";this.selectionDragArrows.push(this.dragRightControl);this.selectionDragControls.add(this.dragRightControl);var s=new THREE.CylinderGeometry(.2,.2,5,3,1);var o=new THREE.Mesh(s,t);o.position.x=2.5;o.rotation.z=-Math.PI/2;this.selectionDragControls.add(o);var l=new THREE.CylinderGeometry(0,.8,2,4,1);var t=new THREE.MeshPhongMaterial({color:255,specular:0,shininess:0,transparent:false,opacity:.6});t.flatShading=true;this.dragForwardControl=new THREE.Mesh(l,t);this.dragForwardControl.rotation.x=Math.PI/2;this.dragForwardControl.position.z=5;this.dragForwardControl.dragType="dragForward";this.selectionDragArrows.push(this.dragForwardControl);this.selectionDragControls.add(this.dragForwardControl);var n=new THREE.CylinderGeometry(.2,.2,5,3,1);var h=new THREE.Mesh(n,t);h.position.z=2.5;h.rotation.x=Math.PI/2;this.selectionDragControls.add(h);this.selectionDragControls.visible=false},initSelection:function(){var e=new THREE.BoxGeometry(this.cellSizeX,this.cellSizeY,this.cellSizeZ);var t=new THREE.MeshPhongMaterial({color:16777215,specular:0,shininess:0,transparent:true,opacity:.3});t.flatShading=true;if(this.selection){scene.remove(this.selection);this.selection=null}this.selection=new THREE.Mesh(e,t);this.selection.frustumCulled=false;this.selection.visible=false;scene.add(this.selection);$("#selectX1").attr("max",this.width);$("#selectX2").attr("max",this.width);$("#selectY1").attr("max",this.height);$("#selectY2").attr("max",this.height);$("#selectZ1").attr("max",this.depth);$("#selectZ2").attr("max",this.depth);this.setupSelectionDragControls()},setSelection:function(e,t,i){this.selectionActive=true;var r=e.x;var a=e.y;var s=e.z;var o=t.x;var l=t.y;var n=t.z;if(r>o){r=o;o=e.x}if(a>l){a=l;l=e.y}if(s==n){n+=1}if(s>n){s=t.z-1;console.log("minz = "+s+" maxz = "+n);if(n-s==1){}n=e.z}else{n-=1}if(r<0){r=0}if(r>=this.width){r=this.width-1}if(o>=this.width){o=this.width-1}if(o<0){o=0}if(a<0){a=0}if(a>=this.height){a=this.height-1}if(l>=this.height){l=this.height-1}if(l<0){l=0}if(s<0){s=0}if(s>=this.depth){s=this.depth-1}if(n<0){n=0}if(n>=this.depth){n=this.depth-1}this.selection.minX=r;this.selection.minY=a;this.selection.minZ=s;this.selection.maxX=o+1;this.selection.maxY=l+1;this.selection.maxZ=n+1;var h=.1;l+=1;o+=1;n+=1;var d=l;r*=this.cellSizeX;a*=this.cellSizeY;s*=this.cellSizeZ;o*=this.cellSizeX;l*=this.cellSizeY;n*=this.cellSizeZ;r-=h;a-=h;s-=h;o+=h;l+=h;n+=h;this.selection.geometry.vertices[0].x=o;this.selection.geometry.vertices[0].y=l;this.selection.geometry.vertices[0].z=n;this.selection.geometry.vertices[1].x=o;this.selection.geometry.vertices[1].y=l;this.selection.geometry.vertices[1].z=s;this.selection.geometry.vertices[2].x=o;this.selection.geometry.vertices[2].y=a;this.selection.geometry.vertices[2].z=n;this.selection.geometry.vertices[3].x=o;this.selection.geometry.vertices[3].y=a;this.selection.geometry.vertices[3].z=s;this.selection.geometry.vertices[4].x=r;this.selection.geometry.vertices[4].y=l;this.selection.geometry.vertices[4].z=s;this.selection.geometry.vertices[5].x=r;this.selection.geometry.vertices[5].y=l;this.selection.geometry.vertices[5].z=n;this.selection.geometry.vertices[6].x=r;this.selection.geometry.vertices[6].y=a;this.selection.geometry.vertices[6].z=s;this.selection.geometry.vertices[7].x=r;this.selection.geometry.vertices[7].y=a;this.selection.geometry.vertices[7].z=n;this.selection.geometry.verticesNeedUpdate=true;if(typeof i=="undefined"||i==true){if(this.editor.invertY){$("#selectX1").val(this.selection.minX);$("#selectY2").val(this.editor.frames.height-this.selection.minY-1);$("#selectZ1").val(this.selection.minZ);$("#selectX2").val(this.selection.maxX-1);$("#selectY1").val(this.editor.frames.height-(this.selection.maxY-1)-1);$("#selectZ2").val(this.selection.maxZ-1)}else{$("#selectX1").val(this.selection.minX);$("#selectY1").val(this.selection.minY);$("#selectZ1").val(this.selection.minZ);$("#selectX2").val(this.selection.maxX-1);$("#selectY2").val(this.selection.maxY-1);$("#selectZ2").val(this.selection.maxZ-1)}}this.selection.position.x=0;this.selection.position.y=0;this.selection.position.z=0;if(this.editor.mode!=="type"){this.selectionDragControls.visible=true}else{this.selectionDragControls.visible=false}this.selectionDragControls.position.x=(r+o)/2;this.selectionDragControls.position.y=(a+l)/2;this.selectionDragControls.position.z=n;this.selectionDragControls.originalPosition={};this.selectionDragControls.originalPosition.x=this.selectionDragControls.position.x;this.selectionDragControls.originalPosition.y=this.selectionDragControls.position.y;this.selectionDragControls.originalPosition.z=this.selectionDragControls.position.z;this.selection.visible=true},offsetSelectionBy:function(e,t,i){console.log("offset selection by "+e+","+t+","+i);this.selection.position.x=e*this.cellSizeX;this.selection.position.y=t*this.cellSizeY;this.selection.position.z=i*this.cellSizeZ;this.selection.offsetX=e;this.selection.offsetY=t;this.selection.offsetZ=i;this.selectionDragControls.position.x=this.selectionDragControls.originalPosition.x+e*this.cellSizeX;this.selectionDragControls.position.y=this.selectionDragControls.originalPosition.y+t*this.cellSizeY;this.selectionDragControls.position.z=this.selectionDragControls.originalPosition.z+i*this.cellSizeZ;var r=this.selection.maxX-this.selection.minX;var a=this.selection.maxZ-this.selection.minZ;var s=this.selection.maxY-this.selection.minY;for(var o=0;o<a;o++){for(var l=0;l<s;l++){for(var n=0;n<r;n++){var h=this.gridData[this.selection.minZ+o][this.selection.minY+l][this.selection.minX+n];if(h.c>=0&&h.c!=this.editor.tileSetManager.blankCharacter){h.mesh.position.x=h.mesh.originalPosition.x+e*this.cellSizeX;h.mesh.position.y=h.mesh.originalPosition.y+t*this.cellSizeY;h.mesh.position.z=h.mesh.originalPosition.z+i*this.cellSizeZ}}}}},clearCellOffsets:function(){for(var e=0;e<this.depth;e++){for(var t=0;t<this.height;t++){for(x=0;x<this.width;x++){var i=this.gridData[e][t][x];if(i&&i.c!=this.editor.tileSetManager.blankCharacter){i.mesh.position.x=i.mesh.originalPosition.x;i.mesh.position.y=i.mesh.originalPosition.y;i.mesh.position.z=i.mesh.originalPosition.z}}}}},createGrid:function(){alert("create grid!");var e=8;var t=8;var i=8;this.cellSizeX=e*1*this.pixelTo3dUnits;this.cellSizeY=t*1*this.pixelTo3dUnits;this.cellSizeZ=i*1*this.pixelTo3dUnits;var r=this.editor.tileSetManager.getCurrentTileSet();if(r){e=r.charWidth;t=r.charHeight;i=r.charDepth;this.cellSizeX=e*r.pixelWidth*this.pixelTo3dUnits;this.cellSizeY=t*r.pixelHeight*this.pixelTo3dUnits;this.cellSizeZ=i*r.pixelDepth*this.pixelTo3dUnits}this.planes=[];if(this.xyMesh){scene.remove(this.xyMesh);this.xyMesh=null}if(this.xzMesh){scene.remove(this.xzMesh);this.xzMesh=null}if(this.zyMesh){scene.remove(this.zyMesh);this.zyMesh=null}if(this.xyLineMaterial==null){this.xyLineMaterial=new THREE.LineBasicMaterial({color:8947848,transparent:false,opacity:.5})}this.xyMesh=new THREE.Object3D;scene.add(this.xyMesh);this.xyGrid=new THREE.Object3D;this.xyMesh.add(this.xyGrid);for(var a=0;a<=this.width;a++){var s=new THREE.Geometry;s.vertices.push(new THREE.Vector3(this.cellSizeX*a,0,0),new THREE.Vector3(this.cellSizeX*a,this.height*this.cellSizeY,0));var o=new THREE.Line(s,this.xyLineMaterial);this.xyGrid.add(o)}for(var a=0;a<=this.height;a++){var s=new THREE.Geometry;s.vertices.push(new THREE.Vector3(0,a*this.cellSizeY,0),new THREE.Vector3(this.width*this.cellSizeX,a*this.cellSizeY,0));var o=new THREE.Line(s,this.xyLineMaterial);this.xyGrid.add(o)}var s=new THREE.PlaneGeometry(this.width*this.cellSizeX,this.height*this.cellSizeY);this.xyGridBackingMaterial=new THREE.MeshBasicMaterial({color:16777215,transparent:true,opacity:.05,side:THREE.DoubleSide});this.xyGridBacking=new THREE.Mesh(s,this.xyGridBackingMaterial);this.xyGridBacking.position.z=-.05;this.xyGridBacking.position.x=this.width*this.cellSizeX/2;this.xyGridBacking.position.y=this.height*this.cellSizeY/2;this.xyGridBacking.gridPlane="xy";this.xyMesh.add(this.xyGridBacking);this.planes.push(this.xyGridBacking);this.xzLineMaterial=new THREE.LineBasicMaterial({color:3487029,transparent:false,opacity:.5});this.xzMesh=new THREE.Object3D;this.xzGrid=new THREE.Object3D;this.xzMesh.add(this.xzGrid);scene.add(this.xzMesh);for(var a=0;a<=this.width;a++){var s=new THREE.Geometry;s.vertices.push(new THREE.Vector3(this.cellSizeX*a,0,0),new THREE.Vector3(this.cellSizeX*a,0,this.depth*this.cellSizeZ));var o=new THREE.Line(s,this.xzLineMaterial);this.xzGrid.add(o)}for(var a=0;a<=this.depth;a++){var s=new THREE.Geometry;s.vertices.push(new THREE.Vector3(0,0,a*this.cellSizeZ),new THREE.Vector3(this.width*this.cellSizeX,0,a*this.cellSizeZ));var o=new THREE.Line(s,this.xzLineMaterial);this.xzGrid.add(o)}var s=new THREE.PlaneGeometry(this.width*this.cellSizeX,this.depth*this.cellSizeZ);this.xzGridBackingMaterial=new THREE.MeshBasicMaterial({color:16777215,transparent:true,opacity:.05,side:THREE.DoubleSide});this.xzGridBacking=new THREE.Mesh(s,this.xzGridBackingMaterial);this.xzGridBacking.rotation.x=-Math.PI/2;this.xzGridBacking.position.y=-.1;this.xzGridBacking.position.x=this.width*this.cellSizeX/2;this.xzGridBacking.position.z=this.depth*this.cellSizeZ/2;this.xzGridBacking.gridPlane="xz";this.xzMesh.add(this.xzGridBacking);this.planes.push(this.xzGridBacking);if(this.floor){scene.remove(this.floor);this.floor=null}var s=new THREE.PlaneGeometry(this.width*this.cellSizeX,this.depth*this.cellSizeZ);material=new THREE.MeshPhongMaterial({color:2236962,emissive:0,specular:0,shininess:0,transparent:false,opacity:1});this.floor=new THREE.Mesh(s,material);this.floor.rotation.x=-Math.PI/2;this.floor.position.y=-.1;this.floor.position.x=this.width*this.cellSizeX/2;this.floor.position.z=this.depth*this.cellSizeZ/2;scene.add(this.floor);this.floor.receiveShadow=true;this.xyPosition=Math.floor(this.depth/2);this.xyMesh.position.z=this.xyPosition*this.cellSizeZ;this.xzPosition=this.height-1;if(this.handedness=="right"){this.xzPosition=0;this.xzMesh.position.y=this.xzPosition*this.cellSizeY}else{this.xzPosition=this.height-1;this.xzMesh.position.y=this.height*this.cellSizeY-1-this.xzPosition*this.cellSizeY-this.cellSizeY/2}this.initSelection();this.initTypingCursor();this.setupBackgroundImage();$("#xyPosition").attr("max",this.depth);$("#xzPosition").attr("max",this.height);console.error("2d shouldn't call this")},toggleGrid:function(){this.xyMesh.visible=!this.xyMesh.visible;this.xzMesh.visible=!this.xzMesh.visible},setBorderEnabled:function(e){this.border.visible=this.border.visible&e;this.borderEnabled=e},toggleBorder:function(){if(!this.borderEnabled){return}this.border.visible=!this.border.visible;UI("edit-showborder").setChecked(this.border.visible)},toggleBackground:function(){this.background.visible=!this.background.visible},setupBackgroundImage:function(){return;this.backgroundImageScale=1;var e=this.editor.tileSetManager.getCurrentTileSet();if(!this.backgroundImageCanvas){this.backgroundImageCanvas=document.createElement("canvas")}this.backgroundImageCanvas.width=e.charWidth*this.width*this.backgroundImageScale;this.backgroundImageCanvas.height=e.charHeight*this.height*this.backgroundImageScale;this.backgroundImageContext=this.backgroundImageCanvas.getContext("2d");this.backgroundImageContext.imageSmoothingEnabled=false;this.backgroundImageContext.webkitImageSmoothingEnabled=false;this.backgroundImageContext.mozImageSmoothingEnabled=false;this.backgroundImageContext.msImageSmoothingEnabled=false;this.backgroundImageContext.oImageSmoothingEnabled=false;if(!this.backgroundImageTexture){this.backgroundImageTexture=new THREE.Texture(this.backgroundImageCanvas);this.backgroundImageTexture.magFilter=THREE.NearestFilter;this.backgroundImageTexture.minFilter=THREE.NearestFilter;this.backgroundImageTexture.generateMipmaps=false}this.backgroundImageContext.clearRect(0,0,this.backgroundImageCanvas.width,this.backgroundImageCanvas.height);this.backgroundImageTexture.needsUpdate=true;if(!this.backgroundImageMaterial){this.backgroundImageMaterial=new THREE.MeshBasicMaterial({color:16777215,map:this.backgroundImageTexture})}var t=new THREE.PlaneGeometry(this.width*this.cellSizeX,this.height*this.cellSizeY);this.backgroundImage=new THREE.Mesh(t,this.backgroundImageMaterial);this.backgroundImage.position.z=-.1;this.backgroundImage.position.x=this.width*this.cellSizeX/2;this.backgroundImage.position.y=this.height*this.cellSizeY/2;this.xyMesh.add(this.backgroundImage)},setBackgroundImage:function(e,t,i,r,a){t*=this.backgroundImageScale;i*=this.backgroundImageScale;r*=this.backgroundImageScale;a*=this.backgroundImageScale;this.backgroundImageContext.clearRect(0,0,this.backgroundImageCanvas.width,this.backgroundImageCanvas.height);this.backgroundImageContext.drawImage(e,t,i,r,a);this.backgroundImageTexture.needsUpdate=true;this.backgroundImageSet=true;this.backgroundImage.visible=true},toggleBackgroundImage:function(){if(!this.backgroundImageSet){this.editor.backgroundImage.start()}this.backgroundImage.visible=!this.backgroundImage.visible},getXYGridPosition:function(){console.error("get xy grid position");return 0;return this.xyPosition},moveXYGrid:function(e){var t=this.xyPosition+e;if(t<0||t>=this.depth){return}this.xyPosition=t;this.xyMesh.position.z=this.xyPosition*this.cellSizeZ;$("#xyPosition").val(this.xyPosition);if(this.cursorCharacter){this.setCursorPosition(this.cursorCharacter.gridX,this.cursorCharacter.gridY,t)}},setXYGridPosition:function(e){var t=e-this.xyPosition;this.moveXYGrid(t)},getXZGridPosition:function(){return this.xzPosition},setXZGridPosition:function(e){var t=e-this.xzPosition;this.moveXZGrid(t)},moveXZGrid:function(e){var t=this.xzPosition+e;if(t<0||t>=this.height){return}this.xzPosition=t;if(this.handedness=="right"){this.xzMesh.position.y=this.xzPosition*this.cellSizeY}else{this.xzMesh.position.y=this.height*this.cellSizeY-1-this.xzPosition*this.cellSizeY-this.cellSizeY/2}$("#xzPosition").val(this.xzPosition)},getXZGridPosition:function(){return this.xzPosition},getCursorEnabled:function(){if(this.cursorCharacter===null){return false}return this.cursorCharacter.visible},setCursorEnabled:function(e){if(this.cursorCharacter!==null&&this.cursorCharacter.visible===e){}if(this.cursorCharacter!==null){this.cursorCharacter.visible=e}this.grid2d.setCursorEnabled(e)},setCursorPosition:function(e,t,i){if(this.cursorCharacter==null){return}this.grid2d.setCursorPosition(e,t);this.cursorCharacter.position.x=e*this.cellSizeX+this.cellSizeX/2;this.cursorCharacter.position.y=t*this.cellSizeY+this.cellSizeY/2;this.cursorCharacter.position.z=i*this.cellSizeZ+this.cellSizeZ/2;this.cursorCharacter.gridX=e;this.cursorCharacter.gridY=t;this.cursorCharacter.gridZ=i},setCursorRotation:function(e,t,i){if(this.cursorCharacter==null){return}this.cursorCharacter.rotation.x=e*Math.PI*2;this.cursorCharacter.rotation.y=t*Math.PI*2;this.cursorCharacter.rotation.z=i*Math.PI*2},setCursorColor:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();this.grid2d.setCursorColor(e);if(this.cursorCharacter){this.cursorCharacter.material.color.setHex(t.getHex(e));this.cursorCharacter.color=e}if(this.typingCursor){this.typingCursor.material=t.getMaterial(e)}},setCursorBGColor:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();this.grid2d.setCursorBGColor(e)},setCursorCharacter:function(e,t){this.grid2d.setCursorCharacter(e);var i=this.editor.currentTile;if(typeof t=="undefined"){t=i.color}return;if(this.cursorCharacter&&(this.cursorCharacter.character!=e||this.cursorCharacter.color!=t)){scene.remove(this.cursorCharacter);this.cursorCharacter=null}if(!this.cursorCharacter){var r=0;var a=null;if(t==-1){r=16777215}else{r=this.editor.colorPaletteManager.currentColorPalette.getHex(t)}a=new THREE.MeshPhongMaterial({color:r,specular:0,shininess:0,transparent:true,opacity:.6});a.flatShading=true;var s=null;if(this.editor.tools.drawTools.tool=="erase"||this.editor.tools.drawTools.tool=="eyedropper"||this.editor.tools.drawTools.tool=="type"||!this.editor.tools.drawTools.drawCharacter){e=-1;s=new THREE.BoxGeometry(this.cellSizeX,this.cellSizeY,this.cellSizeZ)}else{s=this.editor.tileSetManager.currentTileSet.getGeometry(e)}this.cursorCharacter=new THREE.Mesh(s,a);this.cursorCharacter.rotation.order="YXZ";this.cursorCharacter.castShadow=false;if(this.editor.tools.drawTools.tool=="erase"||this.editor.tools.drawTools.tool=="eyedropper"||this.editor.tools.drawTools.tool=="type"||!this.editor.tools.drawTools.drawCharacter){this.cursorCharacter.scale.x=1.05;this.cursorCharacter.scale.y=1.05;this.cursorCharacter.scale.z=1.05}scene.add(this.cursorCharacter)}},setCursorCharacterAndPosition:function(e,t,i,r,a){var s=this.editor.currentTile;if(typeof a=="undefined"){a=s.color}if(typeof t=="undefined"){t=0;i=0;r=0;if(this.cursorCharacter){t=this.cursorCharacter.gridX;i=this.cursorCharacter.gridY;r=this.cursorCharacter.gridZ}}var o=this.editor.currentTile.bgColor;this.grid2d.setCursor(t,i,e,a,o);this.setCursorCharacter(e)},setCursorCell:function(e,t,i){if(!this.cursorCharacter){return}if(!this.cursorEnabled){return}if(typeof e=="undefined"){e=this.editor.currentTile.character}if(typeof t=="undefined"){t=this.editor.currentTile.color}if(typeof i=="undefined"){i=this.editor.currentTile.bgColor}var r=this.editor.currentTile.rotX;var a=this.editor.currentTile.rotY;var s=this.editor.currentTile.rotZ;var o=this.editor.currentTile.flipH;var l=this.editor.currentTile.flipV;var n=this.editor.currentTile.characters;var h={};h.fc=t;h.bc=i;h.update=false;h.fh=o;h.fv=l;h.rz=s;for(var d=0;d<n.length;d++){for(var c=0;c<n[d].length;c++){var f=this.cursorCharacter.gridX+c;var u=this.cursorCharacter.gridY+(n.length-d-1);var p=this.cursorCharacter.gridZ;if(f!==false&&f>=0&&f<this.width&&u!==false&&u>=0&&u<this.height&&p!==false&&p>=0&&p<this.depth){h.x=f;h.y=u;h.z=p;h.c=n[d][c];if(!this.editor.tools.drawTools.drawCharacter){h.c=this.gridData[p][u][f].c;h.rx=this.gridData[p][u][f].rx;h.ry=this.gridData[p][u][f].ry;h.rz=this.gridData[p][u][f].rz;h.fh=this.gridData[p][u][f].fh;h.fv=this.gridData[p][u][f].fv}if(!this.editor.tools.drawTools.drawColor){h.fc=this.gridData[p][u][f].fc}if(!this.editor.tools.drawTools.drawBgColor){h.bc=this.gridData[p][u][f].bc}this.setCell(h)}}}this.update()},eyedropperCursorCell:function(){if(!this.cursorCharacter){return}if(!this.cursorEnabled){return}var e=this.cursorCharacter.gridX;var t=this.cursorCharacter.gridY;var i=this.cursorCharacter.gridZ;if(e===false||e<0||e>=this.width||t===false||t<0||t>=this.height||i===false||i<0||i>=this.depth){return}if(this.editor.tools.drawTools.drawCharacter){var r=this.gridData[i][t][e].c;this.editor.currentTile.setCharacter(r)}if(this.editor.tools.drawTools.drawColor){var a=this.gridData[i][t][e].fc;this.editor.currentTile.setColor(a)}if(this.editor.tools.drawTools.drawBGColor){var s=this.gridData[i][t][e].bc;this.editor.currentTile.setBGColor(s)}if(this.editor.tools.drawTools.tilePalette){this.editor.tools.drawTools.tilePalette.drawCharPalette();this.editor.sideTilePalette.drawCharPalette()}},eraseCursorCell:function(){this.eraseCell(this.cursorCharacter.gridX,this.cursorCharacter.gridY,this.cursorCharacter.gridZ)},eraseCell:function(e,t,i){if(e<0||e>=this.width||t<0||t>=this.height||i<0||i>=this.depth){return}var r={};r.x=e;r.y=t;r.z=i;r.c=this.gridData[i][t][e].c;if(this.editor.tools.drawTools.drawCharacter){r.c=this.editor.tileSetManager.blankCharacter}r.fc=this.gridData[i][t][e].fc;if(this.editor.tools.drawTools.drawColor){r.fc=this.editor.tools.currentBackgroundColor}r.bc=this.gridData[i][t][e].bc;if(this.editor.tools.drawTools.drawBGColor){r.bc=this.editor.colorPaletteManager.noColor}r.rx=0;r.ry=0;r.rz=0;r.fh=0;r.fv=0;this.setCell(r)},setBackgroundColor:function(e){},setGridGhostData:function(e,t){},setGridData:function(e,t){this.changingGridData=true;if(this.gridData){scene.remove(this.holder);this.holder.visible=false}this.holder=t;if(t){scene.add(t);t.visible=true}this.gridData=e;this.changingGridData=false},getWidth:function(){return this.width},getHeight:function(){return this.height},setCell:function(e){console.error("?????");this.editor.frames.setCell(e);var t=true;if(typeof e.update!=="undefined"){t=e.update}if(t){var i=e.x;var r=e.y;var a=e.z;this.grid2d.update()}},getUpdateEnabled:function(e){return this.editor.graphic.getDrawEnabled()},setUpdateEnabled:function(e){this.editor.graphic.setDrawEnabled(e)},update:function(e){if(this.editor.type=="2d"&&this.updateEnabled){this.grid2d.update(e);this.editor.layers.updateLayerPreview()}}};var Grid2d=function(){this.editor=null;this.canvas=null;this.context=null;this.imageData=null;this.prevFrameCanvas=null;this.prevFrameContext=null;this.thumbnailCanvas=null;this.nextFrameCanvas=null;this.nextFrameContext=null;this.effectCanvas=null;this.effectContext=null;this.tempCanvas=null;this.tempContext=null;this.cursor={};this.cursor.isOn=true;this.cursor.position={x:-1,y:-1};this.cursor.offset={x:0,y:0};this.cursor.color=false;this.cursor.bgColor=false;this.cursor.character=false;this.typingCursor={};this.typingCursor.isOn=false;this.typingCursor.position={x:-1,y:-1};this.typingCursor.color=false;this.shapesCanvas=null;this.selectionCanvas=null};Grid2d.prototype={init:function(e){this.editor=e;this.canvas=document.createElement("canvas");this.canvas.width=320;this.canvas.height=200;this.context=this.canvas.getContext("2d");this.shaderEffects=new ImageShaderEffects;this.shaderEffects.init()},getCursorEnabled:function(){return this.cursor.isOn},setCursorEnabled:function(e){if(this.cursor.isOn===e){return}this.cursor.isOn=e},getCursorPosition:function(){return{x:this.cursor.position.x,y:this.cursor.position.y}},setCursorPosition:function(e,t){if(this.cursor.position.x==e&&this.cursor.position.y==t){return}var i=this.cursor.position.x;var r=this.cursor.position.y;var a=1;var s=1;var o=this.editor.tools.drawTools.tool;if(o==="pen"||o==="block"){s=this.editor.currentTile.characters.length;if(s>0){a=this.editor.currentTile.characters[0].length}}var l=this.editor.layers.getSelectedLayerObject();if(o==="block"&&l&&l.getType()=="grid"&&l.getBlockModeEnabled()){this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();var n=l.getBlockWidth();var h=l.getBlockHeight();var d=l.getGridHeight();e=Math.floor(e/n)*n;t=Math.floor(t/h)*h}this.cursor.position.x=e;this.cursor.position.y=t},eyedropperCursorCell:function(){var e=this.editor.layers.getSelectedLayerObject();if(e==null||e.getType()!="grid"){return}var t=e.getGridWidth();var i=e.getGridHeight();var r=this.cursor.position.x;var a=this.cursor.position.y;if(r===false||r<0||r>=t||a===false||a<0||a>=i){return}var s=e.getCell({x:r,y:a});if(s===false){return}var o=this.editor.tools.drawTools;var l=this.editor.currentTile;if(o.drawCharacter){this.editor.setSelectedTiles([[s.t]])}if(o.drawColor){l.setColor(s.fc)}if(o.drawBGColor){l.setBGColor(s.bc)}},eraseCursorCells:function(){var e={};e.useCells=false;e.rz=0;e.fh=0;e.fv=0;e.bc=this.editor.colorPaletteManager.noColor;e.useTile=this.editor.tileSetManager.blankCharacter;this.setCursorCells(e)},setMirrorCells:function(e,t){var i=e.getGridWidth();var r=e.getGridHeight();if(this.editor.tools.drawTools.mirrorH){var a=this.editor.graphic.getHasTileFlip();var s=this.editor.tileSetManager.getCurrentTileSet();var o=t.x;var l=t.y;var n=t.t;var h=t.fv;var d=t.fh;var c=this.editor.tools.drawTools.mirrorHX;var f=c+c-t.x-1;if(f>=0&&f<i){if(a){t.fh=1-t.fh}else{t.t=s.getHFlip(t.t)}t.x=f;e.setCell(t)}if(this.editor.tools.drawTools.mirrorV){var u=this.editor.tools.drawTools.mirrorVY;var p=u+u-t.y-1;if(p>=0&&p<r){t.y=p;if(a){t.fv=1-t.fv}else{t.t=s.getVFlip(t.t)}e.setCell(t)}}t.x=o;t.y=l;t.t=n;t.fh=d;t.fv=h}if(this.editor.tools.drawTools.mirrorV){var v=this.editor.graphic.getHasTileFlip();var s=this.editor.tileSetManager.getCurrentTileSet();var u=this.editor.tools.drawTools.mirrorVY;var p=u+u-t.y-1;if(p>=0&&p<r){t.y=p;if(v){t.fv=1-t.fv}else{t.t=s.getVFlip(t.t)}e.setCell(t)}}},setCursorCells:function(e){var t=true;var i=this.editor.currentTile.rotX;var r=this.editor.currentTile.rotY;var a=this.editor.currentTile.rotZ;var s=false;var o=this.editor.currentTile.characters;var l=this.editor.currentTile.cells;var n=this.editor.currentTile.useCells&&l!=null;var h=this.cursor.position.x;var d=this.cursor.position.y;var c=0;var f=this.editor.layers.getSelectedLayer();if(f.type!="grid"){}f=this.editor.layers.getLayerObject(f.layerId);var u={};u.fc=this.editor.currentTile.color;u.bc=this.editor.currentTile.bgColor;u.fh=0;u.fv=0;if(this.editor.currentTile.flipH){u.fh=1}if(this.editor.currentTile.flipV){u.fv=1}u.update=false;if(f.getBlockModeEnabled()){u.b=this.editor.currentTile.blockId;if(this.editor.tools.drawTools.tool!="block"){u.b=false}}var p=0;var v=0;if(n){if(typeof l=="undefined"||l.length==0){return}v=l.length;p=l[0].length}else{if(typeof o=="undefined"||o.length==0){return}v=o.length;p=o[0].length}if(typeof e!="undefined"){if(typeof e.update!="undefined"){t=e.update}if(typeof e.fh!=="undefined"){u.fh=e.fh}if(typeof e.fv!=="undefined"){u.fv=e.fv}if(typeof e.rz==="undefined"){u.rz=e.rz}if(typeof e.bc!="undefined"){u.bc=e.bc}if(typeof e.useCells!=="undefined"){n=e.useCells}if(typeof e.useTile!="undefined"){s=e.useTile}}var g=f.getGridWidth();var m=f.getGridHeight();for(var y=0;y<v;y++){for(var b=0;b<p;b++){var C=h+b+this.cursor.offset.x;var x=d+y+this.cursor.offset.y;var S=0;var P=f.getCell({x:C,y:x});if(C!==false&&C>=0&&C<g&&x!==false&&x>=0&&x<m){u.x=C;u.y=x;u.z=0;u.update=false;if(n){for(key in l[y][b]){if(key!=="b"){if(l[y][b].hasOwnProperty(key)){u[key]=l[y][b][key]}}}}else{if(s!==false){u.t=s}else{u.t=o[y][b]}if(!this.editor.tools.drawTools.drawCharacter){u.t=P.t;u.rx=P.rx;u.ry=P.ry;u.rz=P.rz;u.fh=P.fh;u.fv=P.fv}if(!this.editor.tools.drawTools.drawColor){u.fc=P.fc}if(!this.editor.tools.drawTools.drawBgColor){u.bc=P.bc}}if(typeof u.t!=="undefined"&&u.t!==false&&u.t!==this.editor.tileSetManager.noTile){f.setCell(u)}this.setMirrorCells(f,u)}}}if(t){if(f.getBlockModeEnabled()&&u.b===false){this.editor.graphic.invalidateAllCells()}this.editor.graphic.redraw()}},setCursorColor:function(e){this.cursor.color=e},setCursorBGColor:function(e){this.cursor.bgColor=e},setCursorCharacter:function(e){this.cursor.character=e},moveCursor:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){return}var r=this.cursor.position.x+e;var a=this.cursor.position.y+t;if(r>=0&&r<i.getGridWidth()&&a>=0&&a<i.getGridHeight()){this.setCursorPosition(r,a)}},setCursor:function(e,t,i,r,a){var s=this.editor.layers.getSelectedLayerObject();if(!s||s.getType()!="grid"){return}if(e<0||t<0||e>=s.getGridWidth()||t>=s.getGridHeight()){return false}if(this.cursor.position.x==e&&this.cursor.position.y==t&&this.cursor.character==i&&this.cursor.color==r&&this.cursor.bgColor==a){return false}if(this.cursor.position.x==e&&this.cursor.position.y==t){this.cursor.character=i;this.cursor.color=r;this.cursor.bgColor=a}else{var o=this.cursor.position.x;var l=this.cursor.position.y;this.cursor.character=i;this.cursor.color=r;this.cursor.bgColor=a;this.setCursorPosition(e,t)}},setTypingCursor:function(e,t,i,r){var a=this.editor.layers.getSelectedLayerObject();if(!a||a.getType()!="grid"){return}if(e<0||t<0||e>=a.getGridWidth()||t>=a.getGridHeight()){return false}if(isNaN(e)||isNaN(t)){return}if(this.typingCursor.position.x==e&&this.typingCursor.position.y==t&&this.typingCursor.color==i&&this.typingCursor.isOn==r){return false}var s=this.editor.graphic.getCurrentFrame();if(this.typingCursor.position.x==e&&this.typingCursor.position.y==t){this.typingCursor.color=i;this.typingCursor.isOn=r}else{var o=this.typingCursor.position.x;var l=this.typingCursor.position.y;this.typingCursor.color=i;this.typingCursor.isOn=r;this.typingCursor.position.x=e;this.typingCursor.position.y=t}},draw:function(e){var t=this.context;var i=this.canvas;var r=this.editor.graphic.getCurrentFrame();var a="visible";var s=true;var o=this.editor.graphic.getGraphicWidth();var l=this.editor.graphic.getGraphicHeight();if(typeof e!="undefined"){if(typeof e.canvas!="undefined"){i=e.canvas;t=i.getContext("2d")}if(typeof e.context!="undefined"){t=e.context}if(typeof e.frame!="undefined"){r=e.frame}if(typeof e.layers!="undefined"){a=e.layers}if(typeof e.clear!=="undefined"){s=e.clear}}if(s){t.clearRect(0,0,i.width,i.height)}for(var n=0;n<this.editor.layers.layers.length;n++){var h=this.editor.layers.layers[n];if((h.visible&&a=="visible"||a=="all"||a==h.layerId)&&(h.type=="grid"||h.type=="image")){if(h.canvas.width!=o||h.canvas.height!=l){h.canvas.width=o;h.canvas.height=l}this.drawLayer({canvas:h.canvas,layerIndex:n,frame:r});var d=1;if(typeof h.opacity!="undefined"){d=h.opacity}t.globalAlpha=d;if(typeof h.compositeOperation!="undefined"){t.globalCompositeOperation=h.compositeOperation}else{t.globalCompositeOperation="source-over"}t.drawImage(h.canvas,0,0)}t.globalAlpha=1;t.globalCompositeOperation="source-over"}},drawFrame:function(e){var t=this.editor.graphic.getCurrentFrame();if(typeof e.frame!="undefined"){t=e.frame}var i=e.canvas;var r=e.context;var a="visible";var s=this.editor.tileSetManager.getCurrentTileSet();var o=this.editor.colorPaletteManager.getCurrentColorPalette();var l=this.editor.graphic.getGraphicWidth();var n=this.editor.graphic.getGraphicHeight();var h=false;if(typeof e.allCells!="undefined"){h=e.allCells}var d=this.editor.layers.isBackgroundVisible();if(typeof e.drawBackground!="undefined"){d=e.drawBackground}var c=true;if(typeof e.updateLayerCanvas!="undefined"){c=e.updateLayerCanvas}var f=false;if(typeof e.animatedTilesOnly!="undefined"){f=e.animatedTilesOnly}if(typeof e.layers!="undefined"){a=e.layers}var u=false;if(typeof e.drawPreviousFrame!="undefined"){u=e.drawPreviousFrame}else{u=this.editor.frames.getShowPrevFrame()}if(l!=i.width||n!=i.height){i.width=l;i.height=n;r=i.getContext("2d")}if(this.effectCanvas==null){this.effectCanvas=document.createElement("canvas")}this.effectCanvas.width=l;this.effectCanvas.height=n;this.effectContext=this.effectCanvas.getContext("2d");if(!c){if(this.tempCanvas==null){this.tempCanvas=document.createElement("canvas")}this.tempCanvas.width=l;this.tempCanvas.height=n;this.tempContext=this.tempCanvas.getContext("2d")}if(typeof t=="undefined"){t=this.editor.graphic.getCurrentFrame()}var p=null;if(u){var v=this.editor.gridView2d;v.setupPreviousFrame();p=v.previousScreen.canvas;this.editor.graphic.invalidateAllCells()}var g={x:0,y:0,width:i.width,height:i.height};if(!h){if(this.editor.graphic.getOnlyViewBoundsDrawn()||f){var m=this.editor.graphic.getViewBounds();g.x=m.x;g.y=m.y;g.width=m.width;g.height=m.height}}r.clearRect(g.x,g.y,g.width,g.height);var i=null;for(var y=0;y<this.editor.layers.layers.length;y++){var b=this.editor.layers.layers[y];if((b.visible&&a=="visible"||a=="all"||a==b.layerId)&&(b.type=="grid"||b.type=="image")){var C=null;i=null;C=this.editor.layers.getLayerObject(b.layerId);var x=d;if(C&&C.isCurrentLayer()&&u){x=false}if(b.type=="grid"){if(c){i=C.getCanvas()}else{i=this.tempCanvas}C.draw({canvas:i,frame:t,allCells:h,drawBackground:x})}else if(b.type=="image"){if(d){if(c){i=C.getCanvas()}else{i=this.tempCanvas}C.draw({canvas:i,frame:t})}}else{}var S=1;if(typeof b.opacity!="undefined"){S=b.opacity}if(false&&y==1){}else{if(C&&C.isCurrentLayer()&&u&&b.type=="grid"){if(d){r.globalAlpha=S;var o=C.getColorPalette();var P=C.getBackgroundColor();if(P!==this.editor.colorPaletteManager.noColor){r.fillStyle="#"+o.getHexString(P);r.fillRect(0,0,i.width,i.height)}}r.globalAlpha=.3;r.drawImage(p,0,0)}r.globalAlpha=S;if(typeof b.compositeOperation!="undefined"){r.globalCompositeOperation=b.compositeOperation}else{r.globalCompositeOperation="source-over"}if(b.type=="grid"||b.type=="image"){if(i){r.drawImage(i,g.x,g.y,g.width,g.height,g.x,g.y,g.width,g.height)}}else{r.drawImage(b.canvas,0,0)}if(C&&C.isCurrentLayer()&&u&&b.type=="image"){r.globalAlpha=.3;r.drawImage(p,0,0)}}if(C.getType()==="grid"){if(C.isCurrentLayer()){var w=this.editor.tools.drawTools.tool;if(w==="rect"||w==="line"||w==="oval"){var I=this.editor.tools.drawTools.shapes.getGrid();if(this.editor.tools.drawTools.shapes.width==C.getGridWidth()&&this.editor.tools.drawTools.shapes.height==C.getGridHeight()){if(this.shapesCanvas===null){this.shapesCanvas=document.createElement("canvas")}var k=C.getCanvas();if(this.shapesCanvas.width!=k.width||this.shapesCanvas.height!=k.height){this.shapesCanvas.width=k.width;this.shapesCanvas.height=k.height}C.draw({canvas:this.shapesCanvas,allCells:true,draw:"shapes"});r.drawImage(this.shapesCanvas,0,0)}}if(b.type=="grid"){if(this.editor.tools.drawTools.select.isActive()){if(!this.editor.tools.drawTools.select.isInPasteMove()){if(this.shapesCanvas===null){this.shapesCanvas=document.createElement("canvas")}var k=C.getCanvas();if(this.shapesCanvas.width!=k.width||this.shapesCanvas.height!=k.height){this.shapesCanvas.width=k.width;this.shapesCanvas.height=k.height}C.draw({canvas:this.shapesCanvas,allCells:true,draw:"selection",frame:t});r.drawImage(this.shapesCanvas,0,0)}}if(this.editor.tools.drawTools.select.isInPasteMove()){this.editor.tools.drawTools.select.drawClipboardImage(r)}var M=this.editor.tools.drawTools.pixelSelect;if(M.isActive()){var T=M.getSelection();if(T.maxX>T.minX&&T.maxY>T.minY){var D=C.getHeight();M.drawSelection();var E=T.minX;var $=T.minY;var _=T.maxX-T.minX;var B=T.maxY-T.minY;var R=T.minX+M.selectionOffsetX;var A=T.minY+M.selectionOffsetY;r.drawImage(M.canvas,E,$,_,B,R,A,_,B)}}if(M.isInPasteMove()){M.drawPastedPixels();var E=0;var $=0;var _=M.getPasteWidth();var B=M.getPasteHeight();var R=M.pasteOffsetX;var A=M.pasteOffsetY;r.drawImage(M.canvas,E,$,_,B,R,A,_,B)}}}}}r.globalAlpha=1;r.globalCompositeOperation="source-over"}},getThumbnailCanvas:function(){var e=90;var t=90;if(this.thumbnailCanvas==null){this.thumbnailCanvas=document.createElement("canvas")}this.thumbnailCanvas.width=e;this.thumbnailCanvas.height=t;var i=this.thumbnailCanvas.getContext("2d");i.imageSmoothingEnabled=false;i.webkitImageSmoothingEnabled=false;i.mozImageSmoothingEnabled=false;i.msImageSmoothingEnabled=false;i.oImageSmoothingEnabled=false;var r=86;var a=86;var s=e;var o=t;if(this.canvas.width>this.canvas.height){s=r;o=this.canvas.height*(s/this.canvas.width)}else{o=a;s=this.canvas.width*(o/this.canvas.height)}var l=(e-s)/2;var n=(t-o)/2;var h=this.editor.colorPaletteManager.getCurrentColorPalette();i.clearRect(0,0,e,t);i.fillStyle="#040404";i.fillRect(0,0,e,t);i.drawImage(this.canvas,l,n,s,o);return this.thumbnailCanvas},update:function(e){if(g_newSystem){console.error("shouldnt get here update in grid2d!!!")}var t=this.editor.graphic.getCurrentFrame();var i=false;var r=this.editor.layers.isBackgroundVisible();var a=this.editor.frames.getShowPrevFrame();var s=false;if(typeof e!="undefined"){if(typeof e.frame!="undefined"){t=e.frame}if(typeof e.allCells!="undefined"){i=e.allCells}if(typeof e.drawBackground!="undefined"){r=e.drawBackground}if(typeof e.drawPreviousFrame!="undefined"){a=e.drawPreviousFrame}if(typeof e.animatedTilesOnly!="undefined"){s=e.animatedTilesOnly}}if(i){}var o=this.editor.graphic.getFrameCount();this.drawFrame({frame:t,canvas:this.canvas,context:this.context,allCells:i,drawBackground:r,drawPreviousFrame:a,animatedTilesOnly:s})}};var Grid3d=function(){this.editor=null;this.scene=null;this.lastCellSetX=false;this.lastCellSetY=false;this.lastCellSetZ=false;this.frames=[];this.currentFrame=false;this.frameCount=0;this.layers=[];this.shapes=null;this.selection=null;this.currentLayer=null;this.backgroundColorIndex=0;this.backgroundColorRGB=3355443;this.doc=null};Grid3d.prototype={init:function(e){this.editor=e},initScene:function(){this.scene=new THREE.Scene;console.log("create shapes 3d");this.shapes=new Shapes3d;this.shapes.init(this.editor,this.scene);this.selection=new Select3d;this.selection.init(this.editor);this.initLights()},initLights:function(){var e=new THREE.DirectionalLight(657930,1);e.position.set(-800,400,-1500);e.target.position.set(0,0,0);e.castShadow=false;this.scene.add(e);var e=new THREE.AmbientLight(5592405);this.scene.add(e);var e=new THREE.DirectionalLight(16777215,1);e.position.set(1e3,1e3,1500);e.target.position.set(0,0,0);e.castShadow=false;this.scene.add(e)},createDoc:function(e,s){var o=g_app.doc;var l=e.name;var n=e.gridWidth;var h=e.gridHeight;var d=e.gridDepth;if(typeof d=="undefined"){d=25}var c="/3d scene";if(typeof e.parentPath!="undefined"){c=e.parentPath}var l=e.name;var f=g_app.getGuid();var t=this;var i={};if(typeof e.tileSetArgs!="undefined"){i=e.tileSetArgs}else if(typeof e.tileSet!="undefined"){i.preset=e.tileSet}if(typeof e.tileSetId!="undefined"&&e.tileSetId!=""){i.tileSetId=e.tileSetId}var r={};r.preset=e.colorPalette;if(typeof e.colorPaletteId!="undefined"&&e.colorPaletteId!=""){r.colorPaletteId=e.colorPaletteId}var u=TextModeEditor.Mode.TEXTMODE;var p=8;var v=8;var g=8;this.editor.colorPaletteManager.addColorPaletteToDoc(r,function(a){t.editor.tileSetManager.addTileSetToDoc(i,function(e){var t={label:"Layer 0",visible:true,opacity:1,layerId:g_app.getGuid(),screenMode:u,colorPerMode:"cell",cellWidth:p,cellHeight:v,cellDepth:g,colorPaletteId:a,tileSetId:e,type:"grid3d",gridWidth:n,gridHeight:h,gridDepth:d,frames:[{data:null}]};var i={id:f,frames:[{duration:12}],layers:[t]};var r=o.createDocRecord(c,l,"3d scene",i,f);if(typeof s!="undefined"){s(r)}})})},connectToDoc:function(){var e=this.editor.doc;console.log("CONNECT TO DOC");console.log(e);if(e.data.frames==null){e.data.frames=[]}if(this.doc!==null&&this.doc.id===e.id){console.log("already connected to doc");return}this.doc=e;this.frames=e.data.frames;this.frameCount=this.frames.length;if(this.scene==null){this.initScene()}if(this.layers.length!=0){for(var t=0;t<this.layers.length;t++){this.layers[t].remove()}}this.layers=[];if(this.layers.length==0){var i=this.doc.data.layers;for(var t=0;t<i.length;t++){var r=new Grid3dLayer;r.init(this.editor,i[t].layerId,this.scene);this.layers.push(r)}}this.setCurrentLayer(this.layers[0]);this.currentFrame=false;if(this.frameCount==0){this.setFrameCount(1)}this.setCurrentFrame(0)},setCurrentLayer:function(e){console.error("grid3d: set current layer!");this.currentLayer=e;var t=this.currentLayer.getTileSet();if(t){this.editor.tileSetManager.setCurrentTileSetFromId(t.getId());t.generate3dGeometries()}var i=this.getColorPalette();if(i){this.editor.colorPaletteManager.setCurrentColorPaletteFromId(i.getId())}this.editor.tileSetManager.updateTileSetMenu();this.editor.colorPaletteManager.updateColorPaletteMenu();this.editor.setInterfaceScreenMode(this.getScreenMode());this.editor.setInterfaceColorPerMode(this.getColorPerMode());this.currentLayer.createGrid()},setBackgroundColor:function(e){this.backgroundColorIndex=e;var t=this.getColorPalette();this.backgroundColorRGB=t.getHex(e);var i="#"+t.getHexString(e);$("#background3dColor").css("background-color",i)},getBackgroundColorRGB:function(){return this.backgroundColorRGB},setGridVisible:function(e){this.currentLayer.setGridVisible(e)},getGridVisible:function(){return this.currentLayer.getGridVisible()},getXYGridVisible:function(){return this.currentLayer.getXYGridVisible()},getXZGridVisible:function(){return this.currentLayer.getXZGridVisible()},setXYGridVisible:function(e){this.currentLayer.setXYGridVisible(e)},setXZGridVisible:function(e){this.currentLayer.setXZGridVisible(e)},toggleGrid:function(){this.currentLayer.toggleGrid()},getXZPosition:function(){return this.currentLayer.xzPosition},setXZPosition:function(e){this.currentLayer.setXZPosition(e)},getXYPosition:function(){return this.currentLayer.getXYPosition()},setXYPosition:function(e){this.currentLayer.setXYPosition(e)},showOnlyXY:function(e){this.currentLayer.showOnlyXY(e)},showOnlyXZ:function(){this.currentLayer.showOnlyXZ()},showAll:function(e){this.currentLayer.showAll(e)},setTypingCursorMeshVisible:function(e){if(this.currentLayer!=null&&this.currentLayer.typingCursorMesh!==null){this.currentLayer.typingCursorMesh.visible=e}},setTypingCursorPosition:function(e,t,i){this.currentLayer.setTypingCursorPosition(e,t,i)},setCursorRotation:function(e,t,i){this.currentLayer.setCursorRotation(e,t,i)},setCursorPosition:function(e,t,i){this.currentLayer.setCursorPosition(e,t,i)},setCursorEnabled:function(e){this.currentLayer.setCursorEnabled(e)},getCursorX:function(){return this.currentLayer.getCursorX()},getCursorY:function(){return this.currentLayer.getCursorY()},getCursorZ:function(){return this.currentLayer.getCursorZ()},getCursorEnabled:function(){if(this.currentLayer!=null){return this.currentLayer.getCursorEnabled()}return false},setCursorColor:function(e){this.currentLayer.setCursorColor(e)},setCursorTile:function(e){if(this.currentLayer!=null){this.currentLayer.setCursorTile(e)}},getCell:function(e,t,i,r){return this.currentLayer.getCell(e,t,i,r)},getCellMesh:function(e,t,i,r){return this.currentLayer.getCellMesh(e,t,i,r)},setCellFromCursor:function(){this.currentLayer.setCellFromCursor()},getColorPerMode:function(){return"cell"},getScreenMode:function(){return this.currentLayer.getScreenMode()},getTileSetId:function(){return this.currentLayer.getTileSetId()},setTileSet:function(e){return this.currentLayer.setTileSet(e)},getTileSet:function(){return this.currentLayer.getTileSet()},setColorPalette:function(e){return this.currentLayer.setColorPalette(e)},getColorPalette:function(){return this.currentLayer.getColorPalette()},getScene:function(){return this.scene},getHolder:function(){return this.currentLayer.getHolder()},getCellSizeX:function(){return this.currentLayer.cellSizeX},getCellSizeY:function(){return this.currentLayer.cellSizeY},getCellSizeZ:function(){return this.currentLayer.cellSizeZ},getGridWidth:function(){return this.currentLayer.getGridWidth()},getGridHeight:function(){return this.currentLayer.getGridHeight()},getGridDepth:function(){return this.currentLayer.getGridDepth()},clearFrame:function(e){this.currentLayer.clearFrame(e)},getFrameCount:function(){return this.frameCount},getFrameDuration:function(e){return this.frames[e].duration},setFrameDuration:function(e,t){var i=this.currentFrame;if(typeof t!=="undefined"){i=t}if(i<0||i>=this.frameCount){return}this.frames[i].duration=e},getCurrentLayer:function(){return this.currentLayer},getCurrentFrame:function(){return this.currentFrame},setCurrentFrame:function(e){if(e===this.currentFrame){return}if(e>this.frameCount||e<0){return false}for(var t=0;t<this.layers.length;t++){this.layers[t].setCurrentFrame(e)}this.currentFrame=e},insertFrame:function(e,t,i,r){if(typeof e=="undefined"){e=this.currentFrame}if(typeof t=="undefined"){t=this.frames[this.currentFrame].duration}var a=i;if(typeof a=="undefined"){a={duration:t}}this.frames.splice(e+1,0,a);for(var s=0;s<this.layers.length;s++){this.layers[s].insertFrame(e,t)}this.frameCount++;this.editor.history.startEntry("insertframe");this.editor.history.addAction("insertframe",{position:e});this.editor.history.endEntry();return e+1},deleteFrame:function(e){if(typeof e=="undefined"){e=this.currentFrame}if(this.frameCount<=1){return false}var t=this.frames.splice(e,1);var i=[];for(var r=0;r<this.layers.length;r++){this.layers[r].deleteFrame(e)}var a=this.frameCount-1;this.setFrameCount(a);return true},duplicateFrame:function(e){if(typeof e=="undefined"){e=this.currentFrame}var t=e+1;this.editor.history.startEntry("Duplicate3d");this.editor.history.setNewEntryEnabled(false);this.insertFrame(e);this.setCurrentFrame(t);for(var i=0;i<this.layers.length;i++){this.layers[i].duplicateFrame(e,t)}this.editor.history.setNewEntryEnabled(true);this.editor.history.endEntry();this.editor.grid.update();return t},setFrameCount:function(e){while(e>this.frames.length){this.frames.push({duration:12})}if(e<this.frameCount){this.frames.length=e}for(var t=0;t<this.layers.length;t++){this.layers[t].setFrameCount(e)}this.frameCount=e},setCell:function(e){this.currentLayer.setCell(e)},update:function(){var e=getTimestamp();var t=this.editor.tools.drawTools.tool}};function disposeArray(){this.array=null}var Grid3dLayer=function(){this.editor=null;this.layerId="";this.scene=null;this.pixelTo3dUnits=.25;this.pixelSizeX=1;this.pixelSizeY=1;this.pixelSizeZ=1;this.cellSizeX=1;this.cellSizeY=1;this.cellSizeZ=1;this.xyMesh=null;this.xzMesh=null;this.zyMesh=null;this.xyLineMaterial=null;this.cursorMesh=null;this.cursorMeshMaterial=null;this.typingCursorMesh=null;this.typingCursorMeshMaterial=null;this.lastTypingBlink=0;this.cursorX=0;this.cursorY=0;this.cursorZ=0;this.cursorRotX=0;this.cursorRotY=0;this.cursorRotZ=0;this.cursorColor=0;this.cursorTileIndex=false;this.cursorEnabled=true;this.cubeMesh=null;this.floor=null;this.frames=[];this.meshFrames=[];this.currentFrame=false;this.frameCount=0;this.changingGridData=false;this.selection=null;this.gridData=[];this.gridMeshes=[];this.holder=null;this.backingMaterialColor=16777215;this.backingMaterialOpacity=.5};Grid3dLayer.prototype={init:function(e,t,i){this.editor=e;this.scene=i;this.layerId=t;this.connectToDoc({layerId:t})},removeAllTileMeshes:function(e){var t=this.meshFrames[e].holder;while(t.children.length>0){var i=t.children[0];while(i.children.length>0){i.remove(i.children[0])}t.remove(i)}var r=this.meshFrames[e].data;for(var a=0;a<r.length;a++){for(var s=0;s<r[a].length;s++){for(var o=0;o<r[a][s].length;o++){if(r[a][s][o].mesh){r[a][s][o].mesh.box=null;r[a][s][o].mesh=null}}}}},remove:function(){console.log("REMOVE LAYER!!!");this.xyMesh.remove(this.xyGrid);this.scene.remove(this.xyMesh);this.xyGrid=null;this.xyMesh=null;this.xzMesh.remove(this.xzGrid);this.scene.remove(this.xzMesh);for(var e=0;e<this.meshFrames.length;e++){this.removeAllTileMeshes(e);this.scene.remove(holder);this.meshFrames[e].holder=null}},connectToDoc:function(e){console.log("CONNECT TO DOC!!!!!!!!!!!");var t=null;if(typeof e!="undefined"){if(typeof e.doc!="undefined"){t=e.doc}if(typeof e.layerId!="undefined"){this.layerId=e.layerId}if(typeof e.editor!="undefined"){this.editor=e.editor}}if(t==null){t=this.editor.doc}var i=t.data.layers;for(var r=0;r<i.length;r++){if(i[r].layerId==this.layerId){if(typeof i[r].frames=="undefined"){i[r].frames=[]}this.frames=i[r].frames;this.meshFrames=[];this.createMeshFrames();this.doc=i[r];this.frameCount=this.frames.length;if(typeof this.doc.colorPerMode=="undefined"){this.doc.colorPerMode="cell"}if(typeof this.doc.screenMode=="undefined"){this.doc.screenMode=TextModeEditor.Mode.TEXTMODE}}}this.createMeshes()},createMeshes:function(){var e=8;var t=8;var i=8;this.cellSizeX=e*1*this.pixelTo3dUnits;this.cellSizeY=t*1*this.pixelTo3dUnits;this.cellSizeZ=i*1*this.pixelTo3dUnits;var r=this.getTileSet();var a=this.getColorPalette();for(var s=0;s<this.frames.length;s++){var o=this.frames[s].data;if(this.meshFrames[s].data==null){this.initMeshFrameData(s)}this.gridMeshes=this.meshFrames[s].data;var l=this.meshFrames[s].holder;var n=this.getGridWidth();var h=this.getGridHeight();var d=this.getGridDepth();var c={};for(var f in o){var u=o.hasOwnProperty(f);if(u){c=o[f];var p=c.x;var v=c.y;var g=c.z;var m=c.t;if(p<0||p>=n||v<0||v>=h||g<0||g>=d){continue}var y=null;y=this.gridMeshes[g][v][p];if(y&&typeof y.mesh!="undefined"&&y.mesh!=null){while(y.mesh.children.length>0){y.remove(y.mesh.children[0])}this.holder.remove(y.mesh);if(y.mesh.box){y.mesh.box=null}y.mesh=null}if(c.t==this.editor.tileSetManager.noTile){}else{var b=null;if(c.bc==this.editor.colorPaletteManager.noColor&&c.bc!==false){var C=r.getGeometry(c.t);var x=a.getMaterial(c.fc);if(typeof C=="undefined"){console.log("no geometry!!!!");continue}b=new THREE.Mesh(C,x)}else{var C=r.getGeometry(c.t);var S=r.getBackgroundGeometry(c.t);var x=a.getMaterial(c.fc);var P=a.getMaterial(c.bc);if(typeof C=="undefined"||typeof S=="undefined"){console.log("no geometry!!!!");continue}b=new THREE.Mesh(S,P);fgMesh=new THREE.Mesh(C,x);b.add(fgMesh)}var w=p*this.cellSizeX+this.cellSizeX/2;var I=v*this.cellSizeY+this.cellSizeY/2;var k=g*this.cellSizeZ+this.cellSizeZ/2;b.rotation.order="YXZ";b.rotation.x=c.rx*Math.PI*2;b.rotation.y=c.ry*Math.PI*2;b.rotation.z=c.rz*Math.PI*2;b.position.x=w;b.position.y=I;b.position.z=k;b.originalPosition={};b.originalPosition.x=w;b.originalPosition.y=I;b.originalPosition.z=k;b.gridX=p;b.gridY=v;b.gridZ=g;b.box=new THREE.Box3(new THREE.Vector3(w-this.cellSizeX/2,I-this.cellSizeY/2,k-this.cellSizeZ/2),new THREE.Vector3(w+this.cellSizeX/2,I+this.cellSizeY/2,k+this.cellSizeZ/2));b.box.gridPosition=new THREE.Vector3(p,v,g);b.castShadow=true;b.receiveShadow=true;y.mesh=b;l.add(b)}}}}},createMeshFrames:function(){this.meshFrames=[];for(var e=0;e<this.frames.length;e++){var t=new THREE.Object3D;t.visible=false;this.meshFrames.push({data:null,holder:t})}},getCellMesh:function(e,t,i,r){var a=this.currentFrame;if(typeof r!="undefined"){a=r}if(a>=0&&a<this.meshFrames.length){if(!this.meshFrames[a].data){return null}return this.meshFrames[a].data[i][t][e].mesh}return null},getCell:function(e,t,i,r){var a=this.currentFrame;if(typeof r!="undefined"){a=r}if(a>=0&&a<this.frames.length){var s=this.frames[a].data;var o=e+","+t+","+i;if(s.hasOwnProperty(o)){return s[o]}}return{t:this.editor.tileSetManager.noTile,fc:0,bc:this.editor.colorPaletteManager.noColor,rx:0,ry:0,rz:0}},createGrid:function(){console.log("create grid");var e=this.scene;var t=8;var i=8;var r=8;this.cellSizeX=t*1*this.pixelTo3dUnits;this.cellSizeY=i*1*this.pixelTo3dUnits;this.cellSizeZ=r*1*this.pixelTo3dUnits;var a=this.editor.tileSetManager.getCurrentTileSet();if(a){t=a.charWidth;i=a.charHeight;r=a.charDepth;this.cellSizeX=t*a.pixelWidth*this.pixelTo3dUnits;this.cellSizeY=i*a.pixelHeight*this.pixelTo3dUnits;this.cellSizeZ=r*a.pixelDepth*this.pixelTo3dUnits}this.planes=[];if(this.xyMesh){e.remove(this.xyMesh);this.xyMesh=null}if(this.xzMesh){e.remove(this.xzMesh);this.xzMesh=null}if(this.zyMesh){e.remove(this.zyMesh);this.zyMesh=null}var s=this.getGridWidth();var o=this.getGridHeight();var l=this.getGridDepth();this.xyLineMaterial=new THREE.LineBasicMaterial({color:3487029,transparent:false,opacity:.5});this.xzLineMaterial=new THREE.LineBasicMaterial({color:3487029,transparent:false,opacity:.5});this.xyMesh=new THREE.Object3D;this.xyGrid=new THREE.Object3D;this.xyMesh.add(this.xyGrid);e.add(this.xyMesh);console.log("create vertical lines");for(var n=0;n<=s;n++){var h=new THREE.BufferGeometry;var d=[];d.push(this.cellSizeX*n,0,0);d.push(this.cellSizeX*n,o*this.cellSizeY,0);h.setAttribute("position",new THREE.Float32BufferAttribute(d,3).onUpload(disposeArray));var c=new THREE.Line(h,this.xyLineMaterial);this.xyGrid.add(c)}for(var n=0;n<=o;n++){var h=new THREE.BufferGeometry;var d=[];d.push(0,n*this.cellSizeY,0);d.push(s*this.cellSizeX,n*this.cellSizeY,0);h.setAttribute("position",new THREE.Float32BufferAttribute(d,3).onUpload(disposeArray));var c=new THREE.Line(h,this.xyLineMaterial);this.xyGrid.add(c)}var h=new THREE.PlaneGeometry(s*this.cellSizeX,o*this.cellSizeY);this.xyGridBackingMaterial=new THREE.MeshBasicMaterial({color:this.backingMaterialColor,transparent:true,opacity:this.backingMaterialOpacity,side:THREE.DoubleSide});this.xyGridBacking=new THREE.Mesh(h,this.xyGridBackingMaterial);this.xyGridBacking.position.z=-.05;this.xyGridBacking.position.x=s*this.cellSizeX/2;this.xyGridBacking.position.y=o*this.cellSizeY/2;this.xyGridBacking.gridPlane="xy";this.xyMesh.add(this.xyGridBacking);this.planes.push(this.xyGridBacking);this.xzMesh=new THREE.Object3D;this.xzGrid=new THREE.Object3D;this.xzMesh.add(this.xzGrid);e.add(this.xzMesh);for(var n=0;n<=s;n++){var h=new THREE.BufferGeometry;var d=[];d.push(this.cellSizeX*n,0,0);d.push(this.cellSizeX*n,0,l*this.cellSizeZ);h.setAttribute("position",new THREE.Float32BufferAttribute(d,3).onUpload(disposeArray));var c=new THREE.Line(h,this.xzLineMaterial);this.xzGrid.add(c)}for(var n=0;n<=l;n++){var h=new THREE.BufferGeometry;d=[];d.push(0,0,n*this.cellSizeZ);d.push(s*this.cellSizeX,0,n*this.cellSizeZ);h.setAttribute("position",new THREE.Float32BufferAttribute(d,3).onUpload(disposeArray));var c=new THREE.Line(h,this.xzLineMaterial);this.xzGrid.add(c)}var h=new THREE.PlaneGeometry(s*this.cellSizeX,l*this.cellSizeZ);this.xzGridBackingMaterial=new THREE.MeshBasicMaterial({color:this.backingMaterialColor,transparent:true,opacity:this.backingMaterialOpacity,side:THREE.DoubleSide});this.xzGridBacking=new THREE.Mesh(h,this.xzGridBackingMaterial);this.xzGridBacking.rotation.x=-Math.PI/2;this.xzGridBacking.position.y=-.1;this.xzGridBacking.position.x=s*this.cellSizeX/2;this.xzGridBacking.position.z=l*this.cellSizeZ/2;this.xzGridBacking.gridPlane="xz";this.xzMesh.add(this.xzGridBacking);this.planes.push(this.xzGridBacking);this.setXYPosition(Math.floor(l/2));this.setXZPosition(0);$("#gridXYPosition").attr("max",l);$("#gridXZPosition").attr("max",o)},toggleGrid:function(){if(this.xzMesh.visible||this.xyMesh.visible){this.xzMesh.visible=true;this.xyMesh.visible=true}else{this.xzMesh.visible=false;this.xyMesh.visible=false}},setGridVisible:function(e){this.xzMesh.visible=e;this.xyMesh.visible=e},getGridVisible:function(){return this.xzMesh.visible||this.xyMesh.visible},getXYGridVisible:function(){return this.xyMesh.visible},getXZGridVisible:function(){return this.xzMesh.visible},setXYGridVisible:function(e){this.xyMesh.visible=e},setXZGridVisible:function(e){this.xzMesh.visible=e},getXZPosition:function(){return this.xzPosition},setXZPosition:function(e){if(e<0||e>=this.getGridHeight()){return}$("#gridXZPosition").val(e);this.xzPosition=e;this.xzMesh.position.y=this.xzPosition*this.cellSizeY},getXYPosition:function(){return this.xyPosition},setXYPosition:function(e){if(e<0||e>=this.getGridDepth()){return}$("#gridXYPosition").val(e);this.xyPosition=e;this.xyMesh.position.z=this.xyPosition*this.cellSizeZ},showOnlyXY:function(e){if(!this.gridMeshes||this.changingGridData){return}var t="";if(typeof e!="undefined"){if(e.behind){t="behind"}if(e.front){t="front"}}var i=this.getGridDepth();var r=this.getGridHeight();var a=this.getGridWidth();for(var s=0;s<i;s++){for(var o=0;o<r;o++){for(var l=0;l<a;l++){if(this.gridMeshes[s][o][l].mesh){if(t=="behind"){this.gridMeshes[s][o][l].mesh.visible=s<=this.xyPosition}else if(t=="front"){this.gridMeshes[s][o][l].mesh.visible=s>=this.xyPosition}else{this.gridMeshes[s][o][l].mesh.visible=s==this.xyPosition}}}}}},showOnlyXZ:function(){if(!this.gridMeshes||this.changingGridData){return}var e=this.getGridDepth();var t=this.getGridHeight();var i=this.getGridWidth();for(var r=0;r<e;r++){for(var a=0;a<t;a++){for(var s=0;s<i;s++){if(this.gridMeshes[r][a][s].mesh){this.gridMeshes[r][a][s].mesh.visible=a==this.xzPosition}}}}},showAll:function(e){if(!this.gridMeshes||this.changingGridData){return}if(typeof showAll=="undefined"){e=true}var t=this.getGridDepth();var i=this.getGridHeight();var r=this.getGridWidth();for(var a=0;a<t;a++){for(var s=0;s<i;s++){for(var o=0;o<r;o++){if(this.gridMeshes[a][s][o].mesh){this.gridMeshes[a][s][o].mesh.visible=e}}}}},setTypingCursorPosition:function(e,t,i){if(this.typingCursorMesh==null){var r=new THREE.BoxGeometry(this.cellSizeX*1.01,this.cellSizeY*1.01,this.cellSizeZ*1.01);this.typingCursorMeshMaterial=new THREE.MeshPhongMaterial({color:16777215,specular:0,shininess:0,transparent:true,opacity:.8});this.typingCursorMeshMaterial.flatShading=true;this.typingCursorMesh=new THREE.Mesh(r,this.typingCursorMeshMaterial);this.scene.add(this.typingCursorMesh)}this.typingCursorMesh.position.x=e*this.cellSizeX+this.cellSizeX/2;this.typingCursorMesh.position.y=t*this.cellSizeY+this.cellSizeY/2;this.typingCursorMesh.position.z=i*this.cellSizeZ+this.cellSizeZ/2},setCursorRotation:function(e,t,i){if(this.cursorMesh==null){return}this.cursorRotX=e;this.cursorRotY=t;this.cursorRotZ=i;this.cursorMesh.rotation.x=e*Math.PI*2;this.cursorMesh.rotation.y=t*Math.PI*2;this.cursorMesh.rotation.z=i*Math.PI*2},setCursorPosition:function(e,t,i){this.cursorX=e;this.cursorY=t;this.cursorZ=i;if(this.cursorMesh!=null){this.cursorMesh.position.x=e*this.cellSizeX+this.cellSizeX/2;this.cursorMesh.position.y=t*this.cellSizeY+this.cellSizeY/2;this.cursorMesh.position.z=i*this.cellSizeZ+this.cellSizeZ/2}if(g_app.isMobile()){this.cursorMesh.visible=false}},getCursorX:function(){return this.cursorX},getCursorY:function(){return this.cursorY},getCursorZ:function(){return this.cursorZ},setCursorEnabled:function(e){this.cursorEnabled=e;if(g_app.isMobile()){this.cursorMesh.visible=false}else{if(this.cursorMesh){this.cursorMesh.visible=e}}},getCursorEnabled:function(){return this.cursorEnabled},setCursorColor:function(e){this.cursorColor=e;var t=this.getColorPalette();var i=t.getHex(e);if(this.cursorMeshMaterial){this.cursorMeshMaterial.color.set(i)}},setCursorTile:function(e){if(this.cursorMesh!=null&&this.cursorTileIndex===e){return}if(this.cursorMesh){this.scene.remove(this.cursorMesh);this.cursorMesh=null}var t=this.getTileSet();var i=this.getColorPalette();var r=null;if(e==this.editor.tileSetManager.noTile){if(this.cubeMesh==null){var r=new THREE.BoxGeometry(this.cellSizeX*1.01,this.cellSizeY*1.01,this.cellSizeZ*1.01);var a=new THREE.MeshPhongMaterial({color:16777215,specular:0,shininess:0,transparent:true,opacity:.4});a.flatShading=true;this.cubeMesh=new THREE.Mesh(r,a)}this.cursorMesh=this.cubeMesh}else{var r=t.getGeometry(e);if(this.cursorMeshMaterial==null){var s=this.editor.currentTile.getColor();var o=i.getHex(s);this.cursorMeshMaterial=new THREE.MeshPhongMaterial({color:o,specular:0,shininess:0,transparent:true,opacity:.6});this.cursorMeshMaterial.flatShading=true}this.cursorMesh=new THREE.Mesh(r,this.cursorMeshMaterial);this.cursorMesh.rotation.order="YXZ";this.cursorMesh.castShadow=false}this.setCursorPosition(this.cursorX,this.cursorY,this.cursorZ);this.setCursorRotation(this.cursorRotX,this.cursorRotY,this.cursorRotZ);this.scene.add(this.cursorMesh);this.cursorTileIndex=e},setCellFromCursor:function(){var e=this.editor.tools.drawTools;if(!this.cursorEnabled){return}var t={};t.x=this.cursorX;t.y=this.cursorY;t.z=this.cursorZ;t.t=this.cursorTileIndex;t.fc=this.editor.currentTile.getColor();t.bc=this.editor.currentTile.getBGColor();var i=this.editor.tools.drawTools.tool;if(i=="erase"){t.t=this.editor.tileSetManager.noTile}else{var r=this.getCell(t.x,t.y,t.z);if(!e.drawCharacter){t.t=r.t}if(!e.drawColor){t.fc=r.fc}if(!e.drawBGColor){t.bc=r.bc}}this.setCell(t);var a=this.editor.grid3d;a.lastCellSetX=t.x;a.lastCellSetY=t.y;a.lastCellSetZ=t.z},getColorPerMode:function(){return"cell"},getScreenMode:function(){return TextModeEditor.Mode.TEXTMODE},getTileSetId:function(){return this.doc.tileSetId},setTileSet:function(e){this.doc.tileSetId=e;this.editor.modified();this.editor.tileSetManager.setCurrentTileSetFromId(e);for(var t=0;t<this.frames.length;t++){this.removeAllTileMeshes(t)}this.createMeshes();var i=this.currentFrame;this.currentFrame=false;this.setCurrentFrame(i)},getTileSet:function(){if(this.doc.tileSetId){return this.editor.tileSetManager.getTileSet(this.doc.tileSetId)}return null},setColorPalette:function(e){this.doc.colorPaletteId=e},getColorPalette:function(){var e=null;if(this.doc.colorPaletteId){return this.editor.colorPaletteManager.getColorPalette(this.doc.colorPaletteId)}else{return this.editor.colorPaletteManager.getCurrentColorPalette()}},getScene:function(){return this.scene},getHolder:function(e){if(typeof e=="undefined"){return this.holder}if(e>=0&&e<this.meshFrames.length){return this.meshFrames[e].holder}return null},getGridWidth:function(){return this.doc.gridWidth},getGridHeight:function(){return this.doc.gridHeight},getGridDepth:function(){return this.doc.gridDepth},clearFrame:function(e){},getFrameCount:function(){return this.frameCount},getFrameDuration:function(e){return 12},setFrameDuration:function(e,t){},getCurrentFrame:function(){return this.currentFrame},initMeshFrameData:function(e){if(e>this.frameCount||e<0){return false}var t=this.getGridWidth();var i=this.getGridHeight();var r=this.getGridDepth();var a=[];for(var s=0;s<r;s++){a[s]=[];for(var o=0;o<i;o++){a[s][o]=[];for(var l=0;l<t;l++){a[s][o][l]={mesh:null}}}}this.meshFrames[e].data=a},initFrameData:function(e){if(e>this.frameCount||e<0){return false}this.frames[e].data={}},setCurrentFrame:function(e){if(e===this.currentFrame){return}if(e>this.frameCount||e<0){return false}if(this.frames[e].data==null){this.initFrameData(e)}if(this.meshFrames[e].data==null){this.initMeshFrameData(e)}this.changingGridData=true;if(this.holder){this.scene.remove(this.holder);this.holder.visible=false}this.holder=this.meshFrames[e].holder;this.holder.visible=true;this.scene.add(this.holder);this.currentFrame=e;this.gridMeshes=this.meshFrames[e].data;this.gridData=this.frames[e].data;this.changingGridData=false},deleteFrame:function(e){if(typeof e=="undefined"){e=this.currentFrame}if(this.frames.length<=1){return false}var t=this.frames.splice(e,1);var i=this.meshFrames.splice(e,1);var r=i[0].data;var a=i[0].holder;while(a.children.length>0){a.remove(a.children[0])}for(var s=0;s<r.length;s++){for(var o=0;o<r[s].length;o++){for(var l=0;l<r[s][o].length;l++){if(r[s][o][l].mesh){r[s][o][l].mesh.box=null;r[s][o][l].mesh=null}r[s][o][l]=null}}}this.scene.remove(a);i.holder=null;console.log("NEED TO CLEAR MESH FRAME DATA!!!!!!");var n=this.frameCount-1;this.setFrameCount(n)},insertFrame:function(e,t){if(typeof t=="undefined"){t=12}var i={data:null};this.frames.splice(e+1,0,i);var r=new THREE.Object3D;r.castShadow=true;r.receiveShadow=true;var a={data:null,holder:r};this.meshFrames.splice(e+1,0,a);this.frameCount++;return e+1},duplicateFrame:function(e,t){if(e<0||e>=this.frames.length||t<0||t>=this.frames.length){return}var i=this.getGridWidth();var r=this.getGridHeight();var a=this.getGridDepth();var s=this.editor.tileSetManager.noTile;var o={};o.z=0;for(o.z=0;o.z<a;o.z++){for(o.y=0;o.y<r;o.y++){for(o.x=0;o.x<i;o.x++){var l=this.getCell(o.x,o.y,o.z,e);if(l.t!==s&&l.t!==false){for(var n in l){if(l.hasOwnProperty(n)){o[n]=l[n]}}o.frame=t;o.update=false;console.log(o);this.setCell(o)}}}}},setFrameCount:function(e){while(e>this.frames.length){var t=new THREE.Object3D;t.visible=false;this.frames.push({data:null});this.meshFrames.push({data:null,holder:t})}if(e<this.frameCount){for(var i=e;i<this.frameCount;i++){this.clearFrame(i)}}this.frameCount=e},setCell:function(e){if(typeof e.t=="undefined"){return}var t=this.currentFrame;if(typeof e.frame!="undefined"){t=e.frame}var i=e.x;var r=e.y;var a=e.z;var s=e.t;var o=false;if(typeof e.b!=="undefined"){o=e.b}var l=this.editor.currentTile.color;if(typeof e.fc!=="undefined"){l=e.fc}var n=this.editor.currentTile.rotX;if(typeof e.rx!=="undefined"){n=e.rx}var h=this.editor.currentTile.rotY;if(typeof e.ry!=="undefined"){h=e.ry}var d=this.editor.currentTile.rotZ;if(typeof e.rz!=="undefined"){d=e.rz}fh=0;if(typeof e.fh!=="undefined"){fh=e.fh}fv=0;if(typeof e.fv!=="undefined"){fv=e.fv}var c=this.getGridWidth();var f=this.getGridHeight();var u=this.getGridDepth();if(i>=c||i<0||r>=f||r<0||a>=u||a<0){return}if(t<0||t>=this.frames.length){return}var p=this.frames[t].data;var v=this.meshFrames[t].data;var g=i+","+r+","+a;var m={t:this.editor.tileSetManager.noTile,rx:0,ry:0,rz:0,fc:0,bc:this.editor.colorPaletteManager.noColor};var y=p.hasOwnProperty(g);if(y){m=p[g]}var b=v[a][r][i];var C=this.editor.currentTile.bgColor;if(typeof e.bc!=="undefined"){C=e.bc}else{if(typeof m.bc!="undefined"){C=m.bc}}if(y){if(m.t===s&&m.fc===l&&m.bc===C&&m.rx==n&&m.ry==h&&m.rz==d){return}}if(b&&typeof b.mesh!="undefined"&&b.mesh!=null){this.holder.remove(b.mesh);b.mesh.box=null;b.mesh=null}if(s==this.editor.tileSetManager.noTile){}else{var x=this.getTileSet();var S=this.getColorPalette();var P=null;if(C==this.editor.colorPaletteManager.noColor&&C!==false){var w=x.getGeometry(s);var I=S.getMaterial(l);if(typeof w=="undefined"){console.log("no geometry!!!!");return}P=new THREE.Mesh(w,I)}else{var w=x.getGeometry(s);var k=x.getBackgroundGeometry(s);var I=S.getMaterial(l);var M=S.getMaterial(C);if(typeof w=="undefined"||typeof k=="undefined"){console.log("no geometry!!!!");return}P=new THREE.Mesh(k,M);fgMesh=new THREE.Mesh(w,I);P.add(fgMesh)}var T=i*this.cellSizeX+this.cellSizeX/2;var D=r*this.cellSizeY+this.cellSizeY/2;var E=a*this.cellSizeZ+this.cellSizeZ/2;P.rotation.order="YXZ";P.rotation.x=n*Math.PI*2;P.rotation.y=h*Math.PI*2;P.rotation.z=d*Math.PI*2;P.position.x=T;P.position.y=D;P.position.z=E;P.originalPosition={};P.originalPosition.x=T;P.originalPosition.y=D;P.originalPosition.z=E;P.gridX=i;P.gridY=r;P.gridZ=a;P.box=new THREE.Box3(new THREE.Vector3(T-this.cellSizeX/2,D-this.cellSizeY/2,E-this.cellSizeZ/2),new THREE.Vector3(T+this.cellSizeX/2,D+this.cellSizeY/2,E+this.cellSizeZ/2));P.box.gridPosition=new THREE.Vector3(i,r,a);P.castShadow=true;P.receiveShadow=true;b.mesh=P;this.holder.add(P)}var $={x:i,y:r,z:a,oldCharacter:m.t,oldColor:m.fc,oldBgColor:m.bc,oldRx:m.rx,oldRy:m.ry,oldRz:m.rz,newCharacter:s,newColor:l,newBgColor:C,newRx:fh,newRy:fv,newRz:d,frame:t};this.editor.history.addAction("setCell3d",$);m.x=i;m.y=r;m.z=a;m.t=s;m.fc=l;m.bc=C;m.fh=fh;m.fv=fv;m.rx=n;m.ry=h;m.rz=d;if(!y){p[g]=m}this.editor.modified()}};var FRAMERATE=1e3/50;var Frames=function(){this.editor=null;this.frames=null;this.width=40;this.height=25;this.depth=25;this.playFrames=false;this.lastFrameTime=0;this.showPrevFrame=false;this.playDirection=1;this.playMode="loop";this.tick=0;this.lastTickTime=0;this.framesCharWidth=0;this.framesCharHeight=0;this.framesCharDepth=0;this.hasCharRotation=false;this.hasCharFlip=false;this.blockWidth=2;this.blockHeight=2;this.updatedCellRanges=[]};Frames.prototype={init:function(e){this.editor=e;var t=this;this.frames=null;this.frameCount=0},load:function(){console.error("remove this? Frames::load");var e=this.editor.doc;if(e.data.frames==null){e.data.frames=[]}this.frames=e.data.frames;this.frameCount=e.data.frames.length;this.width=e.data.width;this.height=e.data.height;this.depth=e.data.depth;this.tileSetId=e.data.tileSetId;this.colorPaletteId=e.data.colorPaletteId;this.editor.tileSetManager.setCurrentTileSetFromId(this.tileSetId);this.editor.colorPaletteManager.setCurrentColorPaletteFromId(this.colorPaletteId);this.blockMode=false;if(this.editor.graphic.frames.length==0){this.editor.graphic.setFrameCount(1)}else{for(var t=0;t<this.frames.length;t++){this.frames[t].holder=new THREE.Object3D}}this.setCurrentFrame(0)},getBlockModeEnabled:function(){return this.blockMode},setBlockModeEnabled:function(e){this.blockMode=e;UI("mode-blockmode").setChecked(e)},getWidth:function(){console.error(" not here frames get wdtih");return this.width},getHeight:function(){console.error("frames get height");return this.height},getDepth:function(){return this.depth},getShowPrevFrame:function(){return this.showPrevFrame},initEvents:function(){var t=this;$("#showGhostFrame").on("click",function(){t.setShowPrevFrame($("#showGhostFrame").is(":checked"))});$("#frameDuration").on("change",function(){var e=parseInt($("#frameDuration").val());t.setFrameDuration(e)});$("#frameDuration").on("keyup",function(){var e=parseInt($("#frameDuration").val());if(!isNaN(e)){t.setFrameDuration(e)}});$("#createFrame").on("click",function(){t.createFrame()});$("#insertFrame").on("click",function(){t.insertFrame()});$("#duplicateFrame").on("click",function(){if(g_app.getMode()!="3d"){var e=t.editor.graphic.duplicateFrame();t.gotoFrame(e)}else{var e=t.editor.grid3d.duplicateFrame();t.gotoFrame(e)}});$("#deleteFrame").on("click",function(){t.deleteFrame()});$("#prevFrame").on("click",function(){t.prevFrame()});$("#nextFrame").on("click",function(){t.nextFrame()});$("#currentFrame").on("change",function(){var e=$("#currentFrame").val();t.gotoFrame(e-1)});$("#play").on("click",function(){t.play()});$("#playMode").on("change",function(){t.setPlayMode($(this).val())})},insertFrame:function(e,t,i,r){console.log("insert frame!");var a=this.editor.currentTile.getColor();var s=e;if(g_app.getMode()!="3d"){if(typeof e=="undefined"){s=this.editor.graphic.getCurrentFrame()}s=this.editor.graphic.insertFrame(s,t,i,r);this.gotoFrame(s);this.editor.currentTile.setColor(a)}else{if(typeof e=="undefined"){s=this.editor.grid3d.getCurrentFrame()}s=this.editor.grid3d.insertFrame(s,t);this.gotoFrame(s)}},deleteFrame:function(e){if(g_app.getMode()!="3d"){var t=this.editor.graphic.getCurrentFrame();if(typeof e!="undefined"){t=e}if(this.editor.graphic.deleteFrame(t)){if(t>0){t--;this.gotoFrame(t)}else{this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw();this.gotoFrame(0)}}else{alert("Unable to delete frame")}}else{var t=this.editor.grid3d.getCurrentFrame();if(typeof e!="undefined"){t=e}if(this.editor.grid3d.deleteFrame(t)){if(t>0){t--;this.gotoFrame(t)}else{this.gotoFrame(0)}}else{alert("Unable to delete frame")}}this.frameTimeline.draw()},setShowPrevFrame:function(e){if(e){this.showPrevFrame=true;if(this.currentFrame>1){}this.setCurrentFrame(this.currentFrame)}else{this.showPrevFrame=false;this.setCurrentFrame(this.currentFrame)}this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})},initEventsMobile:function(){var t=this;$("#createFrameMobile").on("click",function(){t.createFrame()});$("#insertFrameMobile").on("click",function(){t.insertFrame()});$("#duplicateFrameMobile").on("click",function(){var e=t.editor.graphic.duplicateFrame();t.gotoFrame(e)});$("#deleteFrameMobile").on("click",function(){t.deleteFrame()});$("#prevFrameMobile").on("click",function(){t.prevFrame()});$("#nextFrameMobile").on("click",function(){t.nextFrame()});$("#playMobile").on("click",function(){t.play()})},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.SplitPanel");this.htmlComponent=UI.create("UI.HTMLPanel");this.frameTimelinePanel=UI.create("UI.Panel");this.uiComponent.addSouth(this.frameTimelinePanel,20,false);this.uiComponent.add(this.htmlComponent);e.add(this.uiComponent);UI.on("ready",function(){t.htmlComponent.load("html/textMode/frames.html",function(){t.initEvents()})});this.frameTimeline=new FrameTimeline;this.frameTimeline.init(this.editor);this.frameTimeline.buildInterface(this.frameTimelinePanel)},buildMobileInterface:function(e){var t=this;this.mobileHtmlComponent=UI.create("UI.HTMLPanel");e.add(this.mobileHtmlComponent);UI.on("ready",function(){t.mobileHtmlComponent.load("html/textMode/framesMobile.html",function(){t.initEventsMobile()})})},keyDown:function(e){var t=e.keyCode;if(t==46){return}var i=String.fromCharCode(t).toUpperCase();if(t==190){i="."}if(t==188){i=","}switch(i){case keys.textMode.framesNext.key:this.nextFrame();break;case keys.textMode.framesPrev.key:this.prevFrame();break}},keyUp:function(e){},keyPress:function(e){},getBackgroundColor:function(e){var t=e;if(typeof t=="undefined"){t=this.currentFrame}if(this.frames&&t!==false&&t<this.frames.length){bgColor=this.frames[t].bgColor;if(typeof bgColor!="undefined"){return bgColor}}var i=this.editor.colorPaletteManager.getCurrentColorPalette();bgColor=i.getDefaultBackgroundColor();return bgColor},setBackgroundColor:function(e,t){if(!this.frames||this.currentFrame===false){return}if(this.currentFrame!==false&&this.currentFrame<this.frames.length){this.frames[this.currentFrame].bgColor=e}var i=this.editor.colorPaletteManager.getCurrentColorPalette();if(!i){return}var r=i.getHexString(e);$(".backgroundColorMobile").css("background-color","#"+r);$(".backgroundColor").css("background-color","#"+r);$(".backgroundColorDisplay").css("background-color","#"+r);if(typeof t==="undefined"||t===true){this.colorsUpdated()}},getBorderColor:function(e){var t=e;if(typeof t=="undefined"){t=this.currentFrame}if(this.frames&&t!==false&&t<this.frames.length){bgColor=this.frames[t].borderColor;if(typeof bgColor!="undefined"){return bgColor}}var i=this.editor.colorPaletteManager.getCurrentColorPalette();bgColor=i.getDefaultBorderColor();return bgColor},setBorderColor:function(e,t){if(!this.frames||this.currentFrame===false){return}if(this.currentFrame!==false&&this.currentFrame<this.frames.length){this.frames[this.currentFrame].borderColor=e}var i=this.editor.colorPaletteManager.getCurrentColorPalette();if(!i){return}var r=i.getHexString(e);$(".borderColor").css("background-color","#"+r);$(".borderColorMobile").css("background-color","#"+r);if(typeof t==="undefined"||t===true){this.colorsUpdated()}},hasCellBackgroundColors:function(){var e=this.frameCount;if(e>10){e=10}for(var t=0;t<e;t++){if(this.frames[t].data){for(var i=0;i<this.depth;i++){for(y=0;y<this.height;y++){for(x=0;x<this.width;x++){if(this.frames[t].data[i][y][x].bc!=this.editor.colorPaletteManager.noColor){return true}}}}}}return false},replaceColor:function(e,t){var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=i.getMaterial(t);if(!r){return}for(var a=0;a<this.frames.length;a++){var s=this.frames[a].data;for(var o=0;o<this.depth;o++){for(y=0;y<this.height;y++){for(x=0;x<this.width;x++){if(s[o][y][x].fc==e){if(s[o][y][x].mesh){if(s[o][y][x].mesh.fgMesh){s[o][y][x].mesh.fgMesh.material=r}else{s[o][y][x].mesh.material=r}}s[o][y][x].fc=t}if(s[o][y][x].bc==e){s[o][y][x].bc=t;if(s[o][y][x].mesh){s[o][y][x].material=r}}}}}}},clear:function(){if(this.playFrames){this.playFrames=false}for(var e=0;e<this.frames.length;e++){this.clearFrame(e)}this.frames=[];this.frameCount=0},clearFrame:function(e){if(e<0||e>=this.frames.length){return}if(this.frames[e].data){for(var t=0;t<this.depth;t++){for(y=0;y<this.height;y++){for(x=0;x<this.width;x++){if(this.frames[e].data[t][y][x].mesh){this.frames[e].holder.remove(this.frames[e].data[t][y][x].mesh);this.frames[e].data[t][y][x].mesh=null}}}}this.frames[e].data=null}},updateFrameInfo:function(){var e=" / "+this.editor.graphic.frameCount;$("#frameCountInfo").html(e);if(g_app.isMobile()){var t=this.editor.graphic.currentFrame+1;e=t+" / "+this.editor.graphic.frameCount;$("#frameCountInfoMobile").html(e)}},setFrameData:function(e,t,i){alert("SET FRAME DATA");console.error("SET FRAME DATA");if(this.frames[e].data==null){this.frames[e].data=[]}var r=this.frames[e].data;var a=typeof t[0][0].rz!="undefined";var s=this.getBlockModeEnabled()&&t[0][0].b!="undefined";r[i]=[];for(var o=0;o<this.height;o++){r[i][o]=[];for(var l=0;l<this.width;l++){if(o<t.length&&l<t[0].length){r[i][o][l]={c:t[o][l].t,fc:t[o][l].fc,bc:t[o][l].bc,rz:0,fh:0,fv:0};if(a){r[i][o][l].rz=t[o][l].rz;r[i][o][l].fh=t[o][l].fh;r[i][o][l].fv=t[o][l].fv}}else{r[i][o][l]={c:this.editor.tileSetManager.blankCharacter,fc:1,bc:-1,rz:0,fh:0,fv:0};if(this.hasCharRotation){r[i][o][l].rx=0;r[i][o][l].ry=0}if(this.getBlockModeEnabled()){r[i][o][l].b=0}}}}},createFrameData:function(e){console.error("CREATER FRAME DATA");alert("create frame data");if(this.frames[e].data==null){var t=[];for(var i=0;i<this.depth;i++){t[i]=[];for(var r=0;r<this.height;r++){t[i][r]=[];for(var a=0;a<this.width;a++){t[i][r][a]={c:this.editor.tileSetManager.blankCharacter,fc:1,bc:-1,rz:0,fh:0,fv:0};if(this.hasCharRotation){t[i][r][a].rx=0;t[i][r][a].ry=0}if(this.getBlockModeEnabled()){t[i][r][a].b=0}}}}this.frames[e].data=t}},setCurrentFrame:function(e){e=parseInt(e,10);if(isNaN(e)||e>=this.frameCount||e<0){return false}this.currentFrame=parseInt(e,10);var t=this.currentFrame+1;if(g_app.isMobile()){var i=this.currentFrame+1;html=i+" / "+this.frameCount;$("#frameCountInfoMobile").html(html)}$("#currentFrame").val(t);$("#frameDuration").val(this.frames[e].duration);return;var r=this.editor.colorPaletteManager.getCurrentColorPalette();var a=this.frames[e].bgColor;var s=this.frames[e].borderColor;if(r){if(typeof a=="undefined"){a=r.getDefaultBackgroundColor();this.frames[e].bgColor=a}if(typeof s=="undefined"){s=r.getDefaultBorderColor();this.frames[e].borderColor=s}}this.editor.tools.currentBackgroundColor=a;if(a!==this.editor.colorPaletteManager.noColor&&a>=0){this.setBackgroundColor(a,false)}if(s!==this.editor.colorPaletteManager.noColor&&s>=0){this.setBorderColor(s,false)}if(this.editor.type=="2d"){this.editor.grid.update()}var o=g_app.doc.getDocRecord("/settings");o.data.currentFrame=this.currentFrame;this.frameTimeline.draw()},nextFrame:function(){var e=false;if(g_app.getMode()!="3d"){e=this.editor.graphic.getCurrentFrame()}else{e=this.editor.grid3d.getCurrentFrame()}this.gotoFrame(e+1)},prevFrame:function(){var e=false;if(g_app.getMode()!="3d"){e=this.editor.graphic.getCurrentFrame()}else{e=this.editor.grid3d.getCurrentFrame()}this.gotoFrame(e-1)},setFrameDuration:function(e,t){if(g_app.getMode()!="3d"){this.editor.graphic.setFrameDuration(e,t)}else{this.editor.grid3d.setFrameDuration(e,t)}},gotoFrame:function(e){if(this.editor.tools.drawTools.pixelSelect.isInPasteMove()){this.editor.tools.drawTools.pixelSelect.endPasteDrag()}e=parseInt(e,10);var t=0;var i=0;if(g_app.getMode()!="3d"){t=this.editor.graphic.getFrameCount();i=this.editor.graphic.getCurrentFrame()}else{t=this.editor.grid3d.getFrameCount();i=this.editor.grid3d.getCurrentFrame()}if(isNaN(e)||e<0||e>=t){$("#currentFrame").val(parseInt(i,10)+1);return}var r=12;if(g_app.getMode()!="3d"){r=this.editor.graphic.getFrameDuration(e);this.editor.graphic.setCurrentFrame(e);this.frameTimeline.draw()}else{r=this.editor.grid3d.getFrameDuration(e);this.editor.grid3d.setCurrentFrame(e)}var a=e+1;$("#currentFrame").val(a);$("#frameCountInfo").html("/ "+t);$("#frameDuration").val(r);if(g_app.isMobile()){html=a+" / "+t;$("#frameCountInfoMobile").html(html)}if(this.editor.graphic.getType()=="sprite"){this.editor.updateCurrentColorToSpriteColor();if(g_app.isMobile()){this.editor.spriteFramesMobile.highlightCurrentSprite()}else{this.editor.spriteFrames.highlightCurrentSprite()}}this.editor.updateBackgroundColorPicker();this.editor.updateBorderColorPicker();this.editor.updateC64MultiColorPickers()},updateFrameDuration:function(){var e=this.editor.graphic.getCurrentFrame();var t=this.editor.graphic.getFrameDuration(e);$("#frameDuration").val(t)},setPlayMode:function(e){this.playMode=e;if(this.playMode!="pingpong"){this.playDirection=1}},play:function(e){if(this.editor.importImage.importInProgress){return}if(g_app.isMobile()){this.setPlayMode("loop")}if(typeof e!="undefined"&&e){this.playFrames=true}else{this.playFrames=!this.playFrames}if(g_app.isMobile()){if(this.playFrames){$("#playMobile").html('<i class="halflings halflings-pause"></i>')}else{$("#playMobile").html('<i class="halflings halflings-play"></i>')}}else{if(this.playFrames){$("#play").html('<i class="halflings halflings-pause"></i>&nbsp;Pause')}else{$("#play").html('<i class="halflings halflings-play"></i>&nbsp;Play')}}},stop:function(){if(this.playFrames){this.playFrames=false;$("#play").html('<i class="halflings halflings-play"></i>&nbsp;Play');if(g_app.isMobile()){$("#playMobile").html('<i class="halflings halflings-play"></i>')}}},update:function(){var e=getTimestamp();if(e-this.lastTickTime>=FRAMERATE){g_tick++;this.lastTickTime=e}if(g_tick!=this.tick){this.tick=g_tick;var t=this.editor.tileSetManager.getCurrentTileSet();if(t){t.update(this.tick)}g_app.scripting.doTick()}var i=g_app.getMode();if(this.playFrames){var r=0;var a=0;var s=12;var o=0;if(i!="3d"){a=this.editor.graphic.getFrameCount();if(this.editor.graphic.getType()=="sprite"){var l=this.editor.graphic.getFrameRanges();var n=this.editor.animationPreview.getFrameRange();if(n!==""&&n>=0&&n<l.length){r=l[n].start;a=l[n].end}}o=this.editor.graphic.currentFrame;s=this.editor.graphic.frames[o].duration}else{a=this.editor.grid3d.getFrameCount();o=this.editor.grid3d.getCurrentFrame();s=this.editor.grid3d.getFrameDuration(o)}if(e-this.lastFrameTime>s*FRAMERATE){var h=o;h+=this.playDirection;if(this.playMode=="pingpong"){if(h===r){this.playDirection=1}if(h===a){this.playDirection=-1}if(h>=a){h=r}else if(h<r){h=r}}else if(this.playMode=="once"){if(h>=a){h=r;this.editor.animationTools.stop()}}else{if(h>=a){h=r}if(h<r){h=r}}this.gotoFrame(h);this.lastFrameTime=e}}},getCell:function(e){console.error("frame get cell");var t=this.currentFrame;if(typeof e.frame!=="undefined"){t=e.frame}if(isNaN(t)||t<0||t>=this.frames.length){return false}var i=this.frames[t].data;var r=e.x;var a=e.y;var s=e.z;var o=i[s][a][r];return o},setCell:function(e){console.error("frame set cell shouldn't get here");if(typeof e.c=="undefined"){return}var t=this.currentFrame;if(typeof e.frame!=="undefined"){t=e.frame}if(t===false){return}if(isNaN(t)||t<0||t>=this.frames.length){return}var i=this.frames[t].data;var r=e.x;var a=e.y;var s=e.z;var o=e.c;var l=false;if(typeof e.b!=="undefined"){l=e.b}var n=this.editor.currentTile.color;if(typeof e.fc!=="undefined"){n=e.fc}var h=this.editor.currentTile.rotX;if(typeof e.rx!=="undefined"){h=e.rx}var d=this.editor.currentTile.rotY;if(typeof e.ry!=="undefined"){d=e.ry}var c=this.editor.currentTile.rotZ;if(typeof e.rz!=="undefined"){c=e.rz}fh=0;if(typeof e.fh!=="undefined"){fh=e.fh}fv=0;if(typeof e.fv!=="undefined"){fv=e.fv}if(this.editor.grid.selection&&this.editor.grid.selection.visible){if(!this.editor.tools.drawTools.select.inSelection(r,a,s)){return}}if(r>=this.width||r<0||a>=this.height||a<0||s>=this.depth||s<0){return}var f=i[s][a][r];var u=this.editor.currentTile.bgColor;if(typeof e.bc!=="undefined"){u=e.bc}else{if(typeof f.bc!="undefined"){u=f.bc}}if(!this.editor.frames.getBlockModeEnabled()){if(f.c==o&&f.fc==n&&f.rz==c&&f.fh==fh&&f.fv==fv&&(!this.editor.frames.hasCharRotation||f.rx==h&&f.ry==d&&f.rz==c)&&f.bc===u){return}}if(t===this.currentFrame){if(r<this.updatedCellRanges[s].minX){this.updatedCellRanges[s].minX=r}if(r+1>this.updatedCellRanges[s].maxX){this.updatedCellRanges[s].maxX=r+1}if(a<this.updatedCellRanges[s].minY){this.updatedCellRanges[s].minY=a}if(a+1>this.updatedCellRanges[s].maxY){this.updatedCellRanges[s].maxY=a+1}}if(g_app.getEnabled("textmode3d")){var p=r*this.cellSizeX+this.cellSizeX/2;var v=a*this.cellSizeY+this.cellSizeY/2;var g=s*this.cellSizeZ+this.cellSizeZ/2;if(f&&f.mesh){this.holder.remove(f.mesh);f.mesh=null}if(f&&f.bgMesh){this.holder.remove(f.bgMesh);f.bgMesh=null}if(o!=96&&(o!=this.editor.tileSetManager.blankCharacter||u!==-1)){var m=null;var y=null;var b=this.editor.tileSetManager.getCurrentTileSet();var C=this.editor.colorPaletteManager.getCurrentColorPalette();var x=C.getMaterial(n);if(u===false){var m=b.getGeometry(o);if(typeof m=="undefined"){}var y=new THREE.Mesh(m,x)}else{var m=b.getGeometry(o);var S=new THREE.Mesh(m,x);var P=C.getMaterial(u);if(P!==null){var m=b.getBackgroundGeometry(o);var y=new THREE.Mesh(m,P);y.add(S);y.fgMesh=S}else{y=S;y.fgMesh=null}}y.rotation.order="YXZ";y.rotation.x=rotX*Math.PI*2;y.rotation.y=rotY*Math.PI*2;y.rotation.z=rotZ*Math.PI*2;y.position.x=p;y.position.y=v;y.position.z=g;y.originalPosition={};y.originalPosition.x=p;y.originalPosition.y=v;y.originalPosition.z=g;y.gridX=r;y.gridY=a;y.gridZ=s;y.box=new THREE.Box3(new THREE.Vector3(p-this.cellSizeX/2,v-this.cellSizeY/2,g-this.cellSizeZ/2),new THREE.Vector3(p+this.cellSizeX/2,v+this.cellSizeY/2,g+this.cellSizeZ/2));y.box.gridPosition=new THREE.Vector3(r,a,s);y.castShadow=true;y.receiveShadow=true;f.mesh=y;this.holder.add(y)}}var w={x:r,y:a,z:s,oldCharacter:f.c,oldColor:f.fc,oldBgColor:f.bc,oldFh:f.fh,oldFv:f.fv,oldRz:f.rz,newCharacter:o,newColor:n,newBgColor:u,newFh:fh,newFv:fv,newRz:c,frame:t};if(this.editor.frames.getBlockModeEnabled()&&l!==false){w["oldB"]=f.b;w["newB"]=l}if(this.editor.frames.hasCharRotation){w["oldRx"]=f.rx;w["oldRy"]=f.ry;w["newRx"]=h;w["newRy"]=d}if(!this.editor.frames.getBlockModeEnabled()||l!==false){this.editor.history.addAction("setCell",w)}f.c=o;f.fc=n;f.bc=u;f.fh=fh;f.fv=fv;f.rz=c;if(this.editor.frames.getBlockModeEnabled()){if(l!==false){f.b=l}else{l=i[s][a][r].b;if(typeof l!=="undefined"){var I=this.getXOffsetInBlock(r);var k=this.getYOffsetInBlock(this.height-a-1);var M=this.editor.blockSetManager.getCurrentBlockSet();M.setCharacterInBlock(l,I,k,o)}}}if(this.editor.frames.hasCharRotation){f.rx=h;f.ry=d;f.rz=c}}};var FrameTimeline=function(){this.editor=null;this.canvas=null;this.highlightFrame=false;this.frameWidth=18;this.frameHeight=14;this.frameMargin=2;this.frameCount=0};FrameTimeline.prototype={init:function(e){this.editor=e},buildInterface:function(e){var t=this;var i="";i+="<div>";i+='<span style="line-height: 20px; vertical-align: middle; margin-left: 3px" class="gridinfo-label">Frames</span>';i+='<div id="frameTimelineHolder" style="position: absolute; top: 0; right: 0; left: 48px; bottom: 0; background-color: #111111"><canvas id="frameTimeline"></canvas></div>';i+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.on("resize",function(){t.resize()});e.add(this.uiComponent);UI.on("ready",function(){t.resize();t.initEvents()})},initEvents:function(){var t=this;$("#frameTimeline").on("mousemove",function(e){t.mouseMove(e)});$("#frameTimeline").on("mousedown",function(e){t.mouseDown(e)});$("#frameTimeline").on("mouseup",function(e){t.mouseUp(e)});$("#frameTimeline").on("mouseleave",function(e){t.setHighlightFrame(false)})},sizeCanvas:function(){var e=$("#frameTimelineHolder");var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}if(this.canvas==null){this.canvas=document.getElementById("frameTimeline")}if(this.width!=this.canvas.style.width||this.height!=this.canvas.style.height){if(this.width!=0&&this.height!=0){this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvas.width=this.width*UI.devicePixelRatio;this.canvas.height=this.height*UI.devicePixelRatio;this.scale=UI.devicePixelRatio}}this.context=this.canvas.getContext("2d");this.context.scale(this.scale,this.scale)},resize:function(){this.sizeCanvas();this.draw()},mouseDown:function(e){if(this.highlightFrame!==false&&this.highlightFrame>=0&&this.highlightFrame<this.editor.graphic.getFrameCount()){this.editor.frames.gotoFrame(this.highlightFrame)}},mouseMove:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;var r=Math.floor(t/(this.frameWidth+this.frameMargin));this.setHighlightFrame(r)},mouseUp:function(e){},setHighlightFrame:function(e){if(e===this.highlightFrame){return}this.highlightFrame=e;this.drawFrames()},drawFrames:function(){var e=this.editor.graphic.getCurrentFrame();var t=13;var i=this.editor.graphic.getFrameCount();if(this.frameCount!=i){this.sizeCanvas();this.frameCount=i}this.context.fillStyle="#111111";this.context.fillRect(0,0,this.canvas.width,this.canvas.height);var r=this.frameWidth;var a=this.frameHeight;var s=this.frameMargin;for(var o=0;o<i;o++){var l=o+1;var n=o*(r+s)+.5;var h=o*(r+s)+r;var d=n+3;if(o===e){this.context.fillStyle="#444444"}else if(o===this.highlightFrame){this.context.fillStyle="#3d3d3d"}else{this.context.fillStyle="#2d2d2d"}this.context.fillRect(n,3.5,r,a)}this.context.font="8px Verdana";this.context.fillStyle="#eeeeee";this.context.beginPath();this.context.lineWidth=1;for(var o=0;o<i;o++){if(o!==e){var l=o+1;var n=o*(r+s)+.5;var h=o*(r+s)+r;var d=n+3;this.context.fillText(l,d,t)}}this.context.strokeStyle="#777777";this.context.stroke();this.context.beginPath();this.context.lineWidth=1;var o=e;var l=o+1;var n=o*(r+s)+.5;var h=o*(r+s)+r;var d=n+3;this.context.rect(n,3.5,r,a);this.context.fillText(l,d,t);this.context.strokeStyle="#555555";this.context.stroke()},draw:function(){this.drawFrames()}};var SpriteFrames=function(){this.editor=null;this.canvas=null;this.uiComponent=null;this.visible=false;this.spritePositions=[];this.backgroundColor="#000000";this.currentHighlightRect=false;this.rulerHeight=20;this.rangeHeight=20;this.cellWidth=24;this.cellHeight=21;this.cellHPadding=2;this.cellVPadding=2;this.rulerCanvas=null;this.rulerContext=null;this.rangeCanvas=null;this.rangeContext=null;this.gridCanvas=null;this.gridContext=null;this.vScrollBarWidth=styles.ui.scrollbarWidth;this.vScrollBarHeight=0;this.vScrollBarPosition=null;this.vScrollBarPositionMin=0;this.vScrollBarPositionMax=0;this.vScrollBarPositionMouseOffset=0;this.vScroll=false;this.hScrollBarHeight=styles.ui.scrollbarWidth;this.hScrollBarWidth=0;this.hScrollBarPosition=null;this.hScrollBarPositionMin=0;this.hScrollBarPositionMax=0;this.hScrollBarPositionMouseOffset=0;this.hScroll=false;this.scrollX=0;this.scrollY=0;this.mouseDownAtScrollX=0;this.mouseDownAtScrollY=0;this.lastMouseX=0;this.lastMouseY=0;this.id="";this.buttons=[];this.controlHandleWidth=6};SpriteFrames.prototype={init:function(e,t){this.editor=e;if(typeof t=="undefined"){this.id=""}else{this.id=t}},buildInterface:function(e){var t=this;var i="";i+='<div class="panelFill" id="spriteFramesHolder'+this.id+'">';i+='<canvas id="spriteFramesCanvas'+this.id+'" ></canvas>';i+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.on("resize",function(){t.resize()});e.add(this.uiComponent);UI.on("ready",function(){t.resize();t.initEvents()})},show:function(){this.visible=true;this.resize();if(this.rangeCanvas==null){this.rangeCanvas=document.createElement("canvas")}if(this.rulerCanvas==null){this.rulerCanvas=document.createElement("canvas")}if(this.gridCanvas==null){this.gridCanvas=document.createElement("canvas")}this.setSize()},hide:function(){this.visible=false},getVisible:function(){return this.visible},initEvents:function(){var t=this;if(this.canvas==null){this.canvas=document.getElementById("spriteFramesCanvas"+this.id)}$("#spriteFramesCanvas"+this.id).on("mousedown",function(e){t.mouseDown(e)});$("#spriteFramesCanvas"+this.id).on("mousemove",function(e){t.mouseMove(e)});$("#spriteFramesCanvas"+this.id).on("mouseup",function(e){t.mouseUp(e)});$("#spriteFramesCanvas"+this.id).on("mouseenter",function(e){UI.setCursor("default")});$("#spriteFramesCanvas"+this.id).on("mouseleave",function(e){UI.setCursor("default")});this.canvas.addEventListener("dblclick",function(e){t.mouseDoubleClick(e)},false);this.canvas.addEventListener("wheel",function(e){t.mouseWheel(e)},false)},sizeCanvas:function(){var e=$("#spriteFramesHolder"+this.id);if(this.canvas==null){this.canvas=document.getElementById("spriteFramesCanvas"+this.id)}var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}if(this.width!=this.canvas.style.width||this.height!=this.canvas.style.height){if(this.width!=0&&this.height!=0){this.scale=1;this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvas.width=this.width*this.scale;this.canvas.height=this.height*this.scale}}this.context=this.canvas.getContext("2d");this.context.scale(this.scale,this.scale)},resize:function(){this.sizeCanvas();this.draw()},keyDown:function(e){switch(e.keyCode){case keys.textMode.tilePaletteLeft.keyCode:if(keys.textMode.tilePaletteLeft.shift==e.shiftKey){this.editor.frames.prevFrame()}break;case keys.textMode.tilePaletteRight.keyCode:if(keys.textMode.tilePaletteRight.shift==e.shiftKey){this.editor.frames.nextFrame()}break;case keys.textMode.tilePaletteUp.keyCode:if(keys.textMode.tilePaletteRight.shift==e.shiftKey){this.editor.layers.moveSelect(1)}break;case keys.textMode.tilePaletteDown.keyCode:if(keys.textMode.tilePaletteDown.shift==e.shiftKey){this.editor.layers.moveSelect(-1)}break;case keys.textMode.characterRecentNext.keyCode:if(keys.textMode.characterRecentNext.shift==e.shiftKey){}break;case keys.textMode.characterRecentPrev.keyCode:if(keys.textMode.characterRecentPrev.shift==e.shiftKey){}break}},mouseDownVScroll:function(e,t,i){i=this.height-i;if(i<this.rulerHeight+this.rangeHeight+this.vScrollBarPosition){this.setYScroll(this.scrollY+20)}else if(i>this.rulerHeight+this.rangeHeight+this.vScrollBarPosition+this.vScrollBarPositionHeight){this.setYScroll(this.scrollY-20)}else{this.vScroll=true}this.draw({framesChanged:false})},mouseDownHScroll:function(e,t,i){t=t-this.layerLabelWidth;if(t<this.hScrollBarPosition){this.setXScroll(this.scrollX-20)}else if(t>this.hScrollBarPosition+this.hScrollBarPositionWidth){this.setXScroll(this.scrollX+20)}else{this.hScroll=true}this.draw({framesChanged:false})},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){if(UI.os=="Mac OS"){this.buttons=2}}},addFrameRangeEdge:function(e){var t=this.editor.graphic.getFrameRanges();for(var i=0;i<t.length;i++){if(t[i].start<e&&t[i].end>e){var r={start:e,end:t[i].end};t[i].end=e;t.splice(i+1,0,r);return}}},deleteFrameRangeEnd:function(e){var t=e+1;var i=this.editor.graphic.getFrameRanges();if(e>=0&&e<i.length-1){i[e].end=i[t].end;i.splice(t,1)}},mouseDoubleClick:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;t-=this.layerLabelWidth-this.scrollX;if(i>0&&i<this.rangeHeight){for(var r=0;r<this.rangePositions.length;r++){if(t>this.rangePositions[r].fromX&&t<this.rangePositions[r].toX){var a=this.rangePositions[r].fromX;var s=this.rangePositions[r].toX;var o=false;if(t<a+this.controlHandleWidth){o=r;this.deleteFrameRangeEnd(r-1)}else if(t>s-this.controlHandleWidth){this.deleteFrameRangeEnd(r)}else{this.editor.animationPreview.setFrameRange(r);var l=Math.floor(t/this.cellWidth);this.addFrameRangeEdge(l)}this.drawRange({rangesChanged:false});this.draw({framesChanged:false});break}}}},mouseDown:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;var r=0;this.buttons=1;this.mouseCaptured=false;if(!UI.isMobile.any()){r=e.button;this.setButtons(e);if(this.buttons&2){return}if(this.buttons&1){this.leftMouseUp=false}this.mouseIsDown=true}if(r==1){return}this.mouseDownAtX=t;this.mouseDownAtY=i;this.mouseDownAtScrollX=this.scrollX;this.mouseDownAtScrollY=this.scrollY;this.moveFrameRangeEdge=false;if(t>this.width-this.vScrollBarWidth&&i<this.height-(this.rulerHeight+this.rangeHeight)){return this.mouseDownVScroll(r,t,i)}if(t>this.layerLabelWidth&&i>this.height-this.hScrollBarHeight){return this.mouseDownHScroll(r,t,i)}if(t<this.layerLabelWidth){return}t-=this.layerLabelWidth-this.scrollX;var a=Math.floor(t/this.cellWidth);var s=this.editor.graphic.getFrameCount();if(i>0&&i<this.rangeHeight){for(var o=0;o<this.rangePositions.length;o++){if(t>=this.rangePositions[o].fromX&&t<this.rangePositions[o].toX){var l=this.rangePositions[o].fromX;var n=this.rangePositions[o].toX;if(t<l+this.controlHandleWidth){if(o!==0&&o!==this.rangePositions.length){this.moveFrameRangeEdge=o}}else if(t>n-this.controlHandleWidth){if(o+1!==0&&o+1!==this.rangePositions.length){this.moveFrameRangeEdge=o+1}}else{this.editor.animationPreview.setFrameRange(o)}this.drawRange({rangesChanged:false});this.draw({framesChanged:false});break}}}else{if(a<s){this.editor.frames.gotoFrame(a)}if(i>this.rulerHeight+this.rangeHeight){i-=this.rulerHeight+this.rangeHeight;var h=this.editor.layers.getLayers();var d=h.length-1-Math.floor(i/this.cellHeight);if(d>=0&&d<h.length){this.editor.layers.selectLayer(h[d].layerId)}}}},mouseWheel:function(e,t){e.stopPropagation();e.preventDefault();var i=normalizeWheel(e);var r=4;this.setYScroll(this.scrollY-i.spinY*r);this.setXScroll(this.scrollX+i.spinX*r);this.draw({framesChanged:false})},dragView:function(e,t,i,r){this.setYScroll(this.scrollY-r);this.setXScroll(this.scrollX-i);this.draw({framesChanged:false})},mouseMoveVScroll:function(e,t,i,r){var a=this.vScrollBarHeight/this.gridPixelHeight;var s=(t-this.mouseDownAtY)/a;this.setYScroll(this.mouseDownAtScrollY+s);this.draw({framesChanged:false})},mouseMoveHScroll:function(e,t,i,r){var a=this.hScrollBarWidth/this.gridPixelWidth;var s=(e-this.mouseDownAtX)/a;this.setXScroll(this.mouseDownAtScrollX+s);this.draw({framesChanged:false})},mouseMove:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;var r=t-this.lastMouseX;var a=i-this.lastMouseY;this.lastMouseX=t;this.lastMouseY=i;if(this.buttons&1||this.buttons&4){if(!this.mouseCaptured){UI.captureMouse(this);this.mouseCaptured=true}}if(this.buttons&4||this.mode=="hand"&&this.buttons&1){UI.setCursor("drag-scroll");this.dragView(t,i,r,a);return}if(this.hScroll){this.mouseMoveHScroll(t,i,r,a);return}if(this.vScroll){this.mouseMoveVScroll(t,i,r,a);return}UI.setCursor("default");if(this.moveFrameRangeEdge!==false){t-=this.layerLabelWidth-this.scrollX;var s=Math.floor(t/this.cellWidth);if(this.lastMoveFrameRangeCell!==s){var o=this.editor.graphic.getFrameRanges();var l=s+1;var n=this.moveFrameRangeEdge-1;var h=this.moveFrameRangeEdge;var d=0;if(n>=0&&n<o.length){d=o[n].start+1}var c=this.editor.graphic.getFrameCount();if(h>=0&&h<o.length){c=o[h].end}if(l>=d&&l<c){if(n>=0&&n<o.length){d=o[n].start+1;if(l>=d){o[n].end=l}}if(h<o.length){if(l<c){o[h].start=l}}this.drawRange({rangesChanged:false});this.draw({framesChanged:false})}this.lastMoveFrameRangeCell=s}}},mouseUp:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;this.vScroll=false;this.hScroll=false;this.buttons=0;this.lastMoveFrameRangeCell=false;this.moveFrameRangeEdge=false},setHighlightFrame:function(e){if(e===this.highlightFrame){return}this.highlightFrame=e;this.drawFrames()},highlightCurrentSprite:function(){this.draw()},setSize:function(){var e=this.editor.graphic.getGridWidth();var t=this.editor.graphic.getGridHeight();var i=24;var r=21;var a=e*i+this.cellHPadding*2;var s=t*r+this.cellVPadding*2;var o=this.editor.graphic.getFrameCount();var l=this.editor.layers.getLayers();var n=l.length;if(this.gridWidth==o&&this.gridHeight==n&&a==this.cellWidth&&s==this.cellHeight){return}this.cellWidth=a;this.cellHeight=s;this.gridWidth=o;this.gridHeight=n;this.gridPixelHeight=this.gridHeight*this.cellHeight;this.gridPixelWidth=this.gridWidth*this.cellWidth;this.gridCanvas.width=this.gridWidth*this.cellWidth;this.gridCanvas.height=this.gridHeight*this.cellHeight;this.gridContext=this.gridCanvas.getContext("2d");this.rulerCanvas.width=this.gridWidth*this.cellWidth;this.rulerCanvas.height=this.rulerHeight;this.rulerContext=this.rulerCanvas.getContext("2d");this.rangeCanvas.width=this.rulerCanvas.width;this.rangeCanvas.height=this.rangeHeight;this.rangeContext=this.rangeCanvas.getContext("2d")},drawRange:function(e){if(this.rangeCanvas==null||this.rangeContext==null){return}var t=true;if(typeof e!="undefined"){if(typeof e.rangesChanged!=="undefined"){t=e.rangesChanged}}var i=this.editor.graphic.getFrameRanges();var r=this.editor.animationPreview.getFrameRange();this.rangeContext.fillStyle="#111111";this.rangeContext.fillRect(0,0,this.rangeCanvas.width,this.rangeCanvas.height);this.rangePositions=[];for(var a=0;a<i.length;a++){var s=i[a].start;var o=i[a].end;var l=s*this.cellWidth;var n=o*this.cellWidth;var h=n-l;this.rangePositions.push({index:a,fromX:l,toX:n});this.rangeContext.fillStyle="#444444";if(a===r||r===""){this.rangeContext.fillStyle="#888888"}this.rangeContext.fillRect(l,1,h,this.rangeHeight-2);var d=this.controlHandleWidth;var c=this.rangeHeight-6;this.rangeContext.fillStyle="#cccccc";this.rangeContext.beginPath();this.rangeContext.moveTo(l+1,(this.rangeHeight-c)/2);this.rangeContext.lineTo(l+1+d,this.rangeHeight/2);this.rangeContext.lineTo(l+1,(this.rangeHeight+c)/2);this.rangeContext.fill();this.rangeContext.beginPath();this.rangeContext.moveTo(n,(this.rangeHeight-c)/2);this.rangeContext.lineTo(n-d,this.rangeHeight/2);this.rangeContext.lineTo(n,(this.rangeHeight+c)/2);this.rangeContext.fill()}if(t){this.editor.animationPreview.updateFrameRanges()}},drawRuler:function(){this.rulerContext.clearRect(0,0,this.gridWidth*this.cellWidth,this.rulerHeight);this.rulerContext.beginPath();this.rulerContext.strokeStyle=styles.music.rulerBarLines;this.rulerContext.font="10px Verdana";this.rulerContext.fillStyle="#eeeeee";this.rulerContext.strokeStyle=styles.music.rulerLines;bar=0;for(var e=0;e<this.gridWidth;e++){bar++;var t=this.rulerHeight;this.rulerContext.fillText(bar,e*this.cellWidth+4,this.rulerHeight-4);var i=this.rulerHeight-t;this.rulerContext.moveTo(e*this.cellWidth+.5,i);this.rulerContext.lineTo(e*this.cellWidth+.5,i+t)}this.rulerContext.stroke()},drawFrames:function(){if(!this.editor.layers){return}if(!this.visible){return}this.gridContext.clearRect(0,0,this.gridCanvas.width,this.gridCanvas.height);this.gridImageData=this.gridContext.getImageData(0,0,this.gridCanvas.width,this.gridCanvas.height);var e=this.editor.layers.getLayers();var t=this.editor.graphic.getFrameCount();var i=0;var r=0;this.spritePositions=[];for(var a=e.length-1;a>=0;a--){i=0;var s=this.editor.layers.getLayerObject(e[a].layerId);if(s&&s.getType()=="grid"){var o=s.getTileSet();if(o){var l=o.getTileWidth();var n=o.getTileHeight();var h=s.getGridWidth();var d=s.getGridHeight();var c=l*h;var f=n*d;var u={};u["screenMode"]=s.getScreenMode();if(u["screenMode"]===TextModeEditor.Mode.INDEXED){u["transparentColorIndex"]=s.getTransparentColorIndex()}u["imageData"]=this.gridImageData;for(var p=0;p<t;p++){i=p*this.cellWidth+this.cellHPadding;for(var v=0;v<d;v++){for(var g=0;g<h;g++){var m=s.getCell({x:g,y:v,frame:p});if(m){u["color"]=m.fc;u["bgColor"]=m.bc;u["character"]=m.t;if(s.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){u["backgroundColor"]=s.getBackgroundColor(p);u["c64Multi1Color"]=s.getC64Multi1Color(p);u["c64Multi2Color"]=s.getC64Multi2Color(p)}u["x"]=(g*l+i)*this.scale;u["y"]=(v*n+r)*this.scale;u["scale"]=this.scale;o.drawCharacter(u);this.spritePositions.push({layerIndex:a,frame:p,x:u["x"]/this.scale,y:u["y"]/this.scale,width:c,height:f})}}}}r+=this.cellHeight}}}this.gridContext.putImageData(this.gridImageData,0,0);this.currentFrame=false;this.currentLayerIndex=false},setXScroll:function(e){var t=this.width-this.layerLabelWidth-this.vScrollBarWidth;if(e+t>this.gridPixelWidth){e=this.gridPixelWidth-t}if(e<0){e=0}this.scrollX=e},scrollToX:function(e){this.setXScroll(e)},scrollToY:function(e){this.setYScroll(e)},setYScroll:function(e){if(e<0){e=0}var t=this.height-this.rulerHeight-this.rangeHeight-this.hScrollBarHeight;if(e+t>this.gridPixelHeight){e=this.gridPixelHeight-t}if(e<0){e=0}this.scrollY=e},calculateScroll:function(){this.vScrollBarHeight=this.gridViewHeight;this.vScrollBarPositionHeight=this.vScrollBarHeight*this.gridViewHeight/this.gridPixelHeight;if(this.vScrollBarPositionHeight>this.vScrollBarHeight){this.vScrollBarPositionHeight=this.vScrollBarHeight}this.vScrollBarPosition=this.vScrollBarHeight-this.vScrollBarPositionHeight-Math.round(this.scrollY)*this.vScrollBarHeight/this.gridPixelHeight;this.hScrollBarWidth=this.gridViewWidth;this.hScrollBarPositionWidth=this.hScrollBarWidth*this.gridViewWidth/this.gridPixelWidth;if(this.hScrollBarPositionWidth>this.hScrollBarWidth){this.hScrollBarPositionWidth=this.hScrollBarWidth}this.hScrollBarPosition=this.scrollX*this.hScrollBarWidth/this.gridPixelWidth},draw:function(e){var t=true;if(typeof e!="undefined"){if(typeof e.framesChanged!="undefined"){t=e.framesChanged}}if(this.rulerCanvas==null||this.gridCanvas==null){return}if(this.canvas==null){this.sizeCanvas()}var i=this.editor.graphic.getCurrentFrame();var r=this.editor.layers.getSelectedLayerIndex();var a=this.editor.layers.getLayers();var s=a.length;this.setSize();if(t){this.drawRange();this.drawRuler();this.drawFrames()}this.context.fillStyle="#111111";this.context.fillRect(0,0,this.canvas.width,this.canvas.height);this.context.fillStyle="#222222";this.context.fillRect(0,0,this.canvas.width,this.rulerHeight);var o=i*this.cellWidth+this.layerLabelWidth;var l=this.rangeHeight;this.context.fillStyle="#444444";this.context.fillRect(o,l,this.cellWidth,this.rulerHeight);l=this.rangeHeight+this.rulerHeight;this.context.fillStyle="#0a0a0a";this.context.fillRect(o,this.rulerHeight,this.cellWidth,s*this.cellHeight);this.width=this.canvas.width;this.height=this.canvas.height;this.layerLabelWidth=0;var o=this.layerLabelWidth;var l=0;this.context.drawImage(this.rangeCanvas,Math.round(this.scrollX),0,this.width-this.layerLabelWidth,this.rangeHeight,o,l,this.width-this.layerLabelWidth,this.rangeHeight);var o=this.layerLabelWidth;var l=this.rangeHeight;this.context.drawImage(this.rulerCanvas,Math.round(this.scrollX),0,this.width-this.layerLabelWidth,this.rulerHeight,o,l,this.width-this.layerLabelWidth,this.rulerHeight);this.gridViewWidth=this.width-this.layerLabelWidth-this.vScrollBarWidth;this.gridViewHeight=this.height-(this.rulerHeight-this.rangeHeight)-this.hScrollBarHeight;var n=this.gridCanvas.width;var h=this.gridCanvas.height;var o=this.layerLabelWidth;var l=this.rangeHeight+this.rulerHeight;this.context.drawImage(this.gridCanvas,Math.round(this.scrollX),Math.round(this.scrollY),n,h,o,l,n,h);this.context.beginPath();this.context.fillStyle=styles.tilePalette.selectOutline;this.context.strokeStyle=styles.tilePalette.selectOutline;this.context.rect(i*this.cellWidth+this.layerLabelWidth-this.scrollX,(s-r-1)*this.cellHeight+this.rangeHeight+this.rulerHeight-this.scrollY,this.cellWidth,this.cellHeight);this.context.stroke();this.calculateScroll();this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(this.layerLabelWidth,this.height-this.hScrollBarHeight,this.gridViewWidth,this.hScrollBarHeight);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.layerLabelWidth+this.hScrollBarPosition,this.height-this.hScrollBarHeight+1,this.hScrollBarPositionWidth,this.hScrollBarHeight-2);this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(this.width-this.vScrollBarWidth,this.rulerHeight+this.rangeHeight,this.vScrollBarWidth,this.gridViewHeight);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.width-this.vScrollBarWidth+1,this.rulerHeight+this.rangeHeight+this.vScrollBarPosition,this.vScrollBarWidth-2,this.vScrollBarPositionHeight)}};var TilePaletteDisplay=function(){this.editor=null;this.charPaletteMap=[];this.charPaletteMapType=false;this.charPaletteWidth=9*16;this.charPaletteHeight=9*8;this.tilePaletteScale=2;this.charPaletteBlockSpacing=4;this.charPaletteSpacing=1;this.charPaletteX=0;this.charPaletteY=0;this.canvas=null;this.context=null;this.tileCanvas=null;this.tileContext=null;this.columnWidthMax=false;this.columnHeightMax=false;this.singleTileCanvas=null;this.singleTileContext=null;this.mouseDownX=false;this.mouseDownY=false;this.highlightCharacter=false;this.highlightGridX=false;this.highlightGridY=false;this.mouseDownOnCharacter=false;this.charPaletteImageData=null;this.canvasScale=1;this.charMargin=1;this.charRecentIndex=0;this.mode="grid";this.selectMode="add";this.selectedCharacters=[];this.selectedCharactersGrid=[];this.selectedGridCells=[];this.selectedGridChanged=false;this.highlightChanged=false;this.charDblClick=false;this.characterSelectedCallback=false;this.touchCharacterHandler=false;this.touchEndCharacterHandler=false;this.mouseUpHandler=false;this.mouseLeaveHandler=false;this.blockStacking="horizontal";this.tileLocations=[];this.resizeCanvas=true;this.page=0;this.lastMouseX=0;this.lastMouseY=0;this.scrollX=0;this.scrollY=0;this.xScrollSpeed=0;this.yScrollSpeed=0;this.vScrollBarWidth=styles.ui.scrollbarWidth;this.vScrollBarHeight=0;this.vScrollBarPosition=null;this.vScrollBarPositionMin=0;this.vScrollBarPositionMax=0;this.vScrollBarPositionMouseOffset=0;this.vScroll=false;this.hScrollBarHeight=styles.ui.scrollbarWidth;this.hScrollBarWidth=0;this.hScrollBarPosition=null;this.hScrollBarPositionMin=0;this.hScrollBarPositionMax=0;this.hScrollBarPositionMouseOffset=0;this.hScroll=false;this.gridMap=[];this.drawEnabled=true;this.sortDragTile=false;this.sortDragTileX=0;this.sortDragTileY=0;this.sortDragOffsetX=0;this.sortDragOffsetY=0;this.colors="current"};TilePaletteDisplay.prototype={init:function(e,t){this.editor=e;this.canvasElementId=t.canvasElementId;this.blockStacking="horizontal";if(typeof t!="undefined"){if(typeof t.mode!="undefined"){this.mode=t.mode}if(typeof t.blockStacking!="undefined"){this.blockStacking=t.blockStacking}if(typeof t.charMargin!="undefined"){this.charMargin=t.charMargin}if(typeof t.resizeCanvas!=="undefined"){this.resizeCanvas=t.resizeCanvas}if(typeof t.colors!="undefined"){this.colors=t.colors}}},on:function(e,t){if(e=="selectedgridchanged"){this.selectedGridChanged=t}if(e=="highlightchanged"){this.highlightChanged=t}if(e=="dblclick"){this.charDblClick=t}if(e=="characterselected"){this.characterSelectedCallback=t}if(e=="charactertouch"){this.touchCharacterHandler=t}if(e=="charactertouchend"){this.touchEndCharacterHandler=t}if(e=="mouseup"){this.mouseUpHandler=t}if(e=="mouseleave"){this.mouseLeaveHandler=t}},getDrawEnabled:function(){return this.drawEnabled},setDrawEnabled:function(e){this.drawEnabled=e},initEvents:function(){var t=this;this.canvas.addEventListener("dblclick",function(e){t.tilePaletteDoubleClick(e)},false);this.canvas.addEventListener("mousedown",function(e){t.mouseDown(e)},false);this.canvas.addEventListener("mousemove",function(e){t.mouseMove(e)},false);this.canvas.addEventListener("mouseleave",function(e){if(t.mouseIsDown){UI.captureMouse(t)}t.charPaletteMouseLeave(e)},false);this.canvas.addEventListener("mouseup",function(e){t.mouseUp(e)},false);this.canvas.addEventListener("wheel",function(e){t.mouseWheel(e)},false);this.canvas.addEventListener("contextmenu",function(e){e.preventDefault()},false);this.canvas.addEventListener("touchstart",function(e){t.touchStart(e)},false);this.canvas.addEventListener("touchmove",function(e){t.touchMove(e)},false);this.canvas.addEventListener("touchend",function(e){t.touchEnd(e)},false)},getTileMargin:function(){return this.charMargin},getCharPaletteMap:function(){return this.charPaletteMap},getCharPaletteMapType:function(){return this.charPaletteMapType},setCharPaletteMap:function(e,t){if(typeof t!="undefined"){this.charPaletteMapType=t}this.charPaletteMap=[];for(var i=0;i<e.length;i++){this.charPaletteMap[i]=[];for(var r=0;r<e[i].length;r++){this.charPaletteMap[i][r]=e[i][r]}}this.draw({redrawTiles:true})},setCharPaletteMapType:function(e){if(e=="similar"){e="petscii"}this.charPaletteMapType=e;this.charPaletteMap=[];var t=0;for(var i=0;i<16;i++){this.charPaletteMap[i]=[];for(var r=0;r<16;r++){this.charPaletteMap[i][r]=t++}}if(e=="petsciigraphic"){this.charPaletteMap=[[112,64,110,79,119,80,108,98,123,85,68,73,77,114,78,229,101,101,244],[93,87,93,116,91,106,225,32,97,71,81,72,107,86,115,244,116,84,212],[109,64,125,76,111,122,124,226,126,74,70,75,78,113,77,245,117,71,199],[240,192,238,207,247,208,236,226,251,213,196,201,205,242,206,225,97,66,221],[221,215,221,244,219,231,97,160,225,199,209,200,235,214,243,118,246,72,200],[237,192,253,204,239,250,252,98,254,202,198,203,206,241,205,106,234,89,217],[100,111,121,98,248,247,227,160,233,223,92,104,102,127,35,103,231,103,231],[228,239,249,226,120,119,99,32,95,105,220,232,230,255,163,96,160,32,160],[100,111,82,70,64,68,69,119,99,228,239,210,198,195,196,197,247,227,160],[33,0,63,38,93,94,90,88,83,65,30,31,32,32,32,32,32,32,-1],[49,50,51,52,53,54,55,56,57,48,61,43,45,42,47,37,36,28,35],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19],[20,21,22,23,24,25,26,44,46,59,58,34,39,40,41,27,29,60,62],[161,128,191,166,194,222,218,193,216,211,158,159,160,160,160,160,160,160,160],[177,178,179,180,181,182,183,184,185,176,189,171,173,170,175,165,164,156,163],[129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147],[148,149,150,151,152,153,154,172,174,187,186,162,167,168,169,155,157,188,190]];this.draw({redrawTiles:true});return}if(e=="petscii"||e=="similar"){this.charPaletteMap=[[32,48,49,50,51,52,53,54,55,56,57,61,43,45,42,47],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],[17,18,19,20,21,22,23,24,25,26,33,63,58,59,44,46],[108,123,112,110,79,80,107,114,85,73,81,87,78,77,92,102],[124,126,109,125,76,122,113,115,74,75,86,91,95,105,104,127],[100,111,121,98,120,119,99,101,116,117,97,118,106,103,28,35],[82,70,64,68,69,66,67,84,71,93,72,89,30,31,36,37],[90,88,83,65,27,29,40,41,60,62,34,39,94,38,0,96]];for(var i=0;i<8;i++){this.charPaletteMap[i+8]=[];for(var r=0;r<16;r++){this.charPaletteMap[i+8][r]=this.charPaletteMap[i][r]+128}}this.draw({redrawTiles:true});return}if(e=="ascii32x8"){for(var i=0;i<8;i++){for(var r=0;r<16;r++){this.charPaletteMap[i][r]=r+i*32;this.charPaletteMap[i+8][r]=r+16+i*32}}this.draw({redrawTiles:true});return}var a=this.editor.tileSetManager.getCurrentTileSet();var s=a.getPaletteMap(e);if(s!==false){for(var o=0;o<s.data.length;o++){this.charPaletteMap[o]=[];for(var l=0;l<s.data[o].length;l++){this.charPaletteMap[o][l]=s.data[o][l]}}this.draw({redrawTiles:true});return}if(e=="columns"){var n=a.getTileCount();var h=16;var d=8;var c=h*d;var f=Math.ceil(n/c);for(var u=0;u<f;u++){for(var i=0;i<d;i++){this.charPaletteMap[i+d*u]=[];for(var r=0;r<h;r++){var p=u*c+i*h+r;if(p<n){this.charPaletteMap[i+d*u][r]=p}else{this.charPaletteMap[i+d*u][r]=false}}}}}else{for(var i=0;i<8;i++){for(var r=0;r<16;r++){this.charPaletteMap[i][r]=r+i*16;this.charPaletteMap[i+8][r]=128+r+i*16}}}this.draw({redrawTiles:true})},setScale:function(e){this.tilePaletteScale=e},getScale:function(e){return this.tilePaletteScale},setMode:function(e){this.mode=e},setColumnWidthMax:function(e){this.columnWidthMax=e;if(this.columnWidthMax!==false&&this.columnWidth>this.columnWidthMax){this.columnWidth=this.columnWidthMax}},setColumnHeightMax:function(e){this.columnHeightMax=e;if(this.columnHeightMax!==false&&this.columnHeight>this.columnHeightMax){this.columnHeight=this.columnHeightMax}},getPage:function(){return this.page},setPage:function(e){var t=this.getMaxPages();this.page=e},getMaxPages:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.columns*this.columnHeight*this.columnWidth;return Math.ceil(e.getTileCount()/t)},initCharPalette:function(e){var t=this.editor.tileSetManager.getCurrentTileSet();if(!t){return}if(typeof e!="undefined"){if(typeof e.mapType!="undefined"){mapType=e.mapType;this.setCharPaletteMapType(e.mapType)}}if(this.charPaletteMapType===false){this.setCharPaletteMapType("columns")}var i=(t.charWidth+1)*16;var r=(t.charHeight+1)*8;if(this.charPaletteWidth!=i||this.charPaletteHeight!=r||this.charPaletteImageData==null){this.charPaletteWidth=i;this.charPaletteHeight=r;if(this.canvas==null){this.canvas=document.getElementById(this.canvasElementId);this.initEvents()}if(this.tileCanvas==null){this.tileCanvas=document.createElement("canvas")}var a=this.charPaletteWidth*2*this.tilePaletteScale+this.charPaletteBlockSpacing;var s=this.charPaletteHeight*this.tilePaletteScale;if(this.blockStacking=="vertical"){var a=this.charPaletteWidth*this.tilePaletteScale+this.charPaletteBlockSpacing;var s=this.charPaletteHeight*2*this.tilePaletteScale}this.canvasScale=Math.floor(UI.devicePixelRatio);if(this.resizeCanvas){this.canvas.style.width=a+"px";this.canvas.style.height=s+"px";this.canvas.width=a*this.canvasScale;this.canvas.height=s*this.canvasScale}this.context=this.canvas.getContext("2d");if(!g_app.isMobile()){var o=s+82+44+12;if(o<360){var l=UI("textEditorContent").getPanelSize({panel:"south"});if(l>140){UI("textEditorContent").resizeThePanel({panel:"south",size:o})}}}}},checkCanvasSize:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileWidth();var i=e.getTileHeight();var r=this.columnWidth*t*this.tilePaletteScale+this.columnWidth*this.charMargin;var a=this.columnHeight*i*this.tilePaletteScale+this.columnHeight*this.charMargin;var s=10;var o=10;if(this.blockStacking=="horizontal"){s=1+this.columns*(r+this.charPaletteBlockSpacing);o=1+this.columnHeight*(i+this.charMargin)*this.tilePaletteScale}if(this.blockStacking=="vertical"){s=1+r;o=1+this.columns*(a+this.charPaletteBlockSpacing)}var l=s*this.canvasScale;var n=o*this.canvasScale;if(this.resizeCanvas){if(this.canvas.width!==l||this.canvas.height!==n){this.canvas.style.width=s+"px";this.canvas.style.height=o+"px";this.canvas.width=l;this.canvas.height=n}}this.context=this.canvas.getContext("2d");if(this.tileCanvas.width!=s||this.tileCanvas.height!=o||this.tileContext==null){this.tileCanvas.width=s;this.tileCanvas.height=o;this.tileContext=UI.getContextNoSmoothing(this.tileCanvas)}},setSelected:function(e){this.selectedCharacters=[];for(var t=0;t<e.length;t++){if(this.selectedCharacters.indexOf(e[t])==-1){this.selectedCharacters.push(e[t])}}this.draw()},setSelectedGridCells:function(e){this.selectedGridCells=[];for(var t=0;t<e.length;t++){this.selectedGridCells.push({x:e[t].x,y:e[t].y,selectedGridX:e[t].selectedGridX,selectedGridY:e[t].selectedGridY})}},setSelectedGrid:function(e){this.selectedCharacters=[];this.selectedCharactersGrid=[];var t=false;if(this.selectedGridCells.length==0){t=true}for(var i=0;i<e.length;i++){this.selectedCharactersGrid.push([]);for(var r=0;r<e[i].length;r++){this.selectedCharactersGrid[i][r]=e[i][r];if(t){var a=this.getMapPosition(e[i][r]);if(a!==false){this.selectedGridCells.push({x:a.x,y:a.y,selectedGridX:r,selectedGridY:i})}}if(!this.isCharacterSelected(e[i][r])){this.selectedCharacters.push(e[i][r])}}}},getSelectedCharacters:function(){return this.selectedCharacters},getSelectedCharactersGrid:function(){return this.selectedCharactersGrid},unselectCharacter:function(e){var t=false;for(var i=0;i<this.selectedCharacters.length;i++){if(this.selectedCharacters[i]===e){t=i;break}}if(t!==false){this.selectedCharacters.splice(t,1)}},unselectAll:function(){this.selectedCharacters=[];this.selectedCharactersGrid=[];this.selectedGridCells=[]},isCharacterSelected:function(e){for(var t=0;t<this.selectedCharacters.length;t++){if(this.selectedCharacters[t]===e){return true}}return false},drawTilePalette:function(e){var t=this.editor.colorPaletteManager;var i=this.editor.tileSetManager.noTile;if(!this.drawEnabled){return}if(this.context==null||this.tileContext==null){this.initCharPalette()}if(this.context==null){return}var r=TextModeEditor.Mode.TEXTMODE;var a="cell";var s=0;var o=false;var l=false;var n=false;var h=this.editor.layers.getSelectedLayerObject();if(h&&h.getType()=="grid"){r=h.getScreenMode();a=h.getColorPerMode();s=h.getTransparentColorIndex();if(h.getHasTileFlip()){o=this.editor.currentTile.flipH;l=this.editor.currentTile.flipV}if(h.getHasTileRotate()){n=this.editor.currentTile.rotZ}}var d=false;if(typeof e!="undefined"){if(typeof e.screenMode!="undefined"){r=e.screenMode}if(typeof e.tiles!="undefined"){d=e.tiles}}this.columns=2;this.columnWidth=16;var c=this.editor.tileSetManager.getCurrentTileSet();var f=c.getTileCount();var u=c.getTileWidth();var p=c.getTileHeight();var v=c.getTileCount();var g=c.getBlankTile();this.tileLocations=[];for(var m=0;m<v;m++){this.tileLocations.push([])}var y=this.columns;if(this.charPaletteMapType=="columns"){this.columnWidth=16;if(this.columnWidthMax!==false&&this.columnWidth>this.columnWidthMax){this.columnWidth=this.columnWidthMax}this.columnHeight=Math.ceil(c.getTileCount()/this.columnWidth);if(this.columnHeightMax!==false&&this.columnHeight>this.columnHeightMax){this.columnHeight=this.columnHeightMax}this.columnHeight=8;var b=this.columnWidth*this.columnHeight;y=Math.ceil(f/b)}else if(this.charPaletteMapType=="petscii"){this.columnWidth=16;this.columnHeight=8;if(this.columnWidthMax!==false&&this.columnWidth>this.columnWidthMax){this.columnWidth=this.columnWidthMax}if(this.columnHeightMax!==false&&this.columnHeight>this.columnHeightMax){this.columnHeight=this.columnHeightMax}var b=this.columnWidth*this.columnHeight;y=Math.ceil(f/b)}else if(this.charPaletteMapType=="source"){y=1;this.columnWidth=32;if(this.columnWidthMax!==false&&this.columnWidth>this.columnWidthMax){this.columnWidth=this.columnWidthMax}this.columnHeight=Math.ceil(c.getTileCount()/this.columnWidth);if(this.columnHeightMax!==false&&this.columnHeight>this.columnHeightMax){this.columnHeight=this.columnHeightMax}}else if(this.charPaletteMapType=="custom"){y=1;this.columnWidth=this.charPaletteMap[0].length;if(this.columnWidthMax!==false&&this.columnWidth>this.columnWidthMax){this.columnWidth=this.columnWidthMax}this.columnHeight=8;var C=this.columnWidth*this.charPaletteMap.length;var x=this.columnWidth*this.columnHeight;y=Math.ceil(C/x)}else if(this.charPaletteMapType=="petsciigraphic"){y=1;this.columnWidth=this.charPaletteMap[0].length;if(this.columnWidthMax!==false&&this.columnWidth>this.columnWidthMax){this.columnWidth=this.columnWidthMax}this.columnHeight=9;var C=this.columnWidth*this.charPaletteMap.length;var x=this.columnWidth*this.columnHeight;y=Math.ceil(C/x)}else{y=1;this.columnWidth=this.charPaletteMap[0].length;if(this.columnWidthMax!==false&&this.columnWidth>this.columnWidthMax){this.columnWidth=this.columnWidthMax}this.columnHeight=Math.ceil(this.charPaletteMap.length/this.columns);if(this.columnHeightMax!==false&&this.columnHeight>this.columnHeightMax){this.columnHeight=this.columnHeightMax}}this.columns=y;this.checkCanvasSize();if(d===false){this.tileContext.clearRect(0,0,this.tileCanvas.width,this.tileCanvas.height);this.gridMapClear()}if(this.singleTileCanvas==null){this.singleTileCanvas=document.createElement("canvas")}this.singleTileScale=1;if(c.getType()=="vector"){this.singleTileScale=this.tilePaletteScale}if(this.singleTileCanvas.width!=u*this.singleTileScale||this.singleTileCanvas.height!=p*this.singleTileScale||this.singleTileContext==null){this.singleTileCanvas.width=u*this.singleTileScale;this.singleTileCanvas.height=p*this.singleTileScale;this.singleTileContext=this.singleTileCanvas.getContext("2d");this.singleTileImageData=this.singleTileContext.getImageData(0,0,u*this.singleTileScale,p*this.singleTileScale)}if(d===false||this.tilePaletteImageData==null){this.tilePaletteImageData=this.tileContext.getImageData(0,0,this.tileCanvas.width,this.tileCanvas.height)}var S=t.getCurrentColorPalette();if(!S){return}var P=this.editor.currentTile.getColor();var w=this.editor.currentTile.getBGColor();var e={};e["screenMode"]=r;e["transparentColorIndex"]=s;e["imageData"]=this.tilePaletteImageData;e["colorRGB"]=ColorUtils.hexStringToInt(styles.textMode.tilePaletteFg);if(this.colors=="monochrome"){e["bgColorRGB"]=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg)}else{if(w!=t.noColor){e["bgColorRGB"]=S.getHex(w)}else{var I=this.editor.graphic.getBackgroundColor();if(I!=-1){e["bgColorRGB"]=S.getHex(I)}else{e["bgColorRGB"]=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg)}}}if(this.colors=="monochrome"){e["colorRGB"]=ColorUtils.hexStringToInt(styles.textMode.tilePaletteFg)}else{e["colorRGB"]=S.getHex(P)}var k=ColorUtils.hexStringToInt(styles.textMode.tilePaletteBg);if(r===TextModeEditor.Mode.C64MULTICOLOR){e["bgColorRGB"]="#ff0000";e["backgroundColor"]=h.getBackgroundColor();e["c64Multi1Color"]=h.getC64Multi1Color();e["c64Multi2Color"]=h.getC64Multi2Color()}var M=Math.ceil(u*this.tilePaletteScale);var T=Math.ceil(p*this.tilePaletteScale);var D=this.columnWidth*this.columnHeight;var E=D*this.page;var $=false;var _=false;for(var B=0;B<this.columns;B++){var b=this.columnWidth*this.columnHeight;for(var m=0;m<b;m++){var R=m%this.columnWidth;var A=Math.floor(m/this.columnWidth);var F=A+B*this.columnHeight;var L=E+m+B*this.columnWidth*this.columnHeight;if(this.charPaletteMapType!="source"){if(F<this.charPaletteMap.length&&R<this.charPaletteMap[F].length){$=R;_=F;L=this.charPaletteMap[_][$]}else{L=f+1;break}}if(L<f&&L!==false){if(L===i||L===false){L=g}var U=true;if(d!==false){U=d.indexOf(L)!==-1}e["character"]=L;if(r===TextModeEditor.Mode.C64ECM){var H=Math.floor(e["character"]/64)%4;var O=Math.floor(e["character"]/256);e["bgColorRGB"]=S.getHex(h.getC64ECMColor(H));e["character"]=e["character"]%64+O*256}if(a=="character"){var P=c.getTileColor(L);var w=c.getCharacterBGColor(L);e["colorRGB"]=S.getHex(P);e["color"]=P;if(!h||r!=TextModeEditor.Mode.C64ECM){if(w!=t.noColor){e["bgColorRGB"]=S.getHex(w)}else{e["bgColorRGB"]=k}}}var G=0;var z=0;if(this.blockStacking=="horizontal"){G=1+this.charPaletteBlockSpacing*B+this.charMargin*(R+B*this.columnWidth)+(R+B*this.columnWidth)*u*this.tilePaletteScale;z=1+this.charMargin*A+A*p*this.tilePaletteScale}if(this.blockStacking=="vertical"){G=1+R*this.charMargin+R*u*this.tilePaletteScale;z=1+this.charPaletteBlockSpacing*B+this.charMargin*(A+B*this.columnHeight)+(A+B*this.columnHeight)*p*this.tilePaletteScale}G=Math.ceil(G);z=Math.ceil(z);if(L!==false&&L>=0){this.tileLocations[L].push({x:G*this.canvasScale,y:z*this.canvasScale})}if(d===false){if(this.charMargin>1){this.gridMapAdd(G-this.charMargin/2,z-this.charMargin/2,M+this.charMargin,T+this.charMargin,L,$,_)}else{this.gridMapAdd(G,z,M,T,L,$,_)}}if(c.getType()=="vector"){var N=this.tileContext;if(w!=this.editor.colorPaletteManager.noColor){if(this.colors=="monochrome"){N.fillStyle=styles.textMode.tilePaletteBg}else{N.fillStyle="#"+S.getHexString(w)}}else{if(this.colors=="monochrome"){N.fillStyle=styles.textMode.tilePaletteBg}else{if(I!=-1){N.fillStyle="#"+S.getHexString(I)}else{N.fillStyle=styles.textMode.tilePaletteBg}}}N.fillRect(G,z,M,T);var W=c.getGlyphPath(L);if(W){var X=M;var Y=c.getFontScale();var V=X*c.getFontScale();var q=c.getFontAscent();if(this.colors=="monochrome"){N.fillStyle=styles.textMode.tilePaletteFg}else{N.fillStyle="#"+S.getHexString(P)}N.strokeStyle=N.fillStyle;N.setTransform(V,0,0,-V,G,z+q*V);if(o){N.translate(1/(2*Y),-1/(2*Y)+q);N.scale(-1,1);N.translate(-1/(2*Y),1/(2*Y)-q)}if(l){N.translate(1/(2*Y),-1/(2*Y)+q);N.scale(1,-1);N.translate(-1/(2*Y),1/(2*Y)-q)}if(n!=0){N.translate(1/(2*Y),-1/(2*Y)+q);N.rotate(n*90*Math.PI/180);N.translate(-1/(2*Y),1/(2*Y)-q)}N.fill(W);N.setTransform(1,0,0,1,0,0)}}else{e["flipH"]=o;e["flipV"]=l;e["rotZ"]=n;e["x"]=G;e["y"]=z;e["scale"]=this.tilePaletteScale;if(U){c.drawCharacter(e)}if(this.selectedCharacters.length>0&&L==this.selectedCharacters[0]){e["x"]=0;e["y"]=0;e["scale"]=1;e["imageData"]=this.singleTileImageData;c.drawCharacter(e);this.singleTileContext.putImageData(this.singleTileImageData,0,0);e["imageData"]=this.tilePaletteImageData}}}}}if(c.getType()!="vector"){this.tileContext.putImageData(this.tilePaletteImageData,0,0)}if(c.getType()=="vector"&&this.selectedCharacters.length>0){e["character"]=this.selectedCharacters[0];e["x"]=0;e["y"]=0;e["scale"]=this.singleTileScale;e["context"]=this.singleTileContext;c.drawCharacter(e)}},setXScroll:function(e){var t=this.viewWidth;if(e+t>this.contentWidth){e=this.contentWidth-t}if(e<0){e=0}this.scrollX=e;this.draw()},scrollToX:function(e){this.setXScroll(e)},scrollToY:function(e){this.setYScroll(e)},setYScroll:function(e){var t=this.viewHeight;if(e+t>this.contentHeight){e=this.contentHeight-t}if(e<0){e=0}this.scrollY=e;this.draw()},calculateScroll:function(){this.resize();this.viewWidth=this.width;this.viewHeight=this.height;if(this.contentHeight<=this.viewHeight){this.vScrollBarWidth=0}else{this.vScrollBarWidth=styles.ui.scrollbarWidth;this.viewWidth=this.width-this.vScrollBarWidth}if(this.contentWidth<=this.viewWidth){this.hScrollBarHeight=0}else{this.hScrollBarHeight=styles.ui.scrollbarWidth;this.viewHeight=this.height-this.hScrollBarHeight;if(this.vScrollBarWidth===0&&this.contentHeight>this.viewHeight){this.vScrollBarWidth=styles.ui.scrollbarWidth;this.viewWidth=this.width-this.vScrollBarWidth}}if(this.scrollY+this.viewHeight>this.contentHeight){this.scrollY=this.contentHeight-this.viewHeight;if(this.scrollY<0){this.scrollY=0}}if(this.viewWidth+this.scrollX>this.contentWidth){this.scrollX=this.contentWidth-this.viewWidth;if(this.scrollX<0){this.scrollX=0}}this.vScrollBarHeight=this.viewHeight;this.vScrollBarPositionHeight=this.vScrollBarHeight*this.viewHeight/this.contentHeight;if(this.vScrollBarPositionHeight>this.vScrollBarHeight){this.vScrollBarPositionHeight=this.vScrollBarHeight}this.vScrollBarPosition=this.scrollY*this.vScrollBarHeight/this.contentHeight;this.hScrollBarWidth=this.viewWidth;this.hScrollBarPositionWidth=this.hScrollBarWidth*this.viewWidth/this.contentWidth;if(this.hScrollBarPositionWidth>this.hScrollBarWidth){this.hScrollBarPositionWidth=this.hScrollBarWidth}this.hScrollBarPosition=this.scrollX*this.hScrollBarWidth/this.contentWidth},resize:function(){this.width=this.canvas.width/UI.devicePixelRatio;this.height=this.canvas.height/UI.devicePixelRatio;this.viewWidth=this.width-this.vScrollBarWidth;this.viewHeight=this.height-this.hScrollBarHeight;this.contentWidth=this.tileCanvas.width;this.contentHeight=this.tileCanvas.height},draw:function(e){var t=[];var i=[];if(typeof e!=="undefined"&&typeof e.redrawTiles!="undefined"&&e.redrawTiles!==false){this.drawTilePalette(e)}if(this.canvas==null){return}this.context=UI.getContextNoSmoothing(this.canvas);if(this.context==null){return}var r=this.editor.tileSetManager.getCurrentTileSet();this.calculateScroll();if(this.selectedGridCells.length==0){if(typeof this.tileLocations!="undefined"){for(var a=0;a<this.selectedCharacters.length;a++){var s=this.selectedCharacters[a];if(s>=0&&s<this.tileLocations.length){for(var o=0;o<this.tileLocations[s].length;o++)i.push(this.tileLocations[s][o])}}}}if(this.highlightGridX!==false&&this.highlightGridY!==false){}else if(this.highlightCharacter!==false){if(typeof this.tileLocations!="undefined"){if(this.highlightCharacter>=0&&this.highlightCharacter<this.tileLocations.length){var l=this.tileLocations[this.highlightCharacter];for(var a=0;a<l.length;a++){t.push(l[a])}}}}this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var n=Math.round(this.scrollX);var h=Math.round(this.scrollY);var d=this.viewWidth;var c=this.viewHeight;var f=0;var u=0;var p=this.viewWidth*UI.devicePixelRatio;var v=this.viewHeight*UI.devicePixelRatio;this.context.drawImage(this.tileCanvas,n,h,d,c,f,u,p,v);this.context.fillStyle=styles.tilePalette.highlightOutline;this.context.strokeStyle=styles.tilePalette.highlightOutline;this.context.beginPath();this.context.lineWidth=2;var g=(r.getTileWidth()*this.tilePaletteScale+1)*this.canvasScale;var m=(r.getTileHeight()*this.tilePaletteScale+1)*this.canvasScale;if(this.highlightGridX!==false&&this.highlightGridY!==false){this.context.rect(this.highlightGridPixelX*UI.devicePixelRatio-this.scrollX*UI.devicePixelRatio-1+this.charMargin/2,this.highlightGridPixelY*UI.devicePixelRatio-this.scrollY*UI.devicePixelRatio-1+this.charMargin/2,g,m)}else{for(var a=0;a<t.length;a++){this.context.rect(t[a].x-this.scrollX*UI.devicePixelRatio-1,t[a].y-this.scrollY*UI.devicePixelRatio-1,g,m)}}this.context.stroke();this.context.fillStyle=styles.tilePalette.selectOutline;this.context.strokeStyle=styles.tilePalette.selectOutline;this.context.beginPath();this.context.lineWidth=2;var y=r.getTileWidth();var b=r.getTileWidth();var C=((r.getTileWidth()+5)*this.tilePaletteScale+1)*this.canvasScale;var x=((r.getTileHeight()+5)*this.tilePaletteScale+1)*this.canvasScale;if(this.selectedGridCells.length==0){for(var a=0;a<i.length;a++){if(typeof i[a]!="undefined"){this.context.rect(i[a].x-this.scrollX*UI.devicePixelRatio-1,i[a].y-this.scrollY*UI.devicePixelRatio-1,y*this.tilePaletteScale*UI.devicePixelRatio,b*this.tilePaletteScale*UI.devicePixelRatio)}}}else{for(var a=0;a<this.selectedGridCells.length;a++){var S=this.selectedGridCells[a].x;var P=this.selectedGridCells[a].y;var w=0;var I=0;var k=0;var M=0;if(this.blockStacking=="horizontal"){var T=Math.floor(P/this.columnHeight);P=P%this.columnHeight;w=1+this.charPaletteBlockSpacing*T+this.charMargin*(S+T*this.columnWidth)+(S+T*this.columnWidth)*y*this.tilePaletteScale;I=1+this.charMargin*P+P*b*this.tilePaletteScale}if(this.blockStacking=="vertical"){var T=Math.floor(P/this.columnHeight);P=P%this.columnHeight;w=1+S*this.charMargin+S*y*this.tilePaletteScale;I=1+this.charPaletteBlockSpacing*T+this.charMargin*(P+T*this.columnHeight)+(P+T*this.columnHeight)*b*this.tilePaletteScale}this.context.rect(w*UI.devicePixelRatio-this.scrollX*UI.devicePixelRatio,I*UI.devicePixelRatio-this.scrollY*UI.devicePixelRatio,y*this.tilePaletteScale*UI.devicePixelRatio,b*this.tilePaletteScale*UI.devicePixelRatio)}}this.context.stroke();if(this.mode=="sort"){if(this.sortDragTile){var y=r.getTileWidth();var b=r.getTileHeight();var D=y*this.tilePaletteScale*UI.devicePixelRatio;var E=b*this.tilePaletteScale*UI.devicePixelRatio;var $=(this.sortDragTileX-this.mouseDownOnGridPosition.offsetX)*UI.devicePixelRatio;var _=(this.sortDragTileY-this.mouseDownOnGridPosition.offsetY)*UI.devicePixelRatio;this.context.drawImage(this.singleTileCanvas,0,0,y*this.singleTileScale,b*this.singleTileScale,$,_,D,E)}}this.context.fillStyle=styles.ui.scrollbarHolder;if(this.hScrollBarHeight>0){this.context.fillRect(0,(this.height-this.hScrollBarHeight)*UI.devicePixelRatio,this.viewWidth*UI.devicePixelRatio,this.hScrollBarHeight*UI.devicePixelRatio);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.hScrollBarPosition*UI.devicePixelRatio,(this.height-this.hScrollBarHeight+1)*UI.devicePixelRatio,this.hScrollBarPositionWidth*UI.devicePixelRatio,(this.hScrollBarHeight-2)*UI.devicePixelRatio)}if(this.vScrollBarWidth>0){this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect((this.width-this.vScrollBarWidth)*UI.devicePixelRatio,0,this.vScrollBarWidth*UI.devicePixelRatio,this.viewHeight*UI.devicePixelRatio);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect((this.width-this.vScrollBarWidth+1)*UI.devicePixelRatio,this.vScrollBarPosition*UI.devicePixelRatio,(this.vScrollBarWidth-2)*UI.devicePixelRatio,this.vScrollBarPositionHeight*UI.devicePixelRatio)}},moveSelection:function(e,t){var i=this.selectedCharactersGrid;if(this.mode!="grid"||this.charPaletteMapType=="source"){i=[this.selectedCharacters]}var r=[];for(var a=0;a<this.selectedCharacters.length;a++){r.push(this.selectedCharacters[a])}var s=[];this.selectedCharacters=[];var o=[];if(this.selectedGridCells.length>0){for(var a=0;a<this.selectedGridCells.length;a++){var l=this.selectedGridCells[a].x;var n=this.selectedGridCells[a].y;var h=this.selectedGridCells[a].selectedGridX;var d=this.selectedGridCells[a].selectedGridY;l+=e;n+=t;if(n<0||n>=this.charPaletteMap.length){return}if(l>=this.charPaletteMap[n].length){l-=this.charPaletteMap[n].length;n+=this.columnHeight;if(n>=this.charPaletteMap.length){return}}if(l<0){l+=this.charPaletteMap[n].length;n-=this.columnHeight;if(n<0){return}}if(n>=this.charPaletteMap.length||n<0||l>=this.charPaletteMap[n].length||l<0){return}var c=this.charPaletteMap[n][l];if(c===false||c<0){return}while(s.length<=d){var f=[];while(f.length<=h){f.push(-1)}s.push(f)}s[d][h]=c;this.selectedCharacters.push(c);o.push({x:l,y:n,selectedGridX:h,selectedGridY:d})}this.selectedGridCells=o}else{if(this.charPaletteMapType=="source"){var u=this.editor.tileSetManager.getCurrentTileSet();var p=u.getTileCount();for(var v=0;v<i.length;v++){s.push([]);for(var a=0;a<i[v].length;a++){var g=i[v][a];g+=e;g+=t*this.columnWidth;if(g>=0&&g<p){if(!this.isCharacterSelected(g)){this.selectedCharacters.push(g)}s[v].push(g)}else{this.selectedCharacters=[];for(var a=0;a<r.length;a++){this.selectedCharacters.push(r[a])}return}}}}else{var m=this.charPaletteMap.length;for(var v=0;v<i.length;v++){s.push([]);for(var a=0;a<i[v].length;a++){var y=i[v][a];for(var n=0;n<m;n++){for(var l=0;l<this.charPaletteMap[n].length;l++){if(this.charPaletteMap[n][l]==y){var b=this.charPaletteMap[n].length;var C=l+e;var x=n+t;if(C>=b){C-=b;x+=this.columnHeight}if(C<0){C+=b;x-=this.columnHeight}if(x>=0&&x<m&&C>=0&&C<b){var S=this.charPaletteMap[x][C];s[v].push(S);if(!this.isCharacterSelected(S)){this.selectedCharacters.push(S)}}else{return}l=b;n=m;break}}}}}}}this.selectedCharactersGrid=s;if(this.selectedGridChanged){this.selectedGridChanged(this.selectedCharactersGrid)}if(this.mode=="single"){var P=false;if(this.selectedCharacters.length>0){P=this.selectedCharacters[0]}if(this.characterSelectedCallback){this.characterSelectedCallback(P)}}this.draw()},tilePaletteDoubleClick:function(e){var t=this.highlightCharacter;if(this.charDblClick){this.charDblClick(t)}},touchStart:function(e){e.preventDefault();var t=e.changedTouches;if(t.length>0){var i=t[0].pageX-$("#"+this.canvasElementId).offset().left;var r=t[0].pageY-$("#"+this.canvasElementId).offset().top;this.mouseDownOnCharacter=this.tilePaletteXYToTile(i,r);if(this.mouseDownOnCharacter!==false){if(this.touchCharacterHandler!==false){this.touchCharacterHandler(this.mouseDownOnCharacter)}}if(this.mode=="multiple"){if(this.isCharacterSelected(this.mouseDownOnCharacter)){this.unselectCharacter(this.mouseDownOnCharacter);this.selectMode="remove"}else{this.selectedCharacters.push(this.mouseDownOnCharacter);this.selectMode="add"}}this.draw()}},touchMove:function(e){e.preventDefault();var t=e.changedTouches;if(t.length>0){var i=t[0].pageX-$("#"+this.canvasElementId).offset().left;var r=t[0].pageY-$("#"+this.canvasElementId).offset().top;this.mouseDownOnCharacter=this.tilePaletteXYToTile(i,r);if(this.mouseDownOnCharacter!==false){if(this.touchCharacterHandler!==false){this.touchCharacterHandler(this.mouseDownOnCharacter)}if(this.mode=="multiple"){if(this.selectMode=="remove"){this.unselectCharacter(this.mouseDownOnCharacter)}else{if(!this.isCharacterSelected(this.mouseDownOnCharacter)){if(this.selectMode=="add"){this.selectedCharacters.push(this.mouseDownOnCharacter)}}}}}this.draw()}},touchEnd:function(e){e.preventDefault();var t=e.changedTouches;if(t.length>0){var i=t[0].pageX-$("#"+this.canvasElementId).offset().left;var r=t[0].pageY-$("#"+this.canvasElementId).offset().top;var a=this.tilePaletteXYToTile(i,r);if(a!==false){if(this.touchEndCharacterHandler!==false){this.touchEndCharacterHandler(a)}}}},mouseDownVScroll:function(e,t,i){if(i<this.vScrollBarPosition){this.setYScroll(this.scrollY-20)}else if(i>this.vScrollBarPosition+this.vScrollBarPositionHeight){this.setYScroll(this.scrollY+20)}else{this.vScroll=true}},mouseDownHScroll:function(e,t,i){if(t<this.hScrollBarPosition){this.setXScroll(this.scrollX-20)}else if(t>this.hScrollBarPosition+this.hScrollBarPositionWidth){this.setXScroll(this.scrollX+20)}else{this.hScroll=true}},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){if(UI.os=="Mac OS"){this.buttons=2}}},mouseDown:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;var r=0;this.buttons=1;if(!UI.isMobile.any()){r=e.button;this.setButtons(e);if(this.buttons&2){return}if(this.buttons&1){this.leftMouseUp=false}this.mouseIsDown=true}this.mouseDownAtScrollX=this.scrollX;this.mouseDownAtScrollY=this.scrollY;this.mouseDownAtY=i;this.mouseDownAtX=t;if(t>this.width-this.vScrollBarWidth&&i<this.height){return this.mouseDownVScroll(r,t,i)}if(t>0&&i>this.height-this.hScrollBarHeight){return this.mouseDownHScroll(r,t,i)}t+=this.scrollX;i+=this.scrollY;this.mouseDownX=t;this.mouseDownY=i;this.mouseDownOnCharacter=this.tilePaletteXYToTile(t,i);var a=this.gridMapGetMapPosition(t,i);if(this.mouseDownOnCharacter!==false){var s=this.mouseDownOnCharacter;if(this.mode=="grid"){this.selectedCharacters=[];this.selectedCharactersGrid=[];this.selectedCharacters.push(s);this.selectedCharactersGrid.push([s]);this.selectedGridCells=[];if(a.mapX!==false&&a.mapY!==false){this.selectedGridCells.push({x:a.mapX,y:a.mapY,selectedGridX:0,selectedGridY:0});this.draw()}if(this.selectedGridChanged){this.selectedGridChanged(this.selectedCharactersGrid)}}if(this.mode=="multiple"){if(this.isCharacterSelected(s)){this.selectMode="remove";this.unselectCharacter(s)}else{this.selectMode="add";this.selectedCharacters.push(s)}this.draw()}if(this.mode=="single"){this.selectedCharacters=[s];if(this.characterSelectedCallback){this.characterSelectedCallback(s)}}if(this.mode=="sort"){this.selectedCharacters=[s];this.drawTilePalette();this.mouseDownOnGridPosition=this.gridMapGetMapPosition(t,i);this.sortDragOffsetX=0;this.sortDragOffsetY=0;this.sortDragTile=true}}},mouseWheel:function(e,t){e.stopPropagation();e.preventDefault();var i=normalizeWheel(e);var r=4;this.setYScroll(this.scrollY+i.spinY*r);this.setXScroll(this.scrollX+i.spinX*r)},setTileMargin:function(e){if(!isNaN(e)&&e>=0){this.charMargin=e;this.draw({redrawTiles:true})}},dragView:function(e,t,i,r){this.setYScroll(this.scrollY-r);this.setXScroll(this.scrollX-i)},mouseMoveVScroll:function(e,t,i,r){var a=this.vScrollBarHeight/this.contentHeight;var s=(t-this.mouseDownAtY)/a;this.setYScroll(this.mouseDownAtScrollY+s)},mouseMoveHScroll:function(e,t,i,r){var a=this.hScrollBarWidth/this.contentWidth;var s=(e-this.mouseDownAtX)/a;this.setXScroll(this.mouseDownAtScrollX+s)},mouseMove:function(e){var t=this.editor.tileSetManager.getCurrentTileSet();var i=e.pageX-$("#"+this.canvas.id).offset().left;var r=e.pageY-$("#"+this.canvas.id).offset().top;var a=i-this.lastMouseX;var s=r-this.lastMouseY;this.lastMouseX=i;this.lastMouseY=r;var o=false;if(this.buttons&4||this.mode=="hand"&&this.buttons&1){UI.setCursor("drag-scroll");this.dragView(i,r,a,s);return}if(this.hScroll){this.mouseMoveHScroll(i,r,a,s);return}if(this.vScroll){this.mouseMoveVScroll(i,r,a,s);return}this.xScrollSpeed=0;this.yScrollSpeed=0;i+=this.scrollX;r+=this.scrollY;var l=this.tilePaletteXYToTile(i,r);if(l!==false){UI.setCursor("default");if(l!==this.highlightCharacter){this.setHighlightCharacter(l);var n=this.gridMapGetMapPosition(i,r);this.highlightGridX=n.mapX;this.highlightGridY=n.mapY;this.highlightGridPixelX=n.x;this.highlightGridPixelY=n.y;if(this.highlightChanged){this.highlightChanged(l)}o=true;if(this.mouseDownX!==false&&this.mouseDownY!==false){this.editor.info.setCharacter(this.editor.currentTile.getCharacters())}else{this.editor.info.setCharacter(l)}}}else{if(this.highlightCharacter!==false){this.highlightCharacter=false;o=true;this.editor.info.setCharacter(this.editor.currentTile.getCharacters())}}if(this.mouseDownX!==false&&this.mouseDownY!==false){if(this.mode=="grid"){var h=this.mouseDownX;var d=this.mouseDownY;var c=i;var f=r;if(h>c){var u=c;c=h;h=u}if(d>f){var u=f;f=d;d=u}var p=false;var v=false;var g=[];var m=[];var y=[];var b=this.gridMapGetMapPosition(h,d);var C=this.gridMapGetMapPosition(c,f);if(b.mapX===false||b.mapY===false){for(var x=d;x<=f;x++){var S=[];for(var P=h;P<=c;P++){var l=this.tilePaletteXYToTile(P,x);if(l===v&&S.length==0){P=c}else{if(l!==false&&l!==p&&l!==v){if(P==h){v=l}p=l;if(g.indexOf(l)<0){g.push(l)}S.push(l)}}}p=false;if(S.length>0){m.push(S)}}}else{for(var w=b.mapY;w<=C.mapY;w++){var S=[];for(var I=b.mapX;I<=C.mapX;I++){var l=this.charPaletteMap[w][I];if(l===v&&S.length==0){I=C.mapX}else{if(l!==false&&l!==p&&l!==v){if(I==b.mapX){v=l}p=l;if(g.indexOf(l)<0){g.push(l)}y.push({x:I,y:w,selectedGridX:S.length,selectedGridY:m.length});S.push(l)}}}p=false;if(S.length>0){m.push(S)}}}if(m.length>0){this.selectedCharactersGrid=m;this.selectedCharacters=g;this.selectedGridCells=y;if(this.selectedGridChanged){this.selectedGridChanged(this.selectedCharactersGrid)}}}if(this.mode=="multiple"){if(l!==false){if(this.selectMode=="remove"){this.unselectCharacter(l)}else{if(!this.isCharacterSelected(l)){if(this.selectMode=="add"){this.selectedCharacters.push(l)}}}}}o=true}if(this.mode=="sort"){if(this.sortDragTile){this.sortDragTileX=i-this.scrollX;this.sortDragTileY=r-this.scrollY;o=true}}if(o){this.draw()}},gridMapClear:function(){this.gridMap=[]},gridMapAdd:function(e,t,i,r,a,s,o){var l={y:t,height:r,value:a,mapX:s,mapY:o};for(var n=0;n<this.gridMap.length;n++){if(this.gridMap[n].x===e&&this.gridMap[n].width===i){this.gridMap[n].rows.push(l);return}}this.gridMap[n]={x:e,width:i,rows:[l]}},gridMapGetValue:function(e,t){for(var i=0;i<this.gridMap.length;i++){if(e>=this.gridMap[i].x&&e<this.gridMap[i].x+this.gridMap[i].width){for(var r=0;r<this.gridMap[i].rows.length;r++){if(t>=this.gridMap[i].rows[r].y&&t<this.gridMap[i].rows[r].y+this.gridMap[i].rows[r].height){return this.gridMap[i].rows[r].value}}}}return false},gridMapGetPosition:function(e,t){for(var i=0;i<this.gridMap.length;i++){if(e>=this.gridMap[i].x&&e<this.gridMap[i].x+this.gridMap[i].width){for(var r=0;r<this.gridMap[i].rows.length;r++){if(t>=this.gridMap[i].rows[r].y&&t<this.gridMap[i].rows[r].y+this.gridMap[i].rows[r].height){return{x:i,y:r}}}}}return false},gridMapGetMapPosition:function(e,t){for(var i=0;i<this.gridMap.length;i++){if(e>=this.gridMap[i].x&&e<this.gridMap[i].x+this.gridMap[i].width){for(var r=0;r<this.gridMap[i].rows.length;r++){if(t>=this.gridMap[i].rows[r].y&&t<this.gridMap[i].rows[r].y+this.gridMap[i].rows[r].height){return{x:this.gridMap[i].x,y:this.gridMap[i].rows[r].y,mapX:this.gridMap[i].rows[r].mapX,mapY:this.gridMap[i].rows[r].mapY,offsetX:e-this.gridMap[i].x,offsetY:t-this.gridMap[i].rows[r].y}}}}}return false},tilePaletteXYToTile:function(e,t){return this.gridMapGetValue(e,t)},getWidth:function(){return Math.ceil(this.canvas.width/this.canvasScale)},getHeight:function(){return Math.ceil(this.canvas.height/this.canvasScale)},getMapPosition:function(e){for(var t=0;t<this.charPaletteMap.length;t++){for(var i=0;i<this.charPaletteMap[t].length;i++){if(this.charPaletteMap[t][i]===e){return{x:i,y:t}}}}return false},clearSelectedGridCells:function(){this.selectedGridCells=[]},setHighlightCharacter:function(e){this.highlightCharacter=e},clearHighlightCharacter:function(){this.highlightCharacter=false},charPaletteMouseLeave:function(e){this.highlightGridX=false;this.highlightGridY=false;if(this.highlightCharacter!==false){this.highlightCharacter=false;this.draw()}if(this.highlightChanged){this.highlightChanged(false)}if(this.mouseLeaveHandler!==false){this.mouseLeaveHandler(e)}},mouseUp:function(e){var t=this.editor.tileSetManager.noTile;var i=e.pageX-$("#"+this.canvas.id).offset().left;var r=e.pageY-$("#"+this.canvas.id).offset().top;i+=this.scrollX;r+=this.scrollY;this.xScrollSpeed=0;this.yScrollSpeed=0;if(this.mode=="sort"){if(this.mouseDownOnCharacter!==false){this.highlightedChars=false;var a=this.gridMapGetMapPosition(i,r);if(a!==false){var s=this.gridMapGetValue(i,r);var o=this.mouseDownOnGridPosition.mapX;var l=this.mouseDownOnGridPosition.mapY;var n=a.mapX;var h=a.mapY;if(e.shiftKey){if(h==l&&n==o){this.charPaletteMap[h][n]=t}else{this.charPaletteMap[h][n]=this.mouseDownOnCharacter}}else{this.charPaletteMap[l][o]=s;this.charPaletteMap[h][n]=this.mouseDownOnCharacter}}this.draw({redrawTiles:true})}this.sortDragTile=false}this.vScroll=false;this.hScroll=false;this.mouseDownOnCharacter=false;this.mouseDownX=false;this.mouseDownY=false;this.mouseIsDown=false;this.draw();if(this.mouseUpHandler!==false){this.mouseUpHandler(e)}this.buttons=0}};var CharacterSetPresets=[{category:"8x8",characterSets:[{name:"Amiga",id:"b-strict",width:8,height:8,options:[{name:"B Strict",id:"b-strict"},{name:"B Struct",id:"b-struct"}]},{name:"Amstrad CPC",id:"amstradcpc_english",width:8,height:8},{name:"Atari ST",id:"atarist_8x8",width:8,height:8},{name:"ATASCII",id:"atascii",width:8,height:8},{name:"BBC Micro",id:"bbcmicrob",width:8,height:8,options:[{name:"BBC Micro Model B",id:"bbcmicrob"},{name:"BBC Micro Master 128",id:"bbcmaster"}]},{name:"Coleco",id:"coleco",width:8,height:8},{name:"Commodore 128",id:"c128",width:8,height:8,type:"petscii",options:[{name:"C128",id:"c128"},{name:"C128 Shifted",id:"c128_shifted"}]},{name:"Commodore 16",id:"c16",width:8,height:8,type:"petscii"},{name:"Commodore 64",id:"petscii",width:8,height:8,type:"petscii",options:[{name:"C64",id:"petscii"},{name:"C64 Shifted",id:"petscii_shifted"},{name:"C64 Swedish",id:"c64_swedish"},{name:"C64 Swedish Shifted",id:"c64_swedish_shifted"},{name:"C64 Japanese",id:"c64_japanese"},{name:"C64 Japanese Shifted",id:"c64_shifted_japanese"}]},{name:"Commodore PET",id:"pet2001_english",width:8,height:8,type:"petscii",options:[{name:"PET English",id:"pet2001_english"},{name:"PET Japanese",id:"pet_japanese"}]},{name:"Compukit UK101",id:"compukituk101",width:8,height:8},{name:"8px.",id:"8px",width:8,height:8,type:"custom",author:"VectorPixelStar",authorlink:' (<a target="_blank" href="https://vectorpixelstar.itch.io/8px">https://vectorpixelstar.itch.io/8px</a>)',licence:'CC BY 4.0  <a href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a>',notes:"Tiles have been reordered, some tiles removed"},{name:"Gloop",id:"gloop",width:8,height:8,type:"custom",author:"Polyducks",authorlink:' (<a target="_blank" href="https://twitter.com/polyducks">https://twitter.com/polyducks</a>)'},{name:"Rook",id:"rook_8x8",width:8,height:8,type:"custom",author:"Quintin Stokes",authorlink:' (<a target="_blank" href="https://twitter.com/qujast">https://twitter.com/qujast</a>)'},{name:"IBM CGA",id:"ibm_cga",width:8,height:8,options:[{name:"Normal",id:"ibm_cga"},{name:"Thin",id:"ibm_cga_thin"}]},{name:"Intellivision",id:"intellivision",width:8,height:8},{name:"Magnavox Odyssey 2/Philips Videopac",id:"magnavox",width:8,height:8},{name:"Mantavision",id:"diet_petscii",author:"DataDoor",authorlink:' (<a target="_blank" href="https://twitter.com/datad00r">https://twitter.com/datad00r</a>)',width:8,height:8,type:"custom",options:[{name:"Diet PETSCII",id:"diet_petscii"},{name:"Circlex",id:"circlex"},{name:"Filament",id:"filament"},{name:"Retrotech Romance",id:"retrotech_romance"}]},{name:"Mattel Aquarius",id:"aquarius",width:8,height:8},{name:"MSX",id:"msx_international",width:8,height:8,options:[{name:"International",id:"msx_international"},{name:"Japanese",id:"msx_japanese"},{name:"Korean",id:"msx_korean"},{name:"Russian",id:"msx_russian"}]},{name:"Robotron",id:"robotronz9001",width:8,height:8,options:[{name:"Robotron Z 9001",id:"robotronz9001"},{name:"Robotron Z 9001 CGA",id:"robotronz9001cga"},{name:"Robotron Z 9001 CGA International",id:"robotronz9001cgai"},{name:"CAOS 33 - 1",id:"kc85_caos33-1"},{name:"CAOS 33 - 2",id:"kc85_caos33-2"},{name:"CAOS 45 - 1",id:"kc85_caos45-1"},{name:"CAOS 45 - 2",id:"kc85_caos45-2"}]},{name:"SC-3000",id:"sc_3000_export",width:8,height:8,options:[{name:"Export",id:"sc_3000_export"},{name:"Japanese",id:"sc_3000_japanese"},{name:"Home Basic",id:"sc_3000_basic"}]},{name:"Sharp MZ 700",id:"sharpmz700_1",width:8,height:8,options:[{name:"First 256",id:"sharpmz700_1"},{name:"Second 256",id:"sharpmz700_2"},{name:"First 256 Japanese",id:"sharpmz700_japanese_1"},{name:"Second 256 Japanese",id:"sharpmz700_japanese_2"},{name:"Japanese Full Set (512 chars)",id:"sharpmz700_japanese_full"}]},{name:"Sharp MZ 80",id:"sharpmz80a",width:8,height:8,options:[{name:"MZ 80A English",id:"sharpmz80a"},{name:"MZ 80 Japanese",id:"sharpmz80_japanese"}]},{name:"Tatung Einstein",id:"einstein",width:8,height:8},{name:"VIC 20",id:"vic20",width:8,height:8,options:[{name:"VIC 20",id:"vic20"},{name:"VIC 20 Shifted",id:"vic20_shifted"},{name:"VIC 20 Japanese",id:"vic20_japanese"},{name:"VIC 20 Japanese Shifted",id:"vic20_japanese_shifted"}]},{name:"ZX Spectrum",id:"zx_spectrum",width:8,height:8}]},{category:"7x8",characterSets:[{name:"Apple IIc",id:"appleIIc",width:7,height:8}]},{category:"8x14",characterSets:[{name:"IBM EGA",id:"ibm_ega",width:8,height:14}]},{category:"8x16",characterSets:[{name:"Amiga",id:"potnoodle",width:8,height:16,options:[{name:"P0T-NOoDLE",id:"potnoodle"},{name:"mOsOul",id:"mosoul"},{name:"Micro Knight",id:"microknight"},{name:"Micro Knight Plus",id:"microknightplus"},{name:"Topaz",id:"topaz"},{name:"Topaz Plus",id:"topazplus"},{name:"Topaz 500",id:"topaz500"},{name:"Topaz 500 Plus",id:"topaz500plus"}]},{name:"Atari ST",id:"atarist_8x16",width:8,height:16},{name:"IBM VGA",id:"ibm_vga",width:8,height:16}]},{category:"16x16",characterSets:[{name:"Kenny 1 Bit Pack",id:"kenny1bit",width:16,height:16,author:"Kenny",authorlink:' (<a href="https://www.kenney.nl/assets/bit-pack" target="_blank">https://www.kenney.nl/assets/bit-pack</a>)',type:"custom"},{name:"Patterns and Tiles",id:"patterns-and-tiles",width:16,height:16,author:"VectorPixelStar",authorlink:' (<a href="https://vectorpixelstar.itch.io/1-bit-patterns-and-tiles" target="_blank">https://vectorpixelstar.itch.io/1-bit-patterns-and-tiles</a>)',licence:'CC BY 4.0  <a href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a>',type:"custom"}]},{category:"12x20",characterSets:[{name:"Teletext",id:"teletext_12x20",width:12,height:20}]}];var VectorPresets=[{category:"Vector",characterSets:[{name:"Mattel Aquarius",id:"mattel-aquarius",authorlink:'Contains glyphs from <a href="https://www.kreativekorp.com/software/fonts/ksquare.shtml" target="_blank">Kreative Square</a>',width:8,height:8},{name:"Modular Shapes",id:"modular-shapes",authorlink:'Contains glyphs from <a href="https://www.kreativekorp.com/software/fonts/ksquare.shtml" target="_blank">Kreative Square</a>',width:8,height:8},{name:"Modular Reduced",id:"modular-reduced",authorlink:'Contains glyphs from <a href="https://www.kreativekorp.com/software/fonts/ksquare.shtml" target="_blank">Kreative Square</a>',width:8,height:8},{name:"PETSCII Thin",id:"petscii-thin",width:8,height:8,authorlink:'Contains glyphs from <a href="https://www.kreativekorp.com/software/fonts/ksquare.shtml" target="_blank">Kreative Square</a>'},{name:"Symbols For Legacy Computing",id:"symbols-for-legacy-computing",authorlink:'Contains glyphs from <a href="https://www.kreativekorp.com/software/fonts/ksquare.shtml" target="_blank">Kreative Square</a>',width:8,height:8},{name:"Seven Segments",id:"seven-segments",authorlink:'Contains glyphs from <a href="https://www.kreativekorp.com/software/fonts/ksquare.shtml" target="_blank">Kreative Square</a>',width:8,height:8},{name:"Sharp MZ-700 (first 256)",id:"sharpmz700-first",authorlink:'Contains glyphs from <a href="https://www.kreativekorp.com/software/fonts/ksquare.shtml" target="_blank">Kreative Square</a>',width:8,height:8},{name:"Sharp MZ-700 (second 256)",id:"sharpmz700-second",authorlink:'Contains glyphs from <a href="https://www.kreativekorp.com/software/fonts/ksquare.shtml" target="_blank">Kreative Square</a>',width:8,height:8},{name:"Truchet Tiles",id:"truchet",authorlink:'Contains glyphs from <a href="https://www.kreativekorp.com/software/fonts/ksquare.shtml" target="_blank">Kreative Square</a>',width:8,height:8},{name:"Imago Mundi Mei",id:"imago-mundi-mei",authorlink:'Contains glyphs from <a href="https://velvetyne.fr/imagomundimei/" target="_blank">Imago Mundi Mei</a>',width:8,height:8}]}];var TileSetManager=function(){this.editor=null;this.currentTileSet=null;this.tileSetChoosePreset=null;this.tileSetChoosePresetMobile=null;this.tileSetImport=null;this.tileSetSave=null;this.newTileSetDialog=null;this.blankCharacter=32;this.noTile=-1;this.tileSets=[];this.tileSetCache={}};TileSetManager.prototype={init:function(e){this.editor=e},initNewTileSetDialogContent:function(){$("#newTileSetName").val("Tile Set");$("#newTileSetName").focus();$("#newTileSetName").select()},showNewTileSetDialog:function(){var t=this;if(this.newTileSetDialog==null){var e=320;var i=296;this.newTileSetDialog=UI.create("UI.Dialog",{id:"newTileSetDialog",title:"New Tile Set",width:e,height:i});this.newTileSetHTML=UI.create("UI.HTMLPanel");this.newTileSetDialog.add(this.newTileSetHTML);this.newTileSetHTML.load("html/textMode/newTileSet.html",function(){t.initNewTileSetDialogContent()});var r=UI.create("UI.Button",{text:"OK",color:"primary"});r.on("click",function(e){t.newTileSetSubmit();UI.closeDialog()});var a=UI.create("UI.Button",{text:"Cancel",color:"secondary"});a.on("click",function(e){UI.closeDialog()});this.newTileSetDialog.addButton(r);this.newTileSetDialog.addButton(a);UI.showDialog("newTileSetDialog")}else{UI.showDialog("newTileSetDialog");this.initNewTileSetDialogContent()}},newTileSetSubmit:function(){var e=$("#newTileSetName").val();var t=$("#newTileSetCount").val();var i=this.createTileSet({name:e,width:8,height:8});var r=this.getTileSet(i);r.setTileCount(t);if(g_app.getMode()!="3d"){var a=this.editor.layers.getSelectedLayerObject();if(a!=null&&a.getType()=="grid"){a.setTileSet(i)}}else{this.editor.grid3d.setTileSet(i)}this.updateTileSetMenu();g_app.projectNavigator.reloadTreeBranch("/tile sets");g_app.projectNavigator.treeRoot.refreshChildren()},updateTileSetMenu:function(){var e=g_app.tileSetMenu;var t=null;if(g_app.getMode()!="3d"){var i=this.editor.layers.getSelectedLayerObject();if(i==null||i.getType()!="grid"){return}t=i.getTileSet()}else{t=this.editor.grid3d.getTileSet()}var r=t.getTileWidth();var a=t.getTileHeight();var s=g_app.doc.dir("/tile sets");for(var o=0;o<s.length;o++){var l=s[o].data;if(r===l.width&&a===l.height){var n=s[o].name;var h=s[o].id;var d="tileset-select-"+h;var c=e.getItem(d);if(c){c.setLabel(n)}else{c=e.addItem({label:n,id:d})}if(h==t.getId()){c.setChecked(true)}else{c.setChecked(false)}}}},selectTileSet:function(e){if(g_app.getMode()!="3d"){var t=this.editor.layers.getSelectedLayerObject();if(t!=null&&t.getType()=="grid"){t.setTileSet(e);this.editor.graphic.redraw({allCells:true})}}else{this.editor.grid3d.setTileSet(e)}this.updateTileSetMenu()},getCurrentTileSetId:function(){if(this.currentTileSet==null){return false}return this.currentTileSet.tileSetId},createTileSet:function(e){var t=8;var i=8;var r="Tile Set";if(typeof e.name!=="undefined"){r=e.name}var a=false;if(typeof e.id!=="undefined"){a=e.id}if(typeof e.width!="undefined"){t=e.width}if(typeof e.height!="undefined"){i=e.height}var s=r;var o=0;while(g_app.doc.getDocRecord("/tile sets/"+s)){o++;s=r+"_"+o}r=s;var l=g_app.doc.createDocRecord("/tile sets",r,"tile set",{width:t,height:i,tileData:[]},a);return l.id},reset:function(){for(var e=0;e<this.tileSets.length;e++){this.tileSets[e].clear()}this.tileSets=[];this.tileSetCache={}},getTileSetCount:function(){return this.tileSets.length},getTileCount:function(){return 256},tileSetUpdated:function(e){var t=false;var i=false;if(!this.currentTileSet){return}if(typeof e!="undefined"){if(typeof e.updateBlankCells!="undefined"){t=e.updateBlankCells}if(typeof e.updateSortMethods!="undefined"){i=e.updateSortMethods}}this.editor.tools.drawTools.tilePalette.initCharPalette();this.editor.sideTilePalette.initCharPalette();var r=this.currentTileSet.getBlankCharacter();if(t&&r!=this.blankCharacter&&r!==false&&this.blankCharacter!==false){var a=this.editor.layers.getLayers();for(var s=0;s<a.length;s++){var o=a[s].layerId;var l=this.editor.layers.getLayerObject(o);if(l&&l.getType()=="grid"){if(l.getTileSetId()==this.currentTileSet.getId()){l.setBlankTileId(r,true)}}}}else{var a=this.editor.layers.getLayers();for(var s=0;s<a.length;s++){var o=a[s].layerId;var l=this.editor.layers.getLayerObject(o);if(l&&l.getType()=="grid"){if(l.getTileSetId()==this.currentTileSet.getId()){l.setBlankTileId(r,false)}}}}this.blankCharacter=r;if(g_app.getMode()=="3d"){this.currentTileSet.generate3dGeometries()}else if(g_app.getMode()=="2d"){this.editor.graphic.redraw()}if(i){this.updateSortMethods()}this.redrawCharacters();if(this.editor.type=="2d"){this.editor.layers.updateAllLayerPreviews()}var n=this.currentTileSet.getTileWidth();var h=this.currentTileSet.getTileHeight();var d=this.currentTileSet.label+" ("+n+"x"+h+")";$("#tilePaletteTileSize").html(" "+n+"x"+h);$("#sidetilePaletteTileSize").html(" "+n+"x"+h)},getSavedSortMethod:function(){var e=false;if(!this.currentTileSet){return}if(this.currentTileSet.isPetscii()){e=g_app.getPref("textmode.petsciisortmethod");if(typeof e=="undefined"||e==null){e="petsciigraphic"}}var t=this.currentTileSet.getSortMethods();for(var i=0;i<t.length;i++){if(t[i].id==e){return e}}return false},updateSortMethods:function(e){var t=this.editor.tools.drawTools.tilePalette;var i=this.editor.sideTilePalette;var e=this.currentTileSet.getSortMethods();var r=false;var a="";var s="";var o=this.editor.getScreenMode();for(var l=0;l<e.length;l++){if(e[l].id!="similar"||o!=TextModeEditor.Mode.C64ECM){a+='<option value="'+e[l].id+'">'+e[l].name+"</option>";if(e[l].id!="columns"){s+='<option value="'+e[l].id+'">'+e[l].name+"</option>"}if(e[l].id=="similar"){r=true}}}var n=$("#sidecharPaletteSortOrder");$("#charPaletteSortOrder").html(a);if(n){n.html(a)}if(r){var h=this.getSavedSortMethod();if(!h||h==""){h="similar"}$("#charPaletteSortOrder").val(h);if(n){n.val(h)}t.setCharPaletteMapType(h);i.setCharPaletteMapType(h)}else{$("#charPaletteSortOrder").val("columns");t.setCharPaletteMapType("columns");i.setCharPaletteMapType("columns")}t.updateTileCountHTML();i.updateTileCountHTML();if(this.editor.currentTile.tilePaletteChooserMobile!==null){var d=$("#charPaletteSortOrderMobileChoose").val();$("#charPaletteSortOrderMobileChoose").html(s);if(typeof d=="undefined"||!d){d="source";if(r){d="similar"}}this.editor.currentTile.tilePaletteChooserMobile.setCharPaletteMapType(d);$("#charPaletteSortOrderMobilePicker").val(d);$("#charPaletteSortOrderMobileChoose").val(d)}if(this.editor.importImage&&this.editor.importImage.importImageMobile&&this.editor.importImage.importImageMobile.tilePaletteChooserMobile){var d=$("#charPaletteSortOrderMobileChoose").val();if(typeof d=="undefined"||!d){d=$("#charPaletteSortOrderMobilePicker").val()}$("#charPaletteSortOrderMobilePicker").html(s);if(typeof d=="undefined"||!d){d="source";if(r){d="similar"}}this.editor.importImage.importImageMobile.tilePaletteChooserMobile.setCharPaletteMapType(d);$("#charPaletteSortOrderMobilePicker").val(d)}},redrawCharacters:function(){this.editor.tools.drawTools.tilePalette.drawTilePalette({redrawTiles:true});this.editor.sideTilePalette.drawTilePalette({redrawTiles:true});if(this.editor.tileEditor){this.editor.tileEditor.draw()}this.editor.currentTile.canvasDrawCharacters();if(this.editor.tools.drawTools.tool=="type"){this.editor.tools.drawTools.typing.updateTypeCanvas()}},addTileSet:function(e){alert("ADD TILE SET");this.tileSets.push(e)},outputCache:function(e){console.log("=========================> "+e);for(var t in this.tileSetCache){console.log("key = "+t);console.log("tile set id = "+this.tileSetCache[t].getId())}console.log(this.tileSetCache)},addTileSetToDoc:function(e,t){if(typeof e.tileSetId!="undefined"&&e.tileSetId!=""){if(typeof t!="undefined"){t(e.tileSetId)}return}if(typeof e.preset!="undefined"&&e.preset!=""&&e.preset!=false){this.addTileSetFromPreset(e,t);return}var i=8;var r=8;var a="Tile Set";if(typeof e.tileSetName!="undefined"){a=e.tileSetName}if(e.name!="undefined"){a=e.name}if(e.width!="undefined"){i=e.width}if(e.height!="undefined"){r=e.height}var s=this.createTileSet({name:a,width:i,height:r});var o=new TileSet;o.init(this.editor,a,s,"");this.tileSetCache[s]=o;if(typeof e.tileSet!="undefined"&&e.tileSet!=null){o.copyTileSet(e.tileSet)}if(typeof t!="undefined"){t(s)}},addTileSetFromPreset:function(e,t){var i=e.preset;var r="Tile Set";if(typeof e.tileSetName!="undefined"){r=e.tileSetName}var a=this.createTileSet({name:r});var s=new TileSet;s.init(this.editor,i,a);this.tileSetCache[a]=s;s.setToPreset(i,function(){if(typeof t!="undefined"){t(a)}})},usePresetTileSet:function(e,t){var i=this.currentTileSet;if(i==null){var r=this.createTileSet({name:e});i=new TileSet;i.init(this.editor,e,r);this.currentTileSet=i;this.tileSetCache[r]=i}this.currentTileSet.setToPreset(e,t);if(this.tileSets.length>0){this.tileSets[0]=this.currentTileSet}else{this.tileSets.push(this.currentTileSet)}},createBin:function(e){var t=e.tileSetId;var i=e.binPath;var r=e.name;var a="char";if(typeof e.binType!="undefined"){a=e.binType}r=r+" - "+a+" data.bin";var s=this.getTileSet(t);var o=null;switch(a){case"attrib":o=s.getAttribBinaryData();break;default:o=s.getBinaryData();break}var l=bufferToBase64(o);var n="bin";var h="/asm/bin";var d=g_app.doc.getDocRecord(h+"/"+r);if(d){d.data=l}else{var c=g_app.doc.createDocRecord(h,r,n,l)}g_app.projectNavigator.reloadTreeBranch("/asm/bin");g_app.projectNavigator.treeRoot.refreshChildren();return{success:true,path:"bin/"+r}},getTileSet:function(e){if(this.tileSetCache.hasOwnProperty(e)){return this.tileSetCache[e]}var t=g_app.doc.getDocRecordById(e,"/tile sets");if(t){var i=new TileSet;i.init(this.editor,t.name,e);this.tileSetCache[e]=i;return i}return null},setCurrentTileSetFromId:function(e){var t=this.getTileSet(e);if(t){if(this.currentTileSet&&this.currentTileSet.tileSetId==e){return}this.currentTileSet=t;this.tileSetUpdated({updateBlankCells:false,updateSortMethods:true})}},setCurrentTileSet:function(e){console.error("SET CURRENT TILE SET ***** get rid of this ***");if(e>=this.tileSets.length){return}this.currentTileSet=this.tileSets[e]},getCurrentTileSet:function(){return this.currentTileSet},showImport:function(e){e.showImport=true;this.showChoosePreset(e)},showChoosePreset:function(e){var s=this;e.type="character";if(g_app.getMode()!="tile set"){var t=this.editor.layers.getSelectedLayerObject();if(t&&t.getMode()=="vector"){e.type="vector"}}e.callback=function(e){var t=this.editor.tileSetManager.getCurrentTileSet();var i="textmode";i=e.type;var r=e.presetId;if(i=="vector"){var a=this.editor.layers.getSelectedLayerObject();if(a.getMode()!="vector"){a.setMode({mode:"vector",tileSet:r},function(){a.setHasTileFlip(true);a.setHasTileRotate(true);s.editor.layers.updateLayerInterface(a.getId());s.editor.tileSetManager.tileSetUpdated({updateBlankCells:true,updateSortMethods:true});s.editor.graphic.setCellDimensionsFromTiles();s.editor.graphic.redraw({allCells:true})})}else{t.setToVector(r,function(){s.editor.tileSetManager.tileSetUpdated({updateBlankCells:true,updateSortMethods:true});s.editor.graphic.setCellDimensionsFromTiles();s.editor.graphic.redraw({allCells:true})})}}else{var a=this.editor.layers.getSelectedLayerObject();if(a.getMode()=="vector"){a.setMode(TextModeEditor.Mode.TEXTMODE)}t.setToPreset(r,function(){s.editor.tileSetManager.tileSetUpdated({updateBlankCells:true,updateSortMethods:true});s.editor.layers.updateLayerInterface(a.getId());if(g_app.getMode()=="tile set"){g_app.tileSetEditor.redraw()}else{s.editor.tools.drawTools.tilePalette.drawTilePalette();s.editor.sideTilePalette.drawTilePalette();if(g_app.getMode()=="3d"){}else{s.editor.graphic.setCellDimensionsFromTiles();s.editor.graphic.redraw({allCells:true})}}})}};if(g_app.isMobile()){if(this.tileSetChoosePresetMobile==null){this.tileSetChoosePresetMobile=new CharacterSetChoosePresetMobile;this.tileSetChoosePresetMobile.init(this.editor)}this.tileSetChoosePresetMobile.show(e)}else{var i=this.getChoosePresetDialog();i.show(e)}},getChoosePresetDialog:function(){if(this.tileSetChoosePreset==null){this.tileSetChoosePreset=new TileSetChoosePreset;this.tileSetChoosePreset.init(this.editor)}return this.tileSetChoosePreset},showSave:function(){if(this.tileSetSave==null){this.tileSetSave=new TileSetSave;this.tileSetSave.init(this.editor)}this.tileSetSave.show()},showCharacterPicker:function(e,t,i){if(this.tilePickerPopup==null){this.tilePickerPopup=new TilePickerPopup;this.tilePickerPopup.init(this.editor)}this.tilePickerPopup.show(e,t,i)}};if(!HTMLCanvasElement.prototype.toBlob){Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,s,e){var o=this.toDataURL(s,e).split(",")[1];setTimeout(function(){var e=atob(o),t=e.length,i=new Uint8Array(t);for(var r=0;r<t;r++){i[r]=e.charCodeAt(r)}a(new Blob([i],{type:s||"image/png"}))})}})}var TileSet=function(){this.tileSetId=null;this.name="";this.label="";this.type="petscii";this.charWidth=8;this.charHeight=8;this.charDepth=8;this.pixelWidth=1;this.pixelHeight=1;this.pixelDepth=1;this.pixelTo3dUnits=.25;this.colorType="monochrome";this.customCharacterset=false;this.font=null;this.vectorData=[];this.currentTileData=[];this.tileData=[];this.characterGeometries=[];this.characterBackgroundGeometries=[];this.geometryDirty=[];this.importCanvas=null;this.importContext=null;this.tileCount=25;this.editor=null;this.backgroundIsTransparent=true;this.paletteMaps={};this.hFlipMap=[];this.vFlipMap=[];this.characterRotationSets=[[79,80,122,76],[250,204,207,208],[77,78,77,78],[206,205],[112,110,125,109],[240,238,253,237],[85,73,75,74],[203,202,213,201],[114,115,113,107],[243,241,235,242],[126,124,108,123],[236,251,254,252],[105,95,233,223],[98,97,226,225],[99,103,100,101],[231,228,229,227],[119,106,111,116],[121,117,120,118],[98,97,226,225],[246,249,245,248],[234,239,244,247],[231,228,229,227],[82,84,69,89],[70,71,68,72],[64,93],[66,67],[27,29],[155,157],[40,41,41,40],[168,169,169,168],[60,62,62,60],[188,190,190,188],[30,31,31,30],[127,255],[92,104,92,104],[220,232],[102,230,102,230],[86,91],[214,219]];this.glyphCanvas=null;this.unitsPerEm=1;this.ascent=0;this.descent=0;this.blankCharacter=32;this.filledCharacter=false;this.vectorPetscii=false;this.tile3d=null};TileSet.prototype={setToVector:function(a,s){this.setType("vector");var o=this;var e="vectorsets/"+a+".json?3";$.get(e,function(e){o.blankCharacter=0;o.vectorPetscii=false;if(a=="petscii"||a=="petscii-thin"){o.vectorPetscii=true;o.blankCharacter=32}o.docRecord.data.vectorData=e.data;o.unitsPerEm=e.unitsPerEm;o.ascent=e.ascent;o.descent=e.descent;if(typeof e.blankTile!="undefined"){o.blankCharacter=e.blankTile}if(typeof e.filledCharacter!="undefined"){o.filledCharacter=e.filledTile}o.vectorData=e.data;for(var t=0;t<o.vectorData.length;t++){o.vectorData[t].path2d=null}o.tileCount=o.vectorData.length;var i=8;var r=8;if(typeof e.tileWidth!="undefined"){i=e.tileWidth}if(typeof e.tileHeight!="undefined"){r=e.tileHeight}o.setCharDimensions(i,r);o.setSortMethods();if(typeof s!="undefined"){s()}})},getFontScale:function(e){if(this.vectorData==null){return 1}return 1/this.unitsPerEm},getFontAscent:function(){return this.ascent},getFontDescent:function(){return this.descent},getSVGPath:function(e){if(e==this.editor.tileSetManager.noTile){return false}if(e!==false&&e<this.vectorData.length){return this.vectorData[e].path}return false},getGlyphPath:function(e){if(this.vectorData==null){return null}if(e==this.editor.tileSetManager.noTile){return null}if(e!==false&&e<this.vectorData.length){if(this.vectorData[e].path2d==null){this.vectorData[e].path2d=new Path2D(this.vectorData[e].path)}return this.vectorData[e].path2d}return null},getDocRecord:function(){return g_app.doc.getDocRecordById(this.tileSetId,"/tile sets")},getName:function(){var e=this.getDocRecord();return e.name},modified:function(){if(g_app.openingProject){return}if(g_app.doc&&this.docRecord&&this.docRecord.name!=null){var e="/tile sets/"+this.docRecord.name;g_app.doc.recordModified(this.docRecord,e)}},init:function(e,t,i,r){this.editor=e;if(typeof t==="undefined"){this.name="Tile Set"}else{this.name=t}if(typeof r!="undefined"){this.type=r}this.tileSetId=i;this.docRecord=this.getDocRecord();this.name=this.docRecord.name;if(typeof this.docRecord.data.tileData=="undefined"){if(typeof this.docRecord.data.characterData!="undefined"){this.docRecord.data.tileData=this.docRecord.data.characterData}else{this.docRecord.data.tileData=[]}}this.tileData=this.docRecord.data.tileData;this.tileCount=this.tileData.length;this.charWidth=this.docRecord.data.width;this.charHeight=this.docRecord.data.height;this.updateAllCharacterCurrentData();this.canvas=document.createElement("canvas");this.characterGeometries=[];this.characterBackgroundGeometries=[];this.geometryDirty=[]},nameChanged:function(){var e=this.getDocRecord();this.name=e.name},getPath:function(){return"/tile sets/"+this.name},setLabel:function(e){this.label=e},getType:function(){return this.type},setTileDimensions:function(e){var t=e.offsetX;var i=e.offsetY;var r=e.width;var a=e.height;var s=this.charWidth;var o=this.charHeight;this.charWidth=r;this.charHeight=a;this.docRecord.data.width=r;this.docRecord.data.height=a;for(var l=0;l<this.tileData.length;l++){for(var n=0;n<this.tileData[l].data.length;n++){var h=this.tileData[l].data[n];var d=[];for(var c=0;c<a;c++){for(var f=0;f<r;f++){d.push(0)}}var u=0;for(var c=0;c<o;c++){for(var f=0;f<s;f++){if(c<a&&f<r){d[c*r+f]=h[c*s+f]}}}this.tileData[l].data[n]=d}this.updateCharacterCurrentData(l)}},setType:function(e){this.type=e;if(g_app.doc&&this.editor!=null){if(this.getTileWidth()==8&&this.getTileHeight()==8){$("#drawTool_linesegment").show();if(this.editor.tools.drawTools.tool=="linesegment"){this.editor.tools.drawTools.lineSegmentDraw.initCharset()}}else{$("#drawTool_linesegment").hide()}}},getId:function(){return this.tileSetId},getHFlip:function(e){if(this.hFlipMap[e]!==false){return this.hFlipMap[e]}return e},getVFlip:function(e){if(this.vFlipMap[e]!==false){return this.vFlipMap[e]}return e},getCharacterDataCopy:function(){var e=[];for(var t=0;t<this.tileCount;t++){var i=[];for(var r=0;r<this.tileData[t].data[0].length;r++){i.push(this.tileData[t].data[0][r])}e.push(i)}return e},restoreCharacterDataFor:function(e,t){for(var i=0;i<t.length;i++){var r=t[i];var a=e[r];for(var s=0;s<this.tileData[r].data[0].length;s++){this.tileData[r].data[0][s]=e[r][s]}}},getPaletteMap:function(e){var t=this.getDocRecord();var i=t.data.sortMethods;for(var r=0;r<i.length;r++){if(i[r].id==e){if(typeof i[r].map!="undefined"){return i[r].map}break}}return false},setPaletteMap:function(e,t){var i=this.getDocRecord();var r=i.data.sortMethods;var a=false;for(var s=0;s<r.length;s++){if(r[s].id==e){a=s;break}}if(a===false){a=r.length;r.push({name:e,id:e})}var o={rowsPerColumn:t.rowsPerColumn,data:[]};for(var l=0;l<t.length;l++){o.data[l]=[];for(var n=0;n<t.data[l].length;n++){o.data[l][n]=t.data[l][n]}}r[a].map=t},buildHFlipMap:function(){this.hFlipMap=[];for(var e=0;e<this.tileCount;e++){this.hFlipMap[e]=false}if(this.getType()=="vector"){return}for(var t=0;t<this.tileCount;t++){var i=this.tileData[t].data[0];for(var r=t+1;r<this.tileCount;r++){var a=this.tileData[r].data[0];var s=true;for(var o=0;o<this.charHeight;o++){var l=o*this.charWidth;for(var n=0;n<this.charWidth;n++){if(i[l+n]!=a[l+this.charWidth-1-n]){s=false;n=this.charWidth;o=this.charHeight;break}}}if(s){this.hFlipMap[t]=r;this.hFlipMap[r]=t;break}}}},buildVFlipMap:function(){this.vFlipMap=[];for(var e=0;e<this.tileCount;e++){this.vFlipMap[e]=false}if(this.getType()=="vector"){return}for(var t=0;t<this.tileCount;t++){var i=this.tileData[t].data[0];for(var r=t+1;r<this.tileCount;r++){var a=this.tileData[r].data[0];var s=true;for(var o=0;o<this.charHeight;o++){var l=o*this.charWidth;var n=(this.charHeight-1-o)*this.charWidth;for(var h=0;h<this.charWidth;h++){if(i[l+h]!=a[n+h]){s=false;h=this.charWidth;o=this.charHeight;break}}}if(s){this.vFlipMap[t]=r;this.vFlipMap[r]=t;break}}}if(this.type=="petscii"){this.vFlipMap[95]=233;this.vFlipMap[233]=95;this.vFlipMap[105]=223;this.vFlipMap[223]=105}},newPixelData:function(e){var t=e;if(typeof e=="undefined"){t=this.charWidth*this.charHeight}var i=[];for(var r=0;r<t;r++){i.push(0)}return i},updateCharacterCurrentData:function(e){if(e>=this.tileData.length){return}var t=this.tileData[e].props;var i=this.tileData[e].data;while(this.currentTileData.length<=e){this.currentTileData.push([])}var r=0;for(var a=0;a<i[r].length;a++){this.currentTileData[e][a]=i[r][a]}},findRotatedChar:function(e){if(this.charWidth!=this.charHeight){return e}var t=this.tileData[e].data[0];for(var i=0;i<this.tileCount;i++){var r=this.tileData[i].data[0];var a=true;for(var s=0;s<this.charHeight;s++){var o=s*this.charWidth;for(var l=0;l<this.charWidth;l++){if(t[o+l]!=r[this.charWidth-1-s+l*this.charWidth]){a=false;l=this.charWidth;s=this.charHeight;break}}}if(a){return i}}return e},findHShiftedChar:function(e){},findVShiftedChar:function(e){},findShiftedInvertedChar:function(e){},getTileRotation:function(e,t){if(this.type=="petscii"){for(var i=0;i<this.characterRotationSets.length;i++){for(var r=0;r<this.characterRotationSets[i].length;r++){if(this.characterRotationSets[i][r]==e){t=t%this.characterRotationSets[i].length;if(t<this.characterRotationSets[i].length){return this.characterRotationSets[i][t]}break}}}return e}},getCharNextRotation:function(e){if(this.type=="petscii"){for(var t=0;t<this.characterRotationSets.length;t++){for(var i=0;i<this.characterRotationSets[t].length;i++){if(this.characterRotationSets[t][i]==e){i++;if(i>=this.characterRotationSets[t].length){i=0}return this.characterRotationSets[t][i]}}}return false}if(this.type!=="vector"){return this.findRotatedChar(e)}return false},updateAllCharacterCurrentData:function(){for(var e=0;e<this.tileData.length;e++){this.updateCharacterCurrentData(e)}},getTileCount:function(){return this.tileCount},copyTile:function(e,t){var i=this.tileData[e].props;var r=this.tileData[e].data;var a=this.tileData[t].props;var s=[];for(var o in i){if(i.hasOwnProperty(o)){a[o]=i[o]}}for(var l=0;l<r.length;l++){var n=r[l];var h=[];for(var d=0;d<n.length;d++){h.push(n[d])}s.push(h)}this.tileData[t].data=s;this.updateAllCharacterCurrentData()},duplicateTile:function(e){var t=this.tileCount;this.setTileCount(this.tileCount+1);this.copyTile(e,t);return t},createTile:function(){var e=false;var t=this.getTileCount();e=t;this.setTileCount(t+1);return e},setTileCount:function(e){while(this.tileData.length<e){var t=this.charWidth*this.charHeight;var i=g_app.textModeEditor.colorPaletteManager.noColor;this.tileData.push({data:[this.newPixelData(t)],props:{animated:false,ticksPerFrame:1,frameCount:1,frame:0,lastTick:0,fc:1,bc:i}})}this.tileCount=e;this.modified();this.updateAllCharacterCurrentData()},getTileColor:function(e){if(e!==false&&e!=this.editor.tileSetManager.noTile&&e<this.tileData.length&&typeof this.tileData[e].props.fc!="undefined"){return this.tileData[e].props.fc}return 1},setTileColor:function(e,t){if(e!=this.editor.tileSetManager.noTile&&e<this.tileData.length){this.tileData[e].props.fc=t;this.modified()}},getTileBGColor:function(e){if(e!=this.editor.tileSetManager.noTile&&e<this.tileData.length&&typeof this.tileData[e].props.bc!="undefined"){return this.tileData[e].props.bc}return 0},setTileBGColor:function(e,t){if(e!=this.editor.tileSetManager.noTile&&e<this.tileData.length){this.tileData[e].props.bc=t;this.modified()}},getTileMaterial:function(e){if(e!=this.editor.tileSetManager.noTile&&e!==false&&e<this.tileData.length&&typeof this.tileData[e].props.m!="undefined"){return this.tileData[e].props.m}return 0},setTileMaterial:function(e,t){if(e!=this.editor.tileSetManager.noTile&&e<this.tileData.length){this.tileData[e].props.m=t}},getCharacterBGColor:function(e){if(e!=this.editor.tileSetManager.noTile&&e<this.tileData.length&&typeof this.tileData[e].props.bc!="undefined"){return this.tileData[e].props.bc}return this.editor.colorPaletteManager.noColor},setCharacterBGColor:function(e,t){this.tileData[e].props.bc=t;this.modified()},clear:function(){},isDefaultTileSet:function(e){return false},setToPreset:function(e,t){var i="textmode";var r=e.indexOf(":");if(r!=-1){i=e.substring(0,r);e=e.substring(r+1)}if(i=="vector"){this.setToVector(e,t);return}var a=false;var s=8;var o=8;var l="ascii";var n="";for(var h in CharacterSetPresets){if(CharacterSetPresets.hasOwnProperty(h)){for(var d=0;d<CharacterSetPresets[h].characterSets.length;d++){var c=CharacterSetPresets[h].characterSets[d].id;var f=CharacterSetPresets[h].characterSets[d].options;var u=false;if(typeof f!="undefined"){for(var p=0;p<f.length;p++){if(e==f[p].id){s=CharacterSetPresets[h].characterSets[d].width;o=CharacterSetPresets[h].characterSets[d].height;if(typeof CharacterSetPresets[h].characterSets[d].type!="undefined"){l=CharacterSetPresets[h].characterSets[d].type}if(typeof CharacterSetPresets[h].characterSets[d].name!="undefined"){n=CharacterSetPresets[h].characterSets[d].name}a=f[p].id+".png";u=true;break}}}if(u){break}if(c==e){s=CharacterSetPresets[h].characterSets[d].width;o=CharacterSetPresets[h].characterSets[d].height;if(typeof CharacterSetPresets[h].characterSets[d].type!="undefined"){l=CharacterSetPresets[h].characterSets[d].type}if(typeof CharacterSetPresets[h].characterSets[d].name!="undefined"){n=CharacterSetPresets[h].characterSets[d].name}a=c+".png";break}}}}if(a===false){return}var v=this;var g="charsets/"+a;var m=new Image;m.onload=function(){v.type=l;v.customCharacterset=e!=="petscii";v.type=l;v.label=n;v.preset=e;v.setCharDimensions(s,o);v.importImage(m);v.setSortMethods();if(t){t()}};m.src=g},copyTileSet:function(e){this.type=e.getType();this.label=e.label;this.setCharDimensions(e.getTileWidth(),e.getTileHeight());this.docRecord=this.getDocRecord();this.docRecord.data.tileData=[];this.tileData=this.docRecord.data.tileData;var t=e.tileData;this.setTileCount(t.length);if(this.type=="vector"){this.docRecord.data.type="vector";console.log(this.docRecord);this.vectorData=[];var i=e.vectorData;for(var r=0;r<i.length;r++){this.vectorData.push({name:i[r].name,unicode:i[r].unicode,path:i[r].path,path2d:null})}this.docRecord.data.vectorData=this.vectorData;this.unitsPerEm=e.unitsPerEm;this.ascent=e.ascent;this.descent=e.descent;this.setTileCount(i.length)}for(var a=0;a<t.length;a++){this.tileData[a]=t[a];var s={animated:false,ticksPerFrame:1,frameCount:1,frame:0,lastTick:0,fc:1,bc:this.editor.colorPaletteManager.noColor};if(typeof t[a].props!=="undefined"){if(typeof t[a].props.animated!="undefined"){s.animated=t[a].props.animated;s.frameCount=t[a].props.frames;s.ticksPerFrame=t[a].props.ticksPerFrame}if(typeof t[a].props.fc!="undefined"){s.fc=t[a].props.fc}if(typeof t[a].props.bc!="undefined"){s.bc=t[a].props.bc}if(typeof t[a].props.m!="undefined"){s.m=t[a].props.m}}this.tileData[a].props=s}this.setSortMethods();this.updateAllCharacterCurrentData();this.refreshFromImageData()},getSortMethods:function(){if(typeof this.docRecord.data.sortMethods=="undefined"){this.setSortMethods()}return this.docRecord.data.sortMethods},setSortMethods:function(){if(g_app.doc==null||this.editor==null){return}if(this.type=="petscii"||this.type=="vector"&&this.vectorPetscii){this.docRecord.data.sortMethods=[{name:"Tile Index",id:"source"},{name:"Columns of 16",id:"columns"},{name:"Group Similar",id:"similar"},{name:"Group Graphic",id:"petsciigraphic"},{name:"Custom",id:"custom"}]}else{this.docRecord.data.sortMethods=[{name:"Tile Index",id:"source"},{name:"Columns of 16",id:"columns"},{name:"Custom",id:"custom"}]}},setCharDimensions:function(e,t){this.charWidth=e;this.charHeight=t;if(g_app.doc&&this.docRecord&&this.docRecord.data){this.docRecord.data.width=e;this.docRecord.data.height=t;this.modified()}var i=e*t;for(var r=0;r<this.tileData.length;r++){var a=this.tileData[r].data.length;for(var s=0;s<a;s++){if(this.tileData[r].data[s].length!=i){this.tileData[r].data[s]=this.newPixelData(i)}}}},getTileWidth:function(){return this.charWidth},getTileHeight:function(){return this.charHeight},getTileDepth:function(){return this.charDepth},getBlankCharacter:function(){return this.getBlankTile()},getBlockTile:function(){return this.filledCharacter},getBlankTile:function(){var e=32;var t=true;if(this.tileCount==0){return 0}if(this.type=="vector"){return this.blankCharacter}if(e>this.tileCount){e=this.tileCount-1}for(var i=0;i<this.charHeight;i++){for(var r=0;r<this.charWidth;r++){var a=this.getPixel(e,r,i);if(a>0){t=false;i=this.charHeight;break}}}if(t){return e}for(var s=0;s<this.tileCount;s++){var t=this.isBlank(s);if(t){return s}}return false},isBlank:function(e){for(var t=0;t<this.charHeight;t++){for(var i=0;i<this.charWidth;i++){var r=this.getPixel(e,i,t);if(r>0){return false}}}return true},getAttribBinaryData:function(e){var t=new Uint8Array(this.tileCount);for(var i=0;i<this.tileCount;i++){var r=this.getTileColor(i)&15;var a=this.getTileMaterial(i)&15;var s=r+(a<<4);t[i]=s}return t},getBinaryData:function(e){var t=[];var i=0;if(typeof e!="undefined"&&e.format=="c64"){t[i++]=0;t[i++]=56}for(var r=0;r<this.tileCount;r++){var a=r;for(var s=0;s<8;s++){var o=0;for(var l=0;l<8;l++){if(this.getPixel(a,l,s)){o=o|1<<7-l}}t[i++]=o}}var n=new Uint8Array(t.length);for(var r=0;r<t.length;r++){n[r]=t[r]}return n},exportBinary:function(e,t){var i=this.getBinaryData(t);if(e.indexOf(".bin")==-1){e+=".bin"}download(i,e,"application/bin")},exportPngFromMap:function(e){var t=e.map;var i=t.length;var r=t[0].length;if(this.importCanvas==null){this.importCanvas=document.createElement("canvas")}this.importCanvas.width=r*this.charWidth;this.importCanvas.height=i*this.charHeight;this.importContext=this.importCanvas.getContext("2d");this.importContext.clearRect(0,0,this.importCanvas.width,this.importCanvas.height);var a=this.importContext.getImageData(0,0,this.importCanvas.width,this.importCanvas.height);for(var s=0;s<i;s++){for(var o=0;o<r;o++){var l=t[s][o];var n=l.c;var h=l.fc;var d=l.bc;if(n!==-1){var e={};e["imageData"]=a;e["character"]=n;e["color"]=h;e["bgColor"]=d;e["scale"]=1;e["x"]=o*this.charWidth;e["y"]=s*this.charHeight;this.drawCharacter(e)}}}this.importContext.putImageData(a,0,0);var c=this.importCanvas.toDataURL("image/png").split(",")[1];var f=atob(c),u=f.length,p=new Uint8Array(u);for(var v=0;v<u;v++){p[v]=f.charCodeAt(v)}return new Blob([p],{type:"image/png"})},exportPng:function(e){var t=false;if(this.importCanvas==null){this.importCanvas=document.createElement("canvas")}var i=this.getTileCount();var r=16;var a=Math.ceil(i/r);if(typeof e!="undefined"){if(typeof e.filename!="undefined"){t=e.filename}if(typeof e.tilesAcross!="undefined"){r=e.tilesAcross}}this.importCanvas.width=r*this.charWidth;this.importCanvas.height=a*this.charHeight;this.importContext=this.importCanvas.getContext("2d");this.importContext.clearRect(0,0,this.importCanvas.width,this.importCanvas.height);var s=this.importContext.getImageData(0,0,this.importCanvas.width,this.importCanvas.height);for(var o=0;o<a;o++){for(var l=0;l<r;l++){var n=l+o*r;if(n<i){var e={};e["imageData"]=s;e["character"]=n;e["colorRGB"]=16777215;e["bgColorRGB"]=false;e["scale"]=1;e["x"]=l*this.charWidth;e["y"]=o*this.charHeight;this.drawCharacter(e)}}}this.importContext.putImageData(s,0,0);if(t!==false){if(t.indexOf(".png")==-1){t+=".png"}var h=this.importCanvas.toDataURL("image/png");if(UI.isMobile.any()){mobileDownload({data:h,filename:t,mimeType:"image/png"})}else{download(h,t,"image/png")}}else{var h=this.importCanvas.toDataURL("image/png").split(",")[1];var d=atob(h),c=d.length,f=new Uint8Array(c);for(var u=0;u<c;u++){f[u]=d.charCodeAt(u)}return new Blob([f],{type:"image/png"})}},readJsonData:function(e){var t=e.jsonData;var i=null;if(typeof e.dstImageData!="undefined"){i=e.dstImageData}var r=this.charWidth;if(typeof t.data.width!="undefined"){r=t.data.width}var a=this.charHeight;if(typeof t.data.height!="undefined"){a=t.data.height}var s=1;if(typeof e.scale!="undefined"){s=e.scale}var o=t.data.tileData;if(i==null){if(g_app.doc){this.docRecord=this.getDocRecord();this.docRecord.data.tileData=[];this.tileData=this.docRecord.data.tileData}else{this.tileData=[]}this.setCharDimensions(r,a);this.setTileCount(o.length)}var l=16;if(typeof e.dstCharactersAcross!="undefined"){l=e.dstCharactersAcross}var n=1;if(typeof e.dstCharacterSpacing!="undefined"){n=e.dstCharacterSpacing}for(var h=0;h<o.length;h++){var d=o[h].data[0];var c=h%l;var f=Math.floor(h/l);if(i==null){this.tileData[h]=o[h]}else{for(var u=0;u<a*s;u++){for(var p=0;p<r*s;p++){var v=Math.floor(p/s)+Math.floor(u/s)*r;var g=0;if(i){var m=n+c*(r*s+n)+p;var y=n+f*(a*s+n)+u;g=(m+y*i.width)*4}var b=d[v];var C=255;var x=0;if(b>0){i.data[g]=C;i.data[g+1]=C;i.data[g+2]=C;i.data[g+3]=C}else{i.data[g]=x;i.data[g+1]=x;i.data[g+2]=x;i.data[g+3]=255}}}}}if(i==null){this.updateAllCharacterCurrentData();this.refreshFromImageData()}},readCharPad:function(e){var t=null;if(typeof e.dstImageData!="undefined"){t=e.dstImageData}},readJsonDataV1:function(e){var t=e.jsonData;var i=null;if(typeof e.dstImageData!="undefined"){i=e.dstImageData}var r=this.charWidth;if(typeof t.width!="undefined"){r=t.width}var a=this.charHeight;if(typeof t.height!="undefined"){a=t.height}var s=1;if(typeof e.scale!="undefined"){s=e.scale}var o=t.tiles;if(i==null){this.docRecord=this.getDocRecord();this.docRecord.data.tileData=[];this.tileData=this.docRecord.data.tileData;this.setCharDimensions(r,a);this.setTileCount(o.length);if(typeof t.type!="undefined"){if(t.type=="vector"){this.type="vector";this.docRecord.data.type="vector";console.log(this.docRecord);var l=t.vectorData;this.vectorData=[];for(var n=0;n<l.length;n++){this.vectorData.push({name:l[n].name,unicode:l[n].unicode,path:l[n].path,path2d:null})}this.docRecord.data.vectorData=this.vectorData;this.unitsPerEm=t.unitsPerEm;this.ascent=t.ascent;this.descent=t.descent;this.setTileCount(l.length)}}}var h=16;if(typeof e.dstCharactersAcross!="undefined"){h=e.dstCharactersAcross}var d=1;if(typeof e.dstCharacterSpacing!="undefined"){d=e.dstCharacterSpacing}for(var c=0;c<o.length;c++){var f=o[c].data[0];var u=c%h;var p=Math.floor(c/h);if(i==null){this.tileData[c]=o[c];var v={animated:false,ticksPerFrame:1,frameCount:1,frame:0,lastTick:0,fc:1,bc:this.editor.colorPaletteManager.noColor};if(typeof o[c].props!=="undefined"){if(typeof o[c].props.animated!="undefined"){v.animated=o[c].props.animated;v.frameCount=o[c].props.frames;v.ticksPerFrame=o[c].props.ticksPerFrame}if(typeof o[c].props.fc!="undefined"){v.fc=o[c].props.fc}if(typeof o[c].props.bc!="undefined"){v.bc=o[c].props.bc}if(typeof o[c].props.m!="undefined"){v.m=o[c].props.m}}this.tileData[c].props=v}else{for(var g=0;g<a*s;g++){for(var m=0;m<r*s;m++){var y=Math.floor(m/s)+Math.floor(g/s)*r;var b=0;if(i){var C=d+u*(r*s+d)+m;var x=d+p*(a*s+d)+g;b=(C+x*i.width)*4}var S=f[y];var P=255;var w=0;if(S>0){i.data[b]=P;i.data[b+1]=P;i.data[b+2]=P;i.data[b+3]=P}else{i.data[b]=w;i.data[b+1]=w;i.data[b+2]=w;i.data[b+3]=255}}}}}if(i==null){if(typeof t.paletteLayouts!="undefined"&&t.paletteLayouts.length>0){this.docRecord.data.sortMethods=[];var I=this.docRecord.data.sortMethods;for(var n=0;n<t.paletteLayouts.length;n++){var k={name:t.paletteLayouts[n].name,id:t.paletteLayouts[n].id};if(typeof t.paletteLayouts[n].map!="undefined"){var M=t.paletteLayouts[n].map.rowsPerColumn;var T=t.paletteLayouts[n].map.data;k.map={rowsPerColumn:M,data:[]};for(var g=0;g<T.length;g++){k.map.data[g]=[];for(var m=0;m<T[g].length;m++){k.map.data[g][m]=T[g][m]}}}I.push(k)}}else{if(typeof t.sortMethods!="undefined"){if(typeof t.type!="undefined"&&t.type=="vector"){this.type="vector"}else{this.type="ascii";for(var n=0;n<t.sortMethods.length;n++){if(t.sortMethods[n]=="petscii"){this.type="petscii";break}}}}this.setSortMethods()}this.updateAllCharacterCurrentData();this.refreshFromImageData();if(typeof t.blockSet!="undefined"){var D="/tile sets/"+this.name+"/block sets/block set";var E=this.editor.blockSetManager.getBlockSet(D);E.clear();for(var $=0;$<t.blockSet.length;$++){var e={};e.colorMode=t.blockSet[$].colorMode;if(typeof t.blockSet[$].fc!="undefined"){e.fc=t.blockSet[$].fc}if(typeof t.blockSet[$].bc!="undefined"){e.bc=t.blockSet[$].bc}else{e.bc=this.editor.colorPaletteManager.noColor}e.data=[];var o=t.blockSet[$].tileData;for(var g=0;g<o.length;g++){var _=[];for(var m=0;m<o[g].length;m++){var B={};B.t=o[g][m].t;for(var R in o[g][m]){if(R!="t"){B[R]=o[g][m][R]}}_.push(B)}e.data.push(_)}E.createBlock(e)}}}},getBlockSet:function(){var e="/tile sets/"+this.name+"/block sets/block set";var t=this.editor.blockSetManager.getBlockSet(e);return t},getJSON:function(){var e={};e.id=this.docRecord.id;e.name=this.docRecord.name;e.version=1;e.width=this.docRecord.data.width;e.height=this.docRecord.data.height;e.type=this.type;e.sortMethods=["index"];if(this.type=="petscii"){e.sortMethods.push("petscii")}var t=this.docRecord.data.sortMethods;e.paletteLayouts=[];for(var i=0;i<t.length;i++){var r={};r.name=t[i].name;r.id=t[i].id;if(typeof t[i].map!="undefined"){r.map=t[i].map}e.paletteLayouts.push(r)}if(e.type=="vector"){var a=[];for(var i=0;i<this.vectorData.length;i++){a.push({name:this.vectorData[i].name,unicode:this.vectorData[i].unicode,path:this.vectorData[i].path})}e.vectorData=a;e.unitsPerEm=this.unitsPerEm;e.ascent=this.ascent;e.descent=this.descent}var s={};var o=this.docRecord.data.tileData;var l=this.editor.getColorPerMode()=="character";var n=[];for(var i=0;i<o.length;i++){var h={};h.data=o[i].data;if(o[i].props.animated||l){h.props={};if(o[i].props.animated){h.props.animated=o[i].props.animated;h.props.frames=o[i].props.frameCount;h.props.ticksPerFrame=o[i].props.ticksPerFrame}if(l){h.props.fc=o[i].props.fc;h.props.bc=o[i].props.bc}}if(typeof o[i].props.m!="undefined"){if(typeof h.props=="undefined"){h.props={}}h.props.m=o[i].props.m}n.push(h)}e.tiles=n;var d=this.editor.blockSetManager.getCurrentBlockSet();if(d){var c=d.getBlockCount();if(c>0){var f=d.getBlocks();var u=[];for(var p=0;p<f.length;p++){var v={};v.colorMode=f[p].colorMode;if(v.colorMode=="perblock"){v.fc=f[p].fc;v.bc=f[p].bc}var o=[];for(var g=0;g<f[p].data.length;g++){var m=[];for(var y=0;y<f[p].data[g].length;y++){var h={};h.t=f[p].data[g][y].t;if(v.colorMode=="percell"){h.fc=f[p].data[g][y].fc;h.bc=f[p].data[g][y].bc}m.push(h)}o.push(m)}v.tileData=o;u.push(v)}e.blockSet=u}}return e},saveAsJson:function(e){var t=this.getJSON();jsonString=JSON.stringify(t);if(e.indexOf(".json")==-1){e+=".json"}download(jsonString,e,"application/json")},readCharData:function(e){var t=e.tileData;var i=null;if(typeof e.dstImageData!="undefined"){i=e.dstImageData}var r=this.charWidth;if(typeof e.characterWidth!="undefined"){r=e.characterWidth}var a=this.charHeight;if(typeof e.characterHeight!="undefined"){a=e.characterHeight}var s=256;var o=0;for(var l=0;l<s;l++){var n=l%f;var h=Math.floor(l/f);var d=1;var c=0;if(i!=null){d=255;c=0}if(i==null){this.tileData[l].props.animated=false}var f=16;if(typeof e.dstCharactersAcross!="undefined"){f=e.dstCharactersAcross}var u=1;if(typeof e.dstCharacterSpacing!="undefined"){u=e.dstCharacterSpacing}for(var p=0;p<a;p++){for(var v=0;v<r;v++){var g=0;if(i){var m=u+n*(r*scale+u)+v;var y=u+h*(a*scale+u)+p;g=(m+y*i.width)*4}var b=v+p*r;if(l<s&&l>=o){if(t[l][b]){if(i){i.data[g]=d;i.data[g+1]=d;i.data[g+2]=d;i.data[g+3]=d}else{this.tileData[l].data[0][b]=t[l][b]}}else{if(i){i.data[g]=c;i.data[g+1]=c;i.data[g+2]=c;i.data[g+3]=255}else{this.tileData[l].data[0][b]=t[l][b]}}}else{if(i){i.data[g]=40;i.data[g+1]=40;i.data[g+2]=40;i.data[g+3]=255}}}}}if(i==null&&g_app.doc!=null){this.updateAllCharacterCurrentData();if(this.isPetscii()){this.setType("petscii")}else{this.setType("custom")}this.setSortMethods();this.refreshFromImageData()}},readBinaryData:function(e){var t=e.tileData;var i=null;if(typeof e.dstImageData!="undefined"){i=e.dstImageData}var r=this.charWidth;if(typeof e.characterWidth!="undefined"){r=e.characterWidth}var a=this.charHeight;if(typeof e.characterHeight!="undefined"){a=e.characterHeight}var s=16;if(typeof e.charactersAcross!="undefined"){s=e.charactersAcross}var o=0;if(typeof e.startChar!="undefined"){o=e.startChar}var l=0;if(typeof e.characterDataOffset!="undefined"){l=e.characterDataOffset}var n=256;if(typeof e.tileCount!="undefined"){n=e.tileCount}var h=false;if(typeof e.tileSetInvert!="undefined"){h=e.tileSetInvert}var d=16;if(typeof e.dstCharactersAcross!="undefined"){d=e.dstCharactersAcross}var c=1;if(typeof e.dstCharacterSpacing!="undefined"){c=e.dstCharacterSpacing}var f=1;if(typeof e.scale!="undefined"){f=e.scale}if(i==null){if(g_app.doc!=null){this.docRecord=this.getDocRecord();this.docRecord.data.tileData=[];this.tileData=this.docRecord.data.tileData}else{this.tileData=[]}this.setCharDimensions(r,a);this.setTileCount(n)}for(var u=0;u<n;u++){var p=(u-o)%s;var v=Math.floor((u-o)/s);var g=u*(r*a);var m=u%d;var y=Math.floor(u/d);var b=1;var C=0;if(i!=null){b=255;C=0}if(h){var x=b;b=C;C=x}if(i==null){this.tileData[u].props.animated=false}for(var S=0;S<a*f;S++){for(var P=0;P<r*f;P++){var w=P+S*r;var I=g+Math.floor(P/f)+Math.floor(S/f)*r;var k=l+Math.floor(I/8);var M=I%8;var T=t[k];var D=0;if(i){var E=c+m*(r*f+c)+P;var $=c+y*(a*f+c)+S;D=(E+$*i.width)*4}if(u<n&&u>=o){if(T&1<<7-M){if(i){i.data[D]=b;i.data[D+1]=b;i.data[D+2]=b;i.data[D+3]=b}else{this.tileData[u].data[0][w]=b}}else{if(i){i.data[D]=C;i.data[D+1]=C;i.data[D+2]=C;i.data[D+3]=255}else{this.tileData[u].data[0][w]=C}}}else{if(i){i.data[D]=40;i.data[D+1]=40;i.data[D+2]=40;i.data[D+3]=255}}}}}if(i==null){this.updateAllCharacterCurrentData();if(this.isPetscii()){this.setType("petscii")}else{this.setType("custom")}this.setSortMethods();this.refreshFromImageData()}},isPetscii:function(){if(g_app.doc==null||this.editor==null){return}if(this.getTileWidth()!=8||this.getTileHeight()!=8){return false}if(this.getTileCount()!=256){return false}if(this.type=="vector"){return false}var e=0;for(var t=0;t<256;t++){for(var i=0;i<8;i++){var r=0;for(var a=0;a<8;a++){if(this.getPixel(t,a,i)){r+=1<<7-a}}if(r!=romDump.character[e++]){return false}}}return true},readVectorData:function(e){var t=e.font;var i=e.fontSize;var r=null;if(typeof e.dstImageData!="undefined"){r=e.dstImageData}var a=this.charWidth;if(typeof e.tileWidth!="undefined"){a=e.tileWidth}var s=this.charHeight;if(typeof e.tileHeight!="undefined"){s=e.tileHeight}var o=0;if(typeof e.tileHOffset!="undefined"){o=e.tileHOffset}var l=0;if(typeof e.tileVOffset!="undefined"){l=e.tileVOffset}var n=255;if(typeof e.tileCount!="undefined"){n=e.tileCount}var h=0;var d=0;if(typeof e.firstChar!="undefined"){d=e.firstChar}if(r==null){this.docRecord=this.getDocRecord();this.docRecord.data.tileData=[];this.tileData=this.docRecord.data.tileData;this.setCharDimensions(a,s);this.setTileCount(n)}var c=16;if(typeof e.dstTilesAcross!="undefined"){c=e.dstTilesAcross}var f=1;if(typeof e.dstTileSpacing!="undefined"){f=e.dstTileSpacing}if(!this.glyphCanvas){this.glyphCanvas=document.createElement("canvas")}this.glyphCanvas.width=Math.floor(a);this.glyphCanvas.height=Math.floor(s);var u=this.glyphCanvas.getContext("2d");var p=i/t.head.unitsPerEm;for(var v=0;v<n;v++){var g=null;if(r==null){this.tileData[v].props.animated=false;g=this.tileData[v].data[0]}var m=v%c;var y=Math.floor(v/c);var b=0;var C=1;var x=0;if(r!=null){C=255;x=0}glyphIndex=0;scale=1;var S=u.getImageData(0,0,a,s);for(var P=0;P<s*scale;P++){for(var w=0;w<a*scale;w++){var I=w+P*a;var k=P/scale*a*4+w/scale*4;if(r!=null){var M=f+m*(a*scale+f)+w;var T=f+y*(s*scale+f)+P;b=(M+T*r.width)*4}if(v<n&&v>=h){if(S.data[k]>100){if(r){r.data[b]=C;r.data[b+1]=C;r.data[b+2]=C;r.data[b+3]=C}else{g[I]=C}}else{if(r){r.data[b]=x;r.data[b+1]=x;r.data[b+2]=x;r.data[b+3]=255}else{g[I]=x}}}}}}if(r==null){this.updateAllCharacterCurrentData();this.refreshFromImageData()}},readImageData:function(e){var t=e.srcImageData;var i=null;if(typeof e.dstImageData!="undefined"){i=e.dstImageData}var r=false;if(typeof e.dstPosIsSrcPos!="undefined"){r=e.dstPosIsSrcPos}var a="textmode";if(typeof e.mode!="undefined"){a=e.mode}var s=[];if(typeof e.palette!="undefined"){s=e.palette}var o={};if(typeof e.paletteMap!="undefined"){o=e.paletteMap}var l=this.charWidth;if(typeof e.characterWidth!="undefined"){l=e.characterWidth}var n=this.charHeight;if(typeof e.characterHeight!="undefined"){n=e.characterHeight}var h=0;if(typeof e.characterHSpacing!="undefined"){h=e.characterHSpacing}var d=0;if(typeof e.characterVSpacing!="undefined"){d=e.characterVSpacing}var c=1;if(typeof e.pixelSpacing!="undefined"){c=e.pixelSpacing}var f=0;if(typeof e.characterHOffset!="undefined"){f=e.characterHOffset}var u=0;if(typeof e.characterVOffset!="undefined"){u=e.characterVOffset}var p=16;if(typeof e.charactersAcross!="undefined"){p=e.charactersAcross}var v=t.width;var g=t.height;var m=Math.floor(g/n)*p;if(typeof e.tileCount!="undefined"){m=e.tileCount}var y=Math.ceil(m/p);var b=0;if(typeof e.startChar!="undefined"){b=e.startChar}var C="across";if(typeof e.charSetDirection!="undefined"){charSetDirection=e.charSetDirection}var x=false;if(typeof e.tileSetInvert!="undefined"){x=e.tileSetInvert}var S=1;if(typeof e.scale!="undefined"){S=e.scale}if(i==null){if(g_app.doc&&this.getDocRecord()){this.docRecord=this.getDocRecord();this.docRecord.data.tileData=[];this.tileData=this.docRecord.data.tileData}else{this.tileData=[]}this.setCharDimensions(l,n);this.setTileCount(m)}var P=16;if(typeof e.dstCharactersAcross!="undefined"){P=e.dstCharactersAcross}var w=1;if(typeof e.dstCharacterSpacing!="undefined"){w=e.dstCharacterSpacing}for(var I=0;I<m;I++){var k=(I-b)%p;var M=Math.floor((I-b)/p);if(C=="down"){M=(I-b)%p;k=Math.floor((I-b)/p)}var T=null;if(i==null){this.tileData[I].props.animated=false;T=this.tileData[I].data[0]}var D=I%P;var E=Math.floor(I/P);var $=0;var _=1;var B=0;if(i!=null){_=255;B=0}if(x){var R=_;_=B;B=R}for(var A=0;A<n*S;A++){for(var F=0;F<l*S;F++){var L=F+A*l;var U=f+h+k*(l*c+h)+Math.floor(F*c/S);var H=u+d+M*(n*c+d)+Math.floor(A*c/S);var O=(U+H*v)*4;if(i!=null){var G=w+D*(l*S+w)+F;var z=w+E*(n*S+w)+A;if(r){$=O}else{$=(G+z*i.width)*4}}if(U<0||H<0||U>=v||H>=g){}else if(this.tileSetMulticolor){}else{if(I<m&&I>=b){if(a!="indexed"&&a!="rgb"){var N=t.data[O];var W=t.data[O+1];var X=t.data[O+2];if(N+W+X>200){if(i){i.data[$]=_;i.data[$+1]=_;i.data[$+2]=_;i.data[$+3]=_}else{T[L]=_}}else{if(i){i.data[$]=B;i.data[$+1]=B;i.data[$+2]=B;i.data[$+3]=255}else{T[L]=B}}}if(a=="rgb"){var N=t.data[O]&255;var W=t.data[O+1]&255;var X=t.data[O+2]&255;var Y=t.data[O+3]&255;var V=N<<16|W<<8|X;var q=(Y<<24|V>>>0)>>>0;if(i){i.data[$]=N;i.data[$+1]=W;i.data[$+2]=X;i.data[$+3]=Y}else{T[L]=q}}if(a=="indexed"){var N=t.data[O]&255;var W=t.data[O+1]&255;var X=t.data[O+2]&255;var Y=255;var V=N<<16|W<<8|X;var q=(Y<<24|V>>>0)>>>0;var j=0;if(typeof o["c"+q]!="undefined"){j=o["c"+q].index}if(i){i.data[$]=N;i.data[$+1]=W;i.data[$+2]=X;i.data[$+3]=Y}else{T[L]=j}}}else{}}}}}if(i==null&&g_app.doc!=null){this.updateAllCharacterCurrentData();if(this.isPetscii()){this.setType("petscii")}else{this.setType("custom")}this.refreshFromImageData()}},importImage:function(e){if(this.importCanvas==null){this.importCanvas=document.createElement("canvas")}var t=16*this.charWidth;var i=16*this.charHeight;if(typeof e.naturalHeight!="undefined"){t=e.naturalWidth;i=e.naturalHeight}this.importCanvas.width=t;this.importCanvas.height=i;this.importContext=this.importCanvas.getContext("2d");this.importContext.clearRect(0,0,this.importCanvas.width,this.importCanvas.height);this.importContext.drawImage(e,0,0);var r=this.importContext.getImageData(0,0,this.importCanvas.width,this.importCanvas.height);this.readImageData({srcImageData:r});return},setFromImageData:function(e){if(this.imageData==null||this.imageData.width!=e.width||this.imageData.height!=e.height){this.canvas.width=e.width;this.canvas.height=e.height;this.context=this.canvas.getContext("2d");this.imageData=this.context.getImageData(0,0,e.width,e.height)}this.imageData.data.set(e.data);this.refreshFromImageData()},refreshFromImageData:function(){if(false&&g_app.getEnabled("textmode3d")){for(var e=0;e<256;e++){this.generateTileGeometry(e);this.generateTileBackgroundGeometry(e)}}},generate3dGeometries:function(){for(var e=0;e<this.tileCount;e++){if(e>=this.characterGeometries.length){this.geometryDirty[e]=true;this.characterGeometries.push(new THREE.BufferGeometry)}if(e>=this.characterBackgroundGeometries.length){this.characterBackgroundGeometries.push(new THREE.BufferGeometry)}this.generateTileGeometry(e);this.generateTileBackgroundGeometry(e)}},generateTileGeometry:function(e){if(this.tile3d==null){this.tile3d=new Tile3d;this.tile3d.init(this)}return this.tile3d.generateTileGeometry(e);if(e<this.geometryDirty.length&&this.geometryDirty[e]==false){return}while(e>=this.geometryDirty.length){this.geometryDirty.push(true)}if(e==5){console.error("generate tile geometry:"+e)}var t="current";var i=1/4;var r=new THREE.BufferGeometry;var a=this.charWidth*this.pixelWidth*this.pixelTo3dUnits;var s=this.charHeight*this.pixelHeight*this.pixelTo3dUnits;var o=this.charDepth*this.pixelDepth*this.pixelTo3dUnits;for(var l=0;l<this.charHeight;l++){for(var n=0;n<this.charWidth;n++){var h=this.getPixel(e,n,l,t)>0;if(h){var d=false;var c=false;var f=false;var u=false;if(l>0){c=this.getPixel(e,n,l-1,t)>0}if(l<this.charHeight-1){d=this.getPixel(e,n,l+1,t)>0}if(n>0){f=this.getPixel(e,n-1,l,t)>0}if(n<this.charWidth-1){u=this.getPixel(e,n+1,l,t)>0}var p=new THREE.BoxGeometry(this.pixelTo3dUnits,this.pixelTo3dUnits,o);n=100;l=100;r=p;break}}}this.characterGeometries[e]=r;this.geometryDirty[e]=false},generateTileBackgroundGeometry:function(e){return;var t="current";var i=1/4;var r=new THREE.BufferGeometry;var a=this.charWidth*this.pixelWidth*this.pixelTo3dUnits;var s=this.charHeight*this.pixelHeight*this.pixelTo3dUnits;var o=this.charDepth*this.pixelDepth*this.pixelTo3dUnits;for(var l=0;l<this.charHeight;l++){for(var n=0;n<this.charWidth;n++){var h=this.getPixel(e,n,l,t)>0;if(!h){var d=false;var c=false;var f=false;var u=false;if(l>0){c=this.getPixel(e,n,l-1,t)>0}if(l<this.charHeight-1){d=this.getPixel(e,n,l+1,t)>0}if(n>0){f=this.getPixel(e,n-1,l,t)>0}if(n<this.charWidth-1){u=this.getPixel(e,n+1,l,t)>0}var p=new THREE.BoxGeometry(this.pixelTo3dUnits,this.pixelTo3dUnits,o);r.merge(p)}}}this.characterBackgroundGeometries[e]=THREE.BufferGeometryUtils.mergeVertices(r)},getGeometry:function(e){if(e>=this.characterGeometries.length){this.generate3dGeometries()}if(this.geometryDirty[e]){this.generateTileGeometry(e);this.generateTileBackgroundGeometry(e);this.geometryDirty[e]=false}return this.characterGeometries[e]},getBackgroundGeometry:function(e){return this.characterBackgroundGeometries[e]},getData:function(){return this.currentTileData},setTileData:function(e,t){var i=this.tileData[e].data[0].length;if(i!=t.length){return}for(var r=0;r<i;r++){this.tileData[e].data[0][r]=t[r]}this.modified();this.updateCharacterCurrentData(e)},setPixel:function(e,t,i,r,a,s){if(typeof r=="undefined"){r=true}if(typeof s=="undefined"){s=0}if(typeof a=="undefined"){a=true}if(false&&e==this.editor.tileSetManager.blankCharacter){return}var o=false;var l=this.editor.layers.getSelectedLayerObject();if(l.getType()=="grid"&&l.getScreenMode()==TextModeEditor.Mode.C64ECM){var n=Math.floor(e/256);e=e%64+n*256;o=true}if(this.tileData[e].props.animated!==false){this.tileData[e].data[s][t+i*this.charWidth]=r;this.updateCharacterCurrentData(e);return}var h=this.getPixel(e,t,i);var d=t+i*this.charWidth;this.tileData[e].data[0][d]=r;this.updateCharacterCurrentData(e);var c={c:e,x:t,y:i,oldValue:h,newValue:r};this.editor.history.addAction("setCharPixel",c);if(a){this.updateCharacter(e)}this.modified();this.customCharacterset=true},updateCharacter:function(e){if(e<this.characterGeometries.length){this.generateTileGeometry(e);this.generateTileBackgroundGeometry(e)}this.editor.tools.drawTools.tilePalette.drawTilePalette({redrawTiles:true,tiles:[e]});this.editor.sideTilePalette.drawTilePalette({redrawTiles:true,tiles:[e]})},drawCharacter:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();if(typeof e["colorPaletteId"]!="undefined"){t=this.editor.colorPaletteManager.getColorPalette(e["colorPaletteId"])}var i=false;if(typeof e["screenMode"]!="undefined"){i=e["screenMode"]}else{i=this.editor.getScreenMode()}var r=0;if(typeof e["transparentColorIndex"]!="undefined"){r=e["transparentColorIndex"]}var a=this.charHeight;var s=this.charWidth;if(typeof e["charHeight"]!="undefined"){a=e["charHeight"]}if(typeof e["charWidth"]!="undefined"){s=e["charWidth"]}var o=32;if(typeof e["charsAcross"]!="undefined"){o=e["charsAcross"]}var l=null;var n=e["imageData"];var h=e["character"];var d=-1;var c=-1;if(typeof e["color"]!="undefined"){d=e["color"]}var f=false;if(typeof e["backgroundIsTransparent"]!="undefined"){f=e["backgroundIsTransparent"]}if(typeof e["bgColor"]!="undefined"){c=e["bgColor"]}if(h===false){return}l=this.currentTileData;if(h>=0&&h<this.tileData.length){if(typeof e["characterFrame"]!="undefined"&&e["characterFrame"]<this.tileData[h].data.length){l=this.tileData[h].data[e["characterFrame"]]}else{l=l[h]}}var u=false;var p=false;var v=0;if(typeof e["flipH"]!="undefined"){u=e["flipH"]}if(typeof e["flipV"]!="undefined"){p=e["flipV"]}if(typeof e["rotZ"]!="undefined"){v=e["rotZ"]}var g=false;var m=false;var y=false;var b=false;if(typeof e["colorRGB"]!="undefined"){g=e["colorRGB"];m=g>>16&255;y=g>>8&255;b=g&255}var C=false;var x=false;var S=false;var P=false;if(typeof e["bgColorRGB"]!="undefined"){C=e["bgColorRGB"];if(C!==false){x=C>>16&255;S=C>>8&255;P=C&255}}if(c!=-1){C=t.getHex(c);x=C>>16&255;S=C>>8&255;P=C&255}var w=[];if(i===TextModeEditor.Mode.C64MULTICOLOR){var I=this.editor.currentTile.color;if(typeof e["color"]!="undefined"){I=e["color"]}if(this.editor.graphic.getType()!=="sprite"){if(I<8){i=TextModeEditor.Mode.TEXTMODE}else{I-=8}}var k=e["bgColor"];var M=e["c64Multi1Color"];var T=e["c64Multi2Color"];if(typeof e["backgroundColor"]!="undefined"){k=e["backgroundColor"]}f=k==this.editor.colorPaletteManager.noColor;var w=[];if(this.editor.graphic.getType()=="sprite"){w.push(t.getColor(k));w.push(t.getColor(M));w.push(t.getColor(I));w.push(t.getColor(T))}else{w.push(t.getColor(k));w.push(t.getColor(M));w.push(t.getColor(T));w.push(t.getColor(I))}if(d==-1&&g===false){d=I}}var D=e["x"];var E=e["y"];var $=false;if(typeof e["highlight"]=="undefined"){$=false}else{$=e["highlight"]}var _=false;if(typeof e["select"]=="undefined"){_=false}else{_=e["select"]}var B=2;if(typeof e["scale"]!="undefined"){B=e["scale"]}var R=0;if(typeof e["padding"]!="undefined"){R=e["padding"]}if($){for(var A=-1;A<a*B+R*2+1;A++){for(var F=-1;F<s*B+R*2+1;F++){var L=(D+F+D*R+(E+A+E*R)*n.width)*4;if(L>0&&L+3<n.data.length){n.data[L]=255;n.data[L+1]=0;n.data[L+2]=0;n.data[L+3]=255}}}}if(_){for(var A=-1;A<a*B+R*2+1;A++){for(var F=-1;F<s*B+R*2+1;F++){var L=(D+F+D*R+(E+A+E*R)*n.width)*4;if(L>0&&L+3<n.data.length){n.data[L]=255;n.data[L+1]=0;n.data[L+2]=0;n.data[L+3]=255}}}}if(!l){return}if(h==-1){if(d!=-1){var U=t.getHex(d);m=U>>16&255;y=U>>8&255;b=U&255}if(n!=null){for(var A=0;A<a*B;A++){for(var F=0;F<s*B;F++){var L=(D+F+(D+1)*R+(E+A+(E+1)*R)*n.width)*4;n.data[L]=m;n.data[L+1]=y;n.data[L+2]=b;n.data[L+3]=255}}}}else{var H=h%o;var O=Math.floor(h/o);if(d!=-1){var U=t.getHex(d);m=U>>16&255;y=U>>8&255;b=U&255}if(this.getType()=="vector"){var G=e["context"];var z=e["character"];var N=s*e["scale"];var W=a*e["scale"];var c=false;var X=false;var Y=e["bgColor"];if(typeof Y!="undefined"&&Y!=-1){c="#"+t.getHexString(Y)}if(typeof e["bgColorRGB"]!="undefined"){c="rgb("+x+","+S+","+P+")"}var d=e["color"];if(typeof d!="undefined"){X="#"+t.getHexString(d)}if(typeof e["colorRGB"]!="undefined"){X="rgb("+m+","+y+","+b+")"}if(typeof G!="undefined"){var V=D*e["scale"];var q=E*e["scale"];if(c!==false){G.fillStyle=c;G.fillRect(V,q,N,W)}else{if(f){G.clearRect(V,q,N,W)}else if(C!==false){G.fillStyle="rgb("+x+","+S+","+P+")";G.fillRect(V,q,N,W)}}var j=this.getGlyphPath(z);if(j!==null){var K=N;var Z=this.getFontScale();var B=K*Z;var J=this.getFontAscent();G.setTransform(B,0,0,-B,V,q+J*B);if(u){G.translate(1/(2*Z),-1/(2*Z)+J);G.scale(-1,1);G.translate(-1/(2*Z),1/(2*Z)-J)}if(p){G.translate(1/(2*Z),-1/(2*Z)+J);G.scale(1,-1);G.translate(-1/(2*Z),1/(2*Z)-J)}if(v!=0){G.translate(1/(2*Z),-1/(2*Z)+J);G.rotate(v*90*Math.PI/180);G.translate(-1/(2*Z),1/(2*Z)-J)}G.fillStyle=X;G.fill(j);G.setTransform(1,0,0,1,0,0)}}}else{if(!n){return}for(var A=0;A<a*B;A++){for(var F=0;F<s*B;F++){var d=0;var Q=Math.floor(F/B);var ee=Math.floor(A/B);if(u){Q=s-Q-1}if(p){ee=a-ee-1}if(v!=0&&s===a){var te=Q;var ie=ee;if(v===1){ee=s-te-1;Q=ie}if(v===2){Q=s-te-1;ee=a-ie-1}if(v===3){ee=te;Q=a-ie-1}}var re=Q+ee*s;d=l[re];var V=F;var q=A;var L=(D+V+(D+1)*R+(E+q+(E+1)*R)*n.width)*4;if(!$){if(i===TextModeEditor.Mode.RGB){m=d>>>16&255;y=d>>>8&255;b=d&255;var ae=d>>>24&255;n.data[L]=m;n.data[L+1]=y;n.data[L+2]=b;n.data[L+3]=ae}else if(i===TextModeEditor.Mode.INDEXED){if(d===r){n.data[L]=0;n.data[L+1]=0;n.data[L+2]=0;n.data[L+3]=0}else{var U=t.getHex(d);m=U>>16&255;y=U>>8&255;b=U&255;n.data[L]=m;n.data[L+1]=y;n.data[L+2]=b;n.data[L+3]=255}}else if(i==TextModeEditor.Mode.NES){if(d>=4){d=1}d=this.editor.colorPaletteManager.colorSubPalettes.getColor(d);var U=t.getHex(d);n.data[L]=U>>16&255;n.data[L+1]=U>>8&255;n.data[L+2]=U&255;n.data[L+3]=255}else if(i==TextModeEditor.Mode.TEXTMODE||i==TextModeEditor.Mode.C64ECM||i==TextModeEditor.Mode.C64STANDARD){if(d>0){n.data[L]=m;n.data[L+1]=y;n.data[L+2]=b;n.data[L+3]=255}else if(C!==false){n.data[L]=x;n.data[L+1]=S;n.data[L+2]=P;n.data[L+3]=255}}else if(i==TextModeEditor.Mode.C64MULTICOLOR){var se=0;if(d>0){se+=2}d=l[re+1];if(d>0){se+=1}var U=w[se];for(var oe=0;oe<B;oe++){if(se===0&&f){n.data[L+3]=0;F++;n.data[L+7]=0;F++}else{n.data[L]=U.r*255;n.data[L+1]=U.g*255;n.data[L+2]=U.b*255;n.data[L+3]=255;F++;n.data[L+4]=U.r*255;n.data[L+5]=U.g*255;n.data[L+6]=U.b*255;n.data[L+7]=255;F++}L+=8}F--}}else{if(d>0){n.data[L]=40;n.data[L+1]=40;n.data[L+2]=40;n.data[L+3]=40}else{}}}}}}},getPixel:function(e,t,i,r){if(typeof r=="undefined"){r=0}if(e===false||e<0||e>=this.tileData.length){return false}var a=this.editor.layers.getSelectedLayerObject();if(a&&a.getType()=="grid"&&a.getScreenMode()==TextModeEditor.Mode.C64ECM){var s=Math.floor(e/256);e=e%64+s*256}var o=t+i*this.charWidth;if(r=="current"){return this.currentTileData[e][o]}var l=0;if(this.tileData[e].props.animated=="frames"&&r<this.tileData[e].data.length){return this.tileData[e].data[r][o]}return this.tileData[e].data[0][o]},setAnimatedTicksPerFrame:function(e,t){this.tileData[e].props.ticksPerFrame=t;this.modified()},setAnimatedType:function(e,t){if(t=="none"){this.setCharacterFrame(e,0)}this.tileData[e].props.animated=t;if(t=="frames"){this.tileData[e].props.frameCount=1}else{this.tileData[e].props.frameCount=this.charWidth}this.modified()},hasAnimatedTiles:function(){for(var e=0;e<this.tileData.length;e++){if(typeof this.tileData[e].props!=="undefined"){if(typeof this.tileData[e].props.animated!="undefined"&&this.tileData[e].props.animated!=false){return true}}}return false},insertFrame:function(e,t){var i=this.newPixelData();for(var r=0;r<this.tileData[e].data[t].length;r++){i[r]=this.tileData[e].data[t][r]}this.tileData[e].data.splice(t+1,0,i);this.tileData[e].props.frameCount=this.tileData[e].data.length;this.modified()},deleteFrame:function(e,t){if(this.tileData[e].data.length<=1){return}this.tileData[e].data.splice(t,1);this.tileData[e].props.frameCount=this.tileData[e].data.length;this.modified()},getAnimatedType:function(e){return this.tileData[e].props.animated},getTileProperties:function(e){if(e!==false&&e>=0&&e<this.tileData.length){return this.tileData[e].props}return false},getCharacterFrame:function(e){return this.tileData[e].props.frame},setAnimated:function(e,t){this.customCharacterset=true;this.tileData[e].props.animated=t;this.tileData[e].props.lastTick=0;this.tileData[e].props.frame=0;if(t===false){this.setCharacterFrame(e,0)}this.modified()},invertPixels:function(e,t){for(var i=0;i<this.charHeight;i++){for(var r=0;r<this.charWidth;r++){var a=r+i*this.charWidth;var s=this.getPixel(e,r,i);if(t){if(s!==0){this.currentTileData[e][a]=0}else{this.currentTileData[e][a]=1}}else{this.currentTileData[e][a]=s}}}this.updateCharacter(e);this.modified()},rotatePixels:function(e,t,i){var r=[];for(var a=0;a<this.charHeight;a++){r[a]=[];for(var s=0;s<this.charWidth;s++){r[a][s]=this.getPixel(e,s,a)}}for(var a=0;a<this.charHeight;a++){for(var s=0;s<this.charWidth;s++){var o=(s+t+this.charWidth)%this.charWidth;var l=(a+i+this.charHeight)%this.charHeight;this.currentTileData[e][s+a*this.charWidth]=r[l][o]}}this.updateCharacter(e);this.modified()},setCharacterFrame:function(e,t){if(t>=this.tileData[e].data.length){return}for(var i=0;i<this.tileData[e].data[t].length;i++){this.currentTileData[e][i]=this.tileData[e].data[t][i]}this.updateCharacter(e)},getAnimatedCharacterTicks:function(){var e=[];for(var t=0;t<this.tileData.length;t++){if(this.tileData[t].props.animated!==false){var i=this.getFrameCount(t,this.tileData[t].props.animated);e.push(i*this.tileData[t].props.ticksPerFrame)}}return e},getFrameCount:function(e,t){var i=0;switch(t){case"right":case"left":i=this.charWidth;break;case"up":case"down":i=this.charHeight;break;case"blink":i=2;break;case"frames":i=this.tileData[e].props.frameCount;break}return i},update:function(e){var t=[];var i=this.tileData.length;for(var r=0;r<i;r++){if(this.tileData[r].props.animated!==false){var a=this.getFrameCount(r,this.tileData[r].props.animated);var s=Math.floor(e/this.tileData[r].props.ticksPerFrame)%a;if(this.tileData[r].props.frame!=s){this.tileData[r].props.frame=s;this.tileData[r].props.lastTick=e;switch(this.tileData[r].props.animated){case"right":this.rotatePixels(r,-s,0);break;case"up":this.rotatePixels(r,0,s);break;case"down":this.rotatePixels(r,0,-s);break;case"blink":this.invertPixels(r,s);break;default:case"left":this.rotatePixels(r,s,0);break;case"frames":this.setCharacterFrame(r,s);break}t.push(r);if(g_app.getMode()=="3d"){}}}}if(t.length>0){if(this.editor.type=="2d"){this.editor.currentTile.canvasDrawCharacters();this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({animatedTilesOnly:true})}return true}return false}};var Tile3d=function(){this.tileSet=null;this.geometry=null;this.numberOfVertices=0;this.groupStart=0;this.indices=[];this.vertices=[];this.normals=[];this.uvs=[]};Tile3d.prototype={init:function(e){this.tileSet=e},generateTileGeometry:function(e){var t=this.tileSet;if(e<t.geometryDirty.length&&t.geometryDirty[e]==false){return}while(e>=t.geometryDirty.length){t.geometryDirty.push(true)}var i="current";var r=new THREE.BufferGeometry;var a=t.charDepth*t.pixelDepth*t.pixelTo3dUnits;var s=t.getTileHeight();var o=t.getTileWidth();var l=s*t.pixelTo3dUnits;var n=o*t.pixelTo3dUnits;this.indices=[];this.vertices=[];this.normals=[];this.uvs=[];this.numberOfVertices=0;this.groupStart=0;for(var h=0;h<s;h++){for(var d=0;d<o;d++){var c=t.getPixel(e,d,h,i)>0;if(c){var f=false;var u=false;var p=false;var v=true;if(h>0){f=t.getPixel(e,d,h-1,i)>0}if(h<t.charHeight-1){u=t.getPixel(e,d,h+1,i)>0}if(d>0){p=t.getPixel(e,d-1,h,i)>0}if(d<o-1){v=t.getPixel(e,d+1,h,i)>0}var g=t.pixelTo3dUnits;var m=a;var y=t.pixelTo3dUnits;var b=1;var C=1;var x=1;var S=d*g-n/2;var P=(s-h-1)*y-l/2;var w=0;if(!v){this.buildPlane("z","y","x",-1,-1,m,y,g,C,x,0,S,P,w)}if(!p){this.buildPlane("z","y","x",1,-1,m,y,-g,C,x,1,S,P,w)}if(!f){this.buildPlane("x","z","y",1,1,g,m,y,b,C,2,S,P,w)}if(!u){this.buildPlane("x","z","y",1,-1,g,m,-y,b,C,3,S,P,w)}this.buildPlane("x","y","z",1,-1,g,y,m,b,x,4,S,P,w);this.buildPlane("x","y","z",-1,-1,g,y,-m,b,x,5,S,P,w)}}}r.setIndex(this.indices);r.setAttribute("position",new THREE.Float32BufferAttribute(this.vertices,3));r.setAttribute("normal",new THREE.Float32BufferAttribute(this.normals,3));r.setAttribute("uv",new THREE.Float32BufferAttribute(this.uvs,2));t.characterGeometries[e]=THREE.BufferGeometryUtils.mergeVertices(r);t.geometryDirty[e]=false},buildPlane:function(e,t,i,r,a,s,o,l,n,h,d,c,f,u){var p=s/n;var v=o/h;var g=s/2;var m=o/2;var y=l/2;var b=n+1;var C=h+1;var x=0;var S=0;var P=new THREE.Vector3;for(var w=0;w<C;w++){var I=w*v-m;for(var k=0;k<b;k++){var M=k*p-g;P[e]=M*r;P[t]=I*a;P[i]=y;P.set(P.x+c,P.y+f,P.z+u);this.vertices.push(P.x,P.y,P.z);P[e]=0;P[t]=0;P[i]=l>0?1:-1;this.normals.push(P.x,P.y,P.z);this.uvs.push(k/n);this.uvs.push(1-w/h);x+=1}}for(var w=0;w<h;w++){for(var k=0;k<n;k++){var T=this.numberOfVertices+k+b*w;var D=this.numberOfVertices+k+b*(w+1);var E=this.numberOfVertices+(k+1)+b*(w+1);var $=this.numberOfVertices+(k+1)+b*w;this.indices.push(T,D,$);this.indices.push(D,E,$);S+=6}}this.groupStart+=S;this.numberOfVertices+=x}};var TileSetEditor=function(){this.doc=null;this.uiComponent=null;this.tilePaletteDisplay=null};TileSetEditor.prototype={init:function(){},buildInterface:function(e){if(this.uiComponent!=null){return}this.uiComponent=UI.create("UI.Panel",{id:"tileSetEditor"});e.add(this.uiComponent);var t='<canvas id="tileSetEditorCanvas"></canvas>';var i=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.add(i);var r=this;UI.on("ready",function(){r.initContent()})},initContent:function(){if(this.tilePaletteDisplay==null){this.tilePaletteDisplay=new TilePaletteDisplay;this.tilePaletteDisplay.init(g_app.textModeEditor,{mode:"multiple",canvasElementId:"tileSetEditorCanvas"})}},redraw:function(){console.log("path = "+this.path);this.load(this.path)},load:function(e){var t=g_app.textModeEditor.tileSetManager;this.path=e;var i=g_app.doc.getDocRecord(e);if(i!=null){this.doc=i;t.setCurrentTileSetFromId(this.doc.id);this.tilePaletteDisplay.initCharPalette({});this.tilePaletteDisplay.draw({redrawTiles:true})}}};var TileSetChoosePreset=function(){this.editor=null;this.uiComponent=null;this.callback=false;this.type=false;this.tileSet=null;this.tileSetImport=null;this.previewCharsetId=false;this.previewCharsetDescription="";this.createTileSetOnLoad=false;this.tileSets=[];this.visible=false};TileSetChoosePreset.prototype={init:function(e){this.editor=e},show:function(e){var r=this;this.createTileSetOnLoad=false;if(typeof e!="undefined"){if(typeof e.callback!="undefined"){this.callback=e.callback}if(typeof e.createOnLoad!="undefined"){this.createTileSetOnLoad=e.createOnLoad}}if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"chooseCharacterSetPresetDialog",title:"Choose A Tile Set",width:800,height:800});this.splitPanel=UI.create("UI.SplitPanel");this.tabPanel=UI.create("UI.TabPanel",{canCloseTabs:false});this.tabPanel.addTab({key:"character",title:"Character Sets",isTemp:false},true);this.tabPanel.addTab({key:"custom",title:"Custom Text Mode Sets",isTemp:false},true);this.tabPanel.addTab({key:"vector",title:"Vector Tiles",isTemp:false},false);this.tabPanel.addTab({key:"load",title:"Load/Import Tile Set",isTemp:false},false);this.tabPanel.on("tabfocus",function(e,t){r.activeTab=e;var i=r.tabPanel.getTabIndex(e);if(i>=0){if(e=="load"){r.tileSetChoosePanel.showOnly("tileSetImportPanel");r.startLoadTileset({})}else{r.tileSetChoosePanel.showOnly("tileSetChoosePresetPanel");r.setTilePresetType(e)}}});this.splitPanel.addNorth(this.tabPanel,40,false);this.tileSetChoosePanel=UI.create("UI.Panel",{id:"tileSetChoosePanel"});this.splitPanel.add(this.tileSetChoosePanel);this.uiComponent.add(this.splitPanel);this.tileSetImportPanel=UI.create("UI.Panel",{id:"tileSetImportPanel"});this.tileSetChoosePanel.add(this.tileSetImportPanel);this.htmlComponent=UI.create("UI.HTMLPanel",{id:"tileSetChoosePresetPanel"});this.tileSetChoosePanel.add(this.htmlComponent);this.tileSetChoosePanel.showOnly("tileSetChoosePresetPanel");this.htmlComponent.load("html/textMode/tileSetChoosePreset.html",function(){r.initContent(e);r.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){if(r.activeTab=="load"){r.tileSetImport.importTileSet({callback:r.callback,createTileSet:r.createTileSetOnLoad})}else{if(r.callback!==false){r.callback({tileSetCreated:false,tileSet:null,type:r.type,presetId:r.previewCharsetId,description:r.previewCharsetDescription})}}UI.closeDialog()});this.linkButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-351-link.svg"> Create A Template Link',color:"other"});this.uiComponent.addButton(this.linkButton);this.linkButton.on("click",function(e){r.createTemplateLink()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("keydown",function(e){r.keydown(e)});this.uiComponent.on("keyup",function(e){r.keyup(e)});this.uiComponent.on("close",function(e){r.visible=false});UI.showDialog("chooseCharacterSetPresetDialog")}else{UI.showDialog("chooseCharacterSetPresetDialog");this.initContent(e)}this.visible=true},startLoadTileset:function(e){if(this.tileSetImport==null){this.tileSetImport=new TileSetImport;this.tileSetImport.init(this.editor,this.tileSetImportPanel)}this.tileSetImport.start(e)},createTemplateLink:function(){UI.closeDialog();g_app.createTemplateLink.show({charsetId:this.previewCharsetId})},initEvents:function(){var t=this;$("#chooseCharacterSetList").on("click",".characterSetListEntry",function(){var e=$(this).attr("value");$(".characterSetListEntry").removeClass("characterSetListEntrySelected");$(this).addClass("characterSetListEntrySelected");t.chooseDialogSelect(e)})},setTilePresetType:function(e){if(this.type==e){return}this.type=e;switch(e){case"character":this.showCharacterSetPresets();break;case"custom":this.showCustomTextModePresets();break;case"vector":this.showVectorPresets();break}},keydown:function(e){var t=e.key;if(typeof t!="undefined"){t=t.toLowerCase();if(t=="arrowup"||t=="arrowleft"){this.prev()}if(t=="arrowdown"||t=="arrowright"){this.next()}}else{switch(e.keyCode){case 38:case 37:this.prev();break;case 40:case 39:this.next();break}}},keyup:function(e){},prev:function(){var e=false;for(var t=0;t<this.tileSets.length;t++){if(this.tileSets[t]==this.previewCharset.id){if(t>0){e=t-1;break}}}if(e!==false){var i=this.tileSets[e];this.chooseDialogSelect(i);$(".characterSetListEntry").removeClass("characterSetListEntrySelected");$(".characterSetListEntry[value="+i+"]").addClass("characterSetListEntrySelected")}},next:function(){var e=false;for(var t=0;t<this.tileSets.length;t++){if(this.tileSets[t]==this.previewCharset.id){if(t<this.tileSets.length-1){e=t+1;break}}}if(e!==false){var i=this.tileSets[e];this.chooseDialogSelect(i);$(".characterSetListEntry").removeClass("characterSetListEntrySelected");$(".characterSetListEntry[value="+i+"]").addClass("characterSetListEntrySelected")}},showVectorPresets:function(){this.tileSets=[];var e="";for(var t in VectorPresets){if(VectorPresets.hasOwnProperty(t)){var i=VectorPresets[t].category;e+='<div class="characterSetListCategory">'+i+"</div>";for(var r=0;r<VectorPresets[t].characterSets.length;r++){var a=VectorPresets[t].characterSets[r].name;var s=VectorPresets[t].characterSets[r].id;this.tileSets.push(s);e+='<div class="characterSetListEntry ';if(s=="modular-shapes"){e+=" characterSetListEntrySelected "}e+='" value="'+s+'">'+a+"</div>"}}}$("#chooseCharacterSetList").html(e);this.chooseDialogSelect("modular-shapes")},showCustomTextModePresets:function(){var e="";for(var t in CharacterSetPresets){if(CharacterSetPresets.hasOwnProperty(t)){var i=CharacterSetPresets[t].category;var r=0;for(var a=0;a<CharacterSetPresets[t].characterSets.length;a++){var s=CharacterSetPresets[t].characterSets[a].type;if(typeof s!="undefined"&&s=="custom"){r++}}if(r>0){e+='<div class="characterSetListCategory">'+i+"</div>";for(var a=0;a<CharacterSetPresets[t].characterSets.length;a++){var o=CharacterSetPresets[t].characterSets[a].name;var l=CharacterSetPresets[t].characterSets[a].id;var s=CharacterSetPresets[t].characterSets[a].type;if(typeof s!="undefined"&&s=="custom"){e+='<div class="characterSetListEntry ';this.tileSets.push(l);if(l=="8px"){e+=" characterSetListEntrySelected "}e+='" value="'+l+'">'+o+"</div>"}}}}}$("#chooseCharacterSetList").html(e);this.chooseDialogSelect("8px")},showCharacterSetPresets:function(){var e="";for(var t in CharacterSetPresets){if(CharacterSetPresets.hasOwnProperty(t)){var i=CharacterSetPresets[t].category;e+='<div class="characterSetListCategory">'+i+"</div>";for(var r=0;r<CharacterSetPresets[t].characterSets.length;r++){var a=CharacterSetPresets[t].characterSets[r].name;var s=CharacterSetPresets[t].characterSets[r].id;var o=CharacterSetPresets[t].characterSets[r].type;if(typeof o=="undefined"||o!="custom"){e+='<div class="characterSetListEntry ';this.tileSets.push(s);if(s=="petscii"){e+=" characterSetListEntrySelected "}e+='" value="'+s+'">'+a+"</div>"}}}}$("#chooseCharacterSetList").html(e);this.chooseDialogSelect("petscii")},initContent:function(e){var t=this;if(typeof e.showImport!="undefined"&&e.showImport){this.tabPanel.showTab("load");this.tileSetChoosePanel.showOnly("tileSetImportPanel");this.activeTab="load";this.startLoadTileset(e)}else{var i="character";if(typeof e.type!="undefined"){i=e.type}this.tabPanel.showTab(i);this.setTilePresetType(i)}},chooseDialogSelect:function(e){if(typeof e=="undefined"){return}var e=this.getCharacterSetDescription(e);if(!e){return}this.previewCharset=e;var t=this.previewCharset.name;if(typeof this.previewCharset.author!="undefined"){t+=" by "+this.previewCharset.author}var i="";if(typeof this.previewCharset.author!="undefined"){i+=" by "+this.previewCharset.author}if(typeof this.previewCharset.authorlink!="undefined"){i+=this.previewCharset.authorlink}if(i!=""){i="<div>"+i+"</div>"}if(typeof this.previewCharset.licence!="undefined"){i+="<div>Licence: "+this.previewCharset.licence+"</div>"}if(typeof this.previewCharset.notes!="undefined"){i+="</div>"+this.previewCharset.notes+"</div>"}if(i!=""){$("#chooseCharacterSetInfo").html('<div style="margin-top: 4px">'+i+"</div>")}else{$("#chooseCharacterSetInfo").html("")}$("#chooseCharacterSetHeading").html(t);var r="";if(typeof this.previewCharset.description!="undefined"){r=this.previewCharset.description}$("#chooseCharacterSetDescription").html(r);var a="";var s=e.id;if(typeof this.previewCharset.options!="undefined"){for(var o=0;o<this.previewCharset.options.length;o++){a+='<label class="rb-container" style="margin-right: 8px;"> ';a+='<input type="radio" name="charsetOption" value="'+this.previewCharset.options[o].id+'" ';if(o==0){s=this.previewCharset.options[o].id;a+=' checked="checked" '}a+="/> ";a+=this.previewCharset.options[o].name;if(typeof this.previewCharset.options[o].author!="undefined"){a+=" by "+this.previewCharset.options[o].author}if(typeof this.previewCharset.options[o].authorlink!="undefined"){a+=this.previewCharset.options[o].authorlink}a+='<span class="checkmark"></span>';a+="</label>"}}if(a!=""){$("#chooseCharacterSetOptions").html(a);$("#chooseCharacterSetOptions").show()}else{$("#chooseCharacterSetOptions").hide()}var l=this;$("input[type=radio][name=charsetOption]").on("change",function(){var e=$("input[name=charsetOption]:checked").val();l.setPreviewCharacterset(e)});this.setPreviewCharacterset(s)},setPreviewFromImg:function(e){var t=e.img;var i=e.interpret;if(!this.tileSet){this.tileSet=new TileSet}var r=this.previewCharset;if(this.previewCanvas==null){this.previewCanvas=document.getElementById("chooseCharacterSetPreview")}if(!i){this.previewCanvas.width=t.naturalWidth;this.previewCanvas.height=t.naturalHeight;var a=this.previewCanvas.getContext("2d");a.drawImage(t,0,0)}else{var s=2;var o=2;if(r.height>10){o=1}var l=16;var n=16;if(this.charCanvas==null){this.charCanvas=document.createElement("canvas")}this.charCanvas.width=this.img.naturalWidth;this.charCanvas.height=this.img.naturalHeight;var h=this.charCanvas.getContext("2d");h.drawImage(this.img,0,0);var d=h.getImageData(0,0,this.charCanvas.width,this.charCanvas.height);var e={};e.srcImageData=d;e.characterWidth=r.width;e.characterHeight=r.height;e.dstCharacterSpacing=2;e.scale=o;l=this.charCanvas.width/e.characterWidth;n=this.charCanvas.height/e.characterHeight;this.previewCanvas.width=o*r.width*16+s*17;this.previewCanvas.height=o*r.height*n+s*(n+1);var a=this.previewCanvas.getContext("2d");var c=a.getImageData(0,0,this.previewCanvas.width,this.previewCanvas.height);e.dstImageData=c;this.tileSet.readImageData(e);a.putImageData(c,0,0)}},dropFile:function(e){var t=this;this.tileSetChoosePanel.showOnly("tileSetImportPanel");this.activeTab="load";this.startLoadTileset({dialogReadyCallback:function(){t.tileSetImport.chooseTileSetFile(e)}})},setPreviewCharacterset:function(e){this.previewCharsetId=e;this.previewCharsetDescription=this.getCharacterSetDescription(e);var t=this;var i=e+".png?1";var r="charsets/"+i;if(this.type=="vector"){r="vectorsets/"+i}if(!this.img){this.img=new Image;this.img.onload=function(){var e={};e["img"]=t.img;e["interpret"]=t.type!="vector";t.setPreviewFromImg(e)}}this.img.src=r},getCharacterSetDescription:function(e){var t=CharacterSetPresets;if(this.type=="vector"){t=VectorPresets}for(var i in t){if(t.hasOwnProperty(i)){for(var r=0;r<t[i].characterSets.length;r++){var a=t[i].characterSets[r].id;if(a==e){charWidth=t[i].characterSets[r].width;charHeight=t[i].characterSets[r].height;if(typeof t[i].characterSets[r].type=="undefined"){t[i].characterSets[r].type="ascii"}return t[i].characterSets[r]}}}}return null}};CharacterSetChoosePresetMobileCard=function(){this.holder=null;this.cardHeading=null;this.cardOptions=null;this.canvas=null;this.charset=null;this.charsetImage=null;this.charsetId=false;this.charsetOptionId=false;this.moveHorizonal=false;this.moveVertical=false;this.touchStartX=0;this.touchStartY=0;this.touchStartScrollY=0;this.type="character";this.editor=null};CharacterSetChoosePresetMobileCard.prototype={init:function(e,t){this.editor=e;this.postfix=t},initContent:function(){this.holder=$("#chooseCharacterSetMobileHolder"+this.postfix);this.cardHeading=$("#chooseCharacterSetMobileHeading"+this.postfix);this.cardOptions=$("#chooseCharacterSetMobileOptions"+this.postfix);this.canvas=document.getElementById("chooseCharacterSetMobileCanvas"+this.postfix);this.cardWidth=$(window).width();this.holder.width(this.cardWidth)},setPosition:function(e,t){this.holder.css("left",e+"px");this.holder.css("top",t+"px")},getCharset:function(e){for(var t in CharacterSetPresets){if(CharacterSetPresets.hasOwnProperty(t)){for(var i=0;i<CharacterSetPresets[t].characterSets.length;i++){var r=CharacterSetPresets[t].characterSets[i].id;if(r==e){charWidth=CharacterSetPresets[t].characterSets[i].width;charHeight=CharacterSetPresets[t].characterSets[i].height;if(typeof CharacterSetPresets[t].characterSets[i].type=="undefined"){CharacterSetPresets[t].characterSets[i].type="ascii"}return CharacterSetPresets[t].characterSets[i]}}}}return null},setCharset:function(e){if(this.charsetId===e){return}this.charsetId=e;this.charset=this.getCharset(e);var t=this.charset.name;if(typeof this.charset.author!="undefined"){t+=" by "+this.charset.author}this.cardHeading.html(t);var i="";var r=this.charset.id;var a=this.charset.options;var s="charsetMobileOption_"+r;if(typeof a!="undefined"){for(var o=0;o<a.length;o++){i+='<label class="choose-container-tick" ';if(o==0){i+=' style="background-color: #666666" '}i+=">";i+=a[o].name;if(typeof a[o].author!="undefined"){i+=" by "+a[o].author}i+='<input type="radio" name="'+s+'" value="'+a[o].id+'" ';if(o==0){this.charsetId=a[o].id;i+=' checked="checked" '}i+=">";i+='<span class="checkmark"></span>';i+="</label>"}}this.cardOptions.html(i);this.charsetOptionId=this.charsetId;var l=this;$("input[type=radio][name="+s+"]").on("change",function(){var e=$(this).attr("name");var t=$(this).parent();$(".choose-container-tick").css("background-color","#333333");t.css("background-color","#666666");l.charsetOptionId=$("input[name="+e+"]:checked").val();l.loadSelectedCharset()});l.loadSelectedCharset()},loadSelectedCharset:function(){var e=this.charsetOptionId+".png";var t="charsets/"+e;if(this.charsetImage==null){this.charsetImage=new Image}var i=this;this.charsetImage.onload=function(){i.displaySelectedCharset()};this.charsetImage.src=t},displaySelectedCharset:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.charset;var i=2;var r=2;if(t.height>10){r=1}this.canvas.width=r*t.width*16+i*17;this.canvas.height=r*t.height*16+i*17;var a=this.canvas.getContext("2d");var s=a.getImageData(0,0,this.canvas.width,this.canvas.height);if(this.charCanvas==null){this.charCanvas=document.createElement("canvas")}this.charCanvas.width=this.charsetImage.naturalWidth;this.charCanvas.height=this.charsetImage.naturalHeight;var o=this.charCanvas.getContext("2d");o.drawImage(this.charsetImage,0,0);var l=o.getImageData(0,0,this.charCanvas.width,this.charCanvas.height);var n={};n.srcImageData=l;n.dstImageData=s;n.characterWidth=t.width;n.characterHeight=t.height;n.dstCharacterSpacing=2;n.scale=r;e.readImageData(n);a.putImageData(s,0,0)}};var CharacterSetChoosePresetMobile=function(){this.editor=null;this.uiComponent=null;this.cardWidth=false;this.cardPosition=0;this.charsetCardA=null;this.charsetCardB=null;this.moving=false;this.touchVelocity=null;this.cardMoving=false;this.nextPreloadImage=null;this.prevPreloadImage=null;this.preloadImages=[];this.preloadImageIndex=0};CharacterSetChoosePresetMobile.prototype={init:function(e){this.editor=e;this.touchVelocity=new TouchVelocity},show:function(e){var t=this;var i=500;var r=100;var a=UI.getScreenWidth();var s=UI.getScreenHeight();i=a-30;r=s-30;if(typeof e!="undefined"){if(typeof e.callback!="undefined"){this.callback=e.callback}}if(this.uiComponent==null){this.uiComponent=UI.create("UI.MobilePanel",{id:"chooseCharacterSetPresetMobileDialog",title:"Character Set",width:i,height:r});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/characterSetChoosePresetMobile.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"Choose"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){if(t.callback!==false){t.callback({type:t.type,presetId:t.charsetCardA.charsetOptionId})}UI.closeDialog()})}UI.showDialog("chooseCharacterSetPresetMobileDialog")},initContent:function(){var e="";var t=this;var i="";for(var r in CharacterSetPresets){if(CharacterSetPresets.hasOwnProperty(r)){var a=CharacterSetPresets[r].category;e+='<optgroup label="'+a+'">';for(var s=0;s<CharacterSetPresets[r].characterSets.length;s++){var o=CharacterSetPresets[r].characterSets[s].name;var l=CharacterSetPresets[r].characterSets[s].id;e+='<option value="'+l+'"';if(l=="petscii"){i=l;e+=' selected="selected" '}e+=">";e+=o;e+="</option>"}e+="</optgroup>"}}$("#characterSetChoosePresetMobileList").html(e);this.charsetCardA=new CharacterSetChoosePresetMobileCard;this.charsetCardA.init(this.editor,"A");this.charsetCardA.initContent();this.charsetCardA.setPosition(0,0);this.charsetCardB=new CharacterSetChoosePresetMobileCard;this.charsetCardB.init(this.editor,"B");this.charsetCardB.initContent();this.charsetCardB.setPosition(1e4,0);this.cardWidth=$(window).width();this.selectCharsetPreset(i)},initEvents:function(){var r=this;$("#characterSetChoosePresetMobileList").on("change",function(e){r.selectCharsetPreset($(this).val())});$("#chooseCharacterSetMobilePrev").on("click",function(e){r.prevPreset()});$("#chooseCharacterSetMobileNext").on("click",function(e){r.nextPreset()});var e=document.getElementById("chooseCharacterSetMobileHolderA");e.addEventListener("touchstart",function(e){r.touchStart(e)},false);e.addEventListener("touchmove",function(e){r.touchMove(e)},false);e.addEventListener("touchend",function(e){r.touchEnd(e)},false);var e=document.getElementById("chooseCharacterSetMobileHolderB");e.addEventListener("touchstart",function(e){r.touchStart(e)},false);e.addEventListener("touchmove",function(e){r.touchMove(e)},false);e.addEventListener("touchend",function(e){r.touchEnd(e)},false);$("#chooseCharacterSetMobileOptionsA").on("scroll",function(e){var t=$(this).scrollTop();var i=r.startScrollYA-t;if(i<0){i=-i}if(i>5){r.moveVertical=true}});$("#chooseCharacterSetMobileOptionsB").on("scroll",function(e){var t=$(this).scrollTop();var i=r.startScrollYB-t;if(i<0){i=-i}if(i>5){r.moveVertical=true}})},hideNext:function(e){var o=this;var t=2e3;var i=0;var r=this.cardWidth/3.6;if(r>90){r=90}if(this.cardPosition>r){i=this.cardWidth}else if(this.cardPosition<-r){i=-this.cardWidth}else{i=0}if(typeof e!=="undefined"){if(e.gotoNext){i=-this.cardWidth}if(e.gotoPrev){i=this.cardWidth}}var a=this.touchVelocity.getVelocity();if(a&&a.vx){if(i==0){if(a.vx<-1.2){i=-this.cardWidth}if(a.vx>1.2){i=this.cardWidth}}if(i!==0){var s=i-this.cardPosition;if(s!=0){t=s/a.vx}}}if(t>250||t<0){t=250}this.cardMoving=true;this.charsetCardA.holder.animate({left:i+"px"},{duration:t,progress:function(e,t,i){var r=o.charsetCardA.holder.position();o.cardPosition=r.left;var a=r.left;if(a<0){var s=a+o.cardWidth;o.charsetCardB.holder.css("left",s+"px")}else{var s=a-o.cardWidth;o.charsetCardB.holder.css("left",s+"px")}},complete:function(){o.cardMoving=false;if(i!==0){var e=o.charsetCardB.charsetId;var t=o.charsetCardB;o.charsetCardB=o.charsetCardA;o.charsetCardA=t;o.cardPosition=0;o.selectCharsetPreset(e)}}})},preloadImage:function(e){if(this.preloadImageIndex>=this.preloadImages.length){this.preloadImages.push(new Image)}this.preloadImages[this.preloadImageIndex].src=e;this.preloadImageIndex=0},preloadNextPrev:function(e){this.preloadImageIndex=0;if(e!==false){var t=this.charsetCardA.getCharset(e);if(typeof t!="undefined"){var i=t.id;var r=t.options;var a=false;if(typeof r!="undefined"&&r.length>0){a=0;i=r[a].id;for(var s=1;s<r.length;s++){this.preloadImage("charsets/"+r[s].id+".png")}}}}var o=this.getNextPresetId();if(o!==false){var t=this.charsetCardA.getCharset(o);if(typeof t!="undefined"){var i=t.id;var r=t.options;var a=false;if(typeof r!="undefined"&&r.length>0){a=0;i=r[a].id;for(var s=0;s<r.length;s++){this.preloadImage("charsets/"+r[s].id+".png")}}else{this.preloadImage("charsets/"+i+".png")}}}var l=this.getPrevPresetId();if(l!==false){var t=this.charsetCardA.getCharset(l);if(typeof t!="undefined"){var i=t.id;var r=t.options;if(typeof r!="undefined"&&r.length>0){a=0;i=r[a].id;for(var s=0;s<r.length;s++){this.preloadImage("charsets/"+r[s].id+".png")}}else{this.preloadImage("charsets/"+i+".png")}}}},setCardPosition:function(e){this.cardPosition=e;var t=this.charsetCardA.cardWidth;var i=e;var r=0;this.charsetCardA.setPosition(i,r);if(e<0){var a=e+t;this.charsetCardB.setPosition(a,0);this.setCardBContent()}else{var a=e-t;this.charsetCardB.setPosition(a,0);this.setCardBContent()}},getPrevPresetId:function(){var e=false;var t=false;for(var i in CharacterSetPresets){if(CharacterSetPresets.hasOwnProperty(i)){for(var r=0;r<CharacterSetPresets[i].characterSets.length;r++){var a=CharacterSetPresets[i].characterSets[r].id;if(this.presetId==a){if(e===false){return false}t=true;return e}e=a}}}return false},getNextPresetId:function(){var e=false;for(var t in CharacterSetPresets){if(CharacterSetPresets.hasOwnProperty(t)){for(var i=0;i<CharacterSetPresets[t].characterSets.length;i++){var r=CharacterSetPresets[t].characterSets[i].id;if(e){return r}if(this.presetId==r){e=true}}}}return false},setCardBContent:function(){if(this.cardPosition<0){var e=this.getNextPresetId();if(e!==false){this.charsetCardB.setCharset(e)}}if(this.cardPosition>0){var t=this.getPrevPresetId();if(t!==false){this.charsetCardB.setCharset(t)}}},selectCharsetPreset:function(e){this.presetId=e;$("#characterSetChoosePresetMobileList").val(this.presetId);this.charsetCardA.setCharset(this.presetId);this.preloadNextPrev(this.presetId)},touchStart:function(e){this.touchVelocity.touchStart(e);var t=e.touches;this.startScrollYA=$("#chooseCharacterSetMobileOptionsA").scrollTop();this.startScrollYB=$("#chooseCharacterSetMobileOptionsB").scrollTop();if(t.length>0){var i=t[0].pageX;var r=t[0].pageY;this.touchStartX=i;this.touchStartY=r}},touchMove:function(e){this.touchVelocity.touchMove(e);var t=e.touches;if(t.length>0){var i=t[0].pageX;var r=t[0].pageY;if(this.moveVertical){return}var a=i-this.touchStartX;var s=-16;if(a<s){this.moveHorizonal=true;a=i-this.touchStartX-s;if(a>0){a=0}}if(a>-s){this.moveHorizonal=true;a=i-this.touchStartX+s;if(a<0){a=0}}if(this.moveHorizonal&&!this.cardMoving){this.setCardPosition(a)}if($(e.target).hasClass("choose-container-tick")){var o=$(this).parent();var l=$(o).scrollTop()}else{e.preventDefault()}}},touchEnd:function(e){this.touchVelocity.touchEnd(e);var t=e.touches;this.hideNext();this.moveHorizonal=false;this.moveVertical=false},nextPreset:function(){if(this.cardPosition===0){var e=this.getNextPresetId();if(e!==false){this.charsetCardB.setCharset(e);this.hideNext({gotoNext:true})}}},prevPreset:function(){if(this.cardPosition===0){var e=this.getPrevPresetId();if(e!==false){this.charsetCardB.setCharset(e);this.hideNext({gotoPrev:true})}}}};var TileSetImport=function(){this.editor=null;this.uiComponent=null;this.loadFormat="image";this.onscreenCanvas=null;this.loadImage=null;this.loadImageCanvas=null;this.loadImageData=null;this.indexedColorCanvas=null;this.indexedColorPalette=[];this.previewScale=2;this.importArgs={scale:2,startChar:0,tileCount:256,characterWidth:8,characterHeight:8,characterHSpacing:4,characterVSpacing:4,charactersAcross:32,characterHOffset:0,characterVOffset:0,tileSetInvert:false,tileSetDirection:"across",characterDataOffset:0,tileData:null};this.imageLib=new ImageLib;this.backgroundCanvas=null;this.mouseDownInCanvas=false;this.label="";this.loader=null;this.loaded=0;this.importCharPad=null;this.font=null;this.uncd=null;this.glyphCanvas=null;this.colours="source";this.palette=[];this.paletteMap={};this.parentComponent=null;this.tileSet=null};TileSetImport.prototype={init:function(e,t){this.editor=e;if(typeof t!="undefined"){this.parentComponent=t}},start:function(e){var t=this;this.dialogReadyCallback=false;if(typeof e!="undefined"){if(typeof e.dialogReadyCallback!="undefined"){this.dialogReadyCallback=e.dialogReadyCallback}}if(this.uiComponent==null){var i=800;var r=600;if(this.parentComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"tileSetImportDialog",title:"Load / Import Tile Set",width:i,height:r})}else{this.uiComponent=this.parentComponent}this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/tileSetImport.html",function(){t.initContent();t.initEvents();if(t.dialogReadyCallback!==false){t.dialogReadyCallback()}});if(this.parentComponent==null){this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.importTileSet();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}}else{if(this.dialogReadyCallback!==false){this.dialogReadyCallback()}}if(this.parentComponent==null){UI.showDialog("tileSetImportDialog")}},initContent:function(){},initEvents:function(){var i=this;document.getElementById("loadTileSetFile").addEventListener("change",function(e){var t=document.getElementById("loadTileSetFile").files[0];i.chooseTileSetFile(t)});$("#loadTileSetMode").on("change",function(){i.setLoadParameters()});$("#loadTileSetCanvas").on("mousedown",function(e){i.mouseDownCanvas(e)});$("input[name=loadTileSetResize]").on("click",function(){i.setLoadParameters()});$("#loadTileSetWidth").on("change",function(){i.setLoadParameters()});$("#loadTileSetHeight").on("change",function(){i.setLoadParameters()});$("#loadTileSetFileOffset").on("change",function(){i.setLoadParameters()});$("#loadTileSetFileOffset").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetHOffset").on("change",function(){i.setLoadParameters()});$("#loadTileSetHOffset").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetCount").on("change",function(){i.setLoadParameters()});$("#loadTileSetCount").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetStartChar").on("change",function(){i.setLoadParameters()});$("#loadTileSetCount").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetVOffset").on("change",function(){i.setLoadParameters()});$("#loadTileSetVOffset").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetHSpacing").on("change",function(){i.setLoadParameters()});$("#loadTileSetHSpacing").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetVSpacing").on("change",function(){i.setLoadParameters()});$("#loadTileSetVSpacing").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetAcross").on("change",function(){i.setLoadParameters()});$("#loadTileSetWidth").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetHeight").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetAcross").on("keyup",function(){i.setLoadParameters()});$("#loadTileSetInvert").on("click",function(){i.setLoadParameters()});$("#loadTileSetMulticolor").on("click",function(){i.setLoadParameters()});$("input[name=loadTileSetDirection]").on("click",function(){i.setLoadParameters()});$("#loadTileSetPreviewSize").on("change",function(){i.previewScale=parseInt($("#loadTileSetPreviewSize").val(),10);i.previewTileSet()});$("#loadTileSetColors").on("change",function(){i.setColorsOption()});$("#loadTileSetChooseFile").on("click",function(){$("#tileSetImportForm")[0].reset();$("#loadTileSetFile").click()});$("#loadFontGenerate").on("click",function(){i.generateFontTileset()})},mouseDownCanvas:function(e){UI.captureMouse(this);this.mouseDownAtX=e.pageX;this.mouseDownAtY=e.pageY;this.mouseLastX=e.pageX;this.mouseLastY=e.pageY;this.mouseDownHOffset=parseInt($("#loadTileSetHOffset").val(),10);this.mouseDownVOffset=parseInt($("#loadTileSetVOffset").val(),10);this.mouseDownFileOffset=parseInt($("#loadTileSetFileOffset").val(),10);this.mouseDownInCanvas=true},mouseMove:function(e){var t=e.pageX;var i=e.pageY;var r=Math.floor((t-this.mouseDownAtX)/this.previewScale);var a=Math.floor((i-this.mouseDownAtY)/this.previewScale);if(this.mouseDownInCanvas){if(this.loadFormat=="image"){var s=this.mouseDownHOffset+r;var o=this.mouseDownVOffset+a;$("#loadTileSetHOffset").val(s);$("#loadTileSetVOffset").val(o);this.setLoadParameters()}else if(this.loadFormat=="binary"){var l=this.mouseDownFileOffset;if(e.shiftKey||e.altKey){l-=r}else{l-=r*8;l-=a*8*16}if(l<0){l=0}$("#loadTileSetFileOffset").val(l);this.setLoadParameters()}}},mouseUp:function(e){this.mouseDownInCanvas=false},setParametersFromImage:function(){var e=this.loadImage.naturalWidth;var t=this.loadImage.naturalHeight;$("#loadTileSetWidth").val(8);$("#loadTileSetHeight").val(8);$("#loadTileSetCount").val(256);$("#loadTileSetStartChar").val(1);$("#loadTileSetAcross").val(16);$("#loadTileSetHOffset").val(0);$("#loadTileSetVOffset").val(0);$("#loadTileSetHSpacing").val(0)},chooseTileSetFile:function(e){if(typeof e=="undefined"){return}var i=this;var t=e.name;var r=t.lastIndexOf(".");var a=t.split(".").pop().toLowerCase();this.tilename=e.name;$("#loadTileSetFileName").html(t);this.label=t;if(r!==-1){this.label=t.substr(0,r)}if(this.onscreenCanvas==null){this.onscreenCanvas=document.getElementById("loadTileSetCanvas")}this.loadFormat="binary";switch(a){case"vector":this.loadFormat="font";break;case"ttf":case"otf":this.loadFormat="font";break;case"png":case"gif":case"jpg":case"jpeg":this.loadFormat="image";break;case"json":this.loadFormat="json";break;case"ctm":this.loadFormat="charpad";break;default:this.loadFormat="binary"}$("#loadTileSetSettings").show();if(this.loadFormat=="image"){this.setLoadParameters(false);$("#loadTileSetParameters").show();$("#loadTileSetParametersStatic").hide();$("#loadTileSetImageSettings").show();$("#loadTileSetBinarySettings").hide();$("#loadTileSetFontSettings").hide();if(!this.loadImageCanvas){this.loadImageCanvas=document.createElement("canvas")}if(!this.loadImage){this.loadImage=new Image}var s=window.URL||window.webkitURL;var o=s.createObjectURL(e);var i=this;this.loadImage.onload=function(){i.resize=false;var e=i.loadImage.naturalWidth;var t=i.loadImage.naturalHeight;i.loadImageCanvas.width=e;i.loadImageCanvas.height=t;i.loadImageContext=UI.getContextNoSmoothing(i.loadImageCanvas);i.loadImageContext.drawImage(i.loadImage,0,0);i.loadImageData=i.loadImageContext.getImageData(0,0,e,t);if(i.importArgs.mode=="indexed"){i.setupIndexedColor()}i.setParametersFromImage();i.setLoadParameters(true)};this.loadImage.src=o}else if(this.loadFormat=="font"){$("#loadTileSetParameters").hide();$("#loadTileSetParametersStatic").hide();$("#loadTileSetImageSettings").hide();$("#loadTileSetBinarySettings").hide();$("#loadTileSetFontSettings").show();var i=this;var l=new FileReader;l.onload=function(e){i.readFont(e.target.result)};l.readAsArrayBuffer(e)}else if(this.loadFormat=="json"){this.setLoadParameters(false);$("#loadTileSetParameters").hide();$("#loadTileSetParametersStatic").show();$("#loadTileSetImageSettings").hide();$("#loadTileSetBinarySettings").hide();$("#loadTileSetFontSettings").hide();var l=new FileReader;l.onload=function(e){i.readJson(e.target.result)};l.readAsText(e)}else if(this.loadFormat=="charpad"){$("#loadTileSetParameters").show();$("#loadTileSetParametersStatic").hide();$("#loadTileSetImageSettings").hide();$("#loadTileSetBinarySettings").hide();$("#loadTileSetFontSettings").hide();var i=this;var l=new FileReader;l.onload=function(e){var t=new Uint8Array(e.target.result);i.readCharPad(t)};l.readAsArrayBuffer(e)}else{this.setLoadParameters(false);if(a=="64c"){$("#loadTileSetFileOffset").val(2);this.importArgs.characterDataOffset=2}$("#loadTileSetParameters").show();$("#loadTileSetParametersStatic").hide();$("#loadTileSetImageSettings").hide();$("#loadTileSetBinarySettings").show();$("#loadTileSetFontSettings").hide();var i=this;var l=new FileReader;l.onload=function(e){i.importArgs.tileData=new Uint8Array(e.target.result);i.previewTileSet()};l.readAsArrayBuffer(e)}},setLoadParameters:function(e){if(typeof e=="undefined"){e=true}var t=$("#loadTileSetMode").val();if(t!=this.importArgs.mode){this.importArgs.mode=t;if(t=="indexed"){$("#loadTileSetColorsControl").show();this.setupIndexedColor()}else{$("#loadTileSetColorsControl").hide()}}var i=parseInt($("input[name=loadTileSetResize]:checked").val(),10);if(!isNaN(i)){if(this.resize!=i&&this.loadImage){this.resize=i;var r=i/100;var a=Math.floor(this.loadImage.naturalWidth*r);var s=Math.floor(this.loadImage.naturalHeight*r);this.loadImageCanvas.width=a;this.loadImageCanvas.height=s;this.loadImageContext=UI.getContextNoSmoothing(this.loadImageCanvas);this.loadImageContext.drawImage(this.loadImage,0,0,a,s);this.loadImageData=this.loadImageContext.getImageData(0,0,a,s);this.importArgs.pixelSpacing=1;if(t=="indexed"){this.setupIndexedColor()}}if(!this.loadImage){this.importArgs.pixelSpacing=Math.floor(100/this.resize)}}var o=parseInt($("#loadTileSetWidth").val(),10);if(!isNaN(o)){this.importArgs.characterWidth=o}var l=parseInt($("#loadTileSetHeight").val(),10);if(!isNaN(l)){this.importArgs.characterHeight=l}var n=parseInt($("#loadTileSetHSpacing").val(),10);if(!isNaN(n)){this.importArgs.characterHSpacing=n}var n=parseInt($("#loadTileSetVSpacing").val(),10);if(!isNaN(n)){this.importArgs.characterVSpacing=n}var h=parseInt($("#loadTileSetAcross").val(),10);if(!isNaN(h)){this.importArgs.charactersAcross=h}var d=parseInt($("#loadTileSetFileOffset").val(),10);if(!isNaN(d)){this.importArgs.characterDataOffset=d}var c=parseInt($("#loadTileSetHOffset").val(),10);if(!isNaN(c)){this.importArgs.characterHOffset=c}var f=parseInt($("#loadTileSetVOffset").val(),10);if(!isNaN(f)){this.importArgs.characterVOffset=f}var u=parseInt($("#loadTileSetCount").val(),10);if(!isNaN(u)){this.importArgs.tileCount=u}var p=parseInt($("#loadTileSetStartChar").val(),10);if(!isNaN(p)){this.startChar=p-1}this.importArgs.tileSetInvert=$("#loadTileSetInvert").is(":checked");this.importArgs.tileSetDirection=$("input[name=loadTileSetDirection]:checked").val();if(this.onscreenCanvas&&e){this.previewTileSet()}},createBackgroundCanvas:function(){var e=this.onscreenCanvas.width;var t=this.onscreenCanvas.height;if(this.backgroundCanvas==null){this.backgroundCanvas=document.createElement("canvas")}if(this.backgroundContext==null||this.backgroundCanvas.width!=e||this.backgroundCanvas.height!=t){this.backgroundCanvas.width=e;this.backgroundCanvas.height=t;this.backgroundContext=this.backgroundCanvas.getContext("2d");this.backgroundContext.fillStyle="#cccccc";this.backgroundContext.fillRect(0,0,this.backgroundCanvas.width,this.backgroundCanvas.height);var i=5;var r=Math.ceil(this.backgroundCanvas.width/i);var a=Math.ceil(this.backgroundCanvas.height/i);this.backgroundContext.fillStyle="#bbbbbb";for(var s=0;s<a;s++){for(var o=0;o<r;o++){if((o+s)%2){this.backgroundContext.fillRect(o*i,s*i,i,i)}}}}var l=240;var n=40;var h=240;var d=this.backgroundCanvas.width;var c=this.backgroundCanvas.height;var f=this.previewScale;var u=this.backgroundContext.getImageData(0,0,d,c);var p=this.importArgs.characterHeight*f+this.gridLineWidth;for(var s=0;s<c;s+=p){for(var o=0;o<d;o++){for(var v=0;v<this.gridLineWidth;v++){var g=(o+(s+v)*d)*4;u.data[g]=l;u.data[g+1]=n;u.data[g+2]=h;u.data[g+3]=255}}}var m=this.importArgs.characterWidth*f+this.gridLineWidth;for(var s=0;s<c;s++){for(var o=0;o<d;o+=m){for(var v=0;v<this.gridLineWidth;v++){var g=(o+v+s*d)*4;u.data[g]=l;u.data[g+1]=n;u.data[g+2]=h;u.data[g+3]=255}}}this.backgroundContext.putImageData(u,0,0)},readCharPad:function(e){if(this.importCharPad==null){this.importCharPad=new ImportCharPad;this.importCharPad.init(this.editor)}this.importCharPad.readCharPad(e);this.setLoadParameters(true)},getFontNumGlyphs:function(){return this.font.maxp.numGlyphs},readFont:function(e){console.log("READ FONT!!!");this.font=Typr.parse(e)[0];console.log(this.font);this.uncd=new Array(this.getFontNumGlyphs());for(var t=0;t<13e4;t++){var i=Typr.U.codeToGlyph(this.font,t);if(i==0){continue}if(this.uncd[i]==null){this.uncd[i]=[t]}else{this.uncd[i].push(t)}}console.log(this.uncd);this.importArgs.characterWidth=60;this.importArgs.characterHeight=60;this.previewFontTileSet()},getTileSet:function(){var e=this.editor.tileSetManager.getCurrentTileSet();if(e==null){if(this.tileSet==null){this.tileSet=new TileSet}e=this.tileSet}return e},generateFontTileset:function(){this.previewTileSet()},drawFontPreview:function(){var e=this.getTileSet();var t=parseInt($("#loadFontTileSetWidth").val());var i=parseInt($("#loadFontTileSetHeight").val());var r=parseInt($("#loadFontFontSize").val());var a=parseInt($("#loadFontTileSetXOffset").val());var s=parseInt($("#loadFontTileSetYOffset").val());var o=parseInt($("#loadFontFirstChar").val());var l=parseInt($("#loadFontTileCount").val());var n=16;console.log("tile> :"+t+","+i+","+r);if(isNaN(t)||isNaN(i)||isNaN(r)){console.log("return");return}e.readVectorData({font:this.font,fontSize:r,tileWidth:t,tileHeight:i,tileHOffset:a,tileVOffset:s,tileCount:l,firstChar:o});u.putImageData(this.importArgs.dstImageData,0,0);return;if(!this.glyphCanvas){this.glyphCanvas=document.createElement("canvas")}this.glyphCanvas.width=Math.floor(t);this.glyphCanvas.height=Math.floor(i);var h=this.glyphCanvas.getContext("2d");h.font="20px sans";var d=r/this.font.head.unitsPerEm;var c=1772;var f=1772+255;var u=this.loadTileSetCanvas.getContext("2d");u.fillStyle="#ff00ff";u.fillRect(0,0,this.loadTileSetCanvas.width,this.loadTileSetCanvas.height);for(var p=c;p<f;p++){var v=(t+1)*((p-c)%n);var g=(i+1)*Math.floor((p-c)/n);console.log("glyph to path: "+p);var m=Typr.U.glyphToPath(this.font,p);h.save();h.clearRect(0,0,this.glyphCanvas.width,this.glyphCanvas.height);h.translate(a,s+Math.round(r));h.scale(d,-d);h.beginPath();Typr.U.pathToContext(m,h);h.fillStyle="#ffffff";h.fill();h.restore();var y=h.getImageData(0,0,t,i);for(var b=0;b<i;b++){for(var C=0;C<t;C++){var x=b*t*4+C*4;if(y.data[x]>100){y.data[x]=255;y.data[x+1]=255;y.data[x+2]=255;y.data[x+3]=255}else{y.data[x]=0;y.data[x+1]=0;y.data[x+2]=0;y.data[x+3]=0}}}h.putImageData(y,0,0);u.fillStyle="#222222";u.fillRect(v,g,t,i);u.drawImage(this.glyphCanvas,v,g)}},readJson:function(e){var t={};try{t=$.parseJSON(e)}catch(e){console.log(e.message);return}if(typeof t.height=="undefined"||typeof t.width=="undefined"||typeof t.tiles=="undefined"){alert("Sorry, could not interpret the JSON file");return}var i=t.tiles.length;this.importArgs.jsonData=t;$("#loadTileSetWidth").val(t.width);$("#loadTileSetHeight").val(t.height);$("#loadTileSetCount").val(i);$("#loadTileSetWidthStatic").html(t.width);$("#loadTileSetHeightStatic").html(t.height);$("#loadTileSetCountStatic").html(i);this.setLoadParameters(true)},previewFontTileSet:function(){var e=32;var t=32;this.importArgs.dstCharacterSpacing=2;this.importArgs.characterWidth=32;this.importArgs.characterHeight=32;this.importArgs.dstCharactersAcross=32;this.importArgs.dstCharactersDown=32;this.onscreenCanvas.width=this.importArgs.dstCharacterSpacing+(this.previewScale*this.importArgs.characterWidth+this.importArgs.dstCharacterSpacing)*this.importArgs.dstCharactersAcross;this.onscreenCanvas.height=this.importArgs.dstCharacterSpacing+(this.previewScale*this.importArgs.characterHeight+this.importArgs.dstCharacterSpacing)*this.importArgs.dstCharactersDown;var i=this.onscreenCanvas.getContext("2d");i.clearRect(0,0,this.onscreenCanvas.width,this.onscreenCanvas.height);var r=0;var a=32;var s=32;var o=t/this.font.head.unitsPerEm;for(var l=0;l<this.uncd.length;l++){var n=t*Math.floor(l/a);var h=e*(l%a);if(typeof this.uncd[l]!="undefined"){var d=this.uncd[l][0];d=l;var c=Typr.U.glyphToPath(this.font,d);i.save();i.translate(h,n);i.scale(o,-o);i.beginPath();Typr.U.pathToContext(c,i);i.fillStyle="#ffffff";i.fill();i.restore();if(l>1024){return}}}},setupIndexedColor:function(){var e=this.loadImageData;if(!e){return}this.palette=[];this.paletteMap={};this.palette.push(0);this.paletteMap["c0"]={index:0,count:0};var t=e.width;var i=e.height;var r=0;for(var a=0;a<i;a++){for(var s=0;s<t;s++){var o=(s+a*t)*4;var l=e.data[o]&255;var n=e.data[o+1]&255;var h=e.data[o+2]&255;var d=e.data[o+3]&255;var c=l<<16|n<<8|h;var f=(d<<24|c>>>0)>>>0;var u=false;if(typeof this.paletteMap["c"+f]!="undefined"){u=this.paletteMap["c"+f].index;this.paletteMap["c"+f].count++}else{u=this.palette.length;this.palette[u]=f;this.paletteMap["c"+f]={index:u,count:1};r++;if(r>255){console.log("too many colours!");a=i+1;s=t+1;break}}}}console.log("ciolour counr = "+r);var p="";var v=false;if(r<256){v="source";p+='<option value="source">Source Image</option>'}var g=[64,32,16,8];for(var m=0;m<g.length;m++){if(r>g[m]){if(v===false){v=g[m]}p+='<option value="'+g[m]+'">Source Image ('+g[m]+" Colours)</option>"}}var y=this.editor.colorPaletteManager.getCurrentColorPalette();if(y){p+='<option value="0">Current Palette</option>'}$("#loadTileSetColors").html(p);$("#loadTileSetColors").val(v);this.setLoadParameters();this.setColorsOption()},setColorsOption:function(){var e=this.resize/100;var t=$("#loadTileSetColors").val();var i=Math.floor(this.loadImage.naturalWidth*e);var r=Math.floor(this.loadImage.naturalHeight*e);if(this.indexedColorCanvas==null){this.indexedColorCanvas=document.createElement("canvas")}this.indexedColorCanvas.width=i;this.indexedColorCanvas.height=r;var a=UI.getContextNoSmoothing(this.indexedColorCanvas);a.drawImage(this.loadImage,0,0,this.loadImage.naturalWidth,this.loadImage.naturalHeight,0,0,i,r);if(t!="source"){t=parseInt(t,10);if(!isNaN(t)){var s=a.getImageData(0,0,i,r);this.indexedColorPalette=[];this.palette=[];this.paletteMap={};this.palette.push(0);this.paletteMap["c0"]={index:0,count:0};if(t!=0){var o=ImageUtils.createColorPaletteFromImage(t,this.indexedColorCanvas);for(var l=0;l<o.length;l+=4){var n=o[l];var h=o[l+1];var d=o[l+2];this.indexedColorPalette.push([n,h,d,255]);var c=255;var f=n<<16|h<<8|d;var u=(c<<24|f>>>0)>>>0;var p=this.palette.length;this.palette[p]=u;this.paletteMap["c"+u]={index:p,count:1}}}else{var v=this.editor.colorPaletteManager.getCurrentColorPalette();if(v){var g=v.getColorCount();for(var l=0;l<g;l++){this.indexedColorPalette.push(v.getRGBA(l))}}}this.imageLib.palette=this.indexedColorPalette;this.imageLib.setImageData(s);s=this.imageLib.reduceNearest();a.putImageData(s,0,0)}}this.previewImageTileSet()},previewImageTileSet:function(){var e=this.getTileSet();var t=this.resize/100;var i=Math.floor(this.loadImage.naturalWidth*t);var r=Math.floor(this.loadImage.naturalHeight*t);var a=this.importArgs.characterWidth;var s=this.importArgs.characterHeight;var o=this.importArgs.characterHSpacing;var l=this.importArgs.characterVSpacing;var n=this.importArgs.charactersAcross;var h=100;var d=this.importArgs.characterHOffset;var c=this.importArgs.characterVOffset;if(this.importArgs.mode=="indexed"&&this.indexedColorCanvas!=null){this.loadImageContext.drawImage(this.indexedColorCanvas,0,0)}else{this.loadImageContext.drawImage(this.loadImage,0,0,this.loadImage.naturalWidth,this.loadImage.naturalHeight,0,0,i,r)}var f=this.loadImageContext.getImageData(0,0,i,r);var u=this.loadImageContext.getImageData(0,0,i,r);var p=255;var v=0;for(var g=0;g<r;g++){for(var m=0;m<i;m++){var y=(g*i+m)*4;var b=f.data[y];var C=f.data[y+1];var x=f.data[y+2];if(this.importArgs.mode=="textmode"){if(b+C+x>200){b=p;C=p;x=p}else{b=v;C=v;x=v}f.data[y]=b;f.data[y+1]=C;f.data[y+2]=x}b=Math.floor(b/10)+80;C=Math.floor(C/10);x=Math.floor(x/10)+80;u.data[y]=b;u.data[y+1]=C;u.data[y+2]=x}}this.importArgs.dstImageData=u;this.importArgs.scale=1;this.importArgs.palette=this.palette;this.importArgs.paletteMap=this.paletteMap;this.importArgs.srcImageData=f;this.importArgs.dstPosIsSrcPos=true;e.readImageData(this.importArgs);this.importArgs.dstPosIsSrcPos=false;this.loadImageContext.putImageData(u,0,0);this.onscreenCanvas.width=i*this.previewScale;this.onscreenCanvas.height=r*this.previewScale;var S=UI.getContextNoSmoothing(this.onscreenCanvas);S.drawImage(this.loadImageCanvas,0,0,i*this.previewScale,r*this.previewScale);S.strokeStyle="#881188";S.strokeWidth=1;var m=d+o;S.beginPath();if(o==0){while(m>0){m-=a+o}while(m<i){S.moveTo(m*this.previewScale+.5,0);S.lineTo(m*this.previewScale+.5,r*this.previewScale);m+=a+o}}var g=c+l;if(l==0){while(g>0){g-=s+l}while(g<r){S.moveTo(0,g*this.previewScale+.5);S.lineTo(i*this.previewScale,g*this.previewScale+.5);g+=s+l}}S.stroke()},previewImageTileSetOld:function(){console.log("preview image tileset");var e=this.loadImage.naturalWidth;var t=this.loadImage.naturalHeight;var i=this.importArgs.characterWidth;var r=this.importArgs.characterHeight;var a=this.importArgs.tileCount;var s=this.importArgs.charactersAcross;var o=100;var l=this.importArgs.characterHOffset;var n=this.importArgs.characterVOffset;var h=0;this.loadImageContext.drawImage(this.loadImage,0,0);var d=this.importArgs.characterHSpacing;var c=this.importArgs.characterVSpacing;var f=this.loadImageContext.getImageData(0,0,e,t);if(this.importArgs.mode=="textmode"){var u=255;var p=0;for(var v=0;v<t;v++){for(var g=0;g<e;g++){var m=(v*e+g)*4;var y=f.data[m];var b=f.data[m+1];var C=f.data[m+2];if(y+b+C>200){y=u;b=u;C=u}else{y=p;b=p;C=p}f.data[m]=y;f.data[m+1]=b;f.data[m+2]=C}}}var x=false;var S=false;var P=0;var w=false;var I=false;var k=0;var M=0;var T=0;k=n;if(k==0){if(c==0){I=r;T++}else{w=c}}else if(k>0){I=false;w=false}else{var D=r+c;var E=-k;T=Math.ceil(E/D);var $=E%D;if($>=c){$=$-c;w=false;I=i-$}else{I=false;w=c-$}k=0}var _=h;for(var v=0;v<t;v++){x=false;S=false;M=0;P=l;if(P==0){if(d==0){S=i;M++;h++}else{x=d}}else if(P>0){S=false;x=false}else{var D=i+d;var E=-P;M=Math.ceil((E-d)/D);if((E-d)%D==0){M++}if(M>0&&I==r){h+=M-1}var $=E%D;if($>=d){$=$-d;x=false;S=i-$;if($==0){if(I==r){}}}else{S=false;x=d-$}P=0}if(I==r){_=h}h=_;for(var g=0;g<e;g++){var m=(v*e+g)*4;if(h>a||P>0||k>0||S===false||I===false||M>s||T>o){var y=f.data[m];var b=f.data[m+1];var C=f.data[m+2];y=Math.floor(y/10)+80;b=Math.floor(b/10);C=Math.floor(C/10)+80;f.data[m]=y;f.data[m+1]=b;f.data[m+2]=C;if(P>0){P--;if(P<=0){if(d==0){S=i;M++;if(M<=s&&I!==false){h++}}else{x=d}}}else{if(x!==false){x--;if(x<=0){x=false;S=i;M++;if(M<=s&&I!==false){h++}}}}}else{S--;if(S<=0){if(d==0){S=i;M++;if(M<=s){h++}}else{S=false;x=d}}}}if(I===false||k>0){if(k>0){k--;if(k<=0){if(c==0){I=r;T++}else{w=c}}}else{w--;if(w<=0){w=false;I=r;T++}}}else{I--;if(I<=0){if(c==0){I=r;T++}else{I=false;w=c}}}}this.loadImageContext.putImageData(f,0,0);this.onscreenCanvas.width=e*this.previewScale;this.onscreenCanvas.height=t*this.previewScale;var B=UI.getContextNoSmoothing(this.onscreenCanvas);B.drawImage(this.loadImageCanvas,0,0,e*this.previewScale,t*this.previewScale);if(this.importArgs.characterHSpacing==0){}if(this.importArgs.characterVSpacing==0){}},previewTileSet:function(){var e=this.getTileSet();if(this.loadFormat=="image"){this.previewImageTileSet();return}this.gridLineWidth=2;this.importArgs.dstCharacterSpacing=this.gridLineWidth;this.importArgs.dstCharactersAcross=16;this.importArgs.dstCharactersDown=Math.ceil(this.importArgs.tileCount/this.importArgs.dstCharactersAcross);var t=200;var i=240;var r=40;var a=240;var s=(i<<16)+(r<<8)+a;var o=("000000"+s.toString(16)).substr(-6);if(this.loadFormat=="font"){var l=parseInt($("#loadFontTileSetWidth").val());var n=parseInt($("#loadFontTileSetHeight").val());this.importArgs.characterWidth=l;this.importArgs.characterHeight=n}this.onscreenCanvas.width=this.importArgs.dstCharacterSpacing+(this.previewScale*this.importArgs.characterWidth+this.importArgs.dstCharacterSpacing)*this.importArgs.dstCharactersAcross;this.onscreenCanvas.height=this.importArgs.dstCharacterSpacing+(this.previewScale*this.importArgs.characterHeight+this.importArgs.dstCharacterSpacing)*this.importArgs.dstCharactersDown;var h=this.onscreenCanvas.getContext("2d");this.createBackgroundCanvas();h.drawImage(this.backgroundCanvas,0,0);this.importArgs.dstImageData=h.getImageData(0,0,this.onscreenCanvas.width,this.onscreenCanvas.height);this.importArgs.scale=this.previewScale;this.importArgs.palette=this.palette;this.importArgs.paletteMap=this.paletteMap;if(this.loadFormat=="json"){e.readJsonDataV1(this.importArgs);h.putImageData(this.importArgs.dstImageData,0,0)}if(this.loadFormat=="charpad"){this.importArgs.tileData=this.importCharPad.getCharData();console.log(this.importArgs);e.readBinaryData(this.importArgs);h.putImageData(this.importArgs.dstImageData,0,0)}if(this.loadFormat=="binary"){e.readBinaryData(this.importArgs);h.putImageData(this.importArgs.dstImageData,0,0)}},generateColorPalette:function(){var e=this.loadImageData;if(!e){return}this.palette=[];this.paletteMap={};this.palette.push(0);this.paletteMap["c0"]={index:0,count:0};var t=e.width;var i=e.height;var r=0;for(var a=0;a<i;a++){for(var s=0;s<t;s++){var o=(s+a*t)*4;var l=e.data[o]&255;var n=e.data[o+1]&255;var h=e.data[o+2]&255;var d=e.data[o+3]&255;var c=l<<16|n<<8|h;var f=(d<<24|c>>>0)>>>0;var u=false;if(typeof this.paletteMap["c"+f]!="undefined"){u=this.paletteMap["c"+f].index;this.paletteMap["c"+f].count++}else{u=this.palette.length;this.palette[u]=f;this.paletteMap["c"+f]={index:u,count:1};r++;if(r>255){console.log("too many colours!");return}}}}},importTileSet:function(e){var t=false;var i=null;if(typeof e!="undefined"){t=e.callback}var r=false;var a=this.editor.tileSetManager.getCurrentTileSet();if(a==null||typeof e.createTileSet!="undefined"&&e.createTileSet){a=new TileSet;r=true}if(this.loadFormat=="image"){this.importArgs.srcImageData=this.loadImageData;this.importArgs.scale=1;this.importArgs.palette=this.palette;this.importArgs.paletteMap=this.paletteMap;this.importArgs.dstImageData=null;var s=this.editor.layers.getSelectedLayerObject();if(s&&s.getType()=="grid"){switch(this.importArgs.mode){case"indexed":s._setMode(TextModeEditor.Mode.INDEXED);break;case"rgb":s._setMode(TextModeEditor.Mode.RGB);break;case"textmode":if(s.getMode()!=TextModeEditor.Mode.TEXTMODE){s._setMode(TextModeEditor.Mode.TEXTMODE)}break}}if(this.importArgs.mode=="indexed"){i=this.editor.colorPaletteManager.getCurrentColorPalette();if(!i){i=new ColorPalette}var o=8;var l=Math.ceil(this.importArgs.palette.length/o);i.setColors(this.importArgs.palette,o,l);var n=this.indexedColorCanvas.getContext("2d");this.importArgs.srcImageData=n.getImageData(0,0,this.indexedColorCanvas.width,this.indexedColorCanvas.height)}a.readImageData(this.importArgs);a.setType("ascii");a.setLabel(this.label);a.setSortMethods()}if(this.loadFormat=="binary"){this.importArgs.scale=1;this.importArgs.dstImageData=null;a.readBinaryData(this.importArgs);a.setType("ascii");a.setLabel(this.label);a.setSortMethods()}if(this.loadFormat=="charpad"){this.importArgs.scale=1;this.importArgs.dstImageData=null;a.readBinaryData(this.importArgs);a.setType("ascii");a.setLabel(this.label);a.setSortMethods()}if(this.loadFormat=="json"){this.importArgs.scale=1;this.importArgs.dstImageData=null;a.readJsonDataV1(this.importArgs)}if(this.loadFormat=="font"){var h=parseInt($("#loadFontTileSetWidth").val());var d=parseInt($("#loadFontTileSetHeight").val());var c=parseFloat($("#loadFontFontSize").val());var f=parseFloat($("#loadFontTileSetXOffset").val());var u=parseFloat($("#loadFontTileSetYOffset").val());var p=parseInt($("#loadFontFirstChar").val());var v=parseInt($("#loadFontTileCount").val());var g=16;if(isNaN(h)||isNaN(d)||isNaN(c)){return}a.readVectorData({font:this.font,fontSize:c,tileWidth:h,tileHeight:d,tileHOffset:f,tileVOffset:u,tileCount:v,firstChar:p})}if(r){if(t!=false){t({tileSetCreated:true,tileSet:a,type:a.getType(),presetId:false,description:{name:a.label},mode:this.importArgs.mode,colorPalette:i})}}else{this.editor.tileSetManager.tileSetUpdated({updateBlankCells:true,updateSortMethods:true});a.refreshFromImageData();if(g_app.getMode()=="tile set"){g_app.tileSetEditor.redraw()}else{this.editor.tools.drawTools.tilePalette.drawTilePalette();this.editor.sideTilePalette.drawTilePalette();this.editor.graphic.setCellDimensionsFromTiles();this.editor.graphic.redraw({allCells:true})}}}};var TileSetSave=function(){this.editor=null;this.tilesAcross=16};TileSetSave.prototype={init:function(e){this.editor=e},show:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"saveTileSetDialog",title:"Save Tileset",width:300,height:160});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/tileSetSave.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.save();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("saveTileSetDialog")},updateTilesAcross:function(){var e=parseInt($("#saveTileSetTilesAcross").val(),10);if(!isNaN(e)){this.tilesAcross=e}},updateExportFormat:function(){var e=$("#saveTileSetFormat").val();if(e=="png"){$("#saveTilesSetTilesAcrossSection").show()}else{$("#saveTilesSetTilesAcrossSection").hide()}},initContent:function(){this.updateExportFormat();this.updateTilesAcross()},initEvents:function(){var e=this;$("#saveTileSetTilesAcross").on("change",function(){e.updateTilesAcross()});$("#saveTileSetFormat").on("change",function(){e.updateExportFormat()})},save:function(){var e=$("#saveTileSetAs").val();var t=$("#saveTileSetFormat").val();var i=this.editor.tileSetManager.getCurrentTileSet();switch(t){case"json":i.saveAsJson(e);break;case"png":i.exportPng({filename:e,tilesAcross:this.tilesAcross});break;case"bin":i.exportBinary(e,{});break}}};var ChooseCharactersDialog=function(){this.editor=null;this.tilePickerCanvas=null;this.context=null;this.charsets={none:[],alpha:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154],triangles:[32,160,95,105,223,233],squares:[32,160,108,123,124,126,127,255,102,230,207,208,204,250],diagonals:[77,78],verticals:[101],circles:[81,87],segments:[32,160,108,123,124,126,100,111,121,98,120,119,99,101,116,117,97,118,103,106,82,70,64,68,69,228,239,249,226,248,247,227,229,244,245,225,246,231,234,236,251,252,254,240,238,253,237,207,208,250,204,84,71,93,72,89,127,255],"4x4":[32,160,108,123,126,124,127,255,236,251,254,252,97,225,98,226]};this.callback=null;this.uiComponent=null;this.mouseMode="";this.tilePaletteDisplay=null};ChooseCharactersDialog.prototype={init:function(e){this.editor=e},show:function(e){this.charPaletteMap=this.editor.tools.drawTools.tilePalette.charPaletteMap;var t=this.editor.tileSetManager.getCurrentTileSet();if(this.uiComponent==null){var i=740;var r=240;var a=this;var s='<div class="panelFill">';s+='<div id="chooseCharsCanvasHolder" style="position: absolute; top: 2px; bottom: 32px; left: 2px; right: 2px">';s+='<canvas width="144" height="36" id="chooseCharsCanvas" style="background-color: #222222"></canvas>';s+="</div>";s+='<div id="chooseCharsTypeHolder" style="position: absolute; left: 2px; right: 2px; bottom: 2px; height: 26px">';s+='  <div class="ui-button chooseCharsType" data-type="none">Clear Selection</div>';s+='  <div style="display: inline-block" id="chooseCharsPetscii">';s+='    <div class="ui-button chooseCharsType" data-type="triangles">Triangles</div>';s+='    <div class="ui-button chooseCharsType" data-type="squares">Squares</div>';s+='    <div class="ui-button chooseCharsType" data-type="circles">Circles</div>';s+='    <div class="ui-button chooseCharsType" data-type="diagonals">Diagonals</div>';s+='    <div class="ui-button chooseCharsType" data-type="verticals">Verticals</div>';s+='    <div class="ui-button chooseCharsType" data-type="segments">Segments</div>';s+='    <div class="ui-button chooseCharsType" data-type="4x4">4x4 Pixel</div>';s+='    <div class="ui-button chooseCharsType" data-type="alpha">Alpha</div>';s+="  </div>";s+="</div>";s+="</div>";this.uiComponent=UI.create("UI.Dialog",{id:"chooseCharactersDialog",title:"Choose Characters",width:i,height:r});this.htmlComponent=UI.create("UI.HTMLPanel",{html:s});this.uiComponent.add(this.htmlComponent);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){if(a.callback){a.callback(a.tilePaletteDisplay.getSelectedCharacters())}UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});UI.on("ready",function(){a.initContent();a.initEvents();a.uiComponent.on("resize",function(){a.resize()})})}else{this.initContent()}this.callback=null;if(typeof e!="undefined"){if(typeof e.callback!="undefined"){this.callback=e.callback}if(typeof e.chars!="undefined"){this.tilePaletteDisplay.setSelected(e.chars)}}UI.showDialog("chooseCharactersDialog");this.resize()},initContent:function(){var e=this.editor.tileSetManager.getCurrentTileSet();if(this.tilePaletteDisplay==null){this.tilePaletteDisplay=new TilePaletteDisplay;this.tilePaletteDisplay.init(this.editor,{mode:"multiple",canvasElementId:"chooseCharsCanvas",colors:"monochrome"})}var t=this.editor.tools.drawTools.tilePalette.getTilePaletteMapType();this.tilePaletteDisplay.initCharPalette({mapType:t});this.tilePaletteDisplay.draw();var i=this.tilePaletteDisplay.getWidth();var r=this.tilePaletteDisplay.getHeight();var a=i+80;var s=r+120;UI("chooseCharactersDialog").setWidth(a);UI("chooseCharactersDialog").setHeight(s)},resize:function(){if(this.tilePickerCanvas==null){this.tilePickerCanvas=document.getElementById("chooseCharsCanvas")}var e=$("#chooseCharsCanvasHolder");this.width=e.width();this.height=e.height();if(this.width!=this.tilePickerCanvas.style.width||this.height!=this.tilePickerCanvas.style.height){if(this.width!=0&&this.height!=0){this.tilePickerCanvas.style.width=this.width+"px";this.tilePickerCanvas.style.height=this.height+"px";this.tilePickerCanvas.width=this.width*UI.devicePixelRatio;this.tilePickerCanvas.height=this.height*UI.devicePixelRatio}}if(this.tilePaletteDisplay!=null){this.tilePaletteDisplay.draw()}},initEvents:function(){var i=this;$(".chooseCharsType").on("click",function(e){var t=$(this).attr("data-type");if(typeof i.charsets[t]!="undefined"){i.tilePaletteDisplay.setSelected(i.charsets[t])}});$("#chooseCharsCancel").on("click",function(){i.editor.hideDialog()});$("#chooseCharsOK").on("click",function(){if(i.callback){i.callback()}i.editor.hideDialog()})}};var TilePickerPopup=function(){this.html='<div style="position: absolute; top: 0; bottom: 0; left: 0; right: 0">';this.html+='  <div id="charactePickerCanvasHolder" style="position: absolute; top: 0; bottom: 28px; left: 0; right: 0; overflow: hidden">';this.html+='    <canvas id="characterPickerCanvas"></canvas>';this.html+="  </div>";this.html+='  <div style="position: absolute; bottom: 4px; left: 4px; height: 20px;" id="characterPickerInfo" style="color: #ffffff"></div>';this.html+="</div>";this.uiComponent=null;this.htmlComponent=null;this.highlightedCharacter=false;this.characterPickedCallback=null;this.tilePickerCanvas=null;this.layout="vertical";this.mode="single";this.tilePaletteDisplay=null};TilePickerPopup.prototype={init:function(e,t){var i=this;this.editor=e;this.uiComponent=UI.create("UI.Popup",{id:"tilePickerPopup",width:300,height:300});this.uiComponent.on("keydown",function(e){i.editor.keyDown(e);i.tilePaletteDisplay.draw({redrawTiles:true})});this.uiComponent.on("keyup",function(e){i.editor.keyUp(e);i.tilePaletteDisplay.draw({redrawTiles:true})});this.htmlComponent=UI.create("UI.HTMLPanel",{html:this.html});this.uiComponent.add(this.htmlComponent)},updateInfo:function(e){var t="";t+="Tile: ";t+=e;var i=e.toString(16);if(i.length==1){i="0"+i}i="0x"+i;t=="("+i+")";$("#characterPickerInfo").html(t)},resize:function(){if(this.tilePickerCanvas==null){this.tilePickerCanvas=document.getElementById("characterPickerCanvas")}var e=$("#charactePickerCanvasHolder");this.width=e.width();this.height=e.height();if(this.width!=this.tilePickerCanvas.style.width||this.height!=this.tilePickerCanvas.style.height){if(this.width!=0&&this.height!=0){this.tilePickerCanvas.style.width=this.width+"px";this.tilePickerCanvas.style.height=this.height+"px";this.tilePickerCanvas.width=this.width*UI.devicePixelRatio;this.tilePickerCanvas.height=this.height*UI.devicePixelRatio}}if(this.tilePaletteDisplay!=null){this.tilePaletteDisplay.draw()}},show:function(e,t,i){var r=this;this.characterPickedCallback=null;if(typeof i.characterPickedCallback!="undefined"){this.characterPickedCallback=i.characterPickedCallback}if(typeof i.mode!="undefined"){this.mode=i.mode}var a=this.editor.tileSetManager.getCurrentTileSet();if(this.tilePaletteDisplay==null){this.tilePaletteDisplay=new TilePaletteDisplay;this.tilePaletteDisplay.init(this.editor,{mode:this.mode,canvasElementId:"characterPickerCanvas",blockStacking:"vertical"});this.tilePaletteDisplay.on("characterselected",function(e){if(e!==false){r.characterPickedCallback(e)}UI.hidePopup()});this.tilePaletteDisplay.on("highlightchanged",function(e){if(e!==false){r.updateInfo(e)}})}this.tilePaletteDisplay.setScale(2);this.tilePaletteDisplay.setMode(this.mode);if(this.mode=="single"){if(typeof i.selected!="undefined"){this.tilePaletteDisplay.setSelectedGrid([]);this.tilePaletteDisplay.setSelected([i.selected])}}if(typeof i.mouseUp!="undefined"){this.tilePaletteDisplay.on("mouseup",function(e){var t={};t.characters=r.tilePaletteDisplay.getSelectedCharacters();t.grid=r.tilePaletteDisplay.getSelectedCharactersGrid();i.mouseUp(e,t)})}var s=this.editor.tools.drawTools.tilePalette.getTilePaletteMapType();this.tilePaletteDisplay.initCharPalette({mapType:s});this.tilePaletteDisplay.draw({redrawTiles:true});var o=this.tilePaletteDisplay.getWidth();var l=this.tilePaletteDisplay.getHeight();var n=o;var h=l+30;if(n>UI.getScreenWidth()-20){n=UI.getScreenWidth()-20}if(h>UI.getScreenHeight()-200){h=UI.getScreenHeight()-200;n+=14}this.uiComponent.setDimensions(n,h);UI.showPopup("tilePickerPopup",e,t);this.resize()}};var TileMaterials=function(){this.editor=null;this.prefix="";this.tileMaterialsCanvas=null};TileMaterials.prototype={init:function(e,t){this.editor=e;if(typeof t!="undefined"){this.prefix=t}},getHTML:function(){var e='<div class="panelFill" style="color: white">';e+='  <div style="padding-left: 2px;" id="tileMaterialControls">';e+='    <div style="margin: 4px 0 2px 0; font-size: 10px; font-weight: normal; color: #999999">Tile Material</div>';e+='    <canvas id="'+this.prefix+'tileMaterialsCanvas"></canvas>';e+="  </div>";e+="</div>";return e},buildInterface:function(e){var t=this.getHTML();var i=UI.create("UI.HTMLPanel",{html:t});e.add(i);var r=this;UI.on("ready",function(){r.initEvents()})},initEvents:function(){var t=this;if(this.tileMaterialsCanvas==null){this.tileMaterialsCanvas=document.getElementById(this.prefix+"tileMaterialsCanvas")}this.tileMaterialsCanvas.addEventListener("mousedown",function(e){t.materialsMouseDown(e)},false);this.tileMaterialsCanvas.addEventListener("mousemove",function(e){t.materialsMouseMove(e)},false);this.tileMaterialsCanvas.addEventListener("mouseup",function(e){t.materialsMouseUp(e)},false)},materialsMouseDown:function(e){var t=e.pageX-$("#"+this.tileMaterialsCanvas.id).offset().left;var i=e.pageY-$("#"+this.tileMaterialsCanvas.id).offset().top;var r=Math.floor((t-this.materialSpacing)/(this.materialWidth+this.materialSpacing));var a=Math.floor((i-this.materialSpacing)/(this.materialHeight+this.materialSpacing));var s=r+a*8;if(s>=0&&s<16){this.editor.currentTile.setMaterial(s)}},materialsMouseMove:function(e){var t=e.pageX-$("#"+this.tileMaterialsCanvas.id).offset().left;var i=e.pageY-$("#"+this.tileMaterialsCanvas.id).offset().top},materialsMouseUp:function(e){var t=e.pageX-$("#"+this.tileMaterialsCanvas.id).offset().left;var i=e.pageY-$("#"+this.tileMaterialsCanvas.id).offset().top},drawTileMaterials:function(){if(this.tileMaterialsCanvas==null){this.tileMaterialsCanvas=document.getElementById(this.prefix+"tileMaterialsCanvas")}var e=this.editor.tileSetManager.getCurrentTileSet();this.materialWidth=16;this.materialHeight=16;this.materialSpacing=1;var t=8*(this.materialWidth+this.materialSpacing)+this.materialSpacing;var i=2*(this.materialHeight+this.materialSpacing)+this.materialSpacing;this.tileMaterialsCanvas.width=t*UI.devicePixelRatio;this.tileMaterialsCanvas.height=i*UI.devicePixelRatio;this.tileMaterialsCanvas.style.width=t+"px";this.tileMaterialsCanvas.style.height=i+"px";this.tileMaterialsContext=this.tileMaterialsCanvas.getContext("2d");this.tileMaterialsContext.fillStyle="#222222";this.tileMaterialsContext.fillRect(0,0,this.tileMaterialsCanvas.width,this.tileMaterialsCanvas.height);var r=this.editor.currentTile;for(var a=0;a<2;a++){for(var s=0;s<8;s++){var o=s+a*8;var l=(this.materialSpacing+s*(this.materialWidth+this.materialSpacing))*UI.devicePixelRatio;var n=(this.materialSpacing+a*(this.materialHeight+this.materialSpacing))*UI.devicePixelRatio;var h=this.materialWidth*UI.devicePixelRatio;var d=this.materialHeight*UI.devicePixelRatio;var c=false;if(r.useCells){for(var f=0;f<r.cells.length;f++){for(var u=0;u<r.cells[f].length;u++){var p=r.cells[f][u].t;if(p!=this.editor.tileSetManager.noTile){if(e.getTileMaterial(p)==o){c=true}}}}}else{var v=r.getTiles();for(var f=0;f<v.length;f++){for(var u=0;u<v[f].length;u++){var p=v[f][u];if(p!=this.editor.tileSetManager.noTile){if(e.getTileMaterial(p)==o){c=true}}}}}if(c){this.tileMaterialsContext.fillStyle="#cccccc"}else{this.tileMaterialsContext.fillStyle="#121212"}this.tileMaterialsContext.fillRect(l,n,h,d);var g=16*UI.devicePixelRatio;var m=g+'px "Courier New", Courier, monospace';this.tileMaterialsContext.font=m;if(c){this.tileMaterialsContext.fillStyle="#121212"}else{this.tileMaterialsContext.fillStyle="#cccccc"}for(var u=0;u<128;u++){var y=o.toString(16).toUpperCase();var b=this.tileMaterialsContext.measureText(y);var C=l+(h-b.width)/2;var x=n+12*UI.devicePixelRatio;this.tileMaterialsContext.fillText(y,C,x)}}}}};var BlockSetManager=function(){this.currentBlockSetId=false;this.blockSets={};this.blockSizeDialog=null};BlockSetManager.prototype={init:function(e){this.editor=e},initBlockSizeDialogContent:function(){var e=this.editor.layers.getSelectedLayerObject();var t=2;var i=2;this.blockSet=this.editor.blockSetManager.getCurrentBlockSet();if(e&&e.getType()=="grid"){t=e.getBlockWidth();i=e.getBlockHeight()}$("#settingsBlockWidth").val(t);$("#settingsBlockHeight").val(i);var r=this.editor.getColorPerMode();if(r==="cell"){r="block"}$("#settingsBlockColorMode").val(r)},initBlockSizeDialog:function(){var a=this;this.blockSizeDialog=UI.create("UI.Dialog",{id:"blockSizeDialog",title:styles.text.blockName+" Size",width:280,height:168});this.blockSizeHTML=UI.create("UI.HTMLPanel");this.blockSizeDialog.add(this.blockSizeHTML);this.blockSizeHTML.load("html/textMode/blockSizeDialog.html",function(){a.initBlockSizeDialogContent();UI.showDialog("blockSizeDialog")});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.blockSizeDialog.addButton(this.okButton);this.okButton.on("click",function(e){var t=$("#settingsBlockWidth").val();var i=$("#settingsBlockHeight").val();var r=$("#settingsBlockColorMode").val();if(typeof a.blockSizeDialogCallback!="undefined"){a.blockSizeDialogCallback(t,i,r)}UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.blockSizeDialog.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})},showBlockSizeDialog:function(e){this.blockSizeDialogCallback=e;if(this.blockSizeDialog==null){this.initBlockSizeDialog()}else{this.initBlockSizeDialogContent();UI.showDialog("blockSizeDialog")}},checkBlockMode:function(e,t){var i=this.getCurrentBlockSet();if(!i){console.log("NO BLOCK SET!!!");return}var r=i.getBlockCount();if(r===0){console.log("CREATING A BLOCK");var a=this.editor.tileSetManager.blankCharacter;var s=this.editor.currentTile.getColor();var o=this.editor.colorPaletteManager.noColor;var l=[];for(var n=0;n<t;n++){l[n]=[];for(var h=0;h<e;h++){l[n].push({fc:s,bc:o,t:a})}}var d=i.createBlock({bc:o,fc:s,data:l});this.editor.graphic.initFrameBlocks(d);this.editor.tools.drawTools.blockPalette.selectBlock();this.editor.sideBlockPalette.selectBlock();return true}else{var c=i.getBlocks();var f=true;for(var u=0;u<c.length;u++){if(c[u].data.length!=t||c[u].data[0].length!=e){f=false;break}}if(!f){if(confirm("Not all blocks are the correct size, proceeding will resize them. Proceed?")){for(var u=0;u<c.length;u++){if(c[u].data.length!=t||c[u].data[0].length!=e){i.setBlockDimensions(u,e,t)}}this.editor.graphic.initFrameBlocks(0);this.editor.tools.drawTools.blockPalette.selectBlock();this.editor.sideBlockPalette.selectBlock();return true}else{return false}}}},createBlockSet:function(e){var t=2;var i=2;var r="Block Set";console.error("shoulnd't get here...");if(typeof e!="undefined"){if(e.width!="undefined"){t=e.width}if(e.height!="undefined"){i=e.height}}if(typeof e.name!="undefined"){r=e.name}var a=g_app.doc.createDocRecord("/block sets",r,"block set",{width:t,height:i,blocks:[]});this.currentBlockSetId=a.id;return a},setCurrentBlockSetFromId:function(e){console.error("set current block set from id!!!");var t=g_app.doc.getDocRecordById(e,"/block sets");if(t!=null){if(this.currentBlockSet==null){this.currentBlockSet=new BlockSet}console.log("set current block size to "+e);this.currentBlockSetId=e;this.currentBlockSet.init(this.editor,t.name,t.id)}},getCurrentBlockSet:function(){var e=this.editor.tileSetManager.getCurrentTileSet();if(!e){return null}var t=e.getPath();var i=t+"/block sets";var r=g_app.doc.getDocRecord(i);if(!r){r=g_app.doc.createDocRecord(t,"block sets","folder",{})}var a="block set";var s=i+"/"+a;var o=g_app.doc.getDocRecord(s);if(!o){o=g_app.doc.createDocRecord(i,a,"block set",{blocks:[]})}return this.getBlockSet(s)},getBlockSet:function(e){if(this.blockSets.hasOwnProperty(e)){return this.blockSets[e]}var t=g_app.doc.getDocRecord(e);if(!t){var i=e.lastIndexOf("/");var r=e.substring(0,i);var a=e.substring(i+1);console.log("create "+r+" - "+a);var s=g_app.doc.getDocRecord(r);if(!s){var i=r.lastIndexOf("/");var o=r.substring(0,i);s=g_app.doc.createDocRecord(o,"block sets","folder",{})}t=g_app.doc.createDocRecord(r,a,"block set",{blocks:[]})}var t=new BlockSet;t.init(this.editor,e);this.blockSets[e]=t;return t},getBlockSetOld:function(e){if(e===false){return null}var t=g_app.doc.getDocRecordById(e,"/block sets");if(t!=null){if(this.currentBlockSet==null){this.currentBlockSet=new BlockSet}if(this.currentBlockSet.getId()!=e){this.currentBlockSet.init(this.editor,t.name,t.id)}return this.currentBlockSet}return null}};var BlockSet=function(){this.blockSetId=null;this.name="";this.editor=null;this.defaultWidth=2;this.defaultHeight=2;this.path=""};BlockSet.prototype={init:function(e,t){this.editor=e;this.path=t},getDocRecord:function(){return g_app.doc.getDocRecord(this.path)},createBlock:function(e){var t=[];var i={};i.colorMode="none";i.fc=0;i.bc=0;if(typeof e!="undefined"){if(typeof e.colorMode!="undefined"){i.colorMode=e.colorMode}if(typeof e.fc!="undefined"){i.fc=e.fc}if(typeof e.bc!="undefined"){i.bc=e.bc}if(typeof e.data!="undefined"){t=e.data}}i.data=[];for(var r=0;r<t.length;r++){i.data[r]=[];for(var a=0;a<t[r].length;a++){i.data[r][a]={};for(var s in t[r][a]){i.data[r][a][s]=t[r][a][s]}}}this.docRecord=this.getDocRecord();if(this.docRecord){var o=this.docRecord.data.blocks.length;this.docRecord.data.blocks.push(i);return o}return false},getBlockCount:function(){this.docRecord=this.getDocRecord();if(!this.docRecord){return}return this.docRecord.data.blocks.length},setBlockCount:function(e){if(e<this.docRecord.data.blocks.length){this.docRecord.data.blocks.length=e}},setBlock:function(e,t){this.docRecord=this.getDocRecord();if(!this.docRecord){return}var i=this.docRecord.data.blocks[e];if(typeof t!="undefined"){if(typeof t.colorMode!="undefined"){i.colorMode=t.colorMode}if(typeof t.fc!="undefined"){i.fc=t.fc}if(typeof t.bc!="undefined"){i.bc=t.bc}if(typeof t.data!="undefined"){var r=t.data;i.data=[];for(var a=0;a<r.length;a++){i.data[a]=[];for(var s=0;s<r[a].length;s++){i.data[a][s]={};for(var o in r[a][s]){i.data[a][s][o]=r[a][s][o]}}}}}},setCharacterInBlock:function(e,t,i,r){this.docRecord=this.getDocRecord();if(!this.docRecord){return}var a=this.docRecord.data.blocks[e].data;var s={x:t,y:i,b:e,oldCharacter:a[i][t].t,newCharacter:r};a[i][t].t=r;this.editor.history.addAction("setBlockCell",s)},setBlockDimensions:function(e,t,i){this.docRecord=this.getDocRecord();if(!this.docRecord){return}var r=this.docRecord.data.blocks[e].data;var a=[];var s=this.editor.tileSetManager.blankCharacter;var o=this.editor.currentTile.getColor();var l=this.editor.currentTile.getBGColor();for(var n=0;n<i;n++){a.push([]);for(var h=0;h<t;h++){var d={};if(n<r.length&&h<r[n].length){for(var c in r[n][h]){if(r[n][h].hasOwnProperty(c)){d[c]=r[n][h][c]}}}else{d={t:s,fc:o,bc:l,fh:0,fv:0,rz:0}}a[n].push(d)}}this.docRecord.data.blocks[e].data=a},getCharacterInBlock:function(e,t,i){this.docRecord=this.getDocRecord();if(!this.docRecord){return this.editor.tileSetManager.blankCharacter}if(typeof this.docRecord.data.blocks[e]=="undefined"){return this.editor.tileSetManager.blankCharacter}if(i<this.docRecord.data.blocks[e].data.length&&t<this.docRecord.data.blocks[e].data[i].length){return this.docRecord.data.blocks[e].data[i][t].t}return this.editor.tileSetManager.blankCharacter},getBlockColor:function(e){this.docRecord=this.getDocRecord();if(!this.docRecord||typeof this.docRecord.data.blocks[e]=="undefined"){return 0}return this.docRecord.data.blocks[e].fc},setBlockColor:function(e,t){this.docRecord=this.getDocRecord();if(!this.docRecord||typeof this.docRecord.data.blocks[e]=="undefined"){return 0}this.docRecord.data.blocks[e].fc=t},getBlockBGColor:function(e){this.docRecord=this.getDocRecord();if(!this.docRecord||typeof this.docRecord.data.blocks[e]=="undefined"){return this.editor.colorPaletteManager.noColor}return this.docRecord.data.blocks[e].bc},getBlockData:function(e){this.docRecord=this.getDocRecord();if(!this.docRecord){return[]}if(e<this.docRecord.data.blocks.length){return this.docRecord.data.blocks[e]}return[]},clear:function(){this.docRecord=this.getDocRecord();if(!this.docRecord){return}this.docRecord.data.blocks=[]},getBlocks:function(){this.docRecord=this.getDocRecord();if(!this.docRecord){return[]}return this.docRecord.data.blocks},getWidth:function(){console.error("get block width");return this.defaultWidth},getHeight:function(){console.error("get block height!");return this.defaultHeight},getId:function(){console.error("get block id!");return this.blockSetId}};var BlockEditor=function(){this.editor=null;this.blockWidth=2;this.blockHeight=2;this.canResizeBlock=false;this.tilePaletteDisplay=null;this.highlightCharacter=false;this.selectedCharacter=false;this.tileEditorGrid=null;this.callback=null;this.currentTool="pen";this.colorMode="none";this.c64PixelColor="cell";this.visible=false;this.canvas=null;this.blockEditorTilePaletteCanvas=null};BlockEditor.prototype={init:function(e){this.editor=e},initCharInfoCanvas:function(){if(this.characterCanvas==null){this.characterCanvas=document.getElementById("blockEditorCharInfoCanvas")}var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileWidth();var i=e.getTileHeight();this.characterCanvasScale=Math.floor(UI.devicePixelRatio);this.characterCanvas.width=2*t*this.characterCanvasScale;this.characterCanvas.height=2*i*this.characterCanvasScale;this.characterCanvas.style.width=2*t+"px";this.characterCanvas.style.height=2*i+"px";this.characterContext=this.characterCanvas.getContext("2d");this.characterImageData=this.characterContext.getImageData(0,0,this.characterCanvas.width,this.characterCanvas.height)},htmlComponentLoaded:function(e){this.htmlComponentsLoaded++;if(this.htmlComponentsLoaded==2){this.initContent(e);this.initEvents();this.resizeCharPalette()}},show:function(t){var i=this;this.htmlComponentsLoaded=0;this.callback=null;if(typeof t.callback!=="undefined"){this.callback=t.callback}if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"blockEditor",title:styles.text.blockName+" Editor",width:680,height:500});this.uiComponent.on("close",function(e){i.visible=false});this.uiComponent.on("keydown",function(e){i.keyDown(e)});this.uiComponent.on("keyup",function(e){i.keyUp(e)});this.splitPanel=UI.create("UI.SplitPanel",{id:"blockEditorSplitPanel"});this.uiComponent.add(this.splitPanel);this.uiComponent.on("resize",function(){i.resize()});var e='<div id="blockEditorCharPalette" class="panelFill" style="color: white">';e+='<div id="blockEditorInfoPanel" style="height: 19px; position: absolute; top: 0; left: 0; right: 0; height: 24px">';e+='<canvas style="background-color: rgb(34, 34, 34); border: 1px solid white; width: 16px; height: 16px; cursor: default;" width="32" height="32" id="blockEditorCharInfoCanvas"></canvas>';e+='<span id="blockEditorCharInfo" style="display: inline-block; width: 80px; margin-left: 4px;  overflow: hidden; white-space: nowrap; text-overflow: ellipsis"></span>';e+="</div>";e+='<div id="blockEditorTilePaletteHolder" style="position: absolute; top: 24px; left: 0; right: 0; bottom: 0; overflow: hidden">';e+='<canvas  id="blockEditorTilePalette"></canvas>';e+="</div>";e+="</div>";this.blockEditorCharPalette=UI.create("UI.HTMLPanel",{html:e});this.blockEditorCharPalette.on("resize",function(){i.resizeCharPalette()});this.splitPanel.addSouth(this.blockEditorCharPalette,174);this.blockEditorTools=UI.create("UI.HTMLPanel");this.splitPanel.addWest(this.blockEditorTools,240);this.blockEditorTools.load("html/textMode/blockEditorTools.html",function(){i.c64MulticolorTypeControl=new C64MulticolorTypeControl;i.c64MulticolorTypeControl.init(i.editor,{elementId:"blockEditorC64PixelColors"});i.htmlComponentLoaded(t)});this.blockEditor=UI.create("UI.HTMLPanel");this.splitPanel.add(this.blockEditor);this.blockEditor.load("html/textMode/blockEditor.html",function(){i.htmlComponentLoaded(t)});this.blockEditor.on("resize",function(){i.resize()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){if(i.callback){i.callback(t,{data:i.tileEditorGrid.getCells(),colorMode:i.colorMode,fc:i.fgColor,bc:i.bgColor})}UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent(t)}UI.showDialog("blockEditor");this.resize();this.resizeCharPalette();this.visible=true},resizeCharPalette:function(){if(this.blockEditorTilePaletteCanvas==null){this.blockEditorTilePaletteCanvas=document.getElementById("blockEditorTilePalette")}var e=$("#blockEditorTilePaletteHolder");this.width=e.width();this.height=e.height();if(this.width!=this.blockEditorTilePaletteCanvas.style.width||this.height!=this.blockEditorTilePaletteCanvas.style.height){if(this.width!=0&&this.height!=0){this.blockEditorTilePaletteCanvas.style.width=this.width+"px";this.blockEditorTilePaletteCanvas.style.height=this.height+"px";this.blockEditorTilePaletteCanvas.width=this.width*UI.devicePixelRatio;this.blockEditorTilePaletteCanvas.height=this.height*UI.devicePixelRatio}}if(this.tilePaletteDisplay!=null){this.tilePaletteDisplay.draw()}},resize:function(){if(this.canvas==null){this.canvas=document.getElementById("blockEditorBlock")}var e=$("#blockEditorBlockHolder");var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}var i=this.blockWidth;var r=this.blockHeight;var a=this.width-20;var s=this.height-20;if(i>r){s=Math.ceil(r*(a/i))}if(this.tileEditorGrid!=null){this.tileEditorGrid.setSize(a,s)}$("#blockEditorBlock").css("top","0px");$("#blockEditorBlock").css("left","0px")},setHighlightCharacter:function(e){this.tilePaletteDisplay.setHighlightCharacter(e);this.setCharacterInfo(e)},setCharacterInfo:function(e){if(e===false){return}var t=this.editor.layers.getSelectedLayerObject();var i=("00"+e.toString(16)).substr(-2);var r="";r+=e+" (0x"+i+")";$("#blockEditorCharInfo").html(r);var a=2*this.characterCanvasScale;var s=this.editor.tileSetManager.getCurrentTileSet();var o=parseInt(e);if(isNaN(o)){return}s.drawCharacter({character:o,x:0,y:0,scale:a,imageData:this.characterImageData,colorRGB:14540253,bgColorRGB:1118481,context:this.characterContext});if(t&&t.getMode()!=TextModeEditor.Mode.VECTOR){this.characterContext.putImageData(this.characterImageData,0,0)}},setBlockDimensions:function(e,t){this.blockWidth=e;this.blockHeight=t},initContent:function(e){var t=this;if(!this.tileEditorGrid){this.tileEditorGrid=new TileEditorGrid;this.tileEditorGrid.drawPixelLines=false;this.tileEditorGrid.init(this.editor,{canvasElementId:"blockEditorBlock",useCells:true});this.tileEditorGrid.setMode("characterEdit");this.tileEditorGrid.on("cellselected",function(e){t.selectCharacter(e.t)});this.tileEditorGrid.on("mouseOverCharacter",function(e){t.setHighlightCharacter(e)});this.tileEditorGrid.on("mouseenter",function(e){t.gridMouseEnter(e)});this.tileEditorGrid.on("mouseleave",function(e){t.gridMouseLeave(e)})}if(!this.tilePaletteDisplay){this.tilePaletteDisplay=new TilePaletteDisplay;this.tilePaletteDisplay.init(this.editor,{mode:"single",canvasElementId:"blockEditorTilePalette"});this.tilePaletteDisplay.on("characterselected",function(e){t.setHighlightCharacter(e);t.mouseDownCharacter=e;t.selectedCharacter=e;t.tileEditorGrid.setDrawCharacter(t.selectedCharacter)});this.tilePaletteDisplay.on("highlightchanged",function(e){if(e!==false){t.setHighlightCharacter(e)}});this.tilePaletteDisplay.on("mouseleave",function(e){t.setHighlightCharacter(t.selectedCharacter)});this.editor.tools.drawTools.pixelDraw.initC64MulticolorControl()}this.tilePaletteDisplay.draw({redrawTiles:true});var i=this.editor.getColorPerMode();var r="none";if(i=="character"){$("#blockEditorColorOptions").hide();$("#blockEditorColorSelection").hide();r="none"}else if(i=="block"){$("#blockEditorColorOptions").hide();$("#blockEditorColorSelection").show();r="perblock"}else{$("#blockEditorColorOptions").show();$("#blockEditorColorSelection").show();r=$("input[name=blockEditColorSetting]:checked").val();if(typeof e!="undefined"&&typeof e.blockData!="undefined"&&typeof e.blockData.colorMode!="undefined"){r=e.blockData.colorMode}}var a=this.editor.tools.drawTools.tilePalette.getTilePaletteMapType();this.tilePaletteDisplay.initCharPalette({mapType:a});this.tilePaletteDisplay.draw();this.canResizeBlock=false;var s=this.editor.tileSetManager.blankCharacter;if(typeof e.blockWidth!="undefined"){this.blockWidth=e.blockWidth}if(typeof e.blockHeight!="undefined"){this.blockHeight=e.blockHeight}var o=this.editor.currentTile.getColor();var l=this.editor.currentTile.getBGColor();var n=false;var h=this.editor.layers.getSelectedLayerObject();if(h&&h.getType()=="grid"){n=h.getBlockModeEnabled()}if(n){this.canResizeBlock=false;this.blockWidth=h.getBlockWidth();this.blockHeight=h.getBlockHeight();$("#blockDimensionsStatic").show();$("#blockDimensionsEditable").hide()}else{this.canResizeBlock=true;$("#blockDimensionsStatic").hide();$("#blockDimensionsEditable").show()}$("#blockEditorHeight").val(this.blockHeight);$("#blockEditorWidth").val(this.blockWidth);$("#blockEditorStaticWidth").html(this.blockWidth);$("#blockEditorStaticHeight").html(this.blockHeight);if(typeof e.blockData!="undefined"){this.tileEditorGrid.setCells(e.blockData.data);o=e.blockData.fc;l=e.blockData.bc;this.blockHeight=e.blockData.data.length;this.blockWidth=e.blockData.data[0].length}else{var d=[];for(var c=0;c<this.blockHeight;c++){d.push([]);for(var f=0;f<this.blockWidth;f++){d[c].push({t:s,fc:o,bc:l,fh:0,fv:0,rz:0})}}this.tileEditorGrid.setCells(d)}this.colorMode=r;$("#blockEditColorSetting_"+r).prop("checked",true);this.setFGColor(o);this.setBGColor(l);var u=this.editor.getScreenMode();if(u==TextModeEditor.Mode.C64MULTICOLOR||u==TextModeEditor.Mode.C64STANDARD){$("#blockEditBackgroundColor").hide()}if(u===TextModeEditor.Mode.TEXTMODE||u===TextModeEditor.Mode.C64ECM){$("#blockEditBackgroundColor").show()}this.initCharInfoCanvas();this.setTool("pen");var p=this.tilePaletteDisplay.getSelectedCharacters();if(p.length==0){this.selectCharacter(0)}this.resize()},initEvents:function(e){var a=this;$("#blockEditForegroundColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.setFGColor(e)};t.type="cellcolor";var i=e.pageX;var r=e.pageY;a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("#blockEditBackgroundColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.setBGColor(e)};t.c64ECMColorSetCallback=function(e,t){a.editor.setC64ECMColor(e,t);var i=a.editor.colorPaletteManager.getCurrentColorPalette();$("#blockEditBackgroundColor").html("");$("#blockEditBackgroundColor").css("background-color","#"+i.getHexString(t));$("#blockEditBackgroundColor").css("background-image","none")};t.isCellBG=true;t.screenMode=a.editor.getScreenMode();var i=e.pageX;var r=e.pageY;a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("#blockEditorWidth").on("change",function(){var e=parseInt($("#blockEditorWidth").val(),10);if(!isNaN(e)){a.setBlockWidth(e)}});$("#blockEditorHeight").on("change",function(){var e=parseInt($("#blockEditorHeight").val(),10);if(!isNaN(e)){a.setBlockHeight(e)}});$(".blockEditTool").on("click",function(e){var t=$(this).attr("id");var i=t.lastIndexOf("_");t=t.substring(i+1);a.setTool(t,e)});$(".blockEditTool").on("mouseover",function(){var e=$(this).attr("id");e=e.substring("blockEditTool_".length);var t=a.getToolLabel(e);$("#currentBlockEditTool").html(t)});$(".blockEditTool").on("mouseleave",function(){var e=a.getToolLabel(a.currentTool);$("#currentBlockEditTool").html(e)});$("input[name=blockEditColorSetting").on("click",function(){var e=$("input[name=blockEditColorSetting]:checked").val();a.setColorMode(e)});$("#blockEditorMulticolorPixelColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){a.selectColorIndex(e);a.editor.currentTile.setColor(e)};var i=e.pageX;var r=e.pageY;t.currentColor=a.editor.currentTile.getColor();a.editor.colorPaletteManager.showColorPicker(i,r,t)})},selectColorIndex:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();$("#blockEditorMulticolorPixelColor").css("background-color","#"+t.getHexString(e));if(this.tileEditorGrid){this.tileEditorGrid.setColorIndex(e)}},gridMouseEnter:function(e){this.mouseInGrid=true;this.setMouseCursor(e)},gridMouseLeave:function(e){this.mouseInGrid=false;this.setMouseCursor(e);UI.setCursor("default")},setMouseCursor:function(e){if(this.mouseInGrid){if(e.altKey){UI.setCursor("eyedropper");return}switch(this.currentTool){case"pen":UI.setCursor("draw");break;case"erase":UI.setCursor("erase");break;case"eyedropper":UI.setCursor("eyedropper");break;case"pixel":UI.setCursor("crosshair");break;case"select":UI.setCursor("select");break}}},keyDown:function(e){var t=e.keyCode;var i=String.fromCharCode(t).toUpperCase();switch(i){case keys.textMode.toolsPencil.key:this.setTool("pen",e);break;case keys.textMode.toolsEyedropper.key:this.setTool("eyedropper",e);break;case keys.textMode.toolsPixel.key:this.setTool("pixel",e);break}switch(e.keyCode){case keys.textMode.tilePaletteLeft.keyCode:if(keys.textMode.tilePaletteLeft.shift==e.shiftKey){this.tilePaletteDisplay.moveSelection(-1,0)}break;case keys.textMode.tilePaletteRight.keyCode:if(keys.textMode.tilePaletteRight.shift==e.shiftKey){this.tilePaletteDisplay.moveSelection(1,0)}break;case keys.textMode.tilePaletteUp.keyCode:if(keys.textMode.tilePaletteRight.shift==e.shiftKey){this.tilePaletteDisplay.moveSelection(0,-1)}break;case keys.textMode.tilePaletteDown.keyCode:if(keys.textMode.tilePaletteDown.shift==e.shiftKey){this.tilePaletteDisplay.moveSelection(0,1)}break;case keys.textMode.characterRecentNext.keyCode:if(keys.textMode.characterRecentNext.shift==e.shiftKey){}break;case keys.textMode.characterRecentPrev.keyCode:if(keys.textMode.characterRecentPrev.shift==e.shiftKey){}break;case keys.textMode.characterRotate.keyCode:this.rotateCharacter();break}if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR){switch(i){case keys.textMode.c64MultiFG.key:this.editor.tools.drawTools.pixelDraw.setC64MultiColorType("cell");break;case keys.textMode.c64MultiBG.key:this.editor.tools.drawTools.pixelDraw.setC64MultiColorType("background");break;case keys.textMode.c64MultiMC1.key:this.editor.tools.drawTools.pixelDraw.setC64MultiColorType("multi1");break;case keys.textMode.c64MultiMC2.key:this.editor.tools.drawTools.pixelDraw.setC64MultiColorType("multi2");break}}this.setMouseCursor(e)},selectCharacter:function(e){this.tilePaletteDisplay.setSelected([e]);if(this.tileEditorGrid){this.tileEditorGrid.setDrawCharacter(e)}},rotateCharacter:function(){var e=this.tilePaletteDisplay.drawCharacter;if(e===false){return}var t=this.editor.tileSetManager.getCurrentTileSet();var e=t.getCharNextRotation(e);if(e!==false){this.selectCharacter(e)}this.draw()},keyUp:function(e){this.setMouseCursor(e)},setFGColor:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();this.fgColor=e;if(this.tileEditorGrid){if(this.colorMode=="none"||this.colorMode=="perblock"){this.tileEditorGrid.setCellColors(e)}this.tileEditorGrid.setDrawColor(e)}if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){if(e>8){e=e-8}}$("#blockEditForegroundColor").css("background-color","#"+t.getHexString(e));this.tilePaletteDisplay.draw()},setBGColor:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();this.bgColor=e;var i=e;var r=this.editor.layers.getSelectedLayerObject();if(r){if(r.getScreenMode()==TextModeEditor.Mode.C64ECM){i=r.getC64ECMColor(e)}if(r.getScreenMode()==TextModeEditor.Mode.C64STANDARD){i=this.editor.colorPaletteManager.noColor}}if(e!==this.editor.colorPaletteManager.noColor){$("#blockEditBackgroundColor").html("");$("#blockEditBackgroundColor").css("background-color","#"+t.getHexString(i));$("#blockEditBackgroundColor").css("background-image","none")}else{$("#blockEditBackgroundColor").css("background-color","#000000");$("#blockEditBackgroundColor").html('<i style="font-size: 28px; margin-top: -1px" class="halflings halflings-remove"></i>')}if(this.tileEditorGrid){if(this.colorMode=="none"||this.colorMode=="perblock"){this.tileEditorGrid.setCellBGColors(e)}this.tileEditorGrid.setDrawBGColor(e)}},setColorMode:function(e){this.colorMode=e;if(this.colorMode=="none"||this.colorMode=="perblock"){if(this.tileEditorGrid){this.tileEditorGrid.setCellColors(this.fgColor);this.tileEditorGrid.setCellBGColors(this.bgColor)}}},selectC64ColorType:function(e,t){this.c64PixelColor=e;if(this.tileEditorGrid){this.tileEditorGrid.setC64ColorType(e);this.tileEditorGrid.setColorIndex(t)}},getToolLabel:function(e){var t=e;t=this.editor.tools.drawTools.getToolLabel(e);return t},setBlockWidth:function(e){if(!this.tileEditorGrid){return}var t=this.tileEditorGrid.getCells();var i=[];var r=this.editor.tileSetManager.blankCharacter;var a=this.editor.currentTile.getColor();var s=this.editor.currentTile.getBGColor();for(var o=0;o<t.length;o++){i.push([]);for(var l=0;l<e;l++){var n={};if(l<t[o].length){for(var h in t[o][l]){if(t[o][l].hasOwnProperty(h)){n[h]=t[o][l][h]}}}else{n={t:r,fc:a,bc:s,fh:0,fv:0,rz:0}}i[o].push(n)}}this.tileEditorGrid.setCells(i)},setBlockHeight:function(e){if(!this.tileEditorGrid){return}var t=this.tileEditorGrid.getCells();var i=[];var r=this.editor.tileSetManager.blankCharacter;var a=this.editor.currentTile.getColor();var s=this.editor.currentTile.getBGColor();var o=t[0].length;for(var l=0;l<e;l++){i.push([]);for(var n=0;n<o;n++){if(l<t.length){var h={};for(var d in t[l][n]){if(t[l][n].hasOwnProperty(d)){h[d]=t[l][n][d]}}}else{h={t:r,fc:a,bc:s,fh:0,fv:0,rz:0}}i[l].push(h)}}this.tileEditorGrid.setCells(i)},setTool:function(e,t){this.currentTool=e;$(".blockEditTool").removeClass("blockEditToolSelected");$("#blockEditTool_"+e).addClass("blockEditToolSelected");var i=this.getToolLabel(this.currentTool);$("#currentBlockEditTool").html(i);var r=this.editor.getScreenMode();var a=false;switch(e){case"pen":this.tileEditorGrid.setMode("characterEdit");if(r!=TextModeEditor.Mode.INDEXED&&r!=TextModeEditor.Mode.RGB){a=true}$("#blockPixelEditColor").hide();break;case"eyedropper":a=true;this.tileEditorGrid.setMode("characterEyedropper");$("#blockPixelEditColor").hide();break;case"pixel":a=false;this.tileEditorGrid.setMode("pixelEdit");break}if(r==TextModeEditor.Mode.INDEXED||r==TextModeEditor.Mode.RGB){a=false}var s=this.editor.getColorPerMode();var o="none";if(s=="character"){a=false}if(s=="block"){a=true}if(a){$("#blockEditorColorSelection").show()}else{$("#blockEditorColorSelection").hide()}if(e=="pixel"){if(r==TextModeEditor.Mode.C64MULTICOLOR){$("#blockPixelEditColor").hide();$("#blockEditorC64PixelColors").show();$("#blockPixelEditColor").show()}else if(r==TextModeEditor.Mode.INDEXED||r==TextModeEditor.Mode.RGB){$("#blockPixelEditColor").show();$("#blockEditorC64PixelColors").hide();$("#blockPixelEditColor").show()}else{$("#blockEditorC64PixelColors").hide();$("#blockPixelEditColor").hide()}}this.setMouseCursor(t)},draw:function(){this.tileEditorGrid.draw()}};var ColorPalettePresets=[{category:"2 Colour",colorPalettes:[{name:"Commodore PET",id:"commodorepet"},{name:"Terminal",id:"terminalbw",options:[{name:"Black and White",id:"terminalbw"},{name:"Black and Green",id:"terminalbg"},{name:"Black and Orange",id:"terminalbo"}]}]},{category:"4 Colour",colorPalettes:[{name:"Gameboy",id:"gameboy",options:[{name:"Original",id:"gameboy"},{name:"Pocket",id:"gameboypocketa"},{name:"Printer",id:"gameboyprinter"}]},{name:"CGA Palette",id:"cga0_hi",options:[{name:"Palette 0 (High)",id:"cga0_hi"},{name:"Palette 1 (High)",id:"cga1_hi"},{name:"Palette 2 (High)",id:"cga2_hi"}]}]},{category:"8 Colour",colorPalettes:[{name:"Teletext",id:"teletext",description:"3-bit RGB Palette"},{name:"Sharp MZ-700",id:"sharpmz700"}]},{category:"10 Colour",colorPalettes:[{name:"LTRO-1",id:"ltro-1",author:"skeddles"}]},{category:"12 Colour",colorPalettes:[{name:"Japanese Woodblock",id:"japanesewoodblock",author:"Polyducks"}]},{category:"16 Colour",colorPalettes:[{name:"ANSI VGA",id:"ansi"},{name:"Apple II",id:"appleII",description:"The Apple II series features a 16-color composite video palette, based on the YIQ color space used by the NTSC color TV system. Colors 5 and 10 (gray) are indistinguishable on original hardware"},{name:"Commodore 64",id:"c64_colodore",options:[{name:"Colodore",id:"c64_colodore"},{name:"Pepto",id:"c64_pepto"},{name:"VICE",id:"c64_vice"}]},{name:"Commodore VIC 20",id:"vic20"},{name:"IBM CGA",id:"cga"},{name:"PICO-8",id:"pico8"},{name:"ZX Spectrum",id:"spectrum"}]},{category:"27 Colour",colorPalettes:[{name:"Amstrad CPC",id:"amstradcpc",description:"The 3-level (not bits) RGB uses three level for every red, green and blue color components, resulting in a 33 = 27 colours palette."}]},{category:"52 Colour",colorPalettes:[{name:"NES",id:"nes"}]},{category:"64 Colour",colorPalettes:[{name:"Sega Master System",id:"sms"},{name:"IBM EGA",id:"ega"}]},{category:"128 Colour",colorPalettes:[{name:"Atari 2600",id:"atari2600_ntsc",options:[{name:"Atari 2600 NTSC",id:"atari2600_ntsc"},{name:"Atari 2600 PAL",id:"atari2600_pal"}]},{name:"Commodore 16 / Plus 4",id:"commodore16"}]},{category:"256 Color",colorPalettes:[{name:"VGA Default",id:"vga"}]}];var ColorPaletteCustomPresets=[{category:"12 Colour",colorPalettes:[{name:"Japanese Woodblock",id:"japanesewoodblock",author:"Polyducks"}]},{category:"16 Colour",colorPalettes:[{name:"Dots",id:"custom-dots"},{name:"Seventy Sixteen",id:"custom-seventy"},{name:"Seaside",id:"custom-seaside"}]}];var ColorPaletteManager=function(){this.editor=null;this.currentColorPalette=null;this.colorPaletteChoosePreset=null;this.colorPaletteChoosePresetMobile=null;this.colorPaletteSave=null;this.colorPaletteLoad=null;this.defaultColors=[0,16777215,6829867,7382194,7290246,5803331,3483769,12109679,7294757,4405504,10119001,4473924,7105644,10146436,7102133,9803157];this.colorPicker=null;this.colorPickerMobile=null;this.colorSubPalettes=null;this.canvas=null;this.colorPalettes=[];this.colorPaletteCache={};this.noColor=-1;this.colorLimit=256};ColorPaletteManager.prototype={init:function(e){this.editor=e;this.colorSubPalettes=new ColorSubPalettes;this.colorSubPalettes.init(e)},clear:function(){this.colorPaletteCache=[]},showNewColorPaletteDialog:function(){var t=this;if(this.newColorPaletteDialog==null){var e=320;var i=296;this.newColorPaletteDialog=UI.create("UI.Dialog",{id:"newColorPaletteDialog",title:"New Color Palette",width:e,height:i});this.newColorPaletteHTML=UI.create("UI.HTMLPanel");this.newColorPaletteDialog.add(this.newColorPaletteHTML);this.newColorPaletteHTML.load("html/textMode/newColorPalette.html",function(){t.initNewColorPaletteDialogContent()});var r=UI.create("UI.Button",{text:"OK",color:"primary"});r.on("click",function(e){t.newColorPaletteSubmit();UI.closeDialog()});var a=UI.create("UI.Button",{text:"Cancel",color:"secondary"});a.on("click",function(e){UI.closeDialog()});this.newColorPaletteDialog.addButton(r);this.newColorPaletteDialog.addButton(a);UI.showDialog("newColorPaletteDialog")}else{UI.showDialog("newColorPaletteDialog");this.initNewColorPaletteDialogContent()}},initNewColorPaletteDialogContent:function(){$("#newColorPaletteName").val("Colour Palette");$("#newColorPaletteName").focus();$("#newColorPaletteName").select()},newColorPaletteSubmit:function(){var e=$("#newColorPaletteName").val();var t=2;var i=this.createColorPalette({name:e});this.selectColorPalette(i);g_app.projectNavigator.reloadTreeBranch("/color palettes");g_app.projectNavigator.treeRoot.refreshChildren()},updateColorPaletteMenu:function(){var e=g_app.colorPaletteMenu;var t=this.editor.layers.getSelectedLayerObject();if(t==null||t.getType()!="grid"){return}var i=t.getColorPalette();var r=e.getItems();var a=g_app.doc.dir("/color palettes");for(var s=0;s<a.length;s++){if(true){var o=a[s].name;var l=a[s].id;var n="colorpalette-select-"+l;var h=e.getItem(n);if(h){h.setLabel(o)}else{h=e.addItem({label:o,id:n})}if(l==i.getId()){h.setChecked(true)}else{h.setChecked(false)}}}},selectColorPalette:function(e){var t=this.editor.layers.getSelectedLayerObject();if(t!=null&&t.getType()=="grid"){t.setColorPalette(e);this.editor.graphic.redraw({allCells:true})}this.updateColorPaletteMenu();this.setCurrentColorPaletteFromId(e)},getCurrentColorPaletteId:function(){if(!this.currentColorPalette){return false}return this.currentColorPalette.colorPaletteId},createColorPalette:function(e){var t="colour palette";if(typeof e.name!="undefined"){t=e.name}var i=false;if(typeof e.id!=="undefined"){i=e.id}var r=t;var a=0;while(g_app.doc.getDocRecord("/color palettes/"+r)){a++;r=t+"_"+a}t=r;var s=g_app.doc.createDocRecord("/color palettes",t,"color palette",{},i);return s.id},syncColorPickers:function(){deprecated("syncColorPickers");return},reset:function(){for(var e=0;e<this.colorPalettes.length;e++){this.colorPalettes[e].clear()}this.colorPalettes=[];this.colorPaletteCache={}},getColorPalette:function(e){if(this.colorPaletteCache.hasOwnProperty(e)){return this.colorPaletteCache[e]}var t=g_app.doc.getDocRecordById(e,"/color palettes");var i=null;if(t){var i=new ColorPalette;i.init(this.editor,t.name,e);i.setColorsFromDoc();this.colorPaletteCache[e]=i}return i},addColorPaletteToDoc:function(e,t){if(typeof e.colorPaletteId!="undefined"&&e.colorPaletteId!=""){if(typeof t!="undefined"){t(e.colorPaletteId)}return}if(typeof e.preset!="undefined"&&e.preset!==false){this.addColorPaletteFromPreset(e,t);return}var i="Colour Palette";if(typeof e.colorPaletteName!="undefined"){i=e.colorPaletteName}var r=this.createColorPalette({name:i});colorPalette=new ColorPalette;colorPalette.init(this.editor,i,r);if(typeof e.colorPalette!="undefined"){colorPalette.copyPalette(e.colorPalette)}this.colorPaletteCache[r]=colorPalette;t(r)},addColorPaletteFromPreset:function(e,t){var i=e.preset;var r="Colour Palette";if(typeof e.colorPaletteName!="undefined"){r=e.colorPaletteName}var a=this.createColorPalette({name:r});colorPalette=new ColorPalette;colorPalette.init(this.editor,i,a);this.colorPaletteCache[a]=colorPalette;this.choosePreset(i,{colorPalette:colorPalette,callback:function(){t(a)}})},usePresetColorPalette:function(e,t){var i=this.currentColorPalette;if(i==null){var r=this.createColorPalette({name:e});i=new ColorPalette;i.init(this.editor,e,r);this.currentColorPalette=i;this.colorPaletteCache[r]=i}this.choosePreset(e,{callback:t})},showColorSubPalettePicker:function(e,t,i){this.colorSubPalettes.closePicker();this.colorSubPalettes.showPicker(e,t,i)},showColorPickerMobile:function(e){if(this.colorPickerMobile==null){this.colorPickerMobile=new ColorPickerMobile;this.colorPickerMobile.init(this.editor)}this.colorPickerMobile.show(e)},showColorPicker:function(e,t,i){if(this.colorPicker==null){this.colorPicker=new ColorPickerPopup;this.colorPicker.init(this.editor)}this.colorPicker.close();this.colorPicker.show(e,t,i)},closeColorPicker:function(){if(this.colorPicker){this.colorPicker.close()}},setCurrentColorPaletteFromId:function(e){if(this.currentColorPalette!==null&&this.currentColorPalette.getId()==e){return}this.currentColorPalette=this.getColorPalette(e);this.colorPaletteUpdated()},getCurrentColorPalette:function(){return this.currentColorPalette},getBorderColor:function(){return this.borderColor},showChoosePreset:function(e){var i=this;e.callback=function(e,t){i.choosePreset(e,t)};if(g_app.isMobile()){if(this.colorPaletteChoosePresetMobile==null){this.colorPaletteChoosePresetMobile=new ColorPaletteChoosePresetMobile;this.colorPaletteChoosePresetMobile.init(this.editor)}this.colorPaletteChoosePresetMobile.show(e)}else{var t=this.getChoosePresetDialog();t.show(e)}},getChoosePresetDialog:function(){if(this.colorPaletteChoosePreset==null){this.colorPaletteChoosePreset=new ColorPaletteChoosePreset;this.colorPaletteChoosePreset.init(this.editor)}return this.colorPaletteChoosePreset},choosePreset:function(e,a){var s=this;var t="palettes/"+e+".png";if(t!==false){var o=new Image;o.onload=function(){var e=s.colorPaletteFromPaletteImg(o,a);var t=Math.floor(o.naturalWidth/8);var i=Math.floor(o.naturalHeight/8);var r=null;if(typeof a!="undefined"&&typeof a.colorPalette!="undefined"){r=a.colorPalette}else{r=s.getCurrentColorPalette()}r.setColors(e.colors,t,i);if(r.name.indexOf("c64")!=-1){r.setIsC64Palette(true)}r.setSortOrderMethod("default");if(typeof a!="undefined"&&typeof a.callback!=="undefined"&&a.callback!=null){a.callback()}};o.src=t}},getColorPaletteLoader:function(){if(this.colorPaletteLoad==null){this.colorPaletteLoad=new ColorPaletteLoad;this.colorPaletteLoad.init(this.editor)}return this.colorPaletteLoad},showLoad:function(e){e.tab="load";this.showChoosePreset(e)},showSave:function(e){if(this.colorPaletteSave==null){this.colorPaletteSave=new ColorPaletteSave;this.colorPaletteSave.init(this.editor)}this.colorPaletteSave.show(e)},colorPaletteFromPaletteImg:function(e,t){var i=false;var r=0;var a=0;var s=0;var o="internal";if(typeof t!="undefined"){if(typeof t.brightness!="undefined"){r=t.brightness}if(typeof t.saturation!="undefined"){a=t.saturation}if(typeof t.contrast!="undefined"){s=t.contrast}if(typeof t.format!="undefined"){o=t.format}}if(!this.canvas){this.canvas=document.createElement("canvas")}this.canvas.width=e.naturalWidth;this.canvas.height=e.naturalHeight;var l=this.canvas.getContext("2d");l.drawImage(e,0,0);var n=l.getImageData(0,0,this.canvas.width,this.canvas.height);if(r!=0){ImageUtils.adjustBrightness(n,r)}if(a!=0){ImageUtils.adjustSaturation(n,a)}if(s!=0){ImageUtils.adjustContrast(n,s)}var h=[];var d={};var c=0;for(var f=0;f<this.canvas.height;f++){for(var u=0;u<this.canvas.width;u+=8){for(var p=u;p<u+8;p++){var v=(f*this.canvas.width+p)*4;var g=n.data[v];var m=n.data[v+1];var y=n.data[v+2];var b=n.data[v+3];var C=(b<<24)+(g<<16)+(m<<8)+y;C=C>>>0;if(p!=u){if(C!=c){o="png";u=this.canvas.width;f=this.canvas.height;break}}c=C}}}var x=1;var S=1;if(o=="internal"){x=8;S=8;i=[]}var P=0;var w=0;for(var f=0;f<this.canvas.height;f+=S){if(i!==false){i[P]=[];w=0}for(var u=0;u<this.canvas.width;u+=x){if(i!==false){i[P][w]=this.editor.colorPaletteManager.noColor}var v=(f*this.canvas.width+u)*4;var g=n.data[v];var m=n.data[v+1];var y=n.data[v+2];var b=n.data[v+3];var C=(b<<24)+(g<<16)+(m<<8)+y;C=C>>>0;if(o=="internal"||!d.hasOwnProperty(C)){d[C]=true;if(o=="internal"){if(b!==0){var I=h.length;i[P][w]=I;h.push(C)}}else{h.push(C)}if(h.length>this.colorLimit){f=this.canvas.height;u=this.canvas.width;break}}else{}w++}P++}if(h.length>this.colorLimit){var k=ImageUtils.createColorPaletteFromImage(this.colorLimit,e);h=[];for(var M=0;M<k.length;M+=4){var b=255;var C=(b<<24)+(k[M]<<16)+(k[M+1]<<8)+k[M+2];h.push(C)}}if(o=="internal"){colorsAcross=Math.floor(e.naturalWidth/8)}else{if(h.length<=8){colorsAcross=4}else if(h.length<=16){colorsAcross=8}else{colorsAcross=16}}if(colorsAcross>h.length){colorsAcross=h.length}return{colors:h,colorsAcross:colorsAcross,map:i}},colorPaletteUpdated:function(){this.editor.colorPalettePanel.colorPaletteUpdate();var e=this.getCurrentColorPalette();if(!e){return}var t=this.editor.currentTile.getColor();if(t>=e.getColorCount()){t=1}this.editor.currentTile.setColor(t,{force:true,update:false});t=this.editor.currentTile.getBGColor();if(t!=this.noColor){if(t>=e.getColorCount()){t=0}}this.editor.currentTile.setBGColor(t,{force:true,update:false})},sortColors:function(e,t){var i="hue";if(typeof t!="undefined"&&typeof t.sortMethod!="undefined"){i=t.sortMethod}if(i=="source"||i=="default"){var r=[];for(var a=0;a<e.length;a++){r.push(a)}return r}var s=[];for(var a=0;a<e.length;a++){var o={};o.index=a;o.a=e[a]>>>24&255;o.r=e[a]>>>16&255;o.g=e[a]>>>8&255;o.b=e[a]>>>0&255;var l={};l.values=[o.r,o.g,o.b,o.a];o.hsv=Colour.converters[Colour.RGBA][Colour.HSVA](l);o.laba=Colour.converters[Colour.RGBA][Colour.LABA](l);o.hsl=this.rgb2hsl(o.r,o.g,o.b);s.push(o)}var n=16;var h=this;switch(i){case"hls":var h=this;s.sort(function(e,t){var i=e.r==e.g&&e.g==e.b?-1:h.hueGroup(e.hsl.h,n);var r=t.r==t.g&&t.g==t.b?-1:h.hueGroup(t.hsl.h,n);var a=r-i;if(a)return-a;var s=h.lumGroup(+t.hsl.l.toFixed(2))-h.lumGroup(+e.hsl.l.toFixed(2));if(s)return-s;var o=h.satGroup(+t.hsl.s.toFixed(2))-h.satGroup(+e.hsl.s.toFixed(2));if(o)return-o});break;case"hue":s.sort(function(e,t){var i=0;var i=e.hsv.values[0]-t.hsv.values[0];if(i>.1||i<.1){return i}i=e.hsv.values[1]-t.hsv.values[1];if(i>.1||i<-.1){return i}i=e.hsv.values[2]-t.hsv.values[2];return i});case"red":s.sort(function(e,t){var i=h.distEuclidean([255,0,0],[e.r,e.g,e.b]);var r=h.distEuclidean([255,0,0],[t.r,t.g,t.b]);return i-r});break;case"green":s.sort(function(e,t){var i=h.distEuclidean([0,255,0],[e.r,e.g,e.b]);var r=h.distEuclidean([0,255,0],[t.r,t.g,t.b]);return i-r});break;case"blue":s.sort(function(e,t){var i=h.distEuclidean([0,0,255],[e.r,e.g,e.b]);var r=h.distEuclidean([0,0,255],[t.r,t.g,t.b]);return i-r});break;break}var r=[];for(var a=0;a<s.length;a++){r.push(s[a].index)}return r},rgb2hsl:function(e,t,i){var r,a,s,o,l,n;e/=255;t/=255;i/=255;r=Math.max(e,t,i);a=Math.min(e,t,i);l=(r+a)/2;if(r==a){s=o=0}else{n=r-a;o=l>.5?n/(2-r-a):n/(r+a);switch(r){case e:s=(t-i)/n+(t<i?6:0);break;case t:s=(i-e)/n+2;break;case i:s=(e-t)/n+4;break}s/=6}return{h:s,s:o,l:this.rgb2lum(e,t,i)}},rgb2lum:function(e,t,i){var r=.2126,a=.7152,s=.0722;return Math.sqrt(r*e*e+a*t*t+s*i*i)},distEuclidean:function(e,t){var i=.2126,r=.7152,a=.0722;var s=255,o=255,l=255;var n=Math.sqrt(i*s*s+r*o*o+a*l*l);var s=t[0]-e[0],o=t[1]-e[1],l=t[2]-e[2];return Math.sqrt(i*s*s+r*o*o+a*l*l)/n},distManhattan:function(e,t){var i=.2126,r=.7152,a=.0722;var s=255,o=255,l=255;var n=i*s+r*o+a*l;var s=Math.abs(t[0]-e[0]),o=Math.abs(t[1]-e[1]),l=Math.abs(t[2]-e[2]);return(i*s+r*o+a*l)/n},hueGroup:function(e,t){var i=1/t,r=i/2;if(e>=1-r||e<=r)return 0;for(var a=1;a<t;a++){var s=a*i;if(e>=s-r&&e<=s+r)return a}},satGroup:function(e){return e},lumGroup:function(e){return e}};var ColorPaletteChoosePreset=function(){this.editor=null;this.uiComponent=null;this.previewColorPalette=null;this.img=null;this.paletteCanvas=null;this.colorPaletteSampleImage=null;this.sampleImageCanvas=null;this.sampleImageContext=null;this.brightness=0;this.contrast=0;this.saturation=0;this.colorPaletteDisplay=null;this.setColorPalette=false;this.callback=false;this.previewColorPaletteId=false;this.previewColorPaletteDescription="";this.activeTab="system";this.colorPalettes=[];this.visible=false;this.colorPaletteLoad=null};ColorPaletteChoosePreset.prototype={init:function(e){this.editor=e},setupSampleImage:function(e){this.colorPaletteSampleImage=new Image;this.colorPaletteSampleImage.onload=e;this.colorPaletteSampleImage.src="images/color_palette_sample.png"},show:function(e){var r=this;this.visible=true;this.setColorPalette=true;this.callback=false;this.createOnLoad=false;if(typeof e!="undefined"){if(typeof e.setColorPalette!="undefined"){this.setColorPalette=e.setColorPalette}if(typeof e.callback!="undefined"){this.callback=e.callback}if(typeof e.createOnLoad!="undefined"){this.createOnLoad=e.createOnLoad}}if(this.uiComponent==null){var t=636;var i=646;this.uiComponent=UI.create("UI.Dialog",{id:"colorPaletteChoosePresetDialog",title:"Choose A Colour Palette",width:t,height:i});this.splitPanel=UI.create("UI.SplitPanel");this.tabPanel=UI.create("UI.TabPanel",{canCloseTabs:false});this.tabPanel.addTab({key:"system",title:"System Palettes",isTemp:false},true);this.tabPanel.addTab({key:"custom",title:"Custom Palettes",isTemp:false},false);this.tabPanel.addTab({key:"load",title:"Load/Import Palette",isTemp:false},false);this.tabPanel.on("tabfocus",function(e,t){var i=r.tabPanel.getTabIndex(e);r.activeTab=e;if(i>=0){if(e=="load"){r.colorPaletteChoosePanel.showOnly("colorPaletteImportPanel");r.startLoadColorPalette({})}else{r.colorPaletteChoosePanel.showOnly("colorPaletteChoosePresetPanel");r.setColorPalettePresetType(e)}}});this.splitPanel.addNorth(this.tabPanel,30,false);this.colorPaletteChoosePanel=UI.create("UI.Panel",{id:"colorPaletteChoosePanel"});this.splitPanel.add(this.colorPaletteChoosePanel);this.uiComponent.add(this.splitPanel);this.colorPaletteImportPanel=UI.create("UI.Panel",{id:"colorPaletteImportPanel"});this.colorPaletteChoosePanel.add(this.colorPaletteImportPanel);this.htmlComponent=UI.create("UI.HTMLPanel",{id:"colorPaletteChoosePresetPanel"});this.colorPaletteChoosePanel.add(this.htmlComponent);this.colorPaletteChoosePanel.showOnly("colorPaletteChoosePresetPanel");this.uiComponent.add(this.splitPanel);this.htmlComponent.load("html/textMode/colorPaletteChoosePreset.html",function(){r.setupSampleImage(function(){r.initContent(e);r.initEvents()})});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){if(r.activeTab=="load"){r.colorPaletteLoad.setPalette({callback:r.callback,createColorPalette:r.createOnLoad})}else{r.choosePreset(r.previewColorPalette.selectedPaletteId)}UI.closeDialog()});this.linkButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-351-link.svg"> Create A Template Link',color:"other"});this.uiComponent.addButton(this.linkButton);this.linkButton.on("click",function(e){r.createTemplateLink()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("keydown",function(e){r.keydown(e)});this.uiComponent.on("keyup",function(e){r.keyup(e)});this.uiComponent.on("close",function(){r.visible=false})}else{this.initContent(e)}UI.showDialog("colorPaletteChoosePresetDialog")},startLoadColorPalette:function(e){if(this.colorPaletteLoad==null){this.colorPaletteLoad=new ColorPaletteLoad;this.colorPaletteLoad.init(this.editor,this.colorPaletteImportPanel)}this.colorPaletteLoad.show(e)},keydown:function(e){var t=e.key;if(typeof t!="undefined"){t=t.toLowerCase();if(t=="arrowup"||t=="arrowleft"){this.prev()}if(t=="arrowdown"||t=="arrowright"){this.next()}}else{switch(e.keyCode){case 38:case 37:this.prev();break;case 40:case 39:this.next();break}}},keyup:function(e){},prev:function(){var e=false;for(var t=0;t<this.colorPalettes.length;t++){if(this.colorPalettes[t]==this.previewColorPalette.id){if(t>0){e=t-1;break}}}if(e!==false){var i=this.colorPalettes[e];this.colorPaletteDialogSelect(i);$(".colorPaletteListEntry ").removeClass("colorPaletteListEntrySelected");$(".colorPaletteListEntry[value="+i+"]").addClass("colorPaletteListEntrySelected")}},next:function(){var e=false;for(var t=0;t<this.colorPalettes.length;t++){if(this.colorPalettes[t]==this.previewColorPalette.id){if(t<this.colorPalettes.length-1){e=t+1;break}}}if(e!==false){var i=this.colorPalettes[e];this.colorPaletteDialogSelect(i);$(".colorPaletteListEntry ").removeClass("colorPaletteListEntrySelected");$(".colorPaletteListEntry[value="+i+"]").addClass("colorPaletteListEntrySelected")}},createTemplateLink:function(){UI.closeDialog();g_app.createTemplateLink.show({colorPaletteId:this.previewColorPalette.selectedPaletteId})},dropFile:function(e){console.log("drop file!");console.log(e);this.colorPaletteLoad.setImportFile(e)},initContent:function(e){if(this.colorPaletteDisplay==null){this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:"chooseColorPalettePreview"});this.colorPaletteDisplay.setColorSize(24,24,1)}this.showSystemColorPalettes();if(typeof e.tab!="undefined"){if(e.tab=="load"){this.activeTab="load";this.colorPaletteChoosePanel.showOnly("colorPaletteImportPanel");this.startLoadColorPalette(e);this.tabPanel.showTab("load")}else{this.activeTab="system";this.colorPaletteChoosePanel.showOnly("colorPaletteChoosePresetPanel");this.setColorPalettePresetType(this.activeTab);this.tabPanel.showTab(this.activeTab)}}else{this.activeTab="system";this.colorPaletteChoosePanel.showOnly("colorPaletteChoosePresetPanel");this.setColorPalettePresetType(this.activeTab);this.tabPanel.showTab(this.activeTab)}},initEvents:function(){var t=this;var t=this;$("#chooseColorPaletteList").on("click",".colorPaletteListEntry",function(){var e=$(this).attr("value");$(".colorPaletteListEntry").removeClass("colorPaletteListEntrySelected");$(this).addClass("colorPaletteListEntrySelected");t.colorPaletteDialogSelect(e)});$("#choosePaletteBrightness").on("change",function(){t.brightness=$(this).val();$("#choosePaletteBrightnessValue").val(t.brightness);t.previewPalette()});$("#choosePaletteBrightness").on("input",function(){t.brightness=$(this).val();$("#choosePaletteBrightnessValue").val(t.brightness);t.previewPalette()});$("#choosePaletteBrightnessValue").on("change",function(){t.brightness=$(this).val();$("#choosePaletteBrightness").val(t.brightness);t.previewPalette()});$("#choosePaletteBrightnessReset").on("click",function(){t.brightness=0;$("#choosePaletteBrightness").val(t.brightness);$("#choosePaletteBrightnessValue").val(t.brightness);t.previewPalette()});$("#choosePaletteContrast").on("change",function(){t.contrast=$(this).val();$("#choosePaletteContrastValue").val(t.contrast);t.previewPalette()});$("#choosePaletteContrast").on("input",function(){t.contrast=$(this).val();$("#choosePaletteContrastValue").val(t.contrast);t.previewPalette()});$("#choosePaletteContrastValue").on("change",function(){t.contrast=$(this).val();$("#choosePaletteContrast").val(t.contrast);t.previewPalette()});$("#choosePaletteContrastReset").on("click",function(){t.contrast=0;$("#choosePaletteContrast").val(t.contrast);$("#choosePaletteContrastValue").val(t.contrast);t.previewPalette()});$("#choosePaletteSaturation").on("change",function(){t.saturation=$(this).val();$("#choosePaletteSaturationValue").val(t.saturation);t.previewPalette()});$("#choosePaletteSaturation").on("input",function(){t.saturation=$(this).val();$("#choosePaletteSaturationValue").val(t.saturation);t.previewPalette()});$("#choosePaletteSaturationValue").on("change",function(){t.saturation=$(this).val();$("#choosePaletteSaturation").val(t.saturation);t.previewPalette()});$("#choosePaletteSaturationReset").on("click",function(){t.saturation=0;$("#choosePaletteSaturation").val(t.saturation);$("#choosePaletteSaturationValue").val(t.saturation);t.previewPalette()})},showSystemColorPalettes:function(){var e="";this.colorPalettes=[];for(var t in ColorPalettePresets){if(ColorPalettePresets.hasOwnProperty(t)){var i=ColorPalettePresets[t].category;e+='<div class="colorPaletteListCategory">'+i+"</div>";for(var r=0;r<ColorPalettePresets[t].colorPalettes.length;r++){var a=ColorPalettePresets[t].colorPalettes[r].name;var s=ColorPalettePresets[t].colorPalettes[r].id;e+='<div class="colorPaletteListEntry ';if(s=="c64_colodore"){e+=" colorPaletteListEntrySelected "}this.colorPalettes.push(s);e+='" value="'+s+'">'+a+"</div>"}}}this.colorPaletteDialogSelect("c64_colodore");$("#chooseColorPaletteList").html(e)},showCustomColorPalettes:function(){var e="";this.colorPalettes=[];for(var t in ColorPaletteCustomPresets){if(ColorPaletteCustomPresets.hasOwnProperty(t)){var i=ColorPaletteCustomPresets[t].category;e+='<div class="colorPaletteListCategory">'+i+"</div>";for(var r=0;r<ColorPaletteCustomPresets[t].colorPalettes.length;r++){var a=ColorPaletteCustomPresets[t].colorPalettes[r].name;var s=ColorPaletteCustomPresets[t].colorPalettes[r].id;e+='<div class="colorPaletteListEntry ';if(s=="c64_colodore"){e+=" colorPaletteListEntrySelected "}this.colorPalettes.push(s);e+='" value="'+s+'">'+a+"</div>"}}}this.colorPaletteDialogSelect("c64_colodore");$("#chooseColorPaletteList").html(e)},colorPaletteDialogSelect:function(e){var t=this.getColorPaletteDescription(e);this.previewColorPalette=t;var i=this.previewColorPalette.name;if(typeof this.previewColorPalette.author!=="undefined"){i+=" by "+this.previewColorPalette.author}$("#chooseColorPaletteHeading").html(i);var r="";$("#chooseColorPaletteInfo").html(r);var a="";if(typeof this.previewColorPalette.description!="undefined"){a=this.previewColorPalette.description}$("#chooseColorPaletteDescription").html(a);var s="";var o=t.id;if(typeof t.options!="undefined"){for(var l=0;l<t.options.length;l++){s+='<label class="rb-container" style="margin-right: 8px;"><input type="radio" name="colorPaletteOption" value="'+t.options[l].id+'" ';if(l==0){o=t.options[l].id;s+=' checked="checked" '}s+="> "+t.options[l].name+'<span class="checkmark"/></label>&nbsp;'}}if(s!=""){$("#chooseColorPaletteOptions").html(s);$("#chooseColorPaletteOptions").show()}else{$("#chooseColorPaletteOptions").hide()}var n=this;$("input[type=radio][name=colorPaletteOption]").on("change",function(){var e=$("input[name=colorPaletteOption]:checked").val();n.previewColorPalette.selectedPaletteId=e;var t=e+".png";var i="palettes/"+t;n.previewFromPaletteImage(i)});this.previewColorPalette.selectedPaletteId=o;var h=o+".png";var d="palettes/"+h;this.previewFromPaletteImage(d)},setColorPalettePresetType:function(e){if(e=="system"){this.showSystemColorPalettes()}else{this.showCustomColorPalettes()}},previewFromPaletteImage:function(e){if(this.img==null){this.img=new Image}var t=this;this.img.onload=function(){t.paletteImage=t.img;t.previewPalette()};this.img.src=e},previewPalette:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.editor.colorPaletteManager.colorPaletteFromPaletteImg(this.paletteImage,{brightness:this.brightness,saturation:this.saturation,contrast:this.contrast});var i=t.colors.length;var r=16;var a=16;var s=2;var o=8;var l=2;o=Math.floor(this.paletteImage.naturalWidth/8);l=Math.floor(this.paletteImage.naturalHeight/8);var n=[];var h=0;for(var d=0;d<a;d++){n[d]=[];for(var c=0;c<r;c++){if(d<l&&c<o){n[d][c]=h++}else{n[d][c]=this.editor.colorPaletteManager.noColor}}}this.colorPaletteDisplay.setColors(t.colors,{colorMap:n})},showSampleImage:function(e){return;if(this.sampleImageCanvas==null){this.sampleImageCanvas=document.getElementById("chooseColorPaletteSampleImage");this.sampleImageContext=this.sampleImageCanvas.getContext("2d")}this.sampleImageContext.drawImage(this.colorPaletteSampleImage,0,0);var t=this.sampleImageContext.getImageData(0,0,this.sampleImageCanvas.width,this.sampleImageCanvas.height);ImageUtils.rgbQuant(t,{palette:e,dithKern:null});this.sampleImageContext.putImageData(t,0,0,0,0,this.sampleImageCanvas.width,this.sampleImageCanvas.height)},choosePreset:function(e,n){this.previewColorPaletteId=e;this.previewColorPaletteDescription=this.getColorPaletteDescription(e);if(!this.setColorPalette){if(this.callback!==false){this.callback({colorPaletteCreated:false,colorPalette:null,presetId:e,description:this.previewColorPaletteDescription})}return}var h=this;var t="palettes/"+e+".png";if(t!==false){var d=this;var c=new Image;c.src=t;c.onload=function(){var e=h.editor.colorPaletteManager.colorPaletteFromPaletteImg(c,{brightness:h.brightness,saturation:h.saturation,contrast:h.contrast});var t=Math.floor(c.naturalWidth/8);var i=Math.floor(c.naturalHeight/8);var r=d.editor.colorPaletteManager.getCurrentColorPalette();r.setColors(e.colors,t,i);var a=[];var s=0;for(var o=0;o<i;o++){a.push([]);for(var l=0;l<t;l++){if(s<e.colors.length){a[o][l]=s;s++}}}r.setColorPaletteMap("Default Layout",a);h.editor.colorPaletteManager.colorPaletteUpdated();if(r.name.indexOf("c64")!=-1){r.setIsC64Palette(true)}r.setSortOrderMethod("default");if(typeof n!=="undefined"&&n!=null){n()}if(g_app.getMode()=="color palette"){g_app.colorPaletteEditor.draw()}}}},getColorPaletteDescription:function(e){for(var t in ColorPalettePresets){if(ColorPalettePresets.hasOwnProperty(t)){for(var i=0;i<ColorPalettePresets[t].colorPalettes.length;i++){var r=ColorPalettePresets[t].colorPalettes[i].id;if(r==e){return ColorPalettePresets[t].colorPalettes[i]}}}}for(var t in ColorPaletteCustomPresets){if(ColorPaletteCustomPresets.hasOwnProperty(t)){for(var i=0;i<ColorPaletteCustomPresets[t].colorPalettes.length;i++){var r=ColorPaletteCustomPresets[t].colorPalettes[i].id;if(r==e){return ColorPaletteCustomPresets[t].colorPalettes[i]}}}}return null}};ColorPaletteChoosePresetMobileCard=function(){this.holder=null;this.cardHeading=null;this.cardOptions=null;this.canvas=null;this.palette=null;this.colorPaletteDisplay=null;this.paletteImage=null;this.moveHorizonal=false;this.moveVertical=false;this.touchStartX=0;this.touchStartY=0;this.touchStartScrollY=0;this.paletteId=false;this.paletteOptionId=false;this.brightness=0;this.contrast=0;this.saturation=0;this.editor=null};ColorPaletteChoosePresetMobileCard.prototype={init:function(e,t){this.editor=e;this.postfix=t},initContent:function(){this.holder=$("#chooseColorPaletteMobileHolder"+this.postfix);this.cardHeading=$("#chooseColorPaletteMobileHeading"+this.postfix);this.cardOptions=$("#chooseColorPaletteMobileOptions"+this.postfix);this.canvas=document.getElementById("chooseColorPaletteMobileCanvas"+this.postfix);if(this.colorPaletteDisplay==null){this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:"chooseColorPaletteMobileCanvas"+this.postfix})}this.cardWidth=$(window).width();this.holder.width(this.cardWidth)},setPosition:function(e,t){this.holder.css("left",e+"px");this.holder.css("top",t+"px")},getPalette:function(e){for(var t in ColorPalettePresets){if(ColorPalettePresets.hasOwnProperty(t)){for(var i=0;i<ColorPalettePresets[t].colorPalettes.length;i++){var r=ColorPalettePresets[t].colorPalettes[i].id;if(r==e){return ColorPalettePresets[t].colorPalettes[i]}}}}return null},setPalette:function(e){if(this.paletteId===e){return}this.paletteId=e;this.palette=this.getPalette(e);var t=this.palette.name;if(typeof this.palette.author!=="undefined"){t+=" by "+this.palette.author}this.cardHeading.html(t);var i="";$("#chooseColorPaletteMobileInfo").html(i);var r="";var a=this.palette.options;var s="colorPaletteMobileOption_"+this.paletteId;if(typeof a!="undefined"){for(var o=0;o<a.length;o++){r+='<label class="choose-container-tick" ';if(o==0){r+=' style="background-color: #666666" '}r+=">";r+=a[o].name;r+='<input type="radio" name="'+s+'" value="'+a[o].id+'" ';if(o==0){this.paletteId=a[o].id;r+=' checked="checked" '}r+=">";r+='<span class="checkmark"></span>';r+="</label>"}}this.cardOptions.html(r);this.paletteOptionId=this.paletteId;var l=this;$("input[type=radio][name="+s+"]").on("change",function(){var e=$(this).attr("name");var t=$(this).parent();$(".choose-container-tick").css("background-color","#333333");t.css("background-color","#666666");l.paletteOptionId=$("input[name="+e+"]:checked").val();l.loadSelectedPalette()});l.loadSelectedPalette()},loadSelectedPalette:function(){var e=this.paletteOptionId+".png";var t="palettes/"+e;if(this.paletteImage==null){this.paletteImage=new Image}var i=this;this.paletteImage.onload=function(){i.displaySelectedPalette()};this.paletteImage.src=t},displaySelectedPalette:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.editor.colorPaletteManager.colorPaletteFromPaletteImg(this.paletteImage,{brightness:this.brightness,saturation:this.saturation,contrast:this.contrast});var i=t.colors.length;var r=16;var a=16;var s=2;var o=8;var l=2;o=Math.floor(this.paletteImage.naturalWidth/8);l=Math.floor(this.paletteImage.naturalHeight/8);var n=[];var h=0;for(var d=0;d<a;d++){n[d]=[];for(var c=0;c<r;c++){if(d<l&&c<o){n[d][c]=h++}else{n[d][c]=this.editor.colorPaletteManager.noColor}}}this.colorPaletteDisplay.setColors(t.colors,{colorMap:n});var f=UI.getScreenWidth();var u=UI.getScreenHeight();var p=u-111;if(o>6&&f<800){this.colorPaletteDisplay.fitToWidth(f-20)}console.log("DRAW  Palette!!");this.colorPaletteDisplay.draw()}};var ColorPaletteChoosePresetMobile=function(){this.editor=null;this.uiComponent=null;this.colorPaletteSampleImage=null;this.sampleImageCanvas=null;this.sampleImageContext=null;this.cardPosition=0;this.paletteCardA=null;this.paletteCardB=null;this.callback=false;this.touchVelocity=null;this.cardMoving=false;this.nextPreloadImage=null;this.prevPreloadImage=null};ColorPaletteChoosePresetMobile.prototype={init:function(e){this.editor=e;this.touchVelocity=new TouchVelocity},setupSampleImage:function(e){this.colorPaletteSampleImage=new Image;this.colorPaletteSampleImage.onload=e;this.colorPaletteSampleImage.src="images/color_palette_sample.png"},show:function(e){var t=this;var i=500;var r=100;var a=UI.getScreenWidth();var s=UI.getScreenHeight();i=a-30;r=s-30;if(typeof e!="undefined"){if(typeof e.callback!="undefined"){this.callback=e.callback}}if(this.uiComponent==null){this.uiComponent=UI.create("UI.MobilePanel",{id:"colorPaletteChoosePresetMobileDialog",title:"Colours",width:i,height:r});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/colorPaletteChoosePresetMobile.html",function(){t.setupSampleImage(function(){t.initContent();t.initEvents()})});this.okButton=UI.create("UI.Button",{text:"Choose"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){if(t.callback){t.callback(t.paletteCardA.paletteOptionId)}UI.closeDialog()})}UI.showDialog("colorPaletteChoosePresetMobileDialog")},initContent:function(){var e="";var t=this;for(var i in ColorPalettePresets){if(ColorPalettePresets.hasOwnProperty(i)){var r=ColorPalettePresets[i].category;e+='<optgroup label="'+r+'">';for(var a=0;a<ColorPalettePresets[i].colorPalettes.length;a++){var s=ColorPalettePresets[i].colorPalettes[a].name;var o=ColorPalettePresets[i].colorPalettes[a].id;e+='<option value="'+o+'" ';if(o=="c64_colodore"){e+=' selected="selected" '}e+=">"+s+"</option>"}e+="</optgroup>"}}this.paletteCardA=new ColorPaletteChoosePresetMobileCard;this.paletteCardA.init(this.editor,"A");this.paletteCardA.initContent();this.paletteCardA.setPosition(0,0);this.paletteCardB=new ColorPaletteChoosePresetMobileCard;this.paletteCardB.init(this.editor,"B");this.paletteCardB.initContent();this.paletteCardB.setPosition(1e4,0);$("#colorPaletteChoosePresetMobileList").html(e);$("#colorPaletteChoosePresetMobileList").on("change",function(){var e=$(this).val();t.selectPalettePreset(e)});$("#chooseColorPaletteMobilePrev").on("click",function(e){t.prevPreset()});$("#chooseColorPaletteMobileNext").on("click",function(e){t.nextPreset()});this.cardWidth=$(window).width();this.selectPalettePreset("c64_colodore")},initEvents:function(){var t=this;var e=document.getElementById("chooseColorPaletteMobileHolderA");e.addEventListener("touchstart",function(e){t.touchStart(e)},false);e.addEventListener("touchmove",function(e){t.touchMove(e)},false);e.addEventListener("touchend",function(e){t.touchEnd(e)},false);var e=document.getElementById("chooseColorPaletteMobileHolderB");e.addEventListener("touchstart",function(e){t.touchStart(e)},false);e.addEventListener("touchmove",function(e){t.touchMove(e)},false);e.addEventListener("touchend",function(e){t.touchEnd(e)},false)},touchStart:function(e){this.touchVelocity.touchStart(e);var t=e.touches;this.startScrollYA=$("#chooseColorPaletteMobileOptionsA").scrollTop();this.startScrollYB=$("#chooseColorPaletteMobileOptionsB").scrollTop();if(t.length>0){var i=t[0].pageX;var r=t[0].pageY;this.touchStartX=i;this.touchStartY=r}},touchMove:function(e){this.touchVelocity.touchMove(e);var t=e.touches;if(t.length>0){var i=t[0].pageX;var r=t[0].pageY;if(this.moveVertical){return}var a=i-this.touchStartX;var s=-16;if(a<s){this.moveHorizonal=true;a=i-this.touchStartX-s;if(a>0){a=0}}if(a>-s){this.moveHorizonal=true;a=i-this.touchStartX+s;if(a<0){a=0}}if(this.moveHorizonal&&!this.cardMoving){this.setCardPosition(a)}if($(e.target).hasClass("choose-container-tick")){var o=$(this).parent();var l=$(o).scrollTop()}else{e.preventDefault()}}},touchEnd:function(e){this.touchVelocity.touchEnd(e);var t=e.touches;this.hideNext();this.moveHorizonal=false;this.moveVertical=false},hideNext:function(e){var o=this;var t=2e3;var i=0;var r=this.cardWidth/3.6;if(r>90){r=90}if(this.cardPosition>r){i=this.cardWidth}else if(this.cardPosition<-r){i=-this.cardWidth}else{i=0}if(typeof e!=="undefined"){if(e.gotoNext){i=-this.cardWidth}if(e.gotoPrev){i=this.cardWidth}}var a=this.touchVelocity.getVelocity();if(a&&a.vx){if(i==0){if(a.vx<-1.2){i=-this.cardWidth}if(a.vx>1.2){i=this.cardWidth}}if(i!==0){var s=i-this.cardPosition;console.log("distance = "+s);if(s!=0){t=s/a.vx}}console.log("duration = "+t)}if(t>250||t<0){t=250}this.cardMoving=true;this.paletteCardA.holder.animate({left:i+"px"},{duration:t,progress:function(e,t,i){var r=o.paletteCardA.holder.position();o.cardPosition=r.left;var a=r.left;if(a<0){var s=a+o.cardWidth;o.paletteCardB.holder.css("left",s+"px")}else{var s=a-o.cardWidth;o.paletteCardB.holder.css("left",s+"px")}},complete:function(){o.cardMoving=false;if(i!==0){var e=o.paletteCardB.paletteId;var t=o.paletteCardB;o.paletteCardB=o.paletteCardA;o.paletteCardA=t;console.log("set cvard position to 0!!!!!");o.cardPosition=0;o.selectPalettePreset(e)}}})},setCardPosition:function(e){this.cardPosition=e;var t=this.paletteCardA.cardWidth;var i=e;var r=0;this.paletteCardA.setPosition(i,r);if(e<0){var a=e+t;this.paletteCardB.setPosition(a,0);this.setCardBContent()}else{var a=e-t;this.paletteCardB.setPosition(a,0);this.setCardBContent()}},getPrevPresetId:function(){var e=this.presetId;var t=false;var i=false;for(var r in ColorPalettePresets){if(ColorPalettePresets.hasOwnProperty(r)){for(var a=0;a<ColorPalettePresets[r].colorPalettes.length;a++){var s=ColorPalettePresets[r].colorPalettes[a].id;if(s==e){if(t===false){return false}i=true;return t}t=s}}}return false},getNextPresetId:function(){var e=this.presetId;var t=false;for(var i in ColorPalettePresets){if(ColorPalettePresets.hasOwnProperty(i)){for(var r=0;r<ColorPalettePresets[i].colorPalettes.length;r++){var a=ColorPalettePresets[i].colorPalettes[r].id;if(t){return a}if(a==e){t=true}}}}return false},setCardBContent:function(){if(this.cardPosition<0){var e=this.getNextPresetId();if(e!==false){this.paletteCardB.setPalette(e)}}if(this.cardPosition>0){var t=this.getPrevPresetId();if(t!==false){this.paletteCardB.setPalette(t)}}},preloadNextPrev:function(e){var t=this.getNextPresetId();if(t!==false){var i=this.paletteCardA.getPalette(t);var r=i.id;var a=i.options;if(typeof a!="undefined"&&a.length>0){r=a[0].id}var s=r+".png";var o="palettes/"+s;console.log("preload "+s);if(this.nextPreloadImage==null){this.nextPreloadImage=new Image}this.nextPreloadImage.src=o}var l=this.getPrevPresetId();if(l!==false){var i=this.paletteCardA.getPalette(l);var r=i.id;var a=i.options;if(typeof a!="undefined"&&a.length>0){r=a[0].id}var s=r+".png";var o="palettes/"+s;console.log("preload "+s);if(this.prevPreloadImage==null){this.prevPreloadImage=new Image}this.prevPreloadImage.src=o}},selectPalettePreset:function(e){this.presetId=e;$("#colorPaletteChoosePresetMobileList").val(this.presetId);this.paletteCardA.setPalette(this.presetId);this.preloadNextPrev(this.presetId)},nextPreset:function(){console.log("next!"+this.cardPosition);if(this.cardPosition===0){var e=this.getNextPresetId();console.log("preset id = "+e);if(e!==false){this.paletteCardB.setPalette(e);this.hideNext({gotoNext:true})}}},prevPreset:function(){console.log("prev");if(this.cardPosition===0){var e=this.getPrevPresetId();if(e!==false){this.paletteCardB.setPalette(e);this.hideNext({gotoPrev:true})}}}};var ColorPalette=function(){this.editor=null;this.colorPaletteId=null;this.docRecord=null;this.defaultBackgroundColor=6;this.defaultBorderColor=14;this.colors=[];this.materials=[];this.isC64Palette=true;this.paletteCanvas=null;this.sortOrderMethod="default";this.sortOrder=[];this.currentMap=[];this.trackModified=true};ColorPalette.prototype={setTrackModified:function(e){this.trackModified=e},modified:function(){if(g_app.openingProject||!this.trackModified){return}var e="/color palettes/"+this.docRecord.name;g_app.doc.recordModified(this.docRecord,e)},init:function(e,t,i){this.editor=e;if(typeof t==="undefined"){this.name="Color Palette"}else{this.name=t}this.colorPaletteId=i;this.version=1;this.docRecord=g_app.doc.getDocRecordById(i,"/color palettes");this.name=this.docRecord.name;if(typeof this.docRecord.data.colors=="undefined"){this.docRecord.data.colors=[]}var r=false;for(var a=0;a<this.docRecord.data.colors.length;a++){var s=this.docRecord.data.colors[a]>>>24&255;if(s>0){r=true}}if(!r){for(var a=0;a<this.docRecord.data.colors.length;a++){this.docRecord.data.colors[a]=this.docRecord.data.colors[a]>>>0}}if(typeof this.docRecord.data.colorsAcross=="undefined"){this.docRecord.data.colorsAcross=8}if(typeof this.docRecord.data.colorsDown=="undefined"){this.docRecord.data.colorsDown=2}},nameChanged:function(){this.name=this.docRecord.name},setName:function(e){this.name=e;this.docRecord.name=e},getId:function(){return this.colorPaletteId},getName:function(){var e=g_app.doc.getDocRecordById(this.colorPaletteId,"/color palettes");return e.name},getPath:function(){var e=g_app.doc.getDocRecordById(this.colorPaletteId,"/color palettes");if(!e){return false}return"/color palettes/"+e.name},clear:function(){this.docRecord.data.colors=[]},getColors:function(){return this.colors},clearPaletteMaps:function(){var e=this.getPath();var t=e+"/maps";var i=g_app.doc.getDocRecord(t);if(!i){return}i.children=[]},setColorPaletteMap:function(e,t){var i=[];for(var r=0;r<t.length;r++){i[r]=[];for(var a=0;a<t[r].length;a++){i[r][a]=t[r][a]}}if(this.docRecord){var s=this.getPath();var o=s+"/maps";var l=g_app.doc.getDocRecord(o);if(!l){l=g_app.doc.createDocRecord(s,"maps","folder",{})}var n=o+"/"+e;var h=g_app.doc.getDocRecord(n);if(!h){h=g_app.doc.createDocRecord(o,e,"color map",{map:i})}else{h.data.map=i}return h.id}else{this.colorMap=i}},getColorPaletteMaps:function(){var e=this.getPath();if(e===false){return[]}var t=e+"/maps";var i=g_app.doc.getDocRecord(t);if(!i){return[]}var r=[];var a=g_app.doc.dir(t);for(var s=0;s<a.length;s++){r.push({id:a[s].id,name:a[s].name})}return r},getDefaultColorPaletteMap:function(){if(!this.docRecord){return this.colorMap}var e=this.getPath();var t=e+"/maps";var i=g_app.doc.getDocRecord(t);if(!i){return false}var r=[];var a=g_app.doc.dir(t);if(a.length==0){return false}return a[0].data.map},getColorPaletteMapById:function(e){var t=this.getPath();var i=t+"/maps";var r=g_app.doc.getDocRecordById(e,i);if(!r){return false}return r.data.map},getColorsAcross:function(){if(this.docRecord){return this.docRecord.data.colorsAcross}else if(this.colorMap&&this.colorMap.length){return this.colorMap[0].length}else{return 16}},getColorsDown:function(){if(this.docRecord){return this.docRecord.data.colorsDown}else if(this.colorMap){return this.colorMap.length}else{return 16}},setIsC64Palette:function(e){this.isC64Palette=true},getIsC64Palette:function(){return this.isC64Palette},setSortOrderMethod:function(e){$("#colorPaletteSortOrder").val(e);var t=this.docRecord.data.colors;var i=this.getColorsAcross();this.sortOrderMethod=e;this.sortOrder=this.editor.colorPaletteManager.sortColors(t,{sortMethod:e});var r=[];var a=0;var s=Math.ceil(this.sortOrder.length/i);for(var o=0;o<s;o++){r[o]=[];for(var l=0;l<i;l++){if(a<this.sortOrder.length){r[o][l]=this.sortOrder[a]}else{r[o][l]=this.editor.colorPaletteManager.noColor}a++}}this.currentMap=r;return this.sortOrder},getColorMap:function(e,t){if(e=="default"){var i=this.getDefaultColorPaletteMap();if(i!==false){return i}}else if($.isNumeric(e)){console.log("here!");if(this.docRecord){var r=parseInt(e,10);var i=this.getColorPaletteMapById(r);return i}else{return this.colorMap}}var a=null;if(this.docRecord){a=this.docRecord.data.colors}else{a=this.noDocColors}var s=t;if(typeof t=="undefined"){s=this.getColorsAcross()}var o=this.editor.colorPaletteManager.sortColors(a,{sortMethod:e});var i=[];var l=0;var n=Math.ceil(o.length/s);for(var h=0;h<n;h++){i[h]=[];for(var d=0;d<s;d++){if(l<o.length){i[h][d]=o[l]}else{i[h][d]=this.editor.colorPaletteManager.noColor}l++}}return i},setCurrentColorMap:function(e){var t=this.getColorPaletteMapById(e);if(t===false){return false}this.currentMap=t;return t},getCurrentColorMap:function(){return this.currentMap},getSortOrderMethod:function(){return this.sortOrderMethod},getSortOrder:function(){return this.sortOrder},setAcrossDown:function(e,t){if(typeof e!="undefined"&&typeof t!="undefined"){this.docRecord.data.colorsAcross=e;this.docRecord.data.colorsDown=t;return}if(typeof e!="undefined"&&typeof t=="undefined"){this.docRecord.data.colorsAcross=e;this.docRecord.data.colorsDown=Math.ceil(this.colors.length/this.docRecord.data.colorsAcross);return}var i=4;var r=4;switch(this.colors.length){case 2:i=2;r=1;break;case 4:i=4;r=1;break;case 8:i=4;r=2;break;case 16:i=4;r=4;break;case 32:this.colorsAcross=8;this.colorsDown=4;break;case 64:this.colorsAcross=8;this.colorsDown=8;break;case 128:this.colorsAcross=16;this.colorsDown=8;break;case 256:this.colorsAcross=16;this.colorsDown=16;break}this.docRecord.data.colorsAcross=i;this.docRecord.data.colorsDown=r;this.modified()},setColorsFromDoc:function(){var e=this.docRecord.data.colors;for(var t=0;t<e.length;t++){this.createColorMeta(t)}var i=8;var r=Math.ceil(e.length/i);if(typeof this.docRecord.data.colorsAcross!="undefined"){i=this.docRecord.data.colorsAcross}if(typeof this.docRecord.data.colorsDown!="undefined"){r=this.docRecord.data.colorsDown}this.setAcrossDown(i,r);this.paletteChanged();if(this.docRecord.name.indexOf("c64")!=-1){this.isC64Palette=true}else{this.isC64Palette=false}},copyPalette:function(e){this.setColors(e.noDocColors,e.colorsAcross,e.colorsDown)},setColors:function(e,t,i){this.isC64Palette=false;var r=this.colors.length;var a=[];var s=[];for(var o=0;o<this.colors.length;o++){var l=this.getRGBA(o);var n=false;var h=false;for(var d=0;d<e.length;d++){var c=e[d]>>>24&255;var f=e[d]>>>16&255;var u=e[d]>>>8&255;var p=e[d]>>>0&255;var v=(l[0]-f)*(l[0]-f)+(l[1]-u)*(l[1]-u)+(l[2]-p)*(l[2]-p);if(n===false||v<n){n=v;h=d}}if(h!==false){a[o]=h}}if(this.docRecord){var g=this.editor.layers;var m=g.getLayerCount();for(var o=0;o<m;o++){var y=g.getLayerObjectFromIndex(o);for(var d=0;d<this.colors.length;d++){y.replaceColor(d,a[d])}}this.docRecord.data.colors=[];this.colors=[];for(var o=0;o<e.length;o++){this.addColor(e[o]);this.createColorMeta(o)}this.setAcrossDown(t,i);this.paletteChanged();this.editor.graphic.redraw({allCells:true});this.editor.syncColorPickers();this.modified()}else{this.noDocColors=e;this.colorsAcross=t;this.colorsDown=i;for(var o=0;o<e.length;o++){this.createColorMeta(o)}}},setColorRGB:function(e,t){var i=(4278190080|t>>>0)>>>0;this.docRecord.data.colors[e]=i;this.modified();this.createColorMeta(e)},addColor:function(e){this.docRecord.data.colors.push(e);this.modified();this.createColorMeta(this.docRecord.data.colors.length-1)},createColorMeta:function(e){var t=0;if(this.docRecord){t=this.docRecord.data.colors[e]}else{t=this.noDocColors[e]}var i={};i.argb=t;i.hex=t&16777215;i.emissiveHex=0;i.specularHex=0;i.shininess=0;i.index=this.colors.length;var r=i.hex>>>24&255;var a=i.hex>>>16&255;var s=i.hex>>>8&255;var o=i.hex>>>0&255;i.a=r/255;i.r=a/255;i.g=s/255;i.b=o/255;var l={};l.values=[a,s,o,r];i.hsv=Colour.converters[Colour.RGBA][Colour.HSVA](l);i.rgb=l.values;if(i.hsv.values[1]<.1){i.isGrey=true}else{i.isGrey=false}i.laba=Colour.converters[Colour.RGBA][Colour.LABA](l);i.material=null;if(e<this.materials.length&&this.materials[e]!=null){this.materials[e].color.set(i.hex)}this.colors[e]=i},getColorCount:function(){return this.colors.length},getDefaultBackgroundColor:function(){if(this.colors.length>this.defaultBackgroundColor){return this.defaultBackgroundColor}return 0},getDefaultBorderColor:function(){if(this.colors.length>this.defaultBorderColor){return this.defaultBorderColor}return 0},getRGBA:function(e){if(e===false||e===this.editor.colorPaletteManager.noColor){return[0,0,0,0]}if(e<this.colors.length){return this.colors[e].rgb}return[0,0,0,0]},getARGB:function(e){if(e===false||e===this.editor.colorPaletteManager.noColor){return 0}if(e<this.colors.length){return this.colors[e].argb}return 0},getHex:function(e){if(e===false||e===this.editor.colorPaletteManager.noColor){return 0}if(e<this.colors.length){return this.colors[e].hex}return 0},getHexString:function(e){if(e!==false&&e>=0&&e<this.colors.length){return("000000"+this.colors[e].hex.toString(16)).substr(-6)}return"ffffff"},getIsGrey:function(e){if(e===false){return false}if(e<this.colors.length){return this.colors[e].isGrey}return false},getColor:function(e){if(e<this.colors.length){return this.colors[e]}return false},getMaterial:function(e){if(e<this.colors.length){while(e>=this.materials.length){this.materials.push(null)}if(this.materials[e]==null){var t=this.colors[e];this.materials[e]=new THREE.MeshPhongMaterial({color:t.hex,emissive:t.emissiveHex,specular:t.specularHex,shininess:t.shininess})}return this.materials[e]}return null},paletteChanged:function(){this.editor.colorPaletteManager.colorPaletteUpdated()},setToPreset:function(e,t){g_app.textModeEditor.colorPaletteManager.choosePreset(e,{colorPalette:this,callback:t})},saveAsPNG:function(e,t,i,r){var a=t;if(typeof t=="undefined"){a=this.currentMap}if(this.paletteCanvas==null){this.paletteCanvas=document.createElement("canvas")}var s=8;var o=8;if(typeof i!="undefined"){s=i}if(typeof r!="undefined"){o=r}var l=0;var n=0;for(var h=0;h<a.length;h++){for(var d=0;d<a[h].length;d++){if(a[h][d]!=this.editor.colorPaletteManager.noColor){if(d+1>l){l=d+1}n=h+1}}}this.paletteCanvas.width=l*s;this.paletteCanvas.height=n*o;this.paletteCanvasContext=this.paletteCanvas.getContext("2d");for(var h=0;h<n;h++){for(var d=0;d<l;d++){var c=a[h][d];if(c!==this.editor.colorPaletteManager.noColor){var f=this.getHexString(c);var u=("000000"+f.toString(16)).substr(-6);this.paletteCanvasContext.fillStyle="#"+u;this.paletteCanvasContext.fillRect(d*s,h*o,s,o)}}}if(e.indexOf(".png")==-1){e+=".png"}var p=this.paletteCanvas.toDataURL("image/png");download(p,e,"image/png")},loadFromJSON:function(e){var t={};var i=[];var r=8;var a=1;t=e;if(typeof t.colorPalette!="undefined"){t=t.colorPalette}var i=[];var s=[];if(typeof t.data!="undefined"){for(var o=0;o<t.data.length;o++){i.push(t.data[o])}}if(typeof t.across!="undefined"){r=t.across}else{r=i.length;a=1}if(typeof t.maps!="undefined"&&t.maps.length>0){var l=t.maps[0];for(var n=0;n<l.map.length;n++){s[n]=[];for(var h=0;h<l.map[n].length;h++){s[n][h]=l.map[n][h]}}}else{}if(i.length>0){this.docRecord.data.colors=[];this.colors=[];for(var o=0;o<i.length;o++){this.addColor(i[o]);this.createColorMeta(o)}this.clearPaletteMaps();if(s.length>0){this.setColorPaletteMap("Default Layout",s)}}else{this.errorMessage("No colours found")}},getJSON:function(){var e={};if(this.docRecord){e.id=this.docRecord.id;e.name=this.docRecord.name;e.version=1;e.data=this.docRecord.data.colors;e.across=this.docRecord.data.colorsAcross;e.down=this.docRecord.data.colorsDown;e.maps=[];var t=this.getPath();var i=t+"/maps";var r=g_app.doc.getDocRecord(i);if(r){for(var a=0;a<r.children.length;a++){e.maps.push({name:r.children[a].name,map:r.children[a].data.map})}}}else{e.data=this.noDocColors;e.across=this.colorsAcross;e.down=this.colorsDown;e.maps=[];e.maps.push({name:"default",map:this.colorMap})}return e},saveAsJSON:function(e){var t=this.getJSON();var i=JSON.stringify(t);if(e.indexOf(".json")==-1){e+=".json"}download(i,e,"application/json")},getMapColorIndexOrder:function(e){var t=[];for(var i=0;i<e.length;i++){for(var r=0;r<e[i].length;r++){var a=e[i][r];if(a!==this.editor.colorPaletteManager.noColor){t.push(a)}}}return t},saveAsGPL:function(e,t){var i="";i+="GIMP Palette\n";i+="#Palette Name: palette\n";i+="#Description: exported palette\n";i+="#Colors: "+this.colors.length+"\n";var r=false;if(typeof t!=="undefined"){r=this.getMapColorIndexOrder(t)}for(var a=0;a<this.colors.length;a++){var s=this.getHex(a);if(r!==false){s=this.getHex(r[a])}i+=s>>16&255;i+="\t";i+=s>>8&255;i+="\t";i+=s&255;i+="\t";i+="#"+this.getHexString(a);i+="\n"}if(e.indexOf(".gpl")==-1){e+=".gpl"}download(i,e,"application/gpl")},saveAsTxt:function(e,t){var i="";i+=";paint.net Palette File\n";i+=";Palette Name: "+"palette name\n";i+=";Description: "+" palette description\n";i+=";Colors: "+this.colors.length+"\n";var r=false;if(typeof t!=="undefined"){r=this.getMapColorIndexOrder(t)}for(var a=0;a<this.colors.length;a++){var s=a;if(r!==false){s=r[a]}i+="FF"+this.getHexString(s)+"\n"}if(e.indexOf(".txt")==-1){e+=".txt"}download(i,e,"txt/plain")},saveAsHex:function(e,t){var i="";var r=false;if(typeof t!=="undefined"){r=this.getMapColorIndexOrder(t)}for(var a=0;a<this.colors.length;a++){var s=a;if(r!==false){s=r[a]}i+=this.getHexString(s)+"\n"}if(e.indexOf(".hex")==-1){e+=".hex"}download(i,e,"application/hex")},saveAsAco:function(e,t){var i=new ACO;var r=null;if(typeof t!=="undefined"){var a=[];var s=this.getMapColorIndexOrder(t);for(var o=0;o<this.colors.length;o++){var l=s[o];var n=this.colors[l];a.push(n)}r=i.writePalette(a)}else{r=i.writePalette(this.colors)}if(e.indexOf(".aco")==-1){e+=".aco"}download(r,e,"application/aco")},saveAsAse:function(e,t){var i=new ASE;var r=null;if(typeof t!=="undefined"){var a=[];var s=this.getMapColorIndexOrder(t);for(var o=0;o<this.colors.length;o++){var l=s[o];var n=this.colors[l];a.push(n)}r=i.writePalette(a)}else{r=i.writePalette(this.colors)}if(e.indexOf(".ase")==-1){e+=".ase"}download(r,e,"application/ase")}};var ColorPickerPopup=function(){this.html="<div>";this.html+='  <div id="colorPickerNoColor">';this.html+='    <div id="popupColor-1" class="colorPickerPopupColor colorPickerPopupNoColor" style="color: #ffffff; height: 20px; position: absolute; top: 2px; left: 54px"><i class="halflings halflings-remove"></i> Transparent</div>';this.html+="  </div>";this.html+='<div id="colorPickerECM">';this.html+='<div style="color: #ffffff; height: 30px; position: absolute; top: 0px; left: 54px; display: flex; align-items: center">';for(var e=0;e<4;e++){var t=e+1;var i=e;this.html+='<label class="rb-container" style="margin-right: 8px; margin-bottom: 0px; display: flex; align-items: center"> ';this.html+='<input type="radio" id="colorPickerECMColorIndex'+e+'" name="colorPickerECMColorIndex" value="'+i+'"';if(e===0){this.html+=' checked="checked" '}this.html+=">";this.html+='<div id="colorPickerECMColorBlockIndex'+e+'" style="display: flex; width: 16px; height: 16px; margin-right: 6px; background-color: #884433"></div>';this.html+='<span class="rb-label">BG '+t+"</span>";this.html+='<span class="checkmark"/>';this.html+="</label>"}this.html+="</div>";this.html+="</div>";this.html+='<div id="colorPickerCurrentColor" style="position: absolute; left: 2px; top: 2px; width: 50px; height: 24px; background-color: #ff0000"></div>';this.html+='<div id="colorPickerHoverColor" style="position: absolute; left: 2px; top: 26px; width: 50px; height: 24px; background-color: #00ff00"></div>';this.html+='  <canvas id="colorPickerCanvas" style="position: absolute; left: 54px"></canvas>';this.html+='  <div id="colorPickerInfo" style="color: #ffffff; margin: 2px; position: absolute; left: 2px; bottom: 2px"></div>';this.html+='  <div id="colorPickerLabel1" style="display: none; position: absolute; color: #ffffff"></div>';this.html+='  <div id="colorPickerLabel2" style="display: none; position: absolute; color: #ffffff"></div>';this.html+="</div>";this.uiComponent=null;this.htmlComponent=null;this.canvas=null;this.context=null;this.highlightedColor=false;this.colorPickedCallback=null;this.c64ECMColorSetCallback=null;this.c64ECMColorIndex=0;this.mode="";this.visible=false;this.colorPaletteDisplay=null};ColorPickerPopup.prototype={init:function(e){this.editor=e;this.uiComponent=UI.create("UI.Popup",{id:"colorPickerPopup",width:300,height:300});this.htmlComponent=UI.create("UI.HTMLPanel",{html:this.html});this.uiComponent.add(this.htmlComponent);this.initEvents()},updateInfo:function(){var e="";if(this.highlightedColor!==this.editor.colorPaletteManager.noColor&&typeof this.highlightedColor!="undefined"){var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i=t.getHexString(this.highlightedColor);var r=("00"+this.highlightedColor.toString(16)).substr(-2);e+='<div style="display: inline-block; width: 20px">'+this.highlightedColor+"</div>";e+='<div style="display: inline-block; width: 30px">0x'+r+"</div>";e+='<div style="display: inline-block; width: 60px">#'+i+"</div>";$("#colorPickerHoverColor").css("background-color","#"+i)}else{$("#colorPickerHoverColor").css("background-color","#000000")}$("#colorPickerInfo").html(e)},initEvents:function(){var t=this;$("#popupColor-1").on("click",function(e){t.colorPickedCallback(-1);t.close()});$("input[name=colorPickerECMColorIndex]").on("click",function(){var e=$("input[name=colorPickerECMColorIndex]:checked").val();e=parseInt(e,10);if(!isNaN(e)){t.setC64ECMIndex(e)}})},updateC64ECMColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();for(var t=0;t<4;t++){var i=this.editor.getC64ECMColor(t);var r=e.getHexString(i);$("#colorPickerECMColorBlockIndex"+t).css("background-color","#"+r)}},setC64ECMIndex:function(e){this.c64ECMColorIndex=e;var t=this.editor.layers.getSelectedLayerObject();if(t&&t.getType()=="grid"){this.colorPaletteDisplay.setSelectedColor(0,t.getC64ECMColor(e))}this.colorPickedCallback(e)},initColorPaletteDisplay:function(){var i=this;this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:"colorPickerCanvas",maxSelectableColors:1,canSelectWithRightMouseButton:false});this.colorPaletteDisplay.on("colorselected",function(e){if(e.colorIndex==0){var t=e.color;if(t!==i.editor.colorPaletteManager.noColor){if(i.c64ECM&&i.c64ECMColorSetCallback){i.c64ECMColorSetCallback(i.c64ECMColorIndex,e.color)}else{i.colorPickedCallback(e.color)}}i.close()}});this.colorPaletteDisplay.on("highlightchanged",function(e){i.highlightedColor=e.color;i.updateInfo()})},show:function(e,t,i){if(this.colorPaletteDisplay==null){this.initColorPaletteDisplay()}var r=this.editor.colorPaletteManager.getCurrentColorPalette();this.colorPickedCallback=null;this.c64ECMColorSetCallback=null;if(typeof i!="undefined"){if(typeof i.colorPickedCallback!="undefined"){this.colorPickedCallback=i.colorPickedCallback}if(typeof i.c64ECMColorSetCallback!="undefined"){this.c64ECMColorSetCallback=i.c64ECMColorSetCallback}if(typeof i.type!="undefined"){this.colorPaletteDisplay.setType(i.type)}else{this.colorPaletteDisplay.setType("")}}var a=[];var s=r.getColorCount();for(var o=0;o<s;o++){a.push(r.getHex(o))}var l=r.getCurrentColorMap();var n=8;var h=8;if(l.length>0&&l[0].length>0){n=l[0].length;h=l.length}var d=26;var c=26;if(n>12||h>12){d=20;c=20}this.colorPaletteDisplay.setColorSize(d,c);this.colorPaletteDisplay.setColors(a,{colorMap:r.getCurrentColorMap()});this.mode="";if(i.mode!=="undefined"){this.mode=i.mode}this.currentColor=false;if(typeof i.currentColor!="undefined"){this.currentColor=i.currentColor}this.isCellBG=false;if(typeof i.isCellBG!="undefined"){this.isCellBG=i.isCellBG}this.screenMode=false;if(typeof i.screenMode!="undefined"){this.screenMode=i.screenMode}this.hasNone=false;this.c64ECM=false;if(this.isCellBG){if(this.screenMode==TextModeEditor.Mode.C64ECM){this.hasNone=false;this.c64ECM=true;this.c64ECMColorIndex=this.currentColor;if(this.currentColor===this.editor.colorPaletteManager.noColor){this.c64ECMColorIndex=0}$("#colorPickerECMColorIndex"+this.c64ECMColorIndex).prop("checked",true);this.currentColor=this.editor.getC64ECMColor(this.c64ECMColorIndex);this.updateC64ECMColors()}else{this.hasNone=true}}else{if(typeof i.hasNone!="undefined"){this.hasNone=i.hasNone}}if(this.currentColor!==false){var f=r.getHexString(this.currentColor);$("#colorPickerCurrentColor").css("background-color","#"+f);$("#colorPickerHoverColor").css("background-color","#"+f);this.colorPaletteDisplay.setSelectedColor(0,this.currentColor)}this.colorCount=r.getColorCount();if(this.c64ECM){$("#colorPickerCanvas").css("top","34px");$("#colorPickerNoColor").hide();$("#colorPickerECM").show()}else if(this.hasNone){$("#colorPickerCanvas").css("top","28px");$("#colorPickerNoColor").show();$("#colorPickerECM").hide()}else{$("#colorPickerCanvas").css("top","2px");$("#colorPickerNoColor").hide();$("#colorPickerECM").hide()}this.infoHeight=24;var u=this.colorPaletteDisplay.getHeight();var p=this.colorPaletteDisplay.getWidth();var v=50;var g=50;var m=p+v+6;var y=u+this.infoHeight;if(y<g+2){y=g+2}if(this.hasNone){y+=28}if(this.c64ECM){m+=90;y+=40}if(m<160){m=160}this.uiComponent.setDimensions(m,y);UI.showPopup("colorPickerPopup",e,t);this.visible=true},close:function(){if(this.visible){UI.hidePopup()}this.visible=false}};var ColorPickerMobile=function(){this.editor=null;this.colorPaletteDisplay=null;this.colorType="cell";this.uiComponent=null;this.canSelectMultiple=false;this.id="Choose";this.closeHandler=false;this.c64ECMColorIndex=0};ColorPickerMobile.prototype={on:function(e,t){if(e=="close"){this.closeHandler=t}},init:function(e,t){this.editor=e;if(typeof t!="undefined"){if(typeof t.canSelectMultiple!="undefined"){this.canSelectMultiple=t.canSelectMultiple}if(typeof t.id!="undefined"){this.id=t.id}}},initEvents:function(){var i=this;this.colorPaletteDisplay.on("touchcolor",function(e){i.displayInfo(e)});this.colorPaletteDisplay.on("touchcolorend",function(e){if(e!==false){if(!i.canSelectMultiple){i.selectColor(e);UI.closeDialog()}}});$("#noColorMobile").on("click",function(e){i.selectColor(i.editor.colorPaletteManager.noColor);UI.closeDialog()});$(".colorPickerTypeMobile").on("click",function(e){var t=$(this).attr("data-type");i.setColorType(t)});$("#clearColorSelection").on("click",function(e){i.colorPaletteDisplay.setSelectedColors([]);i.colorPaletteDisplay.draw()});$("input[name=colorPickerECMColorIndexMobile]").on("click",function(){var e=$("input[name=colorPickerECMColorIndexMobile]:checked").val();e=parseInt(e,10);if(!isNaN(e)){i.setC64ECMIndex(e)}})},show:function(e){var t="cell";if(typeof e!="undefined"){if(typeof e.type!="undefined"){t=e.type}}var i=this;this.callback=e.colorPickedCallback;if(this.uiComponent==null){var r=500;var a=100;var s=UI.getScreenWidth();var o=UI.getScreenHeight();r=s-30;a=o-30;this.uiComponent=UI.create("UI.MobilePanel",{id:"colorPickerMobile"+this.id,title:"Choose Color",width:r,height:a});var l="";l+='<h2 style="margin: 0 0 14px 0" id="colorPickerMobileHeading">Color type heading</h2>';l+='<div style="margin-bottom: 14px">';l+='  <div style="display: inline-block; width: 64px; height: 60px; border: 3px solid #333333">';l+='    <div style="width: 64px; height: 30px;" id="colorPickerMobileCurrent'+this.id+'"></div>';l+='    <div style="width: 64px; height: 30px;" id="colorPickerMobilePreview'+this.id+'"></div>';l+="  </div>";l+='  <div style="display: inline-block; margin-left: 10px" id="colorPickerMobileInfo'+this.id+'"></div>';l+="</div>";l+='<div style="text-align: center">';l+='<canvas id="colorPickerMobileCanvas'+this.id+'"></canvas>';l+="</div>";if(!this.canSelectMultiple){l+='<div style="position: absolute; left: 0px; right: 0px; bottom: 0px; height: 60px; background-color: #2f2f2f"></div>';l+='<div style="position: absolute; left: 7px; right: 7px; bottom: 10px; height: 42px; display: flex">';l+='  <div id="colorPickerTypeMobile_cell" data-type="cell" class="colorPickerTypeMobile"> <div class="colorPickerMobileColor"></div>Cell FG</div>';l+='  <div id="colorPickerTypeMobile_multi1" data-type="multi1" class="colorPickerTypeMobile colorPickerTypeMobileC64Multi"><div class="colorPickerMobileColor"></div>Multi 1</div>';l+='  <div id="colorPickerTypeMobile_multi2" data-type="multi2" class="colorPickerTypeMobile colorPickerTypeMobileC64Multi"><div class="colorPickerMobileColor"></div>Multi 2</div>';l+='  <div id="colorPickerTypeMobile_cellbg" data-type="cellbg" class="colorPickerTypeMobile colorPickerTypeMobileCellBG"><div class="colorPickerMobileColor"></div>Cell BG</div>';l+='  <div id="colorPickerTypeMobile_background" data-type="background" class="colorPickerTypeMobile"><div class="colorPickerMobileColor"></div>Frame</div>';l+='  <div id="colorPickerTypeMobile_border" data-type="border" class="colorPickerTypeMobile"><div class="colorPickerMobileColor"></div>Border</div>';l+="</div>";l+='<div style="margin-top: 14px" id="noColorMobileHolder">';l+='  <div class="ui-button" id="noColorMobile"><i class="halflings halflings-remove"></i> Transparent</div>';l+="</div>";l+='<div style="margin-top: 14px" id="c64ecmMobileHolder">';for(var n=0;n<4;n++){var h=n+1;var d=n;l+="<div>";l+='<label class="rb-container" style="margin-right: 4px"> ';l+='<div id="colorPickerECMColorBlockIndexMobile'+n+'" style="display: inline-block; width: 16px; height: 16px; background-color: #884433"></div>';l+="BG "+h;l+='<input type="radio" id="colorPickerECMColorIndexMobile'+n+'" name="colorPickerECMColorIndexMobile" value="'+d+'"';if(n===0){l+=' checked="checked" '}l+=">";l+='<span class="checkmark"/>';l+="</label>";l+="</div>"}l+="</div>"}else{l+='<div style="margin-top: 20px">';l+='<div class="ui-button" id="clearColorSelection">Clear Selection</div>';l+="</div>";this.okButton=UI.create("UI.Button",{text:"OK"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){if(i.closeHandler){console.log("close dialog");i.closeHandler()}UI.closeDialog()})}var c=UI.create("UI.HTMLPanel",{id:"colorPickerMobileHTML"+this.id,html:l});this.uiComponent.add(c);this.uiComponent.on("close",function(){});this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:"colorPickerMobileCanvas"+this.id,canSelectMultiple:this.canSelectMultiple,maxSelectableColors:1,canSelectWithRightMouseButton:false});this.colorPaletteDisplay.draw();this.initEvents()}this.setColorType(t);this.initColorTypes();UI.showDialog("colorPickerMobile"+this.id);var f=this.editor.colorPaletteManager.getCurrentColorPalette();this.c64ECMColorIndex=parseInt($("input[name=colorPickerECMColorIndexMobile]:checked").val(),10);var u=[];var p=f.getColorCount();for(var n=0;n<p;n++){u.push(f.getHex(n))}var v=f.getCurrentColorMap();var g=8;var m=8;if(v.length>0&&v[0].length>0){g=v[0].length;m=v.length}var y=34;var b=34;var C=4;if(g>12||m>12){y=20;b=20}if(typeof e.colors!="undefined"){this.colorPaletteDisplay.setSelectedColors(e.colors)}this.colorPaletteDisplay.setColorSize(y,b,C);this.colorPaletteDisplay.setColors(u,{colorMap:f.getCurrentColorMap()});var s=UI.getScreenWidth();var o=UI.getScreenHeight();var x=o-111-120;if(g>6&&s<800){this.colorPaletteDisplay.fitToWidth(s-24)}if(this.colorPaletteDisplay.getHeight()>x){console.log("setting max height");y=14;b=14;C=3;this.colorPaletteDisplay.setColorSize(y,b,C)}this.colorPaletteDisplay.draw();if(typeof e.currentColor!="undefined"){var f=this.editor.colorPaletteManager.getCurrentColorPalette();if(e.currentColor===false){return}var S=f.getHexString(e.currentColor);$("#colorPickerMobileCurrent"+this.id).css("background-color","#"+S)}this.updateColorPreviews()},updateC64ECMColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();for(var t=0;t<4;t++){var i=this.editor.getC64ECMColor(t);var r=e.getHexString(i);$("#colorPickerECMColorBlockIndexMobile"+t).css("background-color","#"+r)}},updateColorPreviews:function(){var e=0;var t="";var i=this.editor.colorPaletteManager.getCurrentColorPalette();this.updateC64ECMColors();e=this.editor.currentTile.getColor();t=i.getHexString(e);$("#colorPickerTypeMobile_cell .colorPickerMobileColor").css("background-color","#"+t);e=this.editor.graphic.getC64Multi1Color();t=i.getHexString(e);$("#colorPickerTypeMobile_multi1 .colorPickerMobileColor").css("background-color","#"+t);e=this.editor.graphic.getC64Multi2Color();t=i.getHexString(e);$("#colorPickerTypeMobile_multi2 .colorPickerMobileColor").css("background-color","#"+t);e=this.editor.currentTile.getBGColor();if(e!==this.editor.colorPaletteManager.noColor){t=i.getHexString(e);$("#colorPickerTypeMobile_cellbg .colorPickerMobileColor").css("background-color","#"+t);$("#colorPickerTypeMobile_cellbg .colorPickerMobileColor").html("")}else{$("#colorPickerTypeMobile_cellbg .colorPickerMobileColor").css("background-color","#000000");$("#colorPickerTypeMobile_cellbg .colorPickerMobileColor").css("color","#eeeeee");$("#colorPickerTypeMobile_cellbg .colorPickerMobileColor").css("text-align","center");$("#colorPickerTypeMobile_cellbg .colorPickerMobileColor").html('<i style="font-size: 12px; margin-top: 1px" class="halflings halflings-remove"></i>')}var r=this.editor.layers.getSelectedLayerObject();if(typeof r.getBackgroundColor!="undefined"){e=r.getBackgroundColor()}if(e!==this.editor.colorPaletteManager.noColor){t=i.getHexString(e);$("#colorPickerTypeMobile_background .colorPickerMobileColor").css("background-color","#"+t)}else{$("#colorPickerTypeMobile_background .colorPickerMobileColor").css("background-color","#000000");$("#colorPickerTypeMobile_background .colorPickerMobileColor").css("color","#eeeeee");$("#colorPickerTypeMobile_background .colorPickerMobileColor").css("text-align","center");$("#colorPickerTypeMobile_background .colorPickerMobileColor").html('<i style="font-size: 12px; margin-top: 1px" class="halflings halflings-remove"></i>')}e=this.editor.graphic.getBorderColor();if(e!==this.editor.colorPaletteManager.noColor){t=i.getHexString(e);$("#colorPickerTypeMobile_border .colorPickerMobileColor").css("background-color","#"+t)}else{$("#colorPickerTypeMobile_border .colorPickerMobileColor").css("background-color","#000000");$("#colorPickerTypeMobile_border .colorPickerMobileColor").css("color","#eeeeee");$("#colorPickerTypeMobile_border .colorPickerMobileColor").css("text-align","center");$("#colorPickerTypeMobile_border .colorPickerMobileColor").html('<i style="font-size: 12px; margin-top: 1px" class="halflings halflings-remove"></i>')}},initColorTypes:function(){var e=this.editor.getScreenMode();if(e==TextModeEditor.Mode.C64MULTICOLOR){$(".colorPickerTypeMobileC64Multi").show();$(".colorPickerTypeMobileCellBG").hide()}else{$(".colorPickerTypeMobileC64Multi").hide();$(".colorPickerTypeMobileCellBG").show()}if(this.editor.graphic.getType()=="sprite"){$("#colorPickerTypeMobile_border").hide()}else{$("#colorPickerTypeMobile_border").show()}},getSelectedColors:function(){return this.colorPaletteDisplay.getSelectedColors()},setC64ECMIndex:function(e){this.c64ECMColorIndex=e;this.editor.currentTile.setBGColor(e);console.log("set c64 ecm index: "+this.c64ECMColorIndex)},selectColor:function(e){var t=this.editor.getScreenMode();switch(this.colorType){case"cell":this.editor.currentTile.setColor(e);break;case"cellbg":if(t===TextModeEditor.Mode.C64ECM){console.log("set ecm colour "+this.c64ECMColorIndex+":"+e);this.editor.setC64ECMColor(this.c64ECMColorIndex,e);this.updateC64ECMColors()}else{this.editor.currentTile.setBGColor(e)}break;case"multi1":this.editor.setC64Multi1Color(e);break;case"multi2":this.editor.setC64Multi2Color(e);break;case"background":this.editor.setBackgroundColor(e);break;case"border":this.editor.setBorderColor(e);break}if(this.editor.tileEditorMobile){this.editor.tileEditorMobile.draw()}},setCurrentColor:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e){return}var t=false;switch(this.colorType){case"cell":t=this.editor.currentTile.getColor();break;case"cellbg":t=this.editor.currentTile.getBGColor();break;case"multi1":if(typeof e.getC64Multi1Color!="undefined"){t=e.getC64Multi1Color()}break;case"multi2":if(typeof e.getC64Multi2Color!="undefined"){t=e.getC64Multi2Color()}break;case"background":if(typeof e.getBackgroundColor!="undefined"){t=e.getBackgroundColor()}break;case"border":if(typeof e.getBorderColor!="undefined"){t=e.getBorderColor()}break}var i=this.editor.colorPaletteManager.getCurrentColorPalette();if(t===this.editor.colorPaletteManager.noColor){var r="000000";$("#colorPickerMobileCurrent"+this.id).css("background-color","#"+r)}else{var r=i.getHexString(t);$("#colorPickerMobileCurrent"+this.id).css("background-color","#"+r)}},setColorType:function(e){if(e=="cellcolor"){e="cell"}this.colorType=e;var t=this.editor.getScreenMode();$("#noColorMobileHolder").hide();$("#c64ecmMobileHolder").hide();var i="";switch(e){case"cell":i="Cell FG Colour";break;case"cellbg":i="Cell BG Colour";if(t===TextModeEditor.Mode.C64ECM){$("#noColorMobileHolder").hide();$("#c64ecmMobileHolder").show()}else{$("#noColorMobileHolder").show()}break;case"background":i="Frame Background Colour";$("#noColorMobileHolder").show();break;case"border":i="Border Colour";$("#noColorMobileHolder").show();break;case"multi1":i="Multi Colour 1";break;case"multi2":i="Multi Colour 2";break}$("#colorPickerMobileHeading").html(i);$(".colorPickerTypeMobile").removeClass("colorPickerTypeMobileSelected");$("#colorPickerTypeMobile_"+e).addClass("colorPickerTypeMobileSelected");if(e=="cell"){this.colorPaletteDisplay.setType("cellcolor")}else{this.colorPaletteDisplay.setType(e)}this.colorPaletteDisplay.draw();this.setCurrentColor()},displayInfo:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();if(e===false){return}var i=e;var r=this.editor.getScreenMode();if(r===TextModeEditor.Mode.C64MULTICOLOR&&e>=8&&this.colorType=="cell"&&this.editor.graphic.getType()!="sprite"){i-=8}var a=t.getHexString(e);var s=t.getHexString(i);$("#colorPickerMobilePreview"+this.id).css("background-color","#"+s);var o="";o+="<div>Index: "+e+"</div>";o+="<div>Hex Index: "+("00"+e.toString(16)).substr(-2)+"</div>";o+="<div>RGB: #"+a+"</div>";o+="<div>";$("#colorPickerMobileInfo"+this.id).html(o)}};var ChooseColorsDialog=function(){this.editor=null;this.canvas=null;this.context=null;this.callback=null;this.colorChosen=[];this.uiComponent=null;this.colorPaletteDisplay=null;this.mouseMode=""};ChooseColorsDialog.prototype={init:function(e){this.editor=e},initColorPaletteDisplay:function(){var t=this;if(this.colorPaletteDisplay==null){this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:"chooseColorsCanvas",canSelectWithRightMouseButton:false,canSelectMultiple:true});this.colorPaletteDisplay.on("colorselected",function(e){if(e.colorIndex==0){var t=e.color}});this.colorPaletteDisplay.on("highlightchanged",function(e){t.highlightedColor=e.color})}},show:function(e){this.message=false;if(typeof e.message!="undefined"){this.message=e.message}if(this.uiComponent==null){var t=this;this.callback=false;var i='<div class="panelFill">';i+='<div id="chooseColorsMessage"></div>';i+='<div style="padding: 2px">';i+='<canvas width="144" height="36" id="chooseColorsCanvas" style="background-color: #222222"></canvas>';i+='<div style="padding-top: 2px">';i+='<div class="ui-button" id="chooseColorsClearSelection">Clear Selection</div>';i+="</div>";i+="</div>";i+="</div>";this.uiComponent=UI.create("UI.Dialog",{id:"chooseColorsDialog",title:"Choose Colors",width:200});this.htmlComponent=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.add(this.htmlComponent);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){if(t.callback){t.callback(t.colorPaletteDisplay.getSelectedColors())}UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.initContent(e);this.initEvents()}else{this.initContent(e)}UI.showDialog("chooseColorsDialog")},initContent:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();for(var i=0;i<t.getColorCount();i++){this.colorChosen[i]=false}if(this.colorPaletteDisplay==null){this.initColorPaletteDisplay()}var r=[];var a=t.getColorCount();for(var i=0;i<a;i++){r.push(t.getHex(i))}var s=t.getCurrentColorMap();var o=8;var l=8;if(s.length>0&&s[0].length>0){o=s[0].length;l=s.length}var n=26;var h=26;if(o>12||l>12){n=20;h=20}this.colorPaletteDisplay.setColorSize(n,h);this.colorPaletteDisplay.setColors(r,{colorMap:t.getCurrentColorMap()});if(typeof e!="undefined"){if(typeof e.callback!="undefined"){this.callback=e.callback}if(typeof e.colors!="undefined"){var t=this.editor.colorPaletteManager.getCurrentColorPalette();this.colorPaletteDisplay.setSelectedColors(e.colors)}}var d=this.colorPaletteDisplay.getWidth();var c=this.colorPaletteDisplay.getHeight();var f=d+8+6;if(f<180){f=180}var u=c+78+6;if(this.message!==false){$("#chooseColorsMessage").html(this.message);$("#chooseColorsMessage").show();u+=20}else{$("#chooseColorsMessage").html("");$("#chooseColorsMessage").hide()}UI("chooseColorsDialog").setWidth(f);UI("chooseColorsDialog").setHeight(u)},clearSelection:function(){this.colorPaletteDisplay.setSelectedColors([]);this.colorPaletteDisplay.draw()},initEvents:function(){var t=this;$("#chooseColorsClearSelection").on("click",function(e){t.clearSelection()})}};var ColorPalettePanel=function(){this.colorPaletteDisplay=null;this.colorPaletteWidth=false;this.scrollbar=null;this.colorRecentIndex=0;this.maxColorSize=30;this.layout=""};ColorPalettePanel.prototype={init:function(e){this.editor=e},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.HTMLPanel",{id:"colorPalettePanel"});UI.on("ready",function(){t.colorPaletteResize();t.uiComponent.load("html/textMode/colorPalettePanel.html",function(){t.initEvents();if(!Modernizr.cssscrollbar){t.scrollbar=new PerfectScrollbar("#colorPaletteHolder")}})});this.uiComponent.on("resize",function(){t.colorPaletteResize()});e.add(this.uiComponent)},setSelectedColor:function(e,t){var i=this.editor.getScreenMode();if(i==TextModeEditor.Mode.NES){var r=t;var a=this.editor.colorPaletteManager.colorSubPalettes.getCurrentPaletteColor();if(typeof a!=="undefined"){t=this.editor.colorPaletteManager.colorSubPalettes.getPaletteColor(r,a)}}if(this.colorPaletteDisplay){this.colorPaletteDisplay.setSelectedColor(e,t);if(e==0&&t!=this.editor.colorPaletteManager.noColor){this.setColorInfo(t)}}},initEvents:function(){var r=this;this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:"colorPalettePanelCanvas",canSelectWithRightMouseButton:true});this.colorPaletteDisplay.setType("cellcolor");this.colorPaletteDisplay.on("colorselected",function(e){r.colorSelected(e.colorIndex,e.color)});this.colorPaletteDisplay.on("highlightchanged",function(e){if(e.color!==r.editor.colorPaletteManager.noColor){r.setColorInfo(e.color)}else{r.setColorInfo(r.colorPaletteDisplay.getSelectedColor(0))}});this.colorPaletteDisplay.on("doubleclick",function(e){r.editor.showColorEditor()});$("#chooseColorPaletteButton").on("click",function(){r.editor.colorPaletteManager.showChoosePreset({})});$("#editColorPaletteButton").on("click",function(){r.editor.editColorPalette()});$("#loadColorPaletteButton").on("click",function(){r.editor.colorPaletteManager.showLoad({})});$("#colorPaletteSortOrder").on("change",function(){var e=$(this).val();r.sortPalette(e)});$(".colorPalettePanelSubPaletteColor").on("click",function(){var e=parseInt($(this).attr("data-subpalette"),10);var t=parseInt($(this).attr("data-color"),10);r.selectSubPaletteColor(e,t)});$(".colorPalettePanelSubPaletteColor").on("mouseover",function(){var e=parseInt($(this).attr("data-subpalette"),10);var t=parseInt($(this).attr("data-color"),10);var i=r.editor.colorPaletteManager.colorSubPalettes.getPaletteColor(e,t);r.setColorInfo(i);r.colorPaletteDisplay.setHighlightColor(i)});$(".colorPalettePanelSubPaletteColor").on("mouseout",function(){var e=r.colorPaletteDisplay.getSelectedColor(0);if(typeof e!="undefined"&&e!==false&&e!==r.editor.colorPaletteManager.noColor){r.setColorInfo(e)}r.colorPaletteDisplay.setHighlightColor(r.editor.colorPaletteManager.noColor)});$("#colorPaletteCloseButton").on("click",function(){r.editor.setColorPalettePanelVisible(false)});this.colorPaletteUpdate()},colorSelected:function(e,t){var i=this.editor.getScreenMode();if(i==TextModeEditor.Mode.NES){var r=this.editor.colorPaletteManager.colorSubPalettes.getCurrentPalette();var a=this.editor.colorPaletteManager.colorSubPalettes.getCurrentPaletteColor();this.editor.colorPaletteManager.colorSubPalettes.setColor(a,t);this.editor.currentTile.setColor(r,{force:true})}else{if(e==0){this.editor.currentTile.setColor(t)}if(e==1){if(i==TextModeEditor.Mode.C64STANDARD){this.editor.currentTile.setBGColor(this.editor.colorPaletteManager.noColor)}else if(i==TextModeEditor.Mode.C64ECM){var s=this.editor.currentTile.getBGColor();this.editor.setC64ECMColor(s,t)}else{this.editor.currentTile.setBGColor(t)}}}},setSubPalettesVisible:function(e){if(e){this.layout="subpalettes";$("#colorPalettePanelSubPalettes").show();$("#colorPalettePanelInfoHolder").css("top","82px");$("#colorPaletteHolder").css("top","106px");var t=UI("eastInfoPanel").getPanelSize({panel:"south"});if(t<210){UI("eastInfoPanel").resizeThePanel({panel:"south",size:210})}}else{this.layout="";$("#colorPalettePanelSubPalettes").hide();$("#colorPalettePanelInfoHolder").css("top","22px");$("#colorPaletteHolder").css("top","46px")}},selectSubPaletteColor:function(e,t){this.editor.colorPaletteManager.colorSubPalettes.selectPalette(e,t);this.editor.colorPaletteManager.colorSubPalettes.selectPaletteColor(t)},highlightSubPaletteColor:function(){$(".colorPalettePanelSubPaletteColor").removeClass("colorPalettePanelSubPaletteColor-selected");var e=this.editor.colorPaletteManager.colorSubPalettes.getCurrentPalette();var t=this.editor.colorPaletteManager.colorSubPalettes.getCurrentPaletteColor();$("#colorPalettePanelSubPalette"+e+"-Color"+t).addClass("colorPalettePanelSubPaletteColor-selected");this.updateSubPaletteColors()},updateSubPaletteColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();var t=this.editor.colorPaletteManager.colorSubPalettes;var i=t.getPaletteCount();var r=t.getPaletteColorCount();for(var a=0;a<i;a++){for(var s=0;s<r;s++){var o=t.getPaletteColor(a,s);var l=e.getHexString(o);$("#colorPalettePanelSubPalette"+a+"-Color"+s).css("background-color","#"+l);$("#colorPalettePanelSubPalette"+a+"-Color"+s).css("border-color","#"+l)}}$(".colorPalettePanelSubPaletteColor-selected").css("border-color","#888888")},sortPalette:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();if(t.setCurrentColorMap(e)===false){t.setSortOrderMethod(e)}this.colorPaletteDisplay.setColorMap(t.getCurrentColorMap());this.colorPaletteDisplay.draw()},setColorInfo:function(e){var t=e;if(this.editor.getScreenMode()==TextModeEditor.Mode.C64MULTICOLOR&&t>=8&&this.editor.graphic.getType()!=="sprite"){t-=8}var i=this.editor.colorPaletteManager.getCurrentColorPalette();if(!i){return}var r=i.getHexString(t);$("#colorPalettePanelInfoColor").css("background-color","#"+r);$("#colorPalettePanelInfoColorDec").html(e);$("#colorPalettePanelInfoColorHex").html("0x"+("00"+e.toString(16)).substr(-2));$("#colorPalettePanelInfoColorRGB").html("#"+r)},keyDown:function(e){switch(e.keyCode){case keys.textMode.colorPaletteLeft.keyCode:if(keys.textMode.colorPaletteLeft.shift==e.shiftKey){this.moveSelection(-1,0)}break;case keys.textMode.colorPaletteRight.keyCode:if(keys.textMode.colorPaletteRight.shift==e.shiftKey){this.moveSelection(1,0)}break;case keys.textMode.colorPaletteUp.keyCode:if(keys.textMode.colorPaletteRight.shift==e.shiftKey){this.moveSelection(0,-1)}break;case keys.textMode.colorPaletteDown.keyCode:if(keys.textMode.colorPaletteDown.shift==e.shiftKey){this.moveSelection(0,1)}break;case keys.textMode.colorPaletteRecentNext.keyCode:if(keys.textMode.colorPaletteRecentNext.shift==e.shiftKey){this.selectRecent(1)}break;case keys.textMode.colorPaletteRecentPrev.keyCode:if(keys.textMode.colorPaletteRecentPrev.shift==e.shiftKey){this.selectRecent(-1)}break}},keyUp:function(e){},keyPress:function(e){},moveSelection:function(e,t){this.colorPaletteDisplay.moveSelection(e,t)},selectRecent:function(e){var t=this.colorRecentIndex-e;if(t<0){t=0}if(t>=this.editor.currentTile.recentColors.length){t=this.editor.currentTile.recentColors.length-1}this.colorRecentIndex=t;var i=this.editor.currentTile.recentColors[this.editor.currentTile.recentColors.length-1-t];if(typeof i!="undefined"){this.editor.currentTile.setColor(i)}},colorPaletteUpdate:function(e){if(!this.colorPaletteDisplay){return}var t=true;if(typeof e!="undefined"){if(typeof e.updateMap!="undefined"){t=e.updateMap}}var i=this.editor.colorPaletteManager.getCurrentColorPalette();if(i==null){return}var r=[];var a=i.getColorCount();for(var s=0;s<a;s++){r.push(i.getHex(s)&16777215)}var o=i.getColorsAcross();this.colorPaletteDisplay.setColors(r,{colorsAcross:o});if(t){var l=$("#colorPaletteSortOrder").val();var n=[{value:"source",label:"Colour Index"},{value:"hls",label:"Hue"},{value:"saturation",label:"Saturation"},{value:"brightness",label:"Brightness"},{value:"red",label:"Red"},{value:"green",label:"Green"},{value:"blue",label:"Blue"}];var h="";var d=i.getColorPaletteMaps();for(var s=0;s<d.length;s++){h+='<option value="'+d[s].id+'">'+d[s].name+"</option>"}if(d.length==1){l=d[0].id}if(d.length==0){h+='<option value="default">Default Layout</option>'}for(var s=0;s<n.length;s++){h+='<option value="'+n[s].value+'">'+n[s].label+"</option>"}$("#colorPaletteSortOrder").html(h);$("#colorPaletteSortOrder").val(l);$("#colorPaletteSortOrder").hide();this.sortPalette(l)}this.colorPaletteWidth=false;this.colorPaletteResize();this.colorPaletteDisplay.draw();var c=this.editor.getScreenMode();if(c==TextModeEditor.Mode.NES){if(this.layout!=="subpalettes"){this.setSubPalettesVisible(true)}this.updateSubPaletteColors()}else{if(this.layout=="subpalettes"){this.setSubPalettesVisible(false)}}},getSortMethod:function(){return $("#colorPaletteSortOrder").val()},colorPaletteResize:function(){var e=$("#colorPaletteHolder").width();if(typeof e=="undefined"||e<0){e=227}if(this.colorPaletteWidth!=e){this.colorPaletteWidth=e;if(this.colorPaletteDisplay){var t=this.editor.colorPaletteManager.getCurrentColorPalette();if(t){this.colorPaletteDisplay.setMaxColorWidth(30);this.colorPaletteDisplay.fitToWidth(e)}}}if(this.scrollbar){this.scrollbar.update()}}};var ColorEditor=function(){this.uiComponent=null;this.rSliderCanvas=null;this.gSliderCanvas=null;this.bSliderCanvas=null;this.hSliderCanvas=null;this.sSliderCanvas=null;this.vSliderCanvas=null;this.colorIndex=false;this.visible=false;this.saveSouthSize=false;this.colorType="hsv"};ColorEditor.prototype={init:function(e){this.editor=e},getVisible:function(){return this.visible},setVisible:function(e){this.visible=e;if(e){if(!this.editor.getColorPalettePanelVisible()){this.editor.setColorPalettePanelVisible(true)}}UI("colorSplitPanel").setPanelVisible("south",this.visible);var t=UI("textModeEastPanel").getPanelSize({panel:"south"});var i=230;if(this.visible){this.saveSouthSize=t;var r=t;if(r<340){r=340}UI("textModeEastPanel").resizeThePanel({panel:"south",size:r});UI("colorSplitPanel").resizeThePanel({panel:"south",size:i})}else{var r=t;if(this.saveSouthSize!==false){r=this.saveSouthSize}UI("textModeEastPanel").resizeThePanel({panel:"south",size:r});UI("colorSplitPanel").resizeThePanel({panel:"south",size:0})}if(UI.exists("color-edit")){if(e){UI("color-edit").setLabel("Hide Colour Editor")}else{UI("color-edit").setLabel("Show Colour Editor")}}},toggleVisible:function(){this.setVisible(!this.visible)},buildInterface:function(e){var t=this;var i="colour editor";this.uiComponent=UI.create("UI.HTMLPanel",{id:"colorEditorPanel"});UI.on("ready",function(){t.uiComponent.load("html/textMode/colorEditor.html",function(){t.htmlComponentLoaded()})});this.uiComponent.on("resize",function(){});e.add(this.uiComponent)},htmlComponentLoaded:function(){this.rSliderCanvas=document.getElementById("editColorRCanvas");this.gSliderCanvas=document.getElementById("editColorGCanvas");this.bSliderCanvas=document.getElementById("editColorBCanvas");this.hSliderCanvas=document.getElementById("editColorHCanvas");this.sSliderCanvas=document.getElementById("editColorSCanvas");this.vSliderCanvas=document.getElementById("editColorVCanvas");this.initEvents()},initEvents:function(){var s=this;$(".colorEditorNumber").on("change",function(e){var t=$(this).val();if(t==""){t="0"}t=parseInt(t,10);var i=$(this).attr("data-component");if(!isNaN(t)){switch(i){case"r":s.setR(t);break;case"g":s.setG(t);break;case"b":s.setB(t);break;case"h":s.setH(t);break;case"s":s.setS(t);break;case"v":s.setV(t);break}}});$(".colorEditorNumber").on("keyup",function(e){var t=parseInt($(this).val(),10);if(!isNaN(t)){var i=$(this).attr("data-component");switch(i){case"r":s.setR(t);break;case"g":s.setG(t);break;case"b":s.setB(t);break;case"h":s.setH(t);break;case"s":s.setS(t);break;case"v":s.setV(t);break}}});$(".colorEditorSlider").on("mousedown",function(e){var t=e.pageX-$(this).offset().left;var i=e.pageY-$(this).offset().top;var r=$(this).attr("data-component");switch(r){case"r":var a=Math.floor(255*(t/$(this).width()));s.setR(a);break;case"g":var a=Math.floor(255*(t/$(this).width()));s.setG(a);break;case"b":var a=Math.floor(255*(t/$(this).width()));s.setB(a);break;case"h":var a=Math.floor(360*(t/$(this).width()));s.setH(a);break;case"s":var a=Math.floor(100*(t/$(this).width()));s.setS(a);break;case"v":var a=Math.floor(100*(t/$(this).width()));s.setV(a);break}s.activeSlider=this;UI.captureMouse(s)});$("#editColorHex").on("keyup",function(){s.setColorFromHex()});$("#editColorHex").on("change",function(){s.setColorFromHex()});$(".colorEditorTab").on("click",function(){var e=$(this).attr("data-colortype");s.setColorType(e)});$("#colorEditorCloseButton").on("click",function(){s.editor.toggleColorEditor()})},setColorType:function(e){this.colorType=e;if(e=="rgb"){$("#colorEditorRGB").show();$("#colorEditorHSV").hide();$("#colorEditorTab-rgb").addClass("colorEditorTabActive");$("#colorEditorTab-hsv").removeClass("colorEditorTabActive")}if(e=="hsv"){$("#colorEditorRGB").hide();$("#colorEditorHSV").show();$("#colorEditorTab-hsv").addClass("colorEditorTabActive");$("#colorEditorTab-rgb").removeClass("colorEditorTabActive")}},mouseMoveSlider:function(e){var t=e.pageX-$(this.activeSlider).offset().left;var i=e.pageY-$(this.activeSlider).offset().top;var r=$(this.activeSlider).attr("data-component");var a=0;if(r=="r"||r=="g"||r=="b"){a=Math.floor(255*(t/$(this.activeSlider).width()));if(a>255){a=255}if(a<0){a=0}}if(r=="h"){a=Math.floor(360*(t/$(this.activeSlider).width()));if(a>360){a=360}if(a<0){a=0}}if(r=="s"||r=="v"){a=Math.floor(100*(t/$(this.activeSlider).width()));if(a>100){a=100}if(a<0){a=0}}switch(r){case"r":this.setR(a);break;case"g":this.setG(a);break;case"b":this.setB(a);break;case"h":this.setH(a);break;case"s":this.setS(a);break;case"v":this.setV(a);break}},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){this.buttons=2}if(e.metaKey&&this.buttons==1){this.buttons=4}},mouseMove:function(e){if(this.activeSlider!==false){this.mouseMoveSlider(e)}},mouseUp:function(e){this.mouseDownOnImage=false;this.activeSlider=false;if(!UI.isMobile.any()){this.setButtons(e)}else{this.buttons=0}if(this.buttons&1){this.leftMouseUp=false}else{this.leftMouseUp=true}},setR:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.r=e;this.setRGB();this.updateHex();this.updatePaletteColor()},setG:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.g=e;this.setRGB();this.updateHex();this.updatePaletteColor()},setB:function(e){e=parseInt(e);if(isNaN(e)){return}this.b=e;this.setRGB();this.updateHex();this.updatePaletteColor()},setH:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.h=e;this.setHSV();this.updateHex();this.updatePaletteColor()},setS:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.s=e;this.setHSV();this.updateHex();this.updatePaletteColor()},setV:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.v=e;this.setHSV();this.updateHex();this.updatePaletteColor()},updateHSVSlider:function(e,t){var i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);var r=i.getImageData(0,0,e.width,e.height);var a=e.height-4;for(var s=0;s<a;s++){for(var o=0;o<e.width;o++){var l=o/e.width;var n=(s*e.width+o)*4;var h=Math.floor(t.fromH+(t.toH-t.fromH)*l);var d=Math.floor(t.fromS+(t.toS-t.fromS)*l);var c=Math.floor(t.fromV+(t.toV-t.fromV)*l);var f=hsv2rgb(h,d/100,c/100);r.data[n]=Math.round(f[0]);r.data[n+1]=Math.round(f[1]);r.data[n+2]=Math.round(f[2]);r.data[n+3]=255}}i.putImageData(r,0,0);var u=t.value*e.width;i.globalAlpha=.6;i.strokeStyle="#ffffff";i.beginPath();i.moveTo(u,0);i.lineTo(u,e.height);i.stroke();i.globalAlpha=1;i.fillStyle="#ffffff";i.beginPath();i.moveTo(u,a);i.lineTo(u+2,e.height);i.lineTo(u-2,e.height);i.fill()},updateHSVSliders:function(){if(this.hSliderCanvas){this.updateHSVSlider(this.hSliderCanvas,{fromH:0,toH:360,fromS:this.s,toS:this.s,fromV:this.v,toV:this.v,value:this.h/360})}if(this.sSliderCanvas){this.updateHSVSlider(this.sSliderCanvas,{fromH:this.h,toH:this.h,fromS:0,toS:100,fromV:this.v,toV:this.v,value:this.s/100})}if(this.vSliderCanvas){this.updateHSVSlider(this.vSliderCanvas,{fromH:this.h,toH:this.h,fromS:this.s,toS:this.s,fromV:0,toV:100,value:this.v/100})}},updateRGBSlider:function(e,t){if(!e){return}var i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);var r=i.getImageData(0,0,e.width,e.height);var a=e.height-4;for(var s=0;s<a;s++){for(var o=0;o<e.width;o++){var l=o/e.width;var n=(s*e.width+o)*4;var h=Math.floor(t.fromR+(t.toR-t.fromR)*l);var d=Math.floor(t.fromG+(t.toG-t.fromG)*l);var c=Math.floor(t.fromB+(t.toB-t.fromB)*l);r.data[n]=h;r.data[n+1]=d;r.data[n+2]=c;r.data[n+3]=255}}i.putImageData(r,0,0);var f=t.value/255*e.width;i.strokeStyle="#ffffff";i.beginPath();i.moveTo(f,0);i.lineTo(f,a);i.stroke();i.fillStyle="#ffffff";i.beginPath();i.moveTo(f,a);i.lineTo(f+2,e.height);i.lineTo(f-2,e.height);i.fill()},updateRGBSliders:function(){this.updateRGBSlider(this.rSliderCanvas,{fromR:0,toR:255,fromG:this.g,toG:this.g,fromB:this.b,toB:this.b,value:this.r});this.updateRGBSlider(this.gSliderCanvas,{fromR:this.r,toR:this.r,fromG:0,toG:255,fromB:this.b,toB:this.b,value:this.g});this.updateRGBSlider(this.bSliderCanvas,{fromR:this.r,toR:this.r,fromG:this.g,toG:this.g,fromB:0,toB:255,value:this.b})},setHSV:function(){var e=hsv2rgb(this.h,this.s/100,this.v/100);this.r=Math.round(e[0]);this.g=Math.round(e[1]);this.b=Math.round(e[2]);this.rgb=((this.r&255)<<16)+((this.g&255)<<8)+(this.b&255);this.updateColorSliders()},setColor:function(e){var t=this.editor.getScreenMode();if(t==TextModeEditor.Mode.NES){var i=e;var r=this.editor.colorPaletteManager.colorSubPalettes.getCurrentPaletteColor();if(typeof r!=="undefined"){e=this.editor.colorPaletteManager.colorSubPalettes.getPaletteColor(i,r)}}this.colorIndex=e;var a=this.editor.colorPaletteManager.getCurrentColorPalette();if(!a){return}var s=a.getHex(e);this.setRGB(s);this.updateHex()},updatePaletteColor:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();e.setColorRGB(this.colorIndex,this.rgb);this.editor.currentTile.setColor(this.colorIndex,{force:true,update:false});this.editor.colorPalettePanel.colorPaletteUpdate({updateMap:false});this.editor.graphic.invalidateAllCells();var t="textmode";if(g_app.getPref(t+".tilePaletteVisible")!="no"){this.editor.tools.drawTools.tilePalette.drawTilePalette({redrawTiles:true})}if(g_app.getPref(t+".sideTilePaletteVisible")=="yes"){this.editor.sideTilePalette.drawTilePalette({redrawTiles:true})}if(g_newSystem){this.editor.gridView2d.draw()}else{this.editor.grid.update()}},setRGB:function(e){if(typeof e=="undefined"){this.rgb=((this.r&255)<<16)+((this.g&255)<<8)+(this.b&255)}else{this.rgb=e;this.r=(e&16711680)>>16;this.g=e>>8&255;this.b=e&255}this.rgb=((this.r&255)<<16)+((this.g&255)<<8)+(this.b&255);var t=false;if(this.colorType=="hsv"){var i=hsv2rgb(this.h,this.s/100,this.v/100);var r=Math.round(i[0]);var a=Math.round(i[1]);var s=Math.round(i[2]);i=((r&255)<<16)+((a&255)<<8)+(s&255);if(i==e){t=true}}if(!t){var o=rgb2hsv(this.r,this.g,this.b);this.h=Math.round(o[0]*360);this.s=Math.round(o[1]*100);this.v=Math.round(o[2]*100)}this.updateColorSliders()},setColorFromHex:function(){var e=$("#editColorHex").val();e=parseInt(e,16);if(isNaN(e)){return}this.setRGB(e);this.updatePaletteColor()},updateHex:function(){if(!$("#editColorHex").is(":focus")){var e=("000000"+this.rgb.toString(16)).substr(-6);$("#editColorHex").val(e)}},updateColorSliders:function(){$("#editColorR").val(this.r);$("#editColorG").val(this.g);$("#editColorB").val(this.b);$("#editColorH").val(this.h);$("#editColorS").val(this.s);$("#editColorV").val(this.v);this.updateRGBSliders();this.updateHSVSliders()}};var ColorPaletteEditor=function(){this.doc=null;this.uiComponent=null;this.colorPaletteEdit=null};ColorPaletteEditor.prototype={init:function(){},buildInterface:function(e){if(this.uiComponent!=null){return}this.uiComponent=UI.create("UI.Panel",{id:"colorPaletteEditor"});e.add(this.uiComponent);this.colorPaletteEdit=new ColorPaletteEdit;this.colorPaletteEdit.init(g_app.textModeEditor);this.colorPaletteEdit.buildInterface(this.uiComponent)},draw:function(){this.load(this.path)},load:function(e){var t=g_app.textModeEditor.colorPaletteManager;this.path=e;var i=g_app.doc.getDocRecord(e);if(i!=null){this.doc=i;t.setCurrentColorPaletteFromId(this.doc.id);this.colorPaletteEdit.setAutosave(true);this.colorPaletteEdit.setToCurrentPalette()}}};function xy2polar(e,t){var i=Math.sqrt(e*e+t*t);var r=Math.atan2(t,e);return[i,r]}function polar2xy(e,t){var i=e*Math.cos(t);var r=e*Math.sin(t);return[i,r]}function rad2deg(e){return(e+Math.PI)/(2*Math.PI)*360}function hsv2rgb(e,t,i){var r=i*t;var a=e/60;var s=r*(1-Math.abs(a%2-1));var o,l,n;if(a>=0&&a<=1){o=r;l=s;n=0}else if(a>=1&&a<=2){o=s;l=r;n=0}else if(a>=2&&a<=3){o=0;l=r;n=s}else if(a>=3&&a<=4){o=0;l=s;n=r}else if(a>=4&&a<=5){o=s;l=0;n=r}else if(a>=5&&a<=6){o=r;l=0;n=s}var h=i-r;var d=o+h;var c=l+h;var f=n+h;return[255*d,255*c,255*f]}function rgb2hsv(e,t,i){e/=255,t/=255,i/=255;var r=Math.max(e,t,i),a=Math.min(e,t,i);var s,o,l=r;var n=r-a;o=r==0?0:n/r;if(r==a){s=0}else{switch(r){case e:s=(t-i)/n+(t<i?6:0);break;case t:s=(i-e)/n+2;break;case i:s=(e-t)/n+4;break}s/=6}return[s,o,l]}var ColorPaletteEdit=function(){this.editor=null;this.uiComponent=null;this.prefix="colorPaletteEdit";this.colorPaletteDisplay=null;this.colorWidth=16;this.colorHeight=16;this.colorSpacing=2;this.colorsAcross=16;this.colorsDown=16;this.colors=[];this.imageColors=[];this.colorCount=16;this.imagePaletteCanvas=null;this.importImage=null;this.imageCanvas=null;this.imageCanvasScale=null;this.imageScale=1;this.imageX=0;this.imageY=0;this.colorWheelCanvas=null;this.colorWheelContext=null;this.imageMouseDownX=false;this.imageMouseDownY=false;this.imageData=null;this.highlightColor=0;this.selectedColor=0;this.mouseDownOnImage=false;this.mouseDownX=0;this.mouseDownY=0;this.currentOffsetX=0;this.currentOffsetY=0;this.gridMouseDownX=0;this.gridMouseDownY=0;this.colorSelectionMethod="rgb";this.rSliderCanvas=null;this.gSliderCanvas=null;this.bSliderCanvas=null;this.hSliderCanvas=null;this.sSliderCanvas=null;this.vSliderCanvas=null;this.activeSlider=false;this.gridWidth=16;this.gridHeight=16;this.currentTool="pen";this.visible=false;this.buttons=0;this.leftMouseUp=true;this.history=[];this.historyPosition=0;this.colorsChanged=false;this.colorMap=[];this.saveMap=[];this.ramps=[];this.rampFromGridX=false;this.rampFromGridY=false;this.rampToGridX=false;this.rampToGridY=false;this.exportCanvas=null;this.paramGraph=null;this.graphParam="red";this.colorPaletteLoadFromURL=null;this.selectedColorWheelColorX=false;this.selectedColorWheelColorY=false;this.colourWheelMouseIsDown=false;this.colorWheelImage=null;this.colorWheelValueCanvas=null;this.colorWheelValue=1;this.autosave=false;this.h=0;this.s=100;this.v=100};ColorPaletteEdit.prototype={init:function(e){this.editor=e},htmlComponentLoaded:function(){this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:this.prefix+"Canvas",gridLinesVisible:true,selectEnabled:false,highlightEnabled:false});this.colorPaletteDisplay.setColorSize(24,24,0);this.paramGraph=new ParamGraph;this.paramGraph.init({canvasElementId:this.prefix+"Graph"});this.paramGraph.on("paramchanged",function(e,t){o.paramChanged(e,t)});this.paramGraph.on("mouseup",function(e){o.paramGraphMouseUp(e)});var o=this;this.colorPaletteDisplay.on("colorselected",function(e){o.colorSelected(e.color)});this.colorPaletteDisplay.on("highlightchanged",function(e){o.colorHighlighted(e.color)});this.colorPaletteDisplay.on("mousemove",function(e,t,i){o.gridMouseMove(e,t,i)});this.colorPaletteDisplay.on("mousedown",function(e,t,i){o.gridMouseDown(e,t,i)});this.colorPaletteDisplay.on("mouseup",function(e,t,i){o.gridMouseUp(e,t,i)});this.colorPaletteDisplay.on("mouseenter",function(e){o.gridMouseEnter(e)});this.colorPaletteDisplay.on("mouseleave",function(e){o.gridMouseLeave(e)});this.colorPaletteDisplay.on("enddrag",function(e,t,i,r){o.gridEndDrag(e,t,i,r)});this.colorPaletteDisplay.on("endmarqueedrag",function(e,t,i,r,a,s){o.gridEndMarqueeDrag(e,t,i,r,a,s)});this.colorPaletteDisplay.on("marqueechanged",function(e,t,i,r){o.marqueeChanged(e,t,i,r)});this.imageCanvas=document.getElementById(this.prefix+"FromImageImage");this.imageCanvas.style.width=16*(this.colorWidth+this.colorSpacing)+this.colorSpacing+"px";this.imageCanvas.style.height=12*(this.colorHeight+this.colorSpacing)+this.colorSpacing+"px";this.imageCanvas.width=16*(this.colorWidth+this.colorSpacing)+this.colorSpacing;this.imageCanvas.height=12*(this.colorHeight+this.colorSpacing)+this.colorSpacing;this.imageContext=this.imageCanvas.getContext("2d");this.imageContext.imageSmoothingEnabled=false;this.imageContext.webkitImageSmoothingEnabled=false;this.imageContext.mozImageSmoothingEnabled=false;this.imageContext.msImageSmoothingEnabled=false;this.imageContext.oImageSmoothingEnabled=false;this.imagePaletteCanvas=document.getElementById(this.prefix+"FromImagePalette");this.imagePaletteCanvas.style.width=16*(this.colorWidth+this.colorSpacing)+this.colorSpacing+"px";this.imagePaletteCanvas.style.height=1*(this.colorHeight+this.colorSpacing)+this.colorSpacing+"px";this.imagePaletteCanvas.width=16*(this.colorWidth+this.colorSpacing)+this.colorSpacing;this.imagePaletteCanvas.height=1*(this.colorHeight+this.colorSpacing)+this.colorSpacing;this.rSliderCanvas=document.getElementById(this.prefix+"RCanvas");this.gSliderCanvas=document.getElementById(this.prefix+"GCanvas");this.bSliderCanvas=document.getElementById(this.prefix+"BCanvas");this.hSliderCanvas=document.getElementById(this.prefix+"HCanvas");this.sSliderCanvas=document.getElementById(this.prefix+"SCanvas");this.vSliderCanvas=document.getElementById(this.prefix+"VCanvas");this.initEvents();this.initColors()},setColorPaletteTool:function(e){if(e=="select"){$("#"+this.prefix+" .colorPaletteSelectionMethod").hide();$("#"+this.prefix+" .colorPaletteEditorDrawColor").hide();$("#"+this.prefix+" .editColorPaletteChooseMethod").hide();$("#"+this.prefix+"GraphHolder").show();this.paramGraph.draw();this.setStartEndColors()}else if(this.currentTool=="select"&&e!="select"){$("#"+this.prefix+" .colorPaletteSelectionMethod").hide();$("#"+this.prefix+"SelectionMethod_"+this.colorSelectionMethod).show();$("#"+this.prefix+" .colorPaletteEditorDrawColor").show();$("#"+this.prefix+" .editColorPaletteChooseMethod").show()}this.currentTool=e;$("#"+this.prefix+" .colorPaletteTool").removeClass("colorPaletteToolSelected");$("#"+this.prefix+"Tool_"+e).addClass("colorPaletteToolSelected");var t=this.getToolLabel(this.currentTool);$("#"+this.prefix+"CurrentTool").html(t);if(e=="select"||e=="move"){this.colorPaletteDisplay.setDrawHighlightInMarquee(false)}else{this.colorPaletteDisplay.setDrawHighlightInMarquee(true)}},colorSelected:function(e){if(e!=this.selectedColor){this.selectedColor=e;this.updateColorInfo()}},colorHighlighted:function(e){if(e!=this.highlightedColor){this.highlightedColor=e;this.updateColorInfo()}},updateColorInfo:function(){var e=false;if(this.highlightedColor!=this.editor.colorPaletteManager.noColor){e=this.highlightedColor}else if(this.selectedColor!=this.editor.colorPaletteManager.noColor){e=this.selectedColor}if(e===false||e>=this.colors.length){return false}var t=this.colors[e];var i=("000000"+t.toString(16)).substr(-6);$("#"+this.prefix+"CurrentColorBox").css("background-color","#"+i);$("#"+this.prefix+"CurrentColorIndex").html(e);$("#"+this.prefix+"CurrentColorHex").html("#"+i)},setAutosave:function(e){this.autosave=e},setToCurrentPalette:function(){if(this.editor.colorPaletteManager==null){return}var e=this.editor.colorPaletteManager.getCurrentColorPalette();if(e==null){return}this.colorCount=e.getColorCount();this.colorsAcross=e.getColorsAcross();this.colors=[];for(var t=0;t<this.colorCount;t++){this.colors.push(e.getARGB(t))}var i=e.getDefaultColorPaletteMap();if(i===false||i.length==0){e.setSortOrderMethod("default");i=e.getCurrentColorMap()}var r=16;var a=16;if(i.length>0){if(i.length>a){a=i.length}if(i[0].length>r){r=i[0].length}}this.colorMap=[];for(var s=0;s<a;s++){this.colorMap[s]=[];for(var o=0;o<r;o++){if(s<i.length&&o<i[s].length){this.colorMap[s][o]=i[s][o]}else{this.colorMap[s][o]=this.editor.colorPaletteManager.noColor}}}this.colorPaletteDisplay.setColors(this.colors,{colorMap:this.colorMap});e.setTrackModified(false);this.historyInit();this.historySaveState();e.setTrackModified(true)},initContent:function(){this.r=$("#"+this.prefix+"R").val();this.g=$("#"+this.prefix+"G").val();this.b=$("#"+this.prefix+"B").val();this.colorPaletteDisplay.setMarqueeEnabled(false);this.setColorPaletteTool("pen");this.setRGB();this.updateHex();this.setToCurrentPalette();this.historyInit();this.historySaveState()},getToolLabel:function(e){var t=e;t=this.editor.tools.drawTools.getToolLabel(e);return t},initEvents:function(){var s=this;$(".colorPaletteTool").on("click",function(){var e=$(this).attr("id");var t=e.lastIndexOf("_");e=e.substring(t+1);s.setColorPaletteTool(e)});$(".colorPaletteTool").on("mouseover",function(){var e=$(this).attr("id");var t=e.indexOf("_");e=e.substring(t+1);var i=s.getToolLabel(e);$("#"+s.prefix+"CurrentTool").html(i)});$(".colorPaletteTool").on("mouseleave",function(){var e=s.getToolLabel(s.currentTool);$("#"+s.prefix+"CurrentTool").html(e)});$("#"+this.prefix+"ShowGrid").on("click",function(){s.colorPaletteDisplay.setGridVisible($("#"+s.prefix+"ShowGrid").is(":checked"))});$("#"+this.prefix+"ImageChooseFile").on("click",function(){$("#"+s.prefix+"Image").click()});document.getElementById(this.prefix+"Image").addEventListener("change",function(e){var t=document.getElementById(s.prefix+"Image").files[0];s.setImportFile(t)});$(".colorPaletteNumber").on("change",function(e){var t=$(this).val();if(t==""){t="0"}t=parseInt(t,10);var i=$(this).attr("data-component");if(!isNaN(t)){switch(i){case"r":s.setR(t);break;case"g":s.setG(t);break;case"b":s.setB(t);break;case"h":s.setH(t);break;case"s":s.setS(t);break;case"v":s.setV(t);break}}});$(".colorPaletteNumber").on("keyup",function(e){var t=parseInt($(this).val(),10);if(!isNaN(t)){var i=$(this).attr("data-component");switch(i){case"r":s.setR(t);break;case"g":s.setG(t);break;case"b":s.setB(t);break;case"h":s.setH(t);break;case"s":s.setS(t);break;case"v":s.setV(t);break}}});$(".colorPaletteSlider").on("mousedown",function(e){var t=e.pageX-$(this).offset().left;var i=e.pageY-$(this).offset().top;var r=$(this).attr("data-component");switch(r){case"r":var a=Math.floor(255*(t/$(this).width()));s.setR(a);break;case"g":var a=Math.floor(255*(t/$(this).width()));s.setG(a);break;case"b":var a=Math.floor(255*(t/$(this).width()));s.setB(a);break;case"h":var a=Math.floor(360*(t/$(this).width()));s.setH(a);break;case"s":var a=Math.floor(100*(t/$(this).width()));s.setS(a);break;case"v":var a=Math.floor(100*(t/$(this).width()));s.setV(a);break}s.activeSlider=this;UI.captureMouse(s)});$("#"+this.prefix+" input[name=editColorPaletteMethod]").on("click",function(e){var t=$("input[name=editColorPaletteMethod]:checked").val();s.setColorSelectionMethod(t)});$("#"+this.prefix+"Clear").on("click",function(e){s.clearPalette()});$("#"+this.prefix+"Load").on("click",function(e){document.getElementById(s.prefix+"LoadForm").reset();$("#"+s.prefix+"ChooseFile").click()});$("#"+this.prefix+"LoadLospec").on("click",function(e){s.loadLospecPalette()});$("#"+this.prefix+"Save").on("click",function(e){s.saveColorPalette()});document.getElementById(this.prefix+"ChooseFile").addEventListener("change",function(e){var t=document.getElementById(s.prefix+"ChooseFile").files[0];s.choosePaletteFile(t)});$("#"+this.prefix+"FromImageColorCount").on("change",function(e){s.colorCount=parseInt($("#"+s.prefix+"FromImageColorCount").val(),10);s.createAutomaticPalette()});$("#"+this.prefix+"FromImageAdd").on("click",function(e){s.addColorsFromImage()});$("#"+this.prefix+"FromImageImage").on("dblclick",function(e){s.dblClickImage(e)});$("#"+this.prefix+"FromImageImage").on("mousedown",function(e){s.mouseDownImage(e)});$("#"+this.prefix+"FromImageImage").on("mouseleave",function(e){s.mouseLeaveImage(e)});$("#"+this.prefix+"FromImageImage").on("wheel",function(e){s.imageMouseWheel(e.originalEvent)});$("#"+this.prefix+"FromImageImage").on("mousemove",function(e){s.mouseMove(e)});$("#"+this.prefix+"FromImageImage").on("mouseup",function(e){s.mouseUp(e)});$("#"+this.prefix+"FromImagePalette").on("mousedown",function(e){s.mouseDownPalette(e)});$("#"+this.prefix+"FromImagePalette").on("mousemove",function(e){s.mouseMove(e)});$("#"+this.prefix+"ImageAddColor").on("click",function(e){s.addSelectedColor()});$("#"+this.prefix+"GraphParam").on("change",function(e){var t=$(this).val();s.setGraphParam(t)});$("#"+this.prefix+"Hex").on("keyup",function(e){s.setColorFromHex()});$("#"+this.prefix+"Hex").on("change",function(e){s.setColorFromHex()});$("#"+this.prefix+"Hex").on("blur",function(e){s.setColorFromHex();s.updateHex()});$("#"+this.prefix+"ImageFit").on("click",function(e){s.scaleImageToFit()});$("#"+this.prefix+"ImageScale").on("keyup",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){s.setImageScale(e/100)}});$("#"+this.prefix+"ImageScaleDecrease").on("click",function(){var e=s.imageScale;if(isNaN(e)){return}e-=.05;if(e>0){s.setImageScale(e)}});$("#"+this.prefix+"ImageScaleIncrease").on("click",function(){var e=s.imageScale;if(isNaN(e)){return}e+=.05;if(e>0){s.setImageScale(e)}});$("#"+this.prefix+"GridWidth").on("change",function(){var e=parseInt($(this).val(),10);s.setGridWidth(e)});$("#"+this.prefix+"GridWidth").on("keyup",function(){var e=parseInt($(this).val(),10);s.setGridWidth(e)});$("#"+this.prefix+"GridHeight").on("change",function(){var e=parseInt($(this).val(),10);s.setGridHeight(e)});$("#"+this.prefix+"GridHeight").on("keyup",function(){var e=parseInt($(this).val(),10);s.setGridHeight(e)});$("#colorPaletteEditorGenerateGradient").on("click",function(e){var t=$("input[name=colorPaletteEditorGenerateGradientType]:checked").val();var i=$("#colorPaletteEditorGradientCorrectLightness").is(":checked");s.generateGradient({type:t,correctLightness:i})})},loadLospecPalette:function(){if(this.colorPaletteLoadFromURL==null){this.colorPaletteLoadFromURL=new ColorPaletteLoadFromURL}var t=this;this.colorPaletteLoadFromURL.show({callback:function(e){t.createPaletteFromLoSpec(e.response)}})},createPaletteFromLoSpec:function(e){this.name=e.name;var t=e.author;var i=[];for(var r=0;r<e.colors.length;r++){var a=parseInt(e.colors[r],16);if(!isNaN(a)){i.push(a)}}this.clearPalette(false);this.addColors(i)},choosePaletteFile:function(e){var t=this;this.clearPalette(false);var i=this.editor.colorPaletteManager.getColorPaletteLoader();i.setImportFile(e,function(e){t.addColors(e)})},dropFile:function(e){this.choosePaletteFile(e)},resize:function(){var e=$("#"+this.prefix+"CanvasHolder").width();var t=$("#"+this.prefix+"CanvasHolder").height()-10;this.colorPaletteDisplay.fitToWidthHeight(e,t)},setGridWidth:function(e){var t=this.colorPaletteDisplay.getColorMap();if(t.length<=0||e==0){return}if(t[0].length==e){return}if(t[0].length>e&&(this.saveMap.length==0||this.saveMap[0].length<t[0].length)){this.saveMap=[];for(var i=0;i<t.length;i++){this.saveMap[i]=[];for(var r=0;r<t[i].length;r++){this.saveMap[i][r]=t[i][r]}}}var a=this.editor.colorPaletteManager.noColor;for(var i=0;i<t.length;i++){if(t[i].length<e){for(var r=t[i].length;r<e;r++){if(i<this.saveMap.length&&r<this.saveMap[i].length){t[i][r]=this.saveMap[i][r]}else{t[i][r]=a}}}if(t[i].length>e){t[i].length=e}}this.colorPaletteDisplay.setColorMap(t);var e=this.colorPaletteDisplay.getCanvasWidth();this.resize()},setGridHeight:function(e){var t=this.colorPaletteDisplay.getColorMap();if(t.length<=0||t.length===e||e==0){return}if(t.length>e&&(this.saveMap.length==0||this.saveMap.length<t.length)){this.saveMap=[];for(var i=0;i<t.length;i++){this.saveMap[i]=[];for(var r=0;r<t[i].length;r++){this.saveMap[i][r]=t[i][r]}}}var a=t[0].length;var s=this.editor.colorPaletteManager.noColor;if(t.length<e){for(var i=t.length;i<e;i++){var o=[];for(var r=0;r<a;r++){o[r]=s;if(i<this.saveMap.length&&r<this.saveMap[i].length){o[r]=this.saveMap[i][r]}}t.push(o)}}if(t.length>e){t.length=e}this.colorPaletteDisplay.setColorMap(t);var a=this.colorPaletteDisplay.getCanvasWidth();this.resize()},setColorSelectionMethod:function(e){this.colorSelectionMethod=e;$("#"+this.prefix+" .colorPaletteSelectionMethod").hide();$("#"+this.prefix+"SelectionMethod_"+this.colorSelectionMethod).show();if(e=="colorwheel"){this.drawColorWheel();this.setColorWheelHSV()}},setR:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.r=e;this.setRGB();this.updateHex()},setG:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.g=e;this.setRGB();this.updateHex()},setB:function(e){e=parseInt(e);if(isNaN(e)){return}this.b=e;this.setRGB();this.updateHex()},setH:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.h=e;this.setHSV();this.updateHex()},setS:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.s=e;this.setHSV();this.updateHex()},setV:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.v=e;this.setHSV();this.updateHex()},updatePalette:function(){var e=this.editor.colorPaletteManager;var t=e.getCurrentColorPalette()},updateHSVSlider:function(e,t){var i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);var r=i.getImageData(0,0,e.width,e.height);var a=e.height-4;for(var s=0;s<a;s++){for(var o=0;o<e.width;o++){var l=o/e.width;var n=(s*e.width+o)*4;var h=Math.floor(t.fromH+(t.toH-t.fromH)*l);var d=Math.floor(t.fromS+(t.toS-t.fromS)*l);var c=Math.floor(t.fromV+(t.toV-t.fromV)*l);var f=hsv2rgb(h,d/100,c/100);r.data[n]=Math.round(f[0]);r.data[n+1]=Math.round(f[1]);r.data[n+2]=Math.round(f[2]);r.data[n+3]=255}}i.putImageData(r,0,0);var u=t.value*e.width;i.globalAlpha=.6;i.strokeStyle="#ffffff";i.beginPath();i.moveTo(u,0);i.lineTo(u,e.height);i.stroke();i.globalAlpha=1;i.fillStyle="#ffffff";i.beginPath();i.moveTo(u,a);i.lineTo(u+2,e.height);i.lineTo(u-2,e.height);i.fill()},updateHSVSliders:function(){this.updateHSVSlider(this.hSliderCanvas,{fromH:0,toH:360,fromS:this.s,toS:this.s,fromV:this.v,toV:this.v,value:this.h/360});this.updateHSVSlider(this.sSliderCanvas,{fromH:this.h,toH:this.h,fromS:0,toS:100,fromV:this.v,toV:this.v,value:this.s/100});this.updateHSVSlider(this.vSliderCanvas,{fromH:this.h,toH:this.h,fromS:this.s,toS:this.s,fromV:0,toV:100,value:this.v/100})},updateRGBSlider:function(e,t){if(!e){return}var i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);var r=i.getImageData(0,0,e.width,e.height);var a=e.height-4;for(var s=0;s<a;s++){for(var o=0;o<e.width;o++){var l=o/e.width;var n=(s*e.width+o)*4;var h=Math.floor(t.fromR+(t.toR-t.fromR)*l);var d=Math.floor(t.fromG+(t.toG-t.fromG)*l);var c=Math.floor(t.fromB+(t.toB-t.fromB)*l);r.data[n]=h;r.data[n+1]=d;r.data[n+2]=c;r.data[n+3]=255}}i.putImageData(r,0,0);var f=t.value/255*e.width;i.strokeStyle="#ffffff";i.beginPath();i.moveTo(f,0);i.lineTo(f,a);i.stroke();i.fillStyle="#ffffff";i.beginPath();i.moveTo(f,a);i.lineTo(f+2,e.height);i.lineTo(f-2,e.height);i.fill()},updateRGBSliders:function(){this.updateRGBSlider(this.rSliderCanvas,{fromR:0,toR:255,fromG:this.g,toG:this.g,fromB:this.b,toB:this.b,value:this.r});this.updateRGBSlider(this.gSliderCanvas,{fromR:this.r,toR:this.r,fromG:0,toG:255,fromB:this.b,toB:this.b,value:this.g});this.updateRGBSlider(this.bSliderCanvas,{fromR:this.r,toR:this.r,fromG:this.g,toG:this.g,fromB:0,toB:255,value:this.b})},setHSV:function(){var e=hsv2rgb(this.h,this.s/100,this.v/100);this.r=Math.round(e[0]);this.g=Math.round(e[1]);this.b=Math.round(e[2]);this.rgb=((this.r&255)<<16)+((this.g&255)<<8)+(this.b&255);this.updateColorSliders()},setRGB:function(e){if(typeof e=="undefined"){this.rgb=((this.r&255)<<16)+((this.g&255)<<8)+(this.b&255)}else{this.rgb=e;this.r=(e&16711680)>>16;this.g=e>>8&255;this.b=e&255}var t=rgb2hsv(this.r,this.g,this.b);this.h=Math.round(t[0]*360);this.s=Math.round(t[1]*100);this.v=Math.round(t[2]*100);this.updateColorSliders()},setColorFromHex:function(){var e=$("#"+this.prefix+"Hex").val();e=parseInt(e,16);if(isNaN(e)){return}this.setRGB(e)},updateHex:function(){var e=("000000"+this.rgb.toString(16)).substr(-6);$("#"+this.prefix+"Hex").val(e)},updateColorSliders:function(){$("#"+this.prefix+"R").val(this.r);$("#"+this.prefix+"G").val(this.g);$("#"+this.prefix+"B").val(this.b);$("#"+this.prefix+"H").val(this.h);$("#"+this.prefix+"S").val(this.s);$("#"+this.prefix+"V").val(this.v);this.setSelectedColor(this.rgb);this.updateRGBSliders();this.updateHSVSliders()},initColors:function(){this.colors=[]},historyInit:function(){this.history=[];this.historyPosition=0},historySaveState:function(){var e={};e.colors=[];e.map=[];for(var t=0;t<this.colors.length;t++){e.colors.push(this.colors[t])}var i=this.colorPaletteDisplay.getColorMap();for(var r=0;r<i.length;r++){e.map.push([]);for(var a=0;a<i[r].length;a++){e.map[r].push(i[r][a])}}this.historyPosition++;this.history[this.historyPosition]=e;if(this.autosave){this.setPalette()}},undo:function(){console.log("undo!!!");if(this.historyPosition<=1){return}this.historyPosition--;this.historyRestoreEntry(this.historyPosition);this.setGraphData();if(this.autosave){this.setPalette()}},redo:function(){if(this.historyPosition>=this.history.length-1){return}this.historyPosition++;this.historyRestoreEntry(this.historyPosition);this.setGraphData();if(this.autosave){this.setPalette()}},historyRestoreEntry:function(e){var t=this.history[e];this.colors=[];for(var i=0;i<t.colors.length;i++){this.colors.push(t.colors[i])}var r=[];for(var a=0;a<t.map.length;a++){r.push([]);for(var s=0;s<t.map[a].length;s++){r[a].push(t.map[a][s])}}this.colorPaletteDisplay.setColors(this.colors,{colorMap:r})},saveColorPalette:function(){if(this.colorPalette==null){this.colorPalette=new ColorPalette;this.colorPalette.editor=this.editor}this.setPalette(false);this.editor.colorPaletteManager.showSave({colorPalette:this.colorPalette})},setPalette:function(e){var t=this.editor.colorPaletteManager;var i=this.colorPalette;if(typeof e=="undefined"||e){i=t.getCurrentColorPalette()}var r=Math.ceil(this.colors.length/this.colorsAcross);var a=this.colorPaletteDisplay.getColorMap();var s=0;var o=0;for(var l=0;l<a.length;l++){for(var n=0;n<a[l].length;n++){if(a[l][n]!=this.editor.colorPaletteManager.noColor){if(n+1>s){s=n+1}o=l+1}}}var h=[];for(var l=0;l<o;l++){h[l]=[];for(var n=0;n<s;n++){h[l][n]=a[l][n]}}i.setColorPaletteMap("Default Layout",h);i.setColors(this.colors,this.colorsAcross,r)},clearPalette:function(e){this.colors=[];for(var t=0;t<this.colorMap.length;t++){for(var i=0;i<this.colorMap[t].length;i++){this.colorMap[t][i]=this.editor.colorPaletteManager.noColor}}this.colorPaletteDisplay.setColors(this.colors,{colorMap:this.colorMap});if(typeof e=="undefined"||e){this.historySaveState()}},removeColor:function(){if(this.selectedColor===false||this.selectedColor>=this.colors.length){return}this.colors.splice(this.selectedColor,1);this.colorPaletteDisplay.setColors(this.colors,{colorsAcross:this.colorsAcross});this.historySaveState();this.selectedColor=false},setImportFile:function(e){if(!this.importImage){this.importImage=new Image}var t=this;this.importImage.onload=function(){t.imageScale=1;t.imageX=-t.imageCanvas.width/2;t.imageY=-t.imageCanvas.height/2;t.updateImportImage();t.createAutomaticPalette()};var i=window.URL||window.webkitURL;var r=i.createObjectURL(e);this.importImage.src=r;if(typeof e.name!="undefined"){$("#"+this.prefix+"ImageChooseFileName").html(e.name)}else{$("#"+this.prefix+"ImageChooseFileName").html("")}},setImageScale:function(e){this.imageScale=e;var t=e*100;$("#"+this.prefix+"ImageScale").val(t);this.updateImportImage()},scaleImageToFit:function(){if(this.importImage==null){return}var e=0;var t=0;var i=1;var e=this.importImage.naturalWidth;var t=this.importImage.naturalHeight;var r=this.imageCanvas.width;var a=this.imageCanvas.height;if(e>r){i=r/this.importImage.naturalWidth}if(t>a){i=a/this.importImage.naturalHeight}if(e<r&&i==1){i=r/this.importImage.naturalWidth}if(t<a&&i==1){i=a/this.importImage.naturalHeight}this.imageX=(r-e*i)/2-r/(2*i);this.imageY=(a-t*i)/2-a/(2*i);var s=i;this.setImageScale(s)},xyToImageColor:function(e,t){if(this.imageData==null){return false}e=Math.floor(e);t=Math.floor(t);var i=e*4+t*4*this.imageData.width;if(i+3>=this.imageData.data.length){return false}var r=this.imageData.data[i];var a=this.imageData.data[i+1];var s=this.imageData.data[i+2];var o=(r<<16)+(a<<8)+s;return o},updateImportImage:function(){var e=this.importImage.naturalWidth;var t=this.importImage.naturalHeight;this.imageContext.clearRect(0,0,this.imageCanvas.width,this.imageCanvas.height);var i=0;var r=0;this.imageContext.save();this.imageContext.translate(this.imageCanvas.width/2,this.imageCanvas.height/2);this.imageContext.scale(this.imageScale,this.imageScale);this.imageContext.drawImage(this.importImage,0,0,e,t,this.imageX+i,this.imageY+r,e,t);this.imageContext.restore();this.imageData=this.imageContext.getImageData(0,0,this.imageCanvas.width,this.imageCanvas.height);if(this.imageMouseDownX!==false&&this.imageMouseDownY!==false){var a=this.imageMouseDownX;var s=this.imageMouseDownY;this.imageContext.strokeStyle="#222222";this.imageContext.beginPath();this.imageContext.arc(a,s,2,0,2*Math.PI);this.imageContext.stroke()}},createAutomaticPalette:function(){if(this.importImage==null){return}var e=ImageUtils.createColorPaletteFromImage(this.colorCount,this.importImage);this.imageColors=[];for(var t=0;t<e.length;t+=4){var i=255>>>0;var r=(i<<24)+(e[t]<<16)+(e[t+1]<<8)+e[t+2]>>>0;this.imageColors.push(r)}this.drawImageColors()},buildInterface:function(e){var t=this;this.prefix="colorPaletteEditor";this.uiComponent=UI.create("UI.Panel");e.add(this.uiComponent);this.uiComponent.on("keydown",function(e){t.keyDown(e)});this.uiComponent.on("keyup",function(e){t.keyUp(e)});this.uiComponent.on("keypress",function(e){t.keyPress(e)});this.createPalettePanel=UI.create("UI.HTMLPanel");this.uiComponent.add(this.createPalettePanel);UI.on("ready",function(){t.createPalettePanel.load("html/textMode/colorPaletteEditor.html",function(){t.htmlComponentLoaded();t.initContent();t.setH(208);t.setS(67);t.setV(67)})})},show:function(){var t=this;this.visible=true;this.autosave=false;this.prefix="colorPaletteEdit";if(this.uiComponent==null){var e=800;var i=660;this.uiComponent=UI.create("UI.Dialog",{id:"editColorPaletteDialog",title:"Edit Colour Palette",width:e,height:i});this.uiComponent.on("close",function(){t.visible=false});this.uiComponent.on("keydown",function(e){t.keyDown(e)});this.uiComponent.on("keyup",function(e){t.keyUp(e)});this.uiComponent.on("keypress",function(e){t.keyPress(e)});this.uiComponent.on("resize",function(e){t.resize()});this.createPalettePanel=UI.create("UI.HTMLPanel");this.uiComponent.add(this.createPalettePanel);this.createPalettePanel.load("html/textMode/colorPaletteEdit.html",function(){t.htmlComponentLoaded();t.initContent();t.setH(208);t.setS(67);t.setV(67)});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.setPalette();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("editColorPaletteDialog")},getColorInfo:function(e){var t=("000000"+e.toString(16)).substr(-6);var i="<div>#"+t+"<div>";var r=(e&4278190080)>>24;var a=(e&16711680)>>16;var s=(e&65280)>>8;var o=e&255;i+="<div>";i+='<label class="gridinfo-label">R</label><div class="color-value">'+a+"</div>";i+='<label class="gridinfo-label">G</label><div class="color-value">'+s+"</div>";i+='<label class="gridinfo-label">B</label><div class="color-value">'+o+"</div>";i+="</div>";var l=rgb2hsv(a,s,o);var n=Math.round(360*l[0]);var h=Math.round(l[1]*100);var d=Math.round(l[2]*100);i+='<div><label class="gridinfo-label">H</label><div class="color-value">'+n+"</div>";i+='<label class="gridinfo-label">S</label><div class="color-value">'+h+"</div>";i+='<label class="gridinfo-label">V</label><div class="color-value">'+d+"</div>";i+="</div>";return i},setHighlightColor:function(e){this.highlightColor=e;var t=("000000"+e.toString(16)).substr(-6);$("#"+this.prefix+"ImageMouseHoverColor").css("background-color","#"+t);var i='<div style="font-weight: bold; font-size: 12px; margin: 2px 0 2px 0">Hover Colour</div>'+this.getColorInfo(e);$("#"+this.prefix+"ImageMouseHoverColorInfo").html(i)},setSelectedColor:function(e){this.selectedColor=e;var t=("000000"+this.selectedColor.toString(16)).substr(-6);$("#"+this.prefix+"ImageMouseSelectedColor").css("background-color","#"+t);var i='<div style="font-weight: bold; font-size: 12px; margin: 2px 0 2px 0">Draw Colour</div>'+this.getColorInfo(e);$("#"+this.prefix+"ImageMouseSelectedColorInfo").html(i);this.colorPaletteDisplay.setCursorRGB(this.selectedColor)},addSelectedColor:function(){for(var e=0;e<this.colors.length;e++){if(this.colors[e]==this.selectedColor){alert("This colour has already been added");return}}this.colors.push(this.selectedColor);this.colorPaletteDisplay.setColors(this.colors,{colorsAcross:this.colorsAcross});this.historySaveState()},applyGridTool:function(e,t,i){if(this.currentTool=="eyedropper"||i.altKey){var r=this.colorPaletteDisplay.getColorAtMapXY(e,t);if(r!==this.colorPaletteDisplay.noColor){var a=this.colors[r];this.setRGB(a);this.updateHex()}return}if(this.currentTool=="erase"){var r=this.colorPaletteDisplay.getColorAtMapXY(e,t);if(r!==this.colorPaletteDisplay.noColor){this.colorPaletteDisplay.setColorAtMapXY(e,t,this.colorPaletteDisplay.noColor);console.error("need to delete the colour as well?..")}}if(this.currentTool=="pen"){var r=this.colorPaletteDisplay.getColorAtMapXY(e,t);if(r===this.colorPaletteDisplay.noColor){r=this.colors.length;this.colors.push(this.selectedColor);this.colorPaletteDisplay.setColors(this.colors,{colorsAcross:this.colorsAcross,createColorMap:false});this.colorPaletteDisplay.setColorAtMapXY(e,t,r)}else{this.colors[r]=this.selectedColor;this.colorPaletteDisplay.setColors(this.colors,{colorsAcross:this.colorsAcross,createColorMap:false})}this.colorsChanged=true}},gridMouseDown:function(e,t,i){var r=0;this.buttons=1;this.saveMap=[];if(!UI.isMobile.any()){r=e.button;this.setButtons(e);if(this.buttons&2){return}if(this.buttons&1){this.leftMouseUp=false}this.mouseIsDown=true}if(this.buttons&1){this.pageMouseDownX=e.pageX;this.pageMouseDownY=e.pageY;this.gridMouseDownX=t;this.gridMouseDownY=i;this.applyGridTool(t,i,e);if(this.currentTool=="move"){if(this.colorPaletteDisplay.getMarqueeEnabled()&&this.colorPaletteDisplay.inMarquee(t,i)){this.colorPaletteDisplay.startDragMarquee(true)}else{this.colorPaletteDisplay.startDragColor(t,i)}}if(this.currentTool=="select"){if(this.colorPaletteDisplay.getMarqueeEnabled()&&this.colorPaletteDisplay.inMarquee(t,i)){this.colorPaletteDisplay.startDragMarquee(false)}else{this.colorPaletteDisplay.setMarqueeBounds(t,i,1,1);this.colorPaletteDisplay.setMarqueeEnabled(true)}}if(this.currentTool=="ramp"){this.rampStart(t,i)}}this.colorPaletteDisplay.draw()},rampStart:function(e,t){this.rampFromGridX=e;this.rampFromGridY=t;this.rampToGridX=e;this.rampToGridY=t;var i=this.colorPaletteDisplay.getColorAtMapXY(e,t);if(i===this.colorPaletteDisplay.noColor){i=this.colors.length;this.colors.push(this.selectedColor);this.colorPaletteDisplay.setColors(this.colors,{colorsAcross:this.colorsAcross,createColorMap:false});this.colorPaletteDisplay.setColorAtMapXY(e,t,i)}else{}this.drawingRamp=true},rampMove:function(e,t){if(this.drawingRamp){this.rampToGridX=e;this.rampToGridY=t;this.drawRamp()}},rampEnd:function(e,t){this.rampToGridX=e;this.rampToGridY=t;this.drawingRamp=false},drawRamp:function(){var e=this.colorPaletteDisplay.getContext();var t=6;var i=this.colorPaletteDisplay.gridXYToCell(this.rampFromGridX,this.rampFromGridY);var r=this.colorPaletteDisplay.gridXYToCell(this.rampToGridX,this.rampToGridY);e.lineWidth=1;e.strokeStyle="#eeeeee";e.beginPath();e.moveTo(i.centerX,i.centerY);e.lineTo(r.centerX,r.centerY);e.stroke();e.beginPath();e.arc(i.centerX,i.centerY,t,0,2*Math.PI);e.stroke();e.beginPath();e.arc(r.centerX,r.centerY,t,0,2*Math.PI);e.stroke()},gridMouseEnter:function(e){this.mouseInGrid=true;this.setMouseCursor(e)},gridMouseLeave:function(e){this.mouseInGrid=false;this.setMouseCursor(e);this.colorPaletteDisplay.setHighlightGrid(false,false);this.colorPaletteDisplay.draw();UI.setCursor("default")},gridEndDrag:function(e,t,i,r){var a=this.colorPaletteDisplay.getColorAtMapXY(e,t);if(a===this.colorPaletteDisplay.noColor){return}if(e!==i||t!==r){var s=this.colorPaletteDisplay.getColorAtMapXY(i,r);this.colorPaletteDisplay.setColorAtMapXY(i,r,a);this.colorPaletteDisplay.setColorAtMapXY(e,t,s);this.colorPaletteDisplay.draw();this.historySaveState()}},gridEndMarqueeDrag:function(e,t,i,r,a,s){if(this.currentTool=="move"){var o=this.colorPaletteDisplay.noColor;if(e!==a||t!==s){var l=[];for(var n=0;n<r;n++){l[n]=[];for(var h=0;h<i;h++){l[n][h]=this.colorPaletteDisplay.getColorAtMapXY(e+h,t+n);this.colorPaletteDisplay.setColorAtMapXY(e+h,t+n,o)}}for(var n=0;n<r;n++){for(var h=0;h<i;h++){this.colorPaletteDisplay.setColorAtMapXY(a+h,s+n,l[n][h])}}this.colorPaletteDisplay.draw();this.historySaveState()}}this.colorPaletteDisplay.setMarqueeBounds(a,s,i,r)},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){this.buttons=2}if(e.metaKey&&this.buttons==1){this.buttons=4}},gridMouseMove:function(e,t,i){if(!UI.isMobile.any()){this.setButtons(e)}this.setMouseCursor(e);this.mouseInGrid=true;if(this.currentTool=="pen"){this.colorPaletteDisplay.setCursorRGB(this.selectedColor)}else{this.colorPaletteDisplay.setCursorRGB(false)}this.colorPaletteDisplay.setHighlightGrid(t,i);var r=this.colorPaletteDisplay.getColorAtMapXY(t,i);if(r!=this.colorPaletteDisplay.noColor&&r<this.colors.length){this.setHighlightColor(this.colors[r])}if(this.buttons&1&&!this.leftMouseUp){if(this.buttons&1){this.applyGridTool(t,i,e)}if(this.currentTool=="select"&&!this.colorPaletteDisplay.getInDragMarquee()){var a=this.gridMouseDownX;var s=this.gridMouseDownY;var o=t-this.gridMouseDownX+1;var l=i-this.gridMouseDownY+1;if(t<this.gridMouseDownX){a=t;o=this.gridMouseDownX-t+1}if(i<this.gridMouseDownY){s=i;l=this.gridMouseDownY-i+1}this.colorPaletteDisplay.setMarqueeBounds(a,s,o,l)}}this.colorPaletteDisplay.draw();if(this.currentTool=="ramp"){this.rampMove(t,i)}},gridMouseUp:function(e,t,i){if(this.currentTool=="select"){if(this.pageMouseDownX==e.pageX&&this.pageMouseDownY==e.pageY){this.colorPaletteDisplay.setMarqueeEnabled(false)}}if(!UI.isMobile.any()){this.setButtons(e)}else{this.buttons=0}if(this.buttons&1){this.leftMouseUp=false}else{this.leftMouseUp=true}if(this.currentTool=="ramp"){this.rampEnd(t,i)}if(this.colorsChanged){this.historySaveState();this.colorsChanged=false;this.setGraphData()}},mouseDown:function(e){},setMouseCursor:function(e){if(this.mouseInGrid){if(e.altKey){UI.setCursor("eyedropper");return}switch(this.currentTool){case"pen":UI.setCursor("draw");break;case"erase":UI.setCursor("erase");break;case"eyedropper":UI.setCursor("eyedropper");break;case"move":UI.setCursor("move");break;case"select":UI.setCursor("select");break}}},keyDown:function(e){var t=e.keyCode;if(typeof e.key!="undefined"){if(e.ctrlKey||e.metaKey){switch(e.key.toUpperCase()){case"Z":if(e.shift){this.redo()}else{this.undo()}break}}}var i=String.fromCharCode(t).toUpperCase();switch(i){case keys.textMode.toolsPencil.key:this.setColorPaletteTool("pen");break;case keys.textMode.toolsErase.key:this.setColorPaletteTool("erase");break;case keys.textMode.toolsEyedropper.key:this.setColorPaletteTool("eyedropper");break;case keys.textMode.toolsMove.key:this.setColorPaletteTool("move");break;case keys.textMode.toolsMarquee.key:this.setColorPaletteTool("select");break}this.setMouseCursor(e)},keyUp:function(e){this.setMouseCursor(e)},keyPress:function(e){},imageMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);var i=this.imageScale-t.spinY/8;if(this.imageMouseDownX!==false&&this.imageMouseDownY!==false){this.imageMouseDownX=this.imageCanvas.width/2+i*(this.imageMouseDownX-this.imageCanvas.width/2)/this.imageScale;this.imageMouseDownY=this.imageCanvas.height/2+i*(this.imageMouseDownY-this.imageCanvas.height/2)/this.imageScale}this.imageScale=i;this.updateImportImage()},dblClickImage:function(e){this.setSelectedColor(this.highlightColor);this.addSelectedColor()},mouseLeaveImage:function(e){if(this.mouseDownOnImage){UI.captureMouse(this)}},mouseDownImage:function(e){var t=e.pageX-$("#"+this.prefix+"FromImageImage").offset().left;var i=e.pageY-$("#"+this.prefix+"FromImageImage").offset().top;this.imageMouseDownX=t;this.imageMouseDownY=i;this.currentImageMouseDownX=t;this.currentImageMouseDownY=i;this.updateImportImage();this.setSelectedColor(this.highlightColor);this.mouseDownAtX=e.pageX;this.mouseDownAtY=e.pageY;this.currentOffsetX=this.imageX;this.currentOffsetY=this.imageY;this.mouseDownOnImage=true},mouseMoveImage:function(e){var t=e.pageX-$("#"+this.prefix+"FromImageImage").offset().left;var i=e.pageY-$("#"+this.prefix+"FromImageImage").offset().top;var r=this.xyToImageColor(t,i);if(r){this.setHighlightColor(r)}if(this.mouseDownOnImage){var t=e.pageX;var i=e.pageY;var a=t-this.mouseDownAtX;var s=i-this.mouseDownAtY;this.imageX=this.currentOffsetX+a/this.imageScale;this.imageY=this.currentOffsetY+s/this.imageScale;this.imageMouseDownX=this.currentImageMouseDownX+a;this.imageMouseDownY=this.currentImageMouseDownX+s;this.updateImportImage()}},mouseDownPalette:function(e){var t=e.pageX-$("#"+this.prefix+"FromImagePalette").offset().left;var i=e.pageY-$("#"+this.prefix+"FromImagePalette").offset().top},mouseMovePalette:function(e){var t=e.pageX-$("#"+this.prefix+"FromImagePalette").offset().left;var i=e.pageY-$("#"+this.prefix+"FromImagePalette").offset().top},mouseMoveSlider:function(e){var t=e.pageX-$(this.activeSlider).offset().left;var i=e.pageY-$(this.activeSlider).offset().top;var r=$(this.activeSlider).attr("data-component");var a=0;if(r=="r"||r=="g"||r=="b"){a=Math.floor(255*(t/$(this.activeSlider).width()));if(a>255){a=255}if(a<0){a=0}}if(r=="h"){a=Math.floor(360*(t/$(this.activeSlider).width()));if(a>360){a=360}if(a<0){a=0}}if(r=="s"||r=="v"){a=Math.floor(100*(t/$(this.activeSlider).width()));if(a>100){a=100}if(a<0){a=0}}switch(r){case"r":this.setR(a);break;case"g":this.setG(a);break;case"b":this.setB(a);break;case"h":this.setH(a);break;case"s":this.setS(a);break;case"v":this.setV(a);break}},mouseMove:function(e){var t=e.pageX-$("#"+this.prefix+"FromImageImage").offset().left;var i=e.pageY-$("#"+this.prefix+"FromImageImage").offset().top;if(this.activeSlider!==false){this.mouseMoveSlider(e)}if(this.colorWheelValueMouseIsDown){this.colorWheelValueMouseMove(e);return}if(this.colourWheelMouseIsDown){this.colorWheelMouseMove(e);return}if(this.mouseDownOnImage||t>0&&i>0&&t<$("#"+this.prefix+"FromImageImage").width()&&i<$("#"+this.prefix+"FromImageImage").height()){this.mouseMoveImage(e)}var t=e.pageX-$("#"+this.prefix+"FromImagePalette").offset().left;var i=e.pageY-$("#"+this.prefix+"FromImagePalette").offset().top;if(t>0&&i>0&&t<$("#"+this.prefix+"FromImagePalette").width()&&i<$("#"+this.prefix+"FromImagePalette").height()){this.mouseMovePalette(e)}},mouseUp:function(e){if(this.colorWheelValueMouseIsDown){this.colorWheelValueMouseUp(e);return}if(this.colourWheelMouseIsDown){this.colorWheelMouseUp(e);return}this.mouseDownOnImage=false;this.activeSlider=false;if(!UI.isMobile.any()){this.setButtons(e)}else{this.buttons=0}if(this.buttons&1){this.leftMouseUp=false}else{this.leftMouseUp=true}},mouseUpImage:function(e){},generateGradient:function(e){var t=e.type;var i=e.correctLightness;console.log("generate gradient: "+t);console.log(this.startColor+","+this.endColor);var r=null;if(t=="bezier"){r=chroma.bezier(["#"+this.startColor,"#"+this.endColor]).scale()}else{r=chroma.scale(["#"+this.startColor,"#"+this.endColor])}if(i){r=r.correctLightness()}console.log(r);var a=this.marqueeWidth*this.marqueeHeight;var s=r.colors(a,"hex");for(var o=1;o<s.length-1;o++){var l=this.marqueeTop+Math.floor(o/this.marqueeWidth);var n=this.marqueeLeft+o%this.marqueeWidth;var h=s[o];if(h.indexOf("#")==0){h=h.substring(1)}h=parseInt(h,16);var d=this.colorMap[l][n];if(d===this.editor.colorPaletteManager.noColor){d=this.colors.length;this.colors.push(h);this.colorPaletteDisplay.setColors(this.colors,{colorsAcross:this.colorsAcross,createColorMap:false});this.colorPaletteDisplay.setColorAtMapXY(n,l,d)}else{this.colors[d]=h;this.colorPaletteDisplay.setColors(this.colors,{colorsAcross:this.colorsAcross,createColorMap:false})}}this.setGraphData();this.paramGraph.draw()},setStartEndColors:function(){var e=this.colorPaletteDisplay.getColorAtMapXY(this.marqueeLeft,this.marqueeTop);if(e!==this.colorPaletteDisplay.noColor){var t=this.colors[e];var i=("000000"+t.toString(16)).substr(-6);this.startColor=i;$("#colorPaletteEditorFrom").css("background-color","#"+i)}var r=this.colorPaletteDisplay.getColorAtMapXY(this.marqueeLeft+this.marqueeWidth-1,this.marqueeTop+this.marqueeHeight-1);if(r!==this.colorPaletteDisplay.noColor){var t=this.colors[r];var i=("000000"+t.toString(16)).substr(-6);this.endColor=i;$("#colorPaletteEditorTo").css("background-color","#"+i)}},marqueeChanged:function(e,t,i,r){if(e===this.marqueeLeft&&t===this.marqueeTop&&i===this.marqueeWidth&&r===this.marqueeHeight){return}this.marqueeLeft=e;this.marqueeTop=t;this.marqueeWidth=i;this.marqueeHeight=r;this.setGraphData();this.setStartEndColors()},setGraphData:function(){this.marqueeColors=[];this.marqueeColorsComponent=[];this.colorMap=this.colorPaletteDisplay.getColorMap();for(var e=this.marqueeTop;e<this.marqueeTop+this.marqueeHeight;e++){for(var t=this.marqueeLeft;t<this.marqueeLeft+this.marqueeWidth;t++){if(e<this.colorMap.length&&t<this.colorMap[e].length){var i=this.colorMap[e][t];var r=0;if(i!==this.editor.colorPaletteManager.nocolor){r=this.colors[i]}var a=0;this.marqueeColors.push({x:t,y:e});if(this.graphParam==="red"||this.graphParam=="green"||this.graphParam=="blue"){this.paramGraph.setBounds(0,255);if(this.graphParam==="red"){a=r>>16&255}if(this.graphParam==="green"){a=r>>8&255}if(this.graphParam==="blue"){a=r&255}}if(this.graphParam=="hue"||this.graphParam=="saturation"||this.graphParam=="value"){var s=(r&16711680)>>16;var o=r>>8&255;var l=r&255;var n=rgb2hsv(s,o,l);if(this.graphParam=="hue"){this.paramGraph.setBounds(0,359);a=Math.round(n[0]*360)}if(this.graphParam=="saturation"){this.paramGraph.setBounds(0,100);a=Math.round(n[1]*100)}if(this.graphParam=="value"){this.paramGraph.setBounds(0,100);a=Math.round(n[2]*100)}}this.marqueeColorsComponent.push(a)}}}this.paramGraph.setData(this.marqueeColorsComponent);this.paramGraph.draw()},setGraphParam:function(e){this.graphParam=e;this.setGraphData()},paramChanged:function(e,t){if(e===false||e<0||e>=this.marqueeColors.length){return}var i=this.marqueeColors[e].x;var r=this.marqueeColors[e].y;var a=this.colorMap[r][i];if(a===this.editor.colorPaletteManager.noColor){a=this.colors.length;this.colors.push(this.selectedColor);this.colorPaletteDisplay.setColors(this.colors,{colorsAcross:this.colorsAcross,createColorMap:false});this.colorPaletteDisplay.setColorAtMapXY(i,r,a)}if(a!==this.editor.colorPaletteManager.noColor){var s=this.colors[a];var o=255;if(this.graphParam=="red"){this.colors[a]=(s&4278255615|t<<16)>>>0}if(this.graphParam=="green"){this.colors[a]=(s&4294902015|t<<8)>>>0}if(this.graphParam=="blue"){this.colors[a]=(s&4294967040|t)>>>0}if(this.graphParam=="hue"||this.graphParam=="saturation"||this.graphParam=="value"){var l=(s&16711680)>>16;var n=s>>8&255;var h=s&255;var d=rgb2hsv(l,n,h);var c=[];if(this.graphParam=="hue"){c=hsv2rgb(t,d[1],d[2])}if(this.graphParam=="saturation"){c=hsv2rgb(d[0]*360,t/100,d[2])}if(this.graphParam=="value"){c=hsv2rgb(d[0]*360,d[1],t/100)}var l=Math.round(c[0])>>>0;var n=Math.round(c[1])>>>0;var h=Math.round(c[2])>>>0;var f=255>>>0;this.colors[a]=(f<<24)+((l&255)<<16)+((n&255)<<8)+(h&255)>>>0}this.colorPaletteDisplay.setColors(this.colors);this.colorsChanged=true}this.setStartEndColors()},paramGraphMouseUp:function(e){if(this.colorsChanged){this.historySaveState();this.colorsChanged=false}},addColorsFromImage:function(){this.addColors(this.imageColors)},addColors:function(e){var t=false;var i=this.colorPaletteDisplay.getColorMap();var r=0;var a=0;for(var s=0;s<i.length;s++){var o=true;for(var l=0;l<i[s].length;l++){if(i[s][l]!=this.editor.colorPaletteManager.noColor){o=false;break}}if(o){r=0;a=s;break}}for(var n=0;n<e.length;n++){var h=e[n];var d=false;for(var c=0;c<this.colors.length;c++){if(this.colors[c]==h){d=true;break}}if(!d){var f=i[a][r];while(f!==this.editor.colorPaletteManager.noColor){r++;if(r>=i[a].length){r=0;a++;if(a>=i.length){break}}f=i[a][r]}if(a<i.length){var u=this.colors.length;this.colors.push(h);i[a][r]=u}else{break}}}this.colorPaletteDisplay.setColors(this.colors,{colorsAcross:this.colorsAcross});this.historySaveState()},downloadPNG:function(e){var t="palette.png";if(typeof e!="undefined"){if(typeof e.filename!="undefined"){t=e.filename}}var i=0;var r=0;for(var a=0;a<this.colorMap.length;a++){for(var s=0;s<this.colorMap[a].length;s++){if(this.colorMap[a][s]!=this.editor.colorPaletteManager.noColor){if(s+1>i){i=s+1}r=a+1}}}if(this.exportCanvas==null){this.exportCanvas=document.createElement("canvas")}var o=16;this.exportCanvas.width=i*o;this.exportCanvas.height=r*o;this.exportContext=this.exportCanvas.getContext("2d");this.exportContext.clearRect(0,0,this.exportCanvas.width,this.exportCanvas.height);for(var a=0;a<r;a++){for(var s=0;s<i;s++){if(this.colorMap[a][s]!=this.editor.colorPaletteManager.noColor){var l=this.colorMap[a][s];var n=this.colors[l]&16777215;var h=this.colors[l]>>>24&255;var d=("000000"+n.toString(16)).substr(-6);this.exportContext.fillStyle="#"+d;this.exportContext.fillRect(s*o,a*o,o,o)}}}if(t.indexOf(".png")==-1){t+=".png"}var c=this.exportCanvas.toDataURL("image/png");download(c,t,"image/png")},colorWheelXYToColor:function(e,t){e=e-this.colorWheelRadius;t=t-this.colorWheelRadius;var i=xy2polar(e,t);var r=i[0];var a=i[1];if(r>this.colorWheelRadius){r=this.colorWheelRadius}var s=rad2deg(a);var o=s;var l=r/this.colorWheelRadius;var n=1;i=polar2xy(r,a);e=this.colorWheelRadius+i[0];t=this.colorWheelRadius+i[1];var h=hsv2rgb(o,l,this.v/100);var r=Math.round(h[0]);var d=Math.round(h[1]);var c=Math.round(h[2]);var f=((r&255)<<16)+((d&255)<<8)+(c&255);this.setHighlightColor(f);return{hue:o,saturation:l,value:n,x:e,y:t}},setColorWheelColor:function(e,t){var i=this.colorWheelXYToColor(e,t);if(i!==false){this.selectedColorWheelColor=this.colorWheelXYToColor(e,t);this.selectedColorWheelColorX=this.selectedColorWheelColor.x;this.selectedColorWheelColorY=this.selectedColorWheelColor.y;this.h=this.selectedColorWheelColor.hue;this.s=this.selectedColorWheelColor.saturation*100;this.setHSV();this.drawColorWheel()}},setColorWheelHSV:function(){var e=polar2xy(this.s/100*this.colorWheelRadius,(this.h-180)*Math.PI/180);this.selectedColorWheelColorX=this.colorWheelRadius+e[0];this.selectedColorWheelColorY=this.colorWheelRadius+e[1];this.setColorWheelValue(this.v/100)},setColorWheelValue:function(e){if(e<0){e=0}if(e>1){e=1}this.colorWheelValue=e;this.v=e*100;this.setHSV();this.updateColorWheelImage();this.drawColorWheel()},colorWheelValueHover:function(e){if(e<0){e=0}if(e>1){e=1}var t=hsv2rgb(this.h,this.s/100,e);var i=Math.round(t[0]);var r=Math.round(t[1]);var a=Math.round(t[2]);var s=((i&255)<<16)+((r&255)<<8)+(a&255);this.setHighlightColor(s)},colorWheelValueMouseDown:function(e){var t=e.pageX-$("#"+this.prefix+"ColorWheelValue").offset().left;var i=e.pageY-$("#"+this.prefix+"ColorWheelValue").offset().top;this.colorWheelValueMouseIsDown=true;var r=200;var a=1-i/r;this.setColorWheelValue(a);UI.captureMouse(this)},colorWheelValueMouseMove:function(e){var t=e.pageX-$("#"+this.prefix+"ColorWheelValue").offset().left;var i=e.pageY-$("#"+this.prefix+"ColorWheelValue").offset().top;var r=200;var a=1-i/r;if(this.colorWheelValueMouseIsDown){this.setColorWheelValue(a)}else{this.colorWheelValueHover(a)}},colorWheelValueMouseUp:function(e){var t=e.pageX-$("#"+this.prefix+"ColorWheelValue").offset().left;var i=e.pageY-$("#"+this.prefix+"ColorWheelValue").offset().top;this.colorWheelValueMouseIsDown=false},colorWheelMouseDown:function(e){var t=e.pageX-$("#"+this.prefix+"ColorWheel").offset().left;var i=e.pageY-$("#"+this.prefix+"ColorWheel").offset().top;this.setColorWheelColor(t,i);this.colourWheelMouseIsDown=true;UI.captureMouse(this)},colorWheelMouseMove:function(e){var t=e.pageX-$("#"+this.prefix+"ColorWheel").offset().left;var i=e.pageY-$("#"+this.prefix+"ColorWheel").offset().top;if(this.colourWheelMouseIsDown){this.setColorWheelColor(t,i)}else{this.colorWheelXYToColor(t,i)}},colorWheelMouseUp:function(e){var t=e.pageX-$("#"+this.prefix+"ColorWheel").offset().left;var i=e.pageY-$("#"+this.prefix+"ColorWheel").offset().top;this.colourWheelMouseIsDown=false},updateColorWheelValue:function(){var e=20;var t=200;if(this.colorWheelValueCanvas==null){this.colorWheelValueCanvas=document.getElementById(this.prefix+"ColorWheelValue");this.colorWheelValueContext=this.colorWheelValueCanvas.getContext("2d");var i=this;$("#"+this.prefix+"ColorWheelValue").on("mousemove",function(e){i.colorWheelValueMouseMove(e)});$("#"+this.prefix+"ColorWheelValue").on("mousedown",function(e){i.colorWheelValueMouseDown(e)});$("#"+this.prefix+"ColorWheelValue").on("mouseup",function(e){i.colorWheelValueMouseUp(e)})}var r=this.colorWheelValueCanvas;this.colorWheelValueContext.clearRect(0,0,r.width,r.height);var a=this.colorWheelValueContext.getImageData(0,0,r.width,r.height);var s=a.data;var o=0;var e=r.width;var l=4;for(var n=0;n<t;n++){var h=Math.round((1-n/t)*255);o+=l*4;for(var d=l;d<e;d++){s[o]=h;s[o+1]=h;s[o+2]=h;s[o+3]=255;o+=4}}this.colorWheelValueContext.putImageData(a,0,0);var c=50;var t=200;c=-(this.colorWheelValue-1)*t;this.colorWheelValueContext.globalAlpha=.6;this.colorWheelValueContext.strokeStyle="#ffffff";this.colorWheelValueContext.beginPath();this.colorWheelValueContext.moveTo(l,c);this.colorWheelValueContext.lineTo(r.width,c);this.colorWheelValueContext.stroke();this.colorWheelValueContext.globalAlpha=1;this.colorWheelValueContext.fillStyle="#ffffff";this.colorWheelValueContext.beginPath();this.colorWheelValueContext.moveTo(l,c);this.colorWheelValueContext.lineTo(0,c+2);this.colorWheelValueContext.lineTo(0,c-2);this.colorWheelValueContext.fill()},updateColorWheelImage:function(){if(this.colorWheelImage==null){this.colorWheelImage=this.colorWheelContext.createImageData(2*this.colorWheelRadius,2*this.colorWheelRadius)}var e=this.colorWheelImage.data;for(var t=-this.colorWheelRadius;t<this.colorWheelRadius;t++){for(var i=-this.colorWheelRadius;i<this.colorWheelRadius;i++){var r=xy2polar(t,i);var a=r[0];var s=r[1];if(a>this.colorWheelRadius){continue}var o=rad2deg(s);var l=2*this.colorWheelRadius;var n=t+this.colorWheelRadius;var h=i+this.colorWheelRadius;var d=4;var c=(n+h*l)*d;var f=o;var u=a/this.colorWheelRadius;var p=this.colorWheelValue;var r=hsv2rgb(f,u,p);var v=r[0];var g=r[1];var m=r[2];var y=255;e[c]=v;e[c+1]=g;e[c+2]=m;e[c+3]=y}}},drawColorWheel:function(){if(this.colorWheelCanvas==null){this.colorWheelCanvas=document.getElementById(this.prefix+"ColorWheel");var t=this;$("#"+this.prefix+"ColorWheel").on("mousemove",function(e){t.colorWheelMouseMove(e)});$("#"+this.prefix+"ColorWheel").on("mousedown",function(e){t.colorWheelMouseDown(e)});$("#"+this.prefix+"ColorWheel").on("mouseup",function(e){t.colorWheelMouseUp(e)})}this.colorWheelRadius=100;var e=this.colorWheelRadius*2;var i=this.colorWheelRadius*2;this.colorWheelCanvas.width=e;this.colorWheelCanvas.height=i;this.colorWheelContext=this.colorWheelCanvas.getContext("2d");if(this.colorWheelImage==null){this.updateColorWheelImage()}this.colorWheelContext.putImageData(this.colorWheelImage,0,0);this.updateColorWheelValue();if(this.selectedColorWheelColorX!==false&&this.selectedColorWheelColorY!==false){var r=this.selectedColorWheelColorX;var a=this.selectedColorWheelColorY;this.colorWheelContext.strokeStyle="#333333";this.colorWheelContext.beginPath();this.colorWheelContext.arc(r,a,2,0,2*Math.PI);this.colorWheelContext.stroke();this.colorWheelContext.strokeStyle="#999999";this.colorWheelContext.beginPath();this.colorWheelContext.arc(r,a,3,0,2*Math.PI);this.colorWheelContext.stroke()}},drawImageColors:function(){var e=Math.ceil(this.imageColors.length/16);this.imagePaletteCanvas.style.width=16*(this.colorWidth+this.colorSpacing)+this.colorSpacing+"px";this.imagePaletteCanvas.style.height=e*(this.colorHeight+this.colorSpacing)+this.colorSpacing+"px";this.imagePaletteCanvas.width=16*(this.colorWidth+this.colorSpacing)+this.colorSpacing;this.imagePaletteCanvas.height=e*(this.colorHeight+this.colorSpacing)+this.colorSpacing;this.imagePaletteContext=this.imagePaletteCanvas.getContext("2d");var t=0;for(var i=0;i<16;i++){for(var r=0;r<16;r++){var a=this.colorSpacing+r*(this.colorWidth+this.colorSpacing);var s=this.colorSpacing+i*(this.colorHeight+this.colorSpacing);if(t<this.imageColors.length){var o=this.imageColors[t];if(o!==false){var l=("000000"+o.toString(16)).substr(-6);this.imagePaletteContext.fillStyle="#"+l;this.imagePaletteContext.fillRect(a,s,this.colorWidth,this.colorHeight)}else{this.imagePaletteContext.fillStyle="#444444";this.imagePaletteContext.fillRect(a,s,this.colorWidth,this.colorHeight)}}else{this.imagePaletteContext.fillStyle="#444444";this.imagePaletteContext.fillRect(a,s,this.colorWidth,this.colorHeight)}t++}}},update:function(){if(!this.colorPaletteDisplay){return}if(this.colorPaletteDisplay.marquee!==false){if(this.lastDashOffset!=this.editor.lastDashOffset){this.lastDashOffset=this.editor.lastDashOffset;this.colorPaletteDisplay.draw()}}},drawPalette:function(){this.colorPaletteDisplay.draw()}};var EditColorPaletteDialog=function(){this.editor=null;this.uiComponent=null;this.canvas=null;this.colorWidth=16;this.colorHeight=16;this.colorSpacing=2;this.colorsAcross=16;this.colorsDown=16;this.colors=[]};EditColorPaletteDialog.prototype={init:function(e){this.editor=e},htmlComponentLoaded:function(){this.canvas=document.getElementById("editColorPaletteCanvas");this.canvas.width=16*(this.colorWidth+this.colorSpacing)+this.colorSpacing;this.canvas.height=16*(this.colorHeight+this.colorSpacing)+this.colorSpacing;this.initColors();this.drawPalette()},initColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();console.log("colour count = "+e.getColorCount());this.colors=[];for(var t=0;t<256;t++){this.colors.push({color:false})}for(var t=0;t<e.getColorCount();t++){this.colors[t].color=e.getHex(t)}},show:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"editColorPalette",title:"Edit/Create Colour Palette",width:810});this.editColorPanel=UI.create("UI.HTMLPanel");this.editColorPanel.load("html/textMode/editColorPalette.html",function(){t.htmlComponentLoaded()});this.uiComponent.add(this.editColorPanel);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("mousedown",function(e){t.mouseDown(e)});this.uiComponent.on("mouseup",function(e){t.mouseUp(e)});this.uiComponent.on("mousemove",function(e){t.mouseMove(e)})}UI.showDialog("editColorPalette")},mouseDown:function(e){console.log("mouse down")},mouseMove:function(e){var t=e.clientX;var i=e.clientY;var r=$("#editColorPaletteCanvas").offset();if(t>r.left&&t<r.left+this.canvas.width&&i>r.top&&i<r.top+this.canvas.height){console.log("in canvas")}},mouseUp:function(e){console.log("mouse up")},drawPalette:function(){this.context=this.canvas.getContext("2d");var e=0;for(var t=0;t<this.colorsDown;t++){for(var i=0;i<this.colorsAcross;i++){var r=this.colorSpacing+i*(this.colorWidth+this.colorSpacing);var a=this.colorSpacing+t*(this.colorHeight+this.colorSpacing);if(e<this.colors.length){var s=this.colors[e].color;if(s!==false){var o=("000000"+s.toString(16)).substr(-6);console.log(this.colors[e].color);console.log("color hex string = "+o);this.context.fillStyle="#"+o;this.context.fillRect(r,a,this.colorWidth,this.colorHeight)}else{this.context.fillStyle="#444444";this.context.fillRect(r,a,this.colorWidth,this.colorHeight)}}else{this.context.fillStyle="#984323";this.context.fillRect(r,a,this.colorWidth,this.colorHeight)}e++}}}};var ColorSubPalettes=function(){this.editor=null;this.html="";this.uiComponent=null;this.currentColorSubPalette=0;this.currentColor=1;this.colorSubPaletteCount=4;this.colorPerColorSubPalette=4;this.subPalettes=[];this.checking=false};ColorSubPalettes.prototype={setColorSubPaletteCount:function(e){this.colorSubPaletteCount=e;if(e==4){this.subPalettes.push([33,32,41,22]);this.subPalettes.push([33,12,38,26]);this.subPalettes.push([33,18,44,29]);this.subPalettes.push([33,48,32,16])}else{while(this.subPalettes.length<this.colorSubPaletteCount){var t=[33,32,41,22];this.subPalettes.push(t)}}this.initHTML()},initColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();var t=e.getColorCount();var i=-1;for(var r=0;r<this.subPalettes.length;r++){for(var a=0;a<this.subPalettes[r].length;a++){var s=this.subPalettes[r][a];if(s>=t){i++;if(i>=t){i=0}this.subPalettes[r][a]=i}}}this.updateColors()},updateColors:function(){var e=this.currentColorSubPalette;for(var t=0;t<this.subPalettes[e].length;t++){this.setColor(t,this.subPalettes[e][t])}},check:function(e){var t=this;if(this.checking){return}this.checking=true;if(this.currentColorSubPalette=="undefined"){this.currentColorSubPalette=0}var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=i.getColorCount();console.log("colour count = "+r);this.initColors();if(typeof e!="undefined"){e()}this.checking=false},initHTML:function(){this.html="";this.html+='<div class="colorSubPalettePicker"  style="background-color: #111111; border: 1px solid #444444">';for(var e=0;e<this.colorSubPaletteCount;e++){this.html+='<div class="colorSubPalette" data-palette="'+e+'" style="">';this.html+='<div id="colorSubPalettePicker_'+e+'_0" style="position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background-color: #ffee66"></div>';this.html+='<div id="colorSubPalettePicker_'+e+'_1" style="position: absolute; top: 2px; left: 20px; width: 16px; height: 16px; background-color: #66ff66"></div>';this.html+='<div id="colorSubPalettePicker_'+e+'_2" style="position: absolute; top: 20px; left: 2px; width: 16px; height: 16px; background-color: #ffee66"></div>';this.html+='<div id="colorSubPalettePicker_'+e+'_3" style="position: absolute; top: 20px; left: 20px; width: 16px; height: 16px; background-color: #66ff66"></div>';this.html+='<div style="position: absolute; top: 4px; left: 50px; color: #eeeeee">Palette '+e+"</div>";this.html+="</div>"}this.html+="</div>"},init:function(e){this.editor=e;this.subPalettes=[];this.setColorSubPaletteCount(4);this.initHTML()},initEvents:function(){var i=this;$(".colorSubPalettePicker .colorSubPalette").on("click",function(e){var t=parseInt($(this).attr("data-palette"));i.closePicker();i.selectPalette(t)})},setPickerColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();for(var t=0;t<this.subPalettes.length;t++){for(var i=0;i<this.subPalettes[t].length;i++){var r=this.subPalettes[t][i];$("#colorSubPalettePicker_"+t+"_"+i).css("background-color","#"+e.getHexString(r))}}},showPicker:function(e,t,i){if(this.uiComponent==null){this.uiComponent=UI.create("UI.Popup",{id:"colorSubPalettePickerPopup",width:300,height:300});this.htmlComponent=UI.create("UI.HTMLPanel",{html:this.html});this.uiComponent.add(this.htmlComponent);this.initEvents()}this.setPickerColors();var r=180;var a=166;this.uiComponent.setDimensions(r,a);UI.showPopup("colorSubPalettePickerPopup",e,t);this.visible=true},closePicker:function(){if(this.visible){UI.hidePopup()}this.visible=false},showMobilePicker:function(e){console.log("show mobile picker");if(this.colorSubPalettePickerMobile==null){this.colorSubPalettePickerMobile=new ColorSubPalettePickerMobile;this.colorSubPalettePickerMobile.init(this.editor)}this.colorSubPalettePickerMobile.show(e)},setColor:function(e,t){var i=this.editor.colorPaletteManager.getCurrentColorPalette();$(".colorSubPaletteColor"+e).css("background-color","#"+i.getHexString(t));$(".colorSubPaletteColor"+e+"Mobile").css("background-color","#"+i.getHexString(t));if(e===0){for(var r=0;r<this.subPalettes.length;r++){this.subPalettes[r][e]=t}this.editor.setBackgroundColor(t,false)}else{this.subPalettes[this.currentColorSubPalette][e]=t}this.editor.colorsUpdated();this.editor.colorPalettePanel.updateSubPaletteColors();if(this.colorSubPalettePickerMobile){this.colorSubPalettePickerMobile.updateSubPaletteColors()}},getColor:function(e){return this.subPalettes[this.currentColorSubPalette][e]},getPaletteColor:function(e,t){if(e>=4||e<0||e===false){e=0}if(e>=this.subPalettes.length||t>=this.subPalettes[e].length){return 0}return this.subPalettes[e][t]},getPaletteCount:function(){return this.subPalettes.length},getPaletteColorCount:function(){return this.colorPerColorSubPalette},selectPaletteColor:function(e){this.currentColor=e;this.editor.tileEditor.tileEditorGrid.setColorIndex(e);this.editor.tools.drawTools.pixelDraw.color=e;this.editor.colorPalettePanel.highlightSubPaletteColor();if(this.colorSubPalettePickerMobile){this.colorSubPalettePickerMobile.highlightSubPaletteColor()}this.editor.tileEditor.drawSelectedSubPaletteColor();if(this.editor.tileEditorMobile){this.editor.tileEditorMobile.tileEditorMobileGrid.setColorIndex(e);this.editor.tileEditorMobile.drawSelectedSubPaletteColor()}this.editor.tools.drawTools.pixelDraw.drawSelectedSubPaletteColor()},getCurrentPalette:function(){return this.currentColorSubPalette},getCurrentPaletteColor:function(){return this.currentColor},selectPalette:function(e,t){var i=this.editor.colorPaletteManager.getCurrentColorPalette();if(typeof e!="undefined"){this.currentColorSubPalette=e}if(typeof t!="undefined"){this.currentColor=t;this.editor.colorPalettePanel.highlightSubPaletteColor()}$(".colorSubPaletteSelectedPaletteName").html("Palette "+this.currentColorSubPalette);for(var r=0;r<4;r++){var a=this.subPalettes[this.currentColorSubPalette][r];$(".colorSubPaletteColor"+r).css("background-color","#"+i.getHexString(a))}this.editor.currentTile.setColor(this.currentColorSubPalette,{force:true})}};var ColorSubPalettePickerMobile=function(){this.editor=null;this.colorPaletteDisplay=null;this.colorType="cell";this.uiComponent=null;this.id="Choose"};ColorSubPalettePickerMobile.prototype={on:function(e,t){if(e=="close"){this.closeHandler=t}},init:function(e,t){this.editor=e},initEvents:function(){var i=this;$(".colorPalettePanelSubPaletteColorMobile").on("click",function(){console.log("select colour");var e=parseInt($(this).attr("data-subpalette"),10);var t=parseInt($(this).attr("data-color"),10);console.log(e+","+t);i.selectSubPaletteColor(e,t)});this.colorPaletteDisplay.on("colorselected",function(e){i.colorSelected(e.colorIndex,e.color)})},show:function(e){var t=this;this.callback=e.colorPickedCallback;if(this.uiComponent==null){var i=500;var r=100;var a=UI.getScreenWidth();var s=UI.getScreenHeight();i=a-30;r=s-30;this.uiComponent=UI.create("UI.MobilePanel",{id:"colorSubPalettePickerMobile"+this.id,title:"Choose Palette",width:i,height:r});var o="";o+='<h2 style="margin: 0 0 14px 0" id="">Color Palette</h2>';o+='<div style="text-align: center">';o+='<canvas id="colorSubPalettePickerMobileCanvas'+this.id+'"></canvas>';o+="</div>";var l=4;o+='<div id="colorPalettePanelSubPalettesMobile">';for(var n=0;n<l;n++){o+='    <div class="colorPalettePanelSubPaletteMobile" data-subPalette="'+n+'">';o+='      <div class="colorPalettePanelSubPaletteHolderMobile">';o+='        <div class="colorPalettePanelSubPaletteLabelMobile">'+n+":</div>";o+='        <div class="colorPalettePanelSubPaletteColorsMobile">';o+='          <div class="colorPalettePanelSubPaletteColorMobile" id="colorPalettePanelSubPalette'+n+'-Color0Mobile" data-subPalette="'+n+'" data-color="0"></div>';o+='          <div class="colorPalettePanelSubPaletteColorMobile" id="colorPalettePanelSubPalette'+n+'-Color1Mobile" data-subPalette="'+n+'" data-color="1"></div>';o+='          <div class="colorPalettePanelSubPaletteColorMobile" id="colorPalettePanelSubPalette'+n+'-Color2Mobile" data-subPalette="'+n+'" data-color="2"></div>';o+='          <div class="colorPalettePanelSubPaletteColorMobile" id="colorPalettePanelSubPalette'+n+'-Color3Mobile" data-subPalette="'+n+'" data-color="3"></div>';o+="        </div>";o+="      </div>";o+="    </div>"}o+="</div>";var h=UI.create("UI.HTMLPanel",{id:"colorSubPalettePickerMobileHTML"+this.id,html:o});this.uiComponent.add(h);this.uiComponent.on("close",function(){});this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:"colorSubPalettePickerMobileCanvas"+this.id,canSelectMultiple:this.canSelectMultiple,maxSelectableColors:1,canSelectWithRightMouseButton:false});this.colorPaletteDisplay.draw();this.initEvents()}UI.showDialog("colorSubPalettePickerMobile"+this.id);var d=this.editor.colorPaletteManager.getCurrentColorPalette();var c=[];var f=d.getColorCount();for(var n=0;n<f;n++){c.push(d.getHex(n))}var u=d.getCurrentColorMap();var p=8;var v=8;if(u.length>0&&u[0].length>0){p=u[0].length;v=u.length}var g=34;var m=34;var y=4;if(p>12||v>12){g=20;m=20}if(typeof e.colors!="undefined"){this.colorPaletteDisplay.setSelectedColors(e.colors)}this.colorPaletteDisplay.setColorSize(g,m,y);this.colorPaletteDisplay.setColors(c,{colorMap:d.getCurrentColorMap()});var a=UI.getScreenWidth();var s=UI.getScreenHeight();var b=s-111-120;if(p>6&&a<800){this.colorPaletteDisplay.fitToWidth(a-24)}if(this.colorPaletteDisplay.getHeight()>b){console.log("setting max height");g=14;m=14;y=3;this.colorPaletteDisplay.setColorSize(g,m,y)}this.colorPaletteDisplay.draw();if(typeof e.currentColor!="undefined"){var d=this.editor.colorPaletteManager.getCurrentColorPalette();if(e.currentColor===false){return}var C=d.getHexString(e.currentColor);$("#colorPickerMobileCurrent"+this.id).css("background-color","#"+C)}this.updateSubPaletteColors()},colorSelected:function(e,t){var i=this.editor.colorPaletteManager.colorSubPalettes;var r=i.getCurrentPalette();var a=i.getCurrentPaletteColor();i.setColor(a,t);this.editor.currentTile.setColor(r,{force:true})},selectSubPaletteColor:function(e,t){this.editor.colorPaletteManager.colorSubPalettes.selectPalette(e,t);this.editor.colorPaletteManager.colorSubPalettes.selectPaletteColor(t)},highlightSubPaletteColor:function(){$(".colorPalettePanelSubPaletteColorMobile").removeClass("colorPalettePanelSubPaletteColorMobile-selected");var e=this.editor.colorPaletteManager.colorSubPalettes.getCurrentPalette();var t=this.editor.colorPaletteManager.colorSubPalettes.getCurrentPaletteColor();$("#colorPalettePanelSubPalette"+e+"-Color"+t+"Mobile").addClass("colorPalettePanelSubPaletteColorMobile-selected");this.updateSubPaletteColors();var i=this.editor.colorPaletteManager.colorSubPalettes;console.log("highlight sub palette colours!!!!");console.log("palette = "+e+","+t);var r=i.getPaletteColor(e,t);if(r!==false){this.colorPaletteDisplay.setSelectedColors([r]);this.colorPaletteDisplay.draw()}console.log("colorIndex = "+r)},updateSubPaletteColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();var t=this.editor.colorPaletteManager.colorSubPalettes;var i=t.getPaletteCount();var r=t.getPaletteColorCount();for(var a=0;a<i;a++){for(var s=0;s<r;s++){var o=t.getPaletteColor(a,s);var l=e.getHexString(o);$("#colorPalettePanelSubPalette"+a+"-Color"+s+"Mobile").css("background-color","#"+l);$("#colorPalettePanelSubPalette"+a+"-Color"+s+"Mobile").css("border-color","#"+l)}}$(".colorPalettePanelSubPaletteColorMobile-selected").css("border-color","#888888")}};var ColorPaletteSave=function(){this.editor=null;this.colorPaletteDisplay=null;this.colorPalette=null;this.sortOrder="default";this.cellWidth=8;this.cellHeight=8};ColorPaletteSave.prototype={init:function(e){this.editor=e},show:function(e){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"saveColorPaletteDialog",title:"Save Colour Palette",width:640});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/colorPaletteSave.html",function(){t.initContent(e);t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.save();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent(e)}UI.showDialog("saveColorPaletteDialog")},initContent:function(e){if(this.colorPaletteDisplay==null){this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:"saveColorPaletteCanvas"})}if(typeof e!="undefined"&&typeof e.colorPalette!="undefined"){this.colorPalette=e.colorPalette}else{this.colorPalette=this.editor.colorPaletteManager.getCurrentColorPalette()}var t=this.colorPalette;this.colorsAcross=t.getColorsAcross();var i=[];var r=t.getColorCount();for(var a=0;a<r;a++){i.push(t.getHex(a))}this.sortOrder=$("#saveColorPaletteSortOrder").val();this.saveFormat=$("#saveColorPaletteFormat").val();$("#saveColorPaletteColorsAcross").val(this.colorsAcross);this.colorPaletteDisplay.setColors(i,{colorsAcross:this.colorsAcross});this.setColorsAcross(this.colorsAcross);this.setSortOrder(this.sortOrder);this.colorPaletteDisplay.fitToWidth(240);this.colorPaletteDisplay.draw();this.setSaveFormat(this.saveFormat)},setCellWidth:function(e){this.cellWidth=e;this.setSortOrder(this.sortOrder)},setCellHeight:function(e){this.cellHeight=e;this.setSortOrder(this.sortOrder)},setColorsAcross:function(e){this.colorsAcross=e;this.colorPaletteDisplay.setColorsAcross(e);this.setSortOrder(this.sortOrder)},setSortOrder:function(e){console.log("get color map");this.sortOrder=e;var t=this.colorPalette.getColorMap(this.sortOrder,this.colorsAcross);this.colorPaletteDisplay.setColorMap(t);this.colorPaletteDisplay.setColorSize(this.cellWidth,this.cellHeight,0);this.colorPaletteDisplay.draw()},initEvents:function(){var i=this;$("#saveColorPaletteSortOrder").on("change",function(e){var t=$(this).val();i.setSortOrder(t)});$("#saveColorPaletteFormat").on("change",function(e){var t=$(this).val();i.setSaveFormat(t)});$("#saveColorPaletteColorsAcross").on("keyup",function(e){var t=parseInt($(this).val(),10);if(isNaN(t)){return}i.setColorsAcross(t)});$("#saveColorPaletteColorsAcross").on("change",function(e){var t=parseInt($(this).val(),10);if(isNaN(t)){return}i.setColorsAcross(t)});$("#saveColorPaletteCellWidth").on("keyup",function(e){var t=parseInt($(this).val(),10);if(isNaN(t)){return}i.setCellWidth(t)});$("#saveColorPaletteCellWidth").on("change",function(e){var t=parseInt($(this).val(),10);if(isNaN(t)){return}i.setCellWidth(t)});$("#saveColorPaletteCellHeight").on("keyup",function(e){var t=parseInt($(this).val(),10);if(isNaN(t)){return}i.setCellHeight(t)});$("#saveColorPaletteCellHeight").on("change",function(e){var t=parseInt($(this).val(),10);if(isNaN(t)){return}i.setCellHeight(t)})},setSaveFormat:function(e){this.saveFormat=e;if(this.saveFormat=="json"){$("#saveColorPaletteSortOrderRow").hide()}else{$("#saveColorPaletteSortOrderRow").show()}if(this.saveFormat=="png"){$("#saveColorPaletteColorsAcrossRow").show();$("#saveColorPaletteCellWidthRow").show();$("#saveColorPaletteCellHeightRow").show();var t=this.colorPalette.getColorCount();$("#saveColorPaletteColorsAcross").attr("max",t);this.cellWidth=parseInt($("#saveColorPaletteCellWidth").val(),10);this.cellHeight=parseInt($("#saveColorPaletteCellHeight").val(),10);this.setColorsAcross(i)}else{$("#saveColorPaletteColorsAcrossRow").hide();$("#saveColorPaletteCellWidthRow").hide();$("#saveColorPaletteCellHeightRow").hide();var i=this.colorPalette.getColorsAcross();this.cellWidth=16;this.cellHeight=16;this.setColorsAcross(i)}},save:function(){var e=$("#saveColorPaletteAs").val();var t=this.saveFormat;var i=this.colorPalette;var r=this.colorPaletteDisplay.getColorMap();switch(t){case"json":i.saveAsJSON(e);break;case"png":i.saveAsPNG(e,r,this.cellWidth,this.cellHeight);break;case"aco":i.saveAsAco(e,r);break;case"ase":i.saveAsAse(e,r);break;case"gpl":i.saveAsGPL(e,r);break;case"txt":i.saveAsTxt(e,r);break;case"hex":i.saveAsHex(e,r);break}},saveAsGPL:function(e){var t=""},saveAsTxt:function(e){},saveAsHex:function(e){}};var ColorPaletteLoad=function(){this.importImage=null;this.paletteCanvas=null;this.colorPaletteDisplay=null;this.colorsAcross=8;this.importColors=16;this.colorMap=[];this.editor=null;this.loadMap=false;this.ase=null;this.aco=null;this.visible=false;this.callback=false;this.dialogReadyCallback=false;this.parentComponent=null;this.colorPaletteLoadFromURL=null;this.name=""};ColorPaletteLoad.prototype={init:function(e,t){this.editor=e;if(typeof t!="undefined"){this.parentComponent=t}},show:function(e){if(typeof e!="undefined"){if(typeof e.dialogReadyCallback!="undefined"){this.dialogReadyCallback=e.dialogReadyCallback}}var t=this;if(this.uiComponent==null){if(this.parentComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"colourPaletteLoadDialog",title:"Colour Palette Load",width:384})}else{this.uiComponent=this.parentComponent}this.colorPaletteLoadPanel=UI.create("UI.HTMLPanel");this.uiComponent.add(this.colorPaletteLoadPanel);this.colorPaletteLoadPanel.load("html/textMode/colorPaletteLoad.html",function(){t.htmlComponentLoaded();t.initContent();t.initEvents();if(t.dialogReadyCallback!=false){t.dialogReadyCallback()}});if(!this.parentComponent){this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.setPalette();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){t.visible=false})}if(this.parentComponent==null){UI.showDialog("colourPaletteLoadDialog")}this.visible=true}else{this.initContent();if(this.parentComponent==null){UI.showDialog("colourPaletteLoadDialog")}this.visible=true;if(t.dialogReadyCallback!=false){t.dialogReadyCallback()}}},initContent:function(){if(this.colorPaletteDisplay==null){this.colorPaletteDisplay=new ColorPaletteDisplay;this.colorPaletteDisplay.init(this.editor,{canvasElementId:"colorPaletteLoadPreview"})}this.sortMethod=$("#colorPaletteLoadColorsSortMethod").val()},htmlComponentLoaded:function(){this.paletteCanvas=document.getElementById("colorPaletteLoadPreview")},initEvents:function(){var i=this;$("#colorPaletteLoadURLButton").on("click",function(e){var t=$("#colorPaletteLoadURL").val();i.loadPaletteFromURL(t)});$("#colorPaletteFileChoose").on("click",function(){$("#colourPaletteFile").click()});$("#colorPaletteLoadLospec").on("click",function(){i.loadLospecPalette()});$("#colorPaletteLoadColorsAcross").on("keyup",function(e){var t=parseInt($("#colorPaletteLoadColorsAcross").val(),10);if(!isNaN(t)){i.setColorsAcross(t)}});$("#colorPaletteLoadColorsAcross").on("change",function(e){var t=parseInt($("#colorPaletteLoadColorsAcross").val(),10);if(!isNaN(t)){i.setColorsAcross(t)}});$("#colorPaletteLoadUserColorCount").on("change",function(e){var t=parseInt($(this).val(),10);if(!isNaN(t)){i.setColorCount(t)}});$("#colorPaletteLoadUserColorCount").on("keyup",function(e){var t=parseInt($(this).val(),10);if(!isNaN(t)){i.setColorCount(t)}});document.getElementById("colourPaletteFile").addEventListener("change",function(e){var t=document.getElementById("colourPaletteFile").files[0];i.setImportFile(t)})},loadLospecPalette:function(){if(this.colorPaletteLoadFromURL==null){this.colorPaletteLoadFromURL=new ColorPaletteLoadFromURL}var t=this;this.colorPaletteLoadFromURL.show({callback:function(e){t.createPaletteFromLoSpec(e.response)}})},loadPaletteFromURL:function(e){if(this.colorPaletteLoadFromURL==null){this.colorPaletteLoadFromURL=new ColorPaletteLoadFromURL}console.log("load palette from url"+e);var t=this;this.colorPaletteLoadFromURL.loadURL({url:e,callback:function(e){t.createPaletteFromLoSpec(e.response)}})},createPaletteFromLoSpec:function(e){this.name=e.name;var t=e.author;var i=[];for(var r=0;r<e.colors.length;r++){var a=parseInt(e.colors[r],16);if(!isNaN(a)){i.push(a)}}if(i.length>0){this.colors=i;this.setAlpha();if(this.callback){this.callback(this.colors)}if(this.visible){this.setColorCount(i.length);this.autoColorsAcross();this.updatePreviewPalette()}}},setPalette:function(e){var t=false;if(typeof e!="undefined"){t=e.callback}var i=this.editor.colorPaletteManager;var r=false;var a=i.getCurrentColorPalette();if(a==null||typeof e.createColorPalette!="undefined"&&e.createColorPalette){r=true;a=new ColorPalette}var s=Math.ceil(this.colors.length/this.colorsAcross);a.setColors(this.colors,this.colorsAcross,s);if(r){if(t){t({colorPaletteCreated:true,colorPalette:a,presetId:false,description:{name:this.name}})}}else{a.clearPaletteMaps();if(this.loadMap){var o=a.setColorPaletteMap("Default Layout",this.colorMap);a.setCurrentColorMap(o)}a.paletteChanged();if(g_app.getMode()=="color palette"){g_app.colorPaletteEditor.draw()}}},setColorsAcross:function(e){this.colorsAcross=e;this.updatePreviewPalette()},autoColorsAcross:function(){this.colorsAcross=16;if(this.colors.length<=8){this.colorsAcross=4}else if(this.colors.length<=16){this.colorsAcross=16}$("#colorPaletteLoadColorsAcross").val(this.colorsAcross)},createColorMap:function(){var e=this.colorsAcross;var t=this.importColors;var i=Math.ceil(this.importColors/e);if(t>this.colors.length){t=this.colors.length}var r=0;this.colorMap=[];for(var a=0;a<i;a++){this.colorMap[a]=[];for(var s=0;s<e;s++){if(r<t){this.colorMap[a][s]=r}else{this.colorMap[a][s]=this.editor.colorPaletteManager.noColor}r++}}},setImportFile:function(e,t){if(typeof e=="undefined"){return}if(typeof t!="undefined"){this.callback=t}var i=e.name;this.name=i;$("#colorPaletteFileChooseName").html(i);var r=i.split(".").pop().toLowerCase();this.loadMap=false;if(r=="png"||r=="jpg"||r=="gif"){this.loadPNG(e)}if(r=="ase"){this.loadASE(e)}if(r=="aco"){this.loadACO(e)}if(r=="txt"||r=="hex"){this.loadTXT(e)}if(r=="vpl"){this.loadVPL(e)}if(r=="gpl"){this.loadGPL(e)}if(r=="act"){this.loadBinary(e)}if(r=="json"){this.loadJSON(e)}},loadPNG:function(e){if(!this.importImage){this.importImage=new Image}var t=this;this.importImage.onload=function(){t.createPaletteFromImage()};var i=window.URL||window.webkitURL;var r=i.createObjectURL(e);this.importImage.src=r},loadTXT:function(e){var i=this;var t=new FileReader;t.onload=function(e){var t=e.target.result;i.createPaletteFromPaintTxt(t)};t.readAsText(e)},loadVPL:function(e){var i=this;var t=new FileReader;t.onload=function(e){var t=e.target.result;i.createPaletteFromVPL(t)};t.readAsText(e)},loadGPL:function(e){var i=this;var t=new FileReader;t.onload=function(e){var t=e.target.result;i.createPaletteFromGPL(t)};t.readAsText(e)},loadACO:function(e){var t=this;var i=new FileReader;i.onload=function(e){t.createPaletteFromACO(new Uint8Array(e.target.result))};i.readAsArrayBuffer(e)},loadASE:function(e){if(this.ase==null){this.ase=new ASE}var t=this;var i=new FileReader;i.onload=function(e){t.createPaletteFromASE(new Uint8Array(e.target.result))};i.readAsArrayBuffer(e)},loadBinary:function(e){var t=this;var i=new FileReader;i.onload=function(e){t.createPaletteFromBinary(new Uint8Array(e.target.result))};i.readAsArrayBuffer(e)},errorMessage:function(e){$("#colorPaletteLoadError").html(e);if(e!=""){$("#colorPaletteLoadError").show()}else{$("#colorPaletteLoadError").hide()}},loadJSON:function(e){var i=this;var t=new FileReader;t.onload=function(e){var t=e.target.result;i.createPaletteFromJSON(t)};t.readAsText(e)},setAlpha:function(){for(var e=0;e<this.colors.length;e++){var t=255>>>0;var i=this.colors[e]>>>0;this.colors[e]=(t<<24|i)>>>0}},createPaletteFromJSON:function(e){var t={};try{t=$.parseJSON(e);if(typeof t.colorPalette!="undefined"){t=t.colorPalette}var i=[];if(typeof t.data!="undefined"){for(var r=0;r<t.data.length;r++){i.push(t.data[r])}}if(typeof t.across!="undefined"){this.colorsAcross=t.across;$("#colorPaletteLoadColorsAcross").val(this.colorsAcross)}else{this.autoColorsAcross()}if(typeof t.maps!="undefined"&&t.maps.length>0){this.loadMap=true;this.colorMap=[];var a=t.maps[0];for(var s=0;s<a.map.length;s++){this.colorMap[s]=[];for(var o=0;o<a.map[s].length;o++){this.colorMap[s][o]=a.map[s][o]}}}else{this.loadMap=false}if(i.length>0){this.colors=i;this.setColorCount(i.length);if(this.callback){this.callback(this.colors)}if(this.visible){this.updatePreviewPalette()}this.errorMessage("")}else{this.errorMessage("No colours found")}}catch(e){this.errorMessage("Sorry, unable to interpret file")}},createPaletteFromASE:function(e){if(this.ase==null){this.ase=new ASE}var t=this.ase.readPalette(e);if(t===false){this.errorMessage("No colours found");return}this.colors=t;this.setAlpha();if(this.callback){this.callback(this.colors)}if(this.visible){this.setColorCount(t.length);this.autoColorsAcross();this.updatePreviewPalette();this.errorMessage("")}},createPaletteFromACO:function(e){if(this.aco==null){this.aco=new ACO}var t=this.aco.readPalette(e);if(t===false){this.errorMessage("No colours found");return}this.colors=t;this.setAlpha();if(this.callback){this.callback(this.colors)}if(this.visible){this.setColorCount(t.length);this.autoColorsAcross();this.updatePreviewPalette();this.errorMessage("")}},createPaletteFromImage:function(){var e=null;if(this.editor){e=this.editor.colorPaletteManager}else if(g_app&&g_app.textModeEditor){e=g_app.textModeEditor.colorPaletteManager}if(!e){console.log("couldnt find color palette manager");return}var t=e.colorPaletteFromPaletteImg(this.importImage);this.colors=t.colors;this.setAlpha();if(this.callback){this.callback(this.colors)}if(this.visible){if(t.map!==false){this.loadMap=true;this.colorMap=t.map}else{this.loadMap=false}this.setColorCount(this.colors.length);this.colorsAcross=t.colorsAcross;this.updatePreviewPalette()}},createPaletteFromVPL:function(e){var t=[];e=e.replace("\r","");var i=e.split("\n");for(var r=0;r<i.length;r++){var a=i[r].trim();if(a.length>0){if(a[0]=="#"){}else{parts=a.split(" ");if(parts.length>=3){var s=parseInt(parts[0],16);var o=parseInt(parts[1],16);var l=parseInt(parts[2],16);if(!isNaN(s)&&!isNaN(o)&&!isNaN(l)){var n=(s<<16)+(o<<8)+l;t.push(n)}}}}}if(t.length>0){this.colors=t;this.setAlpha();if(this.callback){this.callback(this.colors)}if(this.visible){this.setColorCount(t.length);if(t.length==16){this.colorsAcross=8;$("#colorPaletteLoadColorsAcross").val(this.colorsAcross)}else{this.autoColorsAcross()}this.updatePreviewPalette()}}},createPaletteFromPaintTxt:function(e){var t=[];e=e.replace("\r","");var i=e.split("\n");for(var r=0;r<i.length;r++){var a=i[r].trim();if(a.length>0){if(a[0]==";"){}else{if(a.length==8){var s=a.substring(2);var o=parseInt(s,16);if(!isNaN(o)){t.push(o)}}else if(a.length==6){var o=parseInt(a,16);if(!isNaN(o)){t.push(o)}}}}}if(t.length>0){this.colors=t;this.setAlpha();if(this.callback){this.callback(this.colors)}if(this.visible){this.setColorCount(t.length);this.autoColorsAcross();this.updatePreviewPalette()}}},createPaletteFromBinary:function(e){var t=[];var i=3;for(var r=0;r<e.length;r+=i){var a=e[r];var s=e[r+1];var o=e[r+2];if(!isNaN(a)&&!isNaN(s)&&!isNaN(o)){var l=(a<<16)+(s<<8)+o;t.push(l)}}if(t.length>0){this.colors=t;this.setAlpha();if(this.callback){this.callback(this.colors)}if(this.visible){this.setColorCount(t.length);this.autoColorsAcross();this.updatePreviewPalette()}}},createPaletteFromGPL:function(e){var t=[];e=e.trim().replace("\r","");var i=e.split("\n");if(i.length==0){return}if(i[0]!="GIMP Palette"){this.errorMessage("Unknown palette format: "+i[0]);return}for(var r=1;r<i.length;r++){var a=i[r].trim();if(a[0]=="#"){}else{var s=a.split(/[\s,\t\n]+/);if(s.length>=3){var o=parseInt(s[0]);var l=parseInt(s[1]);var n=parseInt(s[2]);if(!isNaN(o)&&!isNaN(l)&&!isNaN(n)){var h=(o<<16)+(l<<8)+n;t.push(h)}}}}if(t.length>0){this.colors=t;this.setAlpha();if(this.callback){this.callback(this.colors)}if(this.visible){this.autoColorsAcross();this.setColorCount(t.length);this.updatePreviewPalette()}}},getColors:function(){return this.colors},setColorCount:function(e){if(e>256){e=256}this.importColors=e;$("#colorPaletteLoadUserColorCount").val(e);this.updatePreviewPalette()},updatePreviewPalette:function(){if(!this.loadMap){this.createColorMap()}$("#colorPaletteLoadColorsAcross").val(this.colorsAcross);this.colorPaletteDisplay.setColors(this.colors,{colorCount:this.importColors,colorMap:this.colorMap});$("#colorPaletteLoadSettings").show();$("#colorPaletteLoadColorCount").html(this.colors.length)}};var ColorPaletteLoadFromURL=function(){this.uiComponent=null;this.visible=false;this.callback=false};ColorPaletteLoadFromURL.prototype={init:function(){},show:function(e){this.callback=e.callback;if(this.uiComponent==null){var t=this;this.uiComponent=UI.create("UI.Dialog",{id:"colorPaletteLoadURLDialog",title:"Load Lospec Palette",width:384,height:170});var i='<div style="padding: 10px">';i+='<div style="margin-bottom: 10px">Enter the URL of a <a href="https://lospec.com/palette-list" target="_blank">Lospec palette</a></div>';i+='<div style="margin: 6px 0" id="colorPaletteLoadStatus">&nbsp;</div>';i+='<input type="text" style="width: 320px" id="colorPaletteLoadURL" placeholder="https://lospec.com/palette-list/palette-slug">';i+="</div>";var r=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.add(r);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.submit()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){t.visible=false});this.visible=true;UI.showDialog("colorPaletteLoadURLDialog");$("#colorPaletteLoadStatus").html("&nbsp;");this.initEvents();$("#colorPaletteLoadURL").focus()}else{this.visible=true;$("#colorPaletteLoadStatus").html("&nbsp;");UI.showDialog("colorPaletteLoadURLDialog");$("#colorPaletteLoadURL").focus()}},initEvents:function(){var t=this;$("#colorPaletteLoadURL").on("keypress",function(e){if(e.keyCode==13){t.submit()}})},submit:function(){var t=this;var e=$("#colorPaletteLoadURL").val();$("#colorPaletteLoadStatus").html("loading...");this.loadURL({url:e,callback:function(e){if(e.success==false){$("#colorPaletteLoadStatus").html('<div style="color: red; display: inline-block">Error</div> unable to load url')}else{$("#colorPaletteLoadStatus").html("&nbsp;");t.callback(e);UI.closeDialog()}}})},loadURL:function(e){var t=e.url;var i=e.callback;var r=t;var a=t.split("/");if(a.length>0){var s=false;for(var o=0;o<a.length;o++){if(s&&a[o].trim()!=""){r=a[o]}if(a[o].toLowerCase()=="palette-list"){s=true}}}console.log(a);console.log("slug == "+r);var l=r.indexOf(".csv");if(l!==-1){r=r.substring(0,l)}if(r.indexOf(".json")==-1){r+=".json"}t="https://lospec.com/palette-list/"+r;console.log("slug = "+r);console.log("url = "+t);try{$.get({url:t,error:function(){i({success:false,message:""})},success:function(t){try{t=$.parseJSON(t);i({success:true,response:t})}catch(e){i({success:false,message:e.getMessage()});console.log(t)}}})}catch(e){i({success:false,message:e.getMessage()})}}};var ColorPaletteDisplay=function(){this.canvas=null;this.context=null;this.canvasScale=1;this.colorWidth=20;this.colorHeight=20;this.colorSpacing=1;this.colorsAcross=8;this.colorsDown=2;this.colorCount=16;this.colors=[];this.selectedColors=[];this.highlightColor=false;this.cursorRGB=false;this.colorSelected=false;this.highlightChanged=false;this.touchColorHandler=false;this.touchEndColorHandler=false;this.buttons=0;this.useColorMap=true;this.colorMap=[];this.noColor=-1;this.lastGridX=false;this.lastGridY=false;this.gridMouseMove=false;this.gridMouseDown=false;this.gridMouseUp=false;this.gridEndDrag=false;this.gridEndMarqueeDrag=false;this.gridDoubleClick=false;this.marqueeChanged=false;this.gridLinesVisible=false;this.selectEnabled=true;this.highlightEnabled=true;this.highlightGridX=false;this.highlightGridY=false;this.inDragMarquee=false;this.dragMarqueeContents=false;this.inDragColor=false;this.dragColorX=false;this.dragColorY=false;this.dragColorIndex=false;this.dragOffsetX=0;this.dragOffsetY=0;this.maxSelectableColors=2;this.canSelectWithRightMouseButton=false;this.canSelectMultiple=false;this.touchColorEndHandler=false;this.multipleSelectMode="add";this.marquee=false;this.marqueeLeft=0;this.marqueeWidth=1;this.marqueeTop=0;this.marqueeHeight=2;this.type="";this.canvasElementId=false;this.maxColorWidth=false;this.drawEnabled=true;this.drawHighlightInMarquee=true};ColorPaletteDisplay.prototype={init:function(e,t){this.editor=e;this.canvasElementId=t.canvasElementId;this.selectedColors[0]=this.editor.colorPaletteManager.noColor;this.selectedColors[1]=this.editor.colorPaletteManager.noColor;this.highlightColor=this.editor.colorPaletteManager.noColor;if(typeof t!="undefined"){if(typeof t.gridLinesVisible!="undefined"){this.gridLinesVisible=t.gridLinesVisible}if(typeof t.selectEnabled!="undefined"){this.selectEnabled=t.selectEnabled}if(typeof t.highlightEnabled!="undefined"){this.highlightEnabled=t.highlightEnabled}if(typeof t.maxSelectableColors!="undefined"){this.maxSelectableColors=t.maxSelectableColors}if(typeof t.canSelectWithRightMouseButton!="undefined"){this.canSelectWithRightMouseButton=t.canSelectWithRightMouseButton}if(typeof t.canSelectMultiple!="undefined"){this.canSelectMultiple=t.canSelectMultiple}}if(this.canSelectMultiple){this.selectedColors=[]}},initEvents:function(){var t=this;$("#"+this.canvasElementId).on("mousedown",function(e){t.mouseDown(e)});$("#"+this.canvasElementId).on("mousemove",function(e){t.mouseMove(e)});$("#"+this.canvasElementId).on("mouseup",function(e){t.mouseUp(e)});this.canvas.addEventListener("dblclick",function(e){t.doubleClick(e)},false);this.canvasElement=document.getElementById(this.canvasElementId);this.canvasElement.addEventListener("touchstart",function(e){t.touchStart(e)},false);this.canvasElement.addEventListener("touchmove",function(e){t.touchMove(e)},false);this.canvasElement.addEventListener("touchend",function(e){t.touchEnd(e)},false);$("#"+this.canvasElementId).on("contextmenu",function(e){e.preventDefault()});$("#"+this.canvasElementId).on("mouseenter",function(e){t.mouseEnter(e)});$("#"+this.canvasElementId).on("mouseleave",function(e){t.mouseLeave(e)})},setDrawEnabled:function(e){this.drawEnabled=e},getDrawEnabled:function(){return this.drawEnabled},setDrawHighlightInMarquee:function(e){this.drawHighlightInMarquee=e},setup:function(){if(this.canvas===null){this.canvas=document.getElementById(this.canvasElementId);this.initEvents()}this.canvasScale=Math.floor(UI.devicePixelRatio);var e=1;var t=1;if(this.colorMap.length>0){e=this.colorMap[0].length;t=this.colorMap.length}var i=(this.colorWidth+this.colorSpacing)*e+this.colorSpacing;var r=(this.colorHeight+this.colorSpacing)*t+this.colorSpacing;if(i==0){i=1}if(r==0){r=1}this.canvas.width=i*this.canvasScale;this.canvas.height=r*this.canvasScale;this.canvas.style.width=i+"px";this.canvas.style.height=r+"px";this.context=this.canvas.getContext("2d");this.context.scale(this.canvasScale,this.canvasScale)},getCanvas:function(){return this.canvas},getCanvasWidth:function(){return this.canvas.width},getCanvasHeight:function(){return this.canvas.height},setColorSize:function(e,t,i){this.colorWidth=e;this.colorHeight=t;if(typeof i!="undefined"){this.colorSpacing=i}this.setup()},getColorsAcross:function(){return this.colorsAcross},setType:function(e){this.type=e},setMarqueeBounds:function(e,t,i,r){this.marqueeLeft=e;this.marqueeTop=t;this.marqueeWidth=i;this.marqueeHeight=r;if(this.marqueeChanged!==false){this.marqueeChanged(e,t,i,r)}},setMarqueeEnabled:function(e){this.marquee=e},getMarqueeEnabled:function(){return this.marquee},inMarquee:function(e,t){return e>=this.marqueeLeft&&e<this.marqueeLeft+this.marqueeWidth&&t>=this.marqueeTop&&t<this.marqueeTop+this.marqueeHeight},getHeight:function(){return Math.ceil(this.canvas.height/this.canvasScale)},getWidth:function(){return Math.ceil(this.canvas.width/this.canvasScale)},setButtons:function(e){if(e.buttons!="undefined"){this.buttons=e.buttons}if(e.buttons==="undefined"&&e.nativeEvent!=="undefined"){this.buttons=e.nativeEvent.buttons}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons==1){this.buttons=2}if(e.metaKey&&this.buttons==1){this.buttons=4}},on:function(e,t){if(e=="colorselected"){this.colorSelected=t}if(e=="highlightchanged"){this.highlightChanged=t}if(e=="mousemove"){this.gridMouseMove=t}if(e=="doubleclick"){this.gridDoubleClick=t}if(e=="mousedown"){this.gridMouseDown=t}if(e=="mouseup"){this.gridMouseUp=t}if(e=="mouseenter"){this.gridMouseEnter=t}if(e=="mouseleave"){this.gridMouseLeave=t}if(e=="enddrag"){this.gridEndDrag=t}if(e=="endmarqueedrag"){this.gridEndMarqueeDrag=t}if(e=="marqueechanged"){this.marqueeChanged=t}if(e=="touchcolor"){this.touchColorHandler=t}if(e=="touchcolorend"){this.touchColorEndHandler=t}},mouseEnter:function(e){if(this.gridMouseEnter){this.gridMouseEnter(e)}},mouseLeave:function(e){this.setHighlightColor(this.editor.colorPaletteManager.noColor);if(this.gridMouseLeave){this.gridMouseLeave(e)}},multipleSelect:function(e){var t=false;for(var i=0;i<this.selectedColors.length;i++){if(this.selectedColors[i]===e){t=i;break}}if(t!==false){if(this.multipleSelectMode=="remove"){this.selectedColors.splice(t,1)}}else{if(this.multipleSelectMode=="add"){this.selectedColors.push(e)}}this.draw()},touchStart:function(e){e.preventDefault();var t=e.changedTouches;if(t.length>0){var i=t[0].pageX-$("#"+this.canvasElementId).offset().left;var r=t[0].pageY-$("#"+this.canvasElementId).offset().top;var a=this.xyToColor(i,r);if(a!==false){if(this.touchColorHandler!==false){this.touchColorHandler(a)}if(this.selectEnabled){if(a!==this.editor.colorPaletteManager.noColor){if(this.canSelectMultiple){this.multipleSelectMode="add";for(var s=0;s<this.selectedColors.length;s++){if(this.selectedColors[s]===a){this.multipleSelectMode="remove";break}}this.multipleSelect(a)}else{this.selectedColors[0]=a}if(this.colorSelected!==false){this.colorSelected({color:a,colorIndex:0})}}if(this.buttons&2&&this.canSelectWithRightMouseButton){this.selectedColors[1]=a;if(this.colorSelected!==false){this.colorSelected({color:a,colorIndex:1})}}this.draw()}}}},touchMove:function(e){e.preventDefault();var t=e.changedTouches;if(t.length>0){var i=t[0].pageX-$("#"+this.canvasElementId).offset().left;var r=t[0].pageY-$("#"+this.canvasElementId).offset().top;var a=this.xyToColor(i,r);if(a!==false){if(this.touchColorHandler!==false){this.touchColorHandler(a)}if(this.canSelectMultiple){var a=this.xyToColor(i,r);this.multipleSelect(a)}}}},touchEnd:function(e){e.preventDefault();var t=e.changedTouches;if(t.length>0){var i=t[0].pageX-$("#"+this.canvasElementId).offset().left;var r=t[0].pageY-$("#"+this.canvasElementId).offset().top;var a=this.xyToColor(i,r);if(a!==false){if(this.touchColorEndHandler!==false){this.touchColorEndHandler(a)}}}},doubleClick:function(e){if(this.gridDoubleClick){this.gridDoubleClick()}},mouseDown:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;var r=Math.floor((t-this.colorSpacing)/(this.colorWidth+this.colorSpacing));var a=Math.floor((i-this.colorSpacing)/(this.colorHeight+this.colorSpacing));var s=0;this.buttons=1;if(!UI.isMobile.any()){s=e.button;this.setButtons(e)}if(this.lastGridX!==false&&this.lastGridY!==false){if(this.gridMouseDown){this.gridMouseDown(e,this.lastGridX,this.lastGridY)}}var o=this.xyToColor(t,i);if(this.selectEnabled){if(o!==this.editor.colorPaletteManager.noColor){if(this.buttons&1){if(this.canSelectMultiple){this.multipleSelectMode="add";for(var l=0;l<this.selectedColors.length;l++){if(this.selectedColors[l]===o){this.multipleSelectMode="remove";break}}this.multipleSelect(o);this.lastGridY=a;this.lastGridX=r}else{this.selectedColors[0]=o}if(this.colorSelected!==false){this.colorSelected({color:o,colorIndex:0})}}if(this.buttons&2&&this.canSelectWithRightMouseButton){this.selectedColors[1]=o;if(this.colorSelected!==false){this.colorSelected({color:o,colorIndex:1})}}this.draw()}}else{}e.preventDefault()},mouseMove:function(e){var t=0;this.buttons=1;if(!UI.isMobile.any()){t=e.button;this.setButtons(e)}var i=e.pageX-$("#"+this.canvasElementId).offset().left;var r=e.pageY-$("#"+this.canvasElementId).offset().top;var a=Math.floor((i-this.colorSpacing)/(this.colorWidth+this.colorSpacing));var s=Math.floor((r-this.colorSpacing)/(this.colorHeight+this.colorSpacing));this.lastX=i;this.lastY=r;if(a<0){a=false}if(s<0){s=false}if(a!==this.lastGridX||s!==this.lastGridY){if(a!==false&&s!==false){if(this.gridMouseMove){this.gridMouseMove(e,a,s)}}this.lastGridY=s;this.lastGridX=a}if(this.canSelectMultiple){if(this.buttons&1){var o=this.xyToColor(i,r);this.multipleSelect(o)}}if(this.highlightEnabled){var o=this.xyToColor(i,r);if(this.highlightColor!==o){this.setHighlightColor(o)}}if(this.inDragColor){this.draw()}if(this.inDragMarquee){this.draw()}},mouseUp:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;this.buttons=0;var r=Math.floor((t-this.colorSpacing)/(this.colorWidth+this.colorSpacing));var a=Math.floor((i-this.colorSpacing)/(this.colorHeight+this.colorSpacing));if(this.gridMouseUp){this.gridMouseUp(e,r,a)}if(this.inDragColor){this.inDragColor=false;this.endDragColor(r,a)}if(this.inDragMarquee){this.inDragMarquee=false;this.endDragMarquee()}this.draw()},setColorsAcross:function(e){this.colorsAcross=e;this.draw()},setHighlightColor:function(e){this.highlightColor=e;this.draw();if(this.highlightChanged!==false){this.highlightChanged({color:e})}},setHighlightGrid:function(e,t){this.highlightGridX=e;this.highlightGridY=t},setGridVisible:function(e){this.gridLinesVisible=e;this.draw()},getHighlightColor:function(){return this.highlightColor},setSelectedColor:function(e,t){if(e<this.maxSelectableColors){this.selectedColors[e]=t;this.draw()}},getSelectedColor:function(e){if(e<this.selectedColors.length){return this.selectedColors[e]}return false},setSelectedColors:function(e){this.selectedColors=[];for(var t=0;t<e.length;t++){this.selectedColors.push(e[t])}},getSelectedColors:function(){return this.selectedColors},setColors:function(e,t){this.colorCount=e.length;if(typeof t!="undefined"){if(typeof t.colorMap!="undefined"){this.setColorMap(t.colorMap)}if(typeof t.colorCount!="undefined"){this.colorCount=t.colorCount}}this.colors=[];for(var i=0;i<this.colorCount;i++){this.colors.push(e[i])}this.setup();this.draw()},setColorMap:function(e){this.useColorMap=true;this.colorMap=e},setMaxColorWidth:function(e){this.maxColorWidth=e},fitToWidthHeight:function(e,t){var i=0;var r=t;if(typeof e=="undefined"){i=Math.floor(this.canvas.width/this.canvasScale)}else{i=e}var a=1;var s=1;if(this.colorMap.length>0){a=this.colorMap[0].length;s=this.colorMap.length}this.colorWidth=Math.floor((i-this.colorSpacing)/a-this.colorSpacing);this.colorHeight=Math.floor((r-this.colorSpacing)/s-this.colorSpacing);if(this.maxColorWidth!==false&&this.colorWidth>this.maxColorWidth){this.colorWidth=this.maxColorWidth}if(this.colorHeight<this.colorWidth){this.colorWidth=this.colorHeight}this.colorHeight=this.colorWidth;this.setup();this.draw()},fitToWidth:function(e){var t=0;if(typeof e=="undefined"){t=Math.floor(this.canvas.width/this.canvasScale)}else{t=e}var i=1;var r=1;if(this.colorMap.length>0){i=this.colorMap[0].length;r=this.colorMap.length}this.colorWidth=Math.floor((t-this.colorSpacing)/i-this.colorSpacing);if(this.maxColorWidth!==false&&this.colorWidth>this.maxColorWidth){this.colorWidth=this.maxColorWidth}this.colorHeight=this.colorWidth;this.setup();this.draw()},moveSelection:function(e,t){if(this.useColorMap){var i=this.selectedColors[0];var r=this.colorToGridXy(i);if(e!=0||t!=0&&r.x!==false&&r.y!==false){var a=r.y;var s=r.x;while(1){s+=e;a+=t;if(a<0||a>=this.colorMap.length||s<0||s>=this.colorMap[a].length){return}if(this.colorMap[a][s]!=this.noColor){this.selectedColors[0]=this.colorMap[a][s];if(this.colorSelected!==false){this.colorSelected({color:this.selectedColors[0],colorIndex:0})}this.draw();return}}}}else{for(var a=0;a<this.colorsDown;a++){for(var s=0;s<this.colorsAcross;s++){var i=s+a*this.colorsAcross;if(this.sortOrder!==false&&this.colors.length==this.sortOrder.length){i=this.sortOrder[i]}if(i==this.selectedColors[0]){var o=s+e;var l=a+t;if(o<0||o>=this.colorsAcross||l<0||l>=this.colorsDown){return}var i=o+l*this.colorsAcross;if(this.sortOrder!==false&&this.colors.length==this.sortOrder.length){i=this.sortOrder[i]}this.selectedColors[0]=i;if(this.colorSelected!==false){this.colorSelected({color:i,colorIndex:0})}this.draw();return}}}}},gridXYToCell:function(e,t){var i=e*(this.colorWidth+this.colorSpacing);var r=t*(this.colorHeight+this.colorSpacing);return{centerX:i+this.colorWidth/2,centerY:r+this.colorHeight/2}},xyToColor:function(e,t){e-=this.colorSpacing*2;t-=this.colorSpacing*2;if(e<0||t<0){return this.noColor}var i=Math.floor(e/(this.colorWidth+this.colorSpacing));var r=Math.floor(t/(this.colorHeight+this.colorSpacing));if(this.useColorMap){if(r<this.colorMap.length&&i<this.colorMap[r].length){return this.colorMap[r][i]}}else{if(i>=this.colorsAcross||i<0){return this.editor.colorPaletteManager.noColor}if(r>=this.colorsDown||r<0){return this.editor.colorPaletteManager.noColor}var a=r*this.colorsAcross+i;if(this.sortOrder!==false&&this.colors.length==this.sortOrder.length){a=this.sortOrder[a]}return a}return this.noColor},colorToGridXy:function(e){var t=e;if(e===this.noColor){return{x:false,y:false}}if(this.useColorMap){for(var i=0;i<this.colorMap.length;i++){for(var r=0;r<this.colorMap[i].length;r++){if(this.colorMap[i][r]==t){return{x:r,y:i}}}}}else{if(this.sortOrder!==false&&this.colors.length==this.sortOrder.length){for(var a=0;a<this.sortOrder.length;a++){if(this.sortOrder[a]==t){t=a;break}}}var r=t%this.colorsAcross;var i=Math.floor(t/this.colorsAcross);return{x:r,y:i}}return{x:false,y:false}},startDragColor:function(e,t){var i=this.getColorAtMapXY(e,t);if(i===this.noColor){return}this.inDragColor=true;this.dragColorX=e;this.dragColorY=t;this.dragColorIndex=i;var r=this.colorSpacing+e*(this.colorWidth+this.colorSpacing);var a=this.colorSpacing+t*(this.colorHeight+this.colorSpacing);this.dragOffsetX=r-this.lastX;this.dragOffsetY=a-this.lastY;UI.captureMouse(this)},endDragColor:function(e,t){if(this.gridEndDrag){this.gridEndDrag(this.dragColorX,this.dragColorY,e,t)}},startDragMarquee:function(e){this.inDragMarquee=true;this.dragMarqueeContents=e;var t=this.colorSpacing+this.marqueeLeft*(this.colorWidth+this.colorSpacing);var i=this.colorSpacing+this.marqueeTop*(this.colorHeight+this.colorSpacing);this.dragOffsetX=t-this.lastX;this.dragOffsetY=i-this.lastY;UI.captureMouse(this)},getInDragMarquee:function(){return this.inDragMarquee},endDragMarquee:function(){var e=this.lastX+this.dragOffsetX;var t=this.lastY+this.dragOffsetY;var i=e;var r=t;var a=Math.floor(e/(this.colorWidth+this.colorSpacing)-this.colorSpacing);var s=Math.floor(t/(this.colorHeight+this.colorSpacing)-this.colorSpacing);if(this.gridEndMarqueeDrag){this.gridEndMarqueeDrag(this.marqueeLeft,this.marqueeTop,this.marqueeWidth,this.marqueeHeight,a,s)}this.marqueeLeft=a;this.marqueeTop=s},getColorMap:function(){return this.colorMap},getColorAtMapXY:function(e,t){if(t<this.colorMap.length&&e<this.colorMap[t].length){return this.colorMap[t][e]}return this.noColor},setColorAtMapXY:function(e,t,i){if(e>=0&&t>=0&&t<this.colorMap.length&&e<this.colorMap[t].length){this.colorMap[t][e]=i}},drawGridLines:function(){var e=1;var t=1;if(this.colorMap.length>0){e=this.colorMap[0].length;t=this.colorMap.length}this.context.beginPath();for(var i=0;i<e;i++){var r=this.colorSpacing+i*(this.colorWidth+this.colorSpacing);this.context.moveTo(r,0);this.context.lineTo(r,this.canvas.height)}for(var a=0;a<t;a++){var s=this.colorSpacing+a*(this.colorHeight+this.colorSpacing);this.context.moveTo(0,s+.5);this.context.lineTo(this.canvas.width,s+.5)}this.context.strokeStyle=styles.textMode.gridView2dGridLine;this.context.lineWidth=styles.textMode.gridView2dGridLineWidth;this.context.stroke()},setCursorRGB:function(e){if(this.cursorRGB===e){return}if(e===false){this.cursorRGB=false}else{this.cursorRGB="#"+("000000"+e.toString(16)).substr(-6)}},getContext:function(){return this.context},draw:function(){if(!this.drawEnabled){return}if(this.colorMap.length==0){return}var e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var t=0;for(var i=0;i<this.canvas.height;i++){for(var r=0;r<this.canvas.width;r++){if((r+i)%(2*this.canvasScale)){e.data[t++]=30;e.data[t++]=30;e.data[t++]=30}else{e.data[t++]=70;e.data[t++]=70;e.data[t++]=70}e.data[t++]=255}}this.context.putImageData(e,0,0);var a=1;var s=1;if(this.colorMap.length>0){a=this.colorMap[0].length;s=this.colorMap.length}this.colorsAcross=a;this.colorsDown=s;var o=this.editor.getScreenMode();for(var i=0;i<s;i++){for(var r=0;r<a;r++){var l=this.colorSpacing+r*(this.colorWidth+this.colorSpacing);var n=this.colorSpacing+i*(this.colorHeight+this.colorSpacing);var h=r+i*this.colorsAcross;if(this.useColorMap){h=this.colorMap[i][r]}if(h<this.colors.length&&h>=0){var d=false;if(o===TextModeEditor.Mode.C64MULTICOLOR&&this.type=="cellcolor"){if(this.editor.graphic.getType()=="sprite"){d=true}else if(h>=8){h-=8;d=true}}var c=this.colors[h]>>>24&255;var f=this.colors[h]&16777215;var u=("000000"+f.toString(16)).substr(-6);this.context.fillStyle="#"+u;this.context.fillRect(l,n,this.colorWidth,this.colorHeight);if(d&&this.editor.graphic.getType()!=="sprite"){this.context.font="8px Verdana";this.context.fillStyle="#eeeeee";this.context.fillText("M",l+2,n+8)}}}}if(this.gridLinesVisible){this.drawGridLines()}for(var p=0;p<this.selectedColors.length;p++){var v={x:false,y:false};if(this.selectedColors[p]!==this.editor.colorPaletteManager.noColor){v=this.colorToGridXy(this.selectedColors[p]);if(v.x!==false){this.context.fillStyle="#ffff00";this.context.strokeStyle="#ffff00";var l=this.colorSpacing+v.x*(this.colorWidth+this.colorSpacing);var n=this.colorSpacing+v.y*(this.colorHeight+this.colorSpacing);this.context.beginPath();if(p%2==0||this.canSelectMultiple){this.context.moveTo(l,n);this.context.lineTo(l+this.colorWidth/3,n);this.context.lineTo(l,n+this.colorHeight/3)}else{this.context.moveTo(l+this.colorWidth,n+this.colorHeight);this.context.lineTo(l+this.colorWidth-this.colorWidth/3,n+this.colorHeight);this.context.lineTo(l+this.colorWidth,n+this.colorHeight-this.colorHeight/3)}this.context.fill();this.context.beginPath();this.context.lineWidth=2;this.context.rect(l,n,this.colorWidth,this.colorHeight);this.context.stroke()}}}if(this.highlightColor!==false){var v=this.colorToGridXy(this.highlightColor);if(v.x!==false){this.context.strokeStyle=styles.colorPalette.highlightOutline;var l=this.colorSpacing+v.x*(this.colorWidth+this.colorSpacing);var n=this.colorSpacing+v.y*(this.colorWidth+this.colorSpacing);this.context.beginPath();this.context.lineWidth=1;this.context.rect(l,n,this.colorWidth,this.colorHeight);this.context.stroke()}}if(!this.inDragMarquee&&(this.drawHighlightInMarquee||!this.inMarquee(this.highlightGridX,this.highlightGridY))){if(this.highlightGridX!==false&&this.highlightGridY!==false){var l=this.colorSpacing+this.highlightGridX*(this.colorWidth+this.colorSpacing);var n=this.colorSpacing+this.highlightGridY*(this.colorWidth+this.colorSpacing);if(this.cursorRGB!==false){this.context.fillStyle=this.cursorRGB;this.context.globalAlpha=.5;this.context.fillRect(l,n,this.colorWidth,this.colorHeight);this.context.globalAlpha=1}this.context.beginPath();this.context.lineWidth=1;this.context.rect(l,n,this.colorWidth,this.colorHeight);this.context.stroke()}}if(this.marquee&&this.marqueeLeft!==false&&this.marqueeTop!==false){var g=this.colorSpacing+this.marqueeLeft*(this.colorWidth+this.colorSpacing);var m=this.colorSpacing+this.marqueeTop*(this.colorHeight+this.colorSpacing);var y=this.marqueeWidth*(this.colorWidth+this.colorSpacing);var b=this.marqueeHeight*(this.colorHeight+this.colorSpacing);if(this.editor.lastDashOffset==0){this.context.setLineDash([5,5])}else{this.context.setLineDash([0,5,5,0])}this.context.beginPath();this.context.lineWidth=1;this.context.rect(g,m,y,b);this.context.stroke();this.context.setLineDash([])}if(this.inDragMarquee){var l=this.lastX+this.dragOffsetX;var n=this.lastY+this.dragOffsetY;var g=l;var m=n;var y=this.marqueeWidth*(this.colorWidth+this.colorSpacing);var b=this.marqueeHeight*(this.colorHeight+this.colorSpacing);if(this.dragMarqueeContents){for(var i=0;i<this.marqueeHeight;i++){for(var r=0;r<this.marqueeWidth;r++){l=g+r*(this.colorWidth+this.colorSpacing);n=m+i*(this.colorHeight+this.colorSpacing);var h=this.colorMap[i+this.marqueeTop][r+this.marqueeLeft];if(h<this.colors.length&&h>=0){var f=this.colors[h]&16777215;var u=("000000"+f.toString(16)).substr(-6);this.context.fillStyle="#"+u;this.context.fillRect(l,n,this.colorWidth,this.colorHeight)}}}}if(this.editor.lastDashOffset==0){this.context.setLineDash([5,5])}else{this.context.setLineDash([0,5,5,0])}this.context.beginPath();this.context.lineWidth=1;this.context.rect(g,m,y,b);this.context.stroke();this.context.setLineDash([])}if(this.inDragColor){var l=this.colorSpacing+this.dragColorX*(this.colorWidth+this.colorSpacing);var n=this.colorSpacing+this.dragColorY*(this.colorWidth+this.colorSpacing);this.context.strokeStyle="#ffff00";this.context.beginPath();this.context.lineWidth=1;this.context.rect(l,n,this.colorWidth,this.colorHeight);this.context.stroke();var l=this.lastX+this.dragOffsetX;var n=this.lastY+this.dragOffsetY;var f=this.colors[this.dragColorIndex];var u=("000000"+f.toString(16)).substr(-6);this.context.fillStyle="#"+u;this.context.fillRect(l,n,this.colorWidth,this.colorHeight)}}};var ImageEffects=function(){this.editor=null;this.effectList=[{name:"Blur",params:{amount:{name:"Amount",min:0,max:10,defaultValue:3}}},{name:"Bump",params:{}},{name:"Diffusion",params:{scale:{name:"Amount",min:0,max:100,defaultValue:4}}},{name:"Edge Detection",params:{}},{name:"Emboss",params:{height:{name:"Height",min:1,max:10,defaultValue:1},angle:{name:"Angle",min:0,max:360,type:"angle",defaultValue:135},elevation:{name:"Elevation",min:0,max:180,defaultValue:30}}},{name:"Gain/Bias",params:{gain:{name:"Gain",min:0,max:1,defaultValue:.5},bias:{name:"Bias",min:0,max:1,defaultValue:.5}}},{name:"Noise",params:{amount:{name:"Amount",min:0,max:100,defaultValue:25},density:{name:"Density",min:0,max:1,defaultValue:.8},mono:{name:"Monochrome",type:"options",options:["Yes","No"],defaultValue:"No"}}},{name:"Oil Painting",params:{range:{name:"Amount",min:0,max:5,defaultValue:3}}},{name:"Brightness",params:{amount:{name:"Amount",min:-1,max:1,defaultValue:0}}},{name:"Hue",params:{amount:{name:"Amount",min:-1,max:1,defaultValue:0}}},{name:"Contrast",params:{amount:{name:"Amount",min:0,max:2,defaultValue:1}}},{name:"Saturation",params:{amount:{name:"Amount",min:0,max:2,defaultValue:1}}},{name:"Sepia",params:{amount:{name:"Amount",min:0,max:30,defaultValue:10}}},{name:"Smear",params:{type:{name:"Type",type:"options",options:["Circle","Line","Square"],defaultValue:"Circle"},size:{name:"Size",min:1,max:30,defaultValue:4},angle:{name:"Angle",min:0,max:360,defaultValue:10,type:"angle"},density:{name:"Density",min:0,max:1,defaultValue:.5},mix:{name:"Mix",min:0,max:1,defaultValue:.5}}},{name:"Ripples",params:{type:{name:"Type",type:"options",options:["Sawtooth","Sine","Triangle"],defaultValue:"Sine"},xAmplitude:{name:"X Amplitude",min:0,max:20,defaultValue:5},yAmplitude:{name:"Y Amplitude",min:0,max:20,defaultValue:5},xWavelength:{name:"X Wavelength",min:0,max:50,defaultValue:16},yWavelength:{name:"Y Wavelength",min:0,max:50,defaultValue:16}}},{name:"Vignette",params:{amount:{name:"Amount",min:0,max:1,defaultValue:.3}}}]};ImageEffects.prototype={init:function(){this.initParameters()},initParameters:function(){},getEffectsList:function(){return this.effectList},getParameters:function(e){switch(e){case"Blur":return JSManipulate.blur.valueRanges;break}},applyEffect:function(e,t,i){switch(e){case"Blur":JSManipulate.blur.filter(t,i);break;case"Bump":JSManipulate.bump.filter(t,i);break;case"Diffusion":JSManipulate.diffusion.filter(t,i);break;case"Edge Detection":JSManipulate.edge.filter(t,i);break;case"Emboss":JSManipulate.emboss.filter(t,i);break;case"Gain/Bias":JSManipulate.gain.filter(t,i);break;case"Noise":i.monochrome=i.mono=="Yes";JSManipulate.noise.filter(t,i);break;case"Oil Painting":JSManipulate.oil.filter(t,i);break;case"Brightness":JSManipulate.brightness.filter(t,i);break;case"Hue":JSManipulate.hue.filter(t,i);break;case"Contrast":JSManipulate.contrast.filter(t,i);break;case"Saturation":JSManipulate.saturation.filter(t,i);break;case"Sepia":JSManipulate.sepia.filter(t,i);break;case"Smear":{var r=i.type;if(r=="Circle"){JSManipulate.circlesmear.filter(t,i)}else if(r=="Cross"){console.log("CROSS SMEAR not wodking??!!");i.distance=i.size;JSManipulate.crosssmear.filter(t,i)}else if(r=="Line"){i.distance=i.size;JSManipulate.linesmear.filter(t,i)}else if(r=="Square"){JSManipulate.squaresmear.filter(t,i)}}break;case"Ripples":var r=i.type;console.log("ripple type = "+r);if(typeof r=="undefined"){r="Sine"}if(r=="Sine"){JSManipulate.sineripple.filter(t,i)}else if(r=="Sawtooth"){JSManipulate.sawtoothripple.filter(t,i)}else if(r=="Triangle"){JSManipulate.triangleripple.filter(t,i)}break;case"Vignette":JSManipulate.vignette.filter(t,i);break}}};var ImageEffectsControl=function(){this.htmlElementId="";this.imageEffects=null;this.effectsList=[];this.availableEffects=null;this.callbacks={}};ImageEffectsControl.prototype={init:function(e){if(typeof e!="undefined"&&typeof e.htmlElementId!="undefined"){this.htmlElementId=e.htmlElementId}if(typeof e!="undefined"&&typeof e.availableEffects!="undefined"){this.availableEffects=e.availableEffects}else{this.imageEffects=new ImageEffects;this.imageEffects.init();this.availableEffects=this.imageEffects.getEffectsList()}this.controlHTML()},on:function(e,t){this.callbacks[e]=t},trigger:function(e){if(this.callbacks.hasOwnProperty(e)){this.callbacks[e]()}},controlHTML:function(){var e="";var a=this;var t=["Chroma Key"];for(var i=0;i<this.effectsList.length;i++){var r=false;e+='<div class="imageControlEffect">';e+='<div class="imageControlEffect_selector">';e+='<select id="'+this.htmlElementId+"_effect_"+i+'" class="'+this.htmlElementId+'_effect" data-effect-index="'+i+'">';e+="<option>Select Effect</option>";for(var s=0;s<this.availableEffects.length;s++){if(t.indexOf(this.availableEffects[s].name)===-1){e+='<option value="'+this.availableEffects[s].name+'" ';if(this.effectsList[i].effect==this.availableEffects[s].name){r=s;e+=' selected="selected" '}e+=">"+this.availableEffects[s].name+"</option>"}}e+="</select>";e+='<div class="ui-button ui-button-danger '+this.htmlElementId+'_remove imageControlEffect_remove" data-effect-index="'+i+'">x</div>';e+="</div>";if(r!==false){var o=this.availableEffects[r].params;for(paramKey in o){if(o.hasOwnProperty(paramKey)){var l=o[paramKey];var n=paramKey;if(typeof l.name!="undefined"){n=l.name}var h="range";if(typeof l.type!="undefined"){h=l.type}if(h!="hidden"){if(h=="range"||h=="angle"){var d=l.defaultValue;if(typeof this.effectsList[i].params[paramKey]!="undefined"){d=this.effectsList[i].params[paramKey]}var c=this.htmlElementId+"_effect_"+i+"_param_"+paramKey;var f=0;var u=100;if(h=="range"){if(l["min"]==-1&&l["max"]==1){f=-100;u=100;d=f+parseInt((u-f)*((d-l["min"])/(l["max"]-l["min"])),10)}else{d=parseInt(100*((d-l["min"])/(l["max"]-l["min"])),10)}}if(h=="angle"){f=0;u=360}e+='<div class="formRow">';e+='<label class="controlLabel">'+n+"</label>";e+='<input type="text" style="width: 30px" "min="'+f+'" max="'+u+'" value="'+d+'" size="2"  class="'+this.htmlElementId+'_effectParamText number" id="'+c+'_text"  data-effect-index="'+i+'" data-effect-param="'+paramKey+'" data-id="'+c+'"/>';e+='<input style="flex: 1 1; margin: 0 2px" type="range"  min="'+f+'" max="'+u+'" value="'+d+'" size="3" class="'+this.htmlElementId+'_effectParamSlider" id="'+c+'_slider" data-effect-index="'+i+'" data-effect-param="'+paramKey+'" data-id="'+c+'"/>';e+='<div type="button" id="'+c+'_reset" class="ui-button '+this.htmlElementId+'_effectParamReset" data-effect-index="'+i+'" data-effect-param="'+paramKey+'" data-id="'+c+'">Reset</div>';e+="</div>"}if(h=="options"){var d=l.defaultValue;if(typeof this.effectsList[i].params[paramKey]!="undefined"){d=this.effectsList[i].params[paramKey]}var c=this.htmlElementId+"_effect_"+i+"_param_"+paramKey;e+='<div class="formRow">';e+='<label class="controlLabel">'+n+"</label>";e+='<div style="display: inline-block">';for(var s=0;s<l.options.length;s++){var p=l.options[s];var v=l.options[s];if(typeof p.value!="undefined"){p=p["value"];v=v["label"]}e+='<label class="rb-container">';e+=v;e+='<input type="radio" name="'+c+'" value="'+p+'" ';if(p==d){e+=' checked="checked" '}e+=' class="'+this.htmlElementId+'_effectParamRadio" id="'+c+'_slider" data-effect-index="'+i+'" data-effect-param="'+paramKey+'" data-id="'+c+'" ';e+="/>";e+='<span class="checkmark"></span>';e+="</label>";e+="<br/>"}e+="</div>";e+="</div>"}}}}}e+="</div>"}e+='<div  class="ui-button imageControlEffect_add" id="'+this.htmlElementId+'_addEffect"><i class="halflings halflings-plus"></i>&nbsp;Add An Effect</div>';$("#"+this.htmlElementId).html(e);UI.number.initControls("#"+this.htmlElementId+" .number");$("#"+this.htmlElementId+"_addEffect").on("click",function(){a.addEffect()});$("."+this.htmlElementId+"_effectParamSlider").on("change",function(){var e=$(this).val();var t=$(this).attr("data-id");$("#"+t+"_text").val(e);var i=$(this).attr("data-effect-index");var r=$(this).attr("data-effect-param");a.updateEffectParam(i,r,e)});$("."+this.htmlElementId+"_effectParamSlider").on("input",function(){var e=$(this).val();var t=$(this).attr("data-id");$("#"+t+"_text").val(e);var i=$(this).attr("data-effect-index");var r=$(this).attr("data-effect-param");a.updateEffectParam(i,r,e)});$("."+this.htmlElementId+"_effectParamText").on("keyup",function(){var e=$(this).val();var t=$(this).attr("data-id");$("#"+t+"_slider").val(e);var i=$(this).attr("data-effect-index");var r=$(this).attr("data-effect-param");a.updateEffectParam(i,r,e)});$("."+this.htmlElementId+"_effectParamReset").on("click",function(){var e=$(this).attr("data-effect-index");var t=$(this).attr("data-effect-param");var i=a.resetEffectParam(e,t);var r=$(this).attr("data-id");$("#"+r+"_slider").val(i);$("#"+r+"_text").val(i)});$("."+this.htmlElementId+"_effectParamRadio").on("click",function(){var e=$(this).attr("data-id");var t=$("input[name="+e+"]:checked").val();var i=$(this).attr("data-effect-index");var r=$(this).attr("data-effect-param");console.log("param = "+r+", value = "+t);a.updateEffectParam(i,r,t)});$("."+this.htmlElementId+"_effect").on("change",function(){var e=$(this).val();var t=parseInt($(this).attr("data-effect-index"),10);a.setEffect(t,e)});$("."+this.htmlElementId+"_remove").on("click",function(){var e=$(this).val();var t=parseInt($(this).attr("data-effect-index"),10);a.removeEffect(t)})},addEffect:function(){this.effectsList.push({});this.controlHTML()},setEffect:function(e,t){this.effectsList[e].effect=t;this.effectsList[e].params={};for(var i=0;i<this.availableEffects.length;i++){if(this.availableEffects[i].name==t){for(var r in this.availableEffects[i].params){if(this.availableEffects[i].params.hasOwnProperty(r)){this.effectsList[e].params[r]=this.availableEffects[i].params[r].defaultValue}}}}this.controlHTML();this.trigger("update")},removeEffect:function(e){this.effectsList.splice(e,1);this.controlHTML();this.trigger("update")},resetEffectParam:function(e,t){console.log("reset effect "+e);var i=this.effectsList[e].effect;var r=0;var a=0;var s=1;for(var o=0;o<this.availableEffects.length;o++){if(i==this.availableEffects[o].name){r=this.availableEffects[o].params[t].defaultValue;a=this.availableEffects[o].params[t].min;s=this.availableEffects[o].params[t].max;break}}this.effectsList[e].params[t]=r;this.trigger("updateParam");var l=0;var n=100;if(a==-1&&s==1){l=-100;n=100;r=l+parseInt((n-l)*((r-a)/(s-a)),10)}else{l=0;n=100;r=parseInt(100*((r-a)/(s-a)),10)}return r},updateEffectParam:function(e,t,i){var r=this.effectsList[e].effect;for(var a=0;a<this.availableEffects.length;a++){if(r==this.availableEffects[a].name){var s="range";if(typeof this.availableEffects[a].params[t].type!="undefined"){s=this.availableEffects[a].params[t].type}if(s=="range"){var o=this.availableEffects[a].params[t].min;var l=this.availableEffects[a].params[t].max;if(o==-1&&l==1){var n=-100;var h=100;i=o+(i-n)*(l-o)/(h-n)}else{i=o+i/100*(l-o)}}}}this.effectsList[e].params[t]=i;this.trigger("updateParam")},getEffectsList:function(){return this.effectsList},getEffectsCount:function(){return this.effectsList.length},applyEffects:function(e){for(var t=0;t<this.effectsList.length;t++){var i=this.effectsList[t].effect;var r=this.effectsList[t].params;if(i!=""){this.imageEffects.applyEffect(i,e,r)}}}};var MirrorEffect=function(){this.src=null;this.dst=null;this.imageX=0;this.imageY=0;this.scale=1;this.deltaX=-12;this.deltaY=0;this.deltaScale=0;this.frame=0;this.flipH=false;this.flipV=false;this.mirrorH=true;this.mirrorV=false;this.canvas=null;this.context=null};MirrorEffect.prototype={setSource:function(e){this.src=e},setDestination:function(e){this.dst=e},setPosition:function(e,t){this.imageX=e;this.imageY=t},setScale:function(e){this.scale=e},setParameters:function(e){if(typeof e.flipH!="undefined"){this.flipH=e.flipH}if(typeof e.flipV!="undefined"){this.flipV=e.flipV}if(typeof e.mirrorH!="undefined"){this.mirrorH=e.mirrorH}if(typeof e.mirrorV!="undefined"){this.mirrorV=e.mirrorV}},nextFrame:function(){this.frame=this.frame+1},gotoFrame:function(e){this.frame=e},setupCanvas:function(){if(this.canvas==null){this.canvas=document.createElement("canvas")}if(this.canvas.width!=this.src.width||this.canvas.height!=this.src.height||this.context==null){this.canvas.width=this.src.width;this.canvas.height=this.src.height;this.context=this.canvas.getContext("2d")}},update:function(){this.dstContext=this.dst.getContext("2d");this.setupCanvas();var e=this.src.width;var t=this.src.height;var i=this.dst.width;var r=this.dst.height;t=r*e/i;var a=this.imageX;var s=this.imageY;var o=this.scale;e=i/o;t=r/o;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);if(this.flipH||this.flipV){var l=1;var n=0;if(this.flipH){l=-1;n=this.canvas.width}var h=1;var d=0;if(this.flipV){h=-1;d=this.canvas.height}this.context.save();this.context.translate(n,d);this.context.scale(l,h);this.context.drawImage(this.src,0,0);this.context.restore()}else{this.context.drawImage(this.src,a,s)}if(this.mirrorH){this.context.clearRect(this.canvas.width/2,0,this.canvas.width/2,this.canvas.height);this.context.save();this.context.translate(i/2,0);this.context.scale(-1,1);this.context.drawImage(this.canvas,a,s,e/2,t,-i/2,0,i/2,r);this.context.restore()}if(this.mirrorV){this.context.save();this.context.translate(0,r/2);this.context.scale(1,-1);this.context.drawImage(this.canvas,a,s,e,t/2,0,-r/2,i,r/2);this.context.restore()}this.dstContext.clearRect(0,0,this.dst.width,this.dst.height);this.dstContext.drawImage(this.canvas,0,0)}};var RotateZoomEffect=function(){this.src=null;this.dst=null;this.imageX=0;this.imageY=0;this.scale=1;this.frame=0;this.frameCount=12;this.zoomStart=1;this.zoomAmountX=10;this.zoomAmountY=10;this.zoomDirection=1;this.zoomType="layer";this.rotateDirection=-1;this.wiggle=false;this.wiggleAmount=30;this.wiggleSteps=2;this.panX=0;this.panY=0;this.layerCount=1;this.layerAngleSeparation=0};RotateZoomEffect.prototype={setSource:function(e){this.src=e},setDestination:function(e){this.dst=e},setParameters:function(e){if(typeof e.zoomAmount!="undefined"){this.zoomAmountX=e.zoomAmount/100;this.zoomAmountY=e.zoomAmount/100}if(typeof e.zoomAmountX!="undefined"){this.zoomAmountX=e.zoomAmountX/100}if(typeof e.zoomAmountY!="undefined"){this.zoomAmountY=e.zoomAmountY/100}if(typeof e.zoomDirection!="undefined"){switch(e.zoomDirection){case"In":this.zoomDirection=1;break;case"Out":this.zoomDirection=-1;break;default:this.zoomAmountX=1;this.zoomAmountY=1;break}}if(typeof e.zoomType!="undefined"){this.zoomType=e.zoomType}if(typeof e.rotateDirection!="undefined"){this.wiggle=false;switch(e.rotateDirection){case"Clockwise":this.rotateDirection=1;break;case"Anticlockwise":this.rotateDirection=-1;break;case"Wiggle":this.wiggle=true;this.rotateDirection=-1;break;default:this.rotateDirection=0;break}}if(typeof e.wiggleAmount!="undefined"){this.wiggleAmount=parseInt(e.wiggleAmount,10)}if(typeof e.wiggleSteps!="undefined"){this.wiggleSteps=parseInt(e.wiggleSteps,10)}if(typeof e.panX!="undefined"){var t=parseInt(e.panX,10);if(!isNaN(t)){this.panX=t}}if(typeof e.panXAnimateType!="undefined"){this.panXAnimateType=e.panXAnimateType}if(typeof e.panY!="undefined"){var i=parseInt(e.panY,10);if(!isNaN(i)){this.panY=i}}if(typeof e.panYAnimateType!="undefined"){this.panYAnimateType=e.panYAnimateType}if(typeof e.layerCount!="undefined"){this.layerCount=e.layerCount}if(typeof e.layerAngleSeparation!="undefined"){this.layerAngleSeparation=e.layerAngleSeparation}},setPosition:function(e,t){this.imageX=e;this.imageY=t},setCrosshair:function(e,t){this.crosshairX=e;this.crosshairY=t},setScale:function(e){this.scale=e},setFrameCount:function(e){this.frameCount=e},setZoomAmount:function(e){this.zoomAmountX=e;this.zoomAmountY=e},nextFrame:function(){this.frame=this.frame+1},gotoFrame:function(e){this.frame=e},update:function(){this.dstContext=this.dst.getContext("2d");var e=this.dst.width;var t=this.dst.height;var i=0;var r=0;if(typeof this.src.naturalWidth!="undefined"){i=this.src.naturalWidth;r=this.src.naturalHeight}if(typeof this.src.videoWidth!="undefined"){i=this.src.videoWidth;r=this.src.videoHeight}this.zoomRotateDelta=0;this.zoomRotateDelta=360/this.zoomFrames;if(this.wiggle){if(this.frame%2){this.rotateAmount=-this.wiggleAmount}else{this.rotateAmount=this.wiggleAmount}}else{this.rotateAmount=this.rotateDirection*(360-this.rotateDirection*this.layerAngleSeparation)*(this.frame/this.frameCount)}this.zoomDeltaX=1;this.zoomDeltaY=1;var a=this.zoomAmountX;var s=this.zoomAmountY;if(this.frameCount>1){if(this.zoomDirection==-1){a=1/a}this.zoomDeltaX=Math.pow(a,1/this.frameCount);if(this.zoomDirection==-1){s=1/s}this.zoomDeltaY=Math.pow(s,1/this.frameCount)}this.zoomStartX=this.scale;this.zoomStartY=this.scale;this.currentZoomX=this.zoomStartX*Math.pow(this.zoomDeltaX,this.frame);this.currentZoomY=this.zoomStartY*Math.pow(this.zoomDeltaY,this.frame);var o=0;var l=0;switch(this.panXAnimateType){case"linear":o=this.panX/this.frameCount*this.frame;break;case"sine":o=this.panX*Math.sin(2*Math.PI*this.frame/this.frameCount);break;case"cosine":o=this.panX*Math.cos(2*Math.PI*this.frame/this.frameCount);break;case"random":o=this.panX*Math.random();break}switch(this.panYAnimateType){case"linear":l=this.panY/this.frameCount*this.frame;break;case"sine":l=this.panY*Math.sin(2*Math.PI*this.frame/this.frameCount);break;case"cosine":l=this.panY*Math.cos(2*Math.PI*this.frame/this.frameCount);break;case"random":l=this.panY*Math.random();break}if(this.zoomType=="infinite"){if(this.zoomDirection==-1){this.zoomLargeStartX=this.zoomStartX/Math.pow(this.zoomDeltaX,this.frameCount);this.zoomLargeStartY=this.zoomStartY/Math.pow(this.zoomDeltaY,this.frameCount)}else{this.zoomLargeStartX=this.zoomStartX*Math.pow(this.zoomDeltaX,this.frameCount);this.zoomLargeStartY=this.zoomStartY*Math.pow(this.zoomDeltaY,this.frameCount)}this.currentLargeImageZoomX=this.zoomLargeStartX*Math.pow(this.zoomDeltaX,this.frame);this.currentLargeImageZoomY=this.zoomLargeStartY*Math.pow(this.zoomDeltaY,this.frame);if(this.currentLargeImageZoomX>0&&this.currentLargeImageZoomY>0){this.dstContext.save();this.dstContext.translate(this.crosshairX,this.crosshairY);this.dstContext.scale(this.currentLargeImageZoomX,this.currentLargeImageZoomY);var n=this.imageX-this.crosshairX;var h=this.imageY-this.crosshairY;this.dstContext.rotate((this.rotateAmount-this.layerAngleSeparation)*Math.PI*2/360);this.dstContext.drawImage(this.src,this.imageX-this.crosshairX,this.imageY-this.crosshairY,i,r);this.dstContext.translate(-this.crosshairX,-this.crosshairY);this.dstContext.restore()}}this.dstContext.save();this.dstContext.translate(this.crosshairX,this.crosshairY);this.dstContext.scale(this.currentZoomX,this.currentZoomY);var n=o+this.imageX-this.crosshairX;var h=l+this.imageY-this.crosshairY;this.dstContext.rotate(this.rotateAmount*Math.PI*2/360);this.dstContext.drawImage(this.src,n,h,i,r);this.dstContext.translate(-this.crosshairX,-this.crosshairY);this.dstContext.restore();if(this.zoomType=="infinite"){if(this.zoomDirection==-1){this.zoomSmallStartX=this.zoomStartX*Math.pow(this.zoomDeltaX,this.frameCount);this.zoomSmallStartY=this.zoomStartY*Math.pow(this.zoomDeltaY,this.frameCount)}else{this.zoomSmallStartX=this.zoomStartX/Math.pow(this.zoomDeltaX,this.frameCount);this.zoomSmallStartY=this.zoomStartY/Math.pow(this.zoomDeltaY,this.frameCount)}this.currentSmallImageZoomX=this.zoomSmallStartX*Math.pow(this.zoomDeltaX,this.frame);this.currentSmallImageZoomY=this.zoomSmallStartY*Math.pow(this.zoomDeltaY,this.frame);if(this.currentSmallImageZoomX>0&&this.currentSmallImageZoomY>0){this.dstContext.save();this.dstContext.translate(this.crosshairX,this.crosshairY);this.dstContext.scale(this.currentSmallImageZoomX,this.currentSmallImageZoomY);var n=this.imageX-this.crosshairX;var h=this.imageY-this.crosshairY;this.dstContext.rotate((this.rotateAmount+this.layerAngleSeparation)*Math.PI*2/360);this.dstContext.drawImage(this.src,this.imageX-this.crosshairX,this.imageY-this.crosshairY,i,r);this.dstContext.translate(-this.crosshairX,-this.crosshairY);this.dstContext.restore()}}}};var SlitscanEffect=function(){this.src=null;this.dst=null;this.imageX=0;this.imageY=0;this.slices=30;this.horizontal=false;this.vertical=true;this.frames=[]};SlitscanEffect.prototype={setSource:function(e){this.src=e},setDestination:function(e){this.dst=e},reset:function(){this.frames=[]},update:function(){if(this.slices<3){this.slices=3}this.dstContext=this.dst.getContext("2d");var e=this.src.height;var t=this.src.width;var i=this.dst.width;var r=this.dst.height;var a=Math.ceil(e/this.slices);var s=Math.ceil(t/this.slices);var o=this.src.getContext("2d");this.frames.push(o.getImageData(0,0,this.src.width,this.src.height));if(this.horizontal){var l=this.slices;if(l>=this.frames.length){l=this.frames.length}while(l--){try{this.dstContext.putImageData(this.frames[l],0,0,0,a*l,this.src.width,a)}catch(e){}}}if(this.vertical){var l=this.slices;if(l>=this.frames.length){l=this.frames.length}while(l--){try{this.dstContext.putImageData(this.frames[l],0,0,s*l,0,s,this.src.height)}catch(e){}}}while(this.frames.length>this.slices){this.frames.shift()}}};var ImageParametersEffect=function(){this.src=null;this.dst=null;this.saturation=0;this.brightness=0;this.contrast=0;this.brightnessDelta=0;this.brightnessAnimateType="linear";this.contrastDelta=0;this.contrastAnimateType="linear";this.saturationDelta=0;this.saturationAnimateType="linear";this.invertColors=false;this.frame=0;this.frameCount=12};ImageParametersEffect.prototype={setSource:function(e){this.src=e},setDestination:function(e){this.dst=e},setFrameCount:function(e){this.frameCount=e},gotoFrame:function(e){this.frame=parseInt(e,10)},setParameters:function(e){if(typeof e.saturation!="undefined"){this.saturation=parseInt(e.saturation,10)}if(typeof e.saturationDelta!="undefined"){this.saturationDelta=parseInt(e.saturationDelta,10)}if(typeof e.saturationAnimateType!="undefined"){this.saturationAnimateType=e.saturationAnimateType}if(typeof e.contrast!="undefined"){this.contrast=parseInt(e.contrast,10)}if(typeof e.contrastDelta!="undefined"){this.contrastDelta=parseInt(e.contrastDelta,10)}if(typeof e.contrastAnimateType!="undefined"){this.contrastAnimateType=e.contrastAnimateType}if(typeof e.brightness!="undefined"){this.brightness=parseInt(e.brightness,10)}if(typeof e.brightnessDelta!="undefined"){this.brightnessDelta=parseInt(e.brightnessDelta,10)}if(typeof e.brightnessAnimateType!="undefined"){this.brightnessAnimateType=e.brightnessAnimateType}if(typeof e.invertColors!="undefined"){this.invertColors=e.invertColors}},update:function(){this.srcContext=this.src.getContext("2d");this.dstContext=this.dst.getContext("2d");var e=this.src.width;var t=this.src.height;var i=this.dst.width;var r=this.dst.height;this.imageData=this.srcContext.getImageData(0,0,this.src.width,this.src.height);if(this.invertColors){ImageUtils.invertColors(this.imageData)}var a=this.saturation;switch(this.saturationAnimateType){case"linear":a=this.saturation+this.saturationDelta*this.frame/this.frameCount;break;case"sine":a=this.saturation+this.saturationDelta*Math.sin(2*Math.PI*this.frame/this.frameCount);break;case"cosine":a=this.saturation+this.saturationDelta*Math.cos(2*Math.PI*this.frame/this.frameCount);break;case"random":a=this.saturation+this.saturationDelta*Math.random();break}if(a!=0){ImageUtils.adjustSaturation(this.imageData,a)}var s=this.brightness;switch(this.brightnessAnimateType){case"linear":s=this.brightness+this.brightnessDelta*this.frame/this.frameCount;break;case"sine":s=this.brightness+this.brightnessDelta*Math.sin(2*Math.PI*this.frame/this.frameCount);break;case"cosine":s=this.brightness+this.brightnessDelta*Math.cos(2*Math.PI*this.frame/this.frameCount);break;case"random":s=this.brightness+this.brightnessDelta*Math.random();break}if(s!=0){ImageUtils.adjustBrightness(this.imageData,s)}var o=this.contrast;switch(this.contrastAnimateType){case"linear":o=this.contrast+this.contrastDelta*this.frame/this.frameCount;break;case"sine":o=this.contrast+this.contrastDelta*Math.sin(2*Math.PI*this.frame/this.frameCount);break;case"cosine":o=this.contrast+this.contrastDelta*Math.cos(2*Math.PI*this.frame/this.frameCount);break;case"random":o=this.contrast+this.contrastDelta*Math.random();break}if(o!=0){ImageUtils.adjustContrast(this.imageData,o)}this.dstContext.putImageData(this.imageData,0,0,0,0,this.src.width,this.src.height)}};var NoiseEffect=function(){this.src=null;this.dst=null;this.imageX=0;this.imageY=0;this.scale=1;this.frame=0;this.amount=30;this.density=.75};NoiseEffect.prototype={setSource:function(e){this.src=e},setDestination:function(e){this.dst=e},setPosition:function(e,t){this.imageX=e;this.imageY=t},setScale:function(e){this.scale=e},setParameters:function(e){if(typeof e.amount!="undefined"){this.amount=parseInt(e.amount,10)}if(typeof e.density!="undefined"){this.density=parseInt(e.density,10)/100}},nextFrame:function(){this.frame=this.frame+1},gotoFrame:function(e){this.frame=e},update:function(){this.dstContext=this.dst.getContext("2d");var e=this.src.width;var t=this.src.height;var i=this.dst.width;var r=this.dst.height;var a=-this.imageX;var s=-this.imageY;var o=this.scale;e=i/o;t=r/o;this.dstContext.drawImage(this.src,a,s,e,t,0,0,i,r);var l=this.dstContext.getImageData(0,0,this.dst.width,this.dst.height);JSManipulate.noise.filter(l,{amount:this.amount,density:this.density,monochrome:true});this.dstContext.putImageData(l,0,0)}};var ImageShaderEffects=function(){this.editor=null;this.width=320;this.height=200;this.renderer=null;this.camera=null;this.renderTarget=null;this.renderTargetPixels=null;this.plane=null;this.planeGeometry=null;this.texture=null;this.material=null;this.srcCanvas=null;this.textureWidth=1024;this.textureHeight=1024;this.textureCanvas=null;this.availableEffects=[{name:"Chroma Key",params:{r:{name:"Red",min:0,max:1,defaultValue:.06},g:{name:"Green",min:0,max:1,defaultValue:.698},b:{name:"Blue",min:0,max:1,defaultValue:0}}},{name:"Brightness/Contrast",params:{brightness:{name:"Brightness",min:-1,max:1,defaultValue:0},contrast:{name:"Contrast",min:-1,max:1,defaultValue:0}}},{name:"Bloom",params:{opacity:{name:"Strength",min:0,max:5,defaultValue:1}}},{name:"Bump",params:{weight:{name:"Weight",min:.5,max:2,defaultValue:1}}},{name:"Colour Cycle",params:{amount:{name:"Amount",min:.1,max:1,defaultValue:.05},offset:{name:"Offset",min:0,max:2,defaultValue:0},time:{type:"hidden",defaultValue:.5}}},{name:"Colour Halftone",params:{scale:{min:0,max:6,defaultValue:2},angle:{type:"angle",min:0,max:2,defaultValue:1}}},{name:"CRT",params:{warpscreen:{type:"options",options:[{label:"Off",value:0},{label:"On",value:1}],defaultValue:1},INPUT_THIN:{min:0,max:1,defaultValue:.7},masktype:{type:"options",options:[{label:"Grille",value:0},{label:"Grille Lite",value:1},{label:"None",value:2}],defaultValue:1},INPUT_MASK:{min:0,max:2,defaultValue:.7},INPUT_X:{type:"hidden",min:0,max:500,defaultValue:128},INPUT_Y:{min:0,max:500,defaultValue:72},INPUT_BLUR:{type:"hidden",min:-5,max:3,defaultValue:-2.5}}},{name:"Denoise",params:{exponent:{min:0,max:15,defaultValue:.2}}},{name:"Digital Glitch",params:{amount:{min:0,max:.02,defaultValue:.002},distortion_x:{min:0,max:1,defaultValue:.2},distortion_y:{min:0,max:1,defaultValue:.2},seed:{min:0,max:4,defaultValue:.7},seed_x:{min:0,max:1,defaultValue:.7},seed_y:{min:0,max:1,defaultValue:.7}}},{name:"Diffusion",params:{scale:{min:0,max:1,defaultValue:.2}}},{name:"Dot Screen",params:{scale:{min:0,max:5,defaultValue:3},angle:{type:"angle",min:0,max:2,defaultValue:1}}},{name:"Edges",params:{}},{name:"Emboss",params:{}},{name:"Ghost",params:{amount:{min:0,max:.1,defaultValue:.06},angle:{min:0,max:300,defaultValue:0}}},{name:"Hexagonal Pixelate",params:{scale:{name:"Scale",min:1,max:100,defaultValue:10}}},{name:"Hue/Saturation",params:{hue:{name:"Hue",min:-1,max:1,defaultValue:0},saturation:{name:"Saturation",min:-1,max:1,defaultValue:0}}},{name:"Kaleidoscope",params:{sides:{min:0,max:6,defaultValue:1},angle:{min:0,max:5,defaultValue:0}}},{name:"Noise",params:{nIntensity:{name:"Intensity",min:0,max:1,defaultValue:.2},time:{name:"time",type:"time",defaultValue:0}}},{name:"Pixelate",params:{pixelsX:{name:"Pixels X",min:1,max:1e3,defaultValue:10},pixelsY:{name:"Pixels Y",min:1,max:1e3,defaultValue:10}}},{name:"Polar Pixelate",params:{pixelsX:{name:"Pixels X",min:0,max:1,defaultValue:.05},pixelsY:{name:"Pixels Y",min:0,max:1,defaultValue:.05}}},{name:"RGB Shift",params:{amount:{min:0,max:.1,defaultValue:.05},angle:{min:0,max:300,defaultValue:0}}},{name:"Scanlines",params:{linesAmount:{name:"Amount",min:0,max:1,defaultValue:1},count:{name:"Count",min:0,max:4096,defaultValue:499}}},{name:"Sepia",params:{amount:{name:"Amount",min:0,max:1,defaultValue:1}}},{name:"Technicolour",params:{}},{name:"Triangle Blur",params:{amount:{min:0,max:.05,defaultValue:.01}}},{name:"Vignette",params:{offset:{name:"Offset",min:0,max:2,defaultValue:1},darkness:{name:"Darkness",min:0,max:2,defaultValue:1}}},{name:"Wobble",params:{strength:{min:0,max:.1,defaultValue:.04},size:{min:0,max:20,defaultValue:3},time:{type:"time",min:0,max:1,defaultValue:0}}}];this.effectsList=[]};ImageShaderEffects.prototype={init:function(e){this.renderer=new THREE.WebGLRenderer;this.renderer.autoClear=false;this.renderer.setSize(this.width,this.height);this.camera=new THREE.OrthographicCamera(this.width/-2,this.width/2,this.height/2,this.height/-2,1,1e3);this.camera.position.z=5;this.scene=new THREE.Scene;this.textureCanvas=document.createElement("canvas")},resize:function(){this.camera.left=-this.width/2;this.camera.right=this.width/2;this.camera.top=this.height/2;this.camera.bottom=-this.height/2;this.camera.updateProjectionMatrix();this.renderer.setSize(this.width,this.height);if(this.renderTarget.width!=this.width||this.renderTarget.height!=this.height){if(this.width>this.textureWidth||this.height>this.textureHeight){if(this.width<2048&&this.height<2048){this.textureWidth=2048;this.textureHeight=2048}else if(this.width<4096&&this.height<4096){this.textureWidth=4096;this.textureHeight=4096}else if(this.width<8192&&this.height<8192){this.textureWidth=8192;this.textureHeight=8192}}this.renderTarget.setSize(this.width,this.height);this.renderTargetPixels=new Uint8Array(this.width*this.height*4)}},setInput:function(e,t){this.srcCanvas=e;this.dstCanvas=t;this.dstContext=this.dstCanvas.getContext("2d");this.dstImageData=this.dstContext.getImageData(0,0,this.dstCanvas.width,this.dstCanvas.height);this.width=e.width;this.height=e.height;var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};if(!this.renderTarget){this.renderTarget=new THREE.WebGLRenderTarget(this.width,this.height,i);this.renderTargetPixels=new Uint8Array(this.width*this.height*4)}this.resize();if(this.textureCanvas.width!=this.textureWidth||this.textureCanvas.height!=this.textureHeight){this.textureCanvas.width=this.textureWidth;this.textureCanvas.height=this.textureHeight;this.textureContext=this.textureCanvas.getContext("2d");if(this.plane){this.scene.remove(this.plane)}if(this.texture){this.texture.dispose()}if(this.material){this.material.dispose()}this.planeGeometry=new THREE.PlaneGeometry(this.textureWidth,this.textureHeight,5);this.texture=new THREE.Texture(this.textureCanvas);this.material=new THREE.MeshBasicMaterial({color:16777215,map:this.texture,side:THREE.DoubleSide});this.plane=new THREE.Mesh(this.planeGeometry,this.material);this.scene.add(this.plane)}this.plane.position.x=(this.textureWidth-this.width)/2;this.plane.position.y=-(this.textureHeight-this.height)/2;this.setupComposer()},setEffects:function(e){this.effectsList=e;this.setupComposer()},setEffectParams:function(e){if(e.length!=this.effectsList.length){this.setEffects(e)}for(var t=0;t<this.effectsList.length;t++){if(this.effectsList[t].effect=="Bloom"){this.effectsList[t].pass.copyUniforms["opacity"].value=this.effectsList[t].params["opacity"]}else{for(var i in e[t].params){if(this.effectsList[t].pass.uniforms.hasOwnProperty(i)){this.effectsList[t].pass.uniforms[i].value=e[t].params[i]}}}}},hasTimeEffects:function(){for(var e=0;e<this.effectsList.length;e++){for(var t in this.effectsList[e].params){if(t=="time"){return true}}}return false},setTime:function(e){for(var t=0;t<this.effectsList.length;t++){for(var i in this.effectsList[t].params){if(i=="time"){this.effectsList[t].pass.uniforms[i].value=e}}}},setupComposer:function(){this.composer=new THREE.EffectComposer(this.renderer,this.renderTarget);this.composer.addPass(new THREE.RenderPass(this.scene,this.camera));for(var e=0;e<this.effectsList.length;e++){switch(this.effectsList[e].effect){case"Bad TV":this.effectsList[e].pass=new THREE.ShaderPass(THREE.BadTVShader);this.composer.addPass(this.effectsList[e].pass);break;case"Chroma Key":this.effectsList[e].pass=new THREE.ShaderPass(ChromaKeyShader);this.composer.addPass(this.effectsList[e].pass);break;case"Bloom":this.effectsList[e].pass=new THREE.BloomPass;this.composer.addPass(this.effectsList[e].pass);break;case"Brightness/Contrast":this.effectsList[e].pass=new THREE.ShaderPass(THREE.BrightnessContrastShader);this.composer.addPass(this.effectsList[e].pass);break;case"Bump":this.effectsList[e].pass=new THREE.ShaderPass(BumpShader);this.composer.addPass(this.effectsList[e].pass);break;case"Colour Cycle":this.effectsList[e].pass=new THREE.ShaderPass(THREE.RainbowShader);this.composer.addPass(this.effectsList[e].pass);break;case"Colour Halftone":this.effectsList[e].pass=new THREE.ShaderPass(ColorHalftoneShader);this.composer.addPass(this.effectsList[e].pass);break;case"CRT":this.effectsList[e].pass=new THREE.ShaderPass(THREE.CRT2Shader);this.composer.addPass(this.effectsList[e].pass);break;case"Denoise":this.effectsList[e].pass=new THREE.ShaderPass(DenoiseShader);this.composer.addPass(this.effectsList[e].pass);break;case"Diffusion":this.effectsList[e].pass=new THREE.ShaderPass(THREE.DiffusionShader);this.composer.addPass(this.effectsList[e].pass);break;case"Digital Glitch":this.effectsList[e].pass=new THREE.ShaderPass(THREE.DigitalGlitch);this.composer.addPass(this.effectsList[e].pass);break;case"Dot Screen":this.effectsList[e].pass=new THREE.ShaderPass(THREE.DotScreenShader);this.composer.addPass(this.effectsList[e].pass);break;case"Edges":this.effectsList[e].pass=new THREE.ShaderPass(EdgeShader);this.composer.addPass(this.effectsList[e].pass);break;case"Emboss":this.effectsList[e].pass=new THREE.ShaderPass(EmbossShader);this.composer.addPass(this.effectsList[e].pass);break;case"Film":this.effectsList[e].pass=new THREE.ShaderPass(THREE.FilmShader);this.composer.addPass(this.effectsList[e].pass);break;case"Ghost":this.effectsList[e].pass=new THREE.ShaderPass(GhostShader);this.composer.addPass(this.effectsList[e].pass);break;case"Hexagonal Pixelate":this.effectsList[e].pass=new THREE.ShaderPass(THREE.HexagonalPixelateShader);this.composer.addPass(this.effectsList[e].pass);break;case"Hue/Saturation":this.effectsList[e].pass=new THREE.ShaderPass(THREE.HueSaturationShader);this.composer.addPass(this.effectsList[e].pass);break;case"Kaleidoscope":this.effectsList[e].pass=new THREE.ShaderPass(THREE.KaleidoShader);this.composer.addPass(this.effectsList[e].pass);break;case"Noise":this.effectsList[e].pass=new THREE.ShaderPass(THREE.NoiseShader);this.composer.addPass(this.effectsList[e].pass);break;case"Pixelate":this.effectsList[e].pass=new THREE.ShaderPass(THREE.PixelateShader);this.composer.addPass(this.effectsList[e].pass);break;case"Plasma":this.effectsList[e].pass=new THREE.ShaderPass(THREE.PlasmaShader);this.composer.addPass(this.effectsList[e].pass);break;case"Polar Pixelate":this.effectsList[e].pass=new THREE.ShaderPass(THREE.PolarPixelateShader);this.composer.addPass(this.effectsList[e].pass);break;case"RGB Shift":this.effectsList[e].pass=new THREE.ShaderPass(THREE.RGBShiftShader);this.composer.addPass(this.effectsList[e].pass);break;case"Scanlines":this.effectsList[e].pass=new THREE.ShaderPass(THREE.ScanlinesShader);this.composer.addPass(this.effectsList[e].pass);break;case"Sepia":this.effectsList[e].pass=new THREE.ShaderPass(THREE.SepiaShader);this.composer.addPass(this.effectsList[e].pass);break;case"Technicolour":this.effectsList[e].pass=new THREE.ShaderPass(THREE.TechnicolorShader);this.composer.addPass(this.effectsList[e].pass);break;case"Triangle Blur":this.effectsList[e].pass=new THREE.ShaderPass(THREE.TriangleBlurShader);this.composer.addPass(this.effectsList[e].pass);break;case"Vignette":this.effectsList[e].pass=new THREE.ShaderPass(THREE.VignetteShader);this.composer.addPass(this.effectsList[e].pass);break;case"Wobble":this.effectsList[e].pass=new THREE.ShaderPass(THREE.WobbleShader);this.composer.addPass(this.effectsList[e].pass);break}}var t=new THREE.ShaderPass(THREE.CopyShader);this.composer.addPass(t)},applyEffects:function(){if(this.textureContext==null){return}for(var e=0;e<this.effectsList.length;e++){if(this.effectsList[e].effect=="CRT"||this.effectsList[e].effect=="Denoise"){this.effectsList[e].pass.uniforms["iResolution"].value.set(this.width,this.height)}}this.textureContext.clearRect(0,0,this.textureCanvas.width,this.textureCanvas.height);this.textureContext.drawImage(this.srcCanvas,0,0);this.material.map.needsUpdate=true;var t=1;this.renderer.clear();this.composer.render();this.renderer.readRenderTargetPixels(this.renderTarget,0,0,this.width,this.height,this.renderTargetPixels);for(var i=0;i<this.dstImageData.height;i++){for(var r=0;r<this.dstImageData.width;r++){var a=4*(i*this.dstImageData.width+r);var s=4*((this.dstImageData.height-1-i)*this.dstImageData.width+r);this.dstImageData.data[s]=this.renderTargetPixels[a];this.dstImageData.data[s+1]=this.renderTargetPixels[a+1];this.dstImageData.data[s+2]=this.renderTargetPixels[a+2];this.dstImageData.data[s+3]=this.renderTargetPixels[a+3]}}this.dstContext.clearRect(0,0,this.dstCanvas.width,this.dstCanvas.height);this.dstContext.putImageData(this.dstImageData,0,0)}};THREE.CRT2Shader={uniforms:{tDiffuse:{type:"t",value:null},iResolution:{type:"v2",value:new THREE.Vector2(320,200)},warpscreen:{type:"f",value:1},INPUT_THIN:{type:"f",value:.55},INPUT_MASK:{type:"f",value:.5},INPUT_BLUR:{type:"f",value:-2.5},masktype:{type:"f",value:1},INPUT_X:{type:"f",value:128},INPUT_Y:{type:"f",value:72}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 iResolution;","uniform float warpscreen;","uniform float INPUT_THIN;","uniform float INPUT_MASK;","uniform float INPUT_BLUR;","uniform float masktype;","uniform float INPUT_X;","uniform float INPUT_Y;","varying vec2 vUv;","#define CRTS_GPU 1","#define CRTS_GLSL 1","#define CRTS_TONE 1","#define CRTS_CONTRAST 1","#define CRTS_SATURATION 1","float FromSrgb1(float c){"," return (c<=0.04045)?c*(1.0/12.92):","  pow(c*(1.0/1.055)+(0.055/1.055),2.4);}","vec3 FromSrgb(vec3 c){return vec3("," FromSrgb1(c.r),FromSrgb1(c.g),FromSrgb1(c.b));}","vec3 CrtsFetch(vec2 uv){","uv*=vec2(INPUT_X,INPUT_Y)/iResolution.xy;","uv+=vec2(0.5,0.5);","return texture2D(tDiffuse,vUv, -16.0).rgb;}","#ifdef CRTS_CPU"," #ifndef CrtsPow","  #define CrtsPow powf"," #endif"," #ifndef CRTS_RESTRICT","  #define CRTS_RESTRICT _restrict"," #endif"," #ifndef CRTS_STATIC","  #define CRTS_STATIC static"," #endif"," CRTS_STATIC void CrtsTone("," float *CRTS_RESTRICT dst,"," float contrast,","float saturation,"," float thin,"," float mask){"," if(masktype > 1.9) {","   mask=1.0f;"," } "," if(masktype > 0.9 && masktype < 2.0) {","   mask=0.5f+mask*0.5f;"," } ","  float midOut=0.18f/((1.5f-thin)*(0.5f*mask+0.5f));","   float pMidIn=CrtsPow(0.18f,contrast);","   dst[0]= contrast;","   dst[1]=((-pMidIn)+midOut)/((1.0f-pMidIn)*midOut);","   dst[2]=((-pMidIn)*midOut+pMidIn)/(midOut*(-pMidIn)+midOut);","   dst[3]=contrast+saturation;}","#endif","#ifdef CRTS_GPU"," #ifdef CRTS_GLSL","  #define CrtsF1 float","  #define CrtsF2 vec2","  #define CrtsF3 vec3","  #define CrtsF4 vec4","  #define CrtsFractF1 fract","  #define CrtsRcpF1(x) (1.0/(x))","  #define CrtsSatF1(x) clamp((x),0.0,1.0)","  CrtsF1 CrtsMax3F1(CrtsF1 a,CrtsF1 b,CrtsF1 c){","   return max(a,max(b,c));}"," #endif"," #ifdef CRTS_HLSL","  #define CrtsF1 float","  #define CrtsF2 float2","  #define CrtsF3 float3","  #define CrtsF4 float4","  #define CrtsFractF1 frac","  #define CrtsRcpF1(x) (1.0/(x))","  #define CrtsSatF1(x) saturate(x)","  CrtsF1 CrtsMax3F1(CrtsF1 a,CrtsF1 b,CrtsF1 c){","   return max(a,max(b,c));}"," #endif"," CrtsF4 CrtsTone("," CrtsF1 contrast,"," CrtsF1 saturation,"," CrtsF1 thin,"," CrtsF1 mask){"," if(masktype > 1.9) {","   mask=1.0;","  } "," if(masktype > 0.9 && masktype < 2.0) {","   mask=0.5+mask*0.5;"," } ","  CrtsF4 ret;","  CrtsF1 midOut=0.18/((1.5-thin)*(0.5*mask+0.5));","  CrtsF1 pMidIn=pow(0.18,contrast);","  ret.x=contrast;","  ret.y=((-pMidIn)+midOut)/((1.0-pMidIn)*midOut);","  ret.z=((-pMidIn)*midOut+pMidIn)/(midOut*(-pMidIn)+midOut);","  ret.w=contrast+saturation;","  return ret;}"," CrtsF3 CrtsMask(CrtsF2 pos,CrtsF1 dark){"," if(masktype < 1.0) {","   CrtsF3 m=CrtsF3(dark,dark,dark);","   CrtsF1 x=CrtsFractF1(pos.x*(1.0/3.0));","   if(x<(1.0/3.0))m.r=1.0;","   else if(x<(2.0/3.0))m.g=1.0;","   else m.b=1.0;","   return m;"," } "," if(masktype > 0.9 && masktype < 2.0) {","   CrtsF3 m=CrtsF3(1.0,1.0,1.0);","   CrtsF1 x=CrtsFractF1(pos.x*(1.0/3.0));","   if(x<(1.0/3.0))m.r=dark;","   else if(x<(2.0/3.0))m.g=dark;","   else m.b=dark;","   return m;","  } "," if(masktype > 1.9) {","   return CrtsF3(1.0,1.0,1.0);"," } ","  #ifdef CRTS_MASK_SHADOW","   pos.x+=pos.y*3.0;","   CrtsF3 m=CrtsF3(dark,dark,dark);","   CrtsF1 x=CrtsFractF1(pos.x*(1.0/6.0));","   if(x<(1.0/3.0))m.r=1.0;","   else if(x<(2.0/3.0))m.g=1.0;","   else m.b=1.0;","   return m;","  #endif"," }"," CrtsF3 CrtsFilter(","  CrtsF2 ipos,","  CrtsF2 inputSizeDivOutputSize,     ","  CrtsF2 halfInputSize,","  CrtsF2 rcpInputSize,","  CrtsF2 rcpOutputSize,","  CrtsF2 twoDivOutputSize,   ","  CrtsF1 inputHeight,","  CrtsF2 warp,","  CrtsF1 thin,","  CrtsF1 blur,","  CrtsF1 mask,","  CrtsF4 tone"," ){","  #ifdef CRTS_DEBUG","   CrtsF2 uv=ipos*rcpOutputSize;","   if(uv.x<0.5){","    uv*=1.0/rcpInputSize;","    uv=floor(uv)+CrtsF2(0.5,0.5);","    uv*=rcpInputSize;","    CrtsF3 color=texture2D(tDiffuse, vUv).rgb;","    return color;","   }","  #endif","  CrtsF2 pos;","  CrtsF1 vin = 0.0;","  if(warpscreen > 0.5) {","   pos=ipos*twoDivOutputSize-CrtsF2(1.0,1.0);","   pos*=CrtsF2(","    1.0+(pos.y*pos.y)*warp.x,","    1.0+(pos.x*pos.x)*warp.y);","   vin=1.0-(","    (1.0-CrtsSatF1(pos.x*pos.x))*(1.0-CrtsSatF1(pos.y*pos.y)));","   vin=CrtsSatF1((-vin)*inputHeight+inputHeight);","   pos=pos*halfInputSize+halfInputSize;     "," } else { ","   pos=ipos*inputSizeDivOutputSize;"," } ","  CrtsF1 y0=floor(pos.y-0.5)+0.5;","  #ifdef CRTS_2_TAP","   pos.x+=0.5;","   CrtsF1 xi=floor(pos.x);","   CrtsF1 xf=pos.x-xi;","   xf=xf*xf*xf*(xf*(xf*6.0-15.0)+10.0);  ","   CrtsF1 x0=xi+xf-0.5;","   CrtsF2 p=CrtsF2(x0*rcpInputSize.x,y0*rcpInputSize.y);     ","   CrtsF3 colA=CrtsFetch(p);","   p.y+=rcpInputSize.y;","   CrtsF3 colB=CrtsFetch(p);","  #else","   CrtsF1 x0=floor(pos.x-1.5)+0.5;","   CrtsF2 p=CrtsF2(x0*rcpInputSize.x,y0*rcpInputSize.y);     ","   CrtsF3 colA0=CrtsFetch(p);","   p.x+=rcpInputSize.x;","   CrtsF3 colA1=CrtsFetch(p);","   p.x+=rcpInputSize.x;","   CrtsF3 colA2=CrtsFetch(p);","   p.x+=rcpInputSize.x;","   CrtsF3 colA3=CrtsFetch(p);","   p.y+=rcpInputSize.y;","   CrtsF3 colB3=CrtsFetch(p);","   p.x-=rcpInputSize.x;","   CrtsF3 colB2=CrtsFetch(p);","   p.x-=rcpInputSize.x;","   CrtsF3 colB1=CrtsFetch(p);","   p.x-=rcpInputSize.x;","   CrtsF3 colB0=CrtsFetch(p);","  #endif","  CrtsF1 off=pos.y-y0;","  CrtsF1 pi2=6.28318530717958;","  CrtsF1 hlf=0.5;","  CrtsF1 scanA=cos(min(0.5,  off *thin     )*pi2)*hlf+hlf;","  CrtsF1 scanB=cos(min(0.5,(-off)*thin+thin)*pi2)*hlf+hlf;","  #ifdef CRTS_2_TAP"," if(warpscreen > 0.5) { ","    scanA*=vin;","    scanB*=vin;"," } ","   CrtsF3 color=(colA*scanA)+(colB*scanB);","  #else","   CrtsF1 off0=pos.x-x0;","   CrtsF1 off1=off0-1.0;","   CrtsF1 off2=off0-2.0;","   CrtsF1 off3=off0-3.0;","   CrtsF1 pix0=exp2(blur*off0*off0);","   CrtsF1 pix1=exp2(blur*off1*off1);","   CrtsF1 pix2=exp2(blur*off2*off2);","   CrtsF1 pix3=exp2(blur*off3*off3);","   CrtsF1 pixT=CrtsRcpF1(pix0+pix1+pix2+pix3);"," if(warpscreen > 0.5) { ","    pixT*=vin;"," } ","   scanA*=pixT;","   scanB*=pixT;","   CrtsF3 color=","    (colA0*pix0+colA1*pix1+colA2*pix2+colA3*pix3)*scanA +","    (colB0*pix0+colB1*pix1+colB2*pix2+colB3*pix3)*scanB;","  #endif","  color*=CrtsMask(ipos,mask);","  #ifdef CRTS_TONE","   CrtsF1 peak=max(1.0/(256.0*65536.0),","    CrtsMax3F1(color.r,color.g,color.b));","   CrtsF3 ratio=color*CrtsRcpF1(peak);","   #ifdef CRTS_CONTRAST","    peak=pow(peak,tone.x);","   #endif","   peak=peak*CrtsRcpF1(peak*tone.y+tone.z);","   #ifdef CRTS_SATURATION","    ratio=pow(ratio,CrtsF3(tone.w,tone.w,tone.w));","   #endif","   return ratio*peak;"," #else","  return color;"," #endif"," }","#endif","float ToSrgb1(float c){"," return(c<0.0031308?c*12.92:1.055*pow(c,0.41666)-0.055);}","vec3 ToSrgb(vec3 c){return vec3("," ToSrgb1(c.r),ToSrgb1(c.g),ToSrgb1(c.b));}","void main() {"," vec2 fragCoord = vUv * iResolution;"," gl_FragColor.rgb=CrtsFilter(","  fragCoord.xy,","  vec2(INPUT_X,INPUT_Y)/iResolution.xy,","  vec2(INPUT_X,INPUT_Y)*vec2(0.5,0.5),","  1.0/vec2(INPUT_X,INPUT_Y),","  1.0/iResolution.xy,","  2.0/iResolution.xy,","  INPUT_Y,","  vec2(1.0/48.0,1.0/24.0),","  INPUT_THIN,","  INPUT_BLUR,","  INPUT_MASK,","  CrtsTone(1.0,0.0,INPUT_THIN,INPUT_MASK));","gl_FragColor.a = 1.0;","}"].join("\n")};GhostShader={uniforms:{tDiffuse:{value:null},amount:{value:.02},angle:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform float angle;","varying vec2 vUv;","void main() {","vec2 offset = amount * vec2( cos(angle), sin(angle));","vec4 cr = texture2D(tDiffuse, vUv + offset);","vec4 cga = texture2D(tDiffuse, vUv);","vec4 cb = texture2D(tDiffuse, vUv - offset);","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vUv ) * 0.7;","sum += texture2D( tDiffuse, vUv + offset ) * 0.3;","sum += texture2D( tDiffuse, vUv + offset * 2.0 ) * 0.2;","sum += texture2D( tDiffuse, vUv + offset * 3.0 ) * 0.1;","sum += texture2D( tDiffuse, vUv + offset * 4.0 ) * 0.04;","gl_FragColor = sum;","}"].join("\n")};ColorHalftoneShader={uniforms:{tDiffuse:{value:null},tSize:{value:new THREE.Vector2(256,256)},center:{value:new THREE.Vector2(.5,.5)},angle:{value:1.57},scale:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec2 center;","uniform float angle;","uniform float scale;","uniform vec2 tSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float pattern(float a) {","float s = sin( a ), c = cos( a );","vec2 tex = vUv * tSize - center;","vec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;","return ( sin( point.x ) * sin( point.y ) ) * 4.0;","}","void main() {","vec4 color = texture2D( tDiffuse, vUv );","vec3 cmy = 1.0 - color.rgb;","float k = min(cmy.x, min(cmy.y, cmy.z));","cmy = (cmy - k) / (1.0 - k);","cmy = clamp(cmy * 10.0 - 3.0 + vec3(pattern(angle + 0.26179), pattern(angle + 1.30899), pattern(angle)), 0.0, 1.0);","k = clamp(k * 10.0 - 5.0 + pattern(angle + 0.78539), 0.0, 1.0);","gl_FragColor = vec4(1.0 - cmy - k, color.a);","}"].join("\n")};THREE.WobbleShader={uniforms:{tDiffuse:{type:"t",value:null},time:{type:"f",value:0},strength:{type:"f",value:.001},size:{type:"f",value:50},speed:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float time;","uniform float strength;","uniform float size;","uniform float speed;","varying vec2 vUv;","const float TWO_PI = 6.283185307179586;","void main() {","vec2 p = -1.0 + 2.0 * vUv;","float pos = time * TWO_PI + length(p * size);","gl_FragColor = texture2D(tDiffuse, vUv + strength * vec2(cos(pos), sin(pos)));","}"].join("\n")};THREE.NoiseShader={uniforms:{tDiffuse:{value:null},time:{value:0},nIntensity:{value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform float time;","uniform float nIntensity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, vUv );","float dx = rand( vUv + time );","vec3 cResult = cTextureScreen.rgb + cTextureScreen.rgb * clamp( 0.1 + dx, 0.0, 1.0 );","cResult = cTextureScreen.rgb + clamp( nIntensity, 0.0,1.0 ) * ( cResult - cTextureScreen.rgb );","gl_FragColor =  vec4( cResult, cTextureScreen.a );","}"].join("\n")};EdgeShader={uniforms:{tDiffuse:{value:null},aspect:{value:new THREE.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform vec2 aspect;","mat3 G[2];","const mat3 g0 = mat3( 1.0, 2.0, 1.0, 0.0, 0.0, 0.0, -1.0, -2.0, -1.0 );","const mat3 g1 = mat3( 1.0, 0.0, -1.0, 2.0, 0.0, -2.0, 1.0, 0.0, -1.0 );","void main(void)","{","mat3 I;","float cnv[2];","vec3 sample;","vec2 texel = vec2(1.0 / aspect.x, 1.0 / aspect.y);","G[0] = g0;","G[1] = g1;","for (float i=0.0; i<3.0; i++)","for (float j=0.0; j<3.0; j++) {","sample = texture2D( tDiffuse, vUv + texel * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","for (int i=0; i<2; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3; ","}","gl_FragColor = vec4(0.5 * sqrt(cnv[0]*cnv[0]+cnv[1]*cnv[1]));","} "].join("\n")};BumpShader={uniforms:{tDiffuse:{value:null},aspect:{value:new THREE.Vector2(512,512)},weight:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform vec2 aspect;","uniform float weight;","const mat3 g0 = mat3( -1.0, -1.0, 0.0, -1.0, 1.0, 1.0, 0.0, 1.0, 1.0 );","void main(void)","{","vec2 texel = vec2(1.0 / aspect.x, 1.0 / aspect.y);","vec4 colorSum =","    texture2D(tDiffuse, vUv + texel * vec2(-1, -1)) * g0[0][0] +","    texture2D(tDiffuse, vUv + texel * vec2( 0, -1)) * g0[0][1] +","    texture2D(tDiffuse, vUv + texel * vec2( 1, -1)) * g0[0][2] +","    texture2D(tDiffuse, vUv + texel * vec2(-1,  0)) * g0[1][0] +","    texture2D(tDiffuse, vUv + texel * vec2( 0,  0)) * g0[1][1] +","    texture2D(tDiffuse, vUv + texel * vec2( 1,  0)) * g0[1][2] +","    texture2D(tDiffuse, vUv + texel * vec2(-1,  1)) * g0[2][0] +","    texture2D(tDiffuse, vUv + texel * vec2( 0,  1)) * g0[2][1] +","    texture2D(tDiffuse, vUv + texel * vec2( 1,  1)) * g0[2][2] ;","gl_FragColor = vec4((colorSum / weight).rgb, 1);","} "].join("\n")};EmbossShader={uniforms:{tDiffuse:{value:null},aspect:{value:new THREE.Vector2(512,512)},weight:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform vec2 aspect;","uniform float weight;","const mat3 g0 = mat3( -2.0, -1.0, 0.0, -1.0, 1.0, 1.0, 0.0, 1.0, 2.0 );","void main(void)","{","vec2 texel = vec2(1.0 / aspect.x, 1.0 / aspect.y);","vec4 colorSum =","    texture2D(tDiffuse, vUv + texel * vec2(-1, -1)) * g0[0][0] +","    texture2D(tDiffuse, vUv + texel * vec2( 0, -1)) * g0[0][1] +","    texture2D(tDiffuse, vUv + texel * vec2( 1, -1)) * g0[0][2] +","    texture2D(tDiffuse, vUv + texel * vec2(-1,  0)) * g0[1][0] +","    texture2D(tDiffuse, vUv + texel * vec2( 0,  0)) * g0[1][1] +","    texture2D(tDiffuse, vUv + texel * vec2( 1,  0)) * g0[1][2] +","    texture2D(tDiffuse, vUv + texel * vec2(-1,  1)) * g0[2][0] +","    texture2D(tDiffuse, vUv + texel * vec2( 0,  1)) * g0[2][1] +","    texture2D(tDiffuse, vUv + texel * vec2( 1,  1)) * g0[2][2] ;","gl_FragColor = vec4((colorSum / weight).rgb, 1);","} "].join("\n")};THREE.RainbowShader={uniforms:{tDiffuse:{type:"t",value:null},amount:{type:"f",value:.5},offset:{type:"f",value:.5},time:{type:"f",value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform float offset;","uniform float time;","varying vec2 vUv;","vec3 rainbow2( in float t ){","vec3 d = vec3(0.0,0.33,0.67);","return 0.5 + 0.5*cos( 6.28318*(t+d) );","}","void main() {","vec2 p = vUv;","vec3 origCol = texture2D( tDiffuse, p ).rgb;","vec2 off = texture2D( tDiffuse, p ).rg - 0.5;","p += off * offset;","vec3 rb = rainbow2( (p.x + p.y + time * 2.0) * 0.5);","vec3 col = mix(origCol,rb,amount);","gl_FragColor = vec4(col, 1.0);","}"].join("\n")};THREE.ScanlinesShader={uniforms:{tDiffuse:{value:null},time:{value:0},linesAmount:{value:.05},count:{value:4096}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float time;","uniform float count;","uniform float linesAmount;","varying vec2 vUv;","#define PI 3.14159265359","highp float rand( const in vec2 uv ) {","const highp float a = 12.9898, b = 78.233, c = 43758.5453;","highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );","return fract(sin(sn) * c);","}","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, vUv );","vec2 sc = vec2( sin( (vUv.y) * count ), cos( (vUv.y) * count) );","vec3 cResult = cTextureScreen.rgb + cTextureScreen.rgb * vec3( sc.x, sc.y, sc.x ) * linesAmount;","gl_FragColor =  vec4( cResult, cTextureScreen.a );","}"].join("\n")};THREE.PlasmaShader={uniforms:{tDiffuse:{value:null},time:{value:0},scale:{value:1},amount:{value:.5}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float time;","uniform float scale;","uniform float amount;","varying vec2 vUv;","#define PI 3.14159265359","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, vUv );","float v = 0.0;","vec2 c = vUv * scale - scale/2.0;","v += sin((c.x+time));","v += sin((c.y+time)/2.0);","v += sin((c.x+c.y+time)/2.0);","c += scale/2.0 * vec2(sin(time/3.0), cos(time/2.0));","v += sin(sqrt(c.x*c.x+c.y*c.y+1.0)+time);","v = v/2.0;","vec3 col = vec3(1, sin(PI*v), cos(PI*v));","gl_FragColor = (1.0 - amount) * cTextureScreen + amount  * vec4(col*.5 + .5, 1);","}"].join("\n")};THREE.BadTVShader={uniforms:{tDiffuse:{type:"t",value:null},time:{type:"f",value:0},distortion:{type:"f",value:3},distortion2:{type:"f",value:5},speed:{type:"f",value:.116},rollSpeed:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float time;","uniform float distortion;","uniform float distortion2;","uniform float speed;","uniform float rollSpeed;","varying vec2 vUv;","vec3 mod289(vec3 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec2 mod289(vec2 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 permute(vec3 x) {","  return mod289(((x*34.0)+1.0)*x);","}","float snoise(vec2 v)","  {","  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0","                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)","                     -0.577350269189626,  // -1.0 + 2.0 * C.x","                      0.024390243902439); // 1.0 / 41.0","  vec2 i  = floor(v + dot(v, C.yy) );","  vec2 x0 = v -   i + dot(i, C.xx);","  vec2 i1;","  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);","  vec4 x12 = x0.xyxy + C.xxzz;"," x12.xy -= i1;","  i = mod289(i); // Avoid truncation effects in permutation","  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))","   + i.x + vec3(0.0, i1.x, 1.0 ));","  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);","  m = m*m ;","  m = m*m ;","  vec3 x = 2.0 * fract(p * C.www) - 1.0;","  vec3 h = abs(x) - 0.5;","  vec3 ox = floor(x + 0.5);","  vec3 a0 = x - ox;","  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );","  vec3 g;","  g.x  = a0.x  * x0.x  + h.x  * x0.y;","  g.yz = a0.yz * x12.xz + h.yz * x12.yw;","  return 130.0 * dot(m, g);","}","void main() {","vec2 p = vUv;","float ty = time * speed * 17.346;","float yt = p.y - ty;","float offset = snoise(vec2(yt*3.0,0.0))*0.2;","offset = offset*distortion * offset*distortion * offset;","offset += snoise(vec2(yt*50.0,0.0))*distortion2*0.002;","gl_FragColor = texture2D(tDiffuse,  vec2(fract(p.x + offset),fract(p.y - time * rollSpeed) ));","}"].join("\n")};THREE.PixelateShader={uniforms:{tDiffuse:{type:"t",value:null},pixelsX:{type:"f",value:10},pixelsY:{type:"f",value:10}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float pixelsX;","uniform float pixelsY;","varying vec2 vUv;","void main() {","vec2 p = vUv;","p.x = floor(p.x * pixelsX)/pixelsX + 0.5/pixelsX;","p.y = floor(p.y * pixelsY)/pixelsY + 0.5/pixelsY;","gl_FragColor = texture2D(tDiffuse, p);","}"].join("\n")};THREE.PolarPixelateShader={uniforms:{tDiffuse:{type:"t",value:null},pixelsX:{type:"f",value:.05},pixelsY:{type:"f",value:.05}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float pixelsX;","uniform float pixelsY;","varying vec2 vUv;","void main() {","vec2 normCoord = 2.0 * vUv - 1.0;","float r = length(normCoord);","float phi = atan(normCoord.y, normCoord.x);","r = r - mod(r, pixelsX) + 0.03;","phi = phi - mod(phi, pixelsY);","normCoord.x = r * cos(phi);","normCoord.y = r * sin(phi);","vec2 textureCoordinateToUse = normCoord / 2.0 + 0.5;","gl_FragColor = texture2D(tDiffuse, textureCoordinateToUse );","}"].join("\n")};THREE.HexagonalPixelateShader={uniforms:{tDiffuse:{type:"t",value:null},scale:{type:"f",value:10},texSize:{value:new THREE.Vector2(320,200)},center:{value:new THREE.Vector2(160,100)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float scale;","uniform vec2 texSize;","uniform vec2 center;","varying vec2 vUv;","void main() {","vec2 tex = (vUv * texSize - center) / scale;","tex.y /= 0.866025404;","tex.x -= tex.y * 0.5;","vec2 a;","if (tex.x + tex.y - floor(tex.x) - floor(tex.y) < 1.0) a = vec2(floor(tex.x), floor(tex.y));","else a = vec2(ceil(tex.x), ceil(tex.y));","vec2 b = vec2(ceil(tex.x), floor(tex.y));","vec2 c = vec2(floor(tex.x), ceil(tex.y));","vec3 TEX = vec3(tex.x, tex.y, 1.0 - tex.x - tex.y);","vec3 A = vec3(a.x, a.y, 1.0 - a.x - a.y);","vec3 B = vec3(b.x, b.y, 1.0 - b.x - b.y);","vec3 C = vec3(c.x, c.y, 1.0 - c.x - c.y);","float alen = length(TEX - A);","float blen = length(TEX - B);","float clen = length(TEX - C);","vec2 choice;","      if (alen < blen) {","          if (alen < clen) choice = a;","          else choice = c;","      } else {","          if (blen < clen) choice = b;","          else choice = c;","      }","      choice.x += choice.y * 0.5;","      choice.y *= 0.866025404;","      choice *= scale / texSize;","      gl_FragColor = texture2D(tDiffuse, choice + center / texSize);","}"].join("\n")};THREE.DiffusionShader={uniforms:{tDiffuse:{type:"t",value:null},scale:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform sampler2D tDiffuse;","uniform float scale;","varying vec2 vUv;","void main() {","float r1 = rand( vUv  );","float r2 = rand( vUv  );","float x = vUv.x - scale * r1 * sin(r2 * 255.0);","float y = vUv.y - scale * r1 * cos(r2 * 255.0);","vec2 p = vUv;","p.x = x;","p.y = y;","gl_FragColor = texture2D(tDiffuse, p);","}"].join("\n")};THREE.TriangleBlurShader={uniforms:{tDiffuse:{value:null},amount:{type:"f",value:.01}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","#define ITERATIONS 10.0","uniform sampler2D tDiffuse;","uniform float amount;","varying vec2 vUv;","void main() {","vec4 color = vec4( 0.0 );","float total = 0.0;","float offset = rand( vUv );","for ( float t = -ITERATIONS; t <= ITERATIONS; t ++ ) {","float percent = ( t + offset - 0.5 ) / ITERATIONS;","float weight = 1.0 - abs( percent );","color += texture2D( tDiffuse, vUv + amount * percent ) * weight;","total += weight;","}","gl_FragColor = color / total;","}"].join("\n")};DenoiseShader={uniforms:{tDiffuse:{value:null},strength:{type:"f",value:.02},exponent:{type:"f",value:.1},iResolution:{type:"v2",value:new THREE.Vector2(320,200)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float strength;","uniform float exponent;","uniform vec2 iResolution;","varying vec2 vUv;","void main() {","  vec4 center = texture2D(tDiffuse, vUv);","  vec4 color = vec4(0.0);","  float total = 0.0;","  for (float x = -4.0; x <= 4.0; x += 1.0) {","    for (float y = -4.0; y <= 4.0; y += 1.0) {","      vec4 sample = texture2D(tDiffuse, vUv + vec2(x, y) / iResolution);","      float weight = 1.0 - abs(dot(sample.rgb - center.rgb, vec3(0.25)));","      weight = pow(weight, exponent);","      color += sample * weight;","      total += weight;","    }","  }"," gl_FragColor = color / total;","}"].join("\n")};ChromaKeyShader={uniforms:{tDiffuse:{value:null},r:{type:"f",value:.06},g:{type:"f",value:.698},b:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float r;","uniform float g;","uniform float b;","varying vec2 vUv;","void main() {","  vec3 screen = vec3(r, g, b);","  mediump vec3 tColor = texture2D( tDiffuse, vUv ).rgb;","  mediump float a = (length(tColor - screen) - 0.5) * 7.0;","  gl_FragColor = vec4(tColor, a);","}"].join("\n")};var HexEditor=function(){this.uiComponent=null;this.data=false};HexEditor.prototype={init:function(){},buildInterface:function(e){if(this.uiComponent!=null){return}this.uiComponent=UI.create("UI.Panel",{id:"hexEditor"});e.add(this.uiComponent);var t='<div id="hexEditorContent" style="background-color: #222222; color: #eeeeee; overflow-y: auto" class="panelFill"></div>';var i=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.add(i);var r=this;UI.on("ready",function(){r.initEvents()})},initEvents:function(){},display:function(){var e=this.data.length;var t=16;var i=Math.ceil(e/t);var r="";var a=0;for(var s=0;s<i;s++){var o="<div>";var l=("0000"+a.toString(16)).substr(-4);o+=l+":&nbsp;&nbsp";for(var n=0;n<t;n++){if(a<e){var l=("00"+this.data[a].toString(16)).substr(-2);o+=l+"&nbsp";a++}}o+="</div>";r+=o}$("#hexEditorContent").html(r)},load:function(e){this.path=e;var t=g_app.doc.getDocRecord(e);if(t!=null){console.log(t.data);this.data=base64ToBuffer(t.data);this.display()}}};var ImportAssembly=function(){this.editor=null};ImportAssembly.prototype={init:function(e){this.editor=e},start:function(){var t=this;this.componentsLoaded=0;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"importAssemblyDialog",title:"Import Assembly",width:840});this.importAssemblyPanel=UI.create("UI.HTMLPanel");this.importAssemblyPanel.load("html/textMode/importAssembly.html",function(){t.initContent()});this.uiComponent.add(this.importAssemblyPanel);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.doImport();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{t.initContent()}UI.showDialog("importAssemblyDialog");this.visible=true},initContent:function(){$("#importAssemblySource").val("")},doImport:function(){var e=$("#importAssemblySource").val();e=e.replace(/\r/g,"");var t=0;var i=0;var r=0;var a=this.editor.grid;var s=a.getWidth();var o=a.getHeight();var l=a.getXYGridPosition();var n=e.split("\n");for(var h=0;h<n.length;h++){var d=n[h].replace(/!byte/g,"");var c=d.split(",");for(var f=0;f<c.length;f++){var u=c[f].trim();if(u[0]==="$"){u=u.substring(1)}if(u!==""){var p=parseInt(u,16);if(isNaN(p)){console.log("nan: "+u)}else{t=o-Math.floor(r/s)-1;i=r%s;r++;a.setCell({c:p,x:i,y:t,z:l})}}}}}};var ImportC64Formats=function(){this.editor=null;this.tileData=[];this.screenData=[];this.colorData=[];this.canvas=null;this.context=null;this.c64ImageData=null;this.crtData=null;this.rows=25;this.cols=40;this.bgColor=6;this.borderColor=6;this.visible=false;this.viceSnapshotReader=null;this.importC=null;this.importSeq=null;this.importCharPad=null;this.importType="";this.screnMode=TextModeEditor.Mode.TEXTMODE;this.extendedBackground=false;this.mouseDownOnPreview=false;this.previewOffsetX=0;this.previewOffsetY=0;this.commodoreKeyDown=false;this.uiPasteText=null;this.lastDriveStatus=false;this.lastDrivePosition=false;this.joystickPort=0};ImportC64Formats.prototype={init:function(e){this.editor=e},initCharacterData:function(){this.tileData=[];var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getData();var i=e.getTileWidth();var r=e.getTileHeight();for(var a=0;a<t.length;a++){this.tileData[a]=[];for(var s=0;s<i*r;s++){this.tileData[a][s]=t[a][s]}}},initScreenData:function(){this.screenData=[];for(var e=0;e<this.rows*this.cols;e++){this.screenData[e]=e%256}},initColorData:function(){this.colorData=[];for(var e=0;e<this.rows*this.cols;e++){this.colorData[e]=14}},showPasteTextDialog:function(){var i=this;if(this.uiPasteText==null){this.uiPasteText=UI.create("UI.Dialog",{id:"importC64PasteDialog",title:"Paste Text",width:400,height:300});var e='<div class="panelFill">';e+='<div style="position: absolute; top: 6px; bottom: 6px; left: 6px; right: 6px">';e+='<textarea id="importC64PasteText" style="position: absolute; top: 0px; left: 0px; bottom: 0px; width: 100%"></textarea>';e+="</div>";e+="</div>";this.pasteHtmlComponent=UI.create("UI.HTMLPanel",{html:e});this.uiPasteText.add(this.pasteHtmlComponent);this.pasteOkButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiPasteText.addButton(this.pasteOkButton);this.pasteOkButton.on("click",function(e){var t=$("#importC64PasteText").val();i.doC64PasteText(t);UI.closeDialog()});this.pasteCloseButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiPasteText.addButton(this.pasteCloseButton);this.pasteCloseButton.on("click",function(e){UI.closeDialog()})}UI.showDialog("importC64PasteDialog")},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"importC64FormatsDialog",title:"Import",width:615,height:500});this.uiComponent.on("keydown",function(e){t.keyDown(e)});this.uiComponent.on("keyup",function(e){t.keyUp(e)});this.uiComponent.on("keypress",function(e){t.keyPress(e)});this.uiComponent.on("close",function(){t.visible=false});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/importC64Formats.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"Import",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.doImport();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI("importC64FormatsDialog").setWidth(615);UI("importC64FormatsDialog").setHeight(490);UI.showDialog("importC64FormatsDialog");this.visible=true},initContent:function(){if(this.canvas==null){this.canvas=document.getElementById("importC64FormatsPreview");this.canvas.width=384;this.canvas.height=272;this.context=this.canvas.getContext("2d");this.c64ImageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var e=this.editor.layers.getSelectedLayerObject();if(e&&e.getType()=="grid"){this.bgColor=e.getBackgroundColor();this.borderColor=e.getBorderColor();this.multi1=e.getC64Multi1Color();this.multi2=e.getC64Multi2Color()}}this.initCharacterData();this.initScreenData();this.initColorData();this.showC64();var t=parseInt($("input[name=importC64JoystickPort]:checked").val(),10);this.setJoystickPort(t);$(".importC64Settings").hide();$("#importC64Settings").show();document.getElementById("importC64FormatsForm").reset()},initEvents:function(){var i=this;$("#importC64FormatsChooseFile").on("click",function(){$("#importC64FormatsSourceFile").click()});document.getElementById("importC64FormatsSourceFile").addEventListener("change",function(e){var t=document.getElementById("importC64FormatsSourceFile").files[0];i.setImportFile(t)});$("#c64SaveState").on("click",function(){});$("#c64RestoreState").on("click",function(){});$("#importC64FormatsButton").on("click",function(){i.doImport()});$("#importC64FormatsFramesPrev").on("click",function(){i.changeFrame(-1)});$("#importC64FormatsFramesNext").on("click",function(){i.changeFrame(1)});$("#importC64FormatsPreview").on("mouseenter",function(e){i.mouseEnter(e)});$("#importC64FormatsPreview").on("mouseleave",function(e){i.mouseLeave(e)});$("#importC64FormatsPreview").on("mousedown",function(e){i.mouseDown(e)});$("#importC64FormatsPreview").on("mousemove",function(e){i.mouseMove(e)});$("#importC64FormatsPreview").on("mouseup",function(e){i.mouseUp(e)});$("#importC64PRGReset").on("click",function(e){i.resetC64()});$("#importC64PRGPaste").on("click",function(e){i.c64Paste()});$("#importC64PRGCMDKey").on("click",function(e){i.c64CommodoreKey()});$("input[name=importC64JoystickPort]").on("click",function(e){var t=parseInt($("input[name=importC64JoystickPort]:checked").val(),10);i.setJoystickPort(t)})},mouseEnter:function(e){if(this.screenWidth>40||this.screenHeight>25){UI.setCursor("can-drag-scroll")}else{UI.setCursor("default")}},mouseLeave:function(e){UI.setCursor("default")},mouseDown:function(e){this.mouseDownX=e.pageX;this.mouseDownY=e.pageY;this.mouseDownOffsetX=this.previewOffsetX;this.mouseDownOffsetY=this.previewOffsetY;this.mouseDownOnPreview=true;UI.captureMouse(this,"drag-scroll");UI.setCursor("drag-scroll")},mouseMove:function(e){if(this.mouseDownOnPreview){UI.setCursor("drag-scroll");var t=this.mouseDownOffsetX+Math.floor((e.pageX-this.mouseDownX)/8);var i=this.mouseDownOffsetY+Math.floor((e.pageY-this.mouseDownY)/8);var r=40;var a=25;if(-t+r>this.screenWidth){t=-(this.screenWidth-r)}if(-t<0){t=0}if(-i+a>this.screenHeight){i=-(this.screenHeight-a)}if(-i<0){i=0}if(this.previewOffsetX!=t||this.previewOffsetY!=i){this.previewOffsetX=t;this.previewOffsetY=i;switch(this.importType){case"ctm":this.getCharPadScreenData();break;case"c":this.getCScreenData();break}this.drawScreen()}}},mouseUp:function(e){this.mouseDownOnPreview=false;UI.setCursor("default")},drawScreen:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();var t=8;var i=8;var r=this.screenMode;var a=t*40;var s=i*25;var o=Math.floor((this.canvas.width-a)/2);var l=Math.floor((this.canvas.height-s)/2);var n=this.context.getImageData(0,0,a,s);var h=e.getHex(this.bgColor);var d=h>>16&255;var c=h>>8&255;var f=h&255;for(var u=0;u<this.screenData.length;u++){r=this.screenMode;var p=this.screenData[u];var v=this.colorData[u];if(v<8){r=TextModeEditor.Mode.TEXTMODE}var g=u%this.cols;var m=Math.floor(u/this.cols);var y=this.tileData[p];var b=[];if(r==TextModeEditor.Mode.C64MULTICOLOR){v-=8;var C=v;b=[];b.push(e.getColor(this.bgColor));b.push(e.getColor(this.multi1));b.push(e.getColor(this.multi2));b.push(e.getColor(C))}var x=e.getHex(v);var S=x>>16&255;var P=x>>8&255;var w=x&255;for(var I=0;I<i;I++){for(var k=0;k<t;k++){var M=k+I*t;var v=y[M];var T=(g*t+k+(m*i+I)*n.width)*4;if(r==TextModeEditor.Mode.TEXTMODE){if(v>0){n.data[T]=S;n.data[T+1]=P;n.data[T+2]=w;n.data[T+3]=255}else{n.data[T]=d;n.data[T+1]=c;n.data[T+2]=f;n.data[T+3]=255}}else if(r==TextModeEditor.Mode.C64MULTICOLOR){var D=0;if(v>0){D+=2}v=y[M+1];if(v>0){D+=1}var x=b[D];if(D==0){n.data[T]=d;n.data[T+1]=c;n.data[T+2]=f;n.data[T+3]=255;n.data[T+4]=d;n.data[T+5]=c;n.data[T+6]=f;n.data[T+7]=255}else if(D==3){n.data[T]=S;n.data[T+1]=P;n.data[T+2]=w;n.data[T+3]=255;n.data[T+4]=S;n.data[T+5]=P;n.data[T+6]=w;n.data[T+7]=255}else{n.data[T]=x.r*255;n.data[T+1]=x.g*255;n.data[T+2]=x.b*255;n.data[T+3]=255;n.data[T+4]=x.r*255;n.data[T+5]=x.g*255;n.data[T+6]=x.b*255;n.data[T+7]=255}k++}}}}var E=e.getHexString(this.borderColor);this.context.fillStyle="#"+E;this.context.fillRect(0,0,this.canvas.width,this.canvas.height);this.context.putImageData(n,o,l)},loadSeq:function(e){this.importType="seq";this.screenMode=TextModeEditor.Mode.TEXTMODE;if(this.importSeq==null){this.importSeq=new ImportSeq;this.importSeq.init(this.editor)}$("#importC64FormatsFrames").hide();$("#importC64FormatsViceSettings").hide();$("#importC64PRGControls").hide();var r=this;var t=new FileReader;t.onload=function(e){var t=new Uint8Array(e.target.result);var i=r.importSeq.readSeq(t);r.showSeq()};t.readAsArrayBuffer(e)},showSeq:function(){$(".importC64Settings").hide();$("#importSEQSettings").show();$("#importC64PRGControls").hide();var e="";e+='<div class="c64ImportRow">';e+='<div class="c64ImportHeading">Format:</div>';e+="<div>SEQ</div>";e+="</div>";this.screenWidth=this.importSeq.getScreenWidth();this.screenHeight=this.importSeq.getScreenHeight();var t=this.importSeq.getFrameCount();e+='<div class="c64ImportRow">';e+='<div class="c64ImportHeading">Screen Size:</div>';e+="<div>"+this.screenWidth+" x "+this.screenHeight+"</div>";e+="</div>";e+='<div class="c64ImportRow"';e+='<div class="c64ImportHeading">Frame Count:</div>';e+="<div>"+t+"</div>";e+="</div>";var i=this.editor.tileSetManager.getCurrentTileSet();if(!i.isPetscii()){e+='<div class="c64ImportRow">';e+="Current tile set will be changed to PETSCII";e+="</div>"}$("#importSEQSettings").html(e);this.importSeq.getScreenData(this.screenData);this.importSeq.getColorData(this.colorData);var r=this.editor.layers.getSelectedLayerObject();if(r&&r.getType()=="grid"){this.bgColor=r.getBackgroundColor()}this.readCharacterBinaryData(romDump.character);this.drawScreen()},doImportSeq:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){alert("Please select a grid layer");return}this.editor.setScreenMode(TextModeEditor.Mode.TEXTMODE);var t={};t.update=false;for(var i=0;i<25;i++){for(var r=0;r<40;r++){var a=r+i*40;var s=this.screenData[a];var o=this.editor.colorPaletteManager.noColor;if(this.extendedBackground){var l=s>>6;o=this.bgColor;if(l==1){o=this.multi1}if(l==2){o=this.multi2}s=s&63}t.x=r;t.y=i;t.t=s;t.fc=this.colorData[a];t.bc=o;e.setCell(t)}}this.editor.graphic.redraw({allCells:true})},loadC:function(e){if(this.importC==null){this.importC=new ImportC;this.importC.init(this.editor)}$("#importC64FormatsFrames").show();$("#importC64FormatsViceSettings").hide();$("#importC64PRGControls").hide();this.screenMode=TextModeEditor.Mode.TEXTMODE;this.previewOffsetX=0;this.previewOffsetY=0;var i=this;var t=new FileReader;t.onload=function(e){var t=i.importC.read(e.target.result);i.frame=0;i.showC()};t.readAsText(e);this.importType="c"},showC:function(){$(".importC64Settings").hide();$("#importPetsciiCSettings").show();var e="";e+='<div class="c64ImportRow">';e+='<div class="c64ImportHeading">Format:</div>';e+="<div>PETSCII C</div>";e+="</div>";this.screenWidth=this.importC.getScreenWidth();this.screenHeight=this.importC.getScreenHeight();var t=this.importC.getFrameCount();e+='<div class="c64ImportRow">';e+='<div class="c64ImportHeading">Screen Size:</div>';e+="<div>"+this.screenWidth+" x "+this.screenHeight+"</div>";e+="</div>";e+='<div class="c64ImportRow">';e+='<div class="c64ImportHeading">Frame Count:</div>';e+="<div>"+t+"</div>";e+="</div>";var i=this.editor.tileSetManager.getCurrentTileSet();if(!i.isPetscii()){e+='<div class="c64ImportRow">';e+="Current tile set will be changed to PETSCII";e+="</div>"}$("#importPetsciiCSettings").html(e);this.showFrames();this.getCScreenData();this.bgColor=this.importC.getBackgroundColor(this.frame);this.borderColor=this.importC.getBorderColor(this.frame);this.readCharacterBinaryData(romDump.character);this.drawScreen()},getCScreenData:function(){this.importC.getScreenData(this.screenData,this.frame,-this.previewOffsetX,-this.previewOffsetY);this.importC.getColorData(this.colorData,this.frame,-this.previewOffsetX,-this.previewOffsetY)},doImportC:function(){this.importC.doImport();return;var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){alert("Please select a grid layer");return}var t=this.importC.getFrameCount();e.setScreenMode(TextModeEditor.Mode.TEXTMODE);this.screenWidth=this.importC.getScreenWidth();this.screenHeight=this.importC.getScreenHeight();var i=1;this.editor.graphic.setGridDimensions({width:this.screenWidth,height:this.screenHeight});var r=this.editor.graphic.getCurrentFrame();for(var a=0;a<t;a++){if(a!=0){var s=this.editor.graphic.insertFrame();this.editor.frames.gotoFrame(s)}this.screenData=[];this.importC.getScreenData(this.screenData,a);this.colorData=[];this.importC.getColorData(this.colorData,a);this.bgColor=this.importC.getBackgroundColor(a);this.borderColor=this.importC.getBorderColor(a);e.setBackgroundColor(this.bgColor);e.setBorderColor(this.borderColor);var o={};o.update=false;for(var l=0;l<this.screenHeight;l++){for(var n=0;n<this.screenWidth;n++){var h=n+l*this.screenWidth;var d=this.screenData[h];var c=this.editor.colorPaletteManager.noColor;if(this.extendedBackground){var f=d>>6;c=this.bgColor;if(f==1){c=this.multi1}if(f==2){c=this.multi2}d=d&63}o.x=n;o.y=l;o.t=d;o.fc=this.colorData[h];o.bc=c;e.setCell(o)}}}var u=e.getTileSet();if(!u.isPetscii()){u.readBinaryData({tileData:romDump.character,characterWidth:8,characterHeight:8});this.editor.tileSetManager.tileSetUpdated({updateBlankCells:false,updateSortMethods:true})}this.editor.frames.gotoFrame(r);this.editor.gridView2d.findViewBounds();this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})},showFrames:function(){var e=this.frame+1;var t=this.importC.getFrameCount();var i="Frame "+e+" of "+t;$("#importC64FormatsFrameInfo").html(i)},changeFrame:function(e){this.frame=this.frame+e;if(this.frame<0){this.frame=0}if(this.frame>=this.importC.getFrameCount()){this.frame=this.importC.getFrameCount()-1}this.showC()},loadPrg:function(e){this.canvas.width=384;this.canvas.height=272;this.context=this.canvas.getContext("2d");$(".importC64Settings").hide();$("#importC64PRGControls").show();$("#importC64FormatsFrames").hide();$("#importC64FormatsViceSettings").hide();$("#importC64Settings").show();var i=this;var r=new FileReader;r.onload=function(e){var t=new Uint8Array(r.result);i.startPRG(t,false)};r.readAsArrayBuffer(e);this.importType="prg"},loadCrt:function(e){this.canvas.width=384;this.canvas.height=272;this.context=this.canvas.getContext("2d");$(".importC64Settings").hide();$("#importC64PRGControls").show();$("#importC64FormatsFrames").hide();$("#importC64FormatsViceSettings").hide();$("#importC64Settings").show();var i=this;var r=new FileReader;r.onload=function(e){var t=new Uint8Array(r.result);i.startCRT(t,false)};r.readAsArrayBuffer(e);this.importType="prg"},startCRT:function(e){if(this.crtData!=null){this.crtData=null;c64_removeCartridge()}c64_loadCRT(e,e.length)},startPRG:function(e,t){var i=e[0]+(e[1]<<8);console.log("load address = "+i.toString(16));var r=i-2+e.length;if(i==2049&&r<53248){t=true}c64_reset();var a=1;a=Math.random()*100;setTimeout(function(){c64_loadPRG(e,e.length,t?1:0);if(t){if(i<1264&&r>1264){}else{c64.insertText("run:\n")}}else{setTimeout(function(){c64.insertText('load "*",8,1\nrun\n')},2e3)}},a)},loadD64:function(e){$(".importC64Settings").hide();$("#importC64PRGControls").show();$("#importC64FormatsFrames").hide();$("#importC64FormatsViceSettings").hide();$("#importC64Settings").show();var i=new FileReader;i.onload=function(e){var t=new Uint8Array(i.result);c64_insertDisk(t,t.length)};i.readAsArrayBuffer(e);var t=e.name;$("#importC64FormatsAttachedDisk").html(t);this.importType="prg"},resetC64:function(){c64_reset();this.importType="prg";document.getElementById("importC64FormatsForm").reset();$("#importC64FormatsAttachedDisk").html("");$(".importC64Settings").hide();$("#importC64PRGControls").show();$("#importC64FormatsFrames").hide();$("#importC64FormatsViceSettings").hide();$("#importC64Settings").show()},setJoystickEnabled:function(e){},setJoystickPort:function(e){var t="";this.joystickPort=e;if(e===0){t+="None"}else{if(e==1){t+="Port 1"}if(e==2){t+="Port 2"}}},c64CommodoreKey:function(){if(this.commodoreKeyDown){this.commodoreKeyDown=false;keyboard.commodoreKeyUp()}else{this.commodoreKeyDown=true;keyboard.commodoreKeyDown()}},c64Paste:function(){this.showPasteTextDialog()},doC64PasteText:function(e){for(var t=0;t<e.length;t++){}},loadCharPad:function(e){this.importType="ctm";if(this.importCharPad==null){this.importCharPad=new ImportCharPad;this.importCharPad.init(this.editor)}$("#importC64PRGControls").hide();$("#importC64FormatsFrames").hide();$("#importC64FormatsViceSettings").hide();this.previewOffsetX=0;this.previewOffsetY=0;var r=this;var t=new FileReader;t.onload=function(e){var t=new Uint8Array(e.target.result);var i=r.importCharPad.readCharPad(t);r.showCharPad()};t.readAsArrayBuffer(e)},doImportCharPad:function(){var e={};e.importC64CharPadCharacters=$("#importC64CharPadCharacters").is(":checked");e.importC64CharPadBlocks=$("#importC64CharPadBlocks").is(":checked");e.importC64CharPadMap=$("#importC64CharPadMap").is(":checked");e.useBlockMode=$("#importC64CharPadBlockMode").is(":checked");e.setColorPerMode=$("#importC64CharPadScreenColorMode").is(":checked");this.importCharPad.doImport(e)},showCharPad:function(){$(".importC64Settings").hide();$("#importC64CharPadSettings").show();var e=this.importCharPad.getTileWidth();var t=this.importCharPad.getTileHeight();var i="";i+='<div class="c64ImportRow">';i+='<div class="c64ImportHeading">Format:</div>';i+="<div>CharPad (Version "+this.importCharPad.getVersion()+")</div>";i+="</div>";i+='<div class="c64ImportRow">';i+='<div class="c64ImportHeading">Characters:</div>';i+="<div>"+this.importCharPad.getTileCount()+"</div>";i+="</div>";i+='<div class="c64ImportRow">';i+='<div class="c64ImportHeading">'+styles.text.blockName+"s:</div>";i+="<div>"+this.importCharPad.getTileCount()+" (CharPad Tiles)</div>";i+="</div>";i+='<div class="c64ImportRow">';i+='<div class="c64ImportHeading">'+styles.text.blockName+" Size:</div>";i+="<div>"+e+" x "+t+"</div>";i+="</div>";this.screenWidth=this.importCharPad.getScreenWidth();this.screenHeight=this.importCharPad.getScreenHeight();var r=this.importCharPad.getMapWidth();var a=this.importCharPad.getMapHeight();i+='<div class="c64ImportRow">';i+='<div class="c64ImportHeading">Map Size:</div>';i+="<div>"+this.screenWidth+" x "+this.screenHeight+" Characters</div>";i+='<div style="margin-top: 2px">'+r+" x "+a+" Blocks</div>";i+="</div>";var s="Colour Per Character";i+='<div class="c64ImportRow">';i+='<div class="c64ImportHeading">Colour Mode:</div>';i+="<div>"+s+"</div>";i+="</div>";$("#importC64CharPadInfo").html(i);$("#importC64CharPadVersion").html("Version: "+this.importCharPad.getVersion());$("#importC64CharPadCharCount").html(this.importCharPad.getTileCount()+" Characters");$("#importC64CharPadBlockSize").html(styles.text.blockName+" Size: "+e+"x"+t);$("#importC64CharPadBlockCount").html(this.importCharPad.getTileCount()+" Blocks (CharPad Tiles)");this.screenWidth=this.importCharPad.getScreenWidth();this.screenHeight=this.importCharPad.getScreenHeight();var r=this.importCharPad.getMapWidth();var a=this.importCharPad.getMapHeight();$("#importC64CharPadMapSize").html("Map Size: "+this.screenWidth+"x"+this.screenHeight+" Characters, "+r+"x"+a+" Blocks");this.screenMode=TextModeEditor.Mode.TEXTMODE;if(this.importCharPad.getMulticolorMode()){this.screenMode=TextModeEditor.Mode.C64MULTICOLOR}this.colorData=[];this.screenData=[];for(var o=0;o<1e3;o++){this.screenData[o]=32;this.colorData[o]=14}this.importCharPad.getScreenData(this.screenData);this.bgColor=this.importCharPad.getBackgroundColor();this.multi1=this.importCharPad.getC64Multi1Color();this.multi2=this.importCharPad.getC64Multi2Color();var l=[];var l=this.importCharPad.getCharData();this.readCharacterBinaryData(l);var n=40;var h=25;for(var o=0;o<1e3;o++){var d=o%n;var c=Math.floor(o/n);if(d<this.screenWidth&&c<this.screenHeight){this.colorData[o]=this.importCharPad.getColorAt(d,c)}}this.bgColor=this.importCharPad.getBackgroundColor();this.drawScreen()},getCharPadScreenData:function(){var e=40;var t=25;this.importCharPad.getScreenData(this.screenData,false,-this.previewOffsetX,-this.previewOffsetY);for(var i=0;i<1e3;i++){var r=i%e-this.previewOffsetX;var a=Math.floor(i/e)-this.previewOffsetY;if(r<this.screenWidth&&a<this.screenHeight){this.colorData[i]=this.importCharPad.getColorAt(r,a)}}},loadVsf:function(e){this.importType="vsf";$("#importC64PRGControls").hide();$(".importC64Settings").hide();$("#importC64FormatsViceSettings").show();$("#importC64FormatsFrames").hide();if(this.viceSnapshotReader==null){this.viceSnapshotReader=new ViceSnapshotReader;this.viceSnapshotReader.init(this.editor)}this.previewOffsetX=0;this.previewOffsetY=0;this.screenWidth=40;this.screenHeight=25;var r=this;var t=new FileReader;t.onload=function(e){var t=new Uint8Array(e.target.result);var i=r.viceSnapshotReader.readSnapshot(t);r.showVsf()};t.readAsArrayBuffer(e)},showVsf:function(){this.screenMode=TextModeEditor.Mode.TEXTMODE;if(this.viceSnapshotReader.getMulticolorMode()){this.screenMode=TextModeEditor.Mode.C64MULTICOLOR}this.viceSnapshotReader.getScreenData(this.screenData);this.viceSnapshotReader.getColorData(this.colorData);this.bgColor=this.viceSnapshotReader.getBackgroundColor();this.borderColor=this.viceSnapshotReader.getBorderColor();this.multi1=this.viceSnapshotReader.getExtraBackgroundColor1();this.multi2=this.viceSnapshotReader.getExtraBackgroundColor2();var e=[];this.viceSnapshotReader.getCharacterData(e);this.readCharacterBinaryData(e);this.drawScreen();var t="";t+='<div class="c64ImportRow">';t+='<div class="c64ImportHeading">Format:</div>';t+="<div>VICE Snapshot (Version "+this.viceSnapshotReader.getVersion()+")</div>";t+="</div>";$("#importC64ViceInfo").html(t)},importVsf:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){alert("Please choose a grid layer");return}var t=this.editor.grid;var i=t.getXYGridPosition();this.screenWidth=40;this.screenHeight=25;var r=1;this.editor.graphic.setGridDimensions({width:this.screenWidth,height:this.screenHeight});this.bgColor=this.viceSnapshotReader.getBackgroundColor();this.borderColor=this.viceSnapshotReader.getBorderColor();e.setBackgroundColor(this.bgColor);e.setBorderColor(this.borderColor);if(this.screenMode===TextModeEditor.Mode.C64MULTICOLOR){e.setC64Multi1Color(this.multi1);e.setC64Multi2Color(this.multi2);e.setScreenMode(TextModeEditor.Mode.C64MULTICOLOR)}else{e.setScreenMode(TextModeEditor.Mode.TEXTMODE)}this.editor.setColorPerMode("cell");var a=e.getTileSet();a.readCharData({tileData:this.tileData,characterWidth:8,characterHeight:8});a.setLabel(this.filename);this.editor.tileSetManager.tileSetUpdated({updateBlankCells:false,updateSortMethods:true});var s={};s.update=false;for(var o=0;o<25;o++){for(var l=0;l<40;l++){var n=l+o*40;var h=this.screenData[n];var d=this.editor.colorPaletteManager.noColor;if(this.extendedBackground){var c=h>>6;d=this.bgColor;if(c==1){d=this.multi1}if(c==2){d=this.multi2}h=h&63}s.x=l;s.y=o;s.t=h;s.fc=this.colorData[n];s.bc=d;e.setCell(s)}}this.editor.gridView2d.findViewBounds();this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})},setImportFile:function(e){this.filename=e.name;var t="";var i=this.filename.lastIndexOf(".");if(i!=-1){t=this.filename.split(".").pop().toLowerCase();this.filename=this.filename.substring(0,i)}switch(t){case"prg":this.loadPrg(e);break;case"crt":this.loadCrt(e);break;case"d64":this.loadD64(e);break;case"vsf":this.loadVsf(e);break;case"c":this.loadC(e);break;case"seq":this.loadSeq(e);break;case"ctm":this.loadCharPad(e);break}},showC64:function(){c64_reset();this.canvas.width=384;this.canvas.height=272;this.context=this.canvas.getContext("2d");$("#importC64FormatsFrames").hide();$("#importC64FormatsViceSettings").hide();this.importType="prg"},importPrg:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){alert("Please select a grid layer");return}var t=(c64_cpuReadNS(53272)&14)<<10;var i=(c64_cpuReadNS(53272)&240)<<6;var r=(c64_cpuReadNS(53265)&64)>0;var a=(c64_cpuReadNS(53270)&16)>0;var s=[];var o=[];var l=[];for(var n=0;n<1e3;n++){s[n]=c64_vicRead(i+n);o[n]=c64_cpuRead(55296+n)&15}for(var n=0;n<2e3;n++){l[n]=c64_vicRead(t+n)}this.screenWidth=40;this.screenHeight=25;var h=1;this.editor.graphic.setGridDimensions({width:this.screenWidth,height:this.screenHeight});var d=c64_vicReadRegister(33)&15;var c=c64_vicReadRegister(32)&15;var f=c64_vicReadRegister(34)&15;var u=c64_vicReadRegister(35)&15;e.setBackgroundColor(d);e.setBorderColor(c);if(a){e.setC64Multi1Color(f);e.setC64Multi2Color(u);e.setScreenMode(TextModeEditor.Mode.C64MULTICOLOR)}else{e.setScreenMode(TextModeEditor.Mode.TEXTMODE)}var p=e.getTileSet();p.readBinaryData({tileData:l,characterWidth:8,characterHeight:8});this.editor.tileSetManager.tileSetUpdated({updateBlankCells:false,updateSortMethods:true});var v={};v.update=false;for(var g=0;g<25;g++){for(var m=0;m<40;m++){var y=m+g*40;var b=s[y];var C=this.editor.colorPaletteManager.noColor;if(r){var x=b>>6;C=c64_vicReadRegister(33+x)&15;b=b&63}v.x=m;v.y=g;v.t=b;v.fc=o[y];v.bc=C;e.setCell(v)}}this.editor.graphic.redraw({allCells:true})},readCharacterBinaryData:function(e){var t=8;var i=8;this.tileData=[];for(var r=0;r<e.length;r++){this.tileData[r]=[];for(var a=0;a<t*i;a++){this.tileData[r][a]=0}var s=r*t;var o=1;var l=0;for(var n=0;n<i;n++){for(var h=0;h<t;h++){var d=h+n*t;var c=s+n;var f=h;var u=e[c];var p=0;if(u&1<<7-f){this.tileData[r][d]=o}else{this.tileData[r][d]=l}}}}},doImport:function(){if(this.importType=="prg"){this.importPrg()}if(this.importType=="c"){this.doImportC()}if(this.importType=="vsf"){this.importVsf()}if(this.importType=="seq"){this.doImportSeq()}if(this.importType=="ctm"){this.doImportCharPad()}},keyDown:function(e){if(this.importType=="prg"){if(this.joystickPort!=0){var t=this.joystickPort-1;e.preventDefault();var i=e.key.toLowerCase();switch(i){case"arrowdown":c64_joystickPush(t,C64_JOYSTICK_DOWN);return;break;case"arrowup":c64_joystickPush(t,C64_JOYSTICK_UP);return;break;case"arrowleft":c64_joystickPush(t,C64_JOYSTICK_LEFT);return;break;case"arrowright":c64_joystickPush(t,C64_JOYSTICK_RIGHT);return;break;case"z":c64_joystickPush(t,C64_JOYSTICK_FIRE);return;break}}c64_keydown(e)}},keyUp:function(e){if(this.importType=="prg"){if(this.joystickPort!=0){var t=this.joystickPort-1;e.preventDefault();var i=e.key.toLowerCase();switch(i){case"arrowdown":c64_joystickRelease(t,C64_JOYSTICK_DOWN);return;break;case"arrowup":c64_joystickRelease(t,C64_JOYSTICK_UP);return;break;case"arrowleft":c64_joystickRelease(t,C64_JOYSTICK_LEFT);return;break;case"arrowright":c64_joystickRelease(t,C64_JOYSTICK_RIGHT);return;break;case"z":c64_joystickRelease(t,C64_JOYSTICK_FIRE);return;break}}c64_keyup(e)}},keyPress:function(e){},c64UpdateDriveLight:function(){var e=c1541_getStatus();if(e!==this.lastDriveStatus){switch(e){case 2:$("#importC64FormatsDriveLight").css("background-color","#00ff00");break;case 1:$("#importC64FormatsDriveLight").css("background-color","#ff0000");break;case 0:$("#importC64FormatsDriveLight").css("background-color","#333333");break}this.lastDriveStatus=e}var t=c1541_getPosition();if(t!==this.lastDrivePosition){$("#importC64FormatsDrivePosition").html(t);this.lastDrivePosition=t}},c64Redraw:function(){var e=c64_getPixelBuffer();var t=384*272*4;var i=new Uint8Array(c64.HEAPU8.subarray(e,e+t));var r=this.c64ImageData.data;r.set(i);this.context.putImageData(this.c64ImageData,0,0)},update:function(){if(this.importType=="prg"){if(c64_ready){var e=getTimestamp();var t=e-this.lastUpdate;this.lastUpdate=e;if(c64.pastingText){c64.processPasteText()}if(debugger_update(t)){this.c64Redraw();this.c64UpdateDriveLight()}}}}};var ImportC64SpriteFormats=function(){this.editor=null;this.visible=false;this.importType=false;this.canvas=null;this.context=null;this.c64ImageData=null;this.spriteCanvas=null;this.spriteContext=null;this.spriteFrames=[];this.lastTime=0;this.sprMulticolor=true;this.c64Focus=true;this.joystickPort=0};ImportC64SpriteFormats.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"importC64SpriteFormatsDialog",title:"Import",width:615,height:500});this.uiComponent.on("keydown",function(e){t.keyDown(e)});this.uiComponent.on("keyup",function(e){t.keyUp(e)});this.uiComponent.on("keypress",function(e){t.keyPress(e)});this.uiComponent.on("close",function(){t.visible=false});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/importC64SpriteFormats.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"Import",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.doImport();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI("importC64SpriteFormatsDialog").setWidth(615);UI("importC64SpriteFormatsDialog").setHeight(490);UI.showDialog("importC64SpriteFormatsDialog");this.visible=true},initContent:function(){if(this.canvas==null){this.canvas=document.getElementById("importC64SpriteFormatsPreview");this.canvas.width=384;this.canvas.height=272;this.context=this.canvas.getContext("2d");this.c64ImageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height)}if(this.spriteCanvas==null){this.spriteCanvas=document.createElement("canvas");this.setSpriteDimensions(24,21)}this.showC64();var e=parseInt($("input[name=importC64SpriteJoystickPort]:checked").val(),10);this.setJoystickPort(e)},setSpriteDimensions:function(e,t){this.spriteCanvas.width=e;this.spriteCanvas.height=t;this.spriteContext=this.spriteCanvas.getContext("2d")},drawSprite:function(e){var t=this.editor.colorPaletteManager.getCurrentColorPalette();var i=e.spriteData;var r=e.multicolor;var a=e.x;var s=e.y;var o=0;var l=e.multi1;var n=e.multi2;var h=e.color;var d=[];d.push(t.getColor(o));d.push(t.getColor(l));d.push(t.getColor(h));d.push(t.getColor(n));var c=this.spriteCanvas.width;var f=this.spriteCanvas.height;this.spriteContext.clearRect(0,0,c,f);this.spriteImageData=this.spriteContext.getImageData(0,0,c,f);var u=this.spriteImageData;var p=0;for(var v=0;v<f;v++){for(var g=0;g<c;g++){var m=i[p++];for(var y=7;y>=0;y--){var b=(g+v*u.width)*4;var C=m>>>y&1;if(r){var x=0;if(C){x+=2}y--;var S=m>>>y&1;if(S){x+=1}var P=d[x];if(x){u.data[b]=P.r*255;u.data[b+1]=P.g*255;u.data[b+2]=P.b*255;u.data[b+3]=255;u.data[b+4]=P.r*255;u.data[b+5]=P.g*255;u.data[b+6]=P.b*255;u.data[b+7]=255}else{u.data[b]=0;u.data[b+1]=0;u.data[b+2]=0;u.data[b+3]=0;u.data[b+4]=0;u.data[b+5]=0;u.data[b+6]=0;u.data[b+7]=0}g+=2}else{var P=d[0];if(C){P=d[2];u.data[b]=P.r*255;u.data[b+1]=P.g*255;u.data[b+2]=P.b*255;u.data[b+3]=255}else{u.data[b]=0;u.data[b+1]=0;u.data[b+2]=0;u.data[b+3]=0}g++}}g--}}this.spriteContext.putImageData(u,0,0);this.context.drawImage(this.spriteCanvas,a,s)},doImport:function(){if(this.importType=="spritepad"){this.importSpritePad.doImport()}if(this.importType=="spr"){this.importSPR.doImport({multicolor:this.sprMulticolor})}if(this.importType=="prg"){this.importPRGSprites()}},initEvents:function(){var i=this;$("#importC64SpriteFormatsChooseFile").on("click",function(){$("#importC64SpriteFormatsSourceFile").click()});document.getElementById("importC64SpriteFormatsSourceFile").addEventListener("change",function(e){var t=document.getElementById("importC64SpriteFormatsSourceFile").files[0];i.setImportFile(t)});$("#importC64SpritePRGReset").on("click",function(e){i.resetC64()});$("#importC64SpritePRGPaste").on("click",function(e){i.c64Paste()});$("#importC64SpritePRGCMDKey").on("click",function(e){i.c64CommodoreKey()});$("input[name=importC64SpriteJoystickPort]").on("click",function(e){var t=parseInt($("input[name=importC64SpriteJoystickPort]:checked").val(),10);i.setJoystickPort(t)});$("#importC64SpriteViewSprites").on("click",function(){i.viewPRGSprites()});$("#importC64SpriteBackToC64").on("click",function(){i.backToC64()});$("#importC64SpriteBank").on("change",function(){var e=parseInt($(this).val());i.setC64VICBank(e)});$("#importC64SpritesFromAddress").on("keyup",function(){var e=parseInt($(this).val(),16);if(!isNaN(e)){i.setC64ViewSpritesFrom(e)}});$("#importC64SpriteSPRMulticolor").on("click",function(){i.setSPRMulticolor($(this).is(":checked"))});$("#importC64SpritesFromAddress").on("focus",function(){i.c64Focus=false});$("#importC64SpritesFromAddress").on("blur",function(){i.c64Focus=true})},setImportFile:function(e){this.filename=e.name;var t="";var i=this.filename.lastIndexOf(".");if(i!=-1){t=this.filename.split(".").pop().toLowerCase();this.filename=this.filename.substring(0,i)}switch(t){case"prg":this.loadPrg(e);break;case"d64":this.loadD64(e);break;case"spd":this.loadSpritePad(e);break;case"spr":this.loadSPR(e);break}},loadSpritePad:function(e){if(this.importSpritePad==null){this.importSpritePad=new ImportSpritePad;this.importSpritePad.init(this.editor)}this.importType="spritepad";$(".importC64SpriteSettings").hide();$("#importC64SpriteSpritePadControls").show();var a=this;var t=new FileReader;t.onload=function(e){var t=new Uint8Array(e.target.result);a.importSpritePad.readSpritePad(t);a.context.clearRect(0,0,a.canvas.width,a.canvas.height);var i=a.importSpritePad.getAnimations();a.spriteFrames=[];for(var r=0;r<i.length;r++){a.spriteFrames.push({frame:i[r].start,count:0})}a.drawSpritePad()};t.readAsArrayBuffer(e)},drawSpritePad:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();var t=this.importSpritePad.getBackgroundColor();this.context.fillStyle="#"+e.getHexString(t);this.context.fillRect(0,0,this.canvas.width,this.canvas.height);var i=false;if(!i){var r=this.importSpritePad.getSprites();var a=0;for(var s=0;s<r.length;s++){var o=r[s];var l=this.importSpritePad.getMulti1();var n=this.importSpritePad.getMulti2();var h=34;var d=Math.floor(this.canvas.width/h);var c=a%d*34;var f=Math.floor(a/d)*31;if(o.overlay!=1){a++}this.drawSprite({x:c,y:f,multi1:l,multi2:n,spriteData:o.spriteData,multicolor:o.multi==1,color:o.color})}}else{var u=this.importSpritePad.getAnimations();for(var s=0;s<u.length;s++){var p=this.spriteFrames[s].frame;this.spriteFrames[s].count++;if(this.spriteFrames[s].count>u[s].timer){this.spriteFrames[s].count=0;this.spriteFrames[s].frame++;if(this.spriteFrames[s].frame>=u[s].end){this.spriteFrames[s].frame=u[s].start}}var o=this.importSpritePad.getSprite(p);var l=this.importSpritePad.getMulti1();var n=this.importSpritePad.getMulti2();var h=34;var d=Math.floor(this.canvas.width/h);var c=s%d*34;var f=Math.floor(s/d)*31;this.drawSprite({x:c,y:f,multi1:l,multi2:n,spriteData:o.spriteData,multicolor:o.multi==1,color:o.color})}}},loadSPR:function(e){if(this.importSPR==null){this.importSPR=new ImportSPR;this.importSPR.init(this.editor)}this.importType="spr";var i=this;var t=new FileReader;t.onload=function(e){var t=new Uint8Array(e.target.result);i.importSPR.readSPR(t);i.context.clearRect(0,0,i.canvas.width,i.canvas.height);$(".importC64SpriteSettings").hide();$("#importC64SpriteSPRControls").show()};t.readAsArrayBuffer(e)},setSPRMulticolor:function(e){this.sprMulticolor=e},drawSpr:function(){var e="#cccccc";this.context.fillStyle="#"+colorPalette.getHexString(e);this.context.fillRect(0,0,this.canvas.width,this.canvas.height);var t=this.importSPR.getSprites();for(var i=0;i<t.length;i++){var r=t[i];var a=1;var s=this.sprMulticolor;var o=2;var l=3;var n=34;var h=Math.floor(this.canvas.width/n);var d=i%h*34;var c=Math.floor(i/h)*31;this.drawSprite({x:d,y:c,multi1:o,multi2:l,spriteData:r.spriteData,multicolor:s,color:r.color})}},loadPrg:function(e){this.canvas.width=384;this.canvas.height=272;this.context=this.canvas.getContext("2d");$(".importC64SpriteSettings").hide();$("#importC64SpritePRGControls").show();var i=new FileReader;i.onload=function(e){var t=new Uint8Array(i.result);c64_reset();c64_loadPRG(t,t.length,false)};i.readAsArrayBuffer(e);this.importType="prg"},loadD64:function(e){$(".importC64SpriteSettings").hide();$("#importC64SpritePRGControls").show();$("#importC64SpriteD64Controls").show();var i=new FileReader;i.onload=function(e){var t=new Uint8Array(i.result);c64_insertDisk(t,t.length)};i.readAsArrayBuffer(e);var t=e.name;$("#importC64SpriteFormatsAttachedDisk").html(t);this.importType="prg"},resetC64:function(){c64_reset();this.importType="prg";document.getElementById("importC64SpriteFormatsForm").reset();$(".importC64SpriteSettings").hide();$("#importC64SpritePRGControls").show()},setJoystickPort:function(e){var t="";this.joystickPort=e;if(e===0){t+="None"}else{if(e==1){t+="Port 1"}if(e==2){t+="Port 2"}}},viewPRGSprites:function(){debugger_pause();var e=c64_cpuRead(56576)&3;this.setC64VICBank(e);var t=this.vicBankAddress+((c64_cpuRead(53272)&240)>>4)*1024;var i=c64_cpuRead(t+1016);this.viewC64VICFrom=this.vicBankAddress+i*64;$("#importC64SpritesFromAddress").val(this.viewC64VICFrom.toString(16));this.sprMulticolor=true;this.multiColor1=c64_cpuRead(53285)&15;this.multiColor2=c64_cpuRead(53286)&15;this.color=c64_cpuRead(53287)&15;this.setC64ViewSpritesFrom(this.viewC64VICFrom);$("#importC64SpriteC64Controls").hide();$("#importC64SpriteSpriteControls").show()},drawC64Sprites:function(){var e="#cccccc";this.context.fillStyle="#"+colorPalette.getHexString(e);this.context.fillRect(0,0,this.canvas.width,this.canvas.height);var t=this.viewC64VICFrom;var i=84;var r=[];try{for(var a=0;a<i;a++){var s=[];for(var o=0;o<63;o++){s.push(c64_cpuRead(t++))}var l=c64_cpuRead(t++);r.push({spriteData:s,color:this.color})}}catch(e){console.log(e)}this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(var a=0;a<r.length;a++){var n=r[a];var h=this.sprMulticolor;var d=34;var c=Math.floor(this.canvas.width/d);var f=a%c*34;var u=Math.floor(a/c)*31;this.drawSprite({x:f,y:u,multi1:this.multiColor1,multi2:this.multiColor2,spriteData:n.spriteData,multicolor:h,color:n.color})}this.sprites=r},importPRGSprites:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){alert("Please choose a grid layer");return}var t=this.editor.graphic;t.setDrawEnabled(false);this.editor.history.setEnabled(false);this.viewPRGSprites();var i=e.getTileSet();var r=0;var a=0;if(this.sprMulticolor){e.setScreenMode(TextModeEditor.Mode.C64MULTICOLOR)}else{e.setScreenMode(TextModeEditor.Mode.TEXTMODE)}e.setCreateSpriteTiles(false);e.setBlankTileId(0);e.setC64Multi1Color(this.multiColor1);e.setC64Multi2Color(this.multiColor2);for(var s=0;s<this.sprites.length;s++){var o=this.sprites[s].spriteData;var l=i.createTile();var n=this.sprites[s].color;var h=[];for(var d=0;d<o.length;d++){var c=o[d];for(var f=7;f>=0;f--){var u=c>>>f&1;h.push(u)}}i.setTileData(l,h);if(s!==0){var p=t.insertFrame();t.setCurrentFrame(p)}var v={};v.update=false;v.x=r;v.y=a;v.t=l;v.fc=n;v.bc=this.editor.colorPaletteManager.noColor;e.setCell(v)}e.setCreateSpriteTiles(true);this.editor.history.setEnabled(true);t.setDrawEnabled(true);this.editor.spriteFrames.draw({framesChanged:true});this.editor.frames.gotoFrame(0);this.editor.graphic.redraw()},backToC64:function(){$("#importC64SpriteC64Controls").show();$("#importC64SpriteSpriteControls").hide();debugger_play()},setC64ViewSpritesFrom:function(e){this.viewC64VICFrom=e;this.drawC64Sprites()},setC64VICBank:function(e){this.c64VICBank=e;switch(this.c64VICBank){case 3:this.vicBankAddress=0;break;case 2:this.vicBankAddress=16384;break;case 1:this.vicBankAddress=32768;break;case 0:this.vicBankAddress=49152;break}this.drawC64Sprites()},c64CommodoreKey:function(){if(this.commodoreKeyDown){this.commodoreKeyDown=false;keyboard.commodoreKeyUp()}else{this.commodoreKeyDown=true;keyboard.commodoreKeyDown()}},showC64:function(){this.canvas.width=384;this.canvas.height=272;this.context=this.canvas.getContext("2d");this.importType="prg";$(".importC64SpriteSettings").hide();$("#importC64SpritePRGControls").show()},keyDown:function(e){if(this.importType=="prg"&&this.c64Focus){if(this.joystickPort!=0){var t=this.joystickPort-1;e.preventDefault();var i=e.key.toLowerCase();switch(i){case"arrowdown":c64_joystickPush(t,C64_JOYSTICK_DOWN);return;break;case"arrowup":c64_joystickPush(t,C64_JOYSTICK_UP);return;break;case"arrowleft":c64_joystickPush(t,C64_JOYSTICK_LEFT);return;break;case"arrowright":c64_joystickPush(t,C64_JOYSTICK_RIGHT);return;break;case"z":c64_joystickPush(t,C64_JOYSTICK_FIRE);return;break}}c64_keydown(e)}},keyUp:function(e){if(this.importType=="prg"&&this.c64Focus){if(this.joystickPort!=0){var t=this.joystickPort-1;e.preventDefault();var i=e.key.toLowerCase();switch(i){case"arrowdown":c64_joystickRelease(t,C64_JOYSTICK_DOWN);return;break;case"arrowup":c64_joystickRelease(t,C64_JOYSTICK_UP);return;break;case"arrowleft":c64_joystickRelease(t,C64_JOYSTICK_LEFT);return;break;case"arrowright":c64_joystickRelease(t,C64_JOYSTICK_RIGHT);return;break;case"z":c64_joystickRelease(t,C64_JOYSTICK_FIRE);return;break}}c64_keyup(e)}},keyPress:function(e){},c64UpdateDriveLight:function(){var e=c1541_getStatus();if(e!==this.lastDriveStatus){switch(e){case 2:$("#importC64SpriteFormatsDriveLight").css("background-color","#00ff00");break;case 1:$("#importC64SpriteFormatsDriveLight").css("background-color","#ff0000");break;case 0:$("#importC64SpriteFormatsDriveLight").css("background-color","#333333");break}this.lastDriveStatus=e}var t=c1541_getPosition();if(t!==this.lastDrivePosition){$("#importC64SpriteFormatsDrivePosition").html(t);this.lastDrivePosition=t}},c64Redraw:function(){var e=c64_getPixelBuffer();var t=384*272*4;var i=new Uint8Array(c64.HEAPU8.subarray(e,e+t));var r=this.c64ImageData.data;r.set(i);this.context.putImageData(this.c64ImageData,0,0)},update:function(){if(this.importType=="spritepad"){var e=getTimestamp();var t=e-this.lastTime;if(t>1e3/50){this.lastTime=e;this.drawSpritePad()}}if(this.importType=="spr"){var e=getTimestamp();var t=e-this.lastTime;if(t>1e3/50){this.lastTime=e;this.drawSpr()}}if(this.importType=="prg"){if(c64_ready){var e=getTimestamp();var i=e-this.lastUpdate;this.lastUpdate=e;if(debugger_isRunning()){if(debugger_update(i)){this.c64Redraw();this.c64UpdateDriveLight()}}}}}};var ImportSpriteImage=function(){this.editor=null;this.visible=false;this.loadImage=null;this.loadImageCanvas=null;this.canvasComponent=null;this.canvasScale=5;this.spritePreview=null;this.spritePreviewIndex=0;this.importCanvas=null;this.importContext=null;this.spriteSource=null;this.spriteCount=1;this.spritesAcross=10;this.spritesDown=1;this.spriteWidth=24;this.spriteHeight=21;this.spriteXOffset=0;this.spriteYOffset=0;this.spriteMarginRight=0;this.spriteMarginBottom=0;this.spriteRects=[];this.rectWidth=24;this.rectHeight=21;this.resizeSource=1};ImportSpriteImage.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"importSpriteImageDialog",title:"Import",width:615,height:500});var e=UI.create("UI.SplitPanel",{});this.uiComponent.add(e);var i='    <div class="formGroup">';i+='<div style="margin-bottom: 6px">';i+=" Choose an image file (.png, .jpg, .gif) containing a sprites";i+=" </div>";i+='<div class="ui-button ui-button-nextaction" id="importSpriteChooseFile">Choose...</div>';i+='<input type="file" id="importSpriteFile" style="position: absolute; top: -50px; left: -100px"/>';i+="</div>";var r=UI.create("UI.HTMLPanel",{html:i});e.addNorth(r,50,false);var i="";i+='<div id="importSpriteControls">';i+="Sprites:";i+='<input type="text" size="2" class="number importSpriteParam" data-param="count" min="1" max="200" value="1" id="importSprite-count">';i+="Reize Source:";i+='<select id="importSprite-resize">';i+='<option value="100">100%</option>';i+='<option value="50">50%</option>';i+='<option value="25">25%</option>';i+="</select>";i+="X Offset:";i+='<input type="text" size="2" class="number importSpriteParam" min="0" max="200" data-param="xoffset" value="0" id="importSprite-xoffset">';i+="Y Offset:";i+='<input type="text" size="2" class="number importSpriteParam" min="0" max="200" data-param="yoffset"  value="0" id="importSprite-yoffset">';i+="Margin Right:";i+='<input type="text" size="2" class="number importSpriteParam" min="0" max="200" data-param="margin-right" value="0" id="importSprite-margin-right">';i+="Margin Bottom:";i+='<input type="text" size="2" class="number importSpriteParam" min="0" max="200" data-param="margin-bottom"  value="0" id="importSprite-margin-bottom">';i+="Rect Width:";i+='<input type="text" size="2" class="number importSpriteParam" min="1" max="200" data-param="rect-width" value="24" id="importSprite-rect-width">';i+="Rect Height:";i+='<input type="text" size="2" class="number importSpriteParam" min="1" max="200" data-param="rect-height"  value="21" id="importSprite-rect-height">';i+="</div>";var a=UI.create("UI.HTMLPanel",{html:i});e.addSouth(a,40,false);i="<div>";i+='<canvas id="importSpritePreview" style="border: 1px solid #333333"></canvas>';i+="<div>";i+='  <div class="ui-button" id="importSpritePreviewPrev">&lt;</div>';i+="  &nbsp";i+='  <div class="ui-button" id="importSpritePreviewNext">&gt;</div>';i+="</div>";i+="</div>";var s=UI.create("UI.HTMLPanel",{html:i});e.addWest(s,200,false);this.canvasComponent=UI.create("UI.CanvasScrollPanel");var t=this;this.canvasComponent.draw=function(e){t.draw(e)};e.add(this.canvasComponent);this.initContent();this.initEvents();this.okButton=UI.create("UI.Button",{text:"Import",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.doImport();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI("importSpriteImageDialog").setWidth(615);UI("importSpriteImageDialog").setHeight(490);UI.showDialog("importSpriteImageDialog");this.resize();this.visible=true},initContent:function(){if(this.canvas==null){this.canvasComponent.resize();this.canvas=this.canvasComponent.getCanvas()}if(this.loadImageCanvas==null){this.loadImageCanvas=document.createElement("canvas")}if(this.spritePreview==null){this.spritePreview=document.getElementById("importSpritePreview");this.spritePreview.width=24*8;this.spritePreview.height=21*8;this.spritePreviewContext=this.spritePreview.getContext("2d");this.spritePreviewContext.imageSmoothingEnabled=false;this.spritePreviewContext.webkitImageSmoothingEnabled=false;this.spritePreviewContext.mozImageSmoothingEnabled=false;this.spritePreviewContext.msImageSmoothingEnabled=false;this.spritePreviewContext.oImageSmoothingEnabled=false}this.setCanvasSize()},setCanvasSize:function(){return;this.canvas.width=200;this.canvas.height=200;this.context=this.canvas.getContext("2d")},initEvents:function(){var r=this;this.spriteCount=parseInt($("#importSprite-count").val(),10);this.spriteXOffset=parseInt($("#importSprite-xoffset").val(),10);this.spriteYOffset=parseInt($("#importSprite-yoffset").val(),10);this.spriteMarginRight=parseInt($("#importSprite-margin-right").val(),10);this.spriteMarginBottom=parseInt($("#importSprite-margin-bottom").val(),10);this.rectWidth=parseInt($("#importSprite-rect-width").val(),10);this.rectHeight=parseInt($("#importSprite-rect-height").val(),10);$("#importSpriteChooseFile").on("click",function(){$("#importSpriteFile").click()});document.getElementById("importSpriteFile").addEventListener("change",function(e){var t=document.getElementById("importSpriteFile").files[0];r.chooseImportSpriteFile(t)});this.uiComponent.on("resize",function(){r.resize()});UI.number.initControls("#importSpriteControls .number");$(".importSpriteParam").on("keyup",function(e){var t=parseInt($(this).val(),10);var i=$(this).attr("data-param");if(!isNaN(t)){r.setParam(i,t)}});$(".importSpriteParam").on("change",function(e){var t=parseInt($(this).val(),10);var i=$(this).attr("data-param");if(!isNaN(t)){r.setParam(i,t)}});$("#importSpritePreviewPrev").on("click",function(e){var t=r.spritePreviewIndex-1;if(t>=0){r.setSpritePreviewIndex(t)}});$("#importSpritePreviewNext").on("click",function(e){var t=r.spritePreviewIndex+1;if(t<r.spriteCount){r.setSpritePreviewIndex(t)}});$("#importSprite-resize").on("change",function(e){var t=parseInt($(this).val(),10);r.setResizeSource(t)})},setSpritePreviewIndex:function(e){this.spritePreviewIndex=e;this.drawSpritePreview()},setParam:function(e,t){switch(e){case"count":this.setSpriteCount(t);break;case"xoffset":this.setSpriteXOffset(t);break;case"yoffset":this.setSpriteYOffset(t);break;case"margin-right":this.setSpriteMarginRight(t);break;case"margin-bottom":this.setSpriteMarginBottom(t);break;case"rect-width":this.setRectWidth(t);break;case"rect-height":this.setRectHeight(t);break}},setResizeSource:function(e){this.resizeSource=e/100;this.draw(this.context)},setSpriteCount:function(e){this.spriteCount=e;if(this.spritePreviewIndex>=this.spriteCount){this.spritePreviewIndex=this.spriteCount-1}this.setSpriteRects();this.draw(this.context)},setSpriteXOffset:function(e){this.spriteXOffset=e;this.setSpriteRects();this.draw(this.context)},setSpriteYOffset:function(e){this.spriteYOffset=e;this.setSpriteRects();this.draw(this.context)},setSpriteMarginRight:function(e){this.spriteMarginRight=e;this.setSpriteRects();this.draw(this.context)},setSpriteMarginBottom:function(e){this.spriteMarginBottom=e;this.setSpriteRects();this.draw(this.context)},setRectWidth:function(e){this.rectWidth=e;this.setSpriteRects();this.draw(this.context)},setRectHeight:function(e){this.rectHeight=e;this.setSpriteRects();this.draw(this.context)},resize:function(){console.log("resize");this.canvasComponent.resize();this.context=this.canvasComponent.getContext();this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;this.draw()},drawSpriteImageCanvas:function(){},chooseImportSpriteFile:function(e){if(typeof e=="undefined"){return}var i=this;var t=e.name;var r=t.lastIndexOf(".");var a=t.split(".").pop().toLowerCase();var s=false;switch(a){case"png":case"gif":case"jpg":case"jpeg":s="image";break}if(s===false){return}this.loadFormat=s;if(this.loadFormat=="image"){if(!this.loadImage){this.loadImage=new Image}var o=window.URL||window.webkitURL;var l=o.createObjectURL(e);this.loadImage.onload=function(){var e=i.loadImage.naturalWidth;var t=i.loadImage.naturalHeight;i.loadImageCanvas.width=e;i.loadImageCanvas.height=t;i.loadImageContext=i.loadImageCanvas.getContext("2d");i.loadImageContext.drawImage(i.loadImage,0,0);i.loadImageData=i.loadImageContext.getImageData(0,0,e,t);i.setSpriteSource();i.draw(this.context)};this.loadImage.src=l}},setSpriteSource:function(){console.log("set sprite source");if(this.spriteSource==null){this.spriteSource=document.createElement("canvas")}this.spriteSource.width=this.loadImageCanvas.width;this.spriteSource.height=this.loadImageCanvas.height;this.spriteSourceContext=this.spriteSource.getContext("2d");this.spriteSourceContext.drawImage(this.loadImageCanvas,0,0);this.setSpriteRects()},setSpriteRects:function(){this.spriteRects=[];var e=0;var t=10;var i=this.spriteMarginRight;var r=this.spriteMarginBottom;for(var a=0;a<this.spriteCount;a++){e=this.spriteXOffset+a*(this.rectWidth+i);t=this.spriteYOffset;this.spriteRects.push({x:e,y:t,width:this.rectWidth,height:this.rectHeight})}},drawSpriteRects:function(){var e=this.context;e.beginPath();e.strokeStyle="#00ff00";for(var t=0;t<this.spriteRects.length;t++){e.rect(this.spriteRects[t].x*this.canvasScale+.5,this.spriteRects[t].y*this.canvasScale+.5,this.spriteRects[t].width*this.canvasScale,this.spriteRects[t].height*this.canvasScale)}e.stroke()},draw:function(e){if(this.loadImageCanvas){this.context.fillStyle="#111111";this.context.fillRect(0,0,this.canvas.width,this.canvas.height);if(this.spriteSource){this.previewCanvasScale=1;this.context.save();this.context.scale(this.canvasScale*this.resizeSource*this.previewCanvasScale,this.canvasScale*this.resizeSource*this.previewCanvasScale);this.context.drawImage(this.spriteSource,0,0);this.context.restore();this.drawSpriteRects();this.drawSpritePreview(0)}}},drawSpritePreview:function(){var e=this.spriteRects[this.spritePreviewIndex];var t=1/this.resizeSource;this.spritePreviewContext.clearRect(0,0,this.spritePreview.width,this.spritePreview.height);this.spritePreviewContext.drawImage(this.spriteSource,e.x*t,e.y*t,e.width*t,e.height*t,0,0,this.spritePreview.width,this.spritePreview.height)},doImport:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!=="grid"){alert("Please choose a grid layer");return}var t=this.editor.graphic;t.setDrawEnabled(false);this.editor.history.setEnabled(false);var i=e.getTileSet();e.setCreateSpriteTiles(false);e.setBlankTileId(0);if(this.importCanvas==null){this.importCanvas=document.createElement("canvas")}this.importCanvas.width=this.spriteWidth;this.importCanvas.height=this.spriteHeight;this.importContext=this.importCanvas.getContext("2d");this.importContext.imageSmoothingEnabled=false;this.importContext.webkitImageSmoothingEnabled=false;this.importContext.mozImageSmoothingEnabled=false;this.importContext.msImageSmoothingEnabled=false;this.importContext.oImageSmoothingEnabled=false;var r=this.editor.currentTile.getColor();for(var a=0;a<this.spriteCount;a++){var s=i.createTile();console.log("create tile: "+s);this.importContext.clearRect(0,0,this.importCanvas.width,this.importCanvas.height);var o=this.spriteRects[a];var l=o.width;var n=o.height;var h=0;var d=0;var c=1/this.resizeSource;this.importContext.drawImage(this.spriteSource,o.x*c,o.y*c,o.width*c,o.height*c,h,d,l,n);var f=this.importContext.getImageData(0,0,this.spriteWidth,this.spriteHeight);var u=[];for(var p=0;p<this.spriteHeight;p++){for(var v=0;v<this.spriteWidth;v++){var g=(v+p*this.spriteWidth)*4;if(f.data[g]>100){u.push(1)}else{u.push(0)}}}i.setTileData(s,u);console.log("set tile data: "+s);console.log(u);if(a!==0){var m=t.insertFrame();t.setCurrentFrame(m)}var y={};y.update=false;y.x=0;y.y=0;y.t=s;y.fc=r;y.bc=this.editor.colorPaletteManager.noColor;console.log(y);e.setCell(y)}e.setCreateSpriteTiles(true);this.editor.history.setEnabled(true);t.setDrawEnabled(true);this.editor.spriteFrames.draw({framesChanged:true});this.editor.frames.gotoFrame(0);this.editor.graphic.redraw()}};var ViceSnapshotReader=function(){this.editor=null;this.data=null;this.index=0};ViceSnapshotReader.prototype={init:function(e){this.editor=e},getVersion:function(){return this.majorVersion+"."+this.minorVersion},readSnapshot:function(e){this.data=e;this.index=0;var t="";for(var i=0;i<18;i++){t+=String.fromCharCode(e[i])}if(t!="VICE Snapshot File"){console.error("unknown file format");return false}console.log("magic = "+t);this.index=19;this.majorVersion=e[this.index++];this.minorVersion=e[this.index++];console.log("major version = "+this.majorVersion);console.log("minor version = "+this.minorVersion);this.machineName="";for(var i=this.index;i<this.index+16;i++){if(e[i]!=0){this.machineName+=String.fromCharCode(e[i])}}console.log("machine name = "+this.machineName);this.index+=16;this.snapshotVersion="";for(var i=this.index;i<this.index+12;i++){if(e[i]!=0){this.snapshotVersion+=String.fromCharCode(e[i])}}console.log(this.snapshotVersion);if(this.snapshotVersion=="VICE Version"){this.index+=13;this.index+=8}this.ramOffset=false;this.viciiOffset=false;this.viciiMajorVersion=0;while(this.index<e.length){var r="";for(var i=this.index;i<this.index+16;i++){if(e[i]!=0){r+=String.fromCharCode(e[i])}}console.log("module name = "+r);this.index+=16;var a=e[this.index++];var s=e[this.index++];var o=0;o+=e[this.index++];o+=e[this.index++]<<8;o+=e[this.index++]<<16;o+=e[this.index++]<<24;console.log("moduleSize = "+o);if(r=="C64MEM"){this.ramOffset=this.index+4}if(r=="VIC-II"){this.viciiOffset=this.index;viciiMajorVersion=a}if(r=="CIA2"){this.cia2Offset=this.index;this.cia2OutputRegisterA=e[this.index];this.cia2OutputRegisterB=e[this.index+1];this.ddRegisterA=e[this.index+2];this.ddRegisterB=e[this.index+3];console.log("----\x3eoutput register A = "+this.cia2OutputRegisterA);console.log("----\x3eoutput register B = "+this.cia2OutputRegisterB);console.log("----\x3edd register A = "+this.ddRegisterA);console.log("----\x3edd register B = "+this.ddRegisterB)}this.index+=o-16-2-4}console.log("vic ii maj version = ");console.log(viciiMajorVersion);this.readVICIIV2()},readVICIIV1:function(){var e=40;var t=25;var i=65*8;var r=this.viciiOffset;var a=this.data;r++;var s=[];for(var o=0;o<64;o++){s.push(a[r+o+1])}r+=2;r+=2;r+=2;r++;r++;r+=2;r++;r+=e;r+=e;r++;r+=2;r+=i;var l=s[17];this.extendedBackgroundMode=(l&64)>0;var n=s[22];this.multicolorMode=(n&16)>0;var h=s[24];var d=s[32];var c=s[33];var f=s[34];var u=s[35];this.borderColor=d;this.backgroundColor=c;this.extraBackgroundColor1=f;this.extraBackgroundColor2=u;var p=0;var v=(h&14)>>1;this.characterMemoryAddress=v*2048;var g=(h&240)>>4;this.screenMemoryAddress=g*1024},getScreenData:function(e){console.log("screen memory address = "+this.screenMemoryAddress);var t=this.screenMemoryAddress;var i=this.cia2OutputRegisterA&3;switch(i){case 0:t+=49152;break;case 1:t+=32768;break;case 2:t+=16384;break;case 3:break}for(var r=0;r<1e3;r++){e[r]=this.data[this.ramOffset+t+r]}return e},getColorData:function(e){console.log("get color data");var t=this.colorRamOffset;for(var i=0;i<1e3;i++){e[i]=this.data[this.colorRamOffset+i]}},getCharacterData:function(e){var t=this.characterMemoryAddress;var i=this.cia2OutputRegisterA&3;switch(i){case 0:t+=49152;break;case 1:t+=32768;break;case 2:t+=16384;break;case 3:break}var r=this.ramOffset+t;for(var a=0;a<2048;a++){e[a]=this.data[this.ramOffset+t+a]}},getBorderColor:function(){return this.borderColor},getBackgroundColor:function(){return this.backgroundColor},getExtraBackgroundColor1:function(){return this.extraBackgroundColor1},getExtraBackgroundColor2:function(){return this.extraBackgroundColor2},getMulticolorMode:function(){return this.multicolorMode},readVICIIV2:function(){var e=this.viciiOffset;var t=this.data;var i=t[e++];console.log("version = "+i);e++;e++;e++;e+=40;this.colorRamOffset=e-1;e+=1024;e++;e++;e++;e++;e+=40;e++;var r=t[e++];r+=t[e++]<<8;console.log("vic ii ram base = "+r);e++;e+=2;var a=[];for(var s=0;s<64;s++){a.push(t[e+s+1])}console.log(a);var o=a[17];this.extendedBackgroundMode=(o&64)>0;var l=a[22];this.multicolorMode=(l&16)>0;console.log("multicolor mode = "+this.multicolorMode);var n=a[24];var h=a[32];var d=a[33];var c=a[34];var f=a[35];this.borderColor=h;this.backgroundColor=d;this.extraBackgroundColor1=c;this.extraBackgroundColor2=f;console.log("d018 = "+n+"!!!!!!");var u=0;var p=(n&14)>>1;this.characterMemoryAddress=p*2048;var v=(n&240)>>4;this.screenMemoryAddress=v*1024}};var ImportC=function(){this.editor=null;this.cols=40;this.rows=25;this.machine="c64";this.charset="upper"};ImportC.prototype={init:function(e){this.editor=e},doImport:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){alert("Please select a grid layer");return}var i=t.getC64Multi1Color();var r=t.getC64Multi2Color();var a=this.getFrameCount();t.setScreenMode(TextModeEditor.Mode.TEXTMODE);var s=this.getScreenWidth();var o=this.getScreenHeight();this.editor.graphic.setGridDimensions({width:s,height:o});var l=this.editor.graphic.getCurrentFrame();for(var n=0;n<a;n++){if(n!=0){var h=this.editor.graphic.insertFrame();this.editor.frames.gotoFrame(h)}var d=[];this.getScreenData(d,n);var c=[];this.getColorData(c,n);var f=this.getBackgroundColor(n);var u=this.getBorderColor(n);t.setBackgroundColor(f);t.setBorderColor(u);var p=false;var e={};e.update=false;for(var v=0;v<o;v++){for(var g=0;g<s;g++){var m=g+v*s;var y=d[m];var b=this.editor.colorPaletteManager.noColor;if(p){var C=y>>6;b=f;if(C==1){b=i}if(C==2){b=r}y=y&63}e.x=g;e.y=v;e.t=y;e.fc=c[m];e.bc=b;t.setCell(e)}}}var x=t.getTileSet();if(!x.isPetscii()){x.readBinaryData({tileData:romDump.character,characterWidth:8,characterHeight:8});this.editor.tileSetManager.tileSetUpdated({updateBlankCells:false,updateSortMethods:true})}this.editor.frames.gotoFrame(l);this.editor.gridView2d.findViewBounds();this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true})},read:function(e){this.cols=40;this.rows=25;this.machine="c64";this.charset="upper";e=e.replace("\r","");var t=e.split("\n");for(var i=0;i<t.length;i++){var r=t[i];var a=r.indexOf("META:");if(a!==-1){a+=5;r=r.substring(a).trim();var s=r.split(" ");if(s.length>=4){this.cols=s[0];this.rows=s[1];this.machine=s[2];this.charset=s[3]}console.log("meta: ");console.log(r)}}console.log("cols = "+this.cols+","+this.rows);var o=0;var r=t[o];this.frames=[];var l=0;while(true){while(o<t.length-1&&r.indexOf("char")===-1){o++;r=t[o]}o++;r=t[o];while(o<t.length-1&&r.indexOf("//")===0){o++;r=t[o];console.log("line = "+r)}if(o>=t.length){console.log("done: "+l+" frames");console.log(this.frames);return}r=t[o];console.log("line index === "+r);var n=r.split(",");if(n.length>4||n.length<2){console.log("parts = ");console.log(n);console.log("too many parts for border, bg");return}var h=parseInt(n[0],10);var d=parseInt(n[1],10);var c=[];for(var i=0;i<this.rows;i++){o++;if(o>=t.length){console.log("not enough data");return}var r=t[o];var n=r.split(",");for(var f=0;f<this.cols;f++){if(f>=n.length){console.log("not enough data for row");console.log(n);return}var u=parseInt(n[f],10);if(isNaN(u)){console.log("not an int: "+f+":"+n[f])}else{c.push(u)}}}var p=[];for(var i=0;i<this.rows;i++){o++;if(o>=t.length){console.log("not enough data");return}var r=t[o];var n=r.split(",");for(var f=0;f<this.cols;f++){if(f>=n.length){console.log("not enough data for row");return}var u=parseInt(n[f],10);if(isNaN(u)){console.log("not an int: "+u)}else{p.push(u)}}}this.frames.push({border:h,bg:d,charData:c,colorData:p});l++;if(l>200){break}}},getFrameCount:function(){return this.frames.length},getScreenData:function(e,t,i,r){var a=this.frames[0];if(typeof t!="undefined"){a=this.frames[t]}var s=0;var o=0;if(typeof i!="undefined"){s=i}if(typeof r!="undefined"){o=r}var l=this.cols*this.rows;for(var n=0;n<l;n++){var h=n+s+o*this.cols;if(h>=l){break}e[n]=a.charData[h]}},getColorData:function(e,t,i,r){var a=this.frames[0];if(typeof t!="undefined"){a=this.frames[t]}var s=0;var o=0;if(typeof i!="undefined"){s=i}if(typeof r!="undefined"){o=r}var l=this.cols*this.rows;for(var n=0;n<l;n++){var h=n+s+o*this.cols;if(h>=l){break}e[n]=a.colorData[h]}},getBackgroundColor:function(e){var t=this.frames[0];if(typeof e!="undefined"){t=this.frames[e]}return t.bg},getBorderColor:function(e){var t=this.frames[0];if(typeof e!="undefined"){t=this.frames[e]}return t.border},getScreenWidth:function(){return this.cols},getScreenHeight:function(){return this.rows}};var ImportSeq=function(){this.editor=null;this.cols=40;this.rows=25;this.machine="c64";this.charset="upper";this.screenData=[];this.colorData=[];this.colors=[144,5,28,159,156,30,31,158,129,149,150,151,152,153,154,155];this.revsOn=18;this.revsOff=146};ImportSeq.prototype={init:function(e){this.editor=e},readSeq:function(e){var t=0;var i=0;var r=false;this.screenData=[];this.colorData=[];for(var a=0;a<1e3;a++){this.screenData[a]=32;this.colorData[a]=0}for(var a=0;a<e.length;a++){var s=e[a];if(s==this.revsOn){r=true}else if(s==this.revsOff){r=false}else if(s==3){}else if(s==8){}else if(s==9){}else if(s==13){t=t-t%40}else if(s==14){}else if(s==17){t+=40}else if(s==19){t=0}else if(s==20){t--;if(t<0){t=0}this.screenData[t]=32}else if(s==29){t++}else if(s>=32&&s<=63){var o=s;if(r){o+=128}this.screenData[t]=o;this.colorData[t]=i;t++}else if(s>=64&&s<=95){var o=s-64;if(r){o+=128}this.screenData[t]=o;this.colorData[t]=i;t++}else if(s>=96&&s<=127){var o=s-32;if(r){o+=128}this.screenData[t]=o;this.colorData[t]=i;t++}else if(s==141){t=t+40-t%40}else if(s==142){}else if(s==145){t-=40}else if(s==147){for(var l=0;l<1e3;l++){this.screenData[l]=32}}else if(s==148){}else if(s==157){t--}else if(s==160){t++}else if(s>160&&s<=191){var o=s-64;if(r){o+=128}this.screenData[t]=o;this.colorData[t]=i;t++}else if(s>=192&&s<=223){var o=s-128;if(r){o+=128}this.screenData[t]=o;this.colorData[t]=i;t++}else if(s>=224&&s<=254){var o=s-128;if(r){o+=128}this.screenData[t]=o;this.colorData[t]=i;t++}else if(s==255){var o=94;if(r){o+=128}this.screenData[t]=o;this.colorData[t]=i;t++}else{var n=false;for(var l=0;l<this.colors.length;l++){if(s==this.colors[l]){i=l;n=true;break}}if(n===false){}}}},getScreenWidth:function(){return this.cols},getScreenHeight:function(){return this.rows},getFrameCount:function(){return 1},getScreenData:function(e){for(var t=0;t<1e3;t++){e[t]=this.screenData[t]}},getColorData:function(e){for(var t=0;t<1e3;t++){e[t]=this.colorData[t]}}};var ImportCharPad=function(){this.editor=null;this.characterMaterials=[];this.tiles=[]};ImportCharPad.prototype={init:function(e){this.editor=e},doImport:function(e){var t=true;var i=true;var r=true;var a=true;var s=true;if(typeof e!="undefined"){t=e.importC64CharPadMap;i=e.importC64CharPadCharacters;r=e.setColorPerMode;a=e.importC64CharPadBlocks;s=e.useBlockMode}var o=this.editor.layers.getSelectedLayerObject();if(!o||o.getType()!=="grid"){alert("Please choose a grid layer");return}var l=this.editor.graphic;l.setDrawEnabled(false);var n=this.getTileWidth();var h=this.getTileHeight();var d=this.getTiles();if(!this.getTileSystem()||d.length==0||n===1&&h===1){s=false}var c=this.getScreenWidth();var f=this.getScreenHeight();var u=1;if(t){this.editor.graphic.setGridDimensions({width:c,height:f})}var p=this.getCharData();var v=o.getTileSet();var g=o.getBlockSet();if(t){o.setBackgroundColor(this.getBackgroundColor());this.editor.currentTile.setColor(this.getCharColor(),{update:false})}if(i){v.readBinaryData({tileData:p,tileCount:this.getCharCount(),characterWidth:8,characterHeight:8});this.editor.tileSetManager.tileSetUpdated({updateBlankCells:false,updateSortMethods:true});if(this.getMulticolorMode()){o.setC64Multi1Color(this.getC64Multi1Color(),false);o.setC64Multi2Color(this.getC64Multi2Color(),false);o.setScreenMode(TextModeEditor.Mode.C64MULTICOLOR)}else if(this.getECMMode()){o.setC64ECMColor(1,this.getC64Multi1Color());o.setC64ECMColor(2,this.getC64Multi2Color());o.setC64ECMColor(3,this.bgColor3);o.setScreenMode(TextModeEditor.Mode.C64ECM)}else{o.setScreenMode(TextModeEditor.Mode.TEXTMODE)}l.setDrawEnabled(false);for(var m=0;m<this.getCharCount();m++){var y=this.getCharacterMaterial(m);v.setTileMaterial(m,y)}if(this.getColorMethod()==2){for(var m=0;m<this.getCharCount();m++){var y=this.getCharacterColor(m);v.setTileColor(m,y)}if(r){o.setColorPerMode("character")}}}if(a){if(this.editor.tools.drawTools.blockPalette){this.editor.tools.drawTools.blockPalette.selectedBlock=false;this.editor.tools.drawTools.blockPalette.highlightBlock=false;this.editor.sideBlockPalette.highlightBlock=false;this.editor.sideBlockPalette.highlightBlock=false}g.clear();var d=this.getTiles();for(var b=0;b<d.length;b++){g.createBlock({data:d[b]})}if(r){if(this.getColorMethod()==1){o.setColorPerMode("block");for(var b=0;b<d.length;b++){var y=this.getTileColor(b);g.setBlockColor(b,y)}}}}if(r){if(this.getColorMethod()==0){var y=this.getCharColor();for(var m=0;m<this.getCharCount();m++){v.setTileColor(m,y)}o.setColorPerMode("character")}}if(t){if(s){o.setBlockDimensions(n,h);o.setBlockModeEnabled(true)}else{o.setBlockModeEnabled(false)}this.editor.layers.updateLayerLabel(o.getId());this.editor.history.setEnabled(false);var e={};e.update=false;for(var C=0;C<f;C++){for(var x=0;x<c;x++){e.x=x;e.y=C;e.b=this.getBlockAt(x,C);e.t=this.getCharAt(x,C);e.fc=this.getColorAt(x,C);e.bc=this.editor.colorPaletteManager.noColor;o.setCell(e)}}this.editor.history.setEnabled(true)}l.setDrawEnabled(true);this.editor.gridView2d.findViewBounds();this.editor.graphic.invalidateAllCells();this.editor.graphic.redraw({allCells:true});this.editor.tools.drawTools.blockPalette.drawBlockPalette();this.editor.sideBlockPalette.drawBlockPalette();this.editor.tools.drawTools.tilePalette.drawTilePalette();this.editor.sideTilePalette.drawTilePalette();this.editor.layers.updateLayerLabel(o.getId())},readCharPadV7:function(e){console.log("read char pad v7");this.tileSystem=false;this.expandedData=false;this.multiColorMode=false;this.ecmMode=false;var t=0;this.bgColor=e[4];this.multiColor1=e[5];this.multiColor2=e[6];this.bgColor3=e[7];this.charColor=e[8];this.colorMethod=e[9];this.screenMode=e[10];this.multiColorMode=this.screenMode==1;this.ecmMode=this.screenMode==2;this.flags=e[11];this.tileSystem=this.flags&1;console.log("screen mode = "+this.screenMode);console.log(this.multiColorMode+","+this.ecmMode);console.log("tile system = "+this.flags+","+this.tileSystem);t=12;var i=e[t++];if(i!=218){console.log("character data block: bad block marker");return}i=e[t++];if(i!=176){console.log("character data block: bad block marker");return}this.numChars=e[t++]+(e[t++]<<8)+1;console.log("num chars = "+this.numChars);this.tileData=[];for(var r=0;r<this.numChars;r++){for(var a=0;a<8;a++){this.tileData.push(e[t++])}}i=e[t++];if(i!=218){console.log("character set attributes block: bad block marker");return}i=e[t++];if(i!=177){console.log("character seta attributes block: bad block marker");return}this.characterMaterials=[];this.characterColors=[];for(var r=0;r<this.numChars;r++){this.characterMaterials.push(e[t]>>4);this.characterColors.push(e[t]&15);t++}this.numTiles=0;if(this.tileSystem){i=e[t++];if(i!=218){console.log("character set attributes block: bad block marker");return}i=e[t++];this.numTiles=e[t++]+(e[t++]<<8)+1;this.tileWidth=e[t++];this.tileHeight=e[t++];console.log("num tiles = "+this.numTiles+","+this.tileWidth+","+this.tileHeight);for(var s=0;s<this.numTiles;s++){var o=[];for(var l=0;l<this.tileHeight;l++){o.push([]);for(var n=0;n<this.tileWidth;n++){var r=e[t++]+(e[t++]<<8);o[l][n]={t:r,fc:0,bc:0}}}this.tiles.push(o)}this.tileColors=[];if(this.colorMethod==1){i=e[t++];if(i!=218){console.log("tile colours block: bad block marker");return}i=e[t++];for(var o=0;o<this.numTiles;o++){this.tileColors.push(e[t++])}}i=e[t++];if(i!=218){console.log("tile tags block: bad block marker");return}i=e[t++];for(var o=0;o<this.numTiles;o++){var h=e[t++]}i=e[t++];if(i!=218){console.log("tile names block: bad block marker");return}i=e[t++];for(var o=0;o<this.numTiles;o++){var d="";while(e[t]!=0){d+=String.fromCharCode(e[t]);t++}t++}}i=e[t++];if(i!=218){console.log("map data block: bad block marker");return}i=e[t++];this.mapWidth=e[t++]+(e[t++]<<8);this.mapHeight=e[t++]+(e[t++]<<8);console.log("map width = "+this.mapWidth+","+this.mapHeight);this.mapData=[];for(var l=0;l<this.mapHeight;l++){for(var n=0;n<this.mapWidth;n++){this.mapData.push(e[t++]+(e[t++]<<8))}}},readCharPad:function(e){if(e[0]!=67||e[1]!=84||e[2]!=77){return}var t=3;this.tileSystem=false;this.expandedData=false;this.multiColorMode=false;this.ecmMode=false;this.characterMaterials=[];this.tiles=[];this.mapWidth=40;this.mapHeight=25;this.mapData=[];this.version=e[3];console.log("char pad v"+this.version);if(this.version==7){this.readCharPadV7(e);return}this.bgColor=e[4];this.multiColor1=e[5];this.multiColor2=e[6];console.log("import charpad version "+this.version);if(this.version==7){this.bgColor3=e[7];this.charColor=e[8];this.colorMethod=e[9];this.screenMode=e[10];this.multiColorMode=this.screenMode==1;this.ecmMode=this.screenMode==2;this.flags=e[11];this.tileSystem=this.flags&1;console.log("tile system = "+this.flags+","+this.tileSystem)}else{this.charColor=e[7];this.colorMethod=e[8];if(this.version<=4&&this.colorMethod==2){this.colorMethod=3}this.flags=e[9]}if(this.version<=4){this.multiColorMode=this.flags}else if(this.version==5){this.tileSystem=(this.flags&1)!=0;this.expandedData=(this.flags&2)!=0;this.multiColorMode=(this.flags&4)!=0}else if(this.version==6){this.multiColorMode=(this.flags&1)!=0;this.tileSystem=(this.flags&2)!=0}if(this.version<=3){this.mapWidth=e[10]+(e[11]<<8);this.mapHeight=e[12]+(e[13]<<8);this.numChars=e[14]+(e[15]<<8)+1;this.numTiles=e[16]+1;this.tileWidth=e[17];this.tileHeight=e[17]}else if(this.version==4){this.numChars=e[10]+(e[11]<<8)+1;this.numTiles=e[12]+1;this.tileWidth=e[13];this.tileHeight=e[14];this.mapWidth=e[15]+(e[16]<<8);this.mapHeight=e[17]+(e[18]<<8);this.expandedData=e[19]}else if(this.version==5){this.numChars=e[10]+(e[11]<<8)+1;this.numTiles=e[12]+(e[13]<<8)+1;this.tileWidth=e[14];this.tileHeight=e[15];this.mapWidth=e[16]+(e[17]<<8);this.mapHeight=e[18]+(e[19]<<8)}if(this.tileWidth==0||this.tileHeight==0){this.expandedData=true}var t=20;if(this.version==4){t=24}if(this.version>=6){if(this.version==6){t=10}if(this.version==7){t=12}if(e[t++]==218&&e[t++]==176){console.log("found char data block marker")}else{console.log("couldnt find charset attributes block")}this.numChars=e[t++]+(e[t++]<<8)+1;console.log("num chars = "+this.numChars)}this.tileData=[];for(var i=0;i<this.numChars;i++){for(var r=0;r<8;r++){this.tileData.push(e[t++])}if(this.version==2){t++}}this.characterMaterials=[];this.characterColors=[];if(this.version>=4){if(this.version>=6){if(e[t++]==218&&e[t++]==177){console.log("found char set attributes block")}else{console.log("couldnt find charset attributes block")}}for(var i=0;i<this.numChars;i++){this.characterMaterials.push(e[t]>>4);this.characterColors.push(e[t]&15);t++}}this.tiles=[];if(!this.expandedData&&this.tileSystem){if(this.version>=6){if(e[t++]==218){var a=e[t++];console.log("found tileblock: "+a)}else{console.log("couldnt find tile block")}this.numTiles=e[t++]+(e[t++]<<8)+1;this.tileWidth=e[t++];this.tileHeight=e[t++];console.log("num tiles = "+this.numTiles+","+this.tileWidth+","+this.tileHeight)}for(var s=0;s<this.numTiles;s++){var o=[];for(var l=0;l<this.tileHeight;l++){o.push([]);for(var n=0;n<this.tileWidth;n++){var i=e[t++]+(e[t++]<<8);o[l][n]={t:i,fc:0,bc:0}}}this.tiles.push(o)}}if(this.tileSystem&&this.expandedData){var h=0;for(var s=0;s<this.numTiles;s++){var o=[];for(var l=0;l<this.tileHeight;l++){o.push([]);for(var n=0;n<this.tileWidth;n++){o[l][n]={t:h++,fc:0,bc:0}}}this.tiles.push(o)}}this.tileCellColors=[];if(this.version==4||this.version==3||this.version==2&&this.colorMethod==3){for(var s=0;s<this.numTiles;s++){var d=[];for(var l=0;l<this.tileHeight;l++){d.push([]);for(var n=0;n<this.tileWidth;n++){d[l][n]=e[t++]&15}}this.tileCellColors.push(d)}}this.tileColors=[];if(this.colorMethod==1){if(this.version>=6){if(e[t++]==218){var a=e[t++];console.log("found tile colours block: "+a)}else{console.log("couldnt find tile colours block")}}for(var o=0;o<this.numTiles;o++){this.tileColors.push(e[t++])}}if(this.tileSystem){if(this.version>=6){if(e[t++]==218){var a=e[t++];console.log("found tile tags block: "+a)}else{console.log("couldnt find tile colours block")}for(var o=0;o<this.numTiles;o++){var c=e[t++]}for(var o=0;o<this.numTiles;o++){var f="";while(e[t]!=0){f+=String.fromCharCode(e[t]);t++}t++}}}if(this.version>=6){if(e[t++]==218){var a=e[t++];console.log("found map block: "+a)}else{console.log("couldnt find map block")}this.mapWidth=e[t++]+(e[t++]<<8);this.mapHeight=e[t++]+(e[t++]<<8);console.log("map width = "+this.mapWidth+","+this.mapHeight)}this.mapData=[];for(var l=0;l<this.mapHeight;l++){for(var n=0;n<this.mapWidth;n++){this.mapData.push(e[t++]+(e[t++]<<8))}}console.log(this)},getVersion:function(){return this.version},getTileCount:function(){return this.numTiles},getCharCount:function(){return this.numChars},getColorMethod:function(){return this.colorMethod},getCharacterColor:function(e){return this.characterColors[e]},getCharacterMaterial:function(e){if(e<0||e>=this.characterMaterials.length){return 0}return this.characterMaterials[e]},getTileColor:function(e){return this.tileColors[e]},getTileWidth:function(){return this.tileWidth},getTileHeight:function(){return this.tileHeight},getMulticolorMode:function(){return this.multiColorMode},getECMMode:function(){return this.ecmMode},getCharData:function(){return this.tileData},getBackgroundColor:function(){return this.bgColor},getC64Multi1Color:function(){return this.multiColor1},getC64Multi2Color:function(){return this.multiColor2},getCharColor:function(){return this.charColor},getMapWidth:function(){return this.mapWidth},getMapHeight:function(){return this.mapHeight},getTileSystem:function(){return this.tileSystem},getScreenWidth:function(){if(this.tileSystem){return this.mapWidth*this.tileWidth}return this.mapWidth},getScreenHeight:function(){if(this.tileSystem){return this.mapHeight*this.tileHeight}return this.mapHeight},getTiles:function(){return this.tiles},getCharAt:function(e,t){if(this.tileSystem){var i=Math.floor(e/this.tileWidth);var r=Math.floor(t/this.tileHeight);var a=r*this.mapWidth+i;if(a<0||a>=this.mapData.length){return 0}var s=this.mapData[a];var o=e%this.tileWidth;var l=t%this.tileHeight;if(s>=this.tiles.length||l>=this.tiles[s].length||o>=this.tiles[s][l].length){return 0}return this.tiles[s][l][o].t}else{var a=t*this.mapWidth+e;if(a<0||a>=this.mapData.length){return 0}return this.mapData[a]}return 0},getBlockAt:function(e,t){if(this.tileSystem){var i=Math.floor(e/this.tileWidth);var r=Math.floor(t/this.tileHeight);var a=r*this.mapWidth+i;if(a<0||a>=this.mapData.length){return 0}return this.mapData[a]}else{var a=t*this.mapWidth+e;if(a<0||a>=this.mapData.length){return 0}return this.mapData[a]}return 0},getColorAt:function(e,t){if(this.colorMethod==0){return this.charColor}if(this.colorMethod==1){var i=this.getBlockAt(e,t);return this.getTileColor(i)}if(this.colorMethod==2){var r=this.getCharAt(e,t);return this.characterColors[r]}return 14},getScreenData:function(e,t,i,r){var a=false;if(typeof t!=="undefined"){a=t}var s=0;var o=40;var l=25;var n=0;var h=0;if(typeof i!="undefined"){n=i}if(typeof r!="undefined"){h=r}if(a){if(this.tileSystem){o=this.mapWidth*this.tileWidth;l=this.mapHeight*this.tileHeight}}if(this.tileSystem){if(o>this.mapWidth*this.tileWidth){o=this.mapWidth*this.tileWidth}if(l>this.mapHeight*this.tileHeight){l=this.mapHeight*this.tileHeight}}else{if(o>this.mapWidth){o=this.mapWidth}if(l>this.mapHeight){l=this.mapHeight}}for(var d=0;d<l;d++){for(var c=0;c<o;c++){var f=c+n;var u=d+h;if(this.tileSystem){var p=Math.floor(f/this.tileWidth);var v=Math.floor(u/this.tileHeight);var g=this.mapData[v*this.mapWidth+p];var m=f%this.tileWidth;var y=u%this.tileHeight;var b=this.tiles[g][y][m].t;e[s++]=b}else{var b=this.mapData[u*this.mapWidth+f];e[s++]=b}}}}};var ImportSpritePad=function(){this.editor=null;this.sprites=[];this.animations=[]};ImportSpritePad.prototype={init:function(e){this.editor=e},readSpritePad:function(e){var t=0;var i=0;if(e[t++]!=83||e[t++]!=80||e[t++]!=68){i=0}else{i=e[t++]}console.log("sprite pad version: "+i);if(i===0){var r=e.length;if((r&63)!=3||r>256*64+3||r<67){console.log("not charpad");return}t=0;this.backgroundColor=e[t++];this.multiColor1=e[t++];this.multiColor2=e[t++];this.spriteCount=(r-3)/64;this.animationCount=0}else if(i===1){this.spriteCount=e[t++]+1;this.animationCount=e[t++]+1;this.backgroundColor=e[t++];this.multiColor1=e[t++];this.multiColor2=e[t++]}else if(i===2){var a=e[t++];this.spriteCount=e[t++];e[t++];e[t++];e[t++];this.animationCount=e[t++];e[t++];e[t++];e[t++];this.backgroundColor=e[t++];this.multiColor1=e[t++];this.multiColor2=e[t++]}console.log("sprite count"+this.spriteCount);console.log("animation count = "+this.animationCount);console.log("background color = "+this.backgroundColor);console.log("multicolor 1 = "+this.multiColor1);console.log("multicolor 2 = "+this.multiColor2);this.sprites=[];for(var s=0;s<this.spriteCount;s++){var o=[];for(var l=0;l<63;l++){var n=e[t++];o.push(n)}var h=e[t++];var d=h>>4&1;this.sprites.push({spriteData:o,color:h&15,overlay:d,multi:h>>7&1,flags:h})}this.animations=[];if(i==0){}if(i==1){for(var s=0;s<this.animationCount;s++){var c=e[t++];this.animations.push({start:c})}for(var s=0;s<this.animationCount;s++){var f=e[t++];this.animations[s].end=f}for(var s=0;s<this.animationCount;s++){var u=e[t++];this.animations[s].timer=u}for(var s=0;s<this.animationCount;s++){var h=e[t++];this.animations[s].flags=h}}if(i==2){for(var s=0;s<this.animationCount;s++){var p=e[t++];var v=e[t++];var c=p;this.animations.push({start:c})}for(var s=0;s<this.animationCount;s++){var g=e[t++];var m=e[t++];var f=g;this.animations[s].end=f}for(var s=0;s<this.animationCount;s++){var u=e[t++];this.animations[s].timer=u}for(var s=0;s<this.animationCount;s++){var h=e[t++];this.animations[s].flags=h}}if(this.animations.length==0){this.animations.push({start:0,end:this.sprites.length-1,timer:12,flags:0})}if(this.animations.length==1&&this.animations[0].start==this.animations[0].end){this.animations[0].start=0;this.animations[0].end=this.sprites.length-1,this.animations[0].timer=12;this.animations[0].flags=0}console.log(this.sprites)},doImport:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){alert("Please choose a grid layer");return}var i=this.editor.graphic;i.setDrawEnabled(false);this.editor.history.setEnabled(false);var r=this.getTileWidth();var a=this.getTileHeight();var s=this.getGridWidth();var o=this.getGridHeight();var l=t.getTileSet();var n=0;var h=0;t.setCreateSpriteTiles(false);t.setBlankTileId(0);t.setC64Multi1Color(this.multiColor1);t.setC64Multi2Color(this.multiColor2);t.setBackgroundColor(this.editor.colorPaletteManager.noColor);var d=TextModeEditor.Mode.TEXTMODE;var c=0;var f={};var u=[];var p=i.getCurrentFrame();var v=this.sprites;var g=false;var m=TextModeEditor.Mode.TEXTMODE;var y=null;for(var b=0;b<v.length;b++){if(v[b].overlay==1){g=true;break}}if(g){var C=this.editor.layers;var x=C.newLayer({label:"overlay",screenMode:m});y=this.editor.layers.getLayerObject(x)}for(var b=0;b<this.animations.length;b++){var S=this.animations[b].start;var P=this.animations[b].end;var w=P-S+1;var I=this.animations[b].timer;var k=p;if(c!==0){k++}var k=p;var w=0;for(var M=S;M<=P;M++){w++;var T=this.sprites[M];var D=T.spriteData;if(T.multi){d=TextModeEditor.Mode.C64MULTICOLOR}var E="";if(f.hasOwnProperty(M)){E=f[M]}else{E=l.createTile();f[M]=E;var $=T.color;var _=[];for(var B=0;B<D.length;B++){var R=D[B];for(var A=7;A>=0;A--){var F=R>>>A&1;_.push(F)}}l.setTileData(E,_)}var L=I;if(c!==0){p=i.insertFrame(p,L);i.setCurrentFrame(p)}else{i.setCurrentFrame(p);i.setFrameDuration(L,p)}var e={};e.update=false;e.x=n;e.y=h;e.t=E;e.fc=$;e.bc=this.editor.colorPaletteManager.noColor;t.setCell(e);if(T.overlay){M++;T=this.sprites[M];var D=T.spriteData;var E="";if(f.hasOwnProperty(M)){E=f[M]}else{E=l.createTile();f[M]=E;var $=T.color;var _=[];for(var B=0;B<D.length;B++){var R=D[B];for(var A=7;A>=0;A--){var F=R>>>A&1;_.push(F)}}l.setTileData(E,_)}var e={};e.update=false;e.x=n;e.y=h;e.t=E;e.fc=$;e.bc=this.editor.colorPaletteManager.noColor;y.setCell(e)}c++}u.push({start:k,end:k+w})}i.setFrameRanges(u);t.setCreateSpriteTiles(true);t.setScreenMode(d);this.editor.history.setEnabled(true);i.setDrawEnabled(true)},getTileWidth:function(){return 24},getTileHeight:function(){return 21},getGridWidth:function(){return 1},getGridHeight:function(){return 1},getAnimations:function(){return this.animations},getSprites:function(){return this.sprites},getSprite:function(e){return this.sprites[e]},getMulti1:function(){return this.multiColor1},getMulti2:function(){return this.multiColor2},getBackgroundColor:function(){return this.backgroundColor}};var ImportSPR=function(){this.editor=null;this.sprites=[]};ImportSPR.prototype={init:function(e){this.editor=e},doImport:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!=="grid"){alert("Please choose a grid layer");return}var i=true;if(typeof e!=="undefined"){if(typeof e.multicolor!="undefined"){i=e.multicolor}}var r=this.editor.graphic;r.setDrawEnabled(false);this.editor.history.setEnabled(false);var a=this.getTileWidth();var s=this.getTileHeight();var o=this.getGridWidth();var l=this.getGridHeight();var n=t.getTileSet();var h=0;var d=0;if(i){t.setScreenMode(TextModeEditor.Mode.C64MULTICOLOR)}else{t.setScreenMode(TextModeEditor.Mode.TEXTMODE)}t.setCreateSpriteTiles(false);t.setBlankTileId(0);t.setC64Multi1Color(this.multiColor1);t.setC64Multi2Color(this.multiColor2);for(var c=0;c<this.sprites.length;c++){var f=this.sprites[c].spriteData;var u=n.createTile();var p=this.sprites[c].color;var v=[];for(var g=0;g<f.length;g++){var m=f[g];for(var y=7;y>=0;y--){var b=m>>>y&1;v.push(b)}}n.setTileData(u,v);if(c!==0){var C=r.insertFrame();r.setCurrentFrame(C)}var e={};e.update=false;e.x=h;e.y=d;e.t=u;e.fc=p;e.bc=this.editor.colorPaletteManager.noColor;t.setCell(e)}t.setCreateSpriteTiles(true);this.editor.history.setEnabled(true);r.setDrawEnabled(true)},getTileWidth:function(){return 24},getTileHeight:function(){return 21},getGridWidth:function(){return 1},getGridHeight:function(){return 1},getSprites:function(){return this.sprites},readSPR:function(e){console.log(e);var t=0;var i=e.length;var r=e[t++];var a=e[t++];i=i-2;this.spriteCount=i/64;console.log("sprite count = "+this.spriteCount);this.sprites=[];for(var s=0;s<this.spriteCount;s++){var o=[];for(var l=0;l<63;l++){o.push(e[t++])}var n=e[t++];this.sprites.push({spriteData:o,color:1})}}};var ImportColorUtils=function(){this.editor=null;this.colorsRGB=[];this.colorsLABA=[]};ImportColorUtils.prototype={init:function(e){this.editor=e},initColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();this.colorsRGB=[];this.colorsLABA=[];for(var t=0;t<e.getColorCount();t++){var i=e.getHex(t);var r=i>>16&255;var a=i>>8&255;var s=i&255;var o={};o.values=[r,a,s,255];o=Colour.converters[Colour.RGBA][Colour.LABA](o);this.colorsRGB[t]=[r,a,s];this.colorsLABA[t]=[o.values[0],o.values[1],o.values[2]]}},imageDataToLABA:function(e){this.imageDataLABA=[];var t=[];var i={};for(var r=0;r<e.data.length;r+=4){t[0]=e.data[r];t[1]=e.data[r+1];t[2]=e.data[r+2];t[3]=e.data[r+3];i.values=t;i=Colour.converters[Colour.RGBA][Colour.LABA](i);this.imageDataLABA[r]=i.values[0];this.imageDataLABA[r+1]=i.values[1];this.imageDataLABA[r+2]=i.values[2];this.imageDataLABA[r+3]=e.data[r+3]}},findColors2:function(e,t){var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=this.editor.tileSetManager.getCurrentTileSet();var a=[];for(var s=0;s<t.length;s++){var o=i.getHex(t[s]);var l=o>>16&255;var n=o>>8&255;var h=o&255;a.push([l,n,h])}var d=2;var c={method:d,palette:a,dithKern:null};var f=new RgbQuant(c);f.sample(e);var u=f.palette(true,true)},findColors:function(e,t){var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=this.editor.tileSetManager.getCurrentTileSet();this.initColors();this.imageDataToLABA(e);this.importFromX=0;this.importFromY=0;this.importToX=this.editor.frames.width;this.importToY=this.editor.frames.height;imageColors=[];for(var a=0;a<t.length;a++){imageColors[a]={color:t[a],timesUsed:0}}for(var s=this.importFromY;s<this.importToY;s++){for(var o=this.importFromX;o<this.importToX;o++){var l=99999999;var n=-1;var h=-1;for(var d=0;d<t.length;d++){var c=t[d];var f=0;var u=false;for(cy=0;cy<r.charHeight;cy++){for(cx=0;cx<r.charWidth;cx++){var p=s*r.charHeight*e.width*4+o*r.charWidth*4+cy*e.width*4+cx*4;var v=this.colorsLABA[c][0];var g=this.colorsLABA[c][1];var m=this.colorsLABA[c][2];var y=this.imageDataLABA[p++];var b=this.imageDataLABA[p++];var C=this.imageDataLABA[p++];var x=this.imageDataLABA[p++];if(x==0){f+=100}else{u=true;f+=Math.abs(y-v);f+=Math.abs(b-g);f+=Math.abs(C-m)}}}if(f<l&&u){l=f;n=c;h=d}}if(n==-1){}else{imageColors[h].timesUsed++}}}imageColors.sort(function(e,t){return t.timesUsed-e.timesUsed});return imageColors},rgbQuant:function(e,t){alert("is this ever used??");if(typeof t=="undefined"){t=false}if(this.useColors=="choose"&&typeof this.customColorSet!="undefined"){this.colors=[];for(var i=0;i<this.customColorSet.length;i++){this.colors.push(this.customColorSet[i])}}else if(this.useColors=="greyscale"){this.colors=[];for(var i=0;i<this.editor.petscii.colors.length;i++){if(this.editor.petscii.colors[i].isGrey){this.colors.push(this.editor.petscii.colors[i].index)}}}else{this.colors=[];for(var i=0;i<this.editor.petscii.colors.length;i++){this.colors.push(i)}}var r={colors:256,method:2,boxSize:[64,64],boxPxls:2,initColors:4096,minHueCols:0,dithKern:null,dithDelta:0,dithSerp:false,palette:[],reIndex:false,useCache:true,cacheFreq:10,colorDist:"euclidean"};var a=[];for(var i=0;i<this.colors.length;i++){a.push(this.editor.petscii.getColor(this.colors[i]))}if(this.isVideo){r.dithKern=$("input[name=videoToPetsciiDither]:checked").val()}else{r.dithKern=$("input[name=toPetsciiDither]:checked").val()}r.colors=a.length;for(var i=0;i<a.length;i++){var s=a[i]>>16&255;var o=a[i]>>8&255;var l=a[i]&255;r.palette[i]=[s,o,l]}var n=new RgbQuant(r);n.sample(e);var h=n.palette();var d=[];for(var i=0;i<e.data.length;i++){if((i+1)%4==0){d.push(e.data[i])}}var c=n.reduce(e);var f=0;for(var i=0;i<e.data.length;i++){if((i+1)%4){}else{e.data[i]=d[f++]}}}};var BasicImport=function(){this.editor=null;this.colors=[];this.bgColors=[];this.characters=[];this.colorsRGB=[];this.colorsLABA=[];this.imageDataLABA=[];this.useMultipleBGColors=false;this.imageData=null;this.nextX=0;this.nextY=0};BasicImport.prototype={init:function(e){this.editor=e;this.charactersHasSpace=true;this.charactersHasBlock=true},setColors:function(e){this.colors=[];for(var t=0;t<e.length;t++){this.colors.push(e[t])}},setBGColors:function(e){this.bgColors=[];for(var t=0;t<e.length;t++){this.bgColors.push(e[t])}},setCharacters:function(e){this.characters=[];for(var t=0;t<e.length;t++){this.characters.push(e[t])}},setImageData:function(e){this.imageData=e},setUseMultipleBGColors:function(e){this.useMultipleBGColors=e},initColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();this.colorsRGB=[];this.colorsLABA=[];for(var t=0;t<e.getColorCount();t++){var i=e.getHex(t);var r=i>>16&255;var a=i>>8&255;var s=i&255;var o={};o.values=[r,a,s,255];o=Colour.converters[Colour.RGBA][Colour.LABA](o);this.colorsRGB[t]=[r,a,s];this.colorsLABA[t]=[o.values[0],o.values[1],o.values[2]]}},imageDataToLABA:function(){this.imageDataLABA=[];var e=[];var t={};for(var i=0;i<this.imageData.data.length;i+=4){e[0]=this.imageData.data[i];e[1]=this.imageData.data[i+1];e[2]=this.imageData.data[i+2];e[3]=this.imageData.data[i+3];t.values=e;t=Colour.converters[Colour.RGBA][Colour.LABA](t);this.imageDataLABA[i]=t.values[0];this.imageDataLABA[i+1]=t.values[1];this.imageDataLABA[i+2]=t.values[2];this.imageDataLABA[i+3]=this.imageData.data[i+3]}},startImport:function(){console.log("BASIC!!!");this.initColors();this.imageDataToLABA();this.nextX=0;this.nextY=0;this.importAtZ=this.editor.grid.getXYGridPosition()},findChar:function(e,t){var i=this.editor.tileSetManager.getCurrentTileSet();var r=99999999;var a=-1;var s=-1;var o=-1;var l=1;if(this.useMultipleBGColors){l=this.bgColors.length}for(var n=-1;n<l;n++){if(n==-1){c2=false}else{c2=this.bgColors[n]}for(var h=0;h<this.colors.length;h++){var d=this.colors[h];for(var c=0;c<this.characters.length;c++){var f=this.characters[c];var u=Math.floor(f/32);var p=f%32;var v=true;var g=0;for(cy=0;cy<i.charHeight;cy++){for(cx=0;cx<i.charWidth;cx++){var m=c2;if(l==1){}if(m===false){m=this.editor.tools.currentBackgroundColor}var y=t*this.imageData.width*4+e*4+cy*this.imageData.width*4+cx*4;var b=u*i.charHeight*256*4+p*i.charWidth*4+cy*256*4+cx*4;var C=this.imageDataLABA[y++];var x=this.imageDataLABA[y++];var S=this.imageDataLABA[y++];var P=this.imageDataLABA[y++];if(P>.7){v=false}if(P<.7&&c2===false&&!i.getPixel(f,cx,cy)){g+=0}else{var w=this.colorsLABA[m][0];var I=this.colorsLABA[m][1];var k=this.colorsLABA[m][2];if(i.getPixel(f,cx,cy)){w=this.colorsLABA[d][0];I=this.colorsLABA[d][1];k=this.colorsLABA[d][2]}g+=Math.abs(C-w);g+=Math.abs(x-I);g+=Math.abs(S-k)}}}if(v){return{ch:false,c1:false,c2:false}}if(a==-1||g<r){r=g;a=f;s=d;o=c2}}}}if(s==o&&this.charactersHasBlock){}return{ch:a,c1:s,c2:o}},getProgress:function(){return"("+this.nextX+","+this.nextY+")"},update:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.nextX*e.charWidth;var i=this.nextY*e.charHeight;var r=this.findChar(t,i);if(r.ch!==false){if(r.ch==160&&r.c1==r.c2){if(this.charactersHasSpace){r.ch=this.editor.tileSetManager.blankCharacter}}var a=this.editor.frames.height-this.nextY-1;var s={};s.c=r.ch;s.x=this.nextX;s.y=a;s.z=this.importAtZ;s.fc=r.c1;s.rx=0;s.ry=0;s.rz=0;if(this.useMultipleBGColors){s.bc=r.c2}else{s.bc=this.edit.colorPaletteManager.noColor}this.editor.grid.setCell(s)}this.nextX++;if(this.nextX>=this.editor.frames.width){this.nextX=0;this.nextY++}if(this.nextY>=this.editor.frames.height){return false}return true}};var MobileImport=function(){this.editor=null;this.colors=[];this.bgColors=[];this.characters=[];this.colorScores=[];this.blankCharacter=false;this.blockCharacter=false;this.useMultipleBGColors=false;this.backgroundColorChoose="auto";this.vectorTileCanvas=null;this.vectorTileContext=null;this.vectorTileImageData=null;this.canvas=null;this.context=null;this.imageData=null;this.colorDist=a;var s=.2126,o=.7152,l=.0722;function e(e,t,i){return Math.sqrt(s*e*e+o*t*t+l*i*i)}var t=255,i=255,r=255;var n=Math.sqrt(s*t*t+o*i*i+l*r*r);function a(e,t){var i=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return Math.sqrt(s*i*i+o*r*r+l*a*a)/n}var h=s*t+o*i+l*r;function d(e,t){var i=Math.abs(t[0]-e[0]),r=Math.abs(t[1]-e[1]),a=Math.abs(t[2]-e[2]);return(s*i+o*r+l*a)/h}};MobileImport.prototype={init:function(e){this.editor=e;this.charactersHasSpace=true;this.charactersHasBlock=true;this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d")},setColors:function(e){this.colors=[];for(var t=0;t<e.length;t++){this.colors.push(e[t])}},setBGColors:function(e){this.bgColors=[];for(var t=0;t<e.length;t++){this.bgColors.push(e[t])}},setBackgroundColorChoose:function(e){this.backgroundColorChoose=e},setCharacters:function(e){var t=this.editor.tileSetManager;var i=t.getCurrentTileSet();var r=i.getTileWidth();var a=i.getTileHeight();this.blankCharacter=false;this.blockCharacter=false;if(i.getType()=="vector"){this.blankCharacter=i.getBlankTile();this.blockCharacter=i.getBlockTile()}this.characters=[];for(var s=0;s<e.length;s++){this.characters.push(e[s]);if(i.getType()=="vector"){if(this.blockCharacter===false){var o=true;for(var l=0;l<a;l++){for(var n=0;n<r;n++){var h=i.getPixel(e[s],n,l);if(h==0){o=false;l=a;break}}}if(o==true){this.blockCharacter=e[s]}}if(this.blankCharacter===false){var d=true;for(var l=0;l<a;l++){for(var n=0;n<r;n++){var h=i.getPixel(e[s],n,l);if(h>0){d=false;l=a;break}}}if(d==true){this.blankCharacter=e[s]}}}}this.initCharSet()},initCharSet:function(){var e=this.editor.tileSetManager.getCurrentTileSet();if(e.getType()=="vector"){this.initCharSetVector();return}var t=e.getTileWidth();var i=e.getTileHeight();this.weights=[];var r=t*i;for(var a=0;a<=r;a++){this.weights[a]=[]}for(var a=0;a<this.characters.length;a++){var s=this.characters[a];var o=[];var l=[];var n=0;if(s!==false){for(var h=0;h<i;h++){l[h]=0;for(var d=0;d<t;d++){if(h==0){o[d]=0}if(e.getPixel(s,d,h)){n++;l[h]++;o[d]++}}}this.weights[n].push({c:s,hWeights:l,vWeights:o})}}},initCharSetVector:function(){console.log("init char set vector");var e=this.editor.tileSetManager.getCurrentTileSet();var t=e.getTileWidth();var i=e.getTileHeight();if(this.vectorTileCanvas==null){this.vectorTileCanvas=document.createElement("canvas")}if(this.vectorTileCanvas.width!=t||this.vectorTileCanvas.height!=i||this.vectorTileContext==null){this.vectorTileCanvas.width=t;this.vectorTileCanvas.height=i;this.vectorTileContext=this.vectorTileCanvas.getContext("2d")}this.vectorTileContext.clearRect(0,0,this.vectorTileCanvas.width,this.vectorTileCanvas.height);this.weights=[];var r=t*i;for(var a=0;a<=r;a++){this.weights[a]=[]}for(var a=0;a<this.characters.length;a++){var s=this.characters[a];var o=[];var l=[];var n=0;if(s!==false){var h=e.getGlyphPath(s);if(h!==null){var d=e.getFontScale();var c=t*d;var f=e.getFontAscent();var u=0;var p=0;this.vectorTileContext.clearRect(0,0,this.vectorTileCanvas.width,this.vectorTileCanvas.height);this.vectorTileContext.setTransform(c,0,0,-c,u,p+f*c);this.vectorTileContext.fillStyle="#ffffff";this.vectorTileContext.fill(h);this.vectorTileContext.setTransform(1,0,0,1,0,0)}this.vectorTileImageData=this.vectorTileContext.getImageData(0,0,this.vectorTileCanvas.width,this.vectorTileCanvas.height);for(var v=0;v<i;v++){l[v]=0;for(var g=0;g<t;g++){var m=(g+v*t)*4;if(v==0){o[g]=0}if(this.vectorTileImageData.data[m]>100){n++;l[v]++;o[g]++}}}this.weights[n].push({c:s,hWeights:l,vWeights:o})}}},findChar:function(e,t,i){var r=9999999;var a=0;var s=0;var o=0;var l=0;var n=0;for(n=e;n<this.weights.length;n++){if(this.weights[n].length>0){for(o=0;o<this.weights[n].length;o++){s++;var h=0;var d=this.weights[n][o].vWeights;var c=this.weights[n][o].hWeights;for(l=0;l<t.length;l++){h+=Math.abs(t[l]-d[l]);h+=Math.abs(i[l]-c[l])}if(h<r&&this.weights[n][o].c!==false){r=h;a=this.weights[n][o].c}}}if(s>10){break}}s=0;for(n=e-1;n>=0;n--){if(this.weights[n].length>0){for(o=0;o<this.weights[n].length;o++){s++;var h=0;var d=this.weights[n][o].vWeights;var c=this.weights[n][o].hWeights;for(var l=0;l<t.length;l++){h+=Math.abs(t[l]-d[l]);h+=Math.abs(i[l]-c[l])}if(h<r&&this.weights[n][o].c!==false){r=h;a=this.weights[n][o].c}}}if(s>10){break}}return a},setupColorPalette:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();this.colorMap={};this.paletteRGB=[];this.paletteI32=[];if(!this.useMultipleBGColors){var t=this.editor.layers.getSelectedLayerObject();if(t&&t.getType()=="grid"){if(this.bgColors.length>0){t.setBackgroundColor(this.bgColors[0]);this.editor.updateBackgroundColorPicker()}}}for(var i=0;i<this.colors.length;i++){var r=e.getHex(this.colors[i]);var a=r>>16&255;var s=r>>8&255;var o=r&255;this.paletteRGB.push([a,s,o]);var l=255<<24|o<<16|s<<8|a;this.paletteI32.push(l);this.colorMap["#"+l]=this.colors[i];if(this.colors[i]==this.bgColorIndex){this.bgColorPaletteIndex=i}}},nearestColorIndex:function(e){var t=1e3;var i=0;var r=[e&255,(e&65280)>>8,(e&16711680)>>16];var a=this.paletteRGB.length;for(var s=0;s<a;s++){var o=this.colorDist(r,this.paletteRGB[s]);if(o<t){t=o;i=s}}return i},importImageData:function(e,t){var i=getTimestamp();var r=this.editor.layers.getSelectedLayerObject();if(!r||r.getType()!="grid"){return}var a=this.editor.tileSetManager.getCurrentTileSet();var s=r.getCellWidth();var o=r.getCellHeight();var l=r.getGridHeight();var n=r.getGridWidth();var h=e.width;var d=e.height;this.canvas.width=n*s;this.canvas.height=l*o;this.context=this.canvas.getContext("2d");this.imageData=e;this.bgColorIndex=r.getBackgroundColor();this.setupColorPalette();var c=0;var f=false;var u=0;for(var p=0;p<this.colors.length;p++){if(this.colors[p]==this.bgColorIndex){u=p;break}}for(var p=0;p<this.colors.length;p++){if(p!=this.bgColorIndex&&this.bgColorIndex!==false&&this.bgColorIndex>=0){var v=this.colorDist(this.paletteRGB[u],this.paletteRGB[p]);if(f===false||v<f){f=v;c=p}}}var g=this.colorMap;var m=this.paletteRGB;var y=this.paletteI32;var b=null;var C=new Uint8Array(e.data);var x=new Uint32Array(C.buffer);var S=new Uint32Array(x.length);var P=0;var w=0;var I=0;var k=0;var M=0,T=0;var D=0;var E=0;var $=0;var _=0;var B=[0,0,0];for(P=0;P<l;P++){for(w=0;w<n;w++){I=P*o*h+w*s;var R={};for(T=0;T<o;T++){for(M=0;M<s;M++){k=I+M+T*h;_=x[k];if(_ in R){R[_]++}else{R[_]=1}}}var A=this.sortedHashKeys(R,true);var F=A.length;var L=[];var U=[];var H=[];var O=false;var G=false;var z=false;var N=false;var W=false;var X=false;if(F>0){var Y=this.nearestColorIndex(A[0]);O=Y;G=m[Y];z=y[Y];if(this.useMultipleBGColors){for(var p=1;p<A.length;p++){Y=this.nearestColorIndex(A[p]);if(Y!==O){N=Y;W=m[Y];X=y[Y];break}}}else{if(O==this.bgColorPaletteIndex){if(A.length>1){Y=this.nearestColorIndex(A[1]);O=Y;G=m[Y];z=y[Y]}else{O=c;G=m[c];z=y[c]}}N=this.bgColorPaletteIndex;if(typeof N=="undefined"||N===false||N>=m.length){N=0}W=m[N];X=y[N]}}else{}var V=[];var q=[];totalWeight=0;if(N===false){}else{var j={};for(T=0;T<o;T++){$=0;for(M=0;M<s;M++){if(T===0){V.push(0)}k=I+M+T*h;_=x[k];B[0]=_&255;B[1]=(_&65280)>>8;B[2]=(_&16711680)>>16;D=this.colorDist(B,G);E=this.colorDist(B,W);if(D<E){$++;totalWeight++;V[M]++;S[k]=255}else{S[k]=0}}q.push($)}}if(X===false){X=z}var K=this.findChar(totalWeight,V,q);var Z={};Z.t=K;Z.x=w;Z.y=P;Z.z=0;Z.fc=this.colorMap["#"+z];Z.bc=this.editor.colorPaletteManager.noColor;if(this.useMultipleBGColors){Z.bc=this.colorMap["#"+X]}Z.rx=0;Z.ry=0;Z.rz=0;Z.update=false;if(t){if(Z.fc==Z.bc||Z.t===this.blockCharacter||Z.t===this.blankCharacter){}else{if(Z.bc!=this.editor.colorPaletteManager.noColor){this.colorScores[Z.bc]++}}}else{r.setCell(Z)}}}var J=getTimestamp();var Q=J-i},findBGColor:function(e){var t=0;this.bgColors=[];for(var i=0;i<this.colors.length;i++){if(this.colors[i]>t){t=this.colors[i]}this.bgColors.push(this.colors[i])}this.colorScores=[];for(var i=0;i<=t;i++){this.colorScores[i]=0}this.useMultipleBGColors=true;this.importImageData(e,true);this.useMultipleBGColors=false;var r=0;var a=0;for(var i=0;i<this.colorScores.length;i++){if(this.colorScores[i]>a){r=i;a=this.colorScores[i]}}this.bgColors=[];this.bgColors.push(r);var s=this.editor.layers.getSelectedLayerObject();if(!s||s.getType()!="grid"){return}s.setBackgroundColor(r)},setImageData:function(e){if(!this.useMultipleBGColors&&this.backgroundColorChoose=="auto"){this.findBGColor(e)}this.importImageData(e,false)},setUseMultipleBGColors:function(e){this.useMultipleBGColors=e},initColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();this.colorsRGB=[];this.colorsLABA=[];for(var t=0;t<e.getColorCount();t++){var i=e.getHex(t);var r=i>>16&255;var a=i>>8&255;var s=i&255;var o={};o.values=[r,a,s,255];o=Colour.converters[Colour.RGBA][Colour.LABA](o);this.colorsRGB[t]=[r,a,s];this.colorsLABA[t]=[o.values[0],o.values[1],o.values[2]]}},imageDataToLABA:function(){this.imageDataLABA=[];var e=[];var t={};for(var i=0;i<this.imageData.data.length;i+=4){e[0]=this.imageData.data[i];e[1]=this.imageData.data[i+1];e[2]=this.imageData.data[i+2];e[3]=this.imageData.data[i+3];t.values=e;t=Colour.converters[Colour.RGBA][Colour.LABA](t);this.imageDataLABA[i]=t.values[0];this.imageDataLABA[i+1]=t.values[1];this.imageDataLABA[i+2]=t.values[2];this.imageDataLABA[i+3]=this.imageData.data[i+3]}},sortedHashKeys:function(i,r){var e=[];for(var t in i)e.push(t);return e.sort(function(e,t){return r?i[t]-i[e]:i[e]-i[t]})},startImport:function(){this.initColors();this.nextX=0;this.nextY=0},getProgress:function(){return"("+this.nextX+","+this.nextY+")"},update:function(){}};var ShaderImport2=function(){this.editor=null;this.colors=[];this.bgColors=[];this.characters=[];this.backgroundColorChoose="auto";this.useMultipleBGColors=false;this.srcCanvas=null;this.charCanvas=null;this.colorCanvas=null;this.vectorTileCanvas=null;this.vectorTileContext=null;this.vectorTileImageData=null;this.shader="\r\n\r\nuniform sampler2D inputImage;\r\nuniform sampler2D charImage;\r\nuniform sampler2D colorImage;\r\nuniform vec3 fgColor;\r\nuniform vec4 bgColor;\r\nuniform int charCount;\r\nuniform float inputImageWidth;\r\nuniform float inputImageHeight;\r\nuniform float inputImageCols;\r\nuniform float inputImageRows;\r\nuniform float outputImageWidth;\r\nuniform float outputImageHeight;\r\n\r\n\r\nvarying vec2 vUv;\r\n\r\n\r\nvec3 RGB2Lab(vec3 rgb){\r\n    float R = rgb.x;\r\n    float G = rgb.y;\r\n    float B = rgb.z;\r\n    // threshold\r\n    float T = 0.008856;\r\n\r\n    float X = R * 0.412453 + G * 0.357580 + B * 0.180423;\r\n    float Y = R * 0.212671 + G * 0.715160 + B * 0.072169;\r\n    float Z = R * 0.019334 + G * 0.119193 + B * 0.950227;\r\n\r\n    // Normalize for D65 white point\r\n    X = X / 0.950456;\r\n    Y = Y;\r\n    Z = Z / 1.088754;\r\n\r\n    bool XT, YT, ZT;\r\n    XT = false; YT=false; ZT=false;\r\n    if(X > T) XT = true;\r\n    if(Y > T) YT = true;\r\n    if(Z > T) ZT = true;\r\n\r\n    float Y3 = pow(Y,1.0/3.0);\r\n    float fX, fY, fZ;\r\n    if(XT){ fX = pow(X, 1.0/3.0);} else{ fX = 7.787 * X + 16.0/116.0; }\r\n    if(YT){ fY = Y3; } else{ fY = 7.787 * Y + 16.0/116.0 ; }\r\n    if(ZT){ fZ = pow(Z,1.0/3.0); } else{ fZ = 7.787 * Z + 16.0/116.0; }\r\n\r\n    float L; if(YT){ L = (116.0 * Y3) - 16.0; }else { L = 903.3 * Y; }\r\n    float a = 500.0 * ( fX - fY );\r\n    float b = 200.0 * ( fY - fZ );\r\n\r\n    return vec3(L,a,b);\r\n}\r\n\r\n\r\nvec2 findCharacter(float x, float y, vec4 fgColorVec4, vec4 bgColorVec4) {\r\n\r\n//  float inputImageWidth = 512.0;\r\n//  float inputImageHeight = 256.0; \r\n  int character = 0;\r\n  float bestScore = 0.00;\r\n\r\n//  vec3 fgColorLAB = RGB2Lab(vec3(1.0, 1.0, 1.0));\r\n  vec3 fgColorLAB = RGB2Lab( vec3(fgColorVec4.x, fgColorVec4.y, fgColorVec4.z));\r\n  //vec3 bgColorLAB = RGB2Lab(vec3(bgColorVec4.x, bgColorVec4.y, bgColorVec4.z)); \r\n  vec3 bgColorLAB = RGB2Lab(vec3(bgColor.x, bgColor.y, bgColor.z));  \r\n\r\n  // loop through the top row\r\n  for(float i = 0.0; i < 256.0; i++) {\r\n      if(int(i) < charCount) {\r\n        float score = 0.0; \r\n        // loop through xy of input image, compare to character\r\n        for(int cy = 0; cy < {charHeight}; cy++) {\r\n          for(int cx = 0; cx < {charWidth}; cx++) {\r\n            float imageX = (x * {charWidth}.0 + float(cx)) / inputImageWidth;\r\n            float imageY = (inputImageHeight - 1.0 - y * {charHeight}.0 - float(cy)) / inputImageHeight;\r\n            vec4 imagePixel = texture2D(inputImage, vec2(imageX, imageY) );\r\n  \r\n            float charCol = mod(float(i), 16.0);\r\n            float charRow = floor(float(i) / 16.0);\r\n            float charImageHeight = 128.0;\r\n            float charImageWidth = 128.0; \r\n            \r\n            float charX = (charCol * {charWidth}.0 + float(cx)) / charImageWidth;\r\n            float charY = (charImageHeight - charRow * {charHeight}.0 - 1.0  - float(cy)) / charImageHeight;\r\n  //          float charY =   ({charHeight}.0 - 1.0 - float(cy)) / ({charHeight}.0 - 1.0);\r\n            vec4 charPixel = texture2D(charImage, vec2(charX, charY));\r\n  \r\n            vec3 imagePixelLAB = RGB2Lab(vec3(imagePixel.x, imagePixel.y, imagePixel.z));\r\n  \r\n            if(charPixel.x > 0.3) {\r\n    //          score = score + abs(imagePixel.x - fgColorVec4.x) + abs(fgColorVec4.y - 1.0) + abs(fgColorVec4.z - 1.0);\r\n              if(imagePixel.w < 0.4) {\r\n                  // its transparent\r\n                  score += 3.0;\r\n              } else {\r\n                score = score + abs(imagePixelLAB.x - fgColorLAB.x) + abs(imagePixelLAB.y - fgColorLAB.y) + abs(imagePixelLAB.z - fgColorLAB.z);\r\n              }\r\n  \r\n            } else {\r\n  //            score = score + abs(imagePixel.x - bgColor.x) + abs(imagePixel.y -bgColor.y) + abs(imagePixel.z -bgColor.z);\r\n\r\n              if(imagePixel.w < 0.3) {\r\n                // its transparent\r\n                if(bgColor.w == 0.0) {\r\n                  // good match..\r\n                  score += 0.0;\r\n                } else {\r\n                  score += 800.0;\r\n                }\r\n              } else {  \r\n                if(bgColor.w == 0.0) {\r\n                  score = score + 800.0;\r\n                } else {\r\n                  score = score + abs(imagePixelLAB.x - bgColorLAB.x) + abs(imagePixelLAB.y - bgColorLAB.y) + abs(imagePixelLAB.z  - bgColorLAB.z);\r\n                }\r\n              }\r\n  \r\n    /*\r\n              if(imagePixel.w == 0.0) {\r\n                score += 0.0;\r\n              } else {\r\n                score = score + abs(imagePixelLAB.x - bgColorLAB.x) + abs(imagePixelLAB.y - bgColorLAB.y) + abs(imagePixelLAB.z  - bgColorLAB.z);\r\n              }\r\n    */\r\n  \r\n            }\r\n   \r\n          }\r\n        }\r\n  \r\n  //      if(character < charCount) {\r\n          if(i == 0.0) {\r\n            bestScore = score;\r\n            character = int(i);\r\n          }\r\n          \r\n          \r\n          if(score < bestScore) {\r\n            character = int(i);\r\n            if(character < charCount) {\r\n              bestScore = score;\r\n            }\r\n          }\r\n    }\r\n//      }\r\n  }\r\n\r\n\r\n\r\n//character = int(y);\r\n  return vec2(float(character), bestScore);\r\n}\r\n\r\n\r\n// by default gl_FragCoord assumes lower left origin\r\n// and assumes pixel centers a located at half pixel centers\r\n// gl_FragCoord is in screen coordinates, not normalised \r\n\r\nvoid main() {\r\n\r\n  // gl_FragCoord.x goes 0.5, 1.5, 2.5, etc\r\n  float resultPosition =  floor(gl_FragCoord.x) + floor(gl_FragCoord.y)  * outputImageWidth;\r\n\r\n\r\n  // 16 colours\r\n  float colorPosition = floor(resultPosition / {shaderColors}.0);\r\n  float colorIndex = mod(resultPosition , {shaderColors}.0);\r\n  \r\n  float fgColorIndex = colorIndex;//mod(colorIndex, 16.0);\r\n  float bgColorIndex = 0.0;//floor(colorIndex / 16.0);\r\n  \r\n  vec4 fgColorVec4 = texture2D(colorImage, vec2(fgColorIndex / {shaderColors}.0, \r\n          ({shaderColors}.0 - 0.5) / {shaderColors}.0));\r\n  vec4 bgColorVec4 = texture2D(colorImage, vec2(bgColorIndex / {shaderColors}.0,\r\n          ({shaderColors}.0 - 0.5) / {shaderColors}.0));\r\n          \r\n  float sourceCol = mod(colorPosition , inputImageCols);\r\n  float sourceRow = floor(colorPosition / inputImageCols);\r\n  \r\n  vec2 result = vec2(0,0);\r\n  \r\n  result =  findCharacter(sourceCol, sourceRow, fgColorVec4, bgColorVec4);\r\n  float character = result.x / 255.0;\r\n   \r\n \r\n  float score = result.y / 256.0;\r\n  float scoreL = fract(score); \r\n  float scoreH = floor(score) / 256.0;\r\n\r\n//  gl_FragColor = vec4(gl_FragCoord.x / 255.0, scoreL, scoreH, 1.0);\r\n\r\n//  gl_FragColor = vec4(inputImageCols / 255.0, 2.0, 3.0, 4.0);\r\n  gl_FragColor = vec4(character, scoreL, scoreH, 1.0);\r\n\r\n}\r\n\r\n      \r\n      \r\n\r\n      ";this.vertexShader=["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n");this.debug=false};ShaderImport2.prototype={init:function(e){this.editor=e;this.charactersHasSpace=true;this.charactersHasBlock=true},setColors:function(e){var t=this.editor.colorPaletteManager.noColor;this.colors=[];for(var i=0;i<e.length;i++){if(e[i]!=="noColor"){this.colors.push(e[i])}}},setBGColors:function(e){this.bgColors=[];for(var t=0;t<e.length;t++){this.bgColors.push(e[t])}},setBackgroundColorChoose:function(e){this.backgroundColorChoose=e},setCharacters:function(e){var t=this.editor.tileSetManager;var i=t.getCurrentTileSet();if(i.getType()=="vector"){this.blankCharacter=i.getBlankTile();this.blockCharacter=i.getBlockTile()}var r=i.getTileWidth();var a=i.getTileHeight();this.blankCharacter=false;this.blockCharacter=false;this.characters=[];for(var s=0;s<e.length;s++){this.characters.push(e[s]);if(this.blockCharacter===false){var o=true;for(var l=0;l<a;l++){for(var n=0;n<r;n++){var h=i.getPixel(e[s],n,l);if(h==0){o=false;l=a;break}}}if(o==true){this.blockCharacter=e[s]}}if(this.blankCharacter===false){var d=true;for(var l=0;l<a;l++){for(var n=0;n<r;n++){var h=i.getPixel(e[s],n,l);if(h>0){d=false;l=a;break}}}if(d==true){this.blankCharacter=e[s]}}}},setSrcCanvas:function(e){this.srcCanvas=e},setUseMultipleBGColors:function(e){this.useMultipleBGColors=e},setShaderCode:function(e){this.shader=e},startImport:function(){},setupRenderTarget:function(e,t){var i=this.editor.tileSetManager.getCurrentTileSet();if(this.renderTarget&&this.renderTargetWidth==e&&this.renderTargetHeight==t){return}this.renderTargetWidth=e;this.renderTargetHeight=t;if(!this.renderTargetScene){this.renderTargetScene=new THREE.Scene}if(this.renderTargetQuad){this.renderTargetScene.remove(this.renderTargetQuad)}this.renderTarget=new THREE.WebGLRenderTarget(this.renderTargetWidth,this.renderTargetHeight,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});this.renderTargetPixels=new Uint8Array(this.renderTargetWidth*this.renderTargetHeight*4);var r=.5;var a=1e3;this.renderTargetCamera=new THREE.OrthographicCamera(-this.renderTargetWidth/2,this.renderTargetWidth/2,this.renderTargetHeight/2,-this.renderTargetHeight/2,r,a);this.renderTargetCamera.position.z=400;var s;var o;var l=this.shader;l=l.replace(/{charWidth}/g,i.charWidth);l=l.replace(/{charHeight}/g,i.charHeight);this.renderTargetMaterial=new THREE.ShaderMaterial({uniforms:{inputImage:{type:"t",value:null},inputImageWidth:{type:"f",value:null},inputImageHeight:{type:"f",value:null},inputImageRows:{type:"f",value:null},inputImageCols:{type:"f",value:null},outputImageWidth:{type:"f",value:null},outputImageHeight:{type:"f",value:null},charImage:{type:"t",value:null},colorImage:{type:"t",value:null},fgColor:{type:"v4",value:new THREE.Vector3(0,0,0,1)},bgColor:{type:"v4",value:new THREE.Vector4(0,0,0,1)},charCount:{type:"i",value:32}},vertexShader:this.vertexShader,fragmentShader:l});this.renderTargetQuad=new THREE.Mesh(new THREE.PlaneGeometry(this.renderTargetWidth,this.renderTargetHeight),this.renderTargetMaterial);this.renderTargetQuad.position.z=0;this.renderTargetScene.add(this.renderTargetQuad);this.renderCanvas=document.createElement("canvas");this.renderCanvas.width=this.renderTargetWidth;this.renderCanvas.height=this.renderTargetHeight;this.renderContext=this.renderCanvas.getContext("2d");this.renderImageData=this.renderContext.getImageData(0,0,this.renderCanvas.width,this.renderCanvas.height)},plotCharacter:function(e,t,i){var r=this.editor.tileSetManager.getCurrentTileSet();if(r.getType()=="vector"){this.plotCharacterVector(e,t,i);return}var a=r.getData();var s=r.getTileHeight();var o=r.getTileWidth();for(var l=0;l<s;l++){for(var n=0;n<o;n++){var h=n+l*o;var d=(e*o+n+(t*s+l)*this.charImageData.width)*4;if(a[i][h]>0){this.charImageData.data[d]=255;this.charImageData.data[d+1]=255;this.charImageData.data[d+2]=255;this.charImageData.data[d+3]=255}else{this.charImageData.data[d]=0;this.charImageData.data[d+1]=0;this.charImageData.data[d+2]=0;this.charImageData.data[d+3]=255}}}},plotCharacterVector:function(e,t,i){var r=this.editor.tileSetManager.getCurrentTileSet();var a=r.getTileHeight();var s=r.getTileWidth();if(this.vectorTileCanvas==null){this.vectorTileCanvas=document.createElement("canvas")}if(this.vectorTileCanvas.width!=s||this.vectorTileCanvas.height!=a||this.vectorTileContext==null){this.vectorTileCanvas.width=s;this.vectorTileCanvas.height=a;this.vectorTileContext=this.vectorTileCanvas.getContext("2d")}this.vectorTileContext.clearRect(0,0,this.vectorTileCanvas.width,this.vectorTileCanvas.height);var o=r.getGlyphPath(i);if(o!==null){var l=r.getFontScale();var n=s*l;var h=r.getFontAscent();var d=0;var c=0;this.vectorTileContext.setTransform(n,0,0,-n,d,c+h*n);this.vectorTileContext.fillStyle="#ffffff";this.vectorTileContext.fill(o);this.vectorTileContext.setTransform(1,0,0,1,0,0)}this.vectorTileImageData=this.vectorTileContext.getImageData(0,0,this.vectorTileCanvas.width,this.vectorTileCanvas.height);for(var f=0;f<a;f++){for(var u=0;u<s;u++){var p=(u+f*s)*4;var v=(e*s+u+(t*a+f)*this.charImageData.width)*4;if(this.vectorTileImageData.data[p]>100){this.charImageData.data[v]=255;this.charImageData.data[v+1]=255;this.charImageData.data[v+2]=255;this.charImageData.data[v+3]=255}else{this.charImageData.data[v]=0;this.charImageData.data[v+1]=0;this.charImageData.data[v+2]=0;this.charImageData.data[v+3]=255}}}this.vectorTileImageData=null},canvasToCharacters:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return}var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=this.editor.tileSetManager.getCurrentTileSet();var a=32;var s=16;var o=r.getTileWidth();var l=r.getTileHeight();var n=40;var h=25;var d=16;var c=16;if(!this.useMultipleBGColors&&this.bgColors.length>0){for(var f=0;f<this.colors.length;f++){var u=false;if(this.colors[f]==this.bgColors[f]){u=f;break}}if(u!==false){this.colors.splice(u,1)}}var p=this.colors.length;if(p>16){s=32;d=32;c=32;n=20}this.importColorUtils=new ImportColorUtils;this.importColorUtils.init(this.editor);var v=t.getGridWidth();var g=t.getGridHeight();this.result=[];for(var m=0;m<g;m++){this.result[m]=[];for(var y=0;y<v;y++){this.result[m][y]={character:this.editor.tileSetManager.blankCharacter,color:0,score:false}}}var b=[];for(var f=0;f<i.getColorCount();f++){b.push(i.getHex(f))}var C=128;this.setupRenderTarget(C,C);var x=n*o;var S=x;var P=h*l;var w=P;if(S<=512){S=512}else if(S<=1024){S=1024}else if(S<=2048){S=2048}else if(S<=4096){S=4096}if(w<=512){w=512}else if(w<=1024){w=1024}else if(width<=2048){w=2048}else if(w<=4096){w=4096}if(!this.importCanvas){this.importCanvas=document.createElement("canvas")}this.importContext=this.importCanvas.getContext("2d");this.importCanvas.width=S;this.importCanvas.height=w;this.inputTexture=new THREE.Texture(this.importCanvas);this.inputTexture.minFilter=THREE.NearestFilter;this.inputTexture.magFilter=THREE.NearestFilter;this.imageData=this.importContext.getImageData(0,0,this.importCanvas.width,this.importCanvas.height);if(!this.colorCanvas){this.colorCanvas=document.createElement("canvas");if(this.debug){document.body.appendChild(this.colorCanvas);this.colorCanvas.style.position="absolute";this.colorCanvas.style.top="10px";this.colorCanvas.style.left="700px"}}this.colorCanvas.width=d;this.colorCanvas.height=c;this.colorContext=this.colorCanvas.getContext("2d");this.colorContext.clearRect(0,0,this.colorCanvas.width,this.colorCanvas.height);this.colorImageData=this.colorContext.getImageData(0,0,this.colorCanvas.width,this.colorCanvas.height);for(var f=0;f<p;f++){var I=this.colors[f];var k=i.getHex(I);this.colorImageData.data[f*4]=k>>16&255;this.colorImageData.data[f*4+1]=k>>8&255;this.colorImageData.data[f*4+2]=k&255;this.colorImageData.data[f*4+3]=255}this.colorContext.putImageData(this.colorImageData,0,0);this.colorTexture=new THREE.Texture(this.colorCanvas);this.colorTexture.minFilter=THREE.NearestFilter;this.colorTexture.magFilter=THREE.NearestFilter;this.colorTexture.needsUpdate=true;if(!this.charCanvas){this.charCanvas=document.createElement("canvas");if(this.debug){document.body.appendChild(this.charCanvas);this.charCanvas.style.position="absolute";this.charCanvas.style.top="10px";this.charCanvas.style.left="805px"}}var M=16;var T=16;this.charCanvas.width=o*M;this.charCanvas.height=l*T;this.charContext=this.charCanvas.getContext("2d");this.charImageData=this.charContext.getImageData(0,0,this.charCanvas.width,this.charCanvas.height);var D=Math.ceil(this.characters.length/M);for(var E=0;E<D;E++){var $=E*M;var _=M;if($+_>this.characters.length){_=this.characters.length-$}for(var B=0;B<_;B++){this.plotCharacter(B,E,this.characters[B+$])}}this.charContext.putImageData(this.charImageData,0,0);this.charTexture=new THREE.Texture(this.charCanvas);this.charTexture.minFilter=THREE.NearestFilter;this.charTexture.magFilter=THREE.NearestFilter;this.charTexture.needsUpdate=true;var R=this.shader;R=R.replace(/{charWidth}/g,r.charWidth);R=R.replace(/{charHeight}/g,r.charHeight);R=R.replace(/{shaderColors}/g,s);this.renderTargetMaterial.fragmentShader=R;this.renderTargetMaterial.uniforms.inputImage.value=this.inputTexture;this.renderTargetMaterial.uniforms.inputImageWidth.value=S;this.renderTargetMaterial.uniforms.inputImageHeight.value=w;this.renderTargetMaterial.uniforms.inputImageCols.value=n;this.renderTargetMaterial.uniforms.inputImageRows.value=h;this.renderTargetMaterial.uniforms.outputImageWidth.value=C;this.renderTargetMaterial.uniforms.outputImageHeight.value=C;this.renderTargetMaterial.uniforms.charImage.value=this.charTexture;this.renderTargetMaterial.uniforms.colorImage.value=this.colorTexture;this.renderTargetMaterial.uniforms.charCount.value=this.characters.length;var A=Math.ceil(v/n);var F=Math.ceil(g/h);for(var L=0;L<A;L++){for(var U=0;U<F;U++){var H=L*x;var O=U*P;var G=x;var z=P;this.importContext.clearRect(0,0,G,z);this.importContext.drawImage(e,H,O,G,z,0,0,G,z);this.inputTexture.needsUpdate=true;var N=this.bgColors.length;for(var W=-1;W<N;W++){var X=W;if(W>=0&&W<N){var X=this.bgColors[W];var Y=b[X];this.renderTargetMaterial.uniforms.bgColor.value.set((Y>>16&255)/255,(Y>>8&255)/255,(Y&255)/255,1)}else{this.renderTargetMaterial.uniforms.bgColor.value.set(0,0,0,0)}this.renderTargetMaterial.needsUpdate=true;UI.renderer.setRenderTarget(this.renderTarget);UI.renderer.render(this.renderTargetScene,this.renderTargetCamera);UI.renderer.readRenderTargetPixels(this.renderTarget,0,0,this.renderTargetWidth,this.renderTargetHeight,this.renderTargetPixels);UI.renderer.setRenderTarget(null);var V=this.renderTargetPixels;var q=n*L;var j=h*U;for(var f=0;f<V.length;f+=4){if(f<h*n*4*s){var K=f/4;var Z=Math.floor(K/s);var I=K%s;if(I<p){var J=this.colors[I];var Q=Z%n;var ee=Math.floor(Z/n);var te=ee+j;var ie=Q+q;if(ie<v&&te<g){var re=V[f+1]+V[f+2]*256;if(this.result[te][ie].score===false||re<this.result[te][ie].score){if(V[f]<this.characters.length){this.result[te][ie].character=this.characters[V[f]];this.result[te][ie].color=J;this.result[te][ie].bgColor=X;this.result[te][ie].score=re}}}}}}}}}return this.result},findBGColor:function(){this.saveBGColors=[];for(var e=0;e<this.bgColors.length;e++){this.saveBGColors.push(this.bgColors[e])}var t=[];var i=0;this.bgColors=[];for(var e=0;e<this.colors.length;e++){if(this.colors[e]>i){i=this.colors[e]}this.bgColors.push(this.colors[e]);t.push(this.colors[e])}this.canvasToCharacters(this.srcCanvas);this.colors=[];for(var e=0;e<t.length;e++){this.colors.push(t[e])}var r=[];for(var e=0;e<=i;e++){r[e]=0}for(var a=0;a<this.result.length;a++){for(var s=0;s<this.result[a].length;s++){var o=this.result[a][s].character;var l=this.result[a][s].color;var n=this.result[a][s].bgColor;if(l==n||o===this.blockCharacter||o===this.blankCharacter){}else{r[l]++;if(n!=this.editor.colorPaletteManager.noColor){r[n]++}}}}var h=0;var d=0;for(var e=0;e<r.length;e++){if(r[e]>d){h=e;d=r[e]}}this.bgColors=[];this.bgColors.push(h)},convert:function(){if(!this.useMultipleBGColors&&this.backgroundColorChoose=="auto"){this.findBGColor()}this.canvasToCharacters(this.srcCanvas)},getResult:function(){return this.result},updateFrame:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return}var t=e.getGridWidth();var i=e.getGridHeight();if(!this.useMultipleBGColors){if(this.backgroundColorChoose=="auto"){if(this.bgColors.length>0){e.setBackgroundColor(this.bgColors[0]);this.editor.updateBackgroundColorPicker()}}}var r=e.getBackgroundColor();var a={};a.update=false;for(a.y=0;a.y<this.result.length;a.y++){for(a.x=0;a.x<this.result[a.y].length;a.x++){a.t=this.result[a.y][a.x].character;a.fc=this.result[a.y][a.x].color;a.bc=this.result[a.y][a.x].bgColor;if(this.useMultipleBGColors){if(a.fc==a.bc){if(this.blankCharacter!==false){a.t=this.blankCharacter}}if(a.bc==this.editor.colorPaletteManager.noColor&&a.t===this.blockCharacter){a.bc=this.bgColors[0]}e.setCell(a)}else{if(a.fc===r){if(this.blankCharacter!==false){a.t=this.blankCharacter}}a.bc=this.editor.colorPaletteManager.noColor;e.setCell(a)}}}this.editor.graphic.redraw()}};var ImportImage=function(){this.editor=null;this.importColorUtils=null;this.importSource="image";this.imageLib=null;this.multipleBackgroundColors=false;this.basicImport=null;this.mobileImport=null;this.srcCanvas=null;this.srcContext=null;this.scrollbar2=null;this.scrollbar1=null;this.scrollbar3=null;this.scrollbar4=null;this.rangeCanvas=null;this.cacheCanvas=null;this.cacheContext=null;this.cacheImageX=false;this.cacheImageY=false;this.cacheDrawWidth=false;this.cacheDrawHeight=false;this.cacheScale=false;this.cacheCrosshairX=false;this.cacheCrosshairY=false;this.cacheRotateAmount=0;this.disableCache=false;this.imageCanvasScale=0;this.imageCanvas=null;this.imageContext=null;this.progressCanvas=null;this.progressContext=null;this.importImageCanvas=null;this.importImageContext=null;this.importImage=null;this.importVideo=null;this.importingVideo=false;this.videoFrameReady=false;this.firstVideoFrame=true;this.imageData=null;this.importInProgress=false;this.frameImportInProgress=false;this.frameCount=20;this.videoSampleEvery=400;this.videoStartAt=0;this.importWidth=320;this.importHeight=200;this.imageScale=100;this.importImageAnimate=false;this.zoomAmount=100;this.currentZoom=100;this.brightnessDelta=0;this.contrastDelta=0;this.saturationDelta=0;this.previewNeedsUpdate=false;this.importImageMobile=null;this.useColors="all";this.maxColors=16;this.frame=0;this.rotateDelta=30;this.rotateAmount=0;this.imageColors=[];this.bgColors=[];this.customTileSet=[];this.customColorSet=[];this.brightness=0;this.contrast=0;this.saturation=0;this.hue=0;this.useShader=true;this.useMobile=false;this.renderTargetWidth=false;this.renderTargetHeight=false;this.renderTarget=null;this.renderTargetScene=null;this.renderTargetCamera=null;this.renderTargetMaterial=null;this.renderTargetQuad=null;this.renderCanvas;this.renderContext;this.renderImageData;this.importCanvas=null;this.charCanvas=null;this.importColorPalette=[];this.createPaletteColorCount=16;this.currentColorCount=false;this.previewAnimation=false;this.lastPreviewUpdate=0;this.ticksPerFrame=6;this.uiComponent=null;this.mouseIsDown=false;this.mirrorEffect=null;this.rotateZoomEffect=null;this.slitscanEffect=null;this.noiseEffect=null;this.imageParametersEffect=null;this.shaderEffects=null;this.shaderEffectsList=[];this.edgeDetect=false;this.insertFrames=false;this.colorReductionMethod="dither";this.ditherThreshold=0;this.visible=false;this.imageSmoothing=false;this.invertColors=false;this.importImageScale=100;this.imageX=0;this.imageY=0;this.backgroundColorType="perCell";this.mouseInPreview=false;this.midPointX=false;this.midPointY=false;this.chromaKeyEnabled=false;this.chromaChooseColor=false;this.importEffects=[{name:"Chroma Key",type:"shadereffect",enabled:false,params:{r:{name:"Red",value:0},g:{name:"Green",value:0},b:{name:"Blue",value:0}}},{name:"Pan",enabled:false,type:"rotatezoom",params:{h:{name:"Horizontal",value:0,animated:true},v:{name:"Vertical",value:0,animated:true}}},{name:"Zoom",enabled:false,type:"rotatezoom",params:{direction:{name:"Direction",type:"options",options:["In","Out"],value:"In"},amountX:{name:"Amount X (%)",value:1e3},amountY:{name:"Amount Y (%)",value:1e3},infinite:{name:"Infinite Zoom",value:false,type:"checkbox"},layerAngleSeparation:{name:"Layer Angle Separation",value:0}}},{name:"Rotate",enabled:false,type:"rotatezoom",params:{direction:{name:"Direction",type:"options",options:["Clockwise","Anticlockwise","Wiggle"],value:"Clockwise"},wiggleAmount:{name:"Wiggle Amount",value:15}}},{name:"Slitscan",enabled:false,type:"slitscan",params:{slice:{name:"Slice",type:"options",options:["Horizontal","Vertical"],value:"Vertical"},sliceCount:{name:"Slice Count",value:15}}},{name:"Mirror",enabled:false,type:"mirror",params:{flip:{name:"Flip",type:"multioptions",options:["Horizontal","Vertical"]},mirror:{name:"Mirror",type:"multioptions",options:["Horizontal","Vertical"]}}},{name:"Brightness",enabled:false,type:"imageparams",params:{amount:{name:"Amount",value:1,animated:true}}},{name:"Contrast",enabled:false,type:"imageparams",params:{amount:{name:"Amount",value:1,animated:true}}},{name:"Saturation",type:"shadereffect",type:"imageparams",enabled:false,params:{amount:{name:"Amount",value:1,animated:true}}},{name:"Hue/Saturation",type:"shadereffect",enabled:false,params:{}},{name:"Wobble",type:"shadereffect",enabled:false,params:{strength:{name:"Strength",type:"range",min:0,max:.1,value:10},size:{name:"Size",type:"range",min:0,max:30,value:16}}},{name:"Colour Cycle",type:"shadereffect",enabled:false,params:{amount:{name:"Amount",type:"range",min:.1,max:1,value:5},offset:{name:"Offset",type:"range",min:0,max:2,value:0}}},{name:"Plasma",type:"shadereffect",enabled:false,params:{scale:{name:"Scale",value:10},amount:{name:"Amount",type:"range",value:50,min:0,max:1}}},{name:"Pixelate",type:"shadereffect",enabled:false,params:{initialX:{name:"Initial X",value:10},amountX:{name:"Amount X",value:0,animated:true},initialY:{name:"Initial Y",value:10},amountY:{name:"Amount Y",value:0,animated:true}}},{name:"Polar Pixelate",type:"shadereffect",enabled:false,params:{initialCircles:{name:"Initial Circles",type:"range",min:0,max:1,value:10},amountCircles:{name:"Amount Circles",value:0,animated:true},initialSlices:{name:"Initial Slices",type:"range",min:0,max:1,value:10},amountSlices:{name:"Amount Slices",value:0,animated:true}}},{name:"Hexagonal Pixelate",type:"shadereffect",enabled:false,params:{initial:{name:"Initial Value",value:10,type:"range",min:0,max:80},amount:{name:"Amount",value:0,animated:true}}},{name:"Diffusion",type:"shadereffect",enabled:false,params:{initial:{name:"Initial Value",value:10,type:"range",min:0,max:.4},amount:{name:"Amount",value:0,animated:true}}},{name:"Noise",enabled:false,type:"noise",params:{amount:{name:"Amount",value:30},density:{name:"Density",value:75}}}]};ImportImage.prototype={init:function(e){this.editor=e;this.importColorUtils=new ImportColorUtils;this.importColorUtils.init(this.editor);this.imageLib=new ImageLib},effectsHTML:function(){var e="";for(var t=0;t<this.importEffects.length;t++){var i=this.importEffects[t].name;if(i!="Chroma Key"){if(i=="Hue/Saturation"){i="Hue"}e+='<div class="importEffectContainer">';e+="  <div>";e+='    <label class="cb-container">';e+=i;e+='<input type="checkbox" id="importEffectCheckbox_'+t+'" class="importEffectCheckbox" data-effectId="'+t+'"/>';e+='<span class="checkmark"></span>';e+="</label>";e+="  </div>";e+='<div id="importEffectParams_'+t+'" class="importEffectParamsContainer" style="display: none">';var r=this.importEffects[t].params;for(var a in r){if(r.hasOwnProperty(a)){var s="number";var o=r[a];if(typeof o.type!="undefined"){s=o.type}e+='<div class="formRow">';e+='<label class="controlLabel" for="importEffect_'+t+"_param_"+a+'">'+o.name+"</label>";var l=0;if(typeof o.value!="undefined"){l=o.value}if(s=="number"){e+='<input type="text" class="number importEffectNumberParam" size="4" data-effectId="'+t+'" data-paramId="'+a+'" id="importEffect_'+t+"_param_"+a+'" value="'+l+'"/>'}if(s=="range"){e+='<input type="text" class="number importEffectNumberParam" size="4" ';if(typeof o.min!="undefined"){e+=' min="0" '}if(typeof o.max!="undefined"){e+=' max="100" '}e+=' data-effectId="'+t+'" data-paramId="'+a+'" id="importEffect_'+t+"_param_"+a+'" value="'+l+'"/>'}if(s=="checkbox"){e+='    <label class="cb-container">&nbsp;';e+='<input type="checkbox" class="importEffectCheckboxParam" data-effectId="'+t+'" id="importEffect_'+t+"_param_"+a+'" value="1"/>';e+='<span class="checkmark"></span>';e+="</label>"}if(s=="options"){e+='<div style="display: inline-block">';for(var n=0;n<o.options.length;n++){e+='<label class="rb-container">';e+=o.options[n];e+='<input type="radio" class="importEffectOptionsParam" data-effectId="'+t+'" value="'+o.options[n]+'" name="importEffect_'+t+"_param_"+a+'" ';if(o.options[n]==l){e+=' checked="checked" '}e+="/>";e+='<span class="checkmark"></span>';e+="</label>";e+="<br/>"}e+="</div>"}if(s=="multioptions"){e+='<div style="display: inline-block">';for(var n=0;n<o.options.length;n++){e+='    <label class="cb-container">';e+=o.options[n];e+='<input type="checkbox" name="importEffect_'+t+"_param_"+a+'" class="importEffectMultiOptionsParam" data-effectId="'+t+'" value="'+o.options[n]+'"/>';e+='<span class="checkmark"></span>';e+="</label>";e+="<br/>"}e+="</div>"}if(typeof o.animated!="undefined"&&o.animated){e+="&nbsp;";e+='<select class="importEffectNumberParam" data-effectId="'+t+'" data-paramId="'+a+'" id="importEffect_'+t+"_param_"+a+'_animateType">';e+='<option value="linear">Linear</option>';e+='<option value="sine">Sin</option>';e+='<option value="cosine">Cos</option>';e+='<option value="random">Random</option>';e+="</select>"}e+="</div>"}}e+="</div>";e+="</div>"}}$("#importImageEffectsHolder").html(e);UI.number.initControls("#importImageEffectsHolder .number");var h=this;$(".importEffectCheckbox").on("click",function(){var e=$(this).attr("data-effectId");h.updateEffectSettings(e);h.updateShaderEffects();h.parameterChanged()});$(".importEffectNumberParam").on("change",function(){var e=$(this).attr("data-effectId");var t=$(this).attr("data-paramId");h.updateEffectSettings(e);h.parameterChanged()});$(".importEffectNumberParam").on("keyup",function(){var e=$(this).attr("data-effectId");var t=$(this).attr("data-paramId");h.updateEffectSettings(e);h.parameterChanged()});$(".importEffectCheckboxParam").on("click",function(){var e=$(this).attr("data-effectId");var t=$(this).attr("data-paramId");h.updateEffectSettings(e);h.parameterChanged()});$(".importEffectOptionsParam").on("click",function(){var e=$(this).attr("data-effectId");var t=$(this).attr("data-paramId");h.updateEffectSettings(e);h.parameterChanged()});$(".importEffectMultiOptionsParam").on("click",function(){var e=$(this).attr("data-effectId");var t=$(this).attr("data-paramId");h.updateEffectSettings(e);h.parameterChanged()})},updateShaderEffects:function(){var e=[];for(var t=0;t<this.importEffects.length;t++){if(this.importEffects[t].type=="shadereffect"&&this.importEffects[t].enabled){var i={};for(var r in this.importEffects[t].params){i[r]=this.importEffects[t].params[r].value}e.push({effect:this.importEffects[t].name,params:i})}}var a=false;if(this.shaderEffectsList.length!=e.length){a=true}else{for(var t=0;t<e.length;t++){if(this.shaderEffectsList[t].effect!=e[t].effect){a=true;break}}}if(a){this.shaderEffectsList=e;this.shaderEffects.setEffects(this.shaderEffectsList)}},updateEffectSettings:function(e){if($("#importEffectCheckbox_"+e).is(":checked")){$("#importEffectParams_"+e).slideDown(200);this.importEffects[e].enabled=true;var t=false;if(this.importEffects[e].type=="shadereffect"){for(var i=0;i<this.shaderEffectsList.length;i++){if(this.shaderEffectsList[i].effect==this.importEffects[e].name){t=i;break}}}for(var r in this.importEffects[e].params){if(this.importEffects[e].params.hasOwnProperty(r)){var a="number";var s=this.importEffects[e].params[r];if(typeof this.importEffects[e].params[r].type!="undefined"){a=this.importEffects[e].params[r].type}var o="none";if(typeof s.animated!="undefined"&&s.animated){this.importEffects[e].params[r].animateType=$("#importEffect_"+e+"_param_"+r+"_animateType").val()}var l="";if(a=="number"){l=parseInt($("#importEffect_"+e+"_param_"+r).val(),10)}else if(a=="range"){l=parseInt($("#importEffect_"+e+"_param_"+r).val(),10);var n=this.importEffects[e].params[r].min;var h=this.importEffects[e].params[r].max;l=n+(h-n)*l/100}else if(a=="checkbox"){l=$("#importEffect_"+e+"_param_"+r).is(":checked")}else if(a=="options"){l=$("input[name=importEffect_"+e+"_param_"+r+"]:checked").val()}else if(a=="multioptions"){l=[];$("input[name=importEffect_"+e+"_param_"+r+"]:checked").each(function(){l.push($(this).val())})}this.importEffects[e].params[r].value=l;if(t!==false){this.shaderEffectsList[t].params[r]=l}}}}else{this.importEffects[e].enabled=false;$("#importEffectParams_"+e).slideUp()}},initEffects:function(){if(this.mirrorEffect==null){this.mirrorEffect=new MirrorEffect}if(this.rotateZoomEffect==null){this.rotateZoomEffect=new RotateZoomEffect}if(this.slitscanEffect==null){this.slitscanEffect=new SlitscanEffect}if(this.noiseEffect==null){this.noiseEffect=new NoiseEffect}if(this.imageParametersEffect==null){this.imageParametersEffect=new ImageParametersEffect}if(this.shaderEffects==null){this.shaderEffects=new ImageShaderEffects;this.shaderEffects.init()}},htmlComponentLoaded:function(){this.componentsLoaded++;if(this.componentsLoaded==4){this.splitPanel.setPanelVisible("east",true);this.splitPanel.resize();this.initContent();this.initEvents();this.initRangeControl();this.drawRangeControl();this.effectsHTML();if(!Modernizr.cssscrollbar){this.scrollbar1=new PerfectScrollbar("#importImageHolder");this.scrollbar2=new PerfectScrollbar("#importEffectsHolder");this.scrollbar3=new PerfectScrollbar("#importImageAllSettings");this.scrollbar4=new PerfectScrollbar("#importImageFramesHolder")}if(this.dialogReadyCallback!==false){this.dialogReadyCallback()}}},updateScrollbars:function(){if(this.scrollbar1&&this.scrollbar2&&this.scrollbar3&&this.scrollbar4){this.scrollbar1.update();this.scrollbar2.update();this.scrollbar3.update();this.scrollbar4.update()}},initRangeControl:function(){var t=this;if(g_app.isMobile()){this.rangeCanvas=document.getElementById("importImageVideoRangeMobile")}else{this.rangeCanvas=document.getElementById("importImageVideoRange")}this.rangeContext=this.rangeCanvas.getContext("2d");this.rangeMaxValue=600;this.rangeStartValue=40;this.rangeEndValue=100;$("#importImageVideoRange").on("mousedown",function(e){t.rangeMouseDown(e)})},setVideoImportFrom:function(e){if(g_app.isMobile()){e=parseFloat(e);this.rangeStartValue=e;$("#importImageMobileStartTime").val(e);$("#importImageMobileStartTimeValue").val(e);this.drawRangeControl()}else{$("#importImageVideoStartAt").val(e);this.rangeStartValue=e;this.drawRangeControl()}this.setVideoImportParams()},setVideoImportTo:function(e){if(g_app.isMobile()){e=parseFloat(e);$("#importImageMobileEndTime").val(e);$("#importImageMobileEndTimeValue").val(e);this.rangeEndValue=e;this.drawRangeControl()}else{$("#importImageVideoEndAt").val(e);this.rangeEndValue=e;this.drawRangeControl()}this.setVideoImportParams()},rangeMouseDown:function(e){var t=e.pageX-$("#importImageVideoRange").offset().left;var i=e.pageY-$("#importImageVideoRange").offset().top;this.mouseDownAtX=e.pageX;this.mouseDownAtY=e.pageY;this.mouseDownInRange=false;this.mouseDownRangeStart=false;this.mouseDownRangeEnd=false;if(t<this.rangeStartPosition&&t>this.rangeStartPosition-6){this.mouseDownInRange=true;this.mouseDownRangeStart=true;this.rangeStartMouseDownPosition=this.rangeStartPosition;UI.captureMouse(this,{cursor:"ew-resize"})}if(t>this.rangeEndPosition&&t<this.rangeEndPosition+6){this.mouseDownInRange=true;this.mouseDownRangeEnd=true;this.rangeEndMouseDownPosition=this.rangeEndPosition;UI.captureMouse(this,{cursor:"ew-resize"})}},rangeMouseMove:function(e){var t=e.pageX-$("#importImageVideoRange").offset().left;var i=e.pageY-$("#importImageVideoRange").offset().top;var r=e.pageX-this.mouseDownAtX;var a=e.pageY-this.mouseDownAtY;if(t<this.rangeStartPosition&&t>this.rangeStartPosition-6){UI.setCursor("ew-resize")}else if(t>this.rangeEndPosition&&t<this.rangeEndPosition+6){UI.setCursor("ew-resize")}else{if(!this.mouseInPreview&&!this.mouseIsDown){UI.setCursor("default")}}if(this.mouseDownRangeStart){this.rangeStartPosition=this.rangeStartMouseDownPosition+r;this.rangeStartValue=(this.rangeStartPosition-10)/this.rangeControlWidth*this.rangeMaxValue;if(this.rangeStartValue<0){this.rangeStartValue=0}if(this.rangeStartValue>this.rangeEndValue){this.rangeStartValue=this.rangeEndValue}UI.setCursor("ew-resize");this.setVideoImportFrom(this.rangeStartValue)}if(this.mouseDownRangeEnd){this.rangeEndPosition=this.rangeEndMouseDownPosition+r;this.rangeEndValue=(this.rangeEndPosition-10)/this.rangeControlWidth*this.rangeMaxValue;if(this.rangeEndValue>this.rangeMaxValue){this.rangeEndValue=this.rangeMaxValue}if(this.rangeEndValue<this.rangeStartValue){this.rangeEndValue=this.rangeStartValue}UI.setCursor("ew-resize");this.setVideoImportTo(this.rangeEndValue)}},rangeMouseUp:function(e){this.mouseDownInRange=false;this.mouseDownRangeStart=false;this.mouseDownRangeEnd=false},drawRangeControl:function(){var e=2;if(this.rangeCanvas==null){return}var t=this.rangeCanvas.width;var i=this.rangeCanvas.height;this.rangeContext.clearRect(0,0,this.rangeCanvas.width,this.rangeCanvas.height);this.rangeControlWidth=t-20;this.rangeContext.fillStyle="#292929";this.rangeContext.fillRect(10,e,this.rangeControlWidth,i-e*2);this.rangeStartPosition=10+this.rangeStartValue/this.rangeMaxValue*this.rangeControlWidth;this.rangeEndPosition=10+this.rangeEndValue/this.rangeMaxValue*this.rangeControlWidth;this.rangeContext.fillStyle="#444444";this.rangeContext.fillRect(this.rangeStartPosition,e,this.rangeEndPosition-this.rangeStartPosition,i-e*2);var r=6;var a=8;this.rangeContext.fillStyle="#aaaaaa";if(!g_app.isMobile()){this.rangeContext.beginPath();this.rangeContext.moveTo(this.rangeStartPosition-r,(i-a)/2);this.rangeContext.lineTo(this.rangeStartPosition,i/2);this.rangeContext.lineTo(this.rangeStartPosition-r,(i+a)/2);this.rangeContext.fill()}this.rangeContext.fillRect(this.rangeStartPosition,e,1,i-e*2);if(!g_app.isMobile()){this.rangeContext.beginPath();this.rangeContext.moveTo(this.rangeEndPosition+1,i/2);this.rangeContext.lineTo(this.rangeEndPosition+1+r,(i-a)/2);this.rangeContext.lineTo(this.rangeEndPosition+1+r,(i+a)/2);this.rangeContext.fill()}this.rangeContext.fillRect(this.rangeEndPosition,e,1,i-e*2);if(this.importVideo!=null&&typeof this.importVideo.currentTime!="undefined"){var s=this.importVideo.currentTime*1e3;var o=10+s/this.rangeMaxValue*this.rangeControlWidth;this.rangeContext.fillStyle="#dddddd";this.rangeContext.fillRect(o,e,1,i-e*2)}},start:function(e){this.dialogReadyCallback=false;if(typeof e!="undefined"){if(typeof e.dialogReadyCallback!="undefined"){this.dialogReadyCallback=e.dialogReadyCallback}}this.editor.frames.stop();var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return}var i=t.getTileSet();this.importWidth=t.getGridWidth()*t.getCellWidth();this.importHeight=t.getGridHeight()*t.getCellHeight();this.initEffects();this.initSrcCanvas();if(!this.shaderImport){this.shaderImport=new ShaderImport2;this.shaderImport.init(this.editor)}if(!this.mobileImport){this.mobileImport=new MobileImport;this.mobileImport.init(this.editor)}if(UI.isMobile.any()){this.useMobile=true;this.useShader=false}else{if($("#importImageMethod").val()=="method2"){this.useMobile=true;this.useShader=false}else if($("#importImageMethod").val()=="method1"){this.useMobile=false;this.useShader=true}else{this.useMobile=true;this.useShader=false}}if(g_app.isMobile()){if(this.importImageMobile==null){this.importImageMobile=new ImportImageMobile;this.importImageMobile.init(this.editor,this)}this.importImageMobile.show();return}var r=this;this.componentsLoaded=0;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"importImageDialog",title:"Import Image",width:900,height:640});this.splitPanel=UI.create("UI.SplitPanel",{id:"importImageSplitPanel"});this.uiComponent.add(this.splitPanel);this.animPanel=UI.create("UI.SplitPanel",{id:"importImageAnimPanel"});this.animPanel.on("resize",function(){r.updateScrollbars()});this.splitPanel.addEast(this.animPanel,260);this.framesPanel=UI.create("UI.HTMLPanel");this.animPanel.addNorth(this.framesPanel,190);this.framesPanel.load("html/textMode/importImageFrames.html",function(){r.htmlComponentLoaded()});this.framesPanel.on("resize",function(){r.updateScrollbars()});this.effectsPanel=UI.create("UI.HTMLPanel");this.animPanel.add(this.effectsPanel);this.effectsPanel.load("html/textMode/importImageEffects.html",function(){r.htmlComponentLoaded()});this.effectsPanel.on("resize",function(){r.updateScrollbars()});this.innerSplitPanel=UI.create("UI.SplitPanel");this.splitPanel.add(this.innerSplitPanel);this.importSourcePanel=UI.create("UI.HTMLPanel");this.innerSplitPanel.addNorth(this.importSourcePanel,336);this.importSourcePanel.load("html/textMode/importImage.html",function(){r.htmlComponentLoaded()});this.innerSplitPanel.on("resize",function(){r.updateScrollbars()});this.converterSettingsPanel=UI.create("UI.HTMLPanel");this.innerSplitPanel.add(this.converterSettingsPanel);this.converterSettingsPanel.load("html/textMode/importImageConverterSettings.html",function(){r.htmlComponentLoaded()});this.converterSettingsPanel.on("resize",function(){r.updateScrollbars()});this.okButton=UI.create("UI.Button",{text:"Import",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){UI.closeDialog();r.frame=0;r.showProgress();setTimeout(function(){r.startImport()},10)});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){r.visible=false})}else{r.initContent();if(r.dialogReadyCallback!==false){r.dialogReadyCallback()}}if(!this.visible){UI.showDialog("importImageDialog")}this.visible=true},setUseEffects:function(e){this.useEffects=e;var t=parseInt($("#importImageFrames").val());if(this.useEffects){$("#importImagePreviewAnimationRow").hide();$("#importImageEffectsBorder").show();$("#importImageEffectsHolder").show();if(t<=1){$("#importImageFrames").val(12)}}else{$("#importImagePreviewAnimationRow").hide();$("#importImageEffectsBorder").hide();$("#importImageEffectsHolder").hide();if(this.importSource!="video"){$("#importImageFrames").val(1)}}this.setAnimationParameters();this.updateAnimateSettings()},updateAnimateSettings:function(){this.importImageAnimate=true;this.previewAnimation=$("#importImagePreviewAnimation").is(":checked")&&this.importImageAnimate;this.insertFrames=$("#importImageInsertFrames").is(":checked");if(this.importImageAnimate){}this.parameterChanged()},initContent:function(){var e=this;this.mouseDownAtX=0;this.mouseDownAtY=0;this.mouseIsDown=false;this.currentOffsetX=0;this.currentOffsetY=0;if(!this.basicImport){this.basicImport=new BasicImport;this.basicImport.init(this.editor)}if(!this.mobileImport){this.mobileImport=new MobileImport;this.mobileImport.init(this.editor)}if(UI.isMobile.any()){this.useMobile=true;this.useShader=false}this.setColorReductionParams();var t=this.editor.layers.getSelectedLayerObject();if(t&&t.getType()=="grid"){this.backgroundColor=t.getBackgroundColor()}var i=t.getMode();var r=this.editor.colorPaletteManager.getCurrentColorPalette();var a=t.getTileSet();this.characters=[];for(var s=0;s<256;s++){this.characters.push(s)}this.charactersHasSpace=true;this.charactersHasBlock=true;this.initColors();var o=parseInt($("#importImageScale").val(),10);if(!isNaN(o)){this.importImageScale=o}else{this.importImageScale=100;$("#importImageScale").val(100)}this.edgeDetect=$("#importImageEdgeDetect").is(":checked");this.edgeDetectLowThreshold=$("#importImageEdgeDetectLow").val();this.edgeDetectHighThreshold=parseInt($("#importImageEdgeDetectHigh").val(),10);this.edgeDetectBlurRadius=parseInt($("#importImageEdgeDetectBlur").val(),10);this.edgeDetectLineThickness=parseInt($("input[name=importImageEdgeDetectLineThickness]:checked").val(),10);if(i==TextModeEditor.Mode.C64STANDARD){this.backgroundColorType="frame";$("#importImageBGSettingsC64Standard").show();$("#importImageBGSettings").hide()}else{this.backgroundColorType=$("#importImageBackgroundColorType").val();$("#importImageBGSettingsC64Standard").hide();$("#importImageBGSettings").show()}this.setBackgroundColorChoose($("#importImageBackgroundColorChoose").val());if(this.backgroundColorType=="frame"){$("#importFrameBGSettings").show()}else{$("#importFrameBGSettings").hide()}var l=Math.floor(t.getGridWidth()*t.getCellWidth()/2);var n=Math.floor(t.getGridHeight()*t.getCellHeight()/2);if(this.midPointY!=n||this.midPointX!=l){this.midPointX=l;this.midPointY=n;$("#imageImportZoomX").val(l);$("#imageImportZoomY").val(n)}this.imageX=parseFloat($("#importImageX").val());this.imageY=parseFloat($("#importImageY").val());this.crosshairX=$("#imageImportZoomX").val();this.crosshairY=$("#imageImportZoomY").val();this.updateAnimateSettings();this.setAnimationParameters();this.setVideoImportParams();this.initCanvas();this.parameterChanged();this.uiComponent.fitContent();var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){reutrn}if(t.getReferenceImageData()){$("#importImageUseReferenceImage").show()}else{$("#importImageUseReferenceImage").hide()}},initEvents:function(){var a=this;$("#importImagePanel").on("mousemove",function(e){a.mouseMove(e)});$("#importImageChooseFile").on("click",function(){$("#importImageSourceFile").click()});$("#importImageMethod").on("change",function(){var e=$(this).val();if(e=="method2"){a.useMobile=true;a.useShader=false}else if(e=="method1"){a.useMobile=false;a.useShader=true}});$("#importImageEdgeDetect").on("click",function(){a.edgeDetect=$("#importImageEdgeDetect").is(":checked");a.parameterChanged()});$("#importImageEdgeDetectLow").on("change",function(){a.edgeDetectLowThreshold=parseInt($(this).val(),10);a.parameterChanged()});$("#importImageEdgeDetectLow").on("keyup",function(){a.edgeDetectLowThreshold=parseInt($(this).val(),10);a.parameterChanged()});$("#importImageEdgeDetectHigh").on("change",function(){a.edgeDetectHighThreshold=parseInt($(this).val(),10);a.parameterChanged()});$("#importImageEdgeDetectHigh").on("keyup",function(){a.edgeDetectHighThreshold=parseInt($(this).val(),10);a.parameterChanged()});$("#importImageEdgeDetectBlur").on("change",function(){a.edgeDetectBlurRadius=parseInt($(this).val(),10);a.parameterChanged()});$("#importImageEdgeDetectBlur").on("keyup",function(){a.edgeDetectBlurRadius=parseInt($(this).val(),10);a.parameterChanged()});$("input[name=importImageEdgeDetectLineThickness]").on("click",function(){a.edgeDetectLineThickness=parseInt($("input[name=importImageEdgeDetectLineThickness]:checked").val(),10);a.parameterChanged()});$("#importImageX").on("keyup",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){a.imageX=e;a.parameterChanged()}});$("#importImageX").on("change",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){a.imageX=e;a.parameterChanged()}});$("#importImageY").on("keyup",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){a.imageY=e;a.parameterChanged()}});$("#importImageY").on("change",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){a.imageY=e;a.parameterChanged()}});$("#importImageBrightness").on("change",function(){a.brightness=$(this).val();$("#importImageBrightnessValue").val(a.brightness);if(a.importSource!="video"){a.parameterChanged()}});$("#importImageBrightness").on("input",function(){a.brightness=$(this).val();$("#importImageBrightnessValue").val(a.brightness);if(a.importSource!="video"){a.parameterChanged()}});$("#importImageBrightnessValue").on("change",function(){a.brightness=$(this).val();$("#importImageBrightness").val(a.brightness);if(a.importSource!="video"){a.parameterChanged()}});$("#importImageContrast").on("change",function(){a.contrast=$(this).val();$("#importImageContrastValue").val(a.contrast);if(a.importSource!="video"){a.parameterChanged()}});$("#importImageContrast").on("input",function(){a.contrast=$(this).val();$("#importImageContrastValue").val(a.contrast);if(a.importSource!="video"){a.parameterChanged()}});$("#importImageContrastValue").on("change",function(){a.contrast=$(this).val();$("#importImageContrast").val(a.contrast);if(a.importSource!="video"){a.parameterChanged()}});$("#importImageSaturation").on("change",function(){a.saturation=$(this).val();$("#importImageSaturationValue").val(a.saturation);if(a.importSource!="video"){a.parameterChanged()}});$("#importImageSaturation").on("input",function(){a.saturation=$(this).val();$("#importImageSaturationValue").val(a.saturation);if(a.importSource!="video"){a.parameterChanged()}});$("#importImageSaturationValue").on("change",function(){a.saturation=$(this).val();$("#importImageSaturation").val(a.saturation);if(a.importSource!="video"){a.parameterChanged()}});$("#importImageCanvas").on("wheel",function(e){a.imageMouseWheel(e.originalEvent)});$("#importImageCanvas").on("mouseenter",function(e){UI.setCursor("can-drag-scroll")});$("#importImageCanvas").on("mouseleave",function(e){a.mouseInPreview=false});$("#importImageCanvas").on("mousemove",function(e){UI.setCursor("can-drag-scroll");a.mouseInPreview=true;e.preventDefault()});$("#importImageCanvas").on("mousedown",function(e){var t=e.offsetX;var i=e.offsetY;a.movingImage=false;a.mouseDownAtX=e.pageX;a.mouseDownAtY=e.pageY;a.currentOffsetX=parseInt($("#importImageX").val());a.currentOffsetY=parseInt($("#importImageY").val());if(a.chromaChooseColor){a.chooseChromaColorClick(e);a.chromaChooseColor=false;return}a.mouseIsDown=true;UI.setCursor("drag-scroll");UI.captureMouse(a,{cursor:"url(cursors/closedhand.png) 2 14, pointer"})});$("#importImageInverColors").on("click",function(){a.setInvertColors()});$("#importImageSmoothing").on("click",function(){a.setSmoothingMethod()});$("#importImageScale").on("keyup",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){a.importImageScale=e;a.parameterChanged()}});$("#importImageScaleDecrease").on("click",function(){var e=parseInt($("#importImageScale").val());if(isNaN(e)){return}e-=5;if(e>0){$("#importImageScale").val(e)}a.importImageScale=e;a.parameterChanged()});$("#importImageScaleIncrease").on("click",function(){var e=parseInt($("#importImageScale").val());if(isNaN(e)){return}e+=5;if(e>0){$("#importImageScale").val(e)}a.importImageScale=e;a.parameterChanged()});$("#importImageScaleToFit").on("click",function(){a.scaleImageToFit()});$("#importImageColorReduction").on("change",function(e){var t=$("#importImageColorReduction").val();a.setColorReductionParams({method:t});a.parameterChanged()});$("#importImageBackgroundColorType").on("change",function(e){a.backgroundColorType=$(this).val();if(a.backgroundColorType=="frame"){$("#importFrameBGSettings").show()}else{$("#importFrameBGSettings").hide()}});$("#importImageBackgroundColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){var t=a.editor.colorPaletteManager.getCurrentColorPalette();a.backgroundColor=e;$("#importImageBackgroundColor").css("background-color","#"+t.getHexString(e))};var i=e.pageX;var r=e.pageY;t.currentColor=a.backgroundColor;a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("#importImageDither").on("change",function(){a.setColorReductionParams();a.parameterChanged()});$("#importImageDitherThreshold").on("change",function(){a.setColorReductionParams();a.parameterChanged()});$("#importImageDitherThreshold").on("keyup",function(){a.setColorReductionParams();a.parameterChanged()});$("#importImageInsertFrames").on("click",function(){a.updateAnimateSettings()});$("#importImageRotate").on("click",function(){a.rotateAmount+=10;a.parameterChanged()});$("input[name=importImageWithFrames]").on("click",function(){a.updateAnimateSettings();a.parameterChanged();a.uiComponent.fitContent()});$(".importImageAnimationEffect").on("click",function(){a.updateAnimateSettings()});$("#importImagePreviewAnimation").on("click",function(){a.frame=0;a.lastPreviewUpdate=getTimestamp();a.updateAnimateSettings()});$("#importImageUseEffects").on("click",function(){a.setUseEffects($(this).is(":checked"))});$("#importImageVideoStartAt").on("keyup",function(){var e=parseInt($(this).val());if(!isNaN(e)){a.setVideoImportFrom(e)}});$("#importImageVideoStartAt").on("change",function(){var e=parseInt($(this).val());if(!isNaN(e)){a.setVideoImportFrom(e)}});$("#importImageVideoEndAt").on("change",function(){var e=parseInt($(this).val());if(!isNaN(e)){a.setVideoImportTo(e)}});$("#importImageVideoEndAt").on("change",function(){var e=parseInt($(this).val());if(!isNaN(e)){a.setVideoImportTo(e)}});$("input[name=importImageVideoPlayDirection]").on("click",function(){a.setVideoImportParams()});$("#importImageFrames").on("keyup",function(){a.setAnimationParameters()});$("#importImageFrames").on("change",function(){a.setAnimationParameters()});$("#importImageTicksPerFrame").on("keyup",function(){a.setAnimationParameters()});$("#importImageTicksPerFrame").on("change",function(){a.setAnimationParameters()});this.initEffectEvents();$("#importImageUseChars").on("change",function(e){a.useChars=$("#importImageUseChars").val();if(a.useChars=="all"){$("#importImageChooseCharsRow").hide()}else{a.chooseCustomChars();$("#importImageChooseCharsRow").show()}a.uiComponent.fitContent()});$("#importImageChromaKeying").on("click",function(){a.setChromaKeyEnabled($(this).is(":checked"))});$("#importImageChromaKeyChooseColor").on("click",function(){a.chromaChooseColorStart()});$("#importImageChooseChars").on("click",function(){a.chooseCustomChars()});$("#importImageUseColors").on("change",function(e){var t=$("#importImageUseColors").val();a.setUseColors(t)});$("#importImageCreatePaletteColorCount").on("change",function(){a.createPaletteColorCount=parseInt($(this).val(),10);a.createImportColorPalette();a.parameterChanged();a.uiComponent.fitContent()});$("#importImageChooseColors").on("click",function(){a.chooseCustomColors()});$("#importImageBackgroundColorChoose").on("change",function(){a.setBackgroundColorChoose($(this).val())});$("#importImageUseReferenceImage").on("click",function(){a.setImportImageFromReferenceImage()});document.getElementById("importImageSourceFile").addEventListener("change",function(e){var t=document.getElementById("importImageSourceFile").files[0];a.setImportImage(t)})},chooseCustomChars:function(){var a=this;var e=function(e){a.customTileSet=[];var t=0;for(var i=0;i<e.length;i++){t++;a.customTileSet.push(e[i])}var r=t+" Character";if(t!=1){r+="s"}r+=" Chosen";$("#importImageCharactersChosen").html(r)};this.editor.chooseCharactersDialog.show({callback:e,chars:this.customTileSet})},chooseCustomColors:function(){var s=this;var e=function(e){s.customColorSet=[];var t=s.editor.colorPaletteManager.noColor;var i=e.length;for(var r=0;r<i;r++){if(e[r]!==t){s.customColorSet.push(e[r])}}var a=i;a+=" Colour";if(i!=1){a+="s"}a+=" Chosen";$("#importImageColoursChosen").html(a);s.parameterChanged()};this.editor.chooseColorsDialog.show({message:"Choose colours",callback:e,colors:this.customColorSet})},chromaChooseColorStart:function(){this.chromaChooseColor=true},chooseChromaColorClick:function(e){var t=e.pageX-$("#importImageCanvas").offset().left;var i=e.pageY-$("#importImageCanvas").offset().top;var r=this.importImageContext.getImageData(0,0,this.importImageCanvas.width,this.importImageCanvas.height);var a=r.data;var s=t*4+i*this.importImageCanvas.width*4;var o=a[s++]/255;var l=a[s++]/255;var n=a[s++]/255;this.setChromaKeyColor(o,l,n);this.chromaChooseColor=false},setChromaKeyEnabled:function(e){this.chromaKeyEnabled=e;for(var t=0;t<this.importEffects.length;t++){var i=this.importEffects[t].name;if(i==="Chroma Key"){this.importEffects[t].enabled=e;break}}this.updateShaderEffects();this.parameterChanged()},setChromaKeyColor:function(e,t,i){for(var r=0;r<this.importEffects.length;r++){var a=this.importEffects[r].name;if(a==="Chroma Key"){this.importEffects[r].params["r"].value=e;this.importEffects[r].params["g"].value=t;this.importEffects[r].params["b"].value=i;break}}for(var r=0;r<this.shaderEffectsList.length;r++){if(this.shaderEffectsList[r].effect=="Chroma Key"){this.shaderEffectsList[r].params["r"]=e;this.shaderEffectsList[r].params["g"]=t;this.shaderEffectsList[r].params["b"]=i;break}}this.updateShaderEffects();this.parameterChanged()},setBackgroundColorChoose:function(e){this.backgroundColorChoose=e;if(this.backgroundColorChoose=="auto"||this.backgroundColorChoose=="current"){$("#importImageUseBackgroundColor").hide()}else{$("#importImageUseBackgroundColor").show()}this.uiComponent.fitContent()},setUseColors:function(e){this.useColors=e;if(this.useColors=="all"){$("#importImageChooseColorsRow").hide();$("#importImageCreatePalette").hide()}else if(this.useColors=="greyscale"){$("#importImageChooseColorsRow").hide();$("#importImageCreatePalette").hide()}else if(this.useColors=="create"){this.createImportColorPalette();$("#importImageChooseColorsRow").hide();$("#importImageCreatePalette").show()}else if(this.useColors=="choose"){this.chooseCustomColors();$("#importImageChooseColorsRow").show();$("#importImageCreatePalette").hide()}else{$("#importImageChooseColorsRow").hide();$("#importImageCreatePalette").hide()}this.parameterChanged();this.uiComponent.fitContent()},setColorReductionParams:function(e){if(typeof e!="undefined"){if(typeof e.method!="undefined"){this.colorReductionMethod=e.method}}if(this.colorReductionMethod=="dither"){$("#importImageDitherGroup").show();var t=parseInt($("#importImageDitherThreshold").val(),10);if(!isNaN(t)){this.ditherThreshold=t}}else{$("#importImageDitherGroup").hide()}if(this.colorReductionMethod=="edge"){$("#importImageEdgeDetectionGroup").show()}else{$("#importImageEdgeDetectionGroup").hide()}this.ditherMethod=$("#importImageDither").val();this.limitColorsPerCell=false},imageMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);var i=parseInt($("#importImageScale").val());if(isNaN(i)){return}i=i-t.spinY*8;if(i>0){$("#importImageScale").val(i)}this.importImageScale=i;this.parameterChanged()},setAnimationParameters:function(){if(this.importSource=="video"){this.setVideoImportParams()}if(this.importSource!="image"){return}var e=parseInt($("#importImageFrames").val());if(!isNaN(e)){var t=this.frameCount;this.frameCount=e;if(this.frameCount==1&&t>1){this.frame=0;this.parameterChanged()}}var i=parseInt($("#importImageTicksPerFrame").val());if(!isNaN(i)){this.ticksPerFrame=i}},setVideoImportParams:function(){if(this.importSource!="video"){return}if(g_app.isMobile()){this.frameCount=this.importImageMobile.frameCount;this.videoStartAt=this.rangeStartValue;this.videoEndAt=this.rangeEndValue;this.videoSampleEvery=(this.videoEndAt-this.videoStartAt)/this.frameCount;if(this.videoPlaybackDirection=="pingpong"){this.videoSampleEvery=this.videoSampleEvery*2}}else{var e=parseInt($("#importImageFrames").val());if(!isNaN(e)){this.frameCount=e}this.videoPlaybackDirection=$("input[name=importImageVideoPlayDirection]:checked").val();this.videoStartAt=this.rangeStartValue;this.videoEndAt=this.rangeEndValue;this.videoSampleEvery=(this.videoEndAt-this.videoStartAt)/this.frameCount;if(this.videoPlaybackDirection=="pingpong"){this.videoSampleEvery=this.videoSampleEvery*2}var t=parseInt($("#importImageTicksPerFrame").val());if(!isNaN(t)){this.ticksPerFrame=t}}},scaleImageToFit:function(){if(this.importSource=="image"&&this.importImage==null){return}if(this.importSource=="video"&&this.importVideo==null){return}var e=0;var t=0;var i=1;if(this.importSource=="image"){var e=this.importImage.naturalWidth;var t=this.importImage.naturalHeight;if(e>this.importWidth){i=this.importWidth/this.importImage.naturalWidth}if(t>this.importHeight){i=this.importHeight/this.importImage.naturalHeight}if(e<this.importWidth&&i==1){i=this.importWidth/this.importImage.naturalWidth}if(t<this.importHeight&&i==1){i=this.importHeight/this.importImage.naturalHeight}}if(this.importSource=="video"){var e=this.importVideo.videoWidth;if(e==0){e=320}var t=this.importVideo.videoHeight;if(t==0){t=200}if(e>this.importWidth){i=this.importWidth/e}if(t>this.importHeight){i=this.importHeight/t}if(e<this.importWidth&&i==1){i=this.importWidth/e}if(t<this.importHeight&&i==1){i=this.importHeight/t}}var r=(this.importWidth-e)/2;$("#importImageX").val(r);this.imageX=r;var a=(this.importHeight-t)/2;$("#importImageY").val(a);this.imageY=a;i=i*100;this.importImageScale=i;if(g_app.isMobile()){$("#importImageMobileScale").val(i)}else{$("#importImageScale").val(i);this.parameterChanged()}},createImportColorPalette:function(){var e=false;if(this.importSource=="video"){if(this.importVideo==null){return}this.srcContext.drawImage(this.importVideo,0,0,this.importVideo.videoWidth,this.importVideo.videoHeight);e=ImageUtils.createColorPaletteFromImage(this.createPaletteColorCount,this.srcCanvas)}else{if(this.importImage==null){return}if(this.currentColorCount==this.createPaletteColorCount){return}e=ImageUtils.createColorPaletteFromImage(this.createPaletteColorCount,this.importImage)}this.importColorPalette=[];for(var t=0;t<e.length;t+=4){var i=(e[t]<<16)+(e[t+1]<<8)+e[t+2];this.importColorPalette.push(i)}this.currentColorCount=this.createPaletteColorCount},setInvertColors:function(){this.invertColors=$("#importImageInverColors").is(":checked");this.parameterChanged()},setSmoothingMethod:function(e){if(typeof e=="undefined"){if($("#importImageSmoothing").is(":checked")){this.imageSmoothing=true}else{this.imageSmoothing=false}}else{this.imageSmoothing=e}this.srcContext.imageSmoothingEnabled=this.imageSmoothing;this.srcContext.webkitImageSmoothingEnabled=this.imageSmoothing;this.srcContext.mozImageSmoothingEnabled=this.imageSmoothing;this.srcContext.msImageSmoothingEnabled=this.imageSmoothing;this.srcContext.oImageSmoothingEnabled=this.imageSmoothing;if(this.importImageContext){this.importImageContext.imageSmoothingEnabled=this.imageSmoothing;this.importImageContext.webkitImageSmoothingEnabled=this.imageSmoothing;this.importImageContext.mozImageSmoothingEnabled=this.imageSmoothing;this.importImageContext.msImageSmoothingEnabled=this.imageSmoothing;this.importImageContext.oImageSmoothingEnabled=this.imageSmoothing}this.parameterChanged()},parameterChanged:function(){this.updateImportImage();this.drawPreview()},resetCacheCanvas:function(){this.cacheImageX=false;this.cacheImageY=false;this.cacheDrawWidth=false;this.cacheDrawHeight=false;this.cacheScale=false;this.cacheCrosshairX=false;this.cacheCrosshairY=false;this.cacheImageSmoothing=-1},updateImportImage:function(){if(this.importSource=="image"&&this.importImage==null){return}if(this.importSource=="video"&&this.importVideo==null){return}var e=0;var t=0;if(this.importSource=="image"){e=this.importImage.naturalWidth;t=this.importImage.naturalHeight}if(this.importSource=="video"){e=this.importVideo.videoWidth;if(e==0){e=320}t=this.importVideo.videoHeight;if(t==0){t=200}}var i=this.importImageScale;this.imageScale=i;this.currentZoom=i;var r=this.editor.colorPaletteManager.getCurrentColorPalette();this.srcContext.clearRect(0,0,this.srcCanvas.width,this.srcCanvas.height);if(!this.importImageAnimate||!this.useEffects&&!this.chromaKeyEnabled||this.chromaChooseColor){var i=this.currentZoom;var a=this.imageX-this.crosshairX;var s=this.imageY-this.crosshairY;if(this.importSource=="image"&&this.cacheCanvas!==null&&this.cacheImageX===a&&this.cacheImageY===s&&this.cacheDrawWidth===e&&this.cacheDrawHeight===t&&this.cacheScale===i&&this.cacheCrosshairX===this.crosshairX&&this.cacheCrosshairY===this.crosshairY&&this.cacheImageSmoothing===this.imageSmoothing&&this.cacheRotateAmount==this.rotateAmount){this.srcContext.drawImage(this.cacheCanvas,0,0)}else{this.srcContext.save();var o=this.crosshairX;var l=this.crosshairY;this.srcContext.translate(o,l);this.srcContext.scale(i/100,i/100);this.srcContext.rotate(this.rotateAmount*Math.PI/180);var n=a;var h=s;n=Math.cos(this.rotateAmount*Math.PI/180)*a+Math.sin(this.rotateAmount*Math.PI/180)*s;h=Math.cos(this.rotateAmount*Math.PI/180)*s-Math.sin(this.rotateAmount*Math.PI/180)*a;if(this.importSource=="image"){this.srcContext.drawImage(this.importImage,n,h,e,t)}if(this.importSource=="video"){this.srcContext.drawImage(this.importVideo,n,h,e,t)}this.srcContext.translate(-o,-l);this.srcContext.restore();if(this.importSource=="image"){if(this.cacheCanvas==null){this.cacheCanvas=document.createElement("canvas")}if(this.cacheCanvas!==null&&this.disableCache!==true){this.cacheCanvas.width=this.srcCanvas.width;this.cacheCanvas.height=this.srcCanvas.height;this.cacheContext=this.cacheCanvas.getContext("2d");this.cacheImageX=a;this.cacheImageY=s;this.cacheDrawWidth=e;this.cacheDrawHeight=t;this.cacheScale=i;this.cacheCrosshairX=this.crosshairX;this.cacheCrosshairY=this.crosshairY;this.cacheImageSmoothing=this.imageSmoothing;this.cacheRotateAmount=this.rotateAmount;this.cacheContext.drawImage(this.srcCanvas,0,0)}}}this.imageParametersEffect.setParameters({brightness:this.brightness});this.imageParametersEffect.setParameters({contrast:this.contrast});this.imageParametersEffect.setParameters({saturation:this.saturation});this.imageParametersEffect.setParameters({invertColors:this.invertColors});this.imageParametersEffect.setSource(this.srcCanvas);this.imageParametersEffect.setDestination(this.srcCanvas);this.imageParametersEffect.update()}else{var i=this.currentZoom;var a=this.imageX-this.crosshairX;var s=this.imageY-this.crosshairY;var i=this.importImageScale;this.rotateZoomEffect.setScale(i/100);this.rotateZoomEffect.gotoFrame(this.frame);this.rotateZoomEffect.setFrameCount(this.frameCount);if(this.rotateAmount!=0){this.srcContext.save();var o=this.crosshairX;var l=this.crosshairY;this.srcContext.translate(o,l);this.srcContext.scale(i/100,i/100);this.srcContext.rotate(this.rotateAmount*Math.PI/180);var n=a;var h=s;n=Math.cos(this.rotateAmount*Math.PI/180)*a+Math.sin(this.rotateAmount*Math.PI/180)*s;h=Math.cos(this.rotateAmount*Math.PI/180)*s-Math.sin(this.rotateAmount*Math.PI/180)*a;if(this.importSource=="image"){this.srcContext.drawImage(this.importImage,n,h,e,t)}if(this.importSource=="video"){this.srcContext.drawImage(this.importVideo,n,h,e,t)}this.srcContext.translate(-o,-l);this.srcContext.restore();if(this.importSource=="image"){this.rotateZoomEffect.setSource(this.srcCanvas)}else if(this.importSource=="video"){this.rotateZoomEffect.setSource(this.srcCanvas)}}else{if(this.importSource=="image"){this.rotateZoomEffect.setSource(this.importImage)}else if(this.importSource=="video"){this.rotateZoomEffect.setSource(this.importVideo)}}var d=false;var c=false;var f=false;for(var u=0;u<this.importEffects.length;u++){var p=this.importEffects[u].name;var v=this.importEffects[u].enabled;var g=this.importEffects[u].type;var m=this.importEffects[u].params;if(g!=="shadereffect"){switch(p){case"Pan":if(v){this.rotateZoomEffect.setParameters({panX:m.h.value,panXAnimateType:m.h.animateType,panY:m.v.value,panYAnimateType:m.v.animateType})}else{this.rotateZoomEffect.setParameters({panX:0,panY:0})}break;case"Zoom":if(v){var y="layer";if(m.infinite.value===true){y="infinite"}this.rotateZoomEffect.setParameters({zoomDirection:m.direction.value,zoomAmountX:m.amountX.value,zoomAmountY:m.amountY.value,zoomType:y,layerAngleSeparation:m.layerAngleSeparation.value})}else{this.rotateZoomEffect.setParameters({zoomDirection:0})}break;case"Rotate":if(v){this.rotateZoomEffect.setParameters({rotateDirection:m.direction.value,wiggleAmount:m.wiggleAmount.value,wiggleSteps:0})}else{this.rotateZoomEffect.setParameters({rotateDirection:0})}break;case"Slitscan":f=v;if(v){this.slitscanEffect.horizontal=m.slice.value=="Horizontal";this.slitscanEffect.vertical=m.slice.value=="Vertical";this.slitscanEffect.slices=m.sliceCount.value}break;case"Mirror":d=v;if(v){var b={flipV:false,flipH:false,mirrorV:false,mirrorH:false};var C=m.flip.value;if(typeof C!="undefined"&&C.length>0){if(C.length>0&&C[0]=="Horizontal"||C.length>1&&C[1]=="Horizontal"){b.flipH=true}if(C.length>0&&C[0]=="Vertical"||C.length>1&&C[1]=="Vertical"){b.flipV=true}}var x=m.mirror.value;if(typeof x!="undefined"&&x.length>0){if(x.length>0&&x[0]=="Horizontal"||m.flip.length>1&&m.mirror[1]=="Horizontal"){b.mirrorH=true}if(x.length>0&&x[0]=="Vertical"||x.length>1&&x[1]=="Vertical"){b.mirrorV=true}}this.mirrorEffect.setParameters(b);this.mirrorEffect.gotoFrame(this.frame)}else{this.mirrorEffect.setParameters({flipV:false,flipH:false,mirrorV:false,mirrorH:false})}break;case"Brightness":if(v){this.imageParametersEffect.setParameters({brightness:this.brightness,brightnessDelta:m.amount.value,brightnessAnimateType:m.amount.animateType})}else{this.imageParametersEffect.setParameters({brightness:this.brightness,brightnessDelta:0})}break;case"Contrast":if(v){this.imageParametersEffect.setParameters({contrast:this.contrast,contrastDelta:m.amount.value,contrastAnimateType:m.amount.animateType})}else{this.imageParametersEffect.setParameters({contrast:this.contrast,contrastDelta:0})}break;case"Saturation":if(v){this.imageParametersEffect.setParameters({saturation:this.saturation,saturationDelta:m.amount.value,saturationAnimateType:m.amount.animateType})}else{this.imageParametersEffect.setParameters({saturation:this.saturation})}break;case"Noise":c=v;if(v){this.noiseEffect.setParameters({amount:m.amount.value,density:m.density.value})}else{}break}}}this.rotateZoomEffect.setDestination(this.srcCanvas);this.rotateZoomEffect.setPosition(this.imageX,this.imageY);this.rotateZoomEffect.setCrosshair(this.crosshairX,this.crosshairY);this.rotateZoomEffect.update();if(d){this.mirrorEffect.setSource(this.srcCanvas);this.mirrorEffect.setDestination(this.srcCanvas);this.mirrorEffect.update()}if(f){this.slitscanEffect.setSource(this.srcCanvas);this.slitscanEffect.setDestination(this.srcCanvas);this.slitscanEffect.update()}this.imageParametersEffect.setFrameCount(this.frameCount);this.imageParametersEffect.setSource(this.srcCanvas);this.imageParametersEffect.setDestination(this.srcCanvas);this.imageParametersEffect.gotoFrame(this.frame);this.imageParametersEffect.update();if(this.shaderEffectsList.length>0){var S=this.frame/this.frameCount;for(var P=0;P<this.shaderEffectsList.length;P++){var w=this.shaderEffectsList[P].effect;if(w=="Pixelate"){this.shaderEffectsList[P].params["pixelsX"]=this.shaderEffectsList[P].params["initialX"]+this.shaderEffectsList[P].params["amountX"]*Math.sin(2*Math.PI*S);this.shaderEffectsList[P].params["pixelsY"]=this.shaderEffectsList[P].params["initialY"]+this.shaderEffectsList[P].params["amountY"]*Math.sin(2*Math.PI*S)}else if(w=="Polar Pixelate"){this.shaderEffectsList[P].params["pixelsX"]=this.shaderEffectsList[P].params["initialCircles"]+this.shaderEffectsList[P].params["amountCircles"]/100*Math.sin(2*Math.PI*S);this.shaderEffectsList[P].params["pixelsY"]=this.shaderEffectsList[P].params["initialSlices"]+this.shaderEffectsList[P].params["amountSlices"]/100*Math.sin(2*Math.PI*S)}else if(w=="Hexagonal Pixelate"){this.shaderEffectsList[P].params["scale"]=this.shaderEffectsList[P].params["initial"]+S*this.shaderEffectsList[P].params["amount"];this.shaderEffectsList[P].params["scale"]=this.shaderEffectsList[P].params["initial"]+this.shaderEffectsList[P].params["amount"]/80*Math.sin(2*Math.PI*S)}else if(w=="Diffusion"){this.shaderEffectsList[P].params["scale"]=this.shaderEffectsList[P].params["initial"]+S*this.shaderEffectsList[P].params["amount"];this.shaderEffectsList[P].params["scale"]=this.shaderEffectsList[P].params["initial"]+this.shaderEffectsList[P].params["amount"]/280*Math.sin(2*Math.PI*S)}else{if(w!="Chroma Key"){if(w=="Hue/Saturation"){this.shaderEffectsList[P].params["hue"]=S*2}else{this.shaderEffectsList[P].params["time"]=S}}}}this.shaderEffects.setEffectParams(this.shaderEffectsList);this.shaderEffects.applyEffects()}if(c){this.noiseEffect.gotoFrame(this.frame);this.noiseEffect.setSource(this.srcCanvas);this.noiseEffect.setDestination(this.srcCanvas);this.noiseEffect.update()}}this.imageData=this.srcContext.getImageData(0,0,this.srcCanvas.width,this.srcCanvas.height);if(!this.chromaChooseColor){if(this.colorReductionMethod=="closest"||this.colorReductionMethod=="dither"){this.imageData=this.srcContext.getImageData(0,0,this.srcCanvas.width,this.srcCanvas.height);this.setColors();if(false){var I=[];for(var P=0;P<this.colors.length;P++){I.push(r.getHex(this.colors[P]))}var k=null;if(this.colorReductionMethod=="dither"){k=this.ditherMethod}if(this.useColors=="create"){I=this.importColorPalette}var M=this.ditherThreshold/200;var T=2;ImageUtils.rgbQuant(this.imageData,{method:T,palette:I,dithKern:k,dithDelta:M})}else{var D=[];if(this.useColors=="create"){for(var P=0;P<this.importColorPalette.length;P++){var E=this.importColorPalette[P];var $=E>>>16&255;var _=E>>>8&255;var B=E>>>0&255;D.push([$,_,B,255])}}else{for(var P=0;P<this.colors.length;P++){D.push(r.getRGBA(this.colors[P]))}}this.imageLib.palette=D;this.imageLib.setImageData(this.imageData);if(this.colorReductionMethod=="dither"){this.imageData=this.imageLib.reduceDither({kernel:this.ditherMethod})}else{this.imageData=this.imageLib.reduceNearest()}}this.srcContext.putImageData(this.imageData,0,0,0,0,this.srcCanvas.width,this.srcCanvas.height);if(this.limitColorsPerCell){ImageUtils.limitColorsPerCell(this.srcContext,{colors:I,dithKern:k,width:this.srcCanvas.width,height:this.srcCanvas.height})}}if(this.colorReductionMethod=="edge"){ImageUtils.edgeDetect(this.imageData,{lowThreshold:this.edgeDetectLowThreshold,highThreshold:this.edgeDetectHighThreshold,blurRadius:this.edgeDetectBlurRadius,lineThickness:this.edgeDetectLineThickness});this.srcContext.putImageData(this.imageData,0,0,0,0,this.srcCanvas.width,this.srcCanvas.height)}}},drawPreview:function(){if(!this.importInProgress){if(!this.importImageContext){return}var e=this.importImageCanvas.width;var t=this.importImageCanvas.height;var i=this.editor.checkerboardPattern.getCanvas(e,t);this.importImageContext.drawImage(i,0,0,e,t,0,0,e,t);this.importImageContext.drawImage(this.srcCanvas,0,0,e,t);this.importImageContext.beginPath();this.importImageContext.moveTo(this.crosshairX*this.previewScale+.5,0);this.importImageContext.lineTo(this.crosshairX*this.previewScale+.5,this.srcCanvas.height*this.previewScale);this.importImageContext.strokeStyle="#ffff00";this.importImageContext.lineWidth=1;this.importImageContext.stroke();this.importImageContext.beginPath();this.importImageContext.moveTo(0,this.crosshairY*this.previewScale+.5);this.importImageContext.lineTo(this.srcCanvas.width*this.previewScale,this.crosshairY*this.previewScale+.5);this.importImageContext.strokeStyle="#ffff00";this.importImageContext.stroke()}},mouseDown:function(e){},mouseMove:function(e){this.rangeMouseMove(e);if(this.mouseIsDown){var t=this.imageScale;var i=e.pageX;var r=e.pageY;var a=i-this.mouseDownAtX;var s=r-this.mouseDownAtY;a=a*100/t/this.previewScale;s=s*100/t/this.previewScale;if(a>2||s>2){this.movingImage=true}var o=this.currentOffsetX+a;$("#importImageX").val(o);this.imageX=o;var l=this.currentOffsetY+s;$("#importImageY").val(l);this.imageY=l;this.parameterChanged()}},mouseUp:function(e){this.mouseIsDown=false;if(this.mouseDownInRange){this.rangeMouseUp(e)}UI.setCursor("default")},setImportVideo:function(e){this.importSource="video";this.resetCacheCanvas();if(g_app.isMobile()){}else{var t=parseInt($("#importImageFrames").val());if(isNaN(t)||t<=1){$("#importImageFrames").val(12)}this.innerSplitPanel.resizeThePanel({panel:"north",size:388});$("#importImageVideoControls").show();if(typeof e.name!="undefined"){$("#importImageChooseFileName").html(e.name)}else{$("#importImageChooseFileName").html("")}}this.setVideoImportParams();var i=window.URL||window.webkitURL;var r=i.createObjectURL(e);if(!this.importVideo){this.importVideo=document.createElement("video")}var a=false;this.videoLoaded=false;var s=this;this.importVideo.onseeked=function(){s.videoFrameReady=true;if(s.importingVideo){s.frameReadyForImport()}else{if(g_app.isMobile()){s.drawRangeControl();s.importImageMobile.parameterChanged()}else{s.drawRangeControl();s.parameterChanged()}}};this.importVideo.oncanplaythrough=function(){var e=s.importVideo.duration;var t=s.importVideo.playbackRate;var i=s.importVideo.seekable;if(!a){s.videoFrameReady=true;a=true;e=e*1e3;s.rangeMaxValue=e;if(g_app.isMobile()){$("#importImageMobileStartTime").attr("max",s.rangeMaxValue);$("#importImageMobileStartTimeValue").attr("max",s.rangeMaxValue);$("#importImageMobileEndTime").attr("max",s.rangeMaxValue);$("#importImageMobileEndTimeValue").attr("max",s.rangeMaxValue)}else{$("#importImageVideoInfo").html("Video Duration: "+e+"ms")}var r=5*1e3;if(r>e){r=e}s.setVideoImportFrom(0);s.setVideoImportTo(r);s.scaleImageToFit()}};this.importVideo.src=r;this.importVideo.load();this.importVideo.currentTime=0;this.updateAnimateSettings()},setImportImageFromReferenceImage:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return}var t=e.getReferenceImageData();if(!t){return}$("#importImageForm")[0].reset();$("#importImageChooseFileName").html("");this.setImportImageFromSrc(t)},setImportImage:function(e){if(typeof e=="undefined"||!e){return}if(e.type.indexOf("video/")===0){this.setImportVideo(e);return}if(typeof e.name!="undefined"){$("#importImageChooseFileName").html(e.name)}else{$("#importImageChooseFileName").html("")}var t=window.URL||window.webkitURL;var i=t.createObjectURL(e);this.setImportImageFromSrc(i)},setImportImageFromSrc:function(e){this.importVideo=null;this.innerSplitPanel.resizeThePanel({panel:"north",size:336});$("#importImageVideoControls").hide();$("#importImageTickControls").show();this.importSource="image";this.resetCacheCanvas();this.setAnimationParameters();if(!this.importImage){this.importImage=new Image}this.currentColorCount=false;var t=this;this.importImage.onload=function(){$("#importImageScale").val(100);t.importImageScale=100;$("#importImageX").val(0);$("#importImageY").val(0);t.imageX=0;t.imageY=0;if(t.useColors=="create"){t.createImportColorPalette()}t.scaleImageToFit();t.parameterChanged()};this.importImage.src=e;this.updateAnimateSettings()},initColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();var t=e.getColorCount();this.colors=[];for(var i=0;i<t;i++){this.colors.push(i)}this.bgColors=[];for(var i=0;i<t;i++){this.bgColors.push(i)}},findBackgroundColors:function(){if(!this.imageData){this.imageData=this.srcContext.getImageData(0,0,this.srcCanvas.width,this.srcCanvas.height)}this.bgColors=[];for(var e=0;e<this.colors.length;e++){this.bgColors.push(this.colors[e])}if(!this.multipleBackgroundColors){if(this.backgroundColorChoose=="auto"){this.imageColors=this.importColorUtils.findColors(this.imageData,this.colors);var t=this.imageColors[0].color;this.editor.frames.setBackgroundColor(t);this.bgColors=[];this.bgColors.push(t)}else if(this.backgroundColorChoose=="manual"){this.bgColors=[];this.bgColors.push(this.backgroundColor);this.editor.setBackgroundColor(this.backgroundColor)}else{this.bgColors=[];this.bgColors.push(this.editor.graphic.getBackgroundColor())}}if(this.multipleBackgroundColors){if(this.multipleBackgroundColorsLimit){this.imageColors=this.importColorUtils.findColors(this.imageData,this.colors);var i=4;if(this.colors.length<i){i=this.colors.length}this.bgColors=[];for(var e=0;e<i;e++){this.bgColors[e]=this.imageColors[e].color}}else{this.bgColors=[];for(var e=0;e<this.colors.length;e++){this.bgColors[e]=this.colors[e]}}}},initCanvas:function(){var e=this;if(this.importImageCanvas==null){this.importImageCanvas=document.getElementById("importImageCanvas")}this.importImageContext=this.importImageCanvas.getContext("2d");this.previewScale=1;var t=this.importWidth;var i=this.importHeight;if(t>320||i>200){if(320/200>t/i){this.previewScale=200/i;t=t*200/i;i=200}else{this.previewScale=320/t;i=i*320/t;t=320}}if(this.importImageCanvas.width!=t||this.importImageCanvas.height!=i){this.importImageCanvas.width=t;this.importImageCanvas.height=i;this.importImageContext=this.importImageCanvas.getContext("2d")}},initSrcCanvas:function(){var e=this.importWidth;var t=this.importHeight;if(!this.srcCanvas){this.srcCanvas=document.createElement("canvas");this.srcCanvas.width=e;this.srcCanvas.height=t;this.shaderEffects.setInput(this.srcCanvas,this.srcCanvas);this.srcContext=this.srcCanvas.getContext("2d")}else if(this.srcCanvas.width!=e||this.srcCanvas.height!=t){this.srcCanvas.width=e;this.srcCanvas.height=t;this.srcContext=this.srcCanvas.getContext("2d");this.shaderEffects.setInput(this.srcCanvas,this.srcCanvas)}this.srcContext.imageSmoothingEnabled=this.imageSmoothing;this.srcContext.webkitImageSmoothingEnabled=this.imageSmoothing;this.srcContext.mozImageSmoothingEnabled=this.imageSmoothing;this.srcContext.msImageSmoothingEnabled=this.imageSmoothing;this.srcContext.oImageSmoothingEnabled=this.imageSmoothing;if(!this.progressCanvas){var i="";i+='<div style="margin-bottom: 6px">Import in progress...</div>';i+='<div style="text-align: center">';i+='<canvas width="128" height="80" id="importCanvas" style="border: 1px solid white"></canvas>';i+="</div>";i+='  <div style="margin-top: 2px">';i+='    <div id="importImageProgressText" style="margin-bottom: 4px">Imported x / y frames</div>';i+='    <button id="importImageCancelProgress">Stop Import</button>';i+="  </div>";var r=document.createElement("div");r.setAttribute("id","importImageProgress");r.setAttribute("style","display: none; z-index: 1000; color: white; text-align: center; padding: 4px; position: absolute; background-color: #111111; top: 32px; left: 2px; width: 120px; height: 110px; border: 1px solid #cccccc");r.innerHTML=i;document.body.append(r);var a=this;$("#importImageCancelProgress").off("click");$("#importImageCancelProgress").on("click",function(){a.endImport()});this.progressCanvas=document.getElementById("importCanvas")}this.progressCanvas.width=e/5;this.progressCanvas.height=t/5;this.progressContext=this.progressCanvas.getContext("2d");this.srcContext.clearRect(0,0,e,t)},setColors:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();if(this.useColors=="choose"&&typeof this.customColorSet!="undefined"){this.colors=[];for(var t=0;t<this.customColorSet.length;t++){this.colors.push(this.customColorSet[t])}}else if(this.useColors=="greyscale"){this.colors=[];for(var t=0;t<e.getColorCount();t++){if(e.getIsGrey(t)){this.colors.push(t)}}}else{this.colors=[];for(var t=0;t<e.getColorCount();t++){this.colors.push(t)}if(this.importInProgress){if(!this.imageData){this.imageData=this.srcContext.getImageData(0,0,this.srcCanvas.width,this.srcCanvas.height)}if(this.colors.length>this.maxColors){this.imageColors=this.importColorUtils.findColors(this.imageData,this.colors);this.colors=[];for(var t=0;t<this.maxColors;t++){this.colors.push(this.imageColors[t].color)}}}}},endImport:function(){this.importInProgress=false;this.frameImportInProgress=false;this.importingVideo=false;this.frame=1;this.frameCount=1;$("#importProgress").hide();$("#importImageProgress").hide();this.editor.history.endEntry();this.editor.graphic.redraw({allCells:true})},initEffectEvents:function(){var t=this;$("#imageImportPanX").on("keyup",function(){t.updateAnimateSettings()});$("#imageImportPanX").on("change",function(){t.updateAnimateSettings()});$("#imageImportPanY").on("keyup",function(){t.updateAnimateSettings()});$("#imageImportPanY").on("change",function(){t.updateAnimateSettings()});$("#imageImportZoomAmount").on("change",function(){t.updateAnimateSettings()});$("#imageImportZoomAmount").on("keyup",function(){t.updateAnimateSettings()});$("input[name=imageImportZoomDirection]").on("click",function(){t.updateAnimateSettings()});$("#imageImportZoomAmount").on("keyup",function(){t.updateAnimateSettings()});$("#imageImportZoomAmount").on("change",function(){t.updateAnimateSettings()});$("input[name=imageImportRotateDirection]").on("click",function(){t.updateAnimateSettings()});$("input[name=imageImportZoomLayers]").on("click",function(){t.updateAnimateSettings()});$("#imageImportZoomRotateAngleSeparation").on("keyup",function(){t.updateAnimateSettings()});$("#imageImportZoomRotateAngleSeparation").on("change",function(){t.updateAnimateSettings()});$("#imageImportZoomX").on("keyup",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){t.crosshairX=e;t.updateAnimateSettings()}});$("#imageImportZoomX").on("change",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){t.crosshairX=e;t.updateAnimateSettings()}});$("#imageImportZoomY").on("keyup",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){t.crosshairY=e;t.updateAnimateSettings()}});$("#imageImportZoomY").on("change",function(){var e=parseInt($(this).val(),10);if(!isNaN(e)){t.crosshairY=e;t.updateAnimateSettings()}});$("input[name=imageImportRotateDirectionAnticlockwise]").on("click",function(){t.updateAnimateSettings()});$(".imageEffectCheckbox").on("click",function(){t.updateAnimateSettings()});$("#importImageBrightnessDelta").on("keyup",function(){t.updateAnimateSettings()});$("#importImageBrightnessDelta").on("change",function(){t.updateAnimateSettings()});$("#importImageSaturationDelta").on("keyup",function(){t.updateAnimateSettings()});$("#importImageSaturationDelta").on("change",function(){t.updateAnimateSettings()});$("#importImageContrastDelta").on("keyup",function(){t.updateAnimateSettings()});$("#importImageContrastDelta").on("change",function(){t.updateAnimateSettings()});$(".importImageParameter").on("keyup",function(){t.updateAnimateSettings()});$(".importImageParameter").on("change",function(){t.updateAnimateSettings()})},startImport:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();var t=this.editor.colorPaletteManager.noColor;this.editor.frames.stop();this.previewAnimation=false;if(UI.isMobile.any()){this.useMobile=true;this.useShader=false}else{this.useShader=true;if($("#importImageMethod").val()=="method2"){this.useMobile=true;this.useShader=false}else if($("#importImageMethod").val()=="method1"){this.useMobile=false;this.useShader=true}else{this.useMobile=true;this.useShader=false}}switch(this.backgroundColorType){case"perCell":this.multipleBackgroundColors=true;this.multipleBackgroundColorsLimit=true;break;case"frame":this.multipleBackgroundColors=false;this.multipleBackgroundColorsLimit=false;break}if(this.useColors=="create"){e.setColors(this.importColorPalette);e.name="From Image"}this.initColors();if(this.useColors=="choose"){if(typeof this.customColorSet=="undefined"||this.customColorSet.length==0){alert("No colours chosen");return false}this.colors=[];for(var i=0;i<this.customColorSet.length;i++){if(this.customColorSet[i]!==t){this.colors.push(this.customColorSet[i])}}}else{this.colors=[];for(var i=0;i<e.getColorCount();i++){this.colors.push(i)}}if(this.colors.length>this.maxColors){if(!this.imageData){this.imageData=this.srcContext.getImageData(0,0,this.srcCanvas.width,this.srcCanvas.height)}this.imageColors=this.importColorUtils.findColors(this.imageData,this.colors);this.colors=[];for(var i=0;i<this.maxColors;i++){this.colors.push(this.imageColors[i].color)}}this.findBackgroundColors();if(this.useChars=="choose"){if(typeof this.customTileSet=="undefined"||this.customTileSet.length==0){alert("No characters chosen");return false}this.characters=[];this.charactersHasSpace=false;this.charactersHasBlock=false;for(var i=0;i<this.customTileSet.length;i++){this.characters.push(this.customTileSet[i])}if(this.customTileSet[i]==this.editor.tileSetManager.blankCharacter){this.charactersHasSpace=true}if(this.customTileSet[i]==160){this.charactersHasBlock=true}}else{this.characters=[];for(var i=0;i<256;i++){this.characters.push(i)}this.charactersHasSpace=true;this.charactersHasBlock=true}this.importImageAnimate=true;this.frame=0;this.frameCount=1;if(this.importSource=="video"){this.setVideoImportParams()}if(this.importImageAnimate&&!g_app.isMobile()){this.setAnimationParameters();var r=parseInt($("#importImageTicksPerFrame").val());if(!isNaN(r)){this.editor.graphic.setFrameDuration(r);$("#frameDuration").val(r)}}this.editor.history.startEntry("Import Image");this.importInProgress=true;if(this.importSource=="video"){this.frameImportInProgress=true;this.frameReady=false;this.importingVideo=true;this.firstVideoFrame=true;if(this.videoPlaybackDirection=="backwards"){this.importVideo.currentTime=this.videoEndAt/1e3}else{this.importVideo.currentTime=this.videoStartAt/1e3}}else{this.frameImportInProgress=true;this.frameReady=true;this.importingVideo=false;this.parameterChanged();this.updateProgress()}if(this.useMobile){this.mobileImport.setColors(this.colors);this.mobileImport.setBGColors(this.bgColors);this.mobileImport.setCharacters(this.characters);this.mobileImport.setUseMultipleBGColors(this.multipleBackgroundColors);this.mobileImport.setBackgroundColorChoose(this.backgroundColorChoose)}else if(this.useShader){this.shaderImport.setColors(this.colors);this.shaderImport.setBGColors(this.bgColors);this.shaderImport.setCharacters(this.characters);this.shaderImport.setUseMultipleBGColors(this.multipleBackgroundColors);this.shaderImport.setBackgroundColorChoose(this.backgroundColorChoose);this.shaderImport.startImport()}else{this.basicImport.setColors(this.colors);this.basicImport.setBGColors(this.bgColors);this.basicImport.setCharacters(this.characters);this.basicImport.setUseMultipleBGColors(this.multipleBackgroundColors);this.basicImport.setImageData(this.imageData);this.basicImport.startImport()}return true},showProgress:function(){this.updateProgress()},updateProgress:function(){var e=this.frame+1;$("#importImageProgressText").html("Frame "+e+" of "+this.frameCount);$("#importImageProgress").show();this.progressContext.clearRect(0,0,this.progressCanvas.width,this.progressCanvas.height);this.progressContext.drawImage(this.srcCanvas,0,0,this.progressCanvas.width,this.progressCanvas.height)},nextFrame:function(){if(!this.insertFrames&&this.editor.graphic.getCurrentFrame()<this.editor.graphic.getFrameCount()-1){this.editor.frames.nextFrame()}else{var e=this.editor.graphic.insertFrame();this.editor.frames.gotoFrame(e)}var t=6;if(!g_app.isMobile()){t=parseInt($("#importImageTicksPerFrame").val())}this.editor.graphic.setFrameDuration(t)},frameReadyForImport:function(){this.parameterChanged();this.updateProgress();if(!this.useShader){if(!this.importingVideo||!this.firstVideoFrame){this.nextFrame()}this.firstVideoFrame=false;if(this.useMobile){this.mobileImport.setImageData(this.imageData);this.mobileImport.startImport()}else{this.basicImport.setImageData(this.imageData);this.basicImport.startImport()}}this.frameReady=true},updatePreview:function(){if(this.importSource=="video"&&!this.importInProgress&&!this.importingVideo){var e=getTimestamp();var t=this.ticksPerFrame;if(e-this.lastPreviewUpdate>t*50&&this.videoFrameReady){this.lastPreviewUpdate=e;this.frame++;var i=0;if(this.videoPlaybackDirection=="backwards"){i=(this.videoEndAt-this.frame*this.videoSampleEvery)/1e3}else if(this.videoPlaybackDirection=="pingpong"){if(this.frame<this.frameCount/2){i=(this.videoStartAt+this.frame*this.videoSampleEvery)/1e3}else{var r=Math.ceil(this.frameCount/2);var a=r-(this.frame-r);i=(this.videoStartAt+a*this.videoSampleEvery)/1e3}}else{i=(this.videoStartAt+this.frame*this.videoSampleEvery)/1e3}if(i<0){i=0}if(i>this.importVideo.duration){i=this.importVideo.duration}if(!isNaN(i)){this.importVideo.currentTime=i;this.videoFrameReady=false}if(this.frame+1>=this.frameCount){this.frame=-1}}}if(this.previewAnimation&&!this.importInProgress){var e=getTimestamp();var t=this.ticksPerFrame;if(e-this.lastPreviewUpdate>t*50){this.lastPreviewUpdate=e;if(this.importSource=="video"){}else{this.frame++;this.parameterChanged()}if(this.frame+1>=this.frameCount){this.frame=-1}}}},update:function(){if(!this.importInProgress&&!this.visible){return}if(this.frameCount>1){this.updatePreview()}else{}if(this.importInProgress){if(this.frameImportInProgress&&this.frameReady){if(this.useMobile){var e=this.frame+1;var t="Frame "+e+" of "+this.frameCount;t+=", "+this.mobileImport.getProgress();$("#importImageProgressText").html(t);if(this.frame!=0){}this.mobileImport.startImport();this.mobileImport.setImageData(this.imageData);this.frameImportInProgress=false}else if(this.useShader){this.shaderImport.setSrcCanvas(this.srcCanvas);this.shaderImport.convert();if(this.frame!=0){this.nextFrame()}this.shaderImport.updateFrame();this.frameImportInProgress=false}else{var e=this.frame+1;var t="Frame "+e+" of "+this.frameCount;t+=", "+this.basicImport.getProgress();$("#importImageProgressText").html(t);this.frameImportInProgress=this.basicImport.update()}}if(!this.frameImportInProgress){this.frame++;if(this.frame>=this.frameCount){this.endImport()}else{this.importInProgress=true;this.frameImportInProgress=true;if(this.importSource=="video"){this.frameReady=false;var i=0;if(this.videoPlaybackDirection=="backwards"){i=(this.videoEndAt-this.frame*this.videoSampleEvery)/1e3}else if(this.videoPlaybackDirection=="pingpong"){if(this.frame<this.frameCount/2){i=(this.videoStartAt+this.frame*this.videoSampleEvery)/1e3}else{var r=Math.ceil(this.frameCount/2);var a=r-(this.frame-r);i=(this.videoStartAt+a*this.videoSampleEvery)/1e3}}else{i=(this.videoStartAt+this.frame*this.videoSampleEvery)/1e3}if(i<0){i=0}if(i>this.importVideo.duration){i=this.importVideo.duration}this.importVideo.currentTime=i}else{this.frameReadyForImport()}}}}}};var ImportImageMobile=function(){this.uiComponent=null;this.importer=null;this.editor=null;this.importWidth=0;this.importHeight=0;this.previewScale=null;this.previewCanvas=null;this.previewContext=null;this.backgroundCanvas=null;this.backgroundContext=null;this.useChars="all";this.useColors="all";this.touchCount=0;this.doImport=false;this.visible=false;this.frameCount=24;this.speed=9;this.mirrorH=false;this.mirrorV=false;this.invertColors=false};ImportImageMobile.prototype={init:function(e,t){this.editor=e;this.importer=t},initEvents:function(){var i=this;document.getElementById("importImageMobileSourceFile").addEventListener("change",function(e){var t=document.getElementById("importImageMobileSourceFile").files[0];i.setImportImage(t)});$("#importImageMobileChooseFile").on("click",function(){$("#importImageMobileSourceFile").click()});$("#importImageMobileScaleToFit").on("click",function(e){i.importer.scaleImageToFit();i.setScale(i.importer.importImageScale)});$("#importImageColorReductionMobile").on("change",function(e){var t=$(this).val();i.setColorReductionMethod(t);i.parameterChanged()});$("#importImageDitherMobile").on("change",function(e){var t=$(this).val();i.setDitherMethod(t);i.parameterChanged()});$("#togglePerCell").on("click",function(e){i.importer.limitColorsPerCell=!i.importer.limitColorsPerCell;i.parameterChanged()});$("#importImageMobileDirection").on("change",function(){i.importer.videoPlaybackDirection=$(this).val();i.importer.setVideoImportParams()});$("#importImageMobileStartTime").on("change",function(){i.importer.setVideoImportFrom($(this).val())});$("#importImageMobileStartTime").on("input",function(){i.importer.setVideoImportFrom($(this).val())});$("#importImageMobileStartTimeValue").on("change",function(){i.importer.setVideoImportFrom($(this).val())});$("#importImageMobileEndTime").on("change",function(){i.importer.setVideoImportTo($(this).val())});$("#importImageMobileEndTime").on("input",function(){i.importer.setVideoImportTo($(this).val())});$("#importImageMobileEndTimeValue").on("change",function(){i.importer.setVideoImportTo($(this).val())});$("#importImageMobileEndTimeReset").on("click",function(){var e=5*1e3;var t=i.importer.importVideo.duration;if(e>t){e=t}i.importer.setVideoImportTo(e)});$("#importImageMobileStartTime").on("change",function(){i.importer.setVideoImportFrom($(this).val())});$("#importImageMobileStartTime").on("input",function(){i.importer.setVideoImportFrom($(this).val())});$("#importImageMobileStartTimeValue").on("change",function(){i.importer.setVideoImportFrom($(this).val())});$("#importImageMobileStartTimeReset").on("click",function(){i.importer.setVideoImportFrom(0)});$("#importImageMobileFrames").on("change",function(){i.setFrameCount($(this).val())});$("#importImageMobileFrames").on("input",function(){i.setFrameCount($(this).val())});$("#importImageMobileFramesValue").on("change",function(){i.setFrameCount($(this).val())});$("#importImageMobileFramesReset").on("click",function(){i.setFrameCount(24)});$("#importImageMobileSpeed").on("change",function(){i.setSpeed($(this).val())});$("#importImageMobileSpeed").on("input",function(){i.setSpeed($(this).val())});$("#importImageMobileSpeedValue").on("change",function(){i.setSpeed($(this).val())});$("#importImageMobileSpeedReset").on("click",function(){i.setSpeed(8)});$("#importImageMobileScale").on("change",function(){i.setScale($(this).val())});$("#importImageMobileScale").on("input",function(){i.setScale($(this).val())});$("#importImageMobileScaleValue").on("change",function(){i.setScale($(this).val())});$("#importImageMobileRotation").on("change",function(){i.setRotation($(this).val())});$("#importImageMobileRotation").on("input",function(){i.setRotation($(this).val())});$("#importImageMobileRotationValue").on("change",function(){i.setRotation($(this).val())});$("#importImageMobileRotation90").on("click",function(){i.rotate90()});$("#importImageMobileBrightness").on("change",function(){i.importer.brightness=$(this).val();$("#importImageMobileBrightnessValue").val(i.importer.brightness);if(i.importer.importSource!="video"){i.parameterChanged()}});$("#importImageMobileBrightness").on("input",function(){i.importer.brightness=$(this).val();$("#importImageMobileBrightnessValue").val(i.importer.brightness);if(i.importer.importSource!="video"){i.parameterChanged()}});$("#importImageMobileBrightnessValue").on("change",function(){i.importer.brightness=$(this).val();$("#importImageMobileBrightness").val(i.importer.brightness);if(i.importer.importSource!="video"){i.parameterChanged()}});$("#importImageMobileBrightnessReset").on("click",function(){i.setBrightness(0)});$("#importImageMobileContrast").on("change",function(){i.importer.contrast=$(this).val();$("#importImageMobileContrastValue").val(i.importer.contrast);if(i.importer.importSource!="video"){i.parameterChanged()}});$("#importImageMobileContrast").on("input",function(){i.importer.contrast=$(this).val();$("#importImageMobileContrastValue").val(i.importer.contrast);if(i.importer.importSource!="video"){i.parameterChanged()}});$("#importImageMobileContrastValue").on("change",function(){i.importer.contrast=$(this).val();$("#importImageMobileContrast").val(i.importer.contrast);if(i.importer.importSource!="video"){i.parameterChanged()}});$("#importImageMobileContrastReset").on("click",function(){i.setContrast(0)});$("#importImageMobileSaturation").on("change",function(){i.importer.saturation=$(this).val();$("#importImageMobileSaturationValue").val(i.importer.saturation);if(i.importer.importSource!="video"){i.parameterChanged()}});$("#importImageMobileSaturation").on("input",function(){i.importer.saturation=$(this).val();$("#importImageMobileSaturationValue").val(i.importer.saturation);if(i.importer.importSource!="video"){i.parameterChanged()}});$("#importImageMobileSaturationValue").on("change",function(){i.importer.saturation=$(this).val();$("#importImageMobileSaturation").val(i.importer.saturation);if(i.importer.importSource!="video"){i.parameterChanged()}});$("#importImageMobileSaturationReset").on("click",function(){i.setSaturation(0)});$("#importImageMobileChooseChars").on("click",function(e){i.chooseTiles()});$("#importImageMobileChooseColors").on("click",function(e){i.chooseColors()});$("#importImageMobileUseChars").on("change",function(e){i.useChars=$(this).val();if(i.useChars=="all"){$("#importImageCharsMobile").css("border-bottom","1px solid #444444");$("#importImageMobileChooseChars").hide();$("#importImageMobileChooseCharsContainer").hide()}else{$("#importImageCharsMobile").css("border-bottom","0px solid #444444");$("#importImageMobileChooseChars").show();$("#importImageMobileChooseCharsContainer").show();i.chooseTiles()}});$("#importImageMobileUseColors").on("change",function(e){i.useColors=$(this).val();i.importer.useColors=i.useColors;i.parameterChanged();if(i.useColors=="all"){$("#importImageColorsMobile").css("border-bottom","1px solid #444444");$("#importImageMobileChooseColorsContainer").hide();$("#importImageMobileChooseColors").hide()}else{$("#importImageColorsMobile").css("border-bottom","0px");$("#importImageMobileChooseColorsContainer").show();$("#importImageMobileChooseColors").show();i.chooseColors()}});$("#importImageMobileBackgroundColorType").on("change",function(e){i.importer.backgroundColorType=$(this).val()});$("#importImageMobileMirrorH").on("click",function(e){i.mirrorH=$(this).is(":checked");i.parameterChanged()});$("#importImageMobileMirrorV").on("click",function(e){i.mirrorV=$(this).is(":checked");i.parameterChanged()});$("#importImageMobileInvertColors").on("click",function(e){i.importer.invertColors=$(this).is(":checked");i.parameterChanged()})},setBrightness:function(e){this.importer.brightness=e;$("#importImageMobileBrightness").val(this.importer.brightness);$("#importImageMobileBrightnessValue").val(this.importer.brightness);if(this.importer.importSource!="video"){this.parameterChanged()}},setContrast:function(e){this.importer.contrast=e;$("#importImageMobileContrast").val(this.importer.contrast);$("#importImageMobileContrastValue").val(this.importer.contrast);if(this.importer.importSource!="video"){this.parameterChanged()}},setSaturation:function(e){this.importer.saturation=e;$("#importImageMobileSaturation").val(this.importer.saturation);$("#importImageMobileSaturationValue").val(this.importer.saturation);if(this.importer.importSource!="video"){this.parameterChanged()}},setFrameCount:function(e){e=parseInt(e,10);if(isNaN(e)){return}$("#importImageMobileFrames").val(e);$("#importImageMobileFramesValue").val(e);this.frameCount=e;this.importer.frameCount=e;this.importer.setVideoImportParams()},setSpeed:function(e){e=parseInt(e,10);if(isNaN(e)){return}$("#importImageMobileSpeed").val(e);$("#importImageMobileSpeedValue").val(e);this.speed=e;this.importer.ticksPerFrame=13-this.speed;this.importer.setVideoImportParams()},setScale:function(e,t){e=parseFloat(e);if(isNaN(e)){return}this.importer.importImageScale=e;$("#importImageMobileScaleValue").val(this.importer.importImageScale);$("#importImageMobileScale").val(this.importer.importImageScale);if(typeof t=="undefined"||t){this.parameterChanged()}},rotate90:function(){var e=(this.importer.rotateAmount+90)%360;this.setRotation(e)},setRotation:function(e){console.log("set rotation to "+e);e=parseInt(e,10);if(isNaN(e)){return}$("#importImageMobileRotation").val(e);$("#importImageMobileRotationValue").val(e);var t=e-this.importer.rotateAmount;var i=this.importer.imageX-this.importer.crosshairX;var r=this.importer.imageY-this.importer.crosshairY;this.importer.imageX=Math.cos(t*Math.PI/180)*i-Math.sin(t*Math.PI/180)*r;this.importer.imageY=Math.cos(t*Math.PI/180)*r+Math.sin(t*Math.PI/180)*i;this.importer.imageX+=this.importer.crosshairX;this.importer.imageY+=this.importer.crosshairY;this.importer.rotateAmount=e;this.parameterChanged()},show:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.MobilePanel",{id:"importImageMobile",title:"Import Image",fullScreen:true,maxWidth:640,maxHeight:800});var e=UI.create("UI.HTMLPanel",{id:"importImageHTML"});this.uiComponent.add(e);e.load("html/textMode/importImageMobile.html",function(){t.importer.initRangeControl();t.initEvents();t.initContent()});this.importButton=UI.create("UI.Button",{text:"Import"});this.importButton.on("click",function(e){t.doImport=true;UI.closeDialog()});this.uiComponent.on("close",function(){t.visible=false;t.importer.visible=false;if(t.doImport){t.showProgress();setTimeout(function(){t.startImport()},10)}});this.uiComponent.addButton(this.importButton)}else{this.initContent()}UI.showDialog("importImageMobile");this.visible=true;this.importer.visible=true},initContent:function(){this.doImport=false;this.initCanvas();this.importer.crosshairX=this.importer.importWidth/2;this.importer.crosshairY=this.importer.importHeight/2;this.importer.setSmoothingMethod(false);this.setColorReductionMethod($("#importImageColorReductionMobile").val());this.setDitherMethod($("#importImageDitherMobile").val());this.setScale(this.importer.importImageScale);this.useChars=$("#importImageMobileUseChars").val();this.useColors=$("#importImageMobileUseColors").val();this.importer.backgroundColorType=$("#importImageMobileBackgroundColorType").val();this.importer.backgroundColorChoose="auto";if(this.importer.importSource=="video"&&this.importer.importVideo){this.importer.videoFrameReady=true;this.importer.importInProgress=false;this.setFrameCount($("#importImageMobileFramesValue").val())}this.importer.videoPlaybackDirection=$("#importImageMobileDirection").val()},initCanvas:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return}var t=320;var i=200;var r=this.editor.tileSetManager.getCurrentTileSet();var a=this;if(this.previewCanvas==null){this.previewCanvas=document.getElementById("importImageMobileCanvas");this.previewCanvas.addEventListener("touchstart",function(e){a.touchStart(e)},false);this.previewCanvas.addEventListener("touchmove",function(e){a.touchMove(e);return false},false);this.previewCanvas.addEventListener("touchend",function(e){a.touchEnd(e)},false)}this.previewContext=this.previewCanvas.getContext("2d");this.importWidth=e.getGridWidth()*e.getCellWidth();this.importHeight=e.getGridHeight()*e.getCellHeight();this.previewScale=1;var s=this.importWidth;var o=this.importHeight;if(s>t||o>i){if(t/i>s/o){this.previewScale=i/o;s=s*i/o;o=i}else{this.previewScale=t/s;o=o*t/s;s=t}}if(this.previewCanvas.width!=s||this.previewCanvas.height!=o){this.previewCanvas.width=s;this.previewCanvas.height=o;this.previewContext=this.previewCanvas.getContext("2d")}if(this.backgroundCanvas==null){this.backgroundCanvas=document.createElement("canvas")}if(this.backgroundCanvas.width!=s||this.backgroundCanvas.height!=o){this.backgroundCanvas.width=s;this.backgroundCanvas.height=o;this.backgroundContext=this.backgroundCanvas.getContext("2d")}this.backgroundContext.fillStyle="#cccccc";this.backgroundContext.fillRect(0,0,this.backgroundCanvas.width,this.backgroundCanvas.height);var l=5;var n=Math.ceil(this.backgroundCanvas.width/l);var h=Math.ceil(this.backgroundCanvas.height/l);this.backgroundContext.fillStyle="#bbbbbb";for(var d=0;d<h;d++){for(var c=0;c<n;c++){if((c+d)%2){this.backgroundContext.fillRect(c*l,d*l,l,l)}}}this.previewContext.drawImage(this.backgroundCanvas,0,0,this.previewCanvas.width,this.previewCanvas.height)},drawPreview:function(){if(!this.importer.importInProgress){if(!this.previewContext){return}this.previewContext.drawImage(this.backgroundCanvas,0,0,this.previewCanvas.width,this.previewCanvas.height);this.previewContext.drawImage(this.importer.srcCanvas,0,0,this.previewCanvas.width,this.previewCanvas.height)}},touchStart:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1){this.touchCount=1;var s=t[0].pageX-r;var o=t[0].pageY-a;this.mouseDownAtX=s;this.mouseDownAtY=o;this.currentOffsetX=this.importer.imageX;this.currentOffsetY=this.importer.imageY;this.mouseIsDown=true}if(t.length==2){this.touchCount=2;this.touchStart0X=t[0].pageX-r;this.touchStart0Y=t[0].pageY-a;this.touchStart1X=t[1].pageX-r;this.touchStart1Y=t[1].pageY-a;this.touchStartDistance=(this.touchStart0X-this.touchStart1X)*(this.touchStart0X-this.touchStart1X)+(this.touchStart0Y-this.touchStart1Y)*(this.touchStart0Y-this.touchStart1Y);this.touchStartDistance=Math.sqrt(this.touchStartDistance);this.touchStartMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchStartMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.touchMoveMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchMoveMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.pinchStartScale=this.importer.importImageScale}this.setColorReductionMethod("none")},touchMove:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1&&this.touchCount==1){var s=t[0].pageX-r;var o=t[0].pageY-a;var l=this.importer.imageScale;var n=s-this.mouseDownAtX;var h=o-this.mouseDownAtY;n=n*100/l/this.previewScale;h=h*100/l/this.previewScale;if(n>2||h>2){this.movingImage=true}var d=this.currentOffsetX+n;this.importer.imageX=d;var c=this.currentOffsetY+h;this.importer.imageY=c;this.parameterChanged()}if(t.length==2){this.touchMove0X=t[0].pageX-r;this.touchMove0Y=t[0].pageY-a;this.touchMove1X=t[1].pageX-r;this.touchMove1Y=t[1].pageY-a;this.touchMoveDistance=(this.touchMove0X-this.touchMove1X)*(this.touchMove0X-this.touchMove1X)+(this.touchMove0Y-this.touchMove1Y)*(this.touchMove0Y-this.touchMove1Y);this.touchMoveDistance=Math.sqrt(this.touchMoveDistance);var f=this.touchMoveMidX;var u=this.touchMoveMidY;var p=(this.touchMove0X+this.touchMove1X)/2;var v=(this.touchMove0Y+this.touchMove1Y)/2;this.touchMoveMidX=p;this.touchMoveMidY=v;var g=this.touchMoveDistance/this.touchStartDistance*this.pinchStartScale;this.setScale(g,false);var l=this.importer.imageScale;var m=p-f;var y=v-u;m=m*100/l/this.previewScale;y=y*100/l/this.previewScale;this.importer.imageX+=m;this.importer.imageY+=y;this.parameterChanged()}},touchEnd:function(e){var t=$("#importImageColorReductionMobile").val();this.setColorReductionMethod(t);this.parameterChanged()},setDitherMethod:function(e){this.importer.ditherMethod=e},setColorReductionMethod:function(e){this.importer.colorReductionMethod=e;if(e=="dither"){$("#importImageDitherGroupMobile").show()}else{$("#importImageDitherGroupMobile").hide()}},parameterChanged:function(){if(this.mirrorH||this.mirrorV){this.importer.importImageAnimate=true;this.importer.useEffects=true;for(var e=0;e<this.importer.importEffects.length;e++){if(this.importer.importEffects[e].name=="Mirror"){this.importer.importEffects[e].enabled=true;this.importer.importEffects[e].params.mirror.value=[];if(this.mirrorH){this.importer.importEffects[e].params.mirror.value.push("Horizontal")}if(this.mirrorV){this.importer.importEffects[e].params.mirror.value.push("Vertical")}}}this.importer.updateShaderEffects()}else{this.importer.importImageAnimate=false;this.importer.useEffects=false}this.importer.updateImportImage();this.drawPreview()},setImportVideo:function(e){$(".importImageMobileVideoSetting").show();$("#importImageSourceContainer").css("height","296px");$("#importImageControlsContainer").css("top","308px");$("#importImageControlsContainer").show();this.importer.setImportVideo(e)},setImportImage:function(e){if(e.type.indexOf("video/")===0){this.setImportVideo(e);return}$(".importImageMobileVideoSetting").hide();$("#importImageSourceContainer").css("height","280px");$("#importImageControlsContainer").css("top","292px");$("#importImageControlsContainer").show();this.importer.resetCacheCanvas();this.importer.importSource="image";if(!this.importer.importImage){this.importer.importImage=new Image}var t=window.URL||window.webkitURL;var i=t.createObjectURL(e);var r=this;this.importer.importImage.onload=function(){r.importer.scaleImageToFit();r.setScale(r.importer.importImageScale);r.setBrightness(0);r.setSaturation(0);r.setContrast(0)};this.importer.importImage.src=i},showProgress:function(){},startImport:function(){this.importer.useChars=this.useChars;this.importer.useColors=this.useColors;this.importer.startImport()},chooseTiles:function(){if(this.tilePaletteChooserMobile==null){var i=this;this.tilePaletteChooserMobile=new TilePaletteChooserMobile;this.tilePaletteChooserMobile.init(this.editor,{mode:"multiple",id:"Picker"});this.tilePaletteChooserMobile.on("close",function(){var e=i.tilePaletteChooserMobile.getSelectedCharacters();i.importer.customTileSet=[];for(var t=0;t<e.length;t++){i.importer.customTileSet.push(e[t])}})}var e=0;if(typeof this.importer.customTileSet=="undefined"){this.importer.customTileSet=[]}this.tilePaletteChooserMobile.show({characters:this.importer.customTileSet})},chooseColors:function(){if(this.colorPickerMobile==null){var i=this;this.colorPickerMobile=new ColorPickerMobile;this.colorPickerMobile.init(this.editor,{canSelectMultiple:true,id:"Picker"});this.colorPickerMobile.on("close",function(){var e=i.colorPickerMobile.getSelectedColors();i.importer.customColorSet=[];for(var t=0;t<e.length;t++){i.importer.customColorSet.push(e[t])}i.parameterChanged()})}if(typeof this.importer.customColorSet=="undefined"){this.importer.customColorSet=[]}this.colorPickerMobile.show({colors:this.importer.customColorSet})}};var ImportShaderEditor=function(){this.uiComponent=null;this.importImage=null;this.sourceCanvas=null;this.sourceContext=null;this.outputCanvas=null;this.outputContext=null;this.scale=1;this.shader="\r\n\r\nuniform sampler2D inputImage;\r\nuniform sampler2D charImage;\r\nuniform sampler2D colorImage;\r\nuniform vec3 fgColor;\r\nuniform vec4 bgColor;\r\nuniform int charCount;\r\nuniform float inputImageWidth;\r\nuniform float inputImageHeight;\r\nuniform float inputImageCols;\r\nuniform float inputImageRows;\r\nuniform float outputImageWidth;\r\nuniform float outputImageHeight;\r\n\r\n\r\nvarying vec2 vUv;\r\n\r\n\r\nvec3 RGB2Lab(vec3 rgb){\r\n    float R = rgb.x;\r\n    float G = rgb.y;\r\n    float B = rgb.z;\r\n    // threshold\r\n    float T = 0.008856;\r\n\r\n    float X = R * 0.412453 + G * 0.357580 + B * 0.180423;\r\n    float Y = R * 0.212671 + G * 0.715160 + B * 0.072169;\r\n    float Z = R * 0.019334 + G * 0.119193 + B * 0.950227;\r\n\r\n    // Normalize for D65 white point\r\n    X = X / 0.950456;\r\n    Y = Y;\r\n    Z = Z / 1.088754;\r\n\r\n    bool XT, YT, ZT;\r\n    XT = false; YT=false; ZT=false;\r\n    if(X > T) XT = true;\r\n    if(Y > T) YT = true;\r\n    if(Z > T) ZT = true;\r\n\r\n    float Y3 = pow(Y,1.0/3.0);\r\n    float fX, fY, fZ;\r\n    if(XT){ fX = pow(X, 1.0/3.0);} else{ fX = 7.787 * X + 16.0/116.0; }\r\n    if(YT){ fY = Y3; } else{ fY = 7.787 * Y + 16.0/116.0 ; }\r\n    if(ZT){ fZ = pow(Z,1.0/3.0); } else{ fZ = 7.787 * Z + 16.0/116.0; }\r\n\r\n    float L; if(YT){ L = (116.0 * Y3) - 16.0; }else { L = 903.3 * Y; }\r\n    float a = 500.0 * ( fX - fY );\r\n    float b = 200.0 * ( fY - fZ );\r\n\r\n    return vec3(L,a,b);\r\n}\r\n\r\n\r\nvec2 findCharacter(float x, float y, vec4 fgColorVec4, vec4 bgColorVec4) {\r\n\r\n//  float inputImageWidth = 512.0;\r\n//  float inputImageHeight = 256.0; \r\n  int character = 0;\r\n  float bestScore = 0.00;\r\n\r\n//  vec3 fgColorLAB = RGB2Lab(vec3(1.0, 1.0, 1.0));\r\n  vec3 fgColorLAB = RGB2Lab( vec3(fgColorVec4.x, fgColorVec4.y, fgColorVec4.z));\r\n  //vec3 bgColorLAB = RGB2Lab(vec3(bgColorVec4.x, bgColorVec4.y, bgColorVec4.z)); \r\n  vec3 bgColorLAB = RGB2Lab(vec3(bgColor.x, bgColor.y, bgColor.z));  \r\n\r\n  // loop through the top row\r\n  for(float i = 0.0; i < 256.0; i++) {\r\n      if(int(i) < charCount) {\r\n        float score = 0.0; \r\n        // loop through xy of input image, compare to character\r\n        for(int cy = 0; cy < {charHeight}; cy++) {\r\n          for(int cx = 0; cx < {charWidth}; cx++) {\r\n            float imageX = (x * {charWidth}.0 + float(cx)) / inputImageWidth;\r\n            float imageY = (inputImageHeight - 1.0 - y * {charHeight}.0 - float(cy)) / inputImageHeight;\r\n            vec4 imagePixel = texture2D(inputImage, vec2(imageX, imageY) );\r\n  \r\n            float charCol = mod(float(i), 16.0);\r\n            float charRow = floor(float(i) / 16.0);\r\n            float charImageHeight = 128.0;\r\n            float charImageWidth = 128.0; \r\n            \r\n            float charX = (charCol * {charWidth}.0 + float(cx)) / charImageWidth;\r\n            float charY = (charImageHeight - charRow * {charHeight}.0 - 1.0  - float(cy)) / charImageHeight;\r\n  //          float charY =   ({charHeight}.0 - 1.0 - float(cy)) / ({charHeight}.0 - 1.0);\r\n            vec4 charPixel = texture2D(charImage, vec2(charX, charY));\r\n  \r\n            vec3 imagePixelLAB = RGB2Lab(vec3(imagePixel.x, imagePixel.y, imagePixel.z));\r\n  \r\n            if(charPixel.x > 0.3) {\r\n    //          score = score + abs(imagePixel.x - fgColorVec4.x) + abs(fgColorVec4.y - 1.0) + abs(fgColorVec4.z - 1.0);\r\n              if(imagePixel.w < 0.4) {\r\n                  // its transparent\r\n                  score += 3.0;\r\n              } else {\r\n                score = score + abs(imagePixelLAB.x - fgColorLAB.x) + abs(imagePixelLAB.y - fgColorLAB.y) + abs(imagePixelLAB.z - fgColorLAB.z);\r\n              }\r\n  \r\n            } else {\r\n  //            score = score + abs(imagePixel.x - bgColor.x) + abs(imagePixel.y -bgColor.y) + abs(imagePixel.z -bgColor.z);\r\n\r\n              if(imagePixel.w < 0.3) {\r\n                // its transparent\r\n                if(bgColor.w == 0.0) {\r\n                  // good match..\r\n                  score += 0.0;\r\n                } else {\r\n                  score += 3.0;\r\n                }\r\n              } else {  \r\n                if(bgColor.w == 0.0) {\r\n                  score = score + 713.0;\r\n                } else {\r\n                  score = score + abs(imagePixelLAB.x - bgColorLAB.x) + abs(imagePixelLAB.y - bgColorLAB.y) + abs(imagePixelLAB.z  - bgColorLAB.z);\r\n                }\r\n              }\r\n  \r\n    /*\r\n              if(imagePixel.w == 0.0) {\r\n                score += 0.0;\r\n              } else {\r\n                score = score + abs(imagePixelLAB.x - bgColorLAB.x) + abs(imagePixelLAB.y - bgColorLAB.y) + abs(imagePixelLAB.z  - bgColorLAB.z);\r\n              }\r\n    */\r\n  \r\n            }\r\n   \r\n          }\r\n        }\r\n  \r\n  //      if(character < charCount) {\r\n          if(i == 0.0) {\r\n            bestScore = score;\r\n            character = int(i);\r\n          }\r\n          \r\n          \r\n          if(score < bestScore) {\r\n            character = int(i);\r\n            if(character < charCount) {\r\n              bestScore = score;\r\n            }\r\n          }\r\n    }\r\n//      }\r\n  }\r\n\r\n\r\n\r\n//character = int(y);\r\n  return vec2(float(character), bestScore);\r\n}\r\n\r\n\r\n// by default gl_FragCoord assumes lower left origin\r\n// and assumes pixel centers a located at half pixel centers\r\n// gl_FragCoord is in screen coordinates, not normalised \r\n\r\nvoid main() {\r\n\r\n  // gl_FragCoord.x goes 0.5, 1.5, 2.5, etc\r\n  float resultPosition =  floor(gl_FragCoord.x) + floor(gl_FragCoord.y)  * outputImageWidth;\r\n\r\n\r\n  // 16 colours\r\n  float colorPosition = floor(resultPosition / {shaderColors}.0);\r\n  float colorIndex = mod(resultPosition , {shaderColors}.0);\r\n  \r\n  float fgColorIndex = colorIndex;//mod(colorIndex, 16.0);\r\n  float bgColorIndex = 0.0;//floor(colorIndex / 16.0);\r\n  \r\n  vec4 fgColorVec4 = texture2D(colorImage, vec2(fgColorIndex / {shaderColors}.0, \r\n          ({shaderColors}.0 - 0.5) / {shaderColors}.0));\r\n  vec4 bgColorVec4 = texture2D(colorImage, vec2(bgColorIndex / {shaderColors}.0,\r\n          ({shaderColors}.0 - 0.5) / {shaderColors}.0));\r\n          \r\n  float sourceCol = mod(colorPosition , inputImageCols);\r\n  float sourceRow = floor(colorPosition / inputImageCols);\r\n  \r\n  vec2 result = vec2(0,0);\r\n  \r\n  result =  findCharacter(sourceCol, sourceRow, fgColorVec4, bgColorVec4);\r\n  float character = result.x / 255.0;\r\n   \r\n \r\n  float score = result.y / 256.0;\r\n  float scoreL = fract(score); \r\n  float scoreH = floor(score) / 256.0;\r\n\r\n//  gl_FragColor = vec4(gl_FragCoord.x / 255.0, scoreL, scoreH, 1.0);\r\n\r\n//  gl_FragColor = vec4(inputImageCols / 255.0, 2.0, 3.0, 4.0);\r\n  gl_FragColor = vec4(character, scoreL, scoreH, 1.0);\r\n\r\n}\r\n\r\n      \r\n      \r\n\r\n      ";this.shaderImport=null};ImportShaderEditor.prototype={init:function(e){this.editor=e;this.mode="ace/mode/assembly_6502";if(typeof mode!="undefined"){this.mode=mode}},show:function(){var e=this;if(this.shaderImport==null){this.shaderImport=new ShaderImport2;this.shaderImport.init(this.editor)}if(!this.uiComponent){this.uiComponent=UI.create("UI.Dialog",{id:"importShaderEditor",title:"Edit Import Shader",width:940,height:620});this.splitPanel=UI.create("UI.SplitPanel",{id:"importShaderEditorSplitPanel"});this.uiComponent.add(this.splitPanel);this.sidePanel=UI.create("UI.SplitPanel");this.splitPanel.addEast(this.sidePanel,380);var t="";t+="<h3>Source</h3>";t+='<div class="formGroup">';t+='<label class="controlLabel" for="importShaderEditorSourceFile">File To Import:</label>';t+='<input class="formControl"  id="importShaderEditorSourceFile" type="file" accept="image/*"/>';t+="</div>";t+="<div>";t+='<canvas  width="320" height="200" id="importShaderEditorInputCanvas" style="border:1px solid white; background: transparent"></canvas>';t+="</div>";t+='<div style="margin: 6px">';t+='<button id="importShaderEditorRun">Run Import</button>';t+="&nbsp;&nbsp;";t+='<button id="importShaderExportJSON">Export JSON</button>';t+="</div>";this.inputPanel=UI.create("UI.HTMLPanel",{html:t});this.sidePanel.addNorth(this.inputPanel,300);t="";t+="<h3>Output</h3>";t+="<div>";t+='<canvas  width="320" height="200" id="importShaderEditorOutputCanvas" style="border:1px solid white; background: transparent"></canvas>';t+="</div>";t+="<div>";t+="Display: ";t+='<label><input type="checkbox" id="importShaderEditorOutputCharacter" checked="checked">Character</label>';t+='<label><input type="checkbox" id="importShaderEditorOutputColor" checked="checked">FG Colour</label>';t+='<label><input type="checkbox" id="importShaderEditorOutputBGColor" checked="checked">BG Colour</label>';t+='<label><input type="checkbox" id="importShaderEditorOutputOriginalImage" checked="checked">Original Image</label>';t+="</div>";this.outputPanel=UI.create("UI.HTMLPanel",{html:t});this.sidePanel.add(this.outputPanel);this.codePanel=UI.create("UI.SplitPanel");this.splitPanel.add(this.codePanel);var t='<button id="importShaderEditorRun">Run</button>';var t="";this.buttonPanel=UI.create("UI.HTMLPanel",{html:t});this.codePanel.addSouth(this.buttonPanel,30);var t='<div class="panelFill" style="background-color:#333333;">';t+='  <div style="position: absolute; top: 0; bottom: 0; left: 0; right: 0" id="importShaderCodeEditor"></div>';t+="</div>";this.codeEditorPanel=UI.create("UI.HTMLPanel",{html:t});this.codePanel.add(this.codeEditorPanel);this.codeEditorPanel.on("resize",function(){console.log("resize html panel!");if(e.codeEditor&&e.codeEditor.resize){e.codeEditor.resize()}});this.closeButton=UI.create("UI.Button",{text:"Close"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("resize",function(){e.resize()});this.initContent()}UI.showDialog("importShaderEditor")},resize:function(){if(this.codeEditor&&this.codeEditor.resize){this.codeEditor.resize()}},initContent:function(){var i=this;this.codeEditor=ace.edit("importShaderCodeEditor");this.codeEditor.getSession().setTabSize(2);this.codeEditor.getSession().setUseSoftTabs(true);this.codeEditor.on("focus",function(){UI.setAllowBrowserEditOperations(true)});this.codeEditor.on("blur",function(){UI.setAllowBrowserEditOperations(false)});var e="ace/mode/assembly_6502";if(this.mode=="javascript"){e="ace/mode/javascript"}this.codeEditor.getSession().setMode(e);this.codeEditor.setShowInvisibles(true);this.codeEditor.gotoLine(1);this.sourceCanvas=document.getElementById("importShaderEditorInputCanvas");this.sourceContext=this.sourceCanvas.getContext("2d");this.outputCanvas=document.getElementById("importShaderEditorOutputCanvas");this.outputContext=this.outputCanvas.getContext("2d");this.importWidth=this.outputCanvas.width;this.importHeight=this.outputCanvas.height;document.getElementById("importShaderEditorSourceFile").addEventListener("change",function(e){var t=document.getElementById("importShaderEditorSourceFile").files[0];i.setImportImage(t)});$("#importShaderEditorRun").on("click",function(){i.runImport()});$("#importShaderExportJSON").on("click",function(){i.exportJSON()});$("#importShaderEditorOutputCharacter").on("click",function(){i.drawResult()});$("#importShaderEditorOutputColor").on("click",function(){i.drawResult()});$("#importShaderEditorOutputBGColor").on("click",function(){i.drawResult()});$("#importShaderEditorOutputOriginalImage").on("click",function(){i.drawResult()});this.codeEditor.setValue(this.shader,-1)},scaleImageToFit:function(){if(this.importImage==null){return}var e=this.importImage.naturalWidth;var t=this.importImage.naturalHeight;this.scale=1;if(e>this.importWidth){this.scale=this.importWidth/this.importImage.naturalWidth}if(t>this.importHeight){this.scale=this.importHeight/this.importImage.naturalHeight}if(e<this.importWidth&&this.scale==1){this.scale=this.importWidth/this.importImage.naturalWidth}if(t<this.importHeight&&this.scale==1){this.scale=this.importHeight/this.importImage.naturalHeight}},runImport:function(){console.log("run import");var e=getTimestamp();var t=[];var i=[];var r=[];var a=this.editor.colorPaletteManager.getCurrentColorPalette();var s=a.getColorCount();for(var o=0;o<s;o++){t.push(o);i.push(o)}for(var o=0;o<256;o++){r.push(o)}var l=this.codeEditor.getValue();this.shaderImport.setShaderCode(l);this.shaderImport.setColors(t);this.shaderImport.setBGColors(i);this.shaderImport.setCharacters(r);this.shaderImport.setUseMultipleBGColors(true);this.shaderImport.setSrcCanvas(this.sourceCanvas);this.shaderImport.convert();this.drawResult();var n=getTimestamp();var h=n-e;console.log("time taken = "+h)},exportJSON:function(){var e=this.codeEditor.getValue();var t=JSON.stringify(e)+";";console.log(t)},drawResult:function(){var e=$("#importShaderEditorOutputCharacter").is(":checked");var t=$("#importShaderEditorOutputColor").is(":checked");var i=$("#importShaderEditorOutputBGColor").is(":checked");var r=$("#importShaderEditorOutputOriginalImage").is(":checked");if(r){console.log("draw original image!");var a=this.importImage.naturalWidth*this.scale;var s=this.importImage.naturalHeight*this.scale;console.log("width = "+a+", height = "+s+", scale = "+this.scale);this.outputContext.drawImage(this.importImage,0,0,a,s)}var o=this.editor.tileSetManager.getCurrentTileSet();var l=this.shaderImport.getResult();var n=o.charHeight;var h=o.charWidth;this.outputScale=1;var d=this.outputContext.getImageData(0,0,this.outputCanvas.width,this.outputCanvas.height);this.useMultipleBGColors=true;this.charactersHasSpace=true;for(var c=0;c<l.length;c++){for(var f=0;f<l[0].length;f++){var u=l[c][f].character;var p=l[c][f].color;var v=l[c][f].bgColor;if(this.useMultipleBGColors){if(p==v){if(this.charactersHasSpace){u=this.editor.tileSetManager.blankCharacter}}}else{if(p===frameBgColor){if(this.charactersHasSpace){u=this.editor.tileSetManager.blankCharacter}}}var g={};g["scale"]=this.outputScale;g["imageData"]=d;if(e){g["character"]=u}else{g["character"]=-1}if(t){g["color"]=p;if(i){if(v!==false){g["bgColor"]=v}}else{g["bgColorRGB"]=3355443}}else{if(i&&!e){if(v!==false){g["color"]=v}else{g["character"]=this.editor.tileSetManager.blankCharacter}}else if(i&&e){g["colorRGB"]=16777215;if(v!==false){g["bgColor"]=v}}else{g["colorRGB"]=16777215;g["bgColorRGB"]=3355443}}g["x"]=f*(h*this.outputScale);g["y"]=c*(n*this.outputScale);o.drawCharacter(g)}}this.outputContext.putImageData(d,0,0)},setImportImage:function(e){if(!this.importImage){this.importImage=new Image}var t=window.URL||window.webkitURL;var i=t.createObjectURL(e);this.importImage.src=i;var r=this;this.importImage.onload=function(){r.updateImportImage()}},updateImportImage:function(){if(this.importImage==null){return}this.scaleImageToFit();var e=this.importImage.naturalWidth*this.scale;var t=this.importImage.naturalHeight*this.scale;this.sourceContext.drawImage(this.importImage,0,0,e,t)}};var ExportFrameImage=function(){this.editor=null;this.layersCanvas=null;this.layersContext=null;this.screenCanvas=null;this.screenContext=null;this.borderWidth=4*8;this.borderHeight=4*8+4;this.scale=1};ExportFrameImage.prototype={init:function(e){this.editor=e},initCanvas:function(){var e=this.editor.graphic.getGraphicWidth();var t=this.editor.graphic.getGraphicHeight();var i=(e+this.borderWidth*2)*this.scale;var r=(t+this.borderHeight*2)*this.scale;if(!this.layersCanvas){this.layersCanvas=document.createElement("canvas");this.layersContext=this.layersCanvas.getContext("2d")}if(this.layersCanvas.width!=i||this.layersCanvas.height!=r){this.layersCanvas.width=i;this.layersCanvas.height=r;this.layersContext=this.layersCanvas.getContext("2d")}},exportFrame:function(e){this.scale=e.scale;this.includeBorder=e.includeBorder;var t=e.layers;if(t=="current"){t=this.editor.layers.getSelectedLayerId()}var i=0;if(typeof e.frame!="undefined"){i=e.frame}var r=false;if(typeof e.addTransparentPixel!="undefined"){r=e.addTransparentPixel}if(this.includeBorder){this.borderWidth=4*8;this.borderHeight=4*8+4;if(typeof e.borderWidth!="undefined"){this.borderWidth=e.borderWidth}if(typeof e.borderHeight!="undefined"){this.borderHeight=e.borderHeight}}else{this.borderWidth=0;this.borderHeight=0}var a=this.editor.colorPaletteManager.getCurrentColorPalette();var s=this.editor.graphic.getGraphicWidth();var o=this.editor.graphic.getGraphicHeight();var l=(s+this.borderWidth*2)*this.scale;var n=(o+this.borderHeight*2)*this.scale;this.initCanvas();if(this.borderWidth!=0||this.borderHeight!=0){var h=false;for(var d=0;d<this.editor.layers.layers.length;d++){var c=this.editor.layers.layers[d];if(c.type=="grid"&&(c.visible&&t=="visible"||t=="all"||t==c.layerId)){var f=null;f=this.editor.layers.getLayerObject(c.layerId);if(f&&typeof f.getBorderColor!="undefined"){h=f.getBorderColor()}}}var u=a.getHexString(h);this.layersContext.fillStyle="#"+u;this.layersContext.fillRect(0,0,this.borderWidth*this.scale,n);this.layersContext.fillRect(l-this.borderWidth*this.scale,0,this.borderWidth*this.scale,n);this.layersContext.fillRect(0,0,l,this.borderHeight*this.scale);this.layersContext.fillRect(0,n-this.borderHeight*this.scale,l,this.borderHeight*this.scale)}this.layersContext.clearRect(this.borderWidth*this.scale,this.borderHeight*this.scale,l-this.borderWidth*this.scale*2,n-this.borderHeight*this.scale*2);if(this.screenCanvas==null){this.screenCanvas=document.createElement("canvas")}if(this.screenContext==null||this.screenCanvas.width!=s||this.screenCanvas.height!=o){this.screenCanvas.width=s;this.screenCanvas.height=o;this.screenContext=UI.getContextNoSmoothing(this.screenCanvas)}this.layersContext.imageSmoothingEnabled=false;this.layersContext.webkitImageSmoothingEnabled=false;this.layersContext.mozImageSmoothingEnabled=false;this.layersContext.msImageSmoothingEnabled=false;this.layersContext.oImageSmoothingEnabled=false;this.editor.graphic.invalidateAllCells();if(g_newSystem){this.editor.graphic.drawFrame({allCells:true,graphicOnly:true,canvas:this.layersCanvas,context:this.layersContext,frame:i,layers:t,scale:this.scale,dstX:this.borderWidth*this.scale,dstY:this.borderHeight*this.scale})}else{this.editor.grid.grid2d.drawFrame({canvas:this.screenCanvas,context:this.screenContext,frame:i,layers:t});this.layersContext.drawImage(this.screenCanvas,this.borderWidth*this.scale,this.borderHeight*this.scale,this.screenCanvas.width*this.scale,this.screenCanvas.height*this.scale)}if(this.addTransparentPixel){var p=this.layersContext.getImageData(0,0,l,n);p.data[3]=100;this.layersContext.putImageData(p,0,0)}},getCanvas:function(){return this.layersCanvas}};var ExportImage=function(){this.editor=null;this.maxExportWidth=8192;this.maxExportHeight=8192;this.previewCanvas=null;this.previewContext=null;this.previewContextSmoothing=false;this.previewCanvasScale=null;this.canvas=null;this.context=null;this.exportFormat="gif";this.borderWidth=4*8;this.borderHeight=4*8+4;this.userBorderWidth=32;this.userBorderHeight=36;this.scale=1;this.addTransparentPixel=false;this.playMode="loop";this.imageEffectsControl=null;this.previewOffsetX=0;this.previewOffsetY=0;this.previewScale=1;this.mouseIsDown=false;this.touchCount=0;this.exportLayer="all";this.showPrevFrameSave=false;this.fromFrame=1;this.toFrame=0;this.playDirection=1;this.lastFrameTime=0;this.lastTickTime=0;this.playFrames=true;this.currentFrame=0;this.tick=0;this.frameTick=0;this.framesTickCount=0;this.startFrame=0;this.endFrame=0;this.exportProgressDialog=null;this.msPerTick=50;this.visible=false;this.active=false;this.exportInProgress=false;this.shaderEffects=null;this.lastGraphicWidth=false;this.lastGraphicHeight=false;this.clipboardCanvas=null};ExportImage.prototype={init:function(e){this.editor=e;this.shaderEffects=new ShaderEffects;this.shaderEffects.init();var i=this;this.shaderEffects.on("paramchanged",function(e,t){i.drawFrame()});this.effects=[null,new MattiasCRTEffect,new LotteCRTEffect,new NoisyGlowEffect]},createProgressDialog:function(){var e="<div>";e+="<h2>Export Progress</h2>";e+='<div id="exportImageProgressText"></div>';e+="</div>";this.exportProgressDialog=UI.create("UI.Dialog",{id:"exportImageProgressDialog",title:"Export Progress",width:280,height:140});this.exportProgressHTML=UI.create("UI.HTMLPanel",{html:e});this.exportProgressDialog.add(this.exportProgressHTML)},htmlComponentLoaded:function(e){this.componentsLoaded++;if(this.componentsLoaded==4){this.splitPanel.setPanelVisible("east",true);this.splitPanel.resize();this.initContent();this.setExportScales({chooseScale:true});this.setEffectsHTML();this.setEffect(0);this.initEvents();if(typeof e!="undefined"){e()}}},createUI:function(e){var t=this;if(this.uiComponent==null){var i=1340;var r=920;this.uiComponent=UI.create("UI.Dialog",{id:"exportImageDialog",title:"Export Image",width:i,height:r});this.uiComponent.on("resize",function(){t.resizePreview()});this.componentsLoaded=0;this.splitPanel=UI.create("UI.SplitPanel",{id:"exportImageSplitPanel"});this.uiComponent.add(this.splitPanel);this.eastPanel=UI.create("UI.SplitPanel");this.splitPanel.addEast(this.eastPanel,320);this.framesComponent=UI.create("UI.HTMLPanel");this.eastPanel.addNorth(this.framesComponent,120);this.framesComponent.load("html/textMode/exportImageFrames.html",function(){t.htmlComponentLoaded(e)});this.effectsHtmlComponent=UI.create("UI.HTMLPanel");this.eastPanel.add(this.effectsHtmlComponent);this.effectsHtmlComponent.load("html/textMode/exportImageEffects.html",function(){t.htmlComponentLoaded(e)});this.propertiesSplit=UI.create("UI.SplitPanel");this.splitPanel.add(this.propertiesSplit);this.htmlComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.addSouth(this.htmlComponent,250);this.htmlComponent.load("html/textMode/exportImage.html",function(){t.htmlComponentLoaded(e)});this.previewComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.add(this.previewComponent);this.previewComponent.load("html/textMode/exportImagePreview.html",function(){t.htmlComponentLoaded(e)});this.previewComponent.on("resize",function(){t.resizePreview()});this.okButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-199-save.svg"> Download',color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportImage()});this.copyButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.copyButton);this.copyButton.on("click",function(e){t.copyToClipboard({})});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){t.visible=false;t.active=false;t.editor.frames.setShowPrevFrame(t.showPrevFrameSave)});this.htmlComponent.on("mousemove",function(e){t.mouseMove(e);e.preventDefault()});this.htmlComponent.on("mouseup",function(e){t.mouseUp(e);e.preventDefault()});this.uiComponent.on("mousedown",function(e){t.mouseDown(e)});this.uiComponent.on("mouseup",function(e){t.mouseUp(e)});this.uiComponent.on("mousemove",function(e){t.mouseMove(e)});this.createProgressDialog()}else{this.initContent();this.setExportScales({chooseScale:false});if(typeof e!="undefined"){e()}}},setExportScales:function(e){var t=false;if(typeof e!="undefined"||typeof e.chooseScale!="undefined"){t=e.chooseScale}var i=this.editor.graphic;var r=i.getGraphicWidth();var a=i.getGraphicHeight();var s=10;var o=3;var l=Math.floor(1e3/r);var n=Math.floor(1e3/a);if(n<l){l=n}o=l;var h=Math.floor(this.maxExportWidth/r);var d=Math.floor(this.maxExportHeight/a);if(h>d){h=d}if(s>h){s=h}if(h>12){s=12}if(s<1){s=1}if(o>s){o=s}if(o==0){o=1}var c="";for(var f=1;f<=s;f++){var u=f*100;u+="%";c+='<option value="'+f+'">'+u+"</option>"}$("#exportImageScale").html(c);$("#exportImageScale").val(o);console.log("set scale to "+o);this.setScale(o);this.calculateImageDimensions();this.drawFrame()},show:function(){this.lastTickTime=getTimestamp();if(g_app.isMobile()){this.showMobile();return}var e=this;this.mouseIsDown=false;this.showPrevFrameSave=this.editor.frames.getShowPrevFrame();this.editor.frames.setShowPrevFrame(false);this.createUI();UI.showDialog("exportImageDialog");this.visible=true;this.active=true;this.resizePreview();if(typeof ClipboardItem!=="undefined"){this.copyButton.setVisible(true)}else{this.copyButton.setVisible(false)}},showMobile:function(){var t=this;this.mouseIsDown=false;var e=500;var i=100;var r=UI.getScreenWidth();var a=UI.getScreenHeight();e=r-30;i=a-30;if(this.uiComponent==null){this.uiComponent=UI.create("UI.MobilePanel",{id:"exportImageMobileDialog",title:"Export Image",width:e,height:i});this.uiComponent.on("resize",function(){t.resizePreview()});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportImageMobile.html",function(){t.initContent();t.setExportScales({chooseScale:true});t.setEffectsHTML();t.setEffect(0);t.initEvents();UI.showDialog("exportImageMobileDialog");t.resizePreview();t.createProgressDialog()});this.htmlComponent.on("resize",function(){t.resizePreview()});this.okButton=UI.create("UI.Button",{text:"Export"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportImage()});this.uiComponent.on("close",function(){t.visible=false;t.active=false;t.editor.frames.setShowPrevFrame(t.showPrevFrameSave)})}else{UI.showDialog("exportImageMobileDialog");this.initContent();this.setExportScales({chooseScale:true})}this.visible=true;this.active=true},resizePreview:function(){if(!this.visible){return}if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportImagePreview");$("#exportImagePreview").on("mouseenter",function(){UI.setCursor("can-drag")});$("#exportImagePreview").on("mouseleave",function(){})}var e=$("#exportImagePreviewHolder");if(!e||e.length==0){return}var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}this.previewCanvasScale=UI.devicePixelRatio;if(this.width!=this.previewCanvas.style.width||this.height!=this.previewCanvas.style.height){if(this.width!=0&&this.height!=0){this.previewCanvas.style.width=this.width+"px";this.previewCanvas.style.height=this.height+"px";this.previewCanvas.width=this.width*this.previewCanvasScale;this.previewCanvas.height=this.height*this.previewCanvasScale}}this.previewContext=null;this.drawPreview({redrawLayers:false,applyEffects:false})},setEffectsHTML:function(){var e="";for(var t=0;t<this.effects.length;t++){var i=this.effects[t];if(!i){e+='<option value="'+t+'">No Effect</option>'}else{e+='<option value="'+t+'">'+i.getName()+"</option>"}}var r=this;$("#exportImageEffectOptions").html(e);$("#exportImageEffectOptions").on("change",function(){var e=$(this).val();r.setEffect(e)})},initContent:function(){var e=this;$("#exportImageAs").val(g_app.fileManager.filename);if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportImagePreview");this.previewContext=null}if(this.imageEffectsControl==null){this.imageEffectsControl=new ImageEffectsControl;this.imageEffectsControl.init({htmlElementId:"exportImageEffects"});this.imageEffectsControl.on("update",function(){e.drawPreview({redrawLayers:false})});this.imageEffectsControl.on("updateParam",function(){e.drawPreview({redrawLayers:false})})}if($("input[name=exportImageLayer]:checked").length>0){this.exportLayer=$("input[name=exportImageLayer]:checked").val()}var t=this.editor.graphic.getFrameCount();$("#exportImageToFrame").val(t);$("#exportImageFromFrame").val(1);$("#exportImageFromFrame").attr("max",t);$("#exportImageToFrame").attr("max",t);$("#exportImageFrame").val(this.editor.graphic.getCurrentFrame()+1);$("#exportImageFrame").attr("max",t);this.playMode=$("#exportImageLoopType").val();this.addTransparentPixel=$("#exportImageTransparentPixel").is(":checked");var i=this.editor.tileSetManager.getCurrentTileSet();var r=this.editor.colorPaletteManager.getCurrentColorPalette();var a=this.editor.graphic.getGraphicWidth();var s=this.editor.graphic.getGraphicHeight();this.previewScale=1;this.previewOffsetX=-a/2;this.previewOffsetY=-s/2;if(t==1&&!i.hasAnimatedTiles()){e.setExportFormat("png")}else{e.setExportFormat("gif")}this.shaderEffects.setControlsParentId("exportImageEffectControls");this.drawPreview();this.resizePreview();this.setFrameParameters();this.calculateImageDimensions();this.calculateImageDuration()},initEvents:function(){var s=this;$("#exportImageIncludeBorder").on("click",function(){console.log("borsder check!");s.drawPreview();s.calculateImageDimensions()});if($("input[type='radio'][name='exportImageScale']").length>0){$("input[type='radio'][name='exportImageScale']").on("click",function(){var e=$("input[type='radio'][name='exportImageScale']:checked").val();s.setScale(e);s.calculateImageDimensions();s.drawPreview()})}if($("#exportImageScale").length>0){$("#exportImageScale").on("change",function(){var e=$(this).val();s.setScale(e);s.calculateImageDimensions();s.drawPreview()})}if($("#exportImageScale-inc").length>0){$("#exportImageScale-inc").on("click",function(){var e=$("#exportImageScale").val();var t=$("#exportImageScale").get(0);var i=t.options;var r=false;for(var a=0;a<i.length;a++){if(i[a].value==e&&a<i.length-1){r=i[a+1].value}}if(r!==false){$("#exportImageScale").val(r);s.setScale(r);s.calculateImageDimensions();s.drawPreview()}})}if($("#exportImageScale-dec").length>0){$("#exportImageScale-dec").on("click",function(){var e=$("#exportImageScale").val();var t=$("#exportImageScale").get(0);var i=t.options;var r=false;for(var a=0;a<i.length;a++){if(i[a].value==e){break}r=i[a].value}if(r!==false){$("#exportImageScale").val(r);s.setScale(r);s.calculateImageDimensions();s.drawPreview()}})}$("input[name=exportImageLayer]").on("click",function(){s.exportLayer=$("input[name=exportImageLayer]:checked").val();s.drawPreview()});$("#exportImageTransparentPixel").on("click",function(){s.addTransparentPixel=$("#exportImageTransparentPixel").is(":checked");s.drawPreview()});$("#exportImagePreview").on("mousedown",function(e){s.previewMouseDown(e)});$("#exportImagePreview").on("wheel",function(e){s.previewMouseWheel(e.originalEvent)});this.previewCanvas.addEventListener("touchstart",function(e){s.touchStart(e)},false);this.previewCanvas.addEventListener("touchmove",function(e){s.touchMove(e);return false},false);this.previewCanvas.addEventListener("touchend",function(e){s.touchEnd(e)},false);$("#imageExportPreviewScale").on("input",function(e){var t=$(this).val();s.setPreviewScale(t/100)});$("#imageExportPreviewScaleText").on("keyup",function(e){var t=parseInt($(this).val());if(isNaN(t)){return}s.setPreviewScale(t/100)});$("#imageExportPreviewScaleReset").on("click",function(){s.setPreviewScale(1)});$("#exportImageLoopType").on("change",function(e){s.setFrameParameters()});$("#exportImageFromFrame").on("change",function(e){s.setFrameParameters()});$("#exportImageFromFrame").on("keyup",function(e){s.setFrameParameters()});$("#exportImageToFrame").on("change",function(e){s.setFrameParameters()});$("#exportImageToFrame").on("keyup",function(e){s.setFrameParameters()});$("#exportImageSpeed").on("change",function(e){if($(this).val()=="custom"){$("#exportImageCustomSpeed").show()}else{$("#exportImageCustomSpeed").hide()}s.setFrameParameters()});$("input[name=exportImageFormat]").on("click",function(){var e=$("input[name=exportImageFormat]:checked").val();s.setExportFormat(e)});$("#exportImageFrame").on("change",function(){s.setFrameParameters()});$("#exportImageEffectPrev").on("click",function(){s.gotoEffect(-1)});$("#exportImageEffectNext").on("click",function(){s.gotoEffect(1)});$("#exportImageBorderReset").on("click",function(){$("#exportImageBorderWidth").val(32);$("#exportImageBorderHeight").val(36);s.setBorderSize()});$("#exportImageBorderWidth,#exportImageBorderHeight").on("keyup",function(){s.setBorderSize()});$("#exportImageBorderWidth,#exportImageBorderHeight").on("change",function(){s.setBorderSize()})},setBorderSize:function(){var e=parseInt($("#exportImageBorderWidth").val(),10);var t=parseInt($("#exportImageBorderHeight").val(),10);if(!isNaN(e)&&!isNaN(t)){this.userBorderHeight=t;this.userBorderWidth=e}this.calculateImageDimensions();this.drawFrame()},setExportFormat:function(e){this.exportFormat=e;$("input[name=exportImageFormat][value="+e+"]").prop("checked",true);this.lastTickTime=getTimestamp();switch(e){case"gif":$(".exportImagePNGParameters").hide();$(".exportImageGIFParameters").show();break;case"png":$(".exportImagePNGParameters").show();$(".exportImageGIFParameters").hide();break}this.setFrameParameters()},gotoEffect:function(e){var t=parseInt($("#exportImageEffectOptions").val(),10);t+=e;if(t<0){t=this.effects.length-1}if(t>=this.effects.length){t=0}this.setEffect(t)},setEffect:function(e){$("#exportImageEffectOptions").val(e);if(!this.effects[e]){$("#exportImageEffectControls").html("");this.effect=null}else{this.effect=this.effects[e];this.shaderEffects.setEffect(this.effects[e])}this.drawFrame()},calculateImageDimensions:function(){var e=$("#exportImageIncludeBorder").is(":checked");if(e){$("#borderSizeHolder").show()}else{$("#borderSizeHolder").hide()}if(e){this.borderWidth=this.userBorderWidth;this.borderHeight=this.userBorderHeight}else{this.borderWidth=0;this.borderHeight=0}var t=this.editor.graphic.getGraphicWidth();var i=this.editor.graphic.getGraphicHeight();var r=(t+this.borderWidth*2)*this.scale;var a=(i+this.borderHeight*2)*this.scale;var s=r+"x"+a+" pixels";$("#exportImageDimensions").html(s)},calculateImageDuration:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=0;for(var i=this.fromFrame-1;i<this.toFrame;i++){t+=this.editor.graphic.getFrameDuration(i)}if(this.playMode=="pingpong"){t*=2}var r=e.getAnimatedCharacterTicks();for(var i=0;i<r.length;i++){if(t<r[i]){t=r[i]}}this.totalTicks=t;var a=t*this.msPerTick/1e3;a=a.toFixed(2);var s="Length "+a+" seconds";$("#exportImageDuration").html(s)},setFrameParameters:function(){var e=this.editor.graphic.getFrameCount();if(this.exportFormat=="png"){var t=parseInt($("#exportImageFrame").val(),10);if(!isNaN(t)){t=t-1;if(t>=0&&t<e){this.currentFrame=t;this.drawPreview()}}}if(this.exportFormat=="gif"){this.playMode=$("#exportImageLoopType").val();var i=parseInt($("#exportImageFromFrame").val(),10);if(!isNaN(i)&&i>=1&&i<=e){this.fromFrame=i}var r=parseInt($("#exportImageToFrame").val(),10);if(!isNaN(r)&&r>=1&&r<=e){this.toFrame=r}this.speed=$("#exportImageSpeed").val();this.msPerTick=50;if(this.speed=="custom"){this.msPerTick=parseInt($("#exportImageMSPerTick").val(),10)}else{this.msPerTick=FRAMERATE/parseInt(this.speed,10)}}},setPreviewScale:function(e){this.previewScale=e;this.drawPreview({redrawLayers:false,applyEffects:false});var t=Math.floor(e*100);$("#imageExportPreviewScale").val(t);$("#imageExportPreviewScaleText").val(t)},previewMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);var i=this.previewScale-t.spinY/8;if(i>=.1){this.setPreviewScale(i)}},previewMouseDown:function(e){var t=e.offsetX;var i=e.offsetY;this.mouseDownAtX=e.clientX;this.mouseDownAtY=e.clientY;this.currentOffsetX=this.previewOffsetX;this.currentOffsetY=this.previewOffsetY;this.mouseIsDown=true;UI.setCursor("drag");UI.captureMouse(this)},mouseDown:function(e){},mouseMove:function(e){if(this.mouseIsDown){var t=e.clientX;var i=e.clientY;var r=t-this.mouseDownAtX;var a=i-this.mouseDownAtY;this.previewOffsetX=this.currentOffsetX+r/this.previewScale;this.previewOffsetY=this.currentOffsetY+a/this.previewScale;this.drawPreview({redrawLayers:false,applyEffects:false})}},mouseUp:function(e){this.mouseIsDown=false},touchStart:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1){this.touchCount=1;var s=t[0].pageX-$(this.previewCanvas).offset().left;var o=t[0].pageY-$(this.previewCanvas).offset().top;this.mouseDownAtX=s;this.mouseDownAtY=o;this.currentOffsetX=this.previewOffsetX;this.currentOffsetY=this.previewOffsetY;this.mouseIsDown=true}if(t.length==2){this.touchCount=2;this.touchStart0X=t[0].pageX-r;this.touchStart0Y=t[0].pageY-a;this.touchStart1X=t[1].pageX-r;this.touchStart1Y=t[1].pageY-a;this.touchStartDistance=(this.touchStart0X-this.touchStart1X)*(this.touchStart0X-this.touchStart1X)+(this.touchStart0Y-this.touchStart1Y)*(this.touchStart0Y-this.touchStart1Y);this.touchStartDistance=Math.sqrt(this.touchStartDistance);this.touchStartMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchStartMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.touchMoveMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchMoveMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.pinchStartScale=this.previewScale}},touchMove:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1&&this.touchCount==1){var s=t[0].pageX-$(this.previewCanvas).offset().left;var o=t[0].pageY-$(this.previewCanvas).offset().top;var l=s-this.mouseDownAtX;var n=o-this.mouseDownAtY;this.previewOffsetX=this.currentOffsetX+l/this.previewScale;this.previewOffsetY=this.currentOffsetY+n/this.previewScale;this.drawPreview({redrawLayers:false,applyEffects:false})}if(t.length==2){this.touchMove0X=t[0].pageX-r;this.touchMove0Y=t[0].pageY-a;this.touchMove1X=t[1].pageX-r;this.touchMove1Y=t[1].pageY-a;this.touchMoveDistance=(this.touchMove0X-this.touchMove1X)*(this.touchMove0X-this.touchMove1X)+(this.touchMove0Y-this.touchMove1Y)*(this.touchMove0Y-this.touchMove1Y);this.touchMoveDistance=Math.sqrt(this.touchMoveDistance);var h=this.touchMoveMidX;var d=this.touchMoveMidY;var c=(this.touchMove0X+this.touchMove1X)/2;var f=(this.touchMove0Y+this.touchMove1Y)/2;this.touchMoveMidX=c;this.touchMoveMidY=f;var u=this.previewScale;var p=this.touchMoveDistance/this.touchStartDistance*this.pinchStartScale;this.setPreviewScale(p);var v=(c-h)/p;var g=(f-d)/p;this.previewOffsetX+=v;this.previewOffsetY+=g}},touchEnd:function(e){},drawPreview:function(e){var t=true;if(typeof e!="undefined"&&typeof e.redrawLayers!="undefined"){t=e.redrawLayers}if(t){this.drawFrame()}if(this.canvas==null||this.previewCanvas==null){return}if(this.previewContext==null||this.previewScale<1&&!this.previewContextSmoothing){this.previewContext=this.previewCanvas.getContext("2d");this.previewContextSmoothing=true}if(this.previewCOntext==null||this.previewScale>=1&&this.previewContextSmoothing){this.previewContext=UI.getContextNoSmoothing(this.previewCanvas);this.previewContextSmoothing=false}var i=this.previewCanvas.width;var r=this.previewCanvas.height;var a=this.editor.checkerboardPattern.getCanvas(i,r);this.previewContext.drawImage(a,0,0,i,r,0,0,i,r);this.previewContext.save();this.previewContext.translate(Math.floor(i/2),Math.floor(r/2));this.previewContext.scale(this.previewScale*this.previewCanvasScale,this.previewScale*this.previewCanvasScale);this.previewContext.drawImage(this.canvas,this.previewOffsetX,this.previewOffsetY);this.previewContext.restore()},applyEffects:function(){var e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);this.imageEffectsControl.applyEffects(e);this.context.putImageData(e,0,0)},readParameters:function(){this.includeBorder=$("#exportImageIncludeBorder").is(":checked");var e=$("input[type='radio'][name='exportImageLayer']:checked").val()},getScale:function(){return this.scale},setScale:function(e){var t=this.scale;this.scale=e;this.previewOffsetY=Math.floor(this.previewOffsetY*this.scale/t);this.previewOffsetX=Math.floor(this.previewOffsetX*this.scale/t)},initCanvas:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.editor.graphic.getGraphicWidth();var i=this.editor.graphic.getGraphicHeight();var r=(t+this.borderWidth*2)*this.scale;var a=(i+this.borderHeight*2)*this.scale;if(!this.canvas){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.shaderEffects.setInput(this.canvas);this.shaderEffects.setOutput(this.canvas)}if(this.canvas.width!=r||this.canvas.height!=a){this.canvas.width=r;this.canvas.height=a;this.context=this.canvas.getContext("2d");this.shaderEffects.setSize(r,a)}},drawFrame:function(e){this.readParameters();var t=this.currentFrame;var i=this.includeBorder;var r=false;var a=this.effect;var s=this.scale;if(typeof e!="undefined"){if(typeof e.frame!="undefined"){t=e.frame}if(typeof e.includeBorder!="undefined"){i=e.includeBorder}if(typeof e.section!="undefined"){r=e.section;if(r){i=false}}if(typeof e.scale!="undefined"){s=e.scale}if(typeof e.effects!="undefined"){a=e.effects}}if(i){this.borderWidth=this.userBorderWidth;this.borderHeight=this.userBorderHeight}else{this.borderWidth=0;this.borderHeight=0}this.initCanvas();this.editor.exportFrameImage.exportFrame({scale:s,includeBorder:i,borderWidth:this.borderWidth,borderHeight:this.borderHeight,addTransparentPixel:this.addTransparentPixel,layers:this.exportLayer,frame:t,section:r});if(a){this.shaderEffects.setInput(this.editor.exportFrameImage.getCanvas());this.shaderEffects.setOutput(this.canvas);this.shaderEffects.applyEffects()}else{this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.drawImage(this.editor.exportFrameImage.getCanvas(),0,0)}},copyToClipboard:function(e){if(typeof navigator=="undefined"||typeof navigator.clipboard=="undefined"||typeof navigator.clipboard.write=="undefined"){return}try{var t=false;var i=0;var r=0;var a=0;var s=0;if(typeof e!="undefined"){if(typeof e.section!="undefined"){t=e.section;if(t){includeBorder=false;if(typeof e.fromX!="undefined"){i=e.fromX}if(typeof e.fromY!="undefined"){r=e.fromY}if(typeof e.width!="undefined"){a=e.width}if(typeof e.height!="undefined"){s=e.height}}}}if(t){if(!this.clipboardCanvas){this.clipboardCanvas=document.createElement("canvas")}this.clipboardCanvas.width=a;this.clipboardCanvas.height=s;this.clipboardContext=this.clipboardCanvas.getContext("2d");this.clipboardContext.drawImage(this.canvas,i,r,a,s,0,0,a,s);this.clipboardCanvas.toBlob(function(e){var t=new ClipboardItem({"image/png":e});navigator.clipboard.write([t])})}else{this.canvas.toBlob(function(e){var t=new ClipboardItem({"image/png":e});navigator.clipboard.write([t])})}}catch(e){}},exportImage:function(){switch(this.exportFormat){case"png":this.exportPng();UI.closeDialog();break;case"gif":this.exportGif();break}},exportPng:function(){var e=$("#exportImageAs").val();this.drawPreview();if(e.indexOf(".png")==-1){e+=".png"}var t=this.canvas.toDataURL("image/png");download(t,e,"image/png")},exportGif:function(){var t=$("#exportImageAs").val();if(t.indexOf(".gif")==-1){t+=".gif"}var e=false;var i=this.fromFrame;var r=this.toFrame;UI.showDialog("exportImageProgressDialog");this.exportInProgress=true;var a=new GIF({workers:4,workerScript:"lib/gif/gif.worker.js",quality:10,width:this.canvas.width,height:this.canvas.height,background:"#000000",repeat:0});var s=30;var o=[];var l=this.editor.tileSetManager.getCurrentTileSet();var n=l.getAnimatedCharacterTicks();var h=0;for(var d=i-1;d<r;d++){h+=this.editor.graphic.getFrameDuration(d)}if(this.playMode=="pingpong"&&r!=i){h*=2}o.push(h);for(var d=0;d<n.length;d++){o.push(n[d]);if(h<n[d]){h=n[d]}}function c(e,t){return!t?e:c(t,e%t)}function f(e,t){return e*t/c(e,t)}var u=o[0];o.forEach(function(e){u=f(u,e)});h=u;var p=0;var v=i-1;var g=0;var m=0;var s=9;var y=1e3/this.msPerTick;var b=1;l.update(p);this.currentFrame=v;this.drawFrame();var C=1;for(var p=1;p<h;p++){g++;this.shaderTime=p/h;var x=l.update(p);var S=this.editor.graphic.getFrameDuration(v)<=g;if(S){v+=C;g=0;if(v==r){if(this.playMode=="pingpong"&&r!=i){v--;C=-C}else{v=i-1}}}if(x||S){var P=(p-m)*this.msPerTick;if(e){a.addFrame(this.context,{copy:true,delay:P/2});a.addFrame(this.context,{copy:true,delay:P/2})}else{a.addFrame(this.context,{copy:true,delay:P})}m=p;this.currentFrame=v;this.drawFrame()}}var P=(p-m)*this.msPerTick;this.drawFrame();if(e){a.addFrame(this.context,{copy:true,delay:P/2})}else{a.addFrame(this.context,{copy:true,delay:P})}var w=this;a.on("finished",function(e){if(t.indexOf(".gif")==-1){t+=".gif"}download(e,t,"application/gif");w.exportGifFinished()});a.on("progress",function(e){var t=e*100;var i=t.toFixed(2)+"%";$("#exportImageProgressText").html(i)});a.render()},exportGifFinished:function(){this.exportInProgress=false;UI.closeDialog();UI.closeDialog()},updateFrame:function(){if(this.exportFormat=="png"){this.lastTickTime=getTimestamp();return false}var e=false;this.startFrame=this.fromFrame-1;this.endFrame=this.toFrame;if(this.startFrame<0){this.startFrame=0}if(this.endFrame>=this.editor.graphic.getFrameCount()){this.endFrame=this.editor.graphic.getFrameCount()}var t=getTimestamp();var i=this.editor.tileSetManager.getCurrentTileSet();while(t-this.lastTickTime>=this.msPerTick){this.tick++;this.frameTick++;this.lastTickTime=this.lastTickTime+this.msPerTick;if(i.update(this.tick)){e=true}if(TextMode.tick){e=true;TextMode.tick(this.tick)}}if(this.playFrames){if(this.currentFrame<0||this.currentFrame>=this.editor.graphic.getFrameCount()){this.currentFrame=0}var r=this.editor.graphic.getFrameDuration(this.currentFrame);if(this.frameTick>=r){this.frameTick=0;this.framesTickCount+=r;var a=this.currentFrame;a+=this.playDirection;if(this.playMode=="pingpong"){if(a===this.startFrame){this.playDirection=1}if(a===this.endFrame-1){this.playDirection=-1}if(a>=this.endFrame){a=this.startFrame}else if(a<this.startFrame){a=this.startFrame}}else if(this.playMode=="once"){if(a>=this.endFrame){a=this.startFrame}}else{if(a>=this.endFrame){a=this.startFrame}}if(this.currentFrame!==a){this.currentFrame=a;e=true}this.lastFrameTime=t}}return e},update:function(){if(!this.active){return false}if(this.updateFrame()){this.drawFrame()}this.drawPreview({redrawLayers:false});return true}};var ExportGif=function(){this.editor=null;this.canvas=null;this.context=null;this.borderWidth=4*8;this.borderHeight=4*8+4;this.scale=1;this.playMode="loop";this.imageEffectsControl=null;this.effectInputSet=false;this.previewCanvas=null;this.previewContext=null;this.previewCanvasScale=null;this.exportGifActive=false;this.playDirection=1;this.lastFrameTime=0;this.lastTickTime=0;this.playFrames=true;this.currentFrame=0;this.tick=0;this.startFrame=0;this.endFrame=0;this.shaderEffects=null;this.exportGIFFormat="gif";this.recordingVideo=false;this.exportLayer="all";this.previewOffsetX=0;this.previewOffsetY=0;this.previewScale=1;this.mouseIsDown=false;this.fromFrame=0;this.toFrame=0;this.shaderTime=0;this.msPerTick=50;this.totalTicks=0;this.framesTickCount=0;this.frameTick=0;this.exportProgressDialog=null;this.showPrevFrameSave=false;this.exportInProgress=false;this.visible=false;this.uiComponent=null};ExportGif.prototype={initExportProgress:function(){var e="<div>";e+="<h2>Export Progress</h2>";e+='<div id="exportGifProgressText"></div>';e+="</div>";this.exportProgressDialog=UI.create("UI.Dialog",{id:"exportGifProgressDialog",title:"Export Progress",width:280,height:140});this.exportProgressHTML=UI.create("UI.HTMLPanel",{html:e});this.exportProgressDialog.add(this.exportProgressHTML)},init:function(e){this.editor=e;this.shaderEffects=new ImageShaderEffects;this.shaderEffects.init()},resizePreview:function(){if(!this.visible){return}if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportGifPreview");$("#exportGifPreview").on("mouseenter",function(){UI.setCursor("can-drag")});$("#exportGifPreview").on("mouseleave",function(){})}if(this.previewCanvas==null){return}var e=$("#exportGifPreviewHolder");var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}this.previewCanvasScale=UI.devicePixelRatio;if(this.width!=this.previewCanvas.style.width||this.height!=this.previewCanvas.style.height){if(this.width!=0&&this.height!=0){this.previewCanvas.style.width=this.width+"px";this.previewCanvas.style.height=this.height+"px";this.previewCanvas.width=this.width*this.previewCanvasScale;this.previewCanvas.height=this.height*this.previewCanvasScale}}this.previewContext=this.previewCanvas.getContext("2d");this.previewContext.imageSmoothingEnabled=false;this.previewContext.webkitImageSmoothingEnabled=false;this.previewContext.mozImageSmoothingEnabled=false;this.previewContext.msImageSmoothingEnabled=false;this.previewContext.oImageSmoothingEnabled=false},drawFrame:function(e){var t=true;var i=true;if(typeof e!="undefined"){if(typeof e.redrawLayers){t=e.redrawLayers}if(typeof e.applyEffects!="undefined"){i=e.applyEffects}}if(!this.imageEffectsControl||this.imageEffectsControl.getEffectsCount()==0){i=false}var r=this.exportLayer;if(r=="current"){r=this.editor.layers.getSelectedLayerId()}if(this.currentFrame<0||this.currentFrame>=this.editor.graphic.getFrameCount()){this.currentFrame=0}this.initCanvas();if(this.previewCanvas==null){this.resizePreview()}if(this.previewCanvas==null){return}this.editor.exportFrameImage.exportFrame({scale:this.scale,includeBorder:this.borderWidth!=0,layers:this.exportLayer,frame:this.currentFrame});this.context.drawImage(this.editor.exportFrameImage.getCanvas(),0,0);if(i){this.shaderEffects.setTime(this.shaderTime);this.shaderEffects.applyEffects()}this.previewContext.fillStyle="#000000";this.previewContext.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height);this.previewContext.save();this.previewContext.translate(Math.floor(this.previewCanvas.width/2),Math.floor(this.previewCanvas.height/2));this.previewContext.scale(this.previewScale*this.previewCanvasScale,this.previewScale*this.previewCanvasScale);this.previewContext.drawImage(this.canvas,this.previewOffsetX,this.previewOffsetY);this.previewContext.restore();return},htmlComponentLoaded:function(){this.componentsLoaded++;if(this.componentsLoaded==4){this.splitPanel.setPanelVisible("east",true);this.splitPanel.resize();$("#exportGIFScale3")[0].checked=true;var e=parseInt($("input[type='radio'][name='exportGIFScale']:checked").val(),10);this.setScale(e);this.initContent();this.initEvents()}},start:function(){var t=this;this.lastTickTime=getTimestamp();this.showPrevFrameSave=this.editor.frames.getShowPrevFrame();this.editor.frames.setShowPrevFrame(false);if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportGifDialog",title:"Export GIF",width:734,height:626});this.splitPanel=UI.create("UI.SplitPanel",{id:"exportGifSplitPanel"});this.uiComponent.add(this.splitPanel);this.uiComponent.on("resize",function(){t.resizePreview()});this.componentsLoaded=0;this.effectsSplitPanel=UI.create("UI.SplitPanel");this.splitPanel.addEast(this.effectsSplitPanel,324);this.exportGIFFramesPanel=UI.create("UI.HTMLPanel");this.effectsSplitPanel.addNorth(this.exportGIFFramesPanel,140);this.exportGIFFramesPanel.load("html/textMode/exportGifFrames.html",function(){t.htmlComponentLoaded()});this.effectsHtmlComponent=UI.create("UI.HTMLPanel");this.effectsSplitPanel.add(this.effectsHtmlComponent);this.effectsHtmlComponent.load("html/textMode/exportGifEffects.html",function(){t.htmlComponentLoaded()});this.propertiesSplit=UI.create("UI.SplitPanel");this.splitPanel.add(this.propertiesSplit);this.htmlComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportGif.html",function(){t.htmlComponentLoaded()});this.previewComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.addNorth(this.previewComponent,330);this.previewComponent.load("html/textMode/exportGifPreview.html",function(){t.htmlComponentLoaded()});this.previewComponent.on("resize",function(){t.resizePreview()});this.okButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-199-save.svg"> Download',color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportGif()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){t.editor.frames.setShowPrevFrame(t.showPrevFrameSave);t.exportGifActive=false});this.initExportProgress()}else{this.initContent()}UI.showDialog("exportGifDialog");this.visible=true;this.exportGifActive=true;this.exportInProgress=false},saveToGDrive:function(){g_app.gdrive.handleAuthClick()},initContent:function(){var e=this;$("#exportGIFAs").val(g_app.fileManager.filename);var t=this.editor.graphic.getFrameCount();$("#exportGIFToFrame").val(t);$("#exportGIFFromFrame").val(1);$("#exportGIFFromFrame").attr("max",t);$("#exportGIFToFrame").attr("max",t);this.playMode=$("#exportGIFLoopType").val();var i=this.editor.tileSetManager.getCurrentTileSet();var r=this.editor.colorPaletteManager.getCurrentColorPalette();var a=this.editor.graphic.getGraphicWidth();var s=this.editor.graphic.getGraphicHeight();this.previewScale=1;this.previewOffsetX=-a/2;this.previewOffsetY=-s/2;if(this.imageEffectsControl==null){this.imageEffectsControl=new ImageEffectsControl;this.imageEffectsControl.init({htmlElementId:"exportGIFEffects",availableEffects:this.shaderEffects.availableEffects});this.imageEffectsControl.on("update",function(){e.effectListUpdated()});this.imageEffectsControl.on("updateParam",function(){e.effectParamUpdated()})}this.exportLayer=$("input[name=exportGIFLayer]:checked").val();this.resizePreview();this.setFrameParameters();this.calculateGifInfo()},initEvents:function(){var i=this;$("input[type='radio'][name='exportGIFScale']").on("click",function(){var e=parseInt($("input[type='radio'][name='exportGIFScale']:checked").val(),10);i.setScale(e);i.calculateGifInfo()});$("input[name=exportGIFLayer]").on("click",function(){i.exportLayer=$("input[name=exportGIFLayer]:checked").val();i.drawFrame()});$("#exportGIFIncludeBorder").on("click",function(){i.calculateGifInfo()});$("input[name=exportGIFFormat]").on("click",function(){i.exportGIFFormat=$("input[name=exportGIFFormat]:checked").val()});$("#exportGifPreview").on("mousedown",function(e){i.previewMouseDown(e)});$("#exportGifPreview").on("wheel",function(e){i.previewMouseWheel(e.originalEvent)});$("#exportGIFLoopType").on("change",function(e){i.setFrameParameters()});$("#exportGIFToFrame").on("change",function(e){i.setFrameParameters()});$("#exportGIFFromFrame").on("change",function(e){i.setFrameParameters()});$("#exportGIFRepeat").on("change",function(e){i.setFrameParameters()});$("#exportGIFSpeed").on("change",function(e){if($(this).val()=="custom"){$("#customSpeedSection").show()}else{$("#customSpeedSection").hide()}i.setFrameParameters()});$("#exportGIFMSPerTick").on("change",function(){i.setFrameParameters()});$("#gifExportPreviewScale").on("input",function(e){var t=$(this).val();i.setPreviewScale(t/100)});$("#gifExportPreviewScaleText").on("keyup",function(e){var t=parseInt($(this).val());if(isNaN(t)){return}i.setPreviewScale(t/100)});$("#gifExportPreviewScaleReset").on("click",function(){i.setPreviewScale(1)})},setFrameParameters:function(){this.playMode=$("#exportGIFLoopType").val();var e=this.editor.graphic.getFrameCount();var t=parseInt($("#exportGIFFromFrame").val(),10);if(!isNaN(t)&&t>=1&&t<=e){this.fromFrame=t}var i=parseInt($("#exportGIFToFrame").val(),10);if(!isNaN(i)&&i>=1&&i<=e){this.toFrame=i}this.repeat=1;this.speed=$("#exportGIFSpeed").val();this.msPerTick=50;if(this.speed=="custom"){this.msPerTick=parseInt($("#exportGIFMSPerTick").val(),10)}else{this.msPerTick=FRAMERATE/parseInt(this.speed,10)}this.calculateGifInfo()},mouseDown:function(e){},setPreviewScale:function(e){this.previewScale=e;this.drawFrame({redrawLayers:false,applyEffects:false});var t=Math.floor(e*100);$("#gifExportPreviewScale").val(t);$("#gifExportPreviewScaleText").val(t)},previewMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);var i=this.previewScale-t.spinY/8;if(i>=.1){this.setPreviewScale(i)}},previewMouseDown:function(e){var t=e.offsetX;var i=e.offsetY;this.mouseDownAtX=e.clientX;this.mouseDownAtY=e.clientY;this.currentOffsetX=this.previewOffsetX;this.currentOffsetY=this.previewOffsetY;UI.setCursor("drag");this.mouseIsDown=true;UI.captureMouse(this,{cursor:"url(cursors/closedhand.png) 2 14, pointer"})},mouseMove:function(e){if(this.mouseIsDown){var t=e.clientX;var i=e.clientY;var r=t-this.mouseDownAtX;var a=i-this.mouseDownAtY;this.previewOffsetX=this.currentOffsetX+r/this.previewScale;this.previewOffsetY=this.currentOffsetY+a/this.previewScale;this.drawFrame({redrawLayers:false,applyEffects:false})}},mouseUp:function(e){this.mouseIsDown=false},effectListUpdated:function(){if(this.shaderEffects&&this.imageEffectsControl){this.shaderEffects.setEffects(this.imageEffectsControl.getEffectsList());this.shaderEffects.setEffectParams(this.imageEffectsControl.getEffectsList())}},effectParamUpdated:function(){this.shaderEffects.setEffectParams(this.imageEffectsControl.getEffectsList())},exportGif:function(){var e=$("#exportGIFAs").val();var t=$("#exportGIFIncludeBorder").is(":checked");if(this.fromFrame>this.toFrame){alert("From must be greater than to");return}var i=this.scale;var r=$("input[type='radio'][name='exportGIFLayer']:checked").val();$("#exportGifProgressText").html("");UI.showDialog("exportGifProgressDialog");if(this.exportGIFFormat=="gif"){this.exportAs(e,t,i,this.speed,r,this.fromFrame,this.toFrame)}if(this.exportGIFFormat=="video"){this.exportVideo()}},setScale:function(e){var t=this.scale;this.scale=e;this.previewOffsetY=Math.floor(this.previewOffsetY*this.scale/t);this.previewOffsetX=Math.floor(this.previewOffsetX*this.scale/t)},calculateGifInfo:function(){this.drawFrame();var e=this.editor.tileSetManager.getCurrentTileSet();var t=$("#exportGIFIncludeBorder").is(":checked");if(t){this.borderWidth=4*8;this.borderHeight=4*8+4}else{this.borderWidth=0;this.borderHeight=0}var i=this.editor.graphic.getGraphicWidth();var r=this.editor.graphic.getGraphicHeight();var a=(i+this.borderWidth*2)*this.scale;var s=(r+this.borderHeight*2)*this.scale;var o=0;for(var l=this.fromFrame-1;l<this.toFrame;l++){o+=this.editor.graphic.getFrameDuration(l)}if(this.playMode=="pingpong"){o*=2}var n=e.getAnimatedCharacterTicks();for(var l=0;l<n.length;l++){if(o<n[l]){o=n[l]}}this.totalTicks=o;var h=o*this.msPerTick/1e3;h=h.toFixed(2);var d="Dimensions: "+a+"x"+s+" pixels, Length "+h+" seconds";$("#exportGIFInfo").html(d)},initCanvas:function(e){var t=this.editor.graphic.getGraphicWidth();var i=this.editor.graphic.getGraphicHeight();var r=(t+this.borderWidth*2)*this.scale;var a=(i+this.borderHeight*2)*this.scale;if(!this.canvas){this.canvas=document.createElement("canvas")}if(this.canvas.width!=r||this.canvas.height!=a){this.canvas.width=r;this.canvas.height=a;this.context=UI.getContextNoSmoothing(this.canvas);if(this.imageEffectsControl&&this.imageEffectsControl.getEffectsCount()>0){this.effectInputSet=true;this.shaderEffects.setInput(this.canvas,this.canvas);this.effectListUpdated()}}if(this.imageEffectsControl&&this.imageEffectsControl.getEffectsCount()>0&&!this.effectInputSet){this.effectInputSet=true;this.shaderEffects.setInput(this.canvas,this.canvas);this.effectListUpdated()}},exportVideo:function(){var t=this;var e=getTimestamp();this.currentFrame=this.startFrame;this.lastFrameTime=e;this.tick=0;this.frameTick=0;this.framesTickCount=0;this.lastTickTime=e;this.shaderTime=0;this.drawFrame();var i={mimeType:"video/webm; codecs=vp8"};this.recordedChunks=[];this.stream=this.canvas.captureStream();this.recorder=new MediaRecorder(this.stream,i);this.recorder.addEventListener("dataavailable",function(e){t.recordedChunks.push(e.data);if(t.recordingVideo==false){t.downloadVideoChunks()}});this.recorder.start();this.recordingVideo=true},exportVideoFinished:function(){this.recorder.stop();this.recordingVideo=false;UI.closeDialog();UI.closeDialog()},downloadVideoChunks:function(){var e=new Blob(this.recordedChunks,{type:"video/webm"});var t="video.webm";download(e,t,"video/webm")},exportAs:function(t,e,i,r,a,s,o){this.exportInProgress=true;this.playMode=$("#exportGIFLoopType").val();var l=50;if(r=="custom"){l=parseInt($("#exportGIFMSPerTick").val(),10)}else{l=FRAMERATE/r}if(typeof e=="undefined"){e=false}if(e){this.borderWidth=4*8;this.borderHeight=4*8+4}else{this.borderWidth=0;this.borderHeight=0}this.scale=i;this.initCanvas(e);var n=[];var h=this.editor.tileSetManager.getCurrentTileSet();var d=h.getAnimatedCharacterTicks();var c=$("#exportGIFShorten").is(":checked");var f=new GIF({workers:4,workerScript:"lib/gif/gif.worker.js",quality:10,width:this.canvas.width,height:this.canvas.height,background:"#000000",repeat:0});var u=30;var p=this.shaderEffects.hasTimeEffects();if(true){var v=0;for(var g=s-1;g<o;g++){v+=this.editor.graphic.getFrameDuration(g)}if(this.playMode=="pingpong"&&o!=s){v*=2}console.log("total ticks = "+v);n.push(v);for(var g=0;g<d.length;g++){n.push(d[g]);if(v<d[g]){v=d[g]}}function m(e,t){return!t?e:m(t,e%t)}function y(e,t){return e*t/m(e,t)}var b=n[0];n.forEach(function(e){b=y(b,e)});v=b;console.log("with anim chars ticks = "+v);var C=0;var x=s-1;var S=0;var P=0;var u=9;var w=1e3/l;var I=1;if(w>u){I=Math.ceil(w/u)}this.shaderTime=0;var k=false;h.update(C);this.currentFrame=x;this.drawFrame();this.drawFrame();var M=1;for(var C=1;C<v;C++){S++;this.shaderTime=C/v;var k=false;if(p){console.log("HAS TIME BASED EFFECTS!!!!");if(C%I==0){k=true}}var T=h.update(C);var D=this.editor.graphic.getFrameDuration(x)<=S;if(D){x+=M;S=0;if(x==o){if(this.playMode=="pingpong"&&o!=s){x--;M=-M}else{x=s-1}}}if(T||D||k){var E=(C-P)*l;if(c){f.addFrame(this.context,{copy:true,delay:E/2});f.addFrame(this.context,{copy:true,delay:E/2})}else{f.addFrame(this.context,{copy:true,delay:E})}P=C;this.currentFrame=x;this.drawFrame();this.drawFrame()}}var E=(C-P)*l;this.drawFrame();if(c){f.addFrame(this.context,{copy:true,delay:E/2})}else{f.addFrame(this.context,{copy:true,delay:E})}}else{for(var g=s-1;g<o;g++){this.currentFrame=g;var _=this.editor.graphic.getFrameDuration(this.currentFrame);this.drawFrame();if(c){if(this.playMode!="pingpong"&&g==o-1){f.addFrame(this.context,{copy:true,delay:_*l/2})}else{f.addFrame(this.context,{copy:true,delay:_*l/2});f.addFrame(this.context,{copy:true,delay:_*l/2})}}else{f.addFrame(this.context,{copy:true,delay:_*l})}}if(this.playMode=="pingpong"){for(var g=o-2;g>s-1;g--){this.currentFrame=g;var _=this.editor.graphic.getFrameDuration(this.currentFrame);this.drawFrame();if(c){if(g==s){f.addFrame(this.context,{copy:true,delay:_*l/2})}else{f.addFrame(this.context,{copy:true,delay:_*l/2});f.addFrame(this.context,{copy:true,delay:_*l/2})}}else{f.addFrame(this.context,{copy:true,delay:_*l})}}}}var B=this;f.on("finished",function(e){if(t.indexOf(".gif")==-1){t+=".gif"}download(e,t,"application/gif");B.exportGifFinished()});f.on("progress",function(e){var t=e*100;var i=t.toFixed(2)+"%";$("#exportGifProgressText").html(i)});f.render()},exportGifFinished:function(){this.exportInProgress=false;UI.closeDialog();UI.closeDialog()},updateFrame:function(){this.startFrame=this.fromFrame-1;this.endFrame=this.toFrame;var e=getTimestamp();while(e-this.lastTickTime>=this.msPerTick){this.tick++;this.frameTick++;this.lastTickTime=this.lastTickTime+this.msPerTick;var t=this.editor.tileSetManager.getCurrentTileSet();t.update(this.tick);if(TextMode.tick){TextMode.tick(this.tick)}var i=this.tick%this.totalTicks;this.shaderTime=i/this.totalTicks}if(this.recordingVideo){var r=100*(i/this.totalTicks);var a=r.toFixed(2)+"%";$("#exportGifProgressText").html(a)}if(this.playFrames){if(this.currentFrame<0||this.currentFrame>=this.editor.graphic.getFrameCount()){this.currentFrame=0}var s=this.editor.graphic.getFrameDuration(this.currentFrame);if(this.frameTick>=s){this.frameTick=0;this.framesTickCount+=s;var o=this.currentFrame;o+=this.playDirection;if(this.playMode=="pingpong"){if(o===this.startFrame){this.playDirection=1}if(o===this.endFrame-1){this.playDirection=-1}if(o>=this.endFrame){o=this.startFrame}else if(o<this.startFrame){o=this.startFrame}}else if(this.playMode=="once"){if(o>=this.endFrame){o=this.startFrame;if(this.recordingVideo){console.log("recording finished: "+this.tick);this.exportVideoFinished()}}}else{if(o>=this.endFrame){if(this.recordingVideo){console.log("recording finished: "+this.tick);this.exportVideoFinished()}o=this.startFrame}}this.currentFrame=o;this.lastFrameTime=e}}},update:function(){if(!this.exportGifActive){return false}if(this.exportInProgress){return true}this.updateFrame();this.drawFrame();return true}};var ExportSvg=function(){this.editor=null;this.uiComponent=null;this.htmlComponent=null;this.visible=false};ExportSvg.prototype={init:function(e){this.editor=e},initContent:function(){$("#exportSVGAs").val("Untitled")},show:function(){var i=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportSVGDialog",title:"Export SVG",width:300,height:120});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportSvg.html",function(){i.initContent()});this.okButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-199-save.svg"> Download',color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){var t=$("#exportSVGAs").val();i.exportSVG({filename:t})});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){i.visible=false})}UI.showDialog("exportSVGDialog");this.visible=true},exportSVG:function(e){var t="Untitled";if(typeof e.filename!="undefined"){t=e.filename}var i=32;var r=32;var a=40;var s=25;var o="";var l=this.editor.layers.getSelectedLayerObject();if(!l||l.getType()!="grid"){alert("Please choose a grid layer");return}var n=l.getGridWidth();var h=l.getGridHeight();var d=l.getTileSet();var c=l.getColorPalette();var f=d.getTileCount();var u=l.getBackgroundColor();var p=c.getRGBA(u);var v=i*n;var g=r*h;o+='<?xml version="1.0" standalone="no"?>';o+='<svg width="'+v+'" height="'+g+'" xmlns:xlink="http://www.w3.org/1999/xlink">';for(var m=0;m<h;m++){var y=m*r;o+='<g transform="translate(0 '+y+')">';for(var b=0;b<a;b++){var C=p;var x=l.getCell({x:b,y:m});if(x.bc!==this.editor.colorPaletteManager.noColor){C=c.getRGBA(x.bc)}var S=b*i;o+='<g transform="translate('+S+')">';o+='<svg height="'+r+'" width="'+i+'" viewBox="0 0 800 800" fill="rgb('+C[0]+","+C[1]+","+C[2]+')"><rect width="100%" height="100%"></rect></svg>';o+="</g>"}o+="</g>"}var P=i;var w=d.getFontScale();var I=P*w;var k=d.getFontAscent();var M=k*I;for(var m=0;m<s;m++){var y=m*r;var T="";for(var b=0;b<a;b++){var x=l.getCell({x:b,y:m});var D=x.t;var E=x.fc;var p=x.bc;var $=c.getRGBA(E);var S=b*i;var _=d.getSVGPath(D);if(_!==false&&_.indexOf("lyph glyph-name")===0){_=false}if(_!==false){T+='<g transform="translate('+S+')">';T+='<svg height="'+r+'" width="'+i+'" viewBox="0 0 '+i+" "+r+'">';if(_!==false){var B=r-(r-M);T+='<g transform=" translate(0 '+B+") scale(1) translate( 0 0 ) scale( "+I+" -"+I+' ) rotate( 0 400 400) translate( 0 0 ) ">';T+='<path d="'+_+'" fill="rgb('+$[0]+","+$[1]+","+$[2]+')"/>';T+="</g>"}T+="</svg>";T+="</g>"}}if(T!=""){o+='<g transform="translate(0 '+y+')">';o+=T;o+="</g>"}}o+="</svg>";if(t.indexOf(".svg")==-1){t+=".svg"}download(o,t,"application/svg")}};var ExportPng=function(){this.editor=null;this.previewCanvas=null;this.previewContext=null;this.previewCanvasScale=null;this.canvas=null;this.context=null;this.borderWidth=4*8;this.borderHeight=4*8+4;this.scale=1;this.addTransparentPixel=false;this.playMode="loop";this.imageEffectsControl=null;this.previewOffsetX=0;this.previewOffsetY=0;this.previewScale=1;this.mouseIsDown=false;this.exportLayer="all";this.showPrevFrameSave=false;this.visible=false};ExportPng.prototype={init:function(e){this.editor=e},htmlComponentLoaded:function(){this.componentsLoaded++;if(this.componentsLoaded==3){this.splitPanel.setPanelVisible("east",true);this.splitPanel.resize();this.initContent();this.initEvents()}},createUI:function(){var t=this;if(this.uiComponent==null){var e=800;var i=800;this.uiComponent=UI.create("UI.Dialog",{id:"exportPngDialog",title:"Export PNG",width:e,height:i});this.uiComponent.on("resize",function(){t.resizePreview()});this.componentsLoaded=0;this.splitPanel=UI.create("UI.SplitPanel",{id:"exportPngSplitPanel"});this.uiComponent.add(this.splitPanel);this.effectsHtmlComponent=UI.create("UI.HTMLPanel");this.splitPanel.addEast(this.effectsHtmlComponent,290);this.effectsHtmlComponent.load("html/textMode/exportPngEffects.html",function(){t.htmlComponentLoaded()});this.propertiesSplit=UI.create("UI.SplitPanel");this.splitPanel.add(this.propertiesSplit);this.htmlComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.addSouth(this.htmlComponent,220);this.htmlComponent.load("html/textMode/exportPng.html",function(){t.htmlComponentLoaded()});this.previewComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.add(this.previewComponent);this.previewComponent.load("html/textMode/exportPngPreview.html",function(){t.htmlComponentLoaded()});this.previewComponent.on("resize",function(){t.resizePreview()});this.okButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-199-save.svg"> Download',color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportPng();UI.closeDialog()});this.copyButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.copyButton);this.copyButton.on("click",function(e){t.copyToClipboard()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){t.editor.frames.setShowPrevFrame(t.showPrevFrameSave)});this.htmlComponent.on("mousemove",function(e){t.mouseMove(e);e.preventDefault()});this.htmlComponent.on("mouseup",function(e){t.mouseUp(e);e.preventDefault()});this.uiComponent.on("mousedown",function(e){t.mouseDown(e)});this.uiComponent.on("mouseup",function(e){t.mouseUp(e)});this.uiComponent.on("mousemove",function(e){t.mouseMove(e)})}else{this.initContent()}},show:function(){var e=this;this.mouseIsDown=false;this.showPrevFrameSave=this.editor.frames.getShowPrevFrame();this.editor.frames.setShowPrevFrame(false);this.createUI();UI.showDialog("exportPngDialog");this.visible=true;this.resizePreview();if(typeof ClipboardItem!=="undefined"){this.copyButton.setVisible(true)}else{this.copyButton.setVisible(false)}},resizePreview:function(){if(!this.visible){return}if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportPngPreview");$("#exportPngPreview").on("mouseenter",function(){UI.setCursor("can-drag")});$("#exportPngPreview").on("mouseleave",function(){})}var e=$("#exportPngPreviewHolder");if(!e||e.length==0){return}var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}this.previewCanvasScale=UI.devicePixelRatio;if(this.width!=this.previewCanvas.style.width||this.height!=this.previewCanvas.style.height){if(this.width!=0&&this.height!=0){this.previewCanvas.style.width=this.width+"px";this.previewCanvas.style.height=this.height+"px";this.previewCanvas.width=this.width*this.previewCanvasScale;this.previewCanvas.height=this.height*this.previewCanvasScale}}this.previewContext=this.previewCanvas.getContext("2d");this.previewContext.imageSmoothingEnabled=false;this.previewContext.webkitImageSmoothingEnabled=false;this.previewContext.mozImageSmoothingEnabled=false;this.previewContext.msImageSmoothingEnabled=false;this.previewContext.oImageSmoothingEnabled=false;this.drawPreview({redrawLayers:false,applyEffects:false})},initContent:function(){var e=this;$("#exportPNGAs").val(g_app.fileManager.filename);if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportPngPreview");this.previewContext=this.previewCanvas.getContext("2d");this.previewContext.imageSmoothingEnabled=false;this.previewContext.webkitImageSmoothingEnabled=false;this.previewContext.mozImageSmoothingEnabled=false;this.previewContext.msImageSmoothingEnabled=false;this.previewContext.oImageSmoothingEnabled=false}if(this.imageEffectsControl==null){this.imageEffectsControl=new ImageEffectsControl;this.imageEffectsControl.init({htmlElementId:"exportImageEffects"});this.imageEffectsControl.on("update",function(){e.drawPreview({redrawLayers:false})});this.imageEffectsControl.on("updateParam",function(){e.drawPreview({redrawLayers:false})})}this.exportLayer=$("input[name=exportPNGLayer]:checked").val();this.addTransparentPixel=$("#exportPNGTransparentPixel").is(":checked");var t=this.editor.tileSetManager.getCurrentTileSet();var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=this.editor.graphic.getGraphicWidth();var a=this.editor.graphic.getGraphicHeight();this.previewScale=1;this.previewOffsetX=-r/2;this.previewOffsetY=-a/2;this.drawPreview()},initEvents:function(){var i=this;$("#exportPNGIncludeBorder").on("click",function(){i.drawPreview()});$("input[type='radio'][name='exportPNGScale']").on("click",function(){var e=$("input[type='radio'][name='exportPNGScale']:checked").val();i.setScale(e);i.drawPreview()});$("input[name=exportPNGLayer]").on("click",function(){i.exportLayer=$("input[name=exportPNGLayer]:checked").val();i.drawPreview()});$("#exportPNGTransparentPixel").on("click",function(){i.addTransparentPixel=$("#exportPNGTransparentPixel").is(":checked");i.drawPreview()});$("#exportPngPreview").on("mousedown",function(e){i.previewMouseDown(e)});$("#exportPngPreview").on("wheel",function(e){i.previewMouseWheel(e.originalEvent)});$("#pngExportPreviewScale").on("input",function(e){var t=$(this).val();i.setPreviewScale(t/100)});$("#pngExportPreviewScaleText").on("keyup",function(e){var t=parseInt($(this).val());if(isNaN(t)){return}i.setPreviewScale(t/100)});$("#pngExportPreviewScaleReset").on("click",function(){i.setPreviewScale(1)})},setPreviewScale:function(e){this.previewScale=e;this.drawPreview({redrawLayers:false,applyEffects:false});var t=Math.floor(e*100);$("#pngExportPreviewScale").val(t);$("#pngExportPreviewScaleText").val(t)},previewMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);var i=this.previewScale-t.spinY/8;if(i>=.1){this.setPreviewScale(i)}},previewMouseDown:function(e){var t=e.offsetX;var i=e.offsetY;this.mouseDownAtX=e.clientX;this.mouseDownAtY=e.clientY;this.currentOffsetX=this.previewOffsetX;this.currentOffsetY=this.previewOffsetY;this.mouseIsDown=true;UI.setCursor("drag");UI.captureMouse(this)},mouseDown:function(e){},mouseMove:function(e){if(this.mouseIsDown){var t=e.clientX;var i=e.clientY;var r=t-this.mouseDownAtX;var a=i-this.mouseDownAtY;this.previewOffsetX=this.currentOffsetX+r/this.previewScale;this.previewOffsetY=this.currentOffsetY+a/this.previewScale;this.drawPreview({redrawLayers:false,applyEffects:false})}},mouseUp:function(e){this.mouseIsDown=false},drawPreview:function(e){var t=true;if(typeof e!="undefined"&&typeof e.redrawLayers!="undefined"){t=e.redrawLayers}var i=true;if(typeof e!="undefined"&&typeof e.applyEffects!="undefined"){i=e.applyEffects}var r=this.editor.graphic.getCurrentFrame();if(t){this.drawFrame(r,this.exportLayer)}if(i){this.context.drawImage(this.editor.exportFrameImage.getCanvas(),0,0);this.applyEffects()}if(this.canvas==null){return}this.previewContext.fillStyle="#000000";this.previewContext.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height);this.previewContext.save();this.previewContext.translate(Math.floor(this.previewCanvas.width/2),Math.floor(this.previewCanvas.height/2));this.previewContext.scale(this.previewScale*this.previewCanvasScale,this.previewScale*this.previewCanvasScale);this.previewContext.drawImage(this.canvas,this.previewOffsetX,this.previewOffsetY);this.previewContext.restore()},applyEffects:function(){var e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);this.imageEffectsControl.applyEffects(e);this.context.putImageData(e,0,0)},readParameters:function(){this.includeBorder=$("#exportPNGIncludeBorder").is(":checked");var e=$("input[type='radio'][name='exportPNGLayer']:checked").val()},setScale:function(e){var t=this.scale;this.scale=e;this.previewOffsetY=Math.floor(this.previewOffsetY*this.scale/t);this.previewOffsetX=Math.floor(this.previewOffsetX*this.scale/t)},initCanvas:function(){var e=this.editor.tileSetManager.getCurrentTileSet();var t=this.editor.graphic.getGraphicWidth();var i=this.editor.graphic.getGraphicHeight();var r=(t+this.borderWidth*2)*this.scale;var a=(i+this.borderHeight*2)*this.scale;if(!this.canvas){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d")}if(this.canvas.width!=r||this.canvas.height!=a){this.canvas.width=r;this.canvas.height=a;this.context=this.canvas.getContext("2d")}},drawFrame:function(e,t){this.readParameters();if(this.includeBorder){this.borderWidth=4*8;this.borderHeight=4*8+4}else{this.borderWidth=0;this.borderHeight=0}this.initCanvas();this.editor.exportFrameImage.exportFrame({scale:this.scale,includeBorder:this.includeBorder,addTransparentPixel:this.addTransparentPixel,layers:this.exportLayer,frame:e});return;var i=this.exportLayer;if(i=="current"){i=this.editor.layers.getSelectedLayerId()}var r=this.editor.colorPaletteManager.getCurrentColorPalette();var a=this.editor.graphic.getGraphicWidth();var s=this.editor.graphic.getGraphicHeight();if(this.includeBorder){this.borderWidth=4*8;this.borderHeight=4*8+4}else{this.borderWidth=0;this.borderHeight=0}this.context.clearRect(0,0,this.canvas.width,this.canvas.height);if(this.borderWidth!=0||this.borderHeight!=0){var o=false;for(var l=0;l<this.editor.layers.layers.length;l++){var n=this.editor.layers.layers[l];if(n.type=="grid"&&(n.visible&&i=="visible"||i=="all"||i==n.layerId)){var h=null;h=this.editor.layers.getLayerObject(n.layerId);if(h&&typeof h.getBorderColor!="undefined"){o=h.getBorderColor()}}}var d=r.getHexString(o);this.layersContext.fillStyle="#"+d;this.layersContext.fillRect(0,0,this.borderWidth*this.scale,this.canvas.height);this.layersContext.fillRect(this.canvas.width-this.borderWidth*this.scale,0,this.borderWidth*this.scale,this.canvas.height);this.layersContext.fillRect(0,0,this.canvas.width,this.borderHeight*this.scale);this.layersContext.fillRect(0,this.canvas.height-this.borderHeight*this.scale,this.canvas.width,this.borderHeight*this.scale)}this.layersContext.clearRect(this.borderWidth*this.scale,this.borderHeight*this.scale,this.canvas.width-this.borderWidth*this.scale*2,this.canvas.height-this.borderHeight*this.scale*2);if(this.screenCanvas==null){this.screenCanvas=document.createElement("canvas")}if(this.screenContext==null||this.screenCanvas.width!=a||this.screenCanvas.height!=s){this.screenCanvas.width=a;this.screenCanvas.height=s;this.screenContext=UI.getContextNoSmoothing(this.screenCanvas)}this.layersContext.imageSmoothingEnabled=false;this.layersContext.webkitImageSmoothingEnabled=false;this.layersContext.mozImageSmoothingEnabled=false;this.layersContext.msImageSmoothingEnabled=false;this.layersContext.oImageSmoothingEnabled=false;if(g_newSystem){this.editor.graphic.drawFrame({allCells:true,graphicOnly:true,canvas:this.layersCanvas,context:this.layersContext,frame:this.currentFrame,layers:i,scale:this.scale,dstX:this.borderWidth*this.scale,dstY:this.borderHeight*this.scale})}else{this.editor.grid.grid2d.drawFrame({canvas:this.screenCanvas,context:this.screenContext,frame:this.currentFrame,layers:i});this.layersContext.drawImage(this.screenCanvas,this.borderWidth*this.scale,this.borderHeight*this.scale,this.screenCanvas.width*this.scale,this.screenCanvas.height*this.scale)}if(this.addTransparentPixel){var c=this.layersContext.getImageData(0,0,this.canvas.width,this.canvas.height);c.data[3]=100;this.layersContext.putImageData(c,0,0)}},copyToClipboard:function(){this.canvas.toBlob(function(e){var t=new ClipboardItem({"image/png":e});navigator.clipboard.write([t])})},exportPng:function(){var e=$("#exportPNGAs").val();this.drawPreview();if(e.indexOf(".png")==-1){e+=".png"}var t=this.canvas.toDataURL("image/png");download(t,e,"image/png")}};var ExportPngMobile=function(){this.editor=null;this.previewCanvas=null;this.previewContext=null;this.previewCanvasScale=null;this.layersCanvas=null;this.canvas=null;this.context=null;this.screenCanvas=null;this.screenContext=null;this.borderWidth=4*8;this.borderHeight=4*8;this.scale=1;this.addTransparentPixel=false;this.playMode="loop";this.imageEffectsControl=null;this.previewOffsetX=0;this.previewOffsetY=0;this.previewScale=1;this.mouseIsDown=false;this.exportLayer="all";this.touchCount=0};ExportPngMobile.prototype={init:function(e){this.editor=e},htmlComponentLoaded:function(){this.initContent();this.initEvents();this.resizePreview()},show:function(){var t=this;this.mouseIsDown=false;var e=500;var i=100;var r=UI.getScreenWidth();var a=UI.getScreenHeight();e=r-30;i=a-30;if(this.uiComponent==null){this.uiComponent=UI.create("UI.MobilePanel",{id:"exportPngMobileDialog",title:"Export PNG",width:e,height:i});this.uiComponent.on("resize",function(){t.resizePreview()});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportPngMobile.html",function(){t.htmlComponentLoaded()});this.htmlComponent.on("resize",function(){t.resizePreview()});this.okButton=UI.create("UI.Button",{text:"Export"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportPng();UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportPngMobileDialog")},resizePreview:function(){console.log("resize preview");if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportPngMobilePreview")}this.previewCanvasScale=Math.floor(UI.devicePixelRatio);this.width=320;this.height=200;this.previewCanvas.style.width=this.width+"px";this.previewCanvas.style.height=this.height+"px";this.previewCanvas.width=this.width*this.previewCanvasScale;this.previewCanvas.height=this.height*this.previewCanvasScale;this.previewContext=this.previewCanvas.getContext("2d");this.previewContext.imageSmoothingEnabled=false;this.previewContext.webkitImageSmoothingEnabled=false;this.previewContext.mozImageSmoothingEnabled=false;this.previewContext.msImageSmoothingEnabled=false;this.previewContext.oImageSmoothingEnabled=false;this.drawPreview({redrawLayers:false,applyEffects:false})},initContent:function(){var e=this;if(typeof ClipboardItem!=="undefined"){$("#pngExportCopyToClipboard").show();$("#exportPNGMobileCanvasHolder").css("height","270px");$("#exportPNGMobileControlsHolder").css("top","282px")}else{$("#pngExportCopyToClipboard").hide();$("#exportPNGMobileCanvasHolder").css("height","240px");$("#exportPNGMobileControlsHolder").css("top","252px")}$("#exportPNGMobileAs").val(g_app.fileManager.filename);if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportPngMobilePreview");this.previewContext=this.previewCanvas.getContext("2d");this.previewContext.imageSmoothingEnabled=false;this.previewContext.webkitImageSmoothingEnabled=false;this.previewContext.mozImageSmoothingEnabled=false;this.previewContext.msImageSmoothingEnabled=false;this.previewContext.oImageSmoothingEnabled=false}if(this.imageEffectsControl==null){this.imageEffectsControl=new ImageEffectsControl;this.imageEffectsControl.init({htmlElementId:"exportImageMobileEffects"});this.imageEffectsControl.on("update",function(){e.drawPreview({redrawLayers:false})});this.imageEffectsControl.on("updateParam",function(){e.drawPreview({redrawLayers:false})})}this.addTransparentPixel=false;var t=this.editor.tileSetManager.getCurrentTileSet();var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=this.editor.graphic.getGraphicWidth();var a=this.editor.graphic.getGraphicHeight();this.previewScale=1;this.previewOffsetX=-r/2;this.previewOffsetY=-a/2;this.drawPreview()},initEvents:function(){var i=this;this.previewCanvas.addEventListener("touchstart",function(e){i.touchStart(e)},false);this.previewCanvas.addEventListener("touchmove",function(e){i.touchMove(e);return false},false);this.previewCanvas.addEventListener("touchend",function(e){i.touchEnd(e)},false);$("#pngExportCopyToClipboard").on("click",function(){i.copyToClipboard()});$("#exportPNGMobileIncludeBorder").on("click",function(){i.drawPreview()});$("#exportPNGMobileScale").on("change",function(){var e=parseInt($(this).val(),10);if(isNaN(e)){return}i.setScale(e);i.drawPreview()});$("input[name=exportPNGMobileLayer]").on("click",function(){i.exportLayer=$("input[name=exportPNGMobileLayer]:checked").val();i.drawPreview()});$("#exportPNGMobileTransparentPixel").on("click",function(){i.addTransparentPixel=$("#exportPNGMobileTransparentPixel").is(":checked");i.drawPreview()});$("#exportPngMobilePreview").on("mousedown",function(e){i.previewMouseDown(e)});$("#pngExportMobilePreviewScale").on("input",function(e){var t=$(this).val();i.setPreviewScale(t/100)});$("#pngExportMobilePreviewScaleText").on("keyup",function(e){var t=parseInt($(this).val());if(isNaN(t)){return}i.setPreviewScale(t/100)});$("#pngExportMobilePreviewScaleReset").on("click",function(){i.setPreviewScale(1)})},setPreviewScale:function(e){this.previewScale=e;this.drawPreview({redrawLayers:false,applyEffects:false});var t=Math.floor(e*100);$("#pngExportMobilePreviewScale").val(t);$("#pngExportMobilePreviewScaleText").val(t)},previewMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);var i=this.previewScale-t.spinY/8;if(i>=.1){this.setPreviewScale(i)}},touchStart:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1){this.touchCount=1;var s=t[0].pageX-$(this.previewCanvas).offset().left;var o=t[0].pageY-$(this.previewCanvas).offset().top;this.mouseDownAtX=s;this.mouseDownAtY=o;this.currentOffsetX=this.previewOffsetX;this.currentOffsetY=this.previewOffsetY;this.mouseIsDown=true}if(t.length==2){this.touchCount=2;this.touchStart0X=t[0].pageX-r;this.touchStart0Y=t[0].pageY-a;this.touchStart1X=t[1].pageX-r;this.touchStart1Y=t[1].pageY-a;this.touchStartDistance=(this.touchStart0X-this.touchStart1X)*(this.touchStart0X-this.touchStart1X)+(this.touchStart0Y-this.touchStart1Y)*(this.touchStart0Y-this.touchStart1Y);this.touchStartDistance=Math.sqrt(this.touchStartDistance);this.touchStartMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchStartMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.touchMoveMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchMoveMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.pinchStartScale=this.previewScale}},touchMove:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1&&this.touchCount==1){var s=t[0].pageX-$(this.previewCanvas).offset().left;var o=t[0].pageY-$(this.previewCanvas).offset().top;var l=s-this.mouseDownAtX;var n=o-this.mouseDownAtY;this.previewOffsetX=this.currentOffsetX+l/this.previewScale;this.previewOffsetY=this.currentOffsetY+n/this.previewScale;this.drawPreview({redrawLayers:false,applyEffects:false})}if(t.length==2){this.touchMove0X=t[0].pageX-r;this.touchMove0Y=t[0].pageY-a;this.touchMove1X=t[1].pageX-r;this.touchMove1Y=t[1].pageY-a;this.touchMoveDistance=(this.touchMove0X-this.touchMove1X)*(this.touchMove0X-this.touchMove1X)+(this.touchMove0Y-this.touchMove1Y)*(this.touchMove0Y-this.touchMove1Y);this.touchMoveDistance=Math.sqrt(this.touchMoveDistance);var h=this.touchMoveMidX;var d=this.touchMoveMidY;var c=(this.touchMove0X+this.touchMove1X)/2;var f=(this.touchMove0Y+this.touchMove1Y)/2;this.touchMoveMidX=c;this.touchMoveMidY=f;var u=this.previewScale;var p=this.touchMoveDistance/this.touchStartDistance*this.pinchStartScale;this.setPreviewScale(p);var v=(c-h)/p;var g=(f-d)/p;this.previewOffsetX+=v;this.previewOffsetY+=g}},touchEnd:function(e){},drawPreview:function(e){var t=true;if(typeof e!="undefined"&&typeof e.redrawLayers!="undefined"){t=e.redrawLayers}var i=true;if(typeof e!="undefined"&&typeof e.applyEffects!="undefined"){i=e.applyEffects}var r=this.editor.graphic.getCurrentFrame();if(t){this.drawFrame(r,this.exportLayer)}if(i){this.context.drawImage(this.editor.exportFrameImage.getCanvas(),0,0);this.applyEffects()}if(this.canvas==null){return}this.previewContext.fillStyle="#000000";this.previewContext.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height);this.previewContext.save();this.previewContext.translate(Math.floor(this.previewCanvas.width/2),Math.floor(this.previewCanvas.height/2));this.previewContext.scale(this.previewScale*this.previewCanvasScale,this.previewScale*this.previewCanvasScale);this.previewContext.drawImage(this.canvas,Math.floor(this.previewOffsetX),Math.floor(this.previewOffsetY));this.previewContext.restore()},applyEffects:function(){var e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);this.imageEffectsControl.applyEffects(e);this.context.putImageData(e,0,0)},readParameters:function(){this.includeBorder=$("#exportPNGMobileIncludeBorder").is(":checked")},setScale:function(e){var t=this.scale;this.scale=e;this.previewOffsetY=Math.floor(this.previewOffsetY*this.scale/t);this.previewOffsetX=Math.floor(this.previewOffsetX*this.scale/t)},initCanvas:function(){var e=this.editor.graphic.getGraphicWidth();var t=this.editor.graphic.getGraphicHeight();var i=(e+this.borderWidth*2)*this.scale;var r=(t+this.borderHeight*2)*this.scale;if(!this.canvas){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d")}if(this.canvas.width!=i||this.canvas.height!=r){this.canvas.width=i;this.canvas.height=r;this.context=this.canvas.getContext("2d")}},drawFrame:function(e,t){this.readParameters();if(this.includeBorder){this.borderWidth=4*8;this.borderHeight=4*8+4}else{this.borderWidth=0;this.borderHeight=0}this.initCanvas();this.editor.exportFrameImage.exportFrame({scale:this.scale,includeBorder:this.includeBorder,addTransparentPixel:this.addTransparentPixel,layers:this.exportLayer,frame:e});return},copyToClipboard:function(){this.canvas.toBlob(function(e){var t=new ClipboardItem({"image/png":e});navigator.clipboard.write([t])})},exportPng:function(){var e=$("#exportPNGMobileAs").val();this.drawPreview();if(e.indexOf(".png")==-1){e+=".png"}var t=this.canvas.toDataURL("image/png");if(UI.isMobile.any()){mobileDownload({data:t,filename:e,mimeType:"image/png"})}else{download(t,e,"image/png")}}};var ExportSpritePng=function(){this.editor=null;this.previewCanvas=null;this.previewContext=null;this.previewCanvasScale=UI.devicePixelRatio;this.spritesCanvas=null;this.spritesContext=null;this.scale=1;this.addTransparentPixel=false;this.playMode="loop";this.imageEffectsControl=null;this.previewOffsetX=0;this.previewOffsetY=0;this.previewScale=1;this.mouseIsDown=false;this.exportLayer="all";this.showPrevFrameSave=false;this.visible=false};ExportSpritePng.prototype={init:function(e){this.editor=e},htmlComponentLoaded:function(){this.componentsLoaded++;if(this.componentsLoaded==2){this.initContent();this.initEvents()}},createUI:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportSpritePngDialog",title:"Export PNG",width:690});this.uiComponent.on("resize",function(){t.resizePreview()});this.componentsLoaded=0;this.splitPanel=UI.create("UI.SplitPanel",{id:"exportSpritePngSplitPanel"});this.uiComponent.add(this.splitPanel);this.propertiesSplit=UI.create("UI.SplitPanel");this.splitPanel.add(this.propertiesSplit);this.htmlComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportSpritePng.html",function(){t.htmlComponentLoaded()});this.previewComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.addNorth(this.previewComponent,290);this.previewComponent.load("html/textMode/exportSpritePngPreview.html",function(){t.htmlComponentLoaded()});this.previewComponent.on("resize",function(){t.resizePreview()});this.okButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-199-save.svg"> Download',color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportPng();UI.closeDialog()});this.copyButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.copyButton);this.copyButton.on("click",function(e){t.copyToClipboard()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){t.editor.frames.setShowPrevFrame(t.showPrevFrameSave)});this.htmlComponent.on("mousemove",function(e){t.mouseMove(e);e.preventDefault()});this.htmlComponent.on("mouseup",function(e){t.mouseUp(e);e.preventDefault()});this.uiComponent.on("mousedown",function(e){t.mouseDown(e)});this.uiComponent.on("mouseup",function(e){t.mouseUp(e)});this.uiComponent.on("mousemove",function(e){t.mouseMove(e)})}else{this.initContent()}},show:function(){var e=this;this.mouseIsDown=false;this.showPrevFrameSave=this.editor.frames.getShowPrevFrame();this.editor.frames.setShowPrevFrame(false);this.createUI();UI.showDialog("exportSpritePngDialog");this.visible=true;this.resizePreview();if(typeof ClipboardItem!=="undefined"){this.copyButton.setVisible(true)}else{this.copyButton.setVisible(false)}},resizePreview:function(){if(!this.visible){return}if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportSpritePngPreview");$("#exportSpritePngPreview").on("mouseenter",function(){UI.setCursor("can-drag")});$("#exportSpritePngPreview").on("mouseleave",function(){})}var e=$("#exportSpritePngPreviewHolder");if(!e||e.length==0){return}var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}this.previewCanvasScale=UI.devicePixelRatio;if(this.width!=this.previewCanvas.style.width||this.height!=this.previewCanvas.style.height){if(this.width!=0&&this.height!=0){this.previewCanvas.style.width=this.width+"px";this.previewCanvas.style.height=this.height+"px";this.previewCanvas.width=this.width*this.previewCanvasScale;this.previewCanvas.height=this.height*this.previewCanvasScale}}this.previewContext=UI.getContextNoSmoothing(this.previewCanvas);this.drawPreview({redrawLayers:false,applyEffects:false})},initContent:function(){var e=this;$("#exportSpritePNGAs").val(g_app.fileManager.filename);if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportSpritePngPreview");this.previewContext=UI.getContextNoSmoothing(this.previewCanvas)}this.exportLayer="current";this.addTransparentPixel=$("#exportSpritePNGTransparentPixel").is(":checked");var t=this.editor.graphic.getGraphicWidth();var i=this.editor.graphic.getGraphicHeight();this.previewScale=1;this.previewOffsetX=-t/2;this.previewOffsetY=-i/2;this.drawPreview();this.resizePreview()},initEvents:function(){var i=this;$("input[type='radio'][name='exportSpritePNGScale']").on("click",function(){var e=$("input[type='radio'][name='exportSpritePNGScale']:checked").val();i.setScale(e);i.drawPreview()});$("#exportSpritePNGTransparentPixel").on("click",function(){i.addTransparentPixel=$("#exportSpritePNGTransparentPixel").is(":checked");i.drawPreview()});$("#exportSpritePngPreview").on("mousedown",function(e){i.previewMouseDown(e)});$("#exportSpritePngPreview").on("wheel",function(e){i.previewMouseWheel(e.originalEvent)});$("#spritepngExportPreviewScale").on("input",function(e){var t=$(this).val();i.setPreviewScale(t/100)});$("#spritepngExportPreviewScaleText").on("keyup",function(e){var t=parseInt($(this).val());if(isNaN(t)){return}i.setPreviewScale(t/100)});$("#spritepngExportPreviewScaleReset").on("click",function(){i.setPreviewScale(1)});$("#exportSpritePNGAsFileBrowse").on("click",function(){g_electronFiles.saveAsDialog(function(e){console.log("save as response");var t=e.path;$("#exportSpritePNGAsFile").val(t)})})},setPreviewScale:function(e){this.previewScale=e;this.drawPreview({redrawLayers:false,applyEffects:false});var t=Math.floor(e*100);$("#spritepngExportPreviewScale").val(t);$("#spritepngExportPreviewScaleText").val(t)},previewMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);var i=this.previewScale-t.spinY/8;if(i>=.1){this.setPreviewScale(i)}},previewMouseDown:function(e){var t=e.offsetX;var i=e.offsetY;this.mouseDownAtX=e.clientX;this.mouseDownAtY=e.clientY;this.currentOffsetX=this.previewOffsetX;this.currentOffsetY=this.previewOffsetY;this.mouseIsDown=true;UI.setCursor("drag");UI.captureMouse(this)},mouseDown:function(e){},mouseMove:function(e){if(this.mouseIsDown){var t=e.clientX;var i=e.clientY;var r=t-this.mouseDownAtX;var a=i-this.mouseDownAtY;this.previewOffsetX=this.currentOffsetX+r/this.previewScale;this.previewOffsetY=this.currentOffsetY+a/this.previewScale;this.drawPreview({redrawLayers:false,applyEffects:false})}},mouseUp:function(e){this.mouseIsDown=false},drawPreview:function(e){var t=true;if(typeof e!="undefined"&&typeof e.redrawLayers!="undefined"){t=e.redrawLayers}var i=this.editor.graphic.getCurrentFrame();if(t){this.drawFrames()}var r=this.previewCanvas.width;var a=this.previewCanvas.height;var s=this.editor.checkerboardPattern.getCanvas(r,a);this.previewContext.drawImage(s,0,0,r,a,0,0,r,a);this.previewContext.save();this.previewContext.translate(Math.floor(this.previewCanvas.width/2),Math.floor(this.previewCanvas.height/2));this.previewContext.scale(this.previewScale*this.previewCanvasScale,this.previewScale*this.previewCanvasScale);this.previewContext.drawImage(this.spritesCanvas,this.previewOffsetX,this.previewOffsetY);this.previewContext.restore()},readParameters:function(){},setScale:function(e){var t=this.scale;this.scale=e;this.previewOffsetY=Math.floor(this.previewOffsetY*this.scale/t);this.previewOffsetX=Math.floor(this.previewOffsetX*this.scale/t)},drawFrames:function(){if(!this.editor.layers){return}var e=this.editor.layers.getLayers();var t=this.editor.graphic.getFrameCount();var i=21;var r=24;var a=2;var s=24;var o=0;for(var l=e.length-1;l>=0;l--){var n=this.editor.layers.getLayerObject(e[l].layerId);if(n&&n.getType()=="grid"){var h=n.getTileSet();if(h){var d=h.getTileWidth();var c=h.getTileHeight();var f=n.getGridWidth();var u=n.getGridHeight();var p=t*f*d;if(p>s){s=p}o+=u*c}}}if(this.spritesCanvas==null){this.spritesCanvas=document.createElement("canvas")}if(this.spritesContext==null||this.spritesCanvas.width!=s||this.spritesCanvas.height!=o){this.spritesCanvas.width=s;this.spritesCanvas.height=o;this.spritesContext=UI.getContextNoSmoothing(this.spritesCanvas)}var v=this.spritesCanvas;var g=this.spritesContext;g.clearRect(0,0,v.width,v.height);var m=g.getImageData(0,0,v.width,v.height);var y=0;var b=0;for(var l=e.length-1;l>=0;l--){y=0;var n=this.editor.layers.getLayerObject(e[l].layerId);if(n&&n.getType()=="grid"){var h=n.getTileSet();if(h){var d=h.getTileWidth();var c=h.getTileHeight();var f=n.getGridWidth();var u=n.getGridHeight();var C=d*f;var x=c*u;var S={};S["screenMode"]=n.getScreenMode();if(S["screenMode"]===TextModeEditor.Mode.INDEXED){S["transparentColorIndex"]=n.getTransparentColorIndex()}S["imageData"]=m;for(var P=0;P<t;P++){for(var w=0;w<u;w++){for(var I=0;I<f;I++){var k=n.getCell({x:I,y:w,frame:P});if(k){S["color"]=k.fc;S["bgColor"]=k.bc;S["character"]=k.t;if(n.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){S["backgroundColor"]=n.getBackgroundColor(P);S["c64Multi1Color"]=n.getC64Multi1Color(P);S["c64Multi2Color"]=n.getC64Multi2Color(P)}S["x"]=I*d+y;S["y"]=w*c+b;S["scale"]=1;h.drawCharacter(S);y+=d}}}}b+=r}}}g.putImageData(m,0,0)},copyToClipboard:function(){this.spritesCanvas.toBlob(function(e){var t=new ClipboardItem({"image/png":e});navigator.clipboard.write([t])})},savePng:function(){var e=$("#exportSpritePNGAsFile").val();g_electronFiles.saveCanvasAsPNG(this.spritesCanvas,{path:e},function(e){console.log("save result  =");console.log(e)})},exportPng:function(){if(g_app.isDesktopApp()){this.savePng();return}var e=$("#exportSpritePNGAs").val();this.drawPreview();if(e.indexOf(".png")==-1){e+=".png"}var t=this.spritesCanvas.toDataURL("image/png");download(t,e,"image/png")}};var ExportGifMobile=function(){this.editor=null;this.previewCanvas=null;this.previewContext=null;this.previewCanvasScale=null;this.canvas=null;this.context=null;this.screenCanvas=null;this.screenContext=null;this.borderWidth=4*8;this.borderHeight=4*8;this.scale=1;this.playMode="loop";this.playDirection=1;this.imageEffectsControl=null;this.tick=0;this.frameTick=0;this.previewOffsetX=0;this.previewOffsetY=0;this.previewScale=1;this.mouseIsDown=false;this.exportLayer="all";this.touchCount=0;this.currentFrame=0;this.lastTickTime=0;this.msPerTick=50;this.visible=false};ExportGifMobile.prototype={init:function(e){this.editor=e},htmlComponentLoaded:function(){this.initContent();this.initEvents();this.resizePreview()},show:function(){var t=this;this.mouseIsDown=false;var e=500;var i=100;var r=UI.getScreenWidth();var a=UI.getScreenHeight();e=r-30;i=a-30;this.fromFrame=1;this.toFrame=this.editor.graphic.getFrameCount();this.currentFrame=this.fromFrame-1;if(this.uiComponent==null){this.uiComponent=UI.create("UI.MobilePanel",{id:"exportGifMobileDialog",title:"Export GIF",width:e,height:i});this.uiComponent.on("resize",function(){t.resizePreview()});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportGifMobile.html",function(){t.htmlComponentLoaded()});this.htmlComponent.on("resize",function(){t.resizePreview()});this.okButton=UI.create("UI.Button",{text:"Export"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportGif()});this.uiComponent.on("close",function(){t.visible=false})}else{this.initContent()}UI.showDialog("exportGifMobileDialog");this.visible=true},resizePreview:function(){if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportGifMobilePreview")}this.previewCanvasScale=Math.floor(UI.devicePixelRatio);this.width=320;this.height=200;this.previewCanvas.style.width=this.width+"px";this.previewCanvas.style.height=this.height+"px";this.previewCanvas.width=this.width*this.previewCanvasScale;this.previewCanvas.height=this.height*this.previewCanvasScale;this.previewContext=this.previewCanvas.getContext("2d");this.previewContext.imageSmoothingEnabled=false;this.previewContext.webkitImageSmoothingEnabled=false;this.previewContext.mozImageSmoothingEnabled=false;this.previewContext.msImageSmoothingEnabled=false;this.previewContext.oImageSmoothingEnabled=false;this.drawPreview({redrawLayers:false,applyEffects:false})},initContent:function(){var e=this;$("#exportGIFMobileAs").val(g_app.fileManager.filename);if(this.previewCanvas==null){this.previewCanvas=document.getElementById("exportGIFMobilePreview");this.previewContext=this.previewCanvas.getContext("2d");this.previewContext.imageSmoothingEnabled=false;this.previewContext.webkitImageSmoothingEnabled=false;this.previewContext.mozImageSmoothingEnabled=false;this.previewContext.msImageSmoothingEnabled=false;this.previewContext.oImageSmoothingEnabled=false}if(this.imageEffectsControl==null){this.imageEffectsControl=new ImageEffectsControl;this.imageEffectsControl.init({htmlElementId:"exportImageMobileEffects"});this.imageEffectsControl.on("update",function(){e.drawPreview({redrawLayers:false})});this.imageEffectsControl.on("updateParam",function(){e.drawPreview({redrawLayers:false})})}var t=this.editor.tileSetManager.getCurrentTileSet();var i=this.editor.colorPaletteManager.getCurrentColorPalette();var r=this.editor.graphic.getGraphicWidth();var a=this.editor.graphic.getGraphicHeight();this.previewScale=1;this.previewOffsetX=-r/2;this.previewOffsetY=-a/2;this.drawPreview();$("#exportGIFMobileProgress").hide()},initEvents:function(){var i=this;this.previewCanvas.addEventListener("touchstart",function(e){i.touchStart(e)},false);this.previewCanvas.addEventListener("touchmove",function(e){i.touchMove(e);return false},false);this.previewCanvas.addEventListener("touchend",function(e){i.touchEnd(e)},false);$("#exportGIFMobileIncludeBorder").on("click",function(){i.drawPreview()});$("#exportGIFMobileScale").on("change",function(){var e=parseInt($(this).val(),10);if(isNaN(e)){return}i.setScale(e);i.drawPreview()});$("input[name=exportGIFMobileLayer]").on("click",function(){i.exportLayer=$("input[name=exportGIFMobileLayer]:checked").val();i.drawPreview()});$("#exportGIFMobilePreview").on("mousedown",function(e){i.previewMouseDown(e)});$("#GIFExportMobilePreviewScale").on("input",function(e){var t=$(this).val();i.setPreviewScale(t/100)});$("#GIFExportMobilePreviewScaleText").on("keyup",function(e){var t=parseInt($(this).val());if(isNaN(t)){return}i.setPreviewScale(t/100)});$("#GIFExportMobilePreviewScaleReset").on("click",function(){i.setPreviewScale(1)});$("#exportGIFMobileSaveGDrive").on("click",function(){i.saveToGDrive()})},setPreviewScale:function(e){this.previewScale=e;this.drawPreview({redrawLayers:false,applyEffects:false});var t=Math.floor(e*100);$("#GIFExportMobilePreviewScale").val(t);$("#GIFExportMobilePreviewScaleText").val(t)},previewMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);var i=this.previewScale-t.spinY/8;if(i>=.1){this.setPreviewScale(i)}},touchStart:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1){this.touchCount=1;var s=t[0].pageX-$(this.previewCanvas).offset().left;var o=t[0].pageY-$(this.previewCanvas).offset().top;this.mouseDownAtX=s;this.mouseDownAtY=o;this.currentOffsetX=this.previewOffsetX;this.currentOffsetY=this.previewOffsetY;this.mouseIsDown=true}if(t.length==2){this.touchCount=2;this.touchStart0X=t[0].pageX-r;this.touchStart0Y=t[0].pageY-a;this.touchStart1X=t[1].pageX-r;this.touchStart1Y=t[1].pageY-a;this.touchStartDistance=(this.touchStart0X-this.touchStart1X)*(this.touchStart0X-this.touchStart1X)+(this.touchStart0Y-this.touchStart1Y)*(this.touchStart0Y-this.touchStart1Y);this.touchStartDistance=Math.sqrt(this.touchStartDistance);this.touchStartMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchStartMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.touchMoveMidX=(this.touchStart0X+this.touchStart1X)/2;this.touchMoveMidY=(this.touchStart0Y+this.touchStart1Y)/2;this.pinchStartScale=this.previewScale}},touchMove:function(e){e.preventDefault();var t=e.touches;var i=$("#"+this.previewCanvas.id).offset();var r=i.left;var a=i.top;if(t.length==1&&this.touchCount==1){var s=t[0].pageX-$(this.previewCanvas).offset().left;var o=t[0].pageY-$(this.previewCanvas).offset().top;var l=s-this.mouseDownAtX;var n=o-this.mouseDownAtY;this.previewOffsetX=this.currentOffsetX+l/this.previewScale;this.previewOffsetY=this.currentOffsetY+n/this.previewScale;this.drawPreview({redrawLayers:false,applyEffects:false})}if(t.length==2){this.touchMove0X=t[0].pageX-r;this.touchMove0Y=t[0].pageY-a;this.touchMove1X=t[1].pageX-r;this.touchMove1Y=t[1].pageY-a;this.touchMoveDistance=(this.touchMove0X-this.touchMove1X)*(this.touchMove0X-this.touchMove1X)+(this.touchMove0Y-this.touchMove1Y)*(this.touchMove0Y-this.touchMove1Y);this.touchMoveDistance=Math.sqrt(this.touchMoveDistance);var h=this.touchMoveMidX;var d=this.touchMoveMidY;var c=(this.touchMove0X+this.touchMove1X)/2;var f=(this.touchMove0Y+this.touchMove1Y)/2;this.touchMoveMidX=c;this.touchMoveMidY=f;var u=this.previewScale;var p=this.touchMoveDistance/this.touchStartDistance*this.pinchStartScale;this.setPreviewScale(p);var v=(c-h)/p;var g=(f-d)/p;this.previewOffsetX+=v;this.previewOffsetY+=g}},touchEnd:function(e){},drawPreview:function(e){if(this.previewCanvas==null){return}var t=true;if(typeof e!="undefined"&&typeof e.redrawLayers!="undefined"){t=e.redrawLayers}var i=true;if(typeof e!="undefined"&&typeof e.applyEffects!="undefined"){i=e.applyEffects}if(t){this.drawFrame()}if(false&&i){this.applyEffects()}else{this.context.drawImage(this.editor.exportFrameImage.getCanvas(),0,0)}if(this.canvas==null){return}this.previewContext.fillStyle="#000000";this.previewContext.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height);this.previewContext.save();this.previewContext.translate(Math.floor(this.previewCanvas.width/2),Math.floor(this.previewCanvas.height/2));this.previewContext.scale(this.previewScale*this.previewCanvasScale,this.previewScale*this.previewCanvasScale);this.previewContext.drawImage(this.canvas,Math.floor(this.previewOffsetX),Math.floor(this.previewOffsetY));this.previewContext.restore()},applyEffects:function(){var e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);this.imageEffectsControl.applyEffects(e);this.context.putImageData(e,0,0)},readParameters:function(){this.includeBorder=$("#exportGIFMobileIncludeBorder").is(":checked")},setScale:function(e){var t=this.scale;this.scale=e;this.previewOffsetY=Math.floor(this.previewOffsetY*this.scale/t);this.previewOffsetX=Math.floor(this.previewOffsetX*this.scale/t)},initCanvas:function(){var e=this.editor.graphic.getGraphicWidth();var t=this.editor.graphic.getGraphicHeight();var i=(e+this.borderWidth*2)*this.scale;var r=(t+this.borderHeight*2)*this.scale;if(!this.canvas){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d")}if(this.canvas.width!=i||this.canvas.height!=r){this.canvas.width=i;this.canvas.height=r;this.context=this.canvas.getContext("2d")}},drawFrame:function(){this.readParameters();var e=this.exportLayer;if(e=="current"){e=this.editor.layers.getSelectedLayerId()}if(this.includeBorder){this.borderWidth=4*8;this.borderHeight=4*8}else{this.borderWidth=0;this.borderHeight=0}this.initCanvas();this.editor.exportFrameImage.exportFrame({scale:this.scale,includeBorder:this.borderWidth!=0,layers:this.exportLayer,frame:this.currentFrame});this.context.drawImage(this.editor.exportFrameImage.getCanvas(),0,0)},exportGifFinished:function(){},saveToGDrive:function(){console.log("save to gdrive");var e=this;g_app.gdrive.handleAuthClick(function(){e.exportGif({saveToGDrive:true})})},exportGif:function(e){var r=false;if(typeof e!=="undefined"){if(typeof e.saveToGDrive!="undefined"){r=e.saveToGDrive}}var a=$("#exportGIFMobileAs").val();this.drawPreview();if(a.indexOf(".gif")==-1){a+=".gif"}var t=100;var i=new GIF({workers:4,workerScript:"lib/gif/gif.worker.js",quality:10,width:this.canvas.width,height:this.canvas.height,background:"#000000",repeat:0});var s=1;var o=FRAMERATE/s;this.playMode="loop";var l=1;var n=this.editor.graphic.getFrameCount();var h=[];var d=this.editor.tileSetManager.getCurrentTileSet();var c=d.getAnimatedCharacterTicks();var f=false;var u=30;var p=false;if(true){var v=0;for(var g=l-1;g<n;g++){var m=this.editor.graphic.getFrameDuration(g);v+=m}if(this.playMode=="pingpong"&&n!=l){v*=2}h.push(v);for(var g=0;g<c.length;g++){h.push(c[g]);if(v<c[g]){v=c[g]}}function y(e,t){return!t?e:y(t,e%t)}function b(e,t){return e*t/y(e,t)}var C=h[0];h.forEach(function(e){C=b(C,e)});v=C;var x=0;var S=l-1;var P=0;var w=0;var u=9;var I=1e3/o;var k=1;if(I>u){k=Math.ceil(I/u)}this.shaderTime=0;var M=false;d.update(x);this.currentFrame=S;console.log("frame = "+this.currentFrame);this.drawFrame();this.context.drawImage(this.editor.exportFrameImage.getCanvas(),0,0);var T=1;for(var x=1;x<v;x++){P++;this.shaderTime=x/v;var M=false;if(p){if(x%k==0){M=true}}var D=d.update(x);var E=this.editor.graphic.getFrameDuration(S)<=P;if(E){S+=T;P=0;if(S==n){if(this.playMode=="pingpong"&&n!=l){S--;T=-T}else{S=l-1}}}if(D||E||M){var t=(x-w)*o;if(f){i.addFrame(this.context,{copy:true,delay:t/2});i.addFrame(this.context,{copy:true,delay:t/2})}else{i.addFrame(this.context,{copy:true,delay:t})}w=x;this.currentFrame=S;console.log("frame = "+this.currentFrame);this.drawFrame();this.context.drawImage(this.editor.exportFrameImage.getCanvas(),0,0)}}var t=(x-w)*o;if(f){i.addFrame(this.context,{copy:true,delay:t/2})}else{i.addFrame(this.context,{copy:true,delay:t})}}else{for(var g=l-1;g<n;g++){var m=this.editor.graphic.getFrameDuration(g);this.currentFrame=g;this.drawFrame();if(f){if(this.playMode!="pingpong"&&g==n-1){i.addFrame(this.context,{copy:true,delay:m*o/2})}else{i.addFrame(this.context,{copy:true,delay:m*o/2});i.addFrame(this.context,{copy:true,delay:m*o/2})}}else{i.addFrame(this.context,{copy:true,delay:m*o})}}if(this.playMode=="pingpong"){for(var g=n-2;g>l-1;g--){this.currentFrame=g;var m=this.editor.graphic.getFrameDuration(g);this.drawFrame();if(f){if(g==l){i.addFrame(this.context,{copy:true,delay:m*o/2})}else{i.addFrame(this.context,{copy:true,delay:m*o/2});i.addFrame(this.context,{copy:true,delay:m*o/2})}}else{i.addFrame(this.context,{copy:true,delay:m*o})}}}}if(true||UI.isMobile.iOS()){$("#exportGIFMobileProgress").html("Generating GIF...");$("#exportGIFMobileProgress").show()}var _=this;i.on("finished",function(e){if(a.indexOf(".gif")==-1){a+=".gif"}if(r){var t=UI.getScreenHeight()*2/5;html='<div style="text-align: center; color: #aaaaaa; font-size: 24px; padding-top: '+t+'px">Uploading...</div>';$("#exportGIFMobileProgress").html(html);g_app.gdrive.uploadToAppFolder(e,a,{success:function(e){UI.closeDialog()},progress:function(e){console.log(e);var t=0;var i=e.loaded||e.position;var r=e.total;if(e.lengthComputable){t=Math.ceil(i/r*100)}var a="Uploading: "+t.toFixed(2)+"%";var s=UI.getScreenHeight()*2/5;a='<div style="text-align: center; color: #aaaaaa; font-size: 24px; padding-top: '+s+'px">'+a+"</div>";$("#exportGIFMobileProgress").html(a)},error:function(e){console.log("ERROR!!!!");console.log(e);var t=UI.getScreenHeight()*2/15;var i="Error!!!";i+="<p>";i+=e.responseText;i+="</p>";html='<div style="text-align: center; color: #aaaaaa; font-size: 24px; padding-top: '+t+'px">'+i+"</div>";$("#exportGIFMobileProgress").html(html)}})}else{var i=new FileReader;i.onload=function(e){var t=e.target.result;mobileDownload({data:t,filename:a,mimeType:"image/gif"});UI.closeDialog()};i.readAsDataURL(e)}_.exportGifFinished()});i.on("progress",function(e){var t=e*100;var i="Generating: "+t.toFixed(2)+"%";var r=UI.getScreenHeight()*2/5;i='<div style="text-align: center; color: #aaaaaa; font-size: 24px; padding-top: '+r+'px">'+i+"</div>";$("#exportGIFMobileProgress").html(i)});i.render()},updateFrame:function(){this.startFrame=this.fromFrame-1;this.endFrame=this.toFrame;var e=getTimestamp();var t=1;this.msPerTick=FRAMERATE/t;while(e-this.lastTickTime>=this.msPerTick){this.tick++;this.frameTick++;this.lastTickTime=this.lastTickTime+this.msPerTick;var i=this.editor.tileSetManager.getCurrentTileSet();i.update(this.tick);if(TextMode.tick){TextMode.tick(this.tick)}}if(true){if(this.currentFrame<0||this.currentFrame>=this.editor.graphic.getFrameCount()){this.currentFrame=0}var r=this.editor.graphic.getFrameDuration(this.currentFrame);if(this.frameTick>=r){this.frameTick=0;this.framesTickCount+=r;var a=this.currentFrame;a+=this.playDirection;if(this.playMode=="pingpong"){if(a===this.startFrame){this.playDirection=1}if(a===this.endFrame-1){this.playDirection=-1}if(a>=this.endFrame){a=this.startFrame}else if(a<this.startFrame){a=this.startFrame}}else if(this.playMode=="once"){if(a>=this.endFrame){a=this.startFrame;if(this.recordingVideo){console.log("recording finished: "+this.tick);this.exportVideoFinished()}}}else{if(a>=this.endFrame){a=this.startFrame}}this.currentFrame=a;this.lastFrameTime=e}}},update:function(){if(!this.visible){return false}this.updateFrame();this.drawPreview();return true}};var ExportJson=function(){this.editor=null;this.jsonType="native"};ExportJson.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportJsonDialog",title:"Export JSON",width:336,height:348});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportJson.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportJson();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportJsonDialog")},initContent:function(){this.colorPerMode=this.editor.getColorPerMode();this.blockModeEnabled=this.editor.getBlockModeEnabled();$("#exportJSONAs").val(g_app.fileManager.filename);var e=this.editor.graphic.getFrameCount();console.log("frame count = "+e);$("#exportJsonToFrame").val(e);$("#exportJsonFromFrame").val(1);$("#exportJsonToFrame").attr("max",e);$("#exportJsonFromFrame").attr("max",e)},initEvents:function(){var e=this;$("#exportJsonType").on("change",function(){e.setJsonType($(this).val())})},setJsonType:function(e){this.jsonType=e;if(e=="native"){$(".exportJsonNativeSettings").show();$(".exportJsonTiledSettings").hide()}if(e=="tiled"){$(".exportJsonNativeSettings").hide();$(".exportJsonTiledSettings").show()}},exportTiledJsonAs:function(e){var t="Untitled";if(typeof e.filename!="undefined"){t=e.filename}var i=this.editor.tileSetManager.getCurrentTileSet();var r=this.editor.graphic.getCurrentFrame();var a=this.editor.layers.getLayers();var s=e.includeTiles;var o=[];var l={};var n=i.tileCount;if(s=="all"){var h=this.editor.colorPaletteManager.noColor;var d=this.editor.currentTile.getColor();for(var c=0;c<n;c++){var f=c+"-"+d+"-"+h;l[f]=o.length;o.push({tileIndex:c,fc:d,bc:h})}}var u=this.editor.graphic.getGridWidth();var p=this.editor.graphic.getGridHeight();for(var v=0;v<a.length;v++){if(a[v].type=="grid"){var g=this.editor.layers.getLayerObject(a[v].layerId);var m=g.getGridWidth();var y=g.getGridHeight();var b=0;var C=y;var x=1;b=y-1;C=-1;x=-1;var S=0;var P=m;var w=1;for(var I=b;I!=C;I+=x){for(var k=S;k!=P;k+=w){var M=g.getCell({x:k,y:I,frame:r});var f=M.t+"-"+M.fc+"-"+M.bc;if(!l.hasOwnProperty(f)){l[f]=o.length;o.push({tileIndex:M.t,fc:M.fc,bc:M.bc})}}}}}var T=[];var D=16;var E=Math.ceil(o.length/16);var $=0;for(var I=0;I<E;I++){T.push([]);for(var k=0;k<D;k++){if($<o.length){T[I].push({c:o[$].tileIndex,fc:o[$].fc,bc:o[$].bc});$++}else{T[I].push({c:-1,fc:-1,bc:-1})}}}var _=i.exportPngFromMap({map:T});var B={tiledversion:"1.2.0",type:"map",version:1.2,width:u,height:p,renderorder:"right-down",infinite:false,orientation:"orthogonal",tilewidth:i.getTileWidth(),tileheight:i.getTileHeight(),tilesets:[{columns:D,firstgid:1,image:"tiles.png",imageheight:E*i.getTileHeight(),imagewidth:D*i.getTileWidth(),margin:0,name:"tile set",spacing:0,tilecount:o.length,tileheight:i.getTileWidth(),tilewidth:i.getTileHeight()}]};var R=[];var A=0;for(var v=0;v<a.length;v++){if(a[v].type=="grid"){var g=this.editor.layers.getLayerObject(a[v].layerId);var m=g.getGridWidth();var y=g.getGridHeight();A++;var b=0;var C=y;var x=1;if(true){b=y-1;C=-1;x=-1}var S=0;var P=m;var w=1;if(false){S=P-1;P=-1;w=-1}var F=[];for(var I=b;I!=C;I+=x){for(var k=S;k!=P;k+=w){var M=g.getCell({x:k,y:I,frame:r});var f=M.t+"-"+M.fc+"-"+M.bc;console.log("key = "+f);var L=l[f];console.log("index = "+L);F.push(L+1)}}R.push({id:A,width:m,height:y,name:a[v].label,opacity:a[v].opacity,type:"tilelayer",visible:true,data:F,x:0,y:0})}}B.layers=R;B.nextlayerid=A+1;B.nextobjectid=1;var U=JSON.stringify(B);var H=new JSZip;H.file(t+".json",U);H.file("tiles.png",_);H.generateAsync({type:"blob"}).then(function(e){download(e,t+".zip","application/zip")})},exportJsonAs:function(e){console.log("args = ");console.log(e);var t="Untitled";if(typeof e.filename!="undefined"){t=e.filename}var i="json";if(typeof e.format!="undefined"){i=e.format}var r="toptobottom";if(typeof e.direction!="undefined"){r=e.direction}var a=this.editor.graphic.getCurrentFrame();var s=a;if(typeof e.fromFrame!="undefined"){s=e.fromFrame}var o=a;if(typeof e.toFrame!="undefined"){o=e.toFrame}var l={};l.version=1;var n=this.editor.tileSetManager.getCurrentTileSet();if(e.exportTileSet){l.tileSet=n.getJSON()}var h=this.editor.colorPaletteManager.getCurrentColorPalette();if(e.exportColorPalette){l.colorPalette=h.getJSON()}if(e.exportMap){if(s>=0){s--}if(o<this.editor.graphic.getFrameCount()){}l.tileMap=this.editor.graphic.getJSON({fromFrame:s,toFrame:o})}if(t.indexOf(".json")==-1){t+=".json"}var d=JSON.stringify(l);download(d,t,"application/json")},exportJson:function(){var e={};e.filename=$("#exportJsonAs").val();e.type=$("#exportJsonType").val();e.format=$("input[name=exportJSONFormat]:checked").val();e.direction=$("input[name=exportJsonDirection]:checked").val();e.exportMap=$("#exportJSONMapData").is(":checked");e.exportTileSet=$("#exportJSONTilesetData").is(":checked");e.exportColorPalette=$("#exportJSONColorPaletteData").is(":checked");e.includeTiles=$("input[name=exportJsonTiles]:checked").val();e.fromFrame=parseInt($("#exportJsonFromFrame").val(),10);e.toFrame=parseInt($("#exportJsonToFrame").val(),10);if(e.type=="native"){this.exportJsonAs(e)}else{this.exportTiledJsonAs(e)}}};var ExportTxt=function(){this.editor=null;this.lineEnding="\r\n";this.columns=16};ExportTxt.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportTxtDialog",title:"Export Txt",width:800,height:600});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportTxt.html",function(){t.initContent();t.initEvents()});this.displayButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"/> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.displayButton);this.displayButton.on("click",function(e){t.copyToClipboard()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportTxtDialog")},initContent:function(){if(this.asmEditor==null){this.asmEditor=ace.edit("exportTxtSource");this.asmEditor.getSession().setTabSize(2);this.asmEditor.getSession().setUseSoftTabs(true);this.asmEditor.on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});this.asmEditor.on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});var e="ace/mode/text";this.asmEditor.getSession().setMode(e);this.asmEditor.setShowInvisibles(false);this.asmEditor.setDisplayIndentGuides(false)}$("#exportTxtAs").val(g_app.fileManager.filename);var t=this.editor.graphic.getFrameCount();$("#exportTxtToFrame").val(t);$("#exportTxtFromFrame").val(1);$("#exportTxtFromFrame").attr("max",t);$("#exportTxtToFrame").attr("max",t);this.exportTxt({displayOnly:true})},initEvents:function(){var e=this;$("#exportTxtInsertFrameSeparator").on("click",function(){e.exportTxt({displayOnly:true})});$("#exportTxtFromFrame").on("change",function(){e.exportTxt({displayOnly:true})});$("#exportTxtToFrame").on("change",function(){e.exportTxt({displayOnly:true})});$("#exportTxtDownload").on("click",function(){e.download()})},copyToClipboard:function(){var e=this.asmEditor.selection.toJSON();this.asmEditor.selectAll();this.asmEditor.focus();document.execCommand("copy");this.asmEditor.selection.fromJSON(e)},exportTxtFormat:function(e){var t=true;if(typeof e.insertFrameSeparator!="undefined"){t=e.insertFrameSeparator}var i="";var r=this.editor.layers.getSelectedLayerObject();var a=r.getGridWidth();var s=r.getGridHeight();for(var o=e.fromFrame-1;o<e.toFrame;o++){if(o>=this.editor.graphic.getFrameCount()){break}var l=o+1;if(t){var n="Frame "+l+" ";var h=a-n.length;i+=n;for(var d=0;d<h;d++){i+="-"}i+=this.lineEnding}for(var c=0;c<s;c++){for(var f=0;f<a;f++){var u=r.getCell({frame:o,x:f,y:c});var p=u.t;p=String.fromCharCode(p);i+=p}i+=this.lineEnding}}if(typeof e.displayOnly!="undefined"&&e.displayOnly){this.asmEditor.setValue(i,-1)}else{download(i,e.filename+".txt","application/txt")}},exportTxtAs:function(e){if(typeof e.filename=="undefined"){e.filename=g_app.fileManager.filename}var t=this.editor.graphic.getCurrentFrame();if(typeof e.fromFrame=="undefined"){e.fromFrame=t}if(typeof e.toFrame=="undefined"){e.toFrame=t}this.exportTxtFormat(e)},download:function(){var e=$("#exportTxtAs").val();e+=".txt";var t=this.asmEditor.getValue();download(t,e,"application/txt")},exportTxt:function(e){e.filename=$("#exportTxtAs").val();e.fromFrame=parseInt($("#exportTxtFromFrame").val(),10);e.toFrame=parseInt($("#exportTxtToFrame").val(),10);e.insertFrameSeparator=$("#exportTxtInsertFrameSeparator").is(":checked");this.exportTxtAs(e)}};var ExportPetsciiC=function(){this.editor=null};ExportPetsciiC.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportPetsciiCDialog",title:"Export C",width:330,height:246});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportPetsciiC.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportPetsciiC();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportPetsciiCDialog")},initContent:function(){$("#exportPetsciiCAs").val(g_app.fileManager.filename);var e=this.editor.graphic.getFrameCount();$("#exportPetsciiCToFrame").val(e);$("#exportPetsciiCFromFrame").val(1);$("#exportPetsciiCFromFrame").attr("max",e);$("#exportPetsciiCToFrame").attr("max",e)},initEvents:function(){var e=this},exportPetsciiCAs:function(e){var t="Untitled";var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){alert("Please select a grid layer");return}var r=i.getGridWidth();var a=i.getGridHeight();if(typeof e.filename!="undefined"){t=e.filename}var s="";var o="frame";if(typeof e.variableName!="undefined"){o=e.variableName}var l=this.editor.graphic.getCurrentFrame();var n=l;if(typeof e.fromFrame!="undefined"){n=e.fromFrame}var h=l;if(typeof e.toFrame!="undefined"){h=e.toFrame}for(var d=n-1;d<h;d++){var c=d+1;var f=o;if(n!==h){f+=("0000"+c).substr(-4)}s+="unsigned char "+f+"[] = {  ";s+="// border,bg,chars,colors";s+="\n";s+=i.getBorderColor(d)+",";s+=i.getBackgroundColor(d)+","+"\n";var u=0;var p=a;var v=1;for(var g=u;g!=p;g+=v){for(var m=0;m<r;m++){var y=i.getCell({x:m,y:g,frame:d});s+=y.t;s+=","}s+="\n"}for(var g=u;g!=p;g+=v){for(var m=0;m<r;m++){var y=i.getCell({x:m,y:g,frame:d});s+=y.fc;if(m!=r-1||g!=a-1){s+=","}}s+="\n"}s+="};\n"}s+="// META: "+r+" "+a+" C64 upper\n";if(t.indexOf(".c")==-1){t+=".c"}download(s,t,"application/c")},exportPetsciiC:function(){var e={};e.filename=$("#exportPetsciiCAs").val();e.variableName=$("#exportPetsciiCAsVariableName").val();e.fromFrame=parseInt($("#exportPetsciiCFromFrame").val(),10);e.toFrame=parseInt($("#exportPetsciiCToFrame").val(),10);this.exportPetsciiCAs(e);var t=$("#exportPetsciiCAs").val()}};var ExportPet=function(){this.editor=null};ExportPet.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportPetDialog",title:"Export .PET",width:330,height:246});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportPet.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportPet();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportPetDialog")},initContent:function(){$("#exportPetAs").val(g_app.fileManager.filename)},initEvents:function(){var e=this},exportPetAs:function(e){var t="Untitled";var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){alert("Please select a grid layer");return}var r=i.getGridWidth();var a=i.getGridHeight();if(typeof e.filename!="undefined"){t=e.filename}var s=[];var o=this.editor.graphic.getCurrentFrame();var l=0;s.push(r);s.push(a);s.push(i.getBorderColor(o));s.push(i.getBackgroundColor(o));s.push(l);for(var n=0;n<a;n++){for(var h=0;h<r;h++){var d=i.getCell({x:h,y:n,frame:o});s.push(d.t)}}for(var n=0;n<a;n++){for(var h=0;h<r;h++){var d=i.getCell({x:h,y:n,frame:o});s.push(d.fc)}}var c=new Uint8Array(s.length);for(var f=0;f<s.length;f++){c[f]=s[f]}if(t.indexOf(".pet")==-1){t+=".pet"}download(c,t,"application/bin")},exportPet:function(){var e={};e.filename=$("#exportPetAs").val();this.exportPetAs(e)}};var ExportBinaryData=function(){this.editor=null};ExportBinaryData.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){var e=420;var i=420;this.uiComponent=UI.create("UI.Dialog",{id:"exportBinaryDataDialog",title:"Export Binary Data",width:e,height:i});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportBinaryData.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportBinaryData();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportBinaryDataDialog")},initContent:function(){$("#exportBinaryAs").val(g_app.fileManager.filename);var e=this.editor.graphic.getFrameCount();$("#exportBinaryToFrame").val(e);$("#exportBinaryFromFrame").val(1);$("#exportBinaryFromFrame").attr("max",e);$("#exportBinaryToFrame").attr("max",e)},initEvents:function(){var e=this},getExtendedColorBGColors:function(e){var t=e.layer;var i=e.gridWidth;var r=e.gridHeight;var a=e.fromFrame-1;var s=e.toFrame;this.extendedColorBGColors=[];var o=[];for(var l=0;l<16;l++){o[l]={color:l,timesUsed:0}}for(var n=a;n<s;n++){var h=n;for(var d=0;d<r;d++){for(var c=0;c<i;c++){var f=0;var u=t.getCell({x:c,y:d,frame:h});f=u.bc;if(typeof f=="undefined"||f===false||f===this.editor.colorPaletteManager.noColor){f=t.getBackgroundColor()}o[f].timesUsed++}}}o.sort(function(e,t){return t.timesUsed-e.timesUsed});for(var l=0;l<4;l++){this.extendedColorBGColors[l]=o[l]}console.log("bg colours:");console.log(o);console.log(this.extendedColorBGColors)},exportBinaryDataAsMega65:function(e){console.log("export mega 65");var t=this.editor.layers.getSelectedLayerObject();var i=t.getScreenMode();var r=g_app.fileManager.filename;if(typeof e.filename!="undefined"){r=e.filename}var a=this.editor.graphic.getCurrentFrame();if(typeof e.fromFrame!="undefined"){a=e.fromFrame}var s=this.editor.graphic.getCurrentFrame();if(typeof e.toFrame!="undefined"){s=e.toFrame}var o="mega65";if(typeof e.format!="undefined"){o=e.format}var l=".bin";if(o=="c64"){l=".prg"}var n=t.getTileSet();var h=n.getTileCount();var d=n.getTileWidth();var c=n.getTileHeight();var f=e.exportMapData;var u=e.exportColorData;var p=e.exportTileData;var v=true;var g=new JSZip;var m=this.editor.graphic.getFrameCount();var y=t.getGridHeight();var b=t.getGridWidth();var C=1;var x=t.getLabel();var S=[];if(p){var S=new Uint8Array(h*c*d);var P=0;for(var w=0;w<h;w++){for(var I=0;I<c;I++){for(var k=0;k<d;k++){var M=n.getPixel(w,k,I);S[P++]=M}}}g.file("TileData_"+x+"_Frame_"+C+l,S)}if(v){var T=new Uint8Array(255*3);var D=[];var E=[];var $=[];var _=t.getColorPalette();var B=_.getColorCount();for(var R=0;R<255;R++){if(R<B){var A=_.getRGBA(R);A[0]=A[0]&255;var F=(A[0]&240)>>4;var L=A[0]&15;if(L>7){L=7}F+=L<<4;D.push(F);F=((A[1]&240)>>4)+((A[1]&15)<<4);E.push(F);F=((A[2]&240)>>4)+((A[2]&15)<<4);$.push(F)}else{D.push(0);E.push(0);$.push(0)}}var P=0;for(var R=0;R<256;R++){T[P++]=D[R]}for(var R=0;R<256;R++){T[P++]=E[R]}for(var R=0;R<256;R++){T[P++]=$[R]}g.file("PaletteData_"+x+"_Frame_"+C+l,T)}console.log("export mega65 binary");g.generateAsync({type:"blob"}).then(function(e){download(e,r+".zip","application/zip")})},exportBinaryDataAs:function(e){var t=this.editor.layers.getSelectedLayerObject();var i=t.getScreenMode();var r=i===TextModeEditor.Mode.C64ECM;var a=false;if(typeof e.colorMode){a=e.colorMode=="ecm"}if(!t&&t.getType()!="grid"){return}var s=g_app.fileManager.filename;if(typeof e.filename!="undefined"){s=e.filename}var o="binary";if(typeof e.format!="undefined"){o=e.format}if(o=="mega65"){this.exportBinaryDataAsMega65(e);return}var l=this.editor.graphic.getCurrentFrame();if(typeof e.fromFrame!="undefined"){l=e.fromFrame}var n=this.editor.graphic.getCurrentFrame();if(typeof e.toFrame!="undefined"){n=e.toFrame}var h=".bin";if(o=="c64"){h=".prg"}var d=t.getTileSet();var c=d.getTileCount();var f=e.exportMapData;var u=e.exportColorData;var p=e.exportTileData;var v=e.exportTileAttributeData;var g=new JSZip;var m=this.editor.graphic.getFrameCount();var y=t.getGridHeight();var b=t.getGridWidth();this.mostUsedCharacters=[];this.charsetMap=[];for(var C=0;C<c;C++){this.mostUsedCharacters.push({c:C,timesUsed:0});this.charsetMap[C]=0}if(a&&!r){var x=false;for(var S=l-1;S<n;S++){if(S>=m){break}var P=t.getFrameData(S).data;for(var w=0;w<y;w++){for(var I=0;I<b;I++){var k=P[w][I].t;if(k>=64){x=true}if(k<this.mostUsedCharacters.length){this.mostUsedCharacters[k].timesUsed++}}}}this.mostUsedCharacters.sort(function(e,t){return t.timesUsed-e.timesUsed});if(x){for(var C=0;C<64;C++){if(C<this.mostUsedCharacters.length){var M=this.mostUsedCharacters[C].c;this.charsetMap[M]=C}}}else{for(var C=0;C<c;C++){this.mostUsedCharacters[C]={c:C,timesUsed:0};this.charsetMap[C]=C}}this.getExtendedColorBGColors({layer:t,fromFrame:l,toFrame:n,gridWidth:b,gridHeight:y})}for(var S=l-1;S<n;S++){if(S>=m){break}var P=t.getFrameData(S).data;if(a&&!r){}var T=[];var D=[];var E=0;if(e.format=="mz80a"){T[E++]=1;T[E++]=77;T[E++]=90;T[E++]=32;T[E++]=70;T[E++]=73;T[E++]=76;T[E++]=69;T[E++]=78;T[E++]=65;T[E++]=77;T[E++]=69;T[E++]=13;T[E++]=13;T[E++]=13;T[E++]=13;T[E++]=13;T[E++]=13;T[E++]=232;T[E++]=3;T[E++]=0;T[E++]=208;T[E++]=0;T[E++]=0;for(var C=0;C<104;C++){T[E++]=0}}if(e.format=="c64"){T[E]=0;D[E]=0;E++;T[E]=4;D[E]=216;E++}var $=this.editor.frames.height-1;var _=-1;var B=-1;for(var w=0;w<y;w++){for(var I=0;I<b;I++){var R=P[w][I].t;var A=P[w][I].bc;if(a){if(!r){A=this.extendedColorBGColors.indexOf(A);if(A<0||A>3){A=0}}if(!r){if(R<this.charsetMap.length){R=this.charsetMap[R]}}R=R&63;switch(A){case 1:R=R|64;break;case 2:R=R|128;break;case 3:R=R|192;break}}T[E]=R&255;if(o=="mz700"){var F=P[w][I].fc&7;var A=P[w][I].bc;if(A===this.editor.colorPaletteManager.noColor){A=t.getBackgroundColor(S)}A=A&7;D[E]=A|F<<4;if(P[w][I].t>=256){D[E]=D[E]|128}}else{D[E]=P[w][I].fc}E++}}var L=S+1;var U=t.getLabel();if(f){var H=new Uint8Array(T.length);for(var C=0;C<T.length;C++){H[C]=T[C]}g.file("ScreenCharacterData_"+U+"_Frame_"+L+h,H)}if(u){var O=new Uint8Array(D.length);for(var C=0;C<D.length;C++){O[C]=D[C]}g.file("ScreenColorData_"+U+"_Frame_"+L+h,O)}}if(p){var G=[];var z=this.editor.tileSetManager;var d=z.getCurrentTileSet();var N=d.getTileWidth();var W=d.getTileHeight();E=0;if(e.format=="c64"){G[E++]=0;G[E++]=56}for(var C=0;C<d.tileCount;C++){var M=C;if(a&&!r){M=M&63;if(M<this.mostUsedCharacters.length){M=this.mostUsedCharacters[M].c}}for(var w=0;w<W;w++){var X=0;for(var I=0;I<N;I++){if(d.getPixel(M,I,w)){X=X|1<<7-I}}G[E++]=X}}var Y=new Uint8Array(G.length);for(var C=0;C<G.length;C++){Y[C]=G[C]}g.file("TileSetData"+h,Y)}if(v){var V=[];var z=this.editor.tileSetManager;var d=z.getCurrentTileSet();var N=d.getTileWidth();var W=d.getTileHeight();for(var C=0;C<d.tileCount;C++){var q=d.getTileColor(C)&15;var j=d.getTileMaterial(C)&15;var K=q+(j<<4);V.push(K)}var Z=new Uint8Array(V.length);for(var C=0;C<V.length;C++){Z[C]=V[C]}h=".bin";g.file("TileSetAttributeData"+h,Z)}g.generateAsync({type:"blob"}).then(function(e){download(e,s+".zip","application/zip")})},exportBinaryData:function(){var e={};e.filename=$("#exportBinaryAs").val();e.format=$("input[name=exportBinaryFormat]:checked").val();e.colorMode=$("input[name=exportBinaryColorMode]:checked").val();e.exportMapData=$("#exportBinaryCharacterData").is(":checked");e.exportColorData=$("#exportBinaryColorData").is(":checked");e.exportTileData=$("#exportBinaryCharactersetData").is(":checked");e.exportTileAttributeData=$("#exportBinaryCharacterAttributeData").is(":checked");e.fromFrame=parseInt($("#exportBinaryFromFrame").val(),10);e.toFrame=parseInt($("#exportBinaryToFrame").val(),10);e.layer=$("input[name=exportBinaryLayer]:checked").val();this.exportBinaryDataAs(e)}};var ExportSpriteBinaryData=function(){this.editor=null};ExportSpriteBinaryData.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){var e=420;var i=380;this.uiComponent=UI.create("UI.Dialog",{id:"exportSpriteBinaryDataDialog",title:"Export Sprite Binary Data",width:e,height:i});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportSpriteBinaryData.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportSpriteBinaryData();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportSpriteBinaryDataDialog")},initContent:function(){$("#exportSpriteBinaryAs").val(g_app.fileManager.filename);var e=this.editor.graphic.getFrameCount();$("#exportSpriteBinaryToFrame").val(e);$("#exportSpriteBinaryFromFrame").val(1);$("#exportSpriteBinaryFromFrame").attr("max",e);$("#exportSpriteBinaryToFrame").attr("max",e)},initEvents:function(){var e=this},exportBinaryDataAsMega65:function(e){var t=this.editor.layers.getSelectedLayerObject();var i=t.getScreenMode();var r=g_app.fileManager.filename;if(typeof e.filename!="undefined"){r=e.filename}var a=this.editor.graphic.getCurrentFrame();if(typeof e.fromFrame!="undefined"){a=e.fromFrame}var s=this.editor.graphic.getCurrentFrame();if(typeof e.toFrame!="undefined"){s=e.toFrame}var o="mega65";if(typeof e.format!="undefined"){o=e.format}var l=".bin";if(o=="c64"){l=".prg"}var n=t.getTileSet();var h=n.getTileCount();var d=n.getTileWidth();var c=n.getTileHeight();var f=e.exportMapData;var u=e.exportColorData;var p=true;var v=true;var g=new JSZip;var m=this.editor.graphic.getFrameCount();var y=t.getGridHeight();var b=t.getGridWidth();var C=1;var x=t.getLabel();var m=this.editor.graphic.getFrameCount();var S=[];if(p){var P=h*c*d;P=P/2;var S=new Uint8Array(m*c*d);var w=0;for(var I=0;I<m;I++){var k=0;var M=0;var T=t.getCell({x:k,y:M,frame:I});var D=T.t;for(var E=0;E<c;E++){for(var $=0;$<d;$++){var _=n.getPixel(D,$,E)&15;if($%2){S[w]=S[w]|_;w++}else{S[w]=_<<4}}}}g.file("SpriteData_"+x+l,S)}if(v){var B=new Uint8Array(255*3);var R=[];var A=[];var F=[];var L=t.getColorPalette();var U=L.getColorCount();for(var H=0;H<255;H++){if(H<U){var O=L.getRGBA(H);O[0]=O[0]&255;var G=(O[0]&240)>>4;var z=O[0]&15;if(z>7){z=7}G+=z<<4;R.push(G);G=((O[1]&240)>>4)+((O[1]&15)<<4);A.push(G);G=((O[2]&240)>>4)+((O[2]&15)<<4);F.push(G)}else{R.push(0);A.push(0);F.push(0)}}var w=0;for(var H=0;H<256;H++){B[w++]=R[H]}for(var H=0;H<256;H++){B[w++]=A[H]}for(var H=0;H<256;H++){B[w++]=F[H]}g.file("PaletteData_"+x+"_Frame_"+C+l,B)}g.generateAsync({type:"blob"}).then(function(e){download(e,r+".zip","application/zip")})},exportBinaryDataAsC64:function(e){var t=g_app.fileManager.filename;if(typeof e.filename!="undefined"){t=e.filename}var i=this.editor.graphic;var r=this.editor.layers.getLayers();var a=r.length;var s=e.fromFrame-1;var o=e.toFrame;if(o>i.getFrameCount()){o=i.getFrameCount()}var l=e.numberFormat;if(l=="bin"){columns=3}var n="c64";if(typeof e.type!="undefined"){n=e.type}var h=0;var d=[];for(var c=s;c<o;c++){for(var f=0;f<a;f++){var u=this.editor.layers.getLayerObjectFromIndex(f);if(u&&u.getType()=="grid"){var p=u.getScreenMode();var v=u.getTileSet();var g=u.getGridWidth();var m=u.getGridHeight();var y=v.getTileWidth();var b=v.getTileHeight();for(var C=0;C<m;C++){for(var x=0;x<g;x++){var S=0;var P=8;if(n=="fcm"){P=y}var w=Math.ceil(y/P);var I=u.getCell({x:x,y:C,frame:c});var k=I.t;var M=I.fc;if(k!==false){h++;for(var T=0;T<b;T++){for(var D=0;D<w;D++){if(n=="fcm"){for(var E=0;E<P;E+=2){var $=D*8+E;var _=v.getPixel(k,$,T)&15;var B=v.getPixel(k,$+1,T)&15;R=_<<4&240;R+=B&15;d.push(R)}}else{var R=0;for(var E=0;E<8;E++){var $=D*8+E;if(v.getPixel(k,$,T)){R=R|1<<7-E}}d.push(R)}}}if(n=="c64"){var R=M;if(u.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){R|=128}d.push(R)}}}}}}}var A=new Uint8Array(d.length);for(var F=0;F<d.length;F++){A[F]=d[F]}download(A,t+".bin","application/bin")},exportBinaryDataAs:function(e){console.log("export binary data");console.log(e);var t=this.editor.layers.getSelectedLayerObject();var i=t.getScreenMode();var r=i===TextModeEditor.Mode.C64ECM;var a=false;if(typeof e.colorMode){a=e.colorMode=="ecm"}if(!t&&t.getType()!="grid"){return}var s=g_app.fileManager.filename;if(typeof e.filename!="undefined"){s=e.filename}var o="binary";if(typeof e.format!="undefined"){o=e.format}if(o=="mega65"){this.exportBinaryDataAsMega65(e);return}if(o=="c64"){this.exportBinaryDataAsC64(e)}},exportSpriteBinaryData:function(){var e={};e.filename=$("#exportSpriteBinaryAs").val();e.format=$("input[name=exportSpriteBinaryFormat]:checked").val();e.fromFrame=parseInt($("#exportSpriteBinaryFromFrame").val(),10);e.toFrame=parseInt($("#exportSpriteBinaryToFrame").val(),10);e.layer=$("input[name=exportSpriteBinaryLayer]:checked").val();this.exportBinaryDataAs(e)}};var ExportC64Assembly=function(){this.editor=null;this.asmEditor=null;this.lineEnding="\r\n";this.columns=16};ExportC64Assembly.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportC64AssemblyDialog",title:"Export Assembly",width:980,height:640});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportC64Assembly.html",function(){t.initContent();t.initEvents()});this.htmlComponent.on("resize",function(){if(t.asmEditor&&t.asmEditor.resize){t.asmEditor.resize()}});this.displayButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"/> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.displayButton);this.displayButton.on("click",function(e){t.copyToClipboard()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportC64AssemblyDialog")},toHex:function(e){return("0000"+e.toString(16)).substr(-4)},initContent:function(){if(this.asmEditor==null){this.asmEditor=ace.edit("exportC64AssemblySource");this.asmEditor.getSession().setTabSize(2);this.asmEditor.getSession().setUseSoftTabs(true);this.asmEditor.on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});this.asmEditor.on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});var e="ace/mode/assembly_6502";if(this.mode=="javascript"){e="ace/mode/javascript"}this.asmEditor.getSession().setMode(e);this.asmEditor.setShowInvisibles(false)}this.colorPerMode=this.editor.getColorPerMode();this.blockModeEnabled=this.editor.getBlockModeEnabled();$("#exportC64AssemblyAs").val(g_app.fileManager.filename);var t=this.editor.graphic.getFrameCount();$("#exportC64AssemblyToFrame").val(t);$("#exportC64AssemblyFromFrame").val(1);$("#exportC64AssemblyFromFrame").attr("max",t);$("#exportC64AssemblyToFrame").attr("max",t);switch(this.colorPerMode){case"character":$("#exportC64AssemblyColorDataHolder").show();$("#exportC64AssemblyMapColorData").hide();break;case"cell":$("#exportC64AssemblyColorDataHolder").show();$("#exportC64AssemblyMapColorData").show();break;case"block":$("#exportC64AssemblyColorDataHolder").show();$("#exportC64AssemblyMapColorData").hide();break}if(this.blockModeEnabled){$("#exportC64AssemblyBlockMapDataHolder").show();if(this.colorPerMode=="block"){$("#exportC64AssemblyBlockColorDataHolder").show()}else{$("#exportC64AssemblyBlockColorDataHolder").hide()}$("#exportC64AssemblyMapData").prop("checked",false);$("#exportC64MetaTileIndexSettings").show()}else{$("#exportC64AssemblyBlockMapDataHolder").hide();$("#exportC64AssemblyBlockColorDataHolder").hide();$("#exportC64AssemblyBlockDataHolder").hide();$("#exportC64MetaTileIndexSettings").hide()}this.exportC64Assembly({displayOnly:true})},initEvents:function(){var e=this;$("input[name=exportC64AssemblyFormat]").on("click",function(){e.exportC64Assembly({displayOnly:true})});$("input[name=exportC64NumberFormat]").on("click",function(){e.exportC64Assembly({displayOnly:true})});$("input[name=exportC64TileIndexSize]").on("click",function(){e.exportC64Assembly({displayOnly:true})});$("input[name=exportC64MetaTileIndexSize]").on("click",function(){e.exportC64Assembly({displayOnly:true})});$(".exportC64AssemblyInclude").on("click",function(){e.exportC64Assembly({displayOnly:true})});$("#exportC64AssemblyFromFrame").on("change",function(){e.exportC64Assembly({displayOnly:true})});$("#exportC64AssemblyToFrame").on("change",function(){e.exportC64Assembly({displayOnly:true})});$("#exportC64AssemblyDownload").on("click",function(){e.download()})},copyToClipboard:function(){var e=this.asmEditor.selection.toJSON();this.asmEditor.selectAll();this.asmEditor.focus();document.execCommand("copy");this.asmEditor.selection.fromJSON(e)},getByteLabel:function(e){var t="!byte ";if(e.format=="kickass"||e.format=="ca65"||e.format=="tass"){t=".byte "}if(e.format=="acme"){t="!byte "}return t},getWordLabel:function(e){var t="!word ";if(e.format=="kickass"||e.format=="ca65"||e.format=="tass"){t=".word "}if(e.format=="acme"){t="!word "}return t},getCommentSymbol:function(e){var t=";";if(e.format=="kickass"){t="//"}return t},getConstSymbol:function(e){var t="";if(e.format=="kickass"){t=".label "}return t},getSetPCSymbol:function(e){var t="* = ";if(e.format=="ca65"){t=".ORG "}return t},getLabelPostfix:function(e){var t="";if(e.format=="kickass"||e.format=="ca65"){t=":"}return t},getBlockMapData:function(e,t){var i=false;if(typeof e.selection!="undefined"){i=e.selection}var r=this.editor.layers.getSelectedLayerObject();var a=1;var s=1;if(typeof e!="undefined"){if(typeof e.fromFrame!="undefined"){a=e.fromFrame}if(typeof e.toFrame!="undefined"){s=e.toFrame}}var o=e.numberFormat!="dec";var l=r.getTileSet();var n=l.getTileCount();var h=n*8;var d=r.getGridWidth();var c=r.getGridHeight();var f=this.editor.tools.drawTools;var u=f.select.selection.minX;var p=f.select.selection.minY;var v=f.select.selectionOffsetX;var g=f.select.selectionOffsetY;var m=f.select.selection.maxX-f.select.selection.minX;var y=f.select.selection.maxY-f.select.selection.minY;if(i){d=m;c=y}var b=this.editor.blockSetManager.getCurrentBlockSet();var C=0;var x=0;var S=0;if(b){C=b.getBlockCount();x=r.getBlockWidth();S=r.getBlockHeight()}var P=C*x*S;var w=this.getByteLabel(e);var I=this.getWordLabel(e);var k="text";if(typeof t!="undefined"){k=t}var M="";var T=[];var D=0;for(var E=a-1;E<s;E++){var $=0;if(E>=r.getFrameCount()){break}var D=0;$=0;var _=0;var B=c;var R=S;var A=x;if(i){_=p;B=f.select.selection.maxY}for(var F=_;F<B;F+=R){var L=0;var U=d;if(i){L=u;U=f.select.selection.maxX}for(var H=L;H<U;H+=A){var O=r.getCell({x:H,y:F,frame:E});var G=O.b;if(typeof G=="undefined"){G=0}if(e.hi_byte){G=G>>8&255}else if(e.metaTileIndexSize=="16word"){G=G&65535}else{G=G&255}if(k=="text"){if($!==0){M+=","}else{if(e.metaTileIndexSize=="16word"){M+=I}else{M+=w}}if(o){M+="$";if(e.metaTileIndexSize=="16word"){M+=("0000"+G.toString(16)).substr(-4)}else{M+=("00"+G.toString(16)).substr(-2)}}else{M+=G.toString(10)}$++;if($==this.columns){$=0;M+=this.lineEnding}}if(k=="binary"){T[D]=G}D++}}M+=this.lineEnding+this.lineEnding;var z=E+1}if(k=="text"){return M}if(k=="binary"){return new Uint8Array(T)}},getBlockSetData:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=i.getTileSet();var a=r.getTileCount();var s=a*8;var o=this.editor.blockSetManager.getCurrentBlockSet();var l=0;var n=0;var h=0;if(o){l=o.getBlockCount();n=i.getBlockWidth();h=i.getBlockHeight()}var d=l*n*h;var c=e.numberFormat!="dec";var f=i.getScreenMode();var u=f===TextModeEditor.Mode.C64ECM;var p=i.getColorPerMode();var v=this.getByteLabel(e);var g=this.getWordLabel(e);var m="text";if(typeof t!="undefined"){m=t}var y="";var b=0;var C=[];var b=0;var x=0;for(var S=0;S<l;S++){for(var P=0;P<h;P++){for(var w=0;w<n;w++){var I=o.getCharacterInBlock(S,w,P);if(u){var k=o.getBlockBGColor(S);if(p=="character"){k=r.getTileBGColor(I);if(k!==this.editor.colorPaletteManager.noColor){k=k&15}}I=I&255;if(k!==this.editor.colorPaletteManager.noColor){I=I&63;switch(k){case 1:I=I|64;break;case 2:I=I|128;break;case 3:I=I|192;break}}}if(e.hi_byte){I=I>>8&255}else if(e.tileIndexSize=="16word"){I=I&65535}else{I=I&255}if(m=="text"){if(b!==0){y+=","}else{if(e.tileIndexSize=="16word"){y+=g}else{y+=v}}if(c){y+="$";if(e.tileIndexSize=="16word"){y+=("0000"+I.toString(16)).substr(-4)}else{y+=("00"+I.toString(16)).substr(-2)}}else{y+=I.toString(10)}b++;if(b==this.columns){b=0;y+=this.lineEnding}}if(m=="binary"){C[x]=I}x++}}}if(m=="text"){return y}if(m=="binary"){return new Uint8Array(C)}},getBlockColorData:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=i.getTileSet();var a=r.getTileCount();var s=a*8;var o=this.editor.blockSetManager.getCurrentBlockSet();var l=0;var n=0;var h=0;if(o){l=o.getBlockCount();n=i.getBlockWidth();h=i.getBlockHeight()}var d=l*n*h;var c=e.numberFormat!="dec";var f=this.getByteLabel(e);var u="text";if(typeof t!="undefined"){u=t}var p="";var v=0;var g=[];var v=0;var m=0;for(var y=0;y<l;y++){var b=o.getBlockColor(y);if(u=="text"){if(v!==0){p+=","}else{p+=f}if(c){p+="$";p+=("00"+b.toString(16)).substr(-2)}else{p+=b.toString(10)}v++;if(v==this.columns){v=0;p+=this.lineEnding}}if(u=="binary"){g[m]=b}m++}if(u=="text"){return p}if(u=="binary"){return new Uint8Array(g)}},getLayerFromPath:function(e){var t=false;var i=g_app.doc.getDocRecord(e.path);if(i){if(typeof e.layerId==="undefined"){var r=i.data.layers;console.log(r);if(r.length>0){t=r[0].layerId}}layer=new LayerGrid;layer.connectToDoc({editor:this.editor,doc:i,layerId:t});console.log(layer);console.log("layer id = "+t)}},getCharMapData:function(e,t){var i=false;if(typeof e.selection!="undefined"){i=e.selection}var r=null;if(typeof e!=="undefined"){if(typeof e.path!=="undefined"){r=this.getLayerFromPath(e)}}if(r===null){r=this.editor.layers.getSelectedLayerObject()}if(r.getType()!=="grid"){return}var a=r.getScreenMode();var s=a===TextModeEditor.Mode.C64ECM;var o=r.getColorPerMode();var l=this.getByteLabel(e);var n=this.getWordLabel(e);var h="text";if(typeof t!="undefined"){h=t}var d=e.numberFormat!="dec";var c=e.tileIndexSize;var f="";var u=0;var p=[];var v=r.getGridWidth();var g=r.getGridHeight();var m=this.editor.tools.drawTools;var y=m.select.selection.minX;var b=m.select.selection.minY;var C=m.select.selectionOffsetX;var x=m.select.selectionOffsetY;var S=m.select.selection.maxX-m.select.selection.minX;var P=m.select.selection.maxY-m.select.selection.minY;if(i){v=S;g=P}var w=r.getTileSet();var I=1;var k=1;if(typeof e!="undefined"){if(typeof e.fromFrame!="undefined"){I=e.fromFrame}if(typeof e.toFrame!="undefined"){k=e.toFrame}}for(var M=I-1;M<k;M++){if(M>=r.getFrameCount()){break}var T=0;u=0;var D=0;var E=g;var $=1;if(i){D=b;E=m.select.selection.maxY}for(var _=D;_!=E;_+=$){var B=0;var R=v;if(i){B=y;R=m.select.selection.maxX}for(var A=B;A<R;A++){var F=r.getCell({x:A,y:_,frame:M});var L=F.t;if(s){var U=F.bc;if(o=="character"){U=w.getTileBGColor(L);if(U!==this.editor.colorPaletteManager.noColor){U=U&15}}if(U!==this.editor.colorPaletteManager.noColor){L=L&63;switch(U){case 1:L=L|64;break;case 2:L=L|128;break;case 3:L=L|192;break}}}if(e.hi_byte){L=L>>8&255}else if(e.tileIndexSize=="16word"){L=L&65535}else{L=L&255}if(h=="text"){if(u!==0){f+=","}else{if(e.tileIndexSize=="16word"){f+=n}else{f+=l}}if(d){f+="$";if(e.tileIndexSize=="16word"){f+=("0000"+L.toString(16)).substr(-4)}else{f+=("00"+L.toString(16)).substr(-2)}}else{f+=L.toString(10)}u++;if(u==this.columns){u=0;f+=this.lineEnding}}if(h=="binary"){p[T]=L}T++}}if(h=="text"){f+=this.lineEnding+this.lineEnding}}if(h=="text"){return f}if(h=="binary"){return new Uint8Array(p)}},exportC64Format:function(e){var t=16;this.columns=16;var i=".txt";var r=true;var a=true;var s=true;var o=true;var l=false;var n=true;var h=false;var d=false;if(typeof e.exportTileSet!="undefined"){r=e.exportTileSet}if(typeof e.exportCharacterColorData!="undefined"){a=e.exportCharacterColorData}if(typeof e.exportBlockData!="undefined"){s=e.exportBlockData}if(typeof e.exportBlockColorData!="undefined"){n=e.exportBlockColorData}if(typeof e.exportBlockMap!="undefined"){o=e.exportBlockMap}if(typeof e.exportCharMap!="undefined"){l=e.exportCharMap}if(typeof e.exportCharMapColorData!="undefined"){h=e.exportCharMapColorData}if(typeof e.selection!="undefined"){d=e.selection}var c="\r\n";var f=this.getByteLabel(e);var u=this.getCommentSymbol(e);var p=this.getConstSymbol(e);var v=this.getLabelPostfix(e);var g=this.getSetPCSymbol(e);var m="";var y=this.editor.tileSetManager;var b=this.editor.layers.getSelectedLayerObject();if(b&&b.getType()=="grid"){var C=b.getScreenMode();var x=C===TextModeEditor.Mode.C64ECM;if(!b.getBlockModeEnabled()){o=false}var S=b.getGridWidth();var P=b.getGridHeight();var w=this.editor.tools.drawTools;var I=w.select.selection.minX;var k=w.select.selection.minY;var M=w.select.selectionOffsetX;var T=w.select.selectionOffsetY;var D=w.select.selection.maxX-this.editor.tools.drawTools.select.selection.minX;var E=w.select.selection.maxY-this.editor.tools.drawTools.select.selection.minY;if(d){S=D;P=E}var $=b.getTileSet();var _=$.getTileCount();var B=_*8;var R=this.editor.blockSetManager.getCurrentBlockSet();var A=0;var F=0;var L=0;var U=e.numberFormat!="dec";if(R){A=R.getBlockCount();F=b.getBlockWidth();L=b.getBlockHeight()}var H=A*F*L;var O=b.getBackgroundColor();var G=b.getBorderColor();m+=p+"SCREEN_BORDER_COLOUR = "+G+c;if(e.screenMode===TextModeEditor.Mode.C64MULTICOLOR){m+=p+"SCREEN_BACKGROUND_COLOUR = "+O+c;var z=b.getC64Multi1Color();var N=b.getC64Multi2Color();m+=p+"CHAR_MULTICOLOUR_MODE = 1"+c;m+=p+"COLOUR_CHAR_MC1 = "+z+c;m+=p+"COLOUR_CHAR_MC2 = "+N+c}else if(e.screenMode==TextModeEditor.Mode.C64ECM){m+=p+"SCREEN_BACKGROUND_COLOUR1 = "+O+c;var W=b.getC64ECMColor(1);m+=p+"SCREEN_BACKGROUND_COLOUR2 = "+W+c;var X=b.getC64ECMColor(2);m+=p+"SCREEN_BACKGROUND_COLOUR3 = "+X+c;var Y=b.getC64ECMColor(3);m+=p+"SCREEN_BACKGROUND_COLOUR4 = "+Y+c}else{m+=p+"SCREEN_BACKGROUND_COLOUR = "+O+c;m+=p+"CHAR_MULTICOLOUR_MODE = 0"+c}if(r){m+=p+"CHAR_COUNT = "+_+c}if(s){m+=p+"TILE_COUNT = "+A+c;m+=p+"TILE_WIDTH = "+F+c;m+=p+"TILE_HEIGHT = "+L+c}var V=0;var q=0;if(o&&F!=0&&L!=0){V=Math.ceil(S/F);q=Math.ceil(P/L);m+=p+"MAP_WID = "+V+c;m+=p+"MAP_HEI = "+q+c}var j=V*q;var K=S*P;var Z=K;if(e.tileIndexSize=="16word"){K*=2}if(e.metaTileIndexSize=="16word"){j*=2}if(o||l){var J=S;var Q=P;var ee=J*8;var te=Q*8;m+=p+"MAP_WID_CHRS = "+J+c;m+=p+"MAP_HEI_CHRS = "+Q+c;m+=p+"MAP_WID_PXLS = "+ee+c;m+=p+"MAP_HEI_PXLS = "+te+c}m+=c+c;m+=u+" Data block size constants:-"+c;if(r){m+=p+"SZ_CHARSET_DATA         = "+B+c}if(a){m+=p+"SZ_CHARSET_ATTRIB_DATA  = "+_+c}if(n){m+=p+"SZ_TILESET_ATTRIB_DATA  = "+A+c}if(s){m+=p+"SZ_TILESET_DATA         = "+H+c}if(o){if(e.metaTileIndexSize=="16split"){m+=p+"SZ_TILE_MAP_DATA_LO        = "+j+c;m+=p+"SZ_TILE_MAP_DATA_HI        = "+j+c}else{m+=p+"SZ_TILE_MAP_DATA        = "+j+c}}if(l){if(e.tileIndexSize=="16split"){m+=p+"SZ_CHAR_MAP_DATA_LO        = "+K+c;m+=p+"SZ_CHAR_MAP_DATA_HI        = "+K+c}else{m+=p+"SZ_CHAR_MAP_DATA        = "+K+c}}if(h){m+=p+"SZ_CHAR_MAP_COLOUR_DATA = "+Z+c}m+=c+c;m+=u+" Data block address constants (dummy values):-"+c;var ie=4096;if(r){m+=p+"ADDR_CHARSET_DATA          = $"+this.toHex(ie)+"   "+u+" label = 'charset_data'        (size = $"+this.toHex(B)+"). "+c;ie+=B}if(a){m+=p+"ADDR_CHARSET_ATTRIB_DATA   = $"+this.toHex(ie)+"   "+u+" label = 'charset_attrib_data' (size = $"+this.toHex(_)+")."+c;ie+=_}if(n){m+=p+"ADDR_TILESET_ATTRIB_DATA             = $"+this.toHex(ie)+"   "+u+" label = 'tileset_attrib_data'        (size = $"+this.toHex(H)+")."+c;ie+=H}if(s){m+=p+"ADDR_TILESET_DATA             = $"+this.toHex(ie)+"   "+u+" label = 'tileset_data'        (size = $"+this.toHex(H)+")."+c;ie+=H}if(o){if(e.metaTileIndexSize=="16split"){m+=p+"ADDR_TILE_MAP_DATA_LO         = $"+this.toHex(ie)+"   "+u+" label = 'tile_map_data'            (size = $"+this.toHex(j)+")."+c;ie+=j;m+=p+"ADDR_TILE_MAP_DATA_HI         = $"+this.toHex(ie)+"   "+u+" label = 'tile_map_data'            (size = $"+this.toHex(j)+")."+c;ie+=j}else{m+=p+"ADDR_TILE_MAP_DATA         = $"+this.toHex(ie)+"   "+u+" label = 'tile_map_data'            (size = $"+this.toHex(j)+")."+c;ie+=j}}if(l){if(e.tileIndexSize=="16split"){m+=p+"ADDR_CHAR_MAP_DATA_LO         = $"+this.toHex(ie)+"   "+u+" label = 'map_data'            (size = $"+this.toHex(K)+")."+c;ie+=K;m+=p+"ADDR_CHAR_MAP_DATA_HI         = $"+this.toHex(ie)+"   "+u+" label = 'map_data'            (size = $"+this.toHex(K)+")."+c;ie+=K}else{m+=p+"ADDR_CHAR_MAP_DATA         = $"+this.toHex(ie)+"   "+u+" label = 'map_data'            (size = $"+this.toHex(K)+")."+c;ie+=K}}if(h){m+=p+"ADDR_CHAR_MAP_COLOUR_DATA  = $"+this.toHex(ie)+"   "+u+" label = 'map_colour_data'     (size = $"+this.toHex(K)+")."+c;ie+=Z}m+="\n\n";if(r){m+=u+" CHAR SET DATA : "+_+" (8 byte) chars : total size is "+B+" ($"+this.toHex(B)+") bytes."+c;m+=c;m+=g+" ADDR_CHARSET_DATA";if(e.format=="kickass"){m+=' "charset_data"'}m+=c;m+="charset_data"+v+c;m+=c;var re=[];Pe=0;var ae=0;for(var se=0;se<$.tileCount;se++){var oe=se;for(var le=0;le<8;le++){var ne=0;for(var he=0;he<8;he++){if($.getPixel(oe,he,le)){ne=ne|1<<7-he}}if(ae!==0){m+=","}else{m+=f}if(U){m+="$";m+=("00"+ne.toString(16)).substr(-2)}else{m+=ne.toString(10)}ae++;if(ae==t){ae=0;m+=c}}}m+=c+c}if(a){var de="";var _=$.getTileCount();de+=u+" CHAR SET ATTRIBUTE DATA : "+_+" attributes : total size is "+_+" ($"+this.toHex(_)+") bytes."+c;de+=u+" nb. Upper nybbles = Material, Lower nybbles = Colour."+c;de+=c;de+=g+" ADDR_CHARSET_ATTRIB_DATA";if(e.format=="kickass"){de+=' "charset_attrib_data"'}de+=c;de+="charset_attrib_data"+v+c;de+=c;var ae=0;for(var se=0;se<$.tileCount;se++){var ce=$.getTileColor(se)&15;var fe=$.getTileMaterial(se)&15;if(ae!==0){de+=","}else{de+=f}var ue=ce+(fe<<4);if(U){de+="$";de+=("00"+ue.toString(16)).substr(-2)}else{de+=ue.toString(10)}ae++;if(ae==t){ae=0;de+=c}}m+=de;m+=c+c}if(s){var pe="";pe+=u+" TILE SET DATA : "+A+" ("+F+"x"+L+") tiles : total size is "+H+" ($"+this.toHex(H)+") bytes."+c;pe+=c;pe+=g+" ADDR_TILESET_DATA";var ve="tileset_data";if(e.tileIndexSize=="16split"){ve="tileset_data_lo"}if(e.format=="kickass"){pe+=' "'+ve+'"'}pe+=c;pe+=ve+v+c;pe+=c;e.hi_byte=false;pe+=this.getBlockSetData(e);if(e.tileIndexSize=="16split"){pe+=c;ve="tileset_data_hi";if(e.format=="kickass"){pe+=' "'+ve+'"'}pe+=c;pe+=ve+v+c;pe+=c;e.hi_byte=true;pe+=this.getBlockSetData(e)}m+=pe;m+=c+c}if(n){var ge="";var me=A;var ye=("0000"+me.toString(16)).substr(-4);ge+=u+" TILE SET ATTRIBUTE DATA : "+A+" attributes : total size is "+me+" ($"+ye+") bytes."+c;ge+=u+" nb. Upper nybbles = Material, Lower nybbles = Colour."+c;ge+=c;ge+=g+" ADDR_TILESET_ATTRIB_DATA";if(e.format=="kickass"){ge+=' "tileset_attrib_data"'}ge+=c;ge+="tileset_attrib_data"+v+c;ge+=c;ge+=this.getBlockColorData(e);m+=ge;m+=c+c}if(o){var be="";var Ce=("0000"+j.toString(16)).substr(-4);var ae=0;be+=u+" MAP DATA : 1 ("+V+"x"+q+") map : total size is "+j+" ($"+Ce+") bytes."+c;be+=c;var xe="tile_map_data";if(e.metaTileIndexSize=="16split"){xe="tile_map_data_lo";be+=g+" ADDR_TILE_MAP_DATA_LO"}else{be+=g+" ADDR_TILE_MAP_DATA"}if(e.format=="kickass"){be+=' "'+xe+'"'}be+=c;be+=xe+v+c;be+=c;e.hi_byte=false;be+=this.getBlockMapData(e);if(e.metaTileIndexSize=="16split"){be+=g+" ADDR_TILE_MAP_DATA_HI";xe="tile_map_data_hi";if(e.format=="kickass"){be+=' "'+xe+'"'}be+=c;be+=xe+v+c;be+=c;e.hi_byte=true;be+=this.getBlockMapData(e)}m+=be;m+=c+c}if(l){var ae=0;m+=u+" MAP DATA : 1 ("+S+"x"+P+") map : total size is "+K+" ($"+this.toHex(K)+") bytes."+c;m+=c;var xe="map_data";if(e.tileIndexSize=="16split"){xe="map_data_lo";m+=g+" ADDR_CHAR_MAP_DATA_LO"}else{m+=g+" ADDR_CHAR_MAP_DATA"}if(e.format=="kickass"){m+=' "'+xe+'"'}m+=c;m+=xe+v+c;m+=c;e.hi_byte=false;m+=this.getCharMapData(e);if(e.tileIndexSize=="16split"){m+=g+" ADDR_CHAR_MAP_DATA_HI";xe="map_data_hi";if(e.format=="kickass"){m+=' "'+xe+'"'}m+=c;m+=xe+v+c;m+=c;e.hi_byte=true;m+=this.getCharMapData(e)}}if(h){var ae=0;m+=u+"  MAP COLOUR DATA : 1 ("+S+"x"+P+") map : total size is "+Z+" ($"+this.toHex(Z)+") bytes."+c;m+=c;m+=g+" ADDR_CHAR_MAP_COLOUR_DATA";if(e.format=="kickass"){m+=' "map_colour_data"'}m+=c;m+="map_colour_data"+v+c;m+=c;for(var Se=e.fromFrame-1;Se<e.toFrame;Se++){if(Se>=this.editor.graphic.getFrameCount()){break}var Pe=0;ae=0;var we=0;var Ie=P;var ke=1;if(d){we=k;Ie=w.select.selection.maxY}for(var le=we;le!=Ie;le+=ke){var Me=0;var Te=S;if(d){Me=I;Te=w.select.selection.maxX}for(var he=Me;he<Te;he++){var De=b.getCell({x:he,y:le,frame:Se});if(ae!==0){m+=","}else{m+=f}if(U){m+="$";m+=("00"+De.fc.toString(16)).substr(-2)}else{m+=De.fc.toString(10)}ae++;if(ae==t){ae=0;m+=c}Pe++}}m+=c+c}}}if(typeof e.displayOnly!="undefined"&&e.displayOnly){this.asmEditor.setValue(m,-1)}else{download(m,e.filename+".txt","application/txt")}},exportC64AssemblyAs:function(e){if(typeof e.filename=="undefined"){e.filename=g_app.fileManager.filename}if(typeof e.format=="undefined"){e.format="binary"}if(typeof e.layer=="undefined"){e.layer="current"}var t=this.editor.graphic.getCurrentFrame();if(typeof e.fromFrame=="undefined"){e.fromFrame=t}if(typeof e.toFrame=="undefined"){e.toFrame=t}this.exportC64Format(e)},download:function(){var e=$("#exportC64AssemblyAs").val();e+=".txt";var t=this.asmEditor.getValue();download(t,e,"application/txt")},exportC64Assembly:function(e){e.filename=$("#exportC64AssemblyAs").val();e.format=$("input[name=exportC64AssemblyFormat]:checked").val();e.numberFormat=$("input[name=exportC64NumberFormat]:checked").val();e.tileIndexSize=$("input[name=exportC64TileIndexSize]:checked").val();e.metaTileIndexSize=$("input[name=exportC64MetaTileIndexSize]:checked").val();e.fromFrame=parseInt($("#exportC64AssemblyFromFrame").val(),10);e.toFrame=parseInt($("#exportC64AssemblyToFrame").val(),10);e.layer=$("input[name=exportC64AssemblyLayer]:checked").val();e.exportTileSet=$("#exportC64AssemblyCharactersetData").is(":checked");e.exportCharacterColorData=$("#exportC64AssemblyColorData").is(":checked");e.exportBlockColorData=$("#exportC64AssemblyBlockColorData").is(":checked")&&this.colorPerMode=="block";e.exportBlockData=$("#exportC64AssemblyBlockData").is(":checked")&&this.blockModeEnabled;e.exportBlockMap=$("#exportC64AssemblyBlockMapData").is(":checked")&&this.blockModeEnabled;e.exportCharMap=$("#exportC64AssemblyMapData").is(":checked");e.exportCharMapColorData=$("#exportC64AssemblyMapColorData").is(":checked");e.selection=$("#exportC64AssemblySelectionOnly").is(":checked");e.screenMode=this.editor.getScreenMode();this.exportC64AssemblyAs(e)}};var ExportMega65Assembly=function(){this.editor=null;this.asmEditor=null;this.lineEnding="\r\n";this.columns=16};ExportMega65Assembly.prototype={init:function(e){this.editor=e},formatBytes:function(e,t){var i=t.numberFormat!="dec";var r=this.getByteLabel(t);var a=this.lineEnding;var s=0;var o=16;if(typeof t.columns!=="undefined"){o=t.columns}var l="";for(var n=0;n<e.length;n++){var h=e[n];if(s!==0){l+=","}else{l+=r}if(i){l+="$";l+=("00"+h.toString(16)).substr(-2)}else{l+=h.toString(10)}s++;if(s==o){s=0;l+=a}}return l},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportMega65AssemblyDialog",title:"Export Assembly",width:840,height:600});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportMega65Assembly.html",function(){t.initContent();t.initEvents()});this.htmlComponent.on("resize",function(){if(t.asmEditor&&t.asmEditor.resize){t.asmEditor.resize()}});this.displayButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"/> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.displayButton);this.displayButton.on("click",function(e){t.copyToClipboard()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportMega65AssemblyDialog")},toHex:function(e){return("0000"+e.toString(16)).substr(-4)},initContent:function(){if(this.asmEditor==null){this.asmEditor=ace.edit("exportMega65AssemblySource");this.asmEditor.getSession().setTabSize(2);this.asmEditor.getSession().setUseSoftTabs(true);this.asmEditor.on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});this.asmEditor.on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});var e="ace/mode/assembly_6502";if(this.mode=="javascript"){e="ace/mode/javascript"}this.asmEditor.getSession().setMode(e);this.asmEditor.setShowInvisibles(false)}this.colorPerMode=this.editor.getColorPerMode();this.blockModeEnabled=this.editor.getBlockModeEnabled();$("#exportMega65AssemblyAs").val(g_app.fileManager.filename);var t=this.editor.graphic.getFrameCount();$("#exportMega65AssemblyToFrame").val(t);$("#exportMega65AssemblyFromFrame").val(1);$("#exportMega65AssemblyFromFrame").attr("max",t);$("#exportMega65AssemblyToFrame").attr("max",t);switch(this.colorPerMode){case"character":$("#exportMega65AssemblyColorDataHolder").show();$("#exportMega65AssemblyMapColorData").hide();break;case"cell":$("#exportMega65AssemblyColorDataHolder").show();$("#exportMega65AssemblyMapColorData").show();break;case"block":$("#exportMega65AssemblyColorDataHolder").show();$("#exportMega65AssemblyMapColorData").hide();break}if(this.blockModeEnabled){$("#exportMega65AssemblyBlockMapDataHolder").show();if(this.colorPerMode=="block"){$("#exportMega65AssemblyBlockColorDataHolder").show()}else{$("#exportMega65AssemblyBlockColorDataHolder").hide()}$("#exportMega65AssemblyMapData").prop("checked",false)}else{$("#exportMega65AssemblyBlockMapDataHolder").hide();$("#exportMega65AssemblyBlockColorDataHolder").hide();$("#exportMega65AssemblyBlockDataHolder").hide()}this.exportMega65Assembly({displayOnly:true})},initEvents:function(){var e=this;$("input[name=exportMega65AssemblyFormat]").on("click",function(){e.exportMega65Assembly({displayOnly:true})});$("input[name=exportMega65NumberFormat]").on("click",function(){e.exportMega65Assembly({displayOnly:true})});$(".exportMega65AssemblyInclude").on("click",function(){e.exportMega65Assembly({displayOnly:true})});$("#exportMega65AssemblyFromFrame").on("change",function(){e.exportMega65Assembly({displayOnly:true})});$("#exportMega65AssemblyToFrame").on("change",function(){e.exportMega65Assembly({displayOnly:true})});$("#exportMega65AssemblyDownload").on("click",function(){e.download()})},copyToClipboard:function(){var e=this.asmEditor.selection.toJSON();this.asmEditor.selectAll();this.asmEditor.focus();document.execCommand("copy");this.asmEditor.selection.fromJSON(e)},getByteLabel:function(e){var t="!byte ";if(e.format=="kickass"||e.format=="ca65"||e.format=="tass"){t=".byte "}if(e.format=="acme"){t="!byte "}return t},getCommentSymbol:function(e){var t=";";if(e.format=="kickass"){t="//"}return t},getConstSymbol:function(e){var t="";if(e.format=="kickass"){t=".label "}return t},getSetPCSymbol:function(e){var t="* = ";if(e.format=="ca65"){t=".ORG "}return t},getLabelPostfix:function(e){var t="";if(e.format=="kickass"||e.format=="ca65"){t=":"}return t},getBlockMapData:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=1;var a=1;if(typeof e!="undefined"){if(typeof e.fromFrame!="undefined"){r=e.fromFrame}if(typeof e.toFrame!="undefined"){a=e.toFrame}}var s=e.numberFormat!="dec";var o=i.getTileSet();var l=o.getTileCount();var n=l*8;var h=i.getGridWidth();var d=i.getGridHeight();var c=this.editor.blockSetManager.getCurrentBlockSet();var f=0;var u=0;var p=0;if(c){f=c.getBlockCount();u=i.getBlockWidth();p=i.getBlockHeight()}var v=f*u*p;var g=this.getByteLabel(e);var m="text";if(typeof t!="undefined"){m=t}var y="";var b=[];var C=0;for(var x=r-1;x<a;x++){var S=0;if(x>=i.getFrameCount()){break}var C=0;S=0;var P=0;var w=d;var I=p;var k=u;for(var M=P;M<w;M+=I){for(var T=0;T<h;T+=k){var D=i.getCell({x:T,y:M,frame:x});var E=D.b;if(typeof E=="undefined"){E=0}if(m=="text"){if(S!==0){y+=","}else{y+=g}if(s){y+="$";y+=("00"+E.toString(16)).substr(-2)}else{y+=E.toString(10)}S++;if(S==this.columns){S=0;y+=this.lineEnding}}if(m=="binary"){b[C]=E}C++}}y+=this.lineEnding+this.lineEnding;var $=x+1}if(m=="text"){return y}if(m=="binary"){return new Uint8Array(b)}},getBlockSetData:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=i.getTileSet();var a=r.getTileCount();var s=a*8;var o=this.editor.blockSetManager.getCurrentBlockSet();var l=0;var n=0;var h=0;if(o){l=o.getBlockCount();n=i.getBlockWidth();h=i.getBlockHeight()}var d=l*n*h;var f=e.numberFormat!="dec";var u=i.getScreenMode();var p=u===TextModeEditor.Mode.Mega65ECM;var v=i.getColorPerMode();var g=this.getByteLabel(e);var m="text";if(typeof t!="undefined"){m=t}var y="";var b=0;var C=[];var b=0;var x=0;for(var S=0;S<l;S++){for(var P=0;P<h;P++){for(var w=0;w<n;w++){var I=o.getCharacterInBlock(S,w,P);if(p){var k=o.getBlockBGColor(S);if(v=="character"){k=r.getTileBGColor(c)&15}I=I&63;switch(k){case 1:I=I|64;break;case 2:I=I|128;break;case 3:I=I|192;break}}if(m=="text"){if(b!==0){y+=","}else{y+=g}if(f){y+="$";y+=("00"+I.toString(16)).substr(-2)}else{y+=I.toString(10)}b++;if(b==this.columns){b=0;y+=this.lineEnding}}if(m=="binary"){C[x]=I}x++}}}if(m=="text"){return y}if(m=="binary"){return new Uint8Array(C)}},getBlockColorData:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=i.getTileSet();var a=r.getTileCount();var s=a*8;var o=this.editor.blockSetManager.getCurrentBlockSet();var l=0;var n=0;var h=0;if(o){l=o.getBlockCount();n=i.getBlockWidth();h=i.getBlockHeight()}var d=l*n*h;var c=e.numberFormat!="dec";var f=this.getByteLabel(e);var u="text";if(typeof t!="undefined"){u=t}var p="";var v=0;var g=[];var v=0;var m=0;for(var y=0;y<l;y++){var b=o.getBlockColor(y);if(u=="text"){if(v!==0){p+=","}else{p+=f}if(c){p+="$";p+=("00"+b.toString(16)).substr(-2)}else{p+=b.toString(10)}v++;if(v==this.columns){v=0;p+=this.lineEnding}}if(u=="binary"){g[m]=b}m++}if(u=="text"){return p}if(u=="binary"){return new Uint8Array(g)}},getLayerFromPath:function(e){var t=false;var i=g_app.doc.getDocRecord(e.path);if(i){if(typeof e.layerId==="undefined"){var r=i.data.layers;console.log(r);if(r.length>0){t=r[0].layerId}}layer=new LayerGrid;layer.connectToDoc({editor:this.editor,doc:i,layerId:t});console.log(layer);console.log("layer id = "+t)}},getCharMapData:function(e,t){var i=null;if(typeof e!=="undefined"){if(typeof e.path!=="undefined"){i=this.getLayerFromPath(e)}}if(i===null){i=this.editor.layers.getSelectedLayerObject()}if(i.getType()!=="grid"){return}var r=i.getScreenMode();var a=r===TextModeEditor.Mode.Mega65ECM;var s=i.getColorPerMode();var o=this.getByteLabel(e);var l="text";if(typeof t!="undefined"){l=t}var n=e.numberFormat!="dec";var h="";var d=0;var c=[];var f=i.getGridWidth();var u=i.getGridHeight();var p=1;var v=1;if(typeof e!="undefined"){if(typeof e.fromFrame!="undefined"){p=e.fromFrame}if(typeof e.toFrame!="undefined"){v=e.toFrame}}for(var g=p-1;g<v;g++){if(g>=i.getFrameCount()){break}var m=0;d=0;var y=0;var b=u;var C=1;for(var x=y;x!=b;x+=C){for(var S=0;S<f;S++){var P=i.getCell({x:S,y:x,frame:g});var w=P.t;if(a){var I=P.bc;if(s=="character"){I=tileSet.getTileBGColor(w)&15}w=w&63;switch(I){case 1:w=w|64;break;case 2:w=w|128;break;case 3:w=w|192;break}}if(l=="text"){if(d!==0){h+=","}else{h+=o}if(n){h+="$";h+=("00"+w.toString(16)).substr(-2)}else{h+=w.toString(10)}d++;if(d==this.columns){d=0;h+=this.lineEnding}}if(l=="binary"){c[m]=w}m++}}if(l=="text"){h+=this.lineEnding+this.lineEnding}}if(l=="text"){return h}if(l=="binary"){return new Uint8Array(c)}},exportMega65Format:function(e){var t=16;this.columns=16;console.log(e);var i=".txt";var r=true;var a=true;var s=true;var o=true;var l=false;var n=true;var h=false;if(typeof e.exportTileSet!="undefined"){r=e.exportTileSet}if(typeof e.exportCharacterColorData!="undefined"){a=e.exportCharacterColorData}if(typeof e.exportBlockData!="undefined"){s=e.exportBlockData}if(typeof e.exportBlockColorData!="undefined"){n=e.exportBlockColorData}if(typeof e.exportBlockMap!="undefined"){o=e.exportBlockMap}if(typeof e.exportCharMap!="undefined"){l=e.exportCharMap}if(typeof e.exportCharMapColorData!="undefined"){h=e.exportCharMapColorData}var d="\r\n";var c=this.getByteLabel(e);var f=this.getCommentSymbol(e);var u=this.getConstSymbol(e);var p=this.getLabelPostfix(e);var v=this.getSetPCSymbol(e);var g="";var m=this.editor.tileSetManager;var y=this.editor.layers.getSelectedLayerObject();if(y&&y.getType()=="grid"){if(!y.getBlockModeEnabled()){o=false}var b=y.getGridWidth();var C=y.getGridHeight();var x=y.getTileSet();var S=x.getTileCount();var P=S*8;var w=this.editor.blockSetManager.getCurrentBlockSet();var I=0;var k=0;var M=0;var T=e.numberFormat!="dec";if(w){I=w.getBlockCount();k=y.getBlockWidth();M=y.getBlockHeight()}var D=I*k*M;var E=y.getBackgroundColor();var $=y.getBorderColor();g+=u+"SCREEN_BACKGROUND_COLOUR = "+E+d;g+=u+"SCREEN_BORDER_COLOUR = "+$+d;if(e.screenMode===TextModeEditor.Mode.Mega65MULTICOLOR){var _=y.getMega65Multi1Color();var B=y.getMega65Multi2Color();g+=u+"CHAR_MULTICOLOUR_MODE = 1"+d;g+=u+"COLOUR_CHAR_MC1 = "+_+d;g+=u+"COLOUR_CHAR_MC2 = "+B+d}else{g+=u+"CHAR_MULTICOLOUR_MODE = 0"+d}if(r){g+=u+"CHAR_COUNT = "+S+d}if(s){g+=u+"TILE_COUNT = "+I+d;g+=u+"TILE_WIDTH = "+k+d;g+=u+"TILE_HEIGHT = "+M+d}var R=0;var A=0;if(o&&k!=0&&M!=0){R=Math.ceil(b/k);A=Math.ceil(C/M);g+=u+"MAP_WID = "+R+d;g+=u+"MAP_HEI = "+A+d}var F=R*A;var L=b*C;if(o||l){var U=b;var H=C;var O=U*8;var G=H*8;g+=u+"MAP_WID_CHRS = "+U+d;g+=u+"MAP_HEI_CHRS = "+H+d;g+=u+"MAP_WID_PXLS = "+O+d;g+=u+"MAP_HEI_PXLS = "+G+d}g+=d+d;g+=f+" Data block size constants:-"+d;if(r){g+=u+"SZ_CHARSET_DATA         = "+P+d}if(a){g+=u+"SZ_CHARSET_ATTRIB_DATA  = "+S+d}if(n){g+=u+"SZ_TILESET_ATTRIB_DATA  = "+I+d}if(s){g+=u+"SZ_TILESET_DATA         = "+D+d}if(o){g+=u+"SZ_TILE_MAP_DATA        = "+F+d}if(l){g+=u+"SZ_CHAR_MAP_DATA        = "+L+d}if(h){g+=u+"SZ_CHAR_MAP_COLOUR_DATA = "+L+d}g+=d+d;g+=f+" Data block address constants (dummy values):-"+d;var z=4096;if(r){g+=u+"ADDR_CHARSET_DATA          = $"+this.toHex(z)+"   "+f+" label = 'charset_data'        (size = $"+this.toHex(P)+"). "+d;z+=P}if(a){g+=u+"ADDR_CHARSET_ATTRIB_DATA   = $"+this.toHex(z)+"   "+f+" label = 'charset_attrib_data' (size = $"+this.toHex(S)+")."+d;z+=S}if(n){g+=u+"ADDR_TILESET_ATTRIB_DATA             = $"+this.toHex(z)+"   "+f+" label = 'tileset_attrib_data'        (size = $"+this.toHex(D)+")."+d;z+=D}if(s){g+=u+"ADDR_TILESET_DATA             = $"+this.toHex(z)+"   "+f+" label = 'tileset_data'        (size = $"+this.toHex(D)+")."+d;z+=D}if(o){g+=u+"ADDR_TILE_MAP_DATA         = $"+this.toHex(z)+"   "+f+" label = 'tile_map_data'            (size = $"+this.toHex(F)+")."+d;z+=F}if(l){g+=u+"ADDR_CHAR_MAP_DATA         = $"+this.toHex(z)+"   "+f+" label = 'map_data'            (size = $"+this.toHex(L)+")."+d;z+=L}if(h){g+=u+"ADDR_CHAR_MAP_COLOUR_DATA  = $"+this.toHex(z)+"   "+f+" label = 'map_colour_data'     (size = $"+this.toHex(L)+")."+d;z+=L}g+="\n\n";if(r){g+=f+" CHAR SET DATA : "+S+" (8 byte) chars : total size is "+P+" ($"+this.toHex(P)+") bytes."+d;g+=d;g+=v+" ADDR_CHARSET_DATA";if(e.format=="kickass"){g+=' "charset_data"'}g+=d;g+="charset_data"+p+d;g+=d;var N=[];Pe=0;var W=0;t=8;var X=x.getTileWidth();var Y=x.getTileHeight();var V=[];var q=this.editor.graphic.getFrameCount();for(var j=0;j<x.tileCount;j++){var K=0;var Z=0;var J=[];for(var Q=0;Q<Y;Q++){for(var ee=0;ee<X;ee++){var te=x.getPixel(j,ee,Q);V.push(te)}}}g+=this.formatBytes(V,{numberFormat:e.numberFormat,columns:8})}var ie=true;if(ie){var re="";var ae=y.getColorPalette();var se=ae.getColorCount();re+=v+" ADDR_CHARSET_PALETTE_DATA";if(e.format=="kickass"){re+=' "charset_palette_data"'}re+=d;re+="charset_palette_data"+p+d;re+=d;var oe=[];var le=[];var ne=[];for(var he=0;he<255;he++){if(he<se){var j=ae.getRGBA(he);j[0]=j[0]&255;var de=(j[0]&240)>>4;var ce=j[0]&15;if(ce>7){ce=7}de+=ce<<4;oe.push(de);de=((j[1]&240)>>4)+((j[1]&15)<<4);le.push(de);de=((j[2]&240)>>4)+((j[2]&15)<<4);ne.push(de)}else{oe.push(0);le.push(0);ne.push(0)}}re+="charset_palette_data_red"+p+d;re+=this.formatBytes(oe,e);re+=d+d;re+="charset_palette_data_green"+p+d;re+=this.formatBytes(le,e);re+=d+d;re+="charset_palette_data_blue"+p+d;re+=this.formatBytes(ne,e);g+=re;g+=d+d}if(a){var fe="";var S=x.getTileCount();fe+=f+" CHAR SET ATTRIBUTE DATA : "+S+" attributes : total size is "+S+" ($"+this.toHex(S)+") bytes."+d;fe+=f+" nb. Upper nybbles = Material, Lower nybbles = Colour."+d;fe+=d;fe+=v+" ADDR_CHARSET_ATTRIB_DATA";if(e.format=="kickass"){fe+=' "charset_attrib_data"'}fe+=d;fe+="charset_attrib_data"+p+d;fe+=d;var W=0;for(var he=0;he<x.tileCount;he++){var ue=x.getTileColor(he)&15;var pe=x.getTileMaterial(he)&15;if(W!==0){fe+=","}else{fe+=c}var ve=ue+(pe<<4);if(T){fe+="$";fe+=("00"+ve.toString(16)).substr(-2)}else{fe+=ve.toString(10)}W++;if(W==t){W=0;fe+=d}}g+=fe;g+=d+d}if(s){var ge="";ge+=f+" TILE SET DATA : "+I+" ("+k+"x"+M+") tiles : total size is "+D+" ($"+this.toHex(D)+") bytes."+d;ge+=d;ge+=v+" ADDR_TILESET_DATA";if(e.format=="kickass"){ge+=' "tileset_data"'}ge+=d;ge+="tileset_data"+p+d;ge+=d;ge+=this.getBlockSetData(e);g+=ge;g+=d+d}if(n){var me="";var ye=I;var be=("0000"+ye.toString(16)).substr(-4);me+=f+" TILE SET ATTRIBUTE DATA : "+I+" attributes : total size is "+ye+" ($"+be+") bytes."+d;me+=f+" nb. Upper nybbles = Material, Lower nybbles = Colour."+d;me+=d;me+=v+" ADDR_TILESET_ATTRIB_DATA";if(e.format=="kickass"){me+=' "tileset_attrib_data"'}me+=d;me+="tileset_attrib_data"+p+d;me+=d;me+=this.getBlockColorData(e);g+=me;g+=d+d}if(o){var Ce="";var xe=("0000"+F.toString(16)).substr(-4);var W=0;Ce+=f+" MAP DATA : 1 ("+R+"x"+A+") map : total size is "+F+" ($"+xe+") bytes."+d;Ce+=d;Ce+=v+" ADDR_TILE_MAP_DATA";if(e.format=="kickass"){Ce+=' "tile_map_data"'}Ce+=d;Ce+="tile_map_data"+p+d;Ce+=d;Ce+=this.getBlockMapData(e);g+=Ce;g+=d+d}if(l){var W=0;g+=f+" MAP DATA : 1 ("+b+"x"+C+") map : total size is "+L+" ($"+this.toHex(L)+") bytes."+d;g+=d;g+=v+" ADDR_CHAR_MAP_DATA";if(e.format=="kickass"){g+=' "map_data"'}g+=d;g+="map_data"+p+d;g+=d;g+=this.getCharMapData(e)}if(h){var W=0;g+=f+"  MAP COLOUR DATA : 1 ("+b+"x"+C+") map : total size is "+L+" ($"+this.toHex(L)+") bytes."+d;g+=d;g+=v+" ADDR_CHAR_MAP_COLOUR_DATA";if(e.format=="kickass"){g+=' "map_colour_data"'}g+=d;g+="map_colour_data"+p+d;g+=d;for(var Se=e.fromFrame-1;Se<e.toFrame;Se++){if(Se>=this.editor.graphic.getFrameCount()){break}var Pe=0;W=0;var we=0;var Ie=C;var ke=1;for(var Q=we;Q!=Ie;Q+=ke){for(var ee=0;ee<b;ee++){var Me=y.getCell({x:ee,y:Q,frame:Se});if(W!==0){g+=","}else{g+=c}if(T){g+="$";g+=("00"+Me.fc.toString(16)).substr(-2)}else{g+=Me.fc.toString(10)}W++;if(W==t){W=0;g+=d}Pe++}}g+=d+d}}}if(typeof e.displayOnly!="undefined"&&e.displayOnly){this.asmEditor.setValue(g,-1)}else{download(g,e.filename+".txt","application/txt")}},exportMega65AssemblyAs:function(e){if(typeof e.filename=="undefined"){e.filename=g_app.fileManager.filename}if(typeof e.format=="undefined"){e.format="binary"}if(typeof e.layer=="undefined"){e.layer="current"}var t=this.editor.graphic.getCurrentFrame();if(typeof e.fromFrame=="undefined"){e.fromFrame=t}if(typeof e.toFrame=="undefined"){e.toFrame=t}this.exportMega65Format(e)},download:function(){var e=$("#exportMega65AssemblyAs").val();e+=".txt";var t=this.asmEditor.getValue();download(t,e,"application/txt")},exportMega65Assembly:function(e){e.filename=$("#exportMega65AssemblyAs").val();e.format=$("input[name=exportMega65AssemblyFormat]:checked").val();e.numberFormat=$("input[name=exportMega65NumberFormat]:checked").val();e.fromFrame=parseInt($("#exportMega65AssemblyFromFrame").val(),10);e.toFrame=parseInt($("#exportMega65AssemblyToFrame").val(),10);e.layer=$("input[name=exportMega65AssemblyLayer]:checked").val();e.exportTileSet=$("#exportMega65AssemblyCharactersetData").is(":checked");e.exportCharacterColorData=$("#exportMega65AssemblyColorData").is(":checked");e.exportBlockColorData=$("#exportMega65AssemblyBlockColorData").is(":checked")&&this.colorPerMode=="block";e.exportBlockData=$("#exportMega65AssemblyBlockData").is(":checked")&&this.blockModeEnabled;e.exportBlockMap=$("#exportMega65AssemblyBlockMapData").is(":checked")&&this.blockModeEnabled;e.exportCharMap=$("#exportMega65AssemblyMapData").is(":checked");e.exportCharMapColorData=$("#exportMega65AssemblyMapColorData").is(":checked");e.screenMode=this.editor.getScreenMode();this.exportMega65AssemblyAs(e)}};var ExportX16Assembly=function(){this.editor=null;this.asmEditor=null;this.lineEnding="\r\n";this.columns=16};ExportX16Assembly.prototype={init:function(e){this.editor=e},formatBytes:function(e,t){var i=t.numberFormat!="dec";var r=this.getByteLabel(t);var a=this.lineEnding;var s=0;var o=16;var l="";for(var n=0;n<e.length;n++){var h=e[n];if(s!==0){l+=","}else{l+=r}if(i){l+="$";l+=("00"+h.toString(16)).substr(-2)}else{l+=h.toString(10)}s++;if(s==o){s=0;l+=a}}return l},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportX16AssemblyDialog",title:"Export Assembly",width:840,height:600});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportX16Assembly.html",function(){t.initContent();t.initEvents()});this.htmlComponent.on("resize",function(){if(t.asmEditor&&t.asmEditor.resize){t.asmEditor.resize()}});this.displayButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"/> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.displayButton);this.displayButton.on("click",function(e){t.copyToClipboard()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportX16AssemblyDialog")},toHex:function(e){return("0000"+e.toString(16)).substr(-4)},initContent:function(){if(this.asmEditor==null){this.asmEditor=ace.edit("exportX16AssemblySource");this.asmEditor.getSession().setTabSize(2);this.asmEditor.getSession().setUseSoftTabs(true);this.asmEditor.on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});this.asmEditor.on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});var e="ace/mode/assembly_6502";if(this.mode=="javascript"){e="ace/mode/javascript"}this.asmEditor.getSession().setMode(e);this.asmEditor.setShowInvisibles(false)}this.colorPerMode=this.editor.getColorPerMode();this.blockModeEnabled=this.editor.getBlockModeEnabled();$("#exportX16AssemblyAs").val(g_app.fileManager.filename);var t=this.editor.graphic.getFrameCount();$("#exportX16AssemblyToFrame").val(t);$("#exportX16AssemblyFromFrame").val(1);$("#exportX16AssemblyFromFrame").attr("max",t);$("#exportX16AssemblyToFrame").attr("max",t);switch(this.colorPerMode){case"character":$("#exportX16AssemblyColorDataHolder").show();$("#exportX16AssemblyMapColorData").hide();break;case"cell":$("#exportX16AssemblyColorDataHolder").show();$("#exportX16AssemblyMapColorData").show();break;case"block":$("#exportX16AssemblyColorDataHolder").show();$("#exportX16AssemblyMapColorData").hide();break}if(this.blockModeEnabled){$("#exportX16AssemblyBlockMapDataHolder").show();if(this.colorPerMode=="block"){$("#exportX16AssemblyBlockColorDataHolder").show()}else{$("#exportX16AssemblyBlockColorDataHolder").hide()}$("#exportX16AssemblyMapData").prop("checked",false)}else{$("#exportX16AssemblyBlockMapDataHolder").hide();$("#exportX16AssemblyBlockColorDataHolder").hide();$("#exportX16AssemblyBlockDataHolder").hide()}this.exportX16Assembly({displayOnly:true})},initEvents:function(){var e=this;$("input[name=exportX16AssemblyFormat]").on("click",function(){e.exportX16Assembly({displayOnly:true})});$("input[name=exportX16NumberFormat]").on("click",function(){e.exportX16Assembly({displayOnly:true})});$(".exportX16AssemblyInclude").on("click",function(){e.exportX16Assembly({displayOnly:true})});$("#exportX16AssemblyFromFrame").on("change",function(){e.exportX16Assembly({displayOnly:true})});$("#exportX16AssemblyToFrame").on("change",function(){e.exportX16Assembly({displayOnly:true})});$("#exportX16AssemblyDownload").on("click",function(){e.download()})},copyToClipboard:function(){var e=this.asmEditor.selection.toJSON();this.asmEditor.selectAll();this.asmEditor.focus();document.execCommand("copy");this.asmEditor.selection.fromJSON(e)},getByteLabel:function(e){var t="!byte ";if(e.format=="kickass"||e.format=="ca65"||e.format=="tass"){t=".byte "}if(e.format=="acme"){t="!byte "}return t},getCommentSymbol:function(e){var t=";";if(e.format=="kickass"){t="//"}return t},getConstSymbol:function(e){var t="";if(e.format=="kickass"){t=".label "}return t},getSetPCSymbol:function(e){var t="* = ";if(e.format=="ca65"){t=".ORG "}return t},getLabelPostfix:function(e){var t="";if(e.format=="kickass"||e.format=="ca65"){t=":"}return t},getBlockMapData:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=1;var a=1;if(typeof e!="undefined"){if(typeof e.fromFrame!="undefined"){r=e.fromFrame}if(typeof e.toFrame!="undefined"){a=e.toFrame}}var s=e.numberFormat!="dec";var o=i.getTileSet();var l=o.getTileCount();var n=l*8;var h=i.getGridWidth();var d=i.getGridHeight();var c=this.editor.blockSetManager.getCurrentBlockSet();var f=0;var u=0;var p=0;if(c){f=c.getBlockCount();u=i.getBlockWidth();p=i.getBlockHeight()}var v=f*u*p;var g=this.getByteLabel(e);var m="text";if(typeof t!="undefined"){m=t}var y="";var b=[];var C=0;for(var x=r-1;x<a;x++){var S=0;if(x>=i.getFrameCount()){break}var C=0;S=0;var P=0;var w=d;var I=p;var k=u;for(var M=P;M<w;M+=I){for(var T=0;T<h;T+=k){var D=i.getCell({x:T,y:M,frame:x});var E=D.b;if(typeof E=="undefined"){E=0}if(m=="text"){if(S!==0){y+=","}else{y+=g}if(s){y+="$";y+=("00"+E.toString(16)).substr(-2)}else{y+=E.toString(10)}S++;if(S==this.columns){S=0;y+=this.lineEnding}}if(m=="binary"){b[C]=E}C++}}y+=this.lineEnding+this.lineEnding;var $=x+1}if(m=="text"){return y}if(m=="binary"){return new Uint8Array(b)}},getBlockSetData:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=i.getTileSet();var a=r.getTileCount();var s=a*8;var o=this.editor.blockSetManager.getCurrentBlockSet();var l=0;var n=0;var h=0;if(o){l=o.getBlockCount();n=i.getBlockWidth();h=i.getBlockHeight()}var d=l*n*h;var f=e.numberFormat!="dec";var u=i.getScreenMode();var p=u===TextModeEditor.Mode.C64ECM;var v=i.getColorPerMode();var g=this.getByteLabel(e);var m="text";if(typeof t!="undefined"){m=t}var y="";var b=0;var C=[];var b=0;var x=0;for(var S=0;S<l;S++){for(var P=0;P<h;P++){for(var w=0;w<n;w++){var I=o.getCharacterInBlock(S,w,P);if(p){var k=o.getBlockBGColor(S);if(v=="character"){k=r.getTileBGColor(c)&15}I=I&63;switch(k){case 1:I=I|64;break;case 2:I=I|128;break;case 3:I=I|192;break}}if(m=="text"){if(b!==0){y+=","}else{y+=g}if(f){y+="$";y+=("00"+I.toString(16)).substr(-2)}else{y+=I.toString(10)}b++;if(b==this.columns){b=0;y+=this.lineEnding}}if(m=="binary"){C[x]=I}x++}}}if(m=="text"){return y}if(m=="binary"){return new Uint8Array(C)}},getBlockColorData:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=i.getTileSet();var a=r.getTileCount();var s=a*8;var o=this.editor.blockSetManager.getCurrentBlockSet();var l=0;var n=0;var h=0;if(o){l=o.getBlockCount();n=i.getBlockWidth();h=i.getBlockHeight()}var d=l*n*h;var c=e.numberFormat!="dec";var f=this.getByteLabel(e);var u="text";if(typeof t!="undefined"){u=t}var p="";var v=0;var g=[];var v=0;var m=0;for(var y=0;y<l;y++){var b=o.getBlockColor(y);if(u=="text"){if(v!==0){p+=","}else{p+=f}if(c){p+="$";p+=("00"+b.toString(16)).substr(-2)}else{p+=b.toString(10)}v++;if(v==this.columns){v=0;p+=this.lineEnding}}if(u=="binary"){g[m]=b}m++}if(u=="text"){return p}if(u=="binary"){return new Uint8Array(g)}},getLayerFromPath:function(e){var t=false;var i=g_app.doc.getDocRecord(e.path);if(i){if(typeof e.layerId==="undefined"){var r=i.data.layers;console.log(r);if(r.length>0){t=r[0].layerId}}layer=new LayerGrid;layer.connectToDoc({editor:this.editor,doc:i,layerId:t});console.log(layer);console.log("layer id = "+t)}},getCharMapData:function(e,t){var i=null;if(typeof e!=="undefined"){if(typeof e.path!=="undefined"){i=this.getLayerFromPath(e)}}if(i===null){i=this.editor.layers.getSelectedLayerObject()}if(i.getType()!=="grid"){return}var r="text";if(typeof t!="undefined"){r=t}var a=0;var s=i.getGridWidth();var o=i.getGridHeight();var l=1;var n=1;var h=[];if(typeof e!="undefined"){if(typeof e.fromFrame!="undefined"){l=e.fromFrame}if(typeof e.toFrame!="undefined"){n=e.toFrame}}for(var d=l-1;d<n;d++){if(d>=i.getFrameCount()){break}a=0;var c=0;var f=o;var u=1;for(var p=c;p!=f;p+=u){for(var v=0;v<s;v++){var g=i.getCell({x:v,y:p,frame:d});var m=g.t;h.push(m&255);var y=m>>8&3;if(g.fh){y=y|4}if(g.fv){y=y|8}h.push(y)}}}if(r=="text"){return this.formatBytes(h,e)}if(r=="binary"){return new Uint8Array(h)}},exportX16Format:function(e){var t=16;this.columns=16;var i=".txt";var r=typeof e.exportColorPalette==="undefined"?true:e.exportColorPalette;var a=true;var s=true;var o=true;var l=true;var n=false;var h=true;var d=false;if(typeof e.exportTileSet!="undefined"){a=e.exportTileSet}if(typeof e.exportCharacterColorData!="undefined"){s=e.exportCharacterColorData}if(typeof e.exportBlockData!="undefined"){o=e.exportBlockData}if(typeof e.exportBlockColorData!="undefined"){h=e.exportBlockColorData}if(typeof e.exportBlockMap!="undefined"){l=e.exportBlockMap}if(typeof e.exportCharMap!="undefined"){n=e.exportCharMap}if(typeof e.exportCharMapColorData!="undefined"){d=e.exportCharMapColorData}var c="\r\n";var f=this.getByteLabel(e);var u=this.getCommentSymbol(e);var p=this.getConstSymbol(e);var v=this.getLabelPostfix(e);var g=this.getSetPCSymbol(e);var m="";var y=this.editor.tileSetManager;var b=this.editor.layers.getSelectedLayerObject();if(b&&b.getType()=="grid"){if(!b.getBlockModeEnabled()){l=false}var C=b.getGridWidth();var x=b.getGridHeight();var S=b.getTileSet();var P=S.getTileCount();var w=P*8;var I=this.editor.blockSetManager.getCurrentBlockSet();var k=0;var M=0;var T=0;var D=e.numberFormat!="dec";if(I){k=I.getBlockCount();M=b.getBlockWidth();T=b.getBlockHeight()}var E=k*M*T;var $=b.getBackgroundColor();var _=b.getBorderColor();m+=p+"SCREEN_BACKGROUND_COLOUR = "+$+c;m+=p+"SCREEN_BORDER_COLOUR = "+_+c;if(e.screenMode===TextModeEditor.Mode.C64MULTICOLOR){var B=b.getC64Multi1Color();var R=b.getC64Multi2Color();m+=p+"CHAR_MULTICOLOUR_MODE = 1"+c;m+=p+"COLOUR_CHAR_MC1 = "+B+c;m+=p+"COLOUR_CHAR_MC2 = "+R+c}else{m+=p+"CHAR_MULTICOLOUR_MODE = 0"+c}if(a){m+=p+"CHAR_COUNT = "+P+c}if(o){m+=p+"TILE_COUNT = "+k+c;m+=p+"TILE_WIDTH = "+M+c;m+=p+"TILE_HEIGHT = "+T+c}var A=0;var F=0;if(l&&M!=0&&T!=0){A=Math.ceil(C/M);F=Math.ceil(x/T);m+=p+"MAP_WID = "+A+c;m+=p+"MAP_HEI = "+F+c}var L=A*F;var U=C*x;if(l||n){var H=C;var O=x;var G=H*8;var z=O*8;m+=p+"MAP_WID_CHRS = "+H+c;m+=p+"MAP_HEI_CHRS = "+O+c;m+=p+"MAP_WID_PXLS = "+G+c;m+=p+"MAP_HEI_PXLS = "+z+c}m+=c+c;m+=u+" Data block size constants:-"+c;if(a){m+=p+"SZ_CHARSET_DATA         = "+w+c}if(s){m+=p+"SZ_CHARSET_ATTRIB_DATA  = "+P+c}if(h){m+=p+"SZ_TILESET_ATTRIB_DATA  = "+k+c}if(o){m+=p+"SZ_TILESET_DATA         = "+E+c}if(l){m+=p+"SZ_TILE_MAP_DATA        = "+L+c}if(n){m+=p+"SZ_CHAR_MAP_DATA        = "+U+c}if(d){m+=p+"SZ_CHAR_MAP_COLOUR_DATA = "+U+c}m+=c+c;m+=u+" Data block address constants (dummy values):-"+c;var N=4096;if(a){m+=p+"ADDR_CHARSET_DATA          = $"+this.toHex(N)+"   "+u+" label = 'charset_data'        (size = $"+this.toHex(w)+"). "+c;N+=w}if(s){m+=p+"ADDR_CHARSET_ATTRIB_DATA   = $"+this.toHex(N)+"   "+u+" label = 'charset_attrib_data' (size = $"+this.toHex(P)+")."+c;N+=P}if(h){m+=p+"ADDR_TILESET_ATTRIB_DATA             = $"+this.toHex(N)+"   "+u+" label = 'tileset_attrib_data'        (size = $"+this.toHex(E)+")."+c;N+=E}if(o){m+=p+"ADDR_TILESET_DATA             = $"+this.toHex(N)+"   "+u+" label = 'tileset_data'        (size = $"+this.toHex(E)+")."+c;N+=E}if(l){m+=p+"ADDR_TILE_MAP_DATA         = $"+this.toHex(N)+"   "+u+" label = 'tile_map_data'            (size = $"+this.toHex(L)+")."+c;N+=L}if(n){m+=p+"ADDR_CHAR_MAP_DATA         = $"+this.toHex(N)+"   "+u+" label = 'map_data'            (size = $"+this.toHex(U)+")."+c;N+=U}if(d){m+=p+"ADDR_CHAR_MAP_COLOUR_DATA  = $"+this.toHex(N)+"   "+u+" label = 'map_colour_data'     (size = $"+this.toHex(U)+")."+c;N+=U}m+="\n\n";if(r){var W="";var X=b.getColorPalette();var Y=X.getColorCount();W+=g+" ADDR_CHARSET_PALETTE_DATA";if(e.format=="kickass"){W+=' "charset_palette_data"'}W+=c;W+="charset_palette_data"+v+c;W+=c;var V=[];for(var q=0;q<Y;q++){var j=X.getRGBA(q);var K=j[0]>>4&15;var Z=j[1]&240;var J=j[2]>>4&15;V.push(Z+J);V.push(K)}W+=this.formatBytes(V,e);m+=W;m+=c+c}if(a){m+=u+" CHAR SET DATA : "+P+" (8 byte) chars : total size is "+w+" ($"+this.toHex(w)+") bytes."+c;m+=c;m+=g+" ADDR_CHARSET_DATA";if(e.format=="kickass"){m+=' "charset_data"'}m+=c;m+="charset_data"+v+c;m+=c;var Q=[];Ce=0;var ee=0;t=8;console.log("export tiles!");var te=S.getTileWidth();var ie=S.getTileHeight();var re=this.editor.graphic.getFrameCount();for(var j=0;j<S.tileCount;j++){var ae=0;var se=0;var oe=[];for(var le=0;le<ie;le++){var J=0;for(var ne=0;ne<te;ne++){J=S.getPixel(j,ne,le);oe.push(J)}}for(var q=0;q<oe.length;q++){var J=oe[q];if(ee!==0){m+=","}else{m+=f}if(D){m+="$";m+=("00"+J.toString(16)).substr(-2)}else{m+=J.toString(10)}ee++;if(ee==t){ee=0;m+=c}}m+=c}m+=c+c}if(s){var he="";var P=S.getTileCount();he+=u+" CHAR SET ATTRIBUTE DATA : "+P+" attributes : total size is "+P+" ($"+this.toHex(P)+") bytes."+c;he+=u+" nb. Upper nybbles = Material, Lower nybbles = Colour."+c;he+=c;he+=g+" ADDR_CHARSET_ATTRIB_DATA";if(e.format=="kickass"){he+=' "charset_attrib_data"'}he+=c;he+="charset_attrib_data"+v+c;he+=c;var ee=0;for(var q=0;q<S.tileCount;q++){var de=S.getTileColor(q)&15;var ce=S.getTileMaterial(q)&15;if(ee!==0){he+=","}else{he+=f}var fe=de+(ce<<4);if(D){he+="$";he+=("00"+fe.toString(16)).substr(-2)}else{he+=fe.toString(10)}ee++;if(ee==t){ee=0;he+=c}}m+=he;m+=c+c}if(o){var ue="";ue+=u+" TILE SET DATA : "+k+" ("+M+"x"+T+") tiles : total size is "+E+" ($"+this.toHex(E)+") bytes."+c;ue+=c;ue+=g+" ADDR_TILESET_DATA";if(e.format=="kickass"){ue+=' "tileset_data"'}ue+=c;ue+="tileset_data"+v+c;ue+=c;ue+=this.getBlockSetData(e);m+=ue;m+=c+c}if(h){var pe="";var ve=k;var ge=("0000"+ve.toString(16)).substr(-4);pe+=u+" TILE SET ATTRIBUTE DATA : "+k+" attributes : total size is "+ve+" ($"+ge+") bytes."+c;pe+=u+" nb. Upper nybbles = Material, Lower nybbles = Colour."+c;pe+=c;pe+=g+" ADDR_TILESET_ATTRIB_DATA";if(e.format=="kickass"){pe+=' "tileset_attrib_data"'}pe+=c;pe+="tileset_attrib_data"+v+c;pe+=c;pe+=this.getBlockColorData(e);m+=pe;m+=c+c}if(l){var me="";var ye=("0000"+L.toString(16)).substr(-4);var ee=0;me+=u+" MAP DATA : 1 ("+A+"x"+F+") map : total size is "+L+" ($"+ye+") bytes."+c;me+=c;me+=g+" ADDR_TILE_MAP_DATA";if(e.format=="kickass"){me+=' "tile_map_data"'}me+=c;me+="tile_map_data"+v+c;me+=c;me+=this.getBlockMapData(e);m+=me;m+=c+c}if(n){var ee=0;m+=u+" MAP DATA : 1 ("+C+"x"+x+") map : total size is "+U+" ($"+this.toHex(U)+") bytes."+c;m+=c;m+=g+" ADDR_CHAR_MAP_DATA";if(e.format=="kickass"){m+=' "map_data"'}m+=c;m+="map_data"+v+c;m+=c;m+=this.getCharMapData(e)}if(d){var ee=0;m+=u+"  MAP COLOUR DATA : 1 ("+C+"x"+x+") map : total size is "+U+" ($"+this.toHex(U)+") bytes."+c;m+=c;m+=g+" ADDR_CHAR_MAP_COLOUR_DATA";if(e.format=="kickass"){m+=' "map_colour_data"'}m+=c;m+="map_colour_data"+v+c;m+=c;for(var be=e.fromFrame-1;be<e.toFrame;be++){if(be>=this.editor.graphic.getFrameCount()){break}var Ce=0;ee=0;var xe=0;var Se=x;var Pe=1;for(var le=xe;le!=Se;le+=Pe){for(var ne=0;ne<C;ne++){var we=b.getCell({x:ne,y:le,frame:be});if(ee!==0){m+=","}else{m+=f}if(D){m+="$";m+=("00"+we.fc.toString(16)).substr(-2)}else{m+=we.fc.toString(10)}ee++;if(ee==t){ee=0;m+=c}Ce++}}m+=c+c}}}if(typeof e.displayOnly!="undefined"&&e.displayOnly){this.asmEditor.setValue(m,-1)}else{download(m,e.filename+".txt","application/txt")}},exportX16AssemblyAs:function(e){if(typeof e.filename=="undefined"){e.filename=g_app.fileManager.filename}if(typeof e.format=="undefined"){e.format="binary"}if(typeof e.layer=="undefined"){e.layer="current"}var t=this.editor.graphic.getCurrentFrame();if(typeof e.fromFrame=="undefined"){e.fromFrame=t}if(typeof e.toFrame=="undefined"){e.toFrame=t}this.exportX16Format(e)},download:function(){var e=$("#exportX16AssemblyAs").val();e+=".txt";var t=this.asmEditor.getValue();download(t,e,"application/txt")},exportX16Assembly:function(e){e.filename=$("#exportX16AssemblyAs").val();e.format=$("input[name=exportX16AssemblyFormat]:checked").val();e.numberFormat=$("input[name=exportX16NumberFormat]:checked").val();e.fromFrame=parseInt($("#exportX16AssemblyFromFrame").val(),10);e.toFrame=parseInt($("#exportX16AssemblyToFrame").val(),10);e.layer=$("input[name=exportX16AssemblyLayer]:checked").val();e.exportColorPalette=$("#exportX16AssemblyColorPalette").is(":checked");e.exportTileSet=$("#exportX16AssemblyCharactersetData").is(":checked");e.exportCharacterColorData=$("#exportX16AssemblyColorData").is(":checked");e.exportBlockColorData=$("#exportX16AssemblyBlockColorData").is(":checked")&&this.colorPerMode=="block";e.exportBlockData=$("#exportX16AssemblyBlockData").is(":checked")&&this.blockModeEnabled;e.exportBlockMap=$("#exportX16AssemblyBlockMapData").is(":checked")&&this.blockModeEnabled;e.exportCharMap=$("#exportX16AssemblyMapData").is(":checked");e.exportCharMapColorData=$("#exportX16AssemblyMapColorData").is(":checked");e.screenMode=this.editor.getScreenMode();this.exportX16AssemblyAs(e)}};var ExportC64SpriteAssembly=function(){this.editor=null;this.asmEditor=null};ExportC64SpriteAssembly.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportC64SpriteAssemblyDialog",title:"Export Assembly",width:600,height:600});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportC64SpriteAssembly.html",function(){t.initContent();t.initEvents()});this.displayButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"/> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.displayButton);this.displayButton.on("click",function(e){t.copyToClipboard()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportC64SpriteAssemblyDialog")},initContent:function(){if(this.asmEditor==null){this.asmEditor=ace.edit("exportC64SpriteAssemblySource");this.asmEditor.getSession().setTabSize(2);this.asmEditor.getSession().setUseSoftTabs(true);this.asmEditor.on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});this.asmEditor.on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});var e="ace/mode/assembly_6502";if(this.mode=="javascript"){e="ace/mode/javascript"}this.asmEditor.getSession().setMode(e);this.asmEditor.setShowInvisibles(false)}$("#exportC64SpriteAssemblyAs").val(g_app.fileManager.filename);var t=this.editor.graphic.getFrameCount();$("#exportC64SpriteAssemblyToFrame").val(t);$("#exportC64SpriteAssemblyFromFrame").val(1);$("#exportC64SpriteAssemblyFromFrame").attr("max",t);$("#exportC64SpriteAssemblyToFrame").attr("max",t);this.exportC64Assembly({displayOnly:true})},initEvents:function(){var e=this;$("input[name=exportC64SpriteAssemblyType]").on("click",function(){e.exportC64Assembly({displayOnly:true})});$("input[name=exportC64SpriteAssemblyFormat]").on("click",function(){e.exportC64Assembly({displayOnly:true})});$("#exportC64SpriteAssemblyFromFrame").on("change",function(){e.exportC64Assembly({displayOnly:true})});$("#exportC64SpriteAssemblyToFrame").on("change",function(){e.exportC64Assembly({displayOnly:true})});$("input[name=exportC64SpriteNumberFormat]").on("click",function(){e.exportC64Assembly({displayOnly:true})});$("#exportC64SpriteAssemblyDownload").on("click",function(){e.download()})},copyToClipboard:function(){var e=this.asmEditor.selection.toJSON();this.asmEditor.selectAll();this.asmEditor.focus();document.execCommand("copy");this.asmEditor.selection.fromJSON(e)},getByteLabel:function(e){var t="!byte ";if(e.format=="kickass"||e.format=="ca65"||e.format=="tass"){t=".byte "}if(e.format=="acme"){t="!byte "}return t},getCommentSymbol:function(e){var t=";";if(e.format=="kickass"){t="//"}return t},getConstSymbol:function(e){var t="";if(e.format=="kickass"){t=".label "}return t},getSetPCSymbol:function(e){var t="* = ";if(e.format=="ca65"){t=".ORG "}return t},getLabelPostfix:function(e){var t="";if(e.format=="kickass"||e.format=="ca65"){t=":"}return t},exportC64Format:function(e){var t=16;var i=this.editor.graphic;var r=this.editor.layers.getLayers();var a=r.length;var s=e.fromFrame-1;var o=e.toFrame;if(o>i.getFrameCount()){o=i.getFrameCount()}var l=e.numberFormat;if(l=="bin"){t=3}var n="c64";if(typeof e.type!="undefined"){n=e.type}var h="\r\n";var d="!byte ";var d=this.getByteLabel(e);var c=this.getCommentSymbol(e);var f=this.getConstSymbol(e);var u=this.getLabelPostfix(e);var p=this.getSetPCSymbol(e);if(n=="fcm"){t=8}var v=0;var g="";for(var m=s;m<o;m++){for(var y=0;y<a;y++){var b=this.editor.layers.getLayerObjectFromIndex(y);if(b&&b.getType()=="grid"){var C=b.getScreenMode();var x=b.getTileSet();var S=b.getGridWidth();var P=b.getGridHeight();var w=x.getTileWidth();var I=x.getTileHeight();var k=b.getLabel();for(var M=0;M<P;M++){for(var T=0;T<S;T++){var D=0;var E=8;if(n=="fcm"){E=w}var $=Math.ceil(w/E);var _=b.getCell({x:T,y:M,frame:m});var B=_.t;var R=_.fc;if(B!==false){console.log("export tile "+B);g+="spr_img_"+m+"_"+y+u+h;g+=c+" Frame: "+m+h;g+=c+" Layer: "+k+h;g+=h;v++;var A=[];for(var F=0;F<I;F++){for(var L=0;L<$;L++){if(n=="fcm"){for(var U=0;U<E;U+=2){var H=L*8+U;var O=x.getPixel(B,H,F)&15;var G=x.getPixel(B,H+1,F)&15;z=O<<4&240;z+=G&15;A.push(z)}}else{var z=0;if(false&&C===TextModeEditor.Mode.C64MULTICOLOR){for(var U=0;U<8;U++){var H=L*8+U;var N=x.getPixel(B,H,F);var H=L*8+U+1;var W=x.getPixel(B,H,F);if(N==0&&W==1){N=0;W=1}else if(N==1&&W==0){N=1;W=1}else if(N==1&&W==1){N=1;W=0}if(N){z=z|1<<7-U}U++;if(W){z=z|1<<7-U}}}else{for(var U=0;U<8;U++){var H=L*8+U;if(x.getPixel(B,H,F)){z=z|1<<7-U}}A.push(z)}}}}if(n=="c64"){var z=R;if(b.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){z|=128}A.push(z)}for(var X=0;X<A.length;X++){var z=A[X];if(D!==0){g+=","}else{g+=d}if(l=="hex"){g+="$";g+=("00"+z.toString(16)).substr(-2)}if(l=="dec"){g+=z.toString(10)}if(l=="bin"){g+="%";g+=("00000000"+z.toString(2)).substr(-8)}D++;if(D==t){D=0;g+=h}}g+=h}}}g+=h+h}}}var Y=c+" SPRITE IMAGE DATA : "+v+" image";if(v!=1){Y+="s"}var V=v*64;var q=("0000"+V.toString(16)).substr(-4);Y+=" : total size is "+V+" ($"+q+") bytes.";Y+=h+h;g=Y+g;if(typeof e.displayOnly!="undefined"&&e.displayOnly){this.asmEditor.setValue(g,-1)}else{download(g,e.filename+".txt","application/txt")}},download:function(){var e=$("#exportC64SpriteAssemblyAs").val();e+=".txt";var t=this.asmEditor.getValue();download(t,e,"application/txt")},exportC64Assembly:function(e){e.filename=$("#exportC64SpriteAssemblyAs").val();e.type=$("input[name=exportC64SpriteAssemblyType]:checked").val();e.format=$("input[name=exportC64SpriteAssemblyFormat]:checked").val();e.fromFrame=parseInt($("#exportC64SpriteAssemblyFromFrame").val(),10);e.toFrame=parseInt($("#exportC64SpriteAssemblyToFrame").val(),10);e.numberFormat=$("input[name=exportC64SpriteNumberFormat]:checked").val();this.exportC64Format(e)}};var ExportCharPad=function(){this.editor=null};ExportCharPad.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportCharPadDialog",title:"Export CharPad",width:300,height:100});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportCharPad.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportCharPad();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportCharPadDialog")},initContent:function(){this.colorPerMode=this.editor.getColorPerMode();this.blockModeEnabled=this.editor.getBlockModeEnabled();$("#exportCharPadAs").val(g_app.fileManager.filename)},initEvents:function(){var e=this},exportCharPadAs:function(e){var t=this.editor.graphic.getCurrentFrame();if(typeof e.filename=="undefined"){e.filename=g_app.fileManager.filename}if(typeof e.format=="undefined"){e.format="binary"}if(typeof e.layer=="undefined"){e.layer="current"}if(typeof e.fromFrame=="undefined"){e.fromFrame=t}if(typeof e.toFrame=="undefined"){e.toFrame=t}var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){alert("Please choose a grid layer");return}var r=this.editor.graphic.getCurrentFrame();var a=i.getTileSet();var s=i.getBlockModeEnabled();var o=i.getColorPerMode();var l=0;var n=0;var h=0;var d=null;if(s){d=i.getBlockSet();if(d){l=d.getBlockCount();n=i.getBlockWidth();h=i.getBlockHeight()}}var c=[];var f={};var u=a.tileCount;if(o=="character"){for(var p=0;p<u;p++){var v=a.getTileColor(p);c.push({tileSetIndex:p,color:v})}}else if(o=="block"){for(var p=0;p<u;p++){var v=a.getTileColor(p);c.push({tileSetIndex:p,color:0})}}else{for(var p=0;p<u;p++){var v=this.editor.currentTile.getColor();var g=p+"-"+v;f[g]=c.length;c.push({tileSetIndex:p,color:v})}var m=i.getGridWidth();var y=i.getGridHeight();for(var b=0;b<y;b++){for(var C=0;C<m;C++){var x=i.getCell({x:C,y:b,frame:r});var S=x.t;var P=x.fc;var g=S+"-"+P;if(!f.hasOwnProperty(g)){var w=c.length;c.push({tileSetIndex:S,color:P});f[g]=w}}}c.sort(function(e,t){if(e.tileSetIndex!=t.tileSetIndex){return e.tileSetIndex-t.tileSetIndex}return e.color-t.color});f={};for(var p=0;p<c.length;p++){var g=c[p].tileSetIndex+"-"+c[p].color;f[g]=p}}this.data=[];var I=this.data;I.push(67);I.push(84);I.push(77);I.push(5);I.push(i.getBackgroundColor(r));I.push(i.getC64Multi1Color(r));I.push(i.getC64Multi2Color(r));I.push(0);if(o=="cell"||o=="character"){I.push(2)}else if(o=="block"){I.push(1)}else{I.push(0)}var k=0;if(s){k+=1}if(!s){k+=2}if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){k+=4}I.push(k);var M=c.length;M--;I.push(M&255);I.push((M&65280)>>8);var T=0;if(s){T=l}if(T>0){T--}I.push(T&255);I.push((T&65280)>>8);var D=1;var E=1;if(s){D=n;E=h}I.push(D);I.push(E);var m=Math.ceil(i.getGridWidth()/D);var y=Math.ceil(i.getGridHeight()/E);I.push(m&255);I.push((m&65280)>>8);I.push(y&255);I.push((y&65280)>>8);var u=c.length;for(var p=0;p<u;p++){var $=c[p].tileSetIndex;for(var b=0;b<8;b++){var k=0;for(var C=0;C<8;C++){if(a.getPixel($,C,b)){k=k|1<<7-C}}I.push(k)}}for(var p=0;p<u;p++){var _=c[p].color;I.push(_)}console.log("number blocks = "+l+","+h+","+n);for(var p=0;p<l;p++){for(var b=0;b<h;b++){for(var C=0;C<n;C++){var B=d.getCharacterInBlock(p,C,b);I.push(B&255);I.push((B&65280)>>8)}}}if(s&&o=="block"){for(var p=0;p<l;p++){var v=d.getBlockColor(p);I.push(v)}}if(s){var R=n;var A=h;var m=i.getGridWidth();var y=i.getGridHeight();var l=0;for(var b=0;b<y;b+=A){for(var C=0;C<m;C+=R){var x=i.getCell({x:C,y:b,frame:r});var F=x.b;l++;console.log(l+": block index = "+F);I.push(F&255);I.push((F&65280)>>8)}}}else{for(var b=0;b<y;b++){for(var C=0;C<m;C++){var x=i.getCell({x:C,y:b,frame:r});var S=x.t;var v=x.fc;var g=S+"-"+v;if(o=="cell"){S=f[g]}I.push(S&255);I.push((S&65280)>>8)}}}var L=new Uint8Array(I.length);for(var p=0;p<L.length;p++){L[p]=I[p]}var U=e.filename+".ctm";download(L,U,"application/ctm")},exportCharPad:function(){var e={};e.filename=$("#exportCharPadAs").val();console.log("export char pad");this.exportCharPadAs(e)}};var ExportSpritePad=function(){this.editor=null};ExportSpritePad.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportSpritePadDialog",title:"Export SpritePad",width:300,height:100});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportSpritePad.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportSpritePad();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportSpritePadDialog")},initContent:function(){this.colorPerMode=this.editor.getColorPerMode();this.blockModeEnabled=this.editor.getBlockModeEnabled();$("#exportSpritePadAs").val(g_app.fileManager.filename)},initEvents:function(){var e=this},exportSpritePadAs:function(e){var t=this.editor.graphic.getCurrentFrame();if(typeof e.filename=="undefined"){e.filename=g_app.fileManager.filename}if(typeof e.format=="undefined"){e.format="binary"}if(typeof e.layer=="undefined"){e.layer="current"}if(typeof e.fromFrame=="undefined"){e.fromFrame=t}if(typeof e.toFrame=="undefined"){e.toFrame=t}var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){alert("Please choose a grid layer");return}var r=this.editor.graphic.getCurrentFrame();var a=i.getTileSet();var s=i.getBlockModeEnabled();var o=i.getColorPerMode();var l=0;var n=0;var h=0;var d=null;if(s){d=i.getCurrentBlockSet();if(d){l=d.getBlockCount();n=i.getBlockWidth();h=i.getBlockHeight()}}var c=[];var f={};var u=a.tileCount;if(o=="character"){for(var p=0;p<u;p++){var v=a.getTileColor(p);c.push({tileSetIndex:p,color:v})}}else if(o=="block"){for(var p=0;p<u;p++){var v=a.getTileColor(p);c.push({tileSetIndex:p,color:0})}}else{for(var p=0;p<u;p++){var v=this.editor.currentTile.getColor();var g=p+"-"+v;f[g]=c.length;c.push({tileSetIndex:p,color:v})}var m=i.getGridWidth();var y=i.getGridHeight();for(var b=0;b<y;b++){for(var C=0;C<m;C++){var x=i.getCell({x:C,y:b,frame:r});var S=x.t;var P=x.fc;var g=S+"-"+P;if(!f.hasOwnProperty(g)){var w=c.length;c.push({tileSetIndex:S,color:P});f[g]=w}}}c.sort(function(e,t){if(e.tileSetIndex!=t.tileSetIndex){return e.tileSetIndex-t.tileSetIndex}return e.color-t.color});f={};for(var p=0;p<c.length;p++){var g=c[p].tileSetIndex+"-"+c[p].color;f[g]=p}}this.data=[];var I=this.data;I.push(67);I.push(84);I.push(77);I.push(5);I.push(i.getBackgroundColor(r));I.push(i.getC64Multi1Color(r));I.push(i.getC64Multi2Color(r));I.push(0);if(o=="cell"||o=="character"){I.push(2)}else if(o=="block"){I.push(1)}else{I.push(0)}var k=0;if(s){k+=1}if(!s){k+=2}if(this.editor.getScreenMode()===TextModeEditor.Mode.C64MULTICOLOR){k+=4}I.push(k);var M=c.length;M--;I.push(M&255);I.push((M&65280)>>8);var T=0;if(s){T=l}if(T>0){T--}I.push(T&255);I.push((T&65280)>>8);var D=1;var E=1;if(s){D=n;E=h}I.push(D);I.push(E);var m=Math.ceil(i.getGridWidth()/D);var y=Math.ceil(i.getGridHeight()/E);I.push(m&255);I.push((m&65280)>>8);I.push(y&255);I.push((y&65280)>>8);var u=c.length;for(var p=0;p<u;p++){var $=c[p].tileSetIndex;for(var b=0;b<8;b++){var k=0;for(var C=0;C<8;C++){if(a.getPixel($,C,b)){k=k|1<<7-C}}I.push(k)}}for(var p=0;p<u;p++){var _=c[p].color;I.push(_)}console.log("number blocks = "+l+","+h+","+n);for(var p=0;p<l;p++){for(var b=0;b<h;b++){for(var C=0;C<n;C++){var B=d.getCharacterInBlock(p,C,b);I.push(B&255);I.push((B&65280)>>8)}}}if(s&&o=="block"){for(var p=0;p<l;p++){var v=d.getBlockColor(p);I.push(v)}}if(s){var R=n;var A=h;var m=i.getGridWidth();var y=i.getGridHeight();var l=0;for(var b=0;b<y;b+=A){for(var C=0;C<m;C+=R){var x=i.getCell({x:C,y:b,frame:r});var F=x.b;l++;console.log(l+": block index = "+F);I.push(F&255);I.push((F&65280)>>8)}}}else{for(var b=0;b<y;b++){for(var C=0;C<m;C++){var x=i.getCell({x:C,y:b,frame:r});var S=x.t;var v=x.fc;var g=S+"-"+v;if(o=="cell"){S=f[g]}I.push(S&255);I.push((S&65280)>>8)}}}var L=new Uint8Array(I.length);for(var p=0;p<L.length;p++){L[p]=I[p]}var U=e.filename+".ctm";download(L,U,"application/ctm")},exportSpritePad:function(){var e={};e.filename=$("#exportSpritePadAs").val();console.log("export sprite pad");this.exportSpritePadAs(e)}};var ExportSEQ=function(){this.editor=null;this.colors=[144,5,28,159,156,30,31,158,129,149,150,151,152,153,154,155];this.revsOn=18;this.revsOff=146};ExportSEQ.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportSEQDialog",title:"Export SEQ",width:345,height:270});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportSEQ.html",function(){t.initContent()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportSEQ();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)})}else{this.initContent()}UI.setAllowBrowserEditOperations(true);g_app.setAllowKeyShortcuts(false);UI.showDialog("exportSEQDialog")},initContent:function(){$("#exportSEQAs").val(g_app.fileManager.filename)},exportSEQ:function(){var e=$("#exportSEQAs").val();this.exportAs(e)},exportAs:function(e){var t=this.editor.graphic.getCurrentFrame();var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!=="grid"){return}var r=$("#exportSEQClearByte").is(":checked");var a=$("#exportSEQNewG0x40Byte").is(":checked");var s=$("#exportSEQNewLineBytes").is(":checked");var o=$("#exportSEQHeaderBytes").val();var l=$("#exportSEQFooterBytes").val();var n=i.getGridWidth();var h=i.getGridHeight();var d=-1;var c="";var f=n*h*4;var u=new Uint8Array(f);var p=0;var v=false;if(r){u[p++]=147}if(a){u[p++]=142}o=o.split(",");for(var g=0;g<o.length;g++){var m=o[g].trim();var y=false;if(m!=""){if(m[0]=="$"){m=m.substring(1);console.log("parse hex: "+m);y=parseInt(m,16)}else{console.log("parse dec: "+m);y=parseInt(m,10)}console.log("value = "+y);if(!isNaN(y)){u[p++]=y}}}for(var b=0;b<h;b++){for(var C=0;C<n;C++){var x=i.getCell({x:C,y:b,frame:t});var S=x.t;var P=x.fc;if(d!=P){if(P<this.colors.length){u[p++]=this.colors[P]}d=P}if(S>=128){if(!v){v=true;u[p++]=this.revsOn}S-=128}else{if(v){v=false;u[p++]=this.revsOff}}if(S>=0&&S<=31){S+=64}else if(S>=64&&S<=93){S+=32}else if(S==94){S=255}else if(S==95){S+=32}else if(S>=96&&S<=127){S+=64}else if(S>=128&&S<=159){S-=128}else if(S>=192&&S<=223){S-=64}if(S==34){u[p++]=34;u[p++]=20}u[p++]=S;console.log(S)}if(s){u[p++]=141}}l=l.split(",");for(var g=0;g<l.length;g++){var m=l[g].trim();var y=false;if(m!=""){if(m[0]=="$"){m=m.substring(1);y=parseInt(m,16)}else{y=parseInt(m,10)}if(!isNaN(y)){u[p++]=y}}}var f=p;var w=new Uint8Array(f);for(var g=0;g<f;g++){w[g]=u[g]}if(e.indexOf(".seq")==-1){e+=".seq"}download(w,e,"application/seq")}};var ExportX16Basic=function(){this.editor=null};ExportX16Basic.prototype={init:function(e){this.editor=e},start:function(){console.log("export x16 basic start...");var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportX16BasicDialog",title:"Export X16 Basic",width:800,height:600});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportX16Basic.html",function(){t.initContent();t.initEvents()});this.displayButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"/> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.displayButton);this.displayButton.on("click",function(e){t.copyToClipboard()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportX16BasicDialog")},initEvents:function(){},initContent:function(){if(this.basicEditor==null){this.basicEditor=ace.edit("exportX16BasicSource");this.basicEditor.getSession().setTabSize(2);this.basicEditor.getSession().setUseSoftTabs(true);this.basicEditor.on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});this.basicEditor.on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});var e="ace/mode/assembly_6502";if(this.mode=="javascript"){e="ace/mode/javascript"}this.basicEditor.getSession().setMode(e);this.basicEditor.setShowInvisibles(false)}this.generateX16Basic()},copyToClipboard:function(){var e=this.basicEditor.selection.toJSON();this.basicEditor.selectAll();this.basicEditor.focus();document.execCommand("copy");this.basicEditor.selection.fromJSON(e)},getLine:function(e){var t=this.lineNumber+" "+e+"\n";this.lineNumber+=10;return t},toHex:function(e,t){if(t==2){return("00"+e.toString(16)).substr(-2).toUpperCase()}return("0000"+e.toString(16)).substr(-4).toUpperCase()},generateX16Basic:function(){var e=this.editor.tileSetManager;var t=this.editor.colorPaletteManager;var i=t.getCurrentColorPalette();var r=i.getColorCount();var a=this.editor.layers.getSelectedLayerObject();var s=128;var o=a.getGridWidth();var l=a.getGridHeight();var n=a.getTileSet();var h=n.getTileWidth();var d=n.getTileHeight();var c=n.getTileCount();var f=0;var u=40;var p=25;var v=p*u*2;var g=v-1;var m=u*2;var y=m-1;var b=l-1;var C=0;var x=s*2;this.lineNumber=10;var S="";S+=this.getLine("REM LVLLVL OUTPUT");S+=this.getLine("REM SET THE MODE TO MODE 0, AND LAYER 0 ENABLED");var P=1+(f<<5);S+=this.getLine("VPOKE $F,$2000,$"+this.toHex(P,2));S+=this.getLine("REM SWITCH TO 40 CHARACTER MODE");S+=this.getLine("IF PEEK($D9) <> 40 THEN SYS $FF5F");S+=this.getLine("REM CLEAR THE SCREEN");S+=this.getLine("PRINT CHR$(147)");var w=r*2;var I=w-1;S+=this.getLine("REM SET THE COLOUR PALETTE");S+=this.getLine("FOR I = 0 TO "+I);S+=this.getLine("READ D");S+=this.getLine("VPOKE $F,$1000+I,D");S+=this.getLine("NEXT");var k=c*8;var M=k-1;S+=this.getLine("REM SET THE TILES");S+=this.getLine("FOR I = 0 TO "+M);S+=this.getLine("READ D");S+=this.getLine("VPOKE $1,$F000+I,D");S+=this.getLine("NEXT");S+=this.getLine("REM SET THE MAP");S+=this.getLine("RADDR=0");S+=this.getLine("FOR ROW=0 TO "+b);S+=this.getLine("FOR COL=0 TO "+y);S+=this.getLine("READ D");S+=this.getLine("VPOKE 0,RADDR+COL,D");S+=this.getLine("NEXT COL");S+=this.getLine("RADDR = RADDR + "+x);S+=this.getLine("NEXT ROW");S+=this.getLine("GOTO "+this.lineNumber);var T="";var D=16;var E=0;S+=this.getLine("REM COLOR PALETTE");E=0;for(var $=0;$<r;$++){var _=i.getHex($);var B=_>>>20&15;var R=_>>>12&15;var A=_>>>4&15;var F=(R<<4)+A;var L=B;if(E!==0){T+=","}else{T+="DATA "}T+="$";T+=this.toHex(F,2);T+=",";T+="$";T+=this.toHex(L,2);E+=2;if(E>=D||$==r-1){E=0;S+=this.getLine(T);T=""}}S+=this.getLine("REM TILE DATA");T="";for(var U=0;U<c;U++){for(var H=0;H<d;H++){var A=0;for(var O=0;O<h;O++){if(n.getPixel(U,O,H)){A=A|1<<7-O}}if(E!==0){T+=","}else{T+="DATA "}T+="$";T+=this.toHex(A,2);E++;if(E==D){E=0;S+=this.getLine(T);T=""}}}S+=this.getLine("REM SCREEN DATA");T="";for(var H=0;H<p;H++){for(var O=0;O<u;O++){var G=a.getCell({x:O,y:H});var z=G.fc;if(G.bc!==this.editor.colorPaletteManager.noColor){z+=G.bc<<4}if(E!==0){T+=","}else{T+="DATA "}T+="$";T+=this.toHex(G.t,2);T+=",";T+="$";T+=this.toHex(z,2);E+=2;if(E>=D){E=0;S+=this.getLine(T);T=""}}}this.basicEditor.setValue(S,-1)}};var C64ASMScroll="*=$801\nbasic_start_code\n!byte    $0B, $08, $0A, $00, $9E, $32, $30, $38, $30, $00, $00, $00\n\n\n; zero page \ncopy_from_low           = $4d\ncopy_from_high          = $4e\n\ncopy_to_low             = $4f\ncopy_to_high            = $50\n\nframe_finished          = $51\n\nback_buffer_high        = $52\nfront_buffer_high       = $53\n\nframe_ptr_low           = $54\nframe_ptr_high          = $55\n\ndelay_counter           = $56\n\ntemp                    = $57\nch1_in_new_note         = $58\nch2_in_new_note         = $59\nch3_in_new_note         = $5a\ntick                    = $5c\n\ntemp_low                = $5d\ntemp_high               = $5e\ncheck_keys_enabled      = $5f\nkey_table_low           = $60\nkey_table_high          = $61\ncheck_instr_enabled     = $62\ninstr_table_low         = $63\ninstr_table_high        = $64\n\ntrig                    = $65\nvertical_scroll         = $66\nvertical_char_offset_high = $67\nvertical_char_offset_low  = $68\n\n\n; frame info..\nfirst_frame_low             = $0be8\nfirst_frame_high            = $0be9\n\nnext_char_frame_type        = $0bea\nnext_char_frame_addr_low    = $0beb\nnext_char_frame_addr_high   = $0bec\nnext_char_frame_delay       = $0bed\nnext_color_frame_type       = $0bee\nnext_color_frame_addr_low   = $0bef\nnext_color_frame_addr_high  = $0bf0\nnext_color_frame_bg1        = $0bf1\nnext_color_frame_bg2        = $0bf2\nnext_color_frame_bg3        = $0bf3\nnext_color_frame_bg4        = $0bf4\n\n\n; need to store location of current frame info for scroll routine\ncurrent_char_frame_addr_low    = $0bf5\ncurrent_char_frame_addr_high   = $0bf6\ncurrent_color_frame_addr_low   = $0bf7\ncurrent_color_frame_addr_high  = $0bf8\n\nch1_newnote                 = $1485\nch1_tempo                   = $149a\nch1_counter                 = $149b\nch1_note                    = $149c\nch1_instr                   = $149d\nch1_gate                    = $149e\n\nch2_tempo                   = $14a1\nch2_counter                 = $14a2\nch2_note                    = $14a3\nch2_instr                   = $14a4\nch2_gate                    = $14a5\n\nch3_tempo                   = $14a8\nch3_counter                 = $14a9\nch3_note                    = $14aa\nch3_instr                   = $14ab\nch3_gate                    = $14ac\n\n; config\n*= $0810\nconfig_values\n\nborder_color\n;        BYTE   $02    \n!byte   $02     \nextended_color_mode\n;        BYTE   $01\n!byte   $00\ncustom_chars \n;        BYTE   $00\n!byte   $00\n\nsid \n;        BYTE   $00\n!byte   $00\n\nsidspeed\n;        BYTE   $01\n!byte   $01\n\nsid_init_addr_low\n;        BYTE   $03\n!byte   $00\nsid_init_addr_high\n;        BYTE   $10\n!byte   $10\n\nsid_play_addr_low\n;        BYTE   $12\n!byte   $03\nsid_play_addr_high\n;        BYTE   $10\n!byte   $10\n\n\nframe_ptr_start_low\n;        BYTE   $00\n!byte   $00\nframe_ptr_start_high\n;        BYTE   $80\n!byte   $80\n\n\n; init code, only run once\n*= $0820\ninit_code\n        ;$01=$36 -> RAM       visible A000-C000, IO visible at D000-E000, Kernal Rom Visible at E000-FFFF\n        lda #$36        ; $36 = 0011 0110\n        sta $01         ; RAM visible at $A000-$BFFF; KERNAL ROM visible at $E000-$FFFF, I/O area visible at $D000-$DFFF. \n\n        ; store location of frame ptrs\n        lda frame_ptr_start_low\n        sta first_frame_low\n        \n        lda frame_ptr_start_high\n        sta first_frame_high\n\n\n        lda border_color\n        sta $d020       ; border color\n\n        lda extended_color_mode\n        cmp #$01\n        bne setup_custom_chars\n\nsetup_extended_color_mode\n        lda $d011    ; turn on extended color mode\n        ora #$40\n        sta $d011\n\nsetup_custom_chars\n\n        lda custom_chars\n        cmp #$01\n        bne setup_sid\n\n        lda $d018       \n        ora #$0e\n        sta $d018\n\nsetup_sid\n\n        lda sid\n        cmp #$01\n        bne disable_sid\n\n        lda sid_init_addr_low\n        sta sid_init_jsr+1\n        lda sid_init_addr_high\n        sta sid_init_jsr+2\n\n        lda sid_play_addr_low\n        sta sid_play_jsr+1\n        lda sid_play_addr_high\n        sta sid_play_jsr+2\n\n        lda sidspeed\n        cmp #$01\n        beq disable_sid_speed2\n\n        lda sid_play_addr_low\n        sta sid_play_jsr2+1\n        lda sid_play_addr_high\n        sta sid_play_jsr2+2\n\n        jmp setup_screen\n\ndisable_sid\n        ; put NOP in the sid init and play instructions\n        lda #$ea \n        sta sid_init_jsr\n        sta sid_init_jsr+1\n        sta sid_init_jsr+2\n\n        sta sid_play_jsr\n        sta sid_play_jsr+1\n        sta sid_play_jsr+2\n\ndisable_sid_speed2\n        lda #$ea \n        sta sid_play_jsr2\n        sta sid_play_jsr2+1\n        sta sid_play_jsr2+2\n\n\nsetup_screen\n        ; set the screen location to 0400    xxx1 xxxx\n        lda $d018\n        and #$0f                  \n        ora #$10                  \n        sta $d018\n\n        ; front buffer is 0400, back buffer is 0800\n        lda #$04\n        sta front_buffer_high\n        lda #$08\n        sta back_buffer_high\n\n        ; turn off multicolor mode\n        lda $d016\n        and #$ef\n        sta $d016\n\n\n        lda #$00\n        sta ch1_in_new_note\n        sta ch2_in_new_note\n        sta ch3_in_new_note\n\n        ;; init effects\n        sta check_keys_enabled\n        sta check_instr_enabled\n\n\t\t\t\tjsr init_effects\n        \n        ; init vertical scroll\n        ; turn on 24 rows\n        lda $d011\n        and #$f0\n        sta $d011\n\n\t\t\t\t; initial scroll is 7\n        lda #$07\n        sta vertical_scroll\n\n\t\t\t\tlda #$00\n        sta vertical_char_offset_high\n        lda #$00\n\t\t\t\tsta vertical_char_offset_low\n        \n        \n        jmp start\n\n\n;-------------- end if init code ---------------\n\n\n\n\n\n*=$0c00\nstart\n        lda first_frame_low\n        sta frame_ptr_low\n        lda first_frame_high\n        sta frame_ptr_high\n\n        ; load first frame into back buffer\n        jsr get_next_frame_info\n        jsr tick2\n        lda #$01\n        sta delay_counter\n\n\n        sei             ;disable maskable IRQs\n\n        lda #$00        ; sid tune 0\nsid_init_jsr\n        jsr $1000       ;init_sid\n\n        lda #$7f\n        sta $dc0d  ;disable timer interrupts which can be generated by the two CIA chips\n        sta $dd0d  ;the kernal uses such an interrupt to flash the cursor and scan the keyboard, so we better\n                   ;stop it.\n\n        lda $dc0d  ;by reading this two registers we negate any pending CIA irqs.\n        lda $dd0d  ;if we don't do this, a pending CIA irq might occur after we finish setting up our irq.\n                   ;we don't want that to happen.\n\n        lda #$01   ;this is how to tell the VICII to generate a raster interrupt\n        sta $d01a\n\n        lda #$ff   ;this is how to tell at which rasterline we want the irq to be triggered\n        sta $d012\n\n        lda $d011  ;as there are more than 256 rasterlines, the topmost bit of $d011 serves as\n        and #$7f   ;the 8th bit for the rasterline we want our irq to be triggered.               \n        sta $d011  ;clear it\n                   \n\n        lda #$35   ;we turn off the BASIC and KERNAL rom here\n        sta $01    ;the cpu now sees RAM everywhere except at $d000-$e000, where still the registers of\n                   ;SID/VICII/etc are visible\n\n        lda #<irq  ;this is how we set up\n        sta $fffe  ;the address of our interrupt code\n        lda #>irq\n        sta $ffff\n\n        cli        ;enable maskable interrupts again\n\n    \nloop\n        jmp loop\n\n\n        ; ---------------------interrupt start--------------------------------------------\nirq =*\n\n        pha        ;store register A in stack\n        txa\n        pha        ;store register X in stack\n        tya\n        pha        ;store register Y in stack\n\n; 0c51\n\n        lda #$ff   ;this is the orthodox and safe way of clearing the interrupt condition of the VICII.\n        sta $d019  ;if you don't do this the interrupt condition will be present all the time and you end\n                   ;up having the CPU running the interrupt code all the time, as when it exists the\n                   ;interrupt, the interrupt request from the VICII will be there again regardless of the\n                   ;rasterline counter.\n\n                   ;it's pretty safe to use inc $d019 (or any other rmw instruction) for brevity, they\n                   ;will only fail on hardware like c65 or supercpu. c64dtv is ok with this though.\n;        inc $d020\n\nsid_play_jsr\n        jsr $1012       ; play sid\n\n\n        lda tick                ; cant do trigger stuff if just ticked.\n        beq goto_play_frames\n\n        lda check_keys_enabled\n        beq instrument_triggers    ; if lda is 0, zero flag is set\n\n        jsr check_keys\n\ninstrument_triggers\n        lda check_instr_enabled\n        beq goto_play_frames\n\n        jsr check_instrument\n\ngoto_play_frames\n        jsr play_frames\n\n\nwait_for_raster\n        lda $d011\n        and #$80    ; zero flag is set if zero\n        bne wait_for_raster\n\n        lda $d012\n        cmp #$80\n        bcc wait_for_raster\n\nsid_play_jsr2\n        jsr $1012\n\n;        dec $d020\nirqout\n        pla\n        tay        ;restore register Y from stack (remember stack is FIFO: First In First Out)\n        pla\n        tax        ;restore register X from stack\n        pla        ;restore register A from stack\n\n        rti        ;Return From Interrupt, this will load into the Program Counter register the address\n                   ;where the CPU was when the interrupt condition arised which will make the CPU continue\n                   ;the code it was interrupted at also restores the status register of the CPU\n\n;-----------------------------------------------------------\nplay_frames\n\n\t\t\t\tjsr vertical_scroll_up\n        \n;        rts\n        \n        ; delay counter was initialised to number of ticks the current frame is to be displayed for\n        dec delay_counter\n        bne ticks ; counter not zero yet, do ticks\n\n\n        ; frame has finished, reset tick counter\n        lda #$00\n        sta tick\n\n        ; delay is zero, display the next frame...\n        jmp display_next_frame\n\nticks\n\n\t\t\t\t; call any effects routines that need to update each on tick\n\t\t\t\tjsr effects_tick\n        \n        inc tick\n        lda tick\n        cmp #$01        ;  start preparing for next frame\n        bne tick2test\n        jmp get_next_frame_info\ntick2test        \n        cmp #$02        ;  start preparing for next frame\n        bne tick3test\n        jmp tick2\ntick3test\n        cmp #$03        ;  start preparing for next frame\n        bne tick4test\n        jmp tick3\ntick4test\n        cmp #$04        ;  start preparing for next frame\n        bne tick5test\n        jmp tick4\ntick5test\n        cmp #$05        ;  start preparing for next frame\n        bne tickgreater5\n        jmp tick5\ntickgreater5\n        rts\n\ndisplay_next_frame\n        lda next_char_frame_delay\n        sta delay_counter\n\n;        jsr swap_buffers\n\n        ; update colors...\n;        lda next_color_frame_bg1\n;        sta $d021       ; background color\n;        lda next_color_frame_bg2\n;        sta $d022       ; background color\n;        lda next_color_frame_bg3\n;        sta $d023       ; background color\n;        lda next_color_frame_bg4\n;        sta $d024       ; background color\n\n\n\t\t\t\t; update current pointer to the next pointers\n\t\t\t\tlda next_char_frame_addr_low\n        sta current_char_frame_addr_low\n        lda next_char_frame_addr_high\n        sta current_char_frame_addr_high\n\n        lda next_color_frame_addr_low\n        sta current_color_frame_addr_low\n        lda next_color_frame_addr_high\n        sta current_color_frame_addr_high\n\n\n\n        ; copy color data\n        lda next_color_frame_addr_low\n        sta copy_from_low\n        lda next_color_frame_addr_high\n        sta copy_from_high\n\n        lda #$00\n        sta copy_to_low\n        lda #$d8\n        sta copy_to_high\n\n\n        lda next_color_frame_type\n        cmp #$01\n        beq whole_frame_color_type             \n\n        ; just copy color changes\n        jsr data_changes\n        jmp read_effects        ; read the effects for this frame\n;        rts \n\nwhole_frame_color_type\n\n\t\t\t\t; set the offset into the data for vertical scroll\n\t\t\t\tclc\n        lda copy_from_low\n        adc vertical_char_offset_low\n        sta copy_from_low\n        \n        lda copy_from_high\n        adc vertical_char_offset_high\n        sta copy_from_high\n\n\n;        jsr copy_data\n        jmp read_effects         ; read the effects for this frame\n\n\n        \n        \n;        rts\n\ncheck_trigger_table\n\n        ldy #$00    ; going to use y to loop through keys\n\n        \ncheck_trigger_loop\n\n\n        lda (temp_low),y    ; load in the test key\n        \n        cmp #$00              ; have we reached end of table?\n        beq check_trigger_done   ; reached end, so exit\n\n        iny\n        iny\n        iny\n        iny\n\n        cmp trig            ; check test key against key pressed\n        bne check_trigger_loop\n\n        ; found trigger !\n\n        dey \n        dey\n        dey\n\n        lda (temp_low),y\n        jsr effects_trigger\n\n        lda (temp_low),y\n        beq trigger_goto_frame\n\n        cmp #$02\n        beq switch_charset\n\n\t\t\t\tcmp #$01\n        beq force_next_frame\n        rts\n        \nforce_next_frame        \n        lda #$04\n        sta delay_counter\n;        sta force_next_frame\n        rts\n\nswitch_charset\n        iny\n        lda $d018\n        and #$f1\n        ora (temp_low),y\n        sta $d018\n        rts        \n\ntrigger_goto_frame\n        iny\n        lda (temp_low),y\n        sta frame_ptr_low\n        iny\n\n        lda (temp_low),y\n        sta frame_ptr_high\n\n\n        ; set this as tick 1 so the char data will be copied\n        lda #$00\n        sta tick\n\n\n        ; make the delay counter 4 so the next frame will be disp next tick\n        ;lda #$05\n        lda #$03\n        sta delay_counter\ncheck_trigger_done\n        rts\n\ncheck_keys\n\n        lda #00\n        jsr scan_key\n        sta trig                 ; store the key to check in temp\n\n        lda key_table_low        ; load in pointer to keys table\n        sta temp_low\n        lda key_table_high\n        sta temp_high\n        jsr check_trigger_table\n\n\ncheck_keys_done\n\n\n        rts\n\ncheck_instrument\n\n        lda ch1_newnote\n        cmp #$00\n        beq reset_ch1_new_note\n\n        lda ch1_in_new_note\n        cmp #$00\n        bne ch1nextchannel\n\n        lda #$01\n        sta ch1_in_new_note\n\n        lda ch1_instr\n\n        sta trig                 ; store the instrument to check in temp\n\n        lda instr_table_low        ; load in pointer to keys table\n        sta temp_low\n        lda instr_table_high\n        sta temp_high\n\n\n        jsr check_trigger_table\n\n        rts\n\nreset_ch1_new_note\n        lda #$00\n        sta ch1_in_new_note\n\nch1nextchannel    \n\n        rts\n\nget_next_frame_info\n        ldy #$00\n        lda (frame_ptr_low),y\n\n        ; #$00 indicates a jump\n        cmp #$00\n        bne get_next_frame_info1\n\n        ; next two bytes are where to jump to\n        iny\n        lda (frame_ptr_low),y\n        sta temp  ;frame_ptr_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta frame_ptr_high\n\n        lda temp\n        sta frame_ptr_low\n\n        ldy #$00\n\n        lda (frame_ptr_low),y\n\nget_next_frame_info1\n\n        ; read in the next frames info\n\n        sta next_char_frame_type\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_char_frame_addr_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_char_frame_addr_high\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_char_frame_delay\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_type\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_addr_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_addr_high\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_bg1\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_bg2\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_bg3\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_bg4\n\n        ; add y accumulator to frame_ptr\n        tya\n        clc                    ; clear carry\n        adc frame_ptr_low              \n        sta frame_ptr_low\n\n        lda frame_ptr_high     ; add 0 with carry to higher byte \n        adc #00\n        sta frame_ptr_high\n\n        lda next_char_frame_type  ; if its the whole frame type, then we're done\n        cmp #$01\n        bne setup_change_frame_type\n        rts\n\nsetup_change_frame_type\n        ; its changes, so need to copy to back buffer\n        jsr copy_front_to_back_buffer\n\n        rts\n\nread_effects\n        ldy #$00\n        ; effects\nread_effects_loop\n        iny\n        lda (frame_ptr_low),y\n\n        ; #$00 means no effects \n        cmp #$00\n        beq frame_info_end\n\n        cmp #$01\n        bne frame_effect_2\n\n        ; enable check keys\n        lda #$01\n        sta check_keys_enabled\n\n        iny\n        lda (frame_ptr_low),y\n        sta key_table_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta key_table_high\n\n        jmp read_effects_loop\n\nframe_effect_2\n        cmp #$02\n        bne frame_effect_3\n\n        ; disable check keys\n        lda #$00\n        sta check_keys_enabled\n        jmp read_effects_loop\n\nframe_effect_3\n        cmp #$03\n        bne frame_effect_4\n\n        ; enable check instr\n        lda #$01\n        sta check_instr_enabled\n\n        iny\n        lda (frame_ptr_low),y\n        sta instr_table_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta instr_table_high\n\n        jmp read_effects_loop\n\n\n\nframe_effect_4\n        cmp #$04\n        bne frame_effect_5\n\n        ; disable check instruments\n        lda #$00\n        sta check_instr_enabled\n        jmp read_effects_loop\n\nframe_effect_5\n\nframe_info_end\n        iny \n\n        ; add y accumulator to frame_ptr\n        tya\n\n;        sta $d020\n\n        clc                    ; clear carry\n        adc frame_ptr_low                ; add 40 with carry to lower byte\n        sta frame_ptr_low\n\n        lda frame_ptr_high     ; add 0 with carry to higher byte \n        adc #00\n        sta frame_ptr_high\n        rts        \ntick2\n        ; load in location of character data\n        lda next_char_frame_addr_low\n        sta copy_from_low\n        lda next_char_frame_addr_high\n        sta copy_from_high\n\n        lda #$00\n        sta copy_to_low\n        lda back_buffer_high\n        sta copy_to_high\n\n\n        ; check what type of frame it is..\n        lda next_char_frame_type\n        cmp #$01\n        beq full_frame_type\n\n        cmp #$02\n        beq changes_frame_type\n\n        ; rle data\n        jsr copy_rle_data\n        rts\n\nchanges_frame_type\n        ; its changes, \n        lda #$00\n        sta frame_finished\n\n        jsr data_changes\n        rts\n\n\nfull_frame_type\n        ; copy all chars to back buffer\n\n\t\t\t\t; set the offset into the data for vertical scroll\n\t\t\t\tclc\n        lda copy_from_low\n        adc vertical_char_offset_low\n        sta copy_from_low\n        \n        lda copy_from_high\n        adc vertical_char_offset_high\n        sta copy_from_high\n        \n\n;        jsr copy_data\n\n        lda #$01\n        sta frame_finished   ; this frame's data is over..\n        rts\n\ntick3\n\n        ; if not finished with changes, continue updating\n        lda frame_finished  ; finished copying frame data ?\n        cmp #$00\n        bne tick3done\n\n        jsr data_changes\n\ntick3done\n        rts\n\ntick4\n        lda frame_finished  ; finished copying frame data ?\n        cmp #$00\n        bne tick4done\n\n        jsr data_changes\n\ntick4done\n        rts\ntick5\n        rts\n\n\n;------------ end of play frames...\n\ncopy_front_to_back_buffer\n\n        ; copy front buffer to back buffer\n        lda #$00\n        sta copy_from_low\n        lda front_buffer_high\n        sta copy_from_high\n\n        lda #$00\n        sta copy_to_low\n        lda back_buffer_high\n        sta copy_to_high\n\n        jsr copy_data\n\n        rts\n\n\nswap_buffers\n        ldx back_buffer_high         ; load value of current back buffer\n        cpx #$04                     ; is it 0400\n        bne swap_buffers_1\n\n        ; set front buffer to 0400, back buffer to 0800\n        lda #$04\n        sta front_buffer_high\n        lda #$08\n        sta back_buffer_high\n\n        ; set screen location to $0400\n        lda $d018\n        and #$0f\n        ora #$10\n        sta $d018\n\n        rts\n\nswap_buffers_1\n        ; set front buffer to 0800, back buffer to 0400\n        lda #$08\n        sta front_buffer_high\n        lda #$04\n        sta back_buffer_high\n\n        ; set screen location to $0800\n        lda $d018\n        and #$0f\n        ora #$20\n        sta $d018\n\n        rts\n\n\ncopy_data\n;        ldy xoffset\n        ldy #$0\n        ldx #25    ; number of lines to copy\n\n\ncopy_data_line\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n\n        cpy #40                 ; have we copied 40 chars? (10x4)\n        bne copy_data_line\n        \n        dex\n        beq copy_data_done\n        \n        ldy #0                  ; back to start of line\n\n\n        ; increase where copy from by 40\n        clc                    ; clear carry\n        lda copy_from_low\n        adc FRAMEWIDTHLOW                ; add FRAMEWIDTH with carry to lower byte\n        sta copy_from_low\n\n        lda copy_from_high     ; add 0 with carry to higher byte \n        adc FRAMEWIDTHHIGH\n        sta copy_from_high\n\n\n        ; increase where copy to by 40\n        clc                     ; clear carry\n        lda copy_to_low\n        adc #40                 ; add 40 with carry to lower byte\n        sta copy_to_low\n\n        lda copy_to_high        ; add 0 with carry to higher byte \n        adc #00\n        sta copy_to_high\n\n        jmp copy_data_line\n\ncopy_data_done\n\n        rts \n\n\n\n\n\ncopy_rle_data\n        ldy #00\n\n        lda (copy_from_low),y\n        bne continue_rle\n\n        ; reached the end of the data\n        lda #$01\n        sta frame_finished\n\n        rts\n\ncontinue_rle\n        tax\n\n        inc copy_from_low\n        bne rle_get_byte\n        inc copy_from_high\n\nrle_get_byte\n        lda (copy_from_low),y\n        inc copy_from_low\n        bne write_rle_byte\n        inc copy_from_high\n\n\nwrite_rle_byte        \n        sta (copy_to_low),y\n        iny\n        dex\n        bne write_rle_byte\n\n        tya\n\n        clc\n        adc copy_to_low\n        sta copy_to_low\n\n        lda copy_to_high\n        adc #$00\n        sta copy_to_high\n\n        jmp copy_rle_data\n\n\n\n\n; data changes are list:  offset, change, offset, change, ends in 00\ndata_changes\n        ldx #$00\n\n        ldy #$00\n        lda (copy_from_low),y      ; load the first offset\n\nnext_change              \n        ; add the offset to buffer ptr\n        clc\n        adc copy_to_low\n\n        sta copy_to_low\n        lda copy_to_high\n        adc #$00\n        sta copy_to_high\n\n\n        ; increase the pointer to the change data\n        inc copy_from_low     ; zero flag will be set if result is zero\n        bne get_change\n        inc copy_from_high\nget_change\n\n\n\n        lda (copy_from_low),y      ; load the character\n        sta (copy_to_low),y \n\n\n        ; increase the pointer to the change data\n        inc copy_from_low           ; zero flag will be set if result is zero\n        bne get_offset\n        inc copy_from_high\n\nget_offset         \n        lda (copy_from_low),y\n\n        cmp #$0                     ; sequence ends with a 0 offset\n        beq changes_done\n\n\n        inx\n        cpx #$ff                    ; only do up to 255 changes\n        bne next_change\n\n        ; reached max number of changes for this refresh... mark as not finished yet\n        lda #$00\n        sta frame_finished\n        rts\n\nchanges_done        \n        \n        lda #$01                        ; mark frame as finished..\n        sta frame_finished\n\n        rts\n\n\n*= $4000\nscan_key\n\n;    inc $d020\n\n    ;; set up the data direction registers\n    lda #$0\n    sta $dc03   ; port b ddr (input)\n    lda #$ff\n    sta $dc02   ; port a ddr (output)\n            \n    ; set which row being checked\n    lda #$00\n    sta $dc00   ; port a\n\n    lda $dc01\n    sta $11\n\n    ; get column information\n    lda $dc01       ; port b\n\n    cmp #$ff\n    beq nokey\n\n    ; got column\n    tay\n    \n\n    ; first row to test        \n    lda #$7f      ;  0111 1111\n    sta nokey2+1\n\n    ; going to check 8 rows\n    ldx #8\nnokey2\n    ;; this location has the row to check\n    lda #0\n    sta $dc00   ; port a\n    \n    ; set the carry flag\n    sec\n    ; set next row to check\n    ror nokey2+1\n\n    ; checked all rows yet?\n    dex\n    ; branch if minus\n    bmi nokey\n\n    ; get column information\n    lda $dc01       ; port b\n    cmp #$ff\n    beq nokey2\n            \n    ; got row in X\n    txa\n    sta $12\n    ora columntab,y\n\n    sta $10\n\n    sec\n    \n;    dec $d020\n    rts\n            \nnokey\n    clc\n;    dec $d020\n    lda #$0\n    sta $10\n\n    rts\n\n\ncolumntab\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$70\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$60\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$50\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$40\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$30\n!byte $ff,$ff,$ff,$20,$ff,$10,$00,$ff\n\n\nvertical_scroll_up\n\n\t; display delay counter for info\n\tlda delay_counter\n;  sta $440\n;  sta $840\n\n\t; scroll up by one pixel\n  dec vertical_scroll\n  \n  ; set the scroll register\n  lda $d011\n  ; dont want to 'and' the position of the raster, so dont use bit 7\n  and #$70\n  ora vertical_scroll\n  sta $d011\n  \n\n\t; check if need to update the offsets\n  lda vertical_scroll\n  cmp #$00\n  bne check_delay_counter0\n  \n  \n  ; reset vertical scroll\n  lda #$08\n  sta vertical_scroll\n  \n  ; on last pixel of current character\n\n\t; update offset into map\n  clc\n  lda vertical_char_offset_low\n  adc FRAMEWIDTHLOW\n  sta vertical_char_offset_low\n  \n  lda vertical_char_offset_high\n  adc FRAMEWIDTHHIGH\n  sta vertical_char_offset_high\n  \n  \n  ;; need to reset it?\n  lda vertical_char_offset_high\n  cmp VERTICALSCROLLMAXHIGH\n  bne check_delay_counter0\n  \n  lda vertical_char_offset_low\n  cmp VERTICALSCROLLMAXLOW\n  bne check_delay_counter0\n  \n  lda #$00\n  sta vertical_char_offset_high\n  sta vertical_char_offset_low\n  \n  \n\n\ncheck_delay_counter0\n\n  lda delay_counter\n  cmp #$02\n  bne check_delay_counter1\n  \n  \n  ; workaround\n\tlda vertical_scroll\n  cmp #$07\n  bne continue_check_delay_counter0\n  lda #$00\n  sta vertical_scroll\n  \n  \n  ; set the scroll register\n  lda $d011\n  ; dont want to 'and' the position of the raster, so dont use bit 7\n  and #$70\n  ora vertical_scroll\n  sta $d011\n  \n  lda #$08\n  sta vertical_scroll\n\ncontinue_check_delay_counter0  \n\n\n  ; delay counter is 2, next frame will be displayed next time\n  \n  lda next_char_frame_addr_low\n  sta copy_from_low\n  lda next_char_frame_addr_high\n  sta copy_from_high\n  \n  jmp scroll_copy_to_back_buffer\n    \n  \ncheck_delay_counter1  \n  lda delay_counter\n  cmp #$01\n  bne check_vertical_scroll1\n    \n    \n\n  lda next_color_frame_bg1\n  sta $d021       ; background color\n  lda next_color_frame_bg2\n  sta $d022       ; background color\n  lda next_color_frame_bg3\n  sta $d023       ; background color\n  lda next_color_frame_bg4\n  sta $d024       ; background color\n\n\n\n\n  ; copy color data\n  lda next_color_frame_addr_low\n  sta copy_from_low\n  lda next_color_frame_addr_high\n  sta copy_from_high\n\n\tjmp scroll_swap_buffers\n  \n  \n  \ncheck_vertical_scroll1\n\tlda vertical_scroll\n  cmp #$08\n  bne check_vertical_scroll2\n  \n  ; need to copy into back buffer\n  ; load in location of current character data\n  lda current_char_frame_addr_low\n  sta copy_from_low\n  lda current_char_frame_addr_high\n  sta copy_from_high\n  \n\nscroll_copy_to_back_buffer\n  ; copy to the back buffer\n  lda #$00\n  sta copy_to_low\n  lda back_buffer_high\n  sta copy_to_high\n\n  ; need to add in the offset\n  clc\n  lda copy_from_low\n  adc vertical_char_offset_low\n  sta copy_from_low\n        \n  lda copy_from_high\n  adc vertical_char_offset_high\n  sta copy_from_high\n       \n       \n  ; copy the data\n  jsr copy_data\n\n\trts\n  \n  \n  \ncheck_vertical_scroll2\n\tlda vertical_scroll\n  cmp #$07\n  bne vertical_scroll_done\n  \n  ; need to swap buffers and copy color data\n  lda current_color_frame_addr_low\n  sta copy_from_low\n  lda current_color_frame_addr_high\n  sta copy_from_high\n  \n\nscroll_swap_buffers\n  ; start of new character, need to swap buffers\n  jsr swap_buffers\n\n\t; copying to color buffer\n  lda #$00\n  sta copy_to_low\n  lda #$d8\n  sta copy_to_high\n\n  ; set the offset into the data for vertical scroll\n  clc\n  lda copy_from_low\n  adc vertical_char_offset_low\n  sta copy_from_low\n        \n  lda copy_from_high\n  adc vertical_char_offset_high\n  sta copy_from_high\n\n  jsr copy_data\n\n\n  rts\n  \n  \n  \nvertical_scroll_done  \n  rts\n  \ncopy_data_4bit\n        ldy #0\n        ldx #25\n\ncopy_data_4bit_line\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y \n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n;        lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n        ;lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n        ;lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n        ;lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n        ;lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n\n        cpy #40                 ; have we copied 40 chars? (10x4)\n        bne copy_data_4bit_line\n        \n        dex\n        beq copy_data_4bit_done\n        \n        ldy #0                  ; back to start of line\n\n\n        ; increase where copy from by 40\n        clc                    ; clear carry\n        lda copy_from_low\n        adc #40                ; add 40 with carry to lower byte\n        sta copy_from_low\n\n        lda copy_from_high     ; add 0 with carry to higher byte \n        adc #00\n        sta copy_from_high\n\n\n        ; increase where copy to by 40\n        clc                     ; clear carry\n        lda copy_to_low\n        adc #40                 ; add 40 with carry to lower byte\n        sta copy_to_low\n\n        lda copy_to_high        ; add 0 with carry to higher byte \n        adc #00\n        sta copy_to_high\n\n        jmp copy_data_4bit_line\n\ncopy_data_4bit_done\n\n        rts \n\n\ninit_effects\n\trts\n  \n\n";var C64ASMSource="*=$801\nbasic_start_code\n!byte    $0B, $08, $0A, $00, $9E, $32, $30, $38, $30, $00, $00, $00\n\n; zero page \ncopy_from_low           = $4d\ncopy_from_high          = $4e\n\ncopy_to_low             = $4f\ncopy_to_high            = $50\n\nframe_finished          = $51\n\nback_buffer_high        = $52\nfront_buffer_high       = $53\n\nframe_ptr_low           = $54\nframe_ptr_high          = $55\n\ndelay_counter           = $56\n\ntemp                    = $57\nch1_in_new_note         = $58\nch2_in_new_note         = $59\nch3_in_new_note         = $5a\ntick                    = $5c\n\ntemp_low                = $5d\ntemp_high               = $5e\ncheck_keys_enabled      = $5f\nkey_table_low           = $60\nkey_table_high          = $61\ncheck_instr_enabled     = $62\ninstr_table_low         = $63\ninstr_table_high        = $64\n\ntrig                    = $65\n\ncopy_from_low2           = $66\ncopy_from_high2          = $67\n\ncopy_to_low2             = $68\ncopy_to_high2            = $69\n\n; frame info.. can fit this in just after init code\nfirst_frame_low             = $0be8\nfirst_frame_high            = $0be9\n\nnext_char_frame_type        = $0bea\nnext_char_frame_addr_low    = $0beb\nnext_char_frame_addr_high   = $0bec\nnext_char_frame_delay       = $0bed\nnext_color_frame_type       = $0bee\nnext_color_frame_addr_low   = $0bef\nnext_color_frame_addr_high  = $0bf0\nnext_color_frame_bg1        = $0bf1\nnext_color_frame_bg2        = $0bf2\nnext_color_frame_bg3        = $0bf3\nnext_color_frame_bg4        = $0bf4\n\nanimated_chars_table_low    = $0bf5\nanimated_chars_table_high   = $0bf6\n\nanimated_bg_colors_table_low    = $0bf7\nanimated_bg_colors_table_high   = $0bf8\n\n\n\nch1_newnote                 = $1485\nch1_tempo                   = $149a\nch1_counter                 = $149b\nch1_note                    = $149c\nch1_instr                   = $149d\nch1_gate                    = $149e\n\nch2_tempo                   = $14a1\nch2_counter                 = $14a2\nch2_note                    = $14a3\nch2_instr                   = $14a4\nch2_gate                    = $14a5\n\nch3_tempo                   = $14a8\nch3_counter                 = $14a9\nch3_note                    = $14aa\nch3_instr                   = $14ab\nch3_gate                    = $14ac\n\n; config\n*= $0810\nconfig_values\n\nborder_color\n;        BYTE   $02    \n!byte   $02     \nextended_color_mode\n;        BYTE   $01\n!byte   $00\ncustom_chars \n;        BYTE   $00\n!byte   $00\n\nsid \n;        BYTE   $00\n!byte   $00\n\nsidspeed\n;        BYTE   $01\n!byte   $01\n\nsid_init_addr_low\n;        BYTE   $03\n!byte   $00\nsid_init_addr_high\n;        BYTE   $10\n!byte   $10\n\nsid_play_addr_low\n;        BYTE   $12\n!byte   $03\nsid_play_addr_high\n;        BYTE   $10\n!byte   $10\n\n\nframe_ptr_start_low\n;        BYTE   $00\n!byte   $00\nframe_ptr_start_high\n;        BYTE   $80\n!byte   $80\n\nanimated_chars_table_start_low\n; \t\t\t BYTE   $00\n!byte   $00\nanimated_chars_table_start_high\n;\t\t\t\t BYTE   $00\n!byte   $00\n\nanimated_bg_colors_table_start_low\n; \t\t\t BYTE   $00\n!byte   $00\nanimated_bg_colors_table_start_high\n;\t\t\t\t BYTE   $00\n!byte   $00\n\n; init code, only run once\n*= $0820\ninit_code\n        ;$01=$36 -> RAM       visible A000-C000, IO visible at D000-E000, Kernal Rom Visible at E000-FFFF\n        lda #$36        ; $36 = 0011 0110\n        sta $01         ; RAM visible at $A000-$BFFF; KERNAL ROM visible at $E000-$FFFF, I/O area visible at $D000-$DFFF. \n\n        ; store location of frame ptrs\n        lda frame_ptr_start_low\n        sta first_frame_low\n        lda frame_ptr_start_high\n        sta first_frame_high\n        \n        lda animated_chars_table_start_low\n        sta animated_chars_table_low\n        lda animated_chars_table_start_high\n        sta animated_chars_table_high\n\n        lda animated_bg_colors_table_start_low\n        sta animated_bg_colors_table_low\n        lda animated_bg_colors_table_start_high\n        sta animated_bg_colors_table_high\n\n\n        lda border_color\n        sta $d020       ; border color\n\n\n        ; turn off multicolor mode\n        lda $d016\n        and #$ef\n        sta $d016\n        \n        lda extended_color_mode\n        cmp #$01\n        bne test_multi_color\n  \nsetup_extended_color_mode\n        lda $d011    ; turn on extended color mode\n        ora #$40\n        sta $d011\n        jmp setup_custom_chars\n\n\ntest_multi_color\n        cmp #$02\n        bne setup_custom_chars\n\nsetup_multi_color_mode\n        lda $d016    ; turn on extended color mode\n        ora #$10\n        sta $d016\n\n\nsetup_custom_chars\n\n        lda custom_chars\n        cmp #$01\n        bne setup_sid\n\n        lda $d018       \n        ora #$0e\n        sta $d018\n\nsetup_sid\n\n        lda sid\n        cmp #$01\n        bne disable_sid\n\n        lda sid_init_addr_low\n        sta sid_init_jsr+1\n        lda sid_init_addr_high\n        sta sid_init_jsr+2\n\n        lda sid_play_addr_low\n        sta sid_play_jsr+1\n        lda sid_play_addr_high\n        sta sid_play_jsr+2\n\n        lda sidspeed\n        cmp #$01\n        beq disable_sid_speed2\n\n        lda sid_play_addr_low\n        sta sid_play_jsr2+1\n        lda sid_play_addr_high\n        sta sid_play_jsr2+2\n\n        jmp setup_screen\n\ndisable_sid\n        ; put NOP in the sid init and play instructions\n        lda #$ea \n        sta sid_init_jsr\n        sta sid_init_jsr+1\n        sta sid_init_jsr+2\n\n        sta sid_play_jsr\n        sta sid_play_jsr+1\n        sta sid_play_jsr+2\n\ndisable_sid_speed2\n        lda #$ea \n        sta sid_play_jsr2\n        sta sid_play_jsr2+1\n        sta sid_play_jsr2+2\n\n\nsetup_screen\n        ; set the screen location to 0400    xxx1 xxxx\n        lda $d018\n        and #$0f                  \n        ora #$10                  \n        sta $d018\n\n        ; front buffer is 0400, back buffer is 0800\n        lda #$04\n        sta front_buffer_high\n        lda #$08\n        sta back_buffer_high\n\n\n        lda #$00\n        sta ch1_in_new_note\n        sta ch2_in_new_note\n        sta ch3_in_new_note\n\n        ;; init effects\n        sta check_keys_enabled\n        sta check_instr_enabled\n\n\t\t\t\tjsr init_effects\n        \n        jmp start\n\n\n;-------------- end if init code ---------------\n\n\n\n\n\n*=$0c00\nstart\n        lda first_frame_low\n        sta frame_ptr_low\n        lda first_frame_high\n        sta frame_ptr_high\n\n        ; load first frame into back buffer\n        jsr get_next_frame_info\n        jsr tick4\n        lda #$01\n        sta delay_counter\n\n\n        sei             ;disable maskable IRQs\n\n        lda #$00        ; sid tune 0\nsid_init_jsr\n        jsr $1000       ;init_sid\n\n        lda #$7f\n        sta $dc0d  ;disable timer interrupts which can be generated by the two CIA chips\n        sta $dd0d  ;the kernal uses such an interrupt to flash the cursor and scan the keyboard, so we better\n                   ;stop it.\n\n        lda $dc0d  ;by reading this two registers we negate any pending CIA irqs.\n        lda $dd0d  ;if we don't do this, a pending CIA irq might occur after we finish setting up our irq.\n                   ;we don't want that to happen.\n\n        lda #$01   ;this is how to tell the VICII to generate a raster interrupt\n        sta $d01a\n\n        lda #$ff   ;this is how to tell at which rasterline we want the irq to be triggered\n        sta $d012\n\n        lda $d011  ;as there are more than 256 rasterlines, the topmost bit of $d011 serves as\n        and #$7f   ;the 8th bit for the rasterline we want our irq to be triggered.               \n        sta $d011  ;clear it\n                   \n\n        lda #$35   ;we turn off the BASIC and KERNAL rom here\n        sta $01    ;the cpu now sees RAM everywhere except at $d000-$e000, where still the registers of\n                   ;SID/VICII/etc are visible\n\n        lda #<irq  ;this is how we set up\n        sta $fffe  ;the address of our interrupt code\n        lda #>irq\n        sta $ffff\n\n        cli        ;enable maskable interrupts again\n\n    \nloop\n        jmp loop\n\n\n        ; ---------------------interrupt start--------------------------------------------\nirq =*\n\n        pha        ;store register A in stack\n        txa\n        pha        ;store register X in stack\n        tya\n        pha        ;store register Y in stack\n\n; 0c51\n\n        lda #$ff   ;this is the orthodox and safe way of clearing the interrupt condition of the VICII.\n        sta $d019  ;if you don't do this the interrupt condition will be present all the time and you end\n                   ;up having the CPU running the interrupt code all the time, as when it exists the\n                   ;interrupt, the interrupt request from the VICII will be there again regardless of the\n                   ;rasterline counter.\n\n                   ;it's pretty safe to use inc $d019 (or any other rmw instruction) for brevity, they\n                   ;will only fail on hardware like c65 or supercpu. c64dtv is ok with this though.\n;        inc $d020\n\nsid_play_jsr\n        jsr $1012       ; play sid\n\n        jsr animate_chars\n;        jsr animate_bg_colors\n\n        lda tick                ; cant do trigger stuff if just ticked.\n        beq goto_play_frames\n\n        lda check_keys_enabled\n        beq instrument_triggers    ; if lda is 0, zero flag is set\n\n        jsr check_keys\n\ninstrument_triggers\n        lda check_instr_enabled\n        beq goto_play_frames\n\n        jsr check_instrument\n\ngoto_play_frames\n        jsr play_frames\n\n\nwait_for_raster\n        lda $d011\n        and #$80    ; zero flag is set if zero\n        bne wait_for_raster\n\n        lda $d012\n        cmp #$80\n        bcc wait_for_raster\n\nsid_play_jsr2\n        jsr $1012\n\n;        dec $d020\nirqout\n        pla\n        tay        ;restore register Y from stack (remember stack is FIFO: First In First Out)\n        pla\n        tax        ;restore register X from stack\n        pla        ;restore register A from stack\n\n        rti        ;Return From Interrupt, this will load into the Program Counter register the address\n                   ;where the CPU was when the interrupt condition arised which will make the CPU continue\n                   ;the code it was interrupted at also restores the status register of the CPU\n\n;-----------------------------------------------------------\nplay_frames\n        dec delay_counter\n        bne ticks ; counter not zero yet, do ticks\n\n        lda #$00\n        sta tick\n\n        ; delay is zero, display the next frame...\n        jmp display_next_frame\n\nticks\n;        lda delay_counter \n\n\t\t\t\tjsr effects_tick\n        \n        \n        inc tick\n        lda tick\n        cmp #$01        ;  start preparing for next frame\n        bne tick2test\n        jmp get_next_frame_info\ntick2test        \n        cmp #$02        ;  start preparing for next frame\n        bne tick3test\n        jmp tick4\ntick3test\n        cmp #$03        ;  start preparing for next frame\n        bne tick4test\n        jmp tick3\ntick4test\n        cmp #$04        ;  start preparing for next frame\n        bne tick5test\n        jmp tick2\ntick5test\n        cmp #$05        ;  start preparing for next frame\n        bne tickgreater5\n        jmp tick1\ntickgreater5\n        rts\n\ndisplay_next_frame\n        lda next_char_frame_delay\n        sta delay_counter\n\n        jsr swap_buffers\n\n        ; update colors...\n        lda next_color_frame_bg1\n        sta $d021       ; background color\n        lda next_color_frame_bg2\n        sta $d022       ; background color\n        lda next_color_frame_bg3\n        sta $d023       ; background color\n        lda next_color_frame_bg4\n        sta $d024       ; background color\n\n        ; copy color data\n        lda next_color_frame_addr_low\n        sta copy_from_low\n        lda next_color_frame_addr_high\n        sta copy_from_high\n\n        lda #$00\n        sta copy_to_low\n        lda #$d8\n        sta copy_to_high\n\n\n        lda next_color_frame_type\n        cmp #$01\n        beq whole_frame_color_type             \n\n        ; just copy color changes\n        jsr data_changes\n        jmp read_effects        ; read the effects for this frame\n;        rts \n\nwhole_frame_color_type\n        jsr copy_data_4bit\n        jmp read_effects         ; read the effects for this frame\n;        rts\n\ncheck_trigger_table\n\n        ldy #$00    ; going to use y to loop through keys\n\n        \ncheck_trigger_loop\n\n\n        lda (temp_low),y    ; load in the test key\n        \n        cmp #$00              ; have we reached end of table?\n        beq check_trigger_done   ; reached end, so exit\n\n        iny\n        iny\n        iny\n        iny\n\n        cmp trig            ; check test key against key pressed\n        bne check_trigger_loop\n\n        ; found trigger !\n\n        dey \n        dey\n        dey\n\n        lda (temp_low),y\n        jsr effects_trigger\n\n        lda (temp_low),y\n        beq trigger_goto_frame\n\n        cmp #$02\n        beq switch_charset\n\n\t\t\t\tcmp #$01\n        beq force_next_frame\n        rts\n        \nforce_next_frame        \n        lda #$04\n        sta delay_counter\n;        sta force_next_frame\n        rts\n\nswitch_charset\n        iny\n        lda $d018\n        and #$f1\n        ora (temp_low),y\n        sta $d018\n        rts        \n\ntrigger_goto_frame\n        iny\n        lda (temp_low),y\n        sta frame_ptr_low\n        iny\n\n        lda (temp_low),y\n        sta frame_ptr_high\n\n\n        ; set this as tick 1 so the char data will be copied\n        lda #$00\n        sta tick\n\n\n        ; make the delay counter 4 so the next frame will be disp next tick\n        ;lda #$05\n        lda #$03\n        sta delay_counter\ncheck_trigger_done\n        rts\n\ncheck_keys\n\n        lda #00\n        jsr scan_key\n        sta trig                 ; store the key to check in temp\n\n        lda key_table_low        ; load in pointer to keys table\n        sta temp_low\n        lda key_table_high\n        sta temp_high\n        jsr check_trigger_table\n\n\ncheck_keys_done\n\n\n        rts\n\ncheck_instrument\n\n        lda ch1_newnote\n        cmp #$00\n        beq reset_ch1_new_note\n\n        lda ch1_in_new_note\n        cmp #$00\n        bne ch1nextchannel\n\n        lda #$01\n        sta ch1_in_new_note\n\n        lda ch1_instr\n\n        sta trig                 ; store the instrument to check in temp\n\n        lda instr_table_low        ; load in pointer to keys table\n        sta temp_low\n        lda instr_table_high\n        sta temp_high\n\n\n        jsr check_trigger_table\n\n        rts\n\nreset_ch1_new_note\n        lda #$00\n        sta ch1_in_new_note\n\nch1nextchannel    \n\n        rts\n\nget_next_frame_info\n        ldy #$00\n        lda (frame_ptr_low),y\n\n        ; #$00 indicates a jump\n        cmp #$00\n        bne get_next_frame_info1\n\n        ; next two bytes are where to jump to\n        iny\n        lda (frame_ptr_low),y\n        sta temp  ;frame_ptr_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta frame_ptr_high\n\n        lda temp\n        sta frame_ptr_low\n\n        ldy #$00\n\n        lda (frame_ptr_low),y\n\nget_next_frame_info1\n\n        ; read in the next frames info\n\n        sta next_char_frame_type\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_char_frame_addr_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_char_frame_addr_high\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_char_frame_delay\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_type\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_addr_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_addr_high\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_bg1\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_bg2\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_bg3\n\n        iny\n        lda (frame_ptr_low),y\n        sta next_color_frame_bg4\n\n        ; add y accumulator to frame_ptr\n        tya\n        clc                    ; clear carry\n        adc frame_ptr_low              \n        sta frame_ptr_low\n\n        lda frame_ptr_high     ; add 0 with carry to higher byte \n        adc #00\n        sta frame_ptr_high\n\n        lda next_char_frame_type  ; if its the whole frame type, then we're done\n        cmp #$01\n        bne setup_change_frame_type\n        rts\n\nsetup_change_frame_type\n        ; its changes, so need to copy to back buffer\n        jsr copy_front_to_back_buffer\n\n        rts\n\nread_effects\n        ldy #$00\n        ; effects\nread_effects_loop\n        iny\n        lda (frame_ptr_low),y\n\n        ; #$00 means no effects \n        cmp #$00\n        beq frame_info_end\n\n        cmp #$01\n        bne frame_effect_2\n\n        ; enable check keys\n        lda #$01\n        sta check_keys_enabled\n\n        iny\n        lda (frame_ptr_low),y\n        sta key_table_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta key_table_high\n\n        jmp read_effects_loop\n\nframe_effect_2\n        cmp #$02\n        bne frame_effect_3\n\n        ; disable check keys\n        lda #$00\n        sta check_keys_enabled\n        jmp read_effects_loop\n\nframe_effect_3\n        cmp #$03\n        bne frame_effect_4\n\n        ; enable check instr\n        lda #$01\n        sta check_instr_enabled\n\n        iny\n        lda (frame_ptr_low),y\n        sta instr_table_low\n\n        iny\n        lda (frame_ptr_low),y\n        sta instr_table_high\n\n        jmp read_effects_loop\n\n\n\nframe_effect_4\n        cmp #$04\n        bne frame_effect_5\n\n        ; disable check instruments\n        lda #$00\n        sta check_instr_enabled\n        jmp read_effects_loop\n\nframe_effect_5\n\nframe_info_end\n        iny \n\n        ; add y accumulator to frame_ptr\n        tya\n\n;        sta $d020\n\n        clc                    ; clear carry\n        adc frame_ptr_low                ; add 40 with carry to lower byte\n        sta frame_ptr_low\n\n        lda frame_ptr_high     ; add 0 with carry to higher byte \n        adc #00\n        sta frame_ptr_high\n        rts        \ntick4\n        ; load in location of character data\n        lda next_char_frame_addr_low\n        sta copy_from_low\n        lda next_char_frame_addr_high\n        sta copy_from_high\n\n        lda #$00\n        sta copy_to_low\n        lda back_buffer_high\n        sta copy_to_high\n\n\n        ; check what type of frame it is..\n        lda next_char_frame_type\n        cmp #$01\n        beq full_frame_type\n\n        cmp #$02\n        beq changes_frame_type\n\n        ; rle data\n        jsr copy_rle_data\n        rts\n\nchanges_frame_type\n        ; its changes, \n        lda #$00\n        sta frame_finished\n\n        jsr data_changes\n        rts\n\n\nfull_frame_type\n        ; copy all chars to back buffer\n\n        jsr copy_data\n\n        lda #$01\n        sta frame_finished   ; this frame's data is over..\n        rts\n\ntick3\n\n        ; if not finished with changes, continue updating\n        lda frame_finished  ; finished copying frame data ?\n        cmp #$00\n        bne tick3done\n\n        jsr data_changes\n\ntick3done\n        rts\n\ntick2\n        lda frame_finished  ; finished copying frame data ?\n        cmp #$00\n        bne tick2done\n\n        jsr data_changes\n\ntick2done\n        rts\ntick1\n        rts\n\n\n;------------ end of play frames...\n\ncopy_front_to_back_buffer\n\n        ; copy front buffer to back buffer\n        lda #$00\n        sta copy_from_low\n        lda front_buffer_high\n        sta copy_from_high\n\n        lda #$00\n        sta copy_to_low\n        lda back_buffer_high\n        sta copy_to_high\n\n        jsr copy_data\n\n        rts\n\n\nswap_buffers\n        ldx back_buffer_high         ; load value of current back buffer\n        cpx #$04                     ; is it 0400\n        bne swap_buffers_1\n\n        ; set front buffer to 0400, back buffer to 0800\n        lda #$04\n        sta front_buffer_high\n        lda #$08\n        sta back_buffer_high\n\n        ; set screen location to $0400\n        lda $d018\n        and #$0f\n        ora #$10\n        sta $d018\n\n        rts\n\nswap_buffers_1\n        ; set front buffer to 0800, back buffer to 0400\n        lda #$08\n        sta front_buffer_high\n        lda #$04\n        sta back_buffer_high\n\n        ; set screen location to $0800\n        lda $d018\n        and #$0f\n        ora #$20\n        sta $d018\n\n        rts\n\n\ncopy_data\n;        ldy xoffset\n        ldy #$0\n        ldx #25    ; number of lines to copy\n\n\ncopy_data_line\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n\n        cpy #40                 ; have we copied 40 chars? (10x4)\n        bne copy_data_line\n        \n        dex\n        beq copy_data_done\n        \n        ldy #0                  ; back to start of line\n\n\n        ; increase where copy from by 40\n        clc                    ; clear carry\n        lda copy_from_low\n        adc #40                ; add 40 with carry to lower byte\n        sta copy_from_low\n\n        lda copy_from_high     ; add 0 with carry to higher byte \n        adc #00\n        sta copy_from_high\n\n\n        ; increase where copy to by 40\n        clc                     ; clear carry\n        lda copy_to_low\n        adc #40                 ; add 40 with carry to lower byte\n        sta copy_to_low\n\n        lda copy_to_high        ; add 0 with carry to higher byte \n        adc #00\n        sta copy_to_high\n\n        jmp copy_data_line\n\ncopy_data_done\n\n        rts \n\n\ncopy_data_4bit\n        ldy #0\n        ldx #25\n\ncopy_data_4bit_line\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y \n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n;        lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n        ;lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n        ;lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n        ;lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n        lda (copy_from_low),y\n        sta (copy_to_low),y\n        iny\n        lsr\n        lsr\n        lsr\n        lsr\n        ;lda (copy_from_low),y\n        sta (copy_to_low),y\n\n        iny\n\n\n        cpy #40                 ; have we copied 40 chars? (10x4)\n        bne copy_data_4bit_line\n        \n        dex\n        beq copy_data_4bit_done\n        \n        ldy #0                  ; back to start of line\n\n\n        ; increase where copy from by 40\n        clc                    ; clear carry\n        lda copy_from_low\n        adc #40                ; add 40 with carry to lower byte\n        sta copy_from_low\n\n        lda copy_from_high     ; add 0 with carry to higher byte \n        adc #00\n        sta copy_from_high\n\n\n        ; increase where copy to by 40\n        clc                     ; clear carry\n        lda copy_to_low\n        adc #40                 ; add 40 with carry to lower byte\n        sta copy_to_low\n\n        lda copy_to_high        ; add 0 with carry to higher byte \n        adc #00\n        sta copy_to_high\n\n        jmp copy_data_4bit_line\n\ncopy_data_4bit_done\n\n        rts \n\n\n\ncopy_rle_data\n        ldy #00\n\n        lda (copy_from_low),y\n        bne continue_rle\n\n        ; reached the end of the data\n        lda #$01\n        sta frame_finished\n\n        rts\n\ncontinue_rle\n        tax\n\n        inc copy_from_low\n        bne rle_get_byte\n        inc copy_from_high\n\nrle_get_byte\n        lda (copy_from_low),y\n        inc copy_from_low\n        bne write_rle_byte\n        inc copy_from_high\n\n\nwrite_rle_byte        \n        sta (copy_to_low),y\n        iny\n        dex\n        bne write_rle_byte\n\n        tya\n\n        clc\n        adc copy_to_low\n        sta copy_to_low\n\n        lda copy_to_high\n        adc #$00\n        sta copy_to_high\n\n        jmp copy_rle_data\n\n\n\n\n; data changes are list:  offset, change, offset, change, ends in 00\ndata_changes\n        ldx #$00\n\n        ldy #$00\n        lda (copy_from_low),y      ; load the first offset\n\nnext_change              \n        ; add the offset to buffer ptr\n        clc\n        adc copy_to_low\n\n        sta copy_to_low\n        lda copy_to_high\n        adc #$00\n        sta copy_to_high\n\n\n        ; increase the pointer to the change data\n        inc copy_from_low     ; zero flag will be set if result is zero\n        bne get_change\n        inc copy_from_high\nget_change\n\n\n\n        lda (copy_from_low),y      ; load the character\n        sta (copy_to_low),y \n\n\n        ; increase the pointer to the change data\n        inc copy_from_low           ; zero flag will be set if result is zero\n        bne get_offset\n        inc copy_from_high\n\nget_offset         \n        lda (copy_from_low),y\n\n        cmp #$0                     ; sequence ends with a 0 offset\n        beq changes_done\n\n\n        inx\n        cpx #$ff                    ; only do up to 255 changes\n        bne next_change\n\n        ; reached max number of changes for this refresh... mark as not finished yet\n        lda #$00\n        sta frame_finished\n        rts\n\nchanges_done        \n        \n        lda #$01                        ; mark frame as finished..\n        sta frame_finished\n\n        rts\n\n\n*= $4000\n\nanimate_chars\n\n;  inc $d020\n;  rts\n  lda #$38\n  sta copy_to_high2\n  lda #$00\n  sta copy_to_low2\n  \n\n  \n  lda animated_chars_table_low\n  sta copy_from_low2\n  \n  lda animated_chars_table_high\n  sta copy_from_high2\n  \n  \nanim_char_start\n  ; load number of ticks per frame\n  ldy #$00\n  lda (copy_from_low2), y\n  \n  ; if value is 0 then reached end of table\n  cmp #$00\n  beq animate_chars_done\n  \n  ldy #$01\n  lda (copy_from_low2), y\n  tax\n  dex\n  txa\n  sta (copy_from_low2), y\n  \n  bne next_anim_char\n  \n  \n  ; counter has reached 0\n  \n  ; load number of ticks per frame\n  ldy #$00\n  lda (copy_from_low2), y\n  \n  ; store in counter for the character\n  iny\n  sta (copy_from_low2), y\n  \n  ; load in character to animate\n  iny\n\n\t; get character offset\n  lda (copy_from_low2), y\n  \n  clc                    ; clear carry\n  adc copy_to_low2              \n  sta temp_low\n\n\t\n  iny\n  lda (copy_from_low2),y\n  adc copy_to_high2\n  sta temp_high\n  \n  ; get the animation type\n  iny\n  lda (copy_from_low2),y\n  \n  cmp #$00\n  bne anim_type_1\n\tjsr scroll_char_left\n\tjmp next_anim_char\nanim_type_1\n  cmp #$01\n  bne anim_type_2\n  jsr scroll_char_right\n  jmp next_anim_char\nanim_type_2\n\tcmp #$02\n  bne anim_type_3\n  jsr scroll_char_up\n  jmp next_anim_char\nanim_type_3\n\tcmp #$03\n  bne anim_type_4\n  jsr scroll_char_down\n  jmp next_anim_char\n\nanim_type_4\n  jsr blink_char\n  \nnext_anim_char\n\n\tclc\n  \n\t; add 5 to animated char table ptr\n\tlda copy_from_low2\n  adc #$05              \n  sta copy_from_low2\n\n\tlda copy_from_high2     ; add 0 with carry to higher byte \n\tadc #00\n  sta copy_from_high2\n  \n  jmp anim_char_start\n\n\n\nanimate_chars_done\n\n;  dec $d020\n\t\n\trts\n  \nblink_char\n\tldy #$00\n\n\tlda #$ff\n  eor (temp_low),y\n  sta (temp_low),y\n  iny\n\n\tlda #$ff\n  eor (temp_low),y\n  sta (temp_low),y\n  iny\n\n\tlda #$ff\n  eor (temp_low),y\n  sta (temp_low),y\n  iny\n\n\tlda #$ff\n  eor (temp_low),y\n  sta (temp_low),y\n  iny\n\n\tlda #$ff\n  eor (temp_low),y\n  sta (temp_low),y\n  iny\n\n\tlda #$ff\n  eor (temp_low),y\n  sta (temp_low),y\n  iny\n\n\tlda #$ff\n  eor (temp_low),y\n  sta (temp_low),y\n  iny\n\n\tlda #$ff\n  eor (temp_low),y\n  sta (temp_low),y\n  iny\n\n\trts\n  \nscroll_char_down\n\n\tldy #$07\n  lda (temp_low),y\n  sta temp\n  \n  dey\n  ; 3806\n  lda (temp_low),y\n  iny\n  sta (temp_low),y\n  dey\n  dey\n  \n  ; 3805\n  lda (temp_low),y\n  iny\n  sta (temp_low),y\n  dey\n  dey\n\n  ; 3804\n  lda (temp_low),y\n  iny\n  sta (temp_low),y\n  dey\n  dey\n\n  ; 3803\n  lda (temp_low),y\n  iny\n  sta (temp_low),y\n  dey\n  dey\n\n  ; 3802\n  lda (temp_low),y\n  iny\n  sta (temp_low),y\n  dey\n  dey\n\n  ; 3801\n  lda (temp_low),y\n  iny\n  sta (temp_low),y\n  dey\n  dey\n\n  ; 3800\n  lda (temp_low),y\n  iny\n  sta (temp_low),y\n  dey\n  \n\tlda temp\n  sta (temp_low), y\n\n;\tlda $3800\n;  sta temp\n  \n;  lda $3807\n;  sta $3800\n\n;  lda $3806\n;  sta $3807\n\n;  lda $3805\n;  sta $3806\n;  lda $3804\n;  sta $3805\n;  lda $3803\n;  sta $3804\n;  lda $3802\n;  sta $3803\n;  lda $3801\n;  sta $3802\n;  lda temp\n;  sta $3801\n\n\trts\n\n\nscroll_char_up\n\tldy #$00\n\tlda (temp_low), y\n  sta temp\n  \n  iny\n  lda (temp_low), y\n  dey\n  sta (temp_low), y\n  iny\n  iny\n\n  lda (temp_low), y\n  dey\n  sta (temp_low), y\n  iny\n  iny\n\n  lda (temp_low), y\n  dey\n  sta (temp_low), y\n  iny\n  iny\n\n  lda (temp_low), y\n  dey\n  sta (temp_low), y\n  iny\n  iny\n\n  lda (temp_low), y\n  dey\n  sta (temp_low), y\n  iny\n  iny\n\n  lda (temp_low), y\n  dey\n  sta (temp_low), y\n  iny\n  iny\n\n  lda (temp_low), y\n  dey\n  sta (temp_low), y\n  iny\n\n\tlda temp\n  sta (temp_low), y\n\n\trts\n  \nscroll_char_right\n\tldy #$00\n  ldx #$08\n\nscroll_char_right_cont\n  dex\n\n\tlda temp_low\n  sta scroll_char_right_addr1 + 1\n  sta scroll_char_right_addr2 + 1\n\n\tlda temp_high\n  sta scroll_char_right_addr1 + 2\n  sta scroll_char_right_addr2 + 2\n\n\nscroll_char_right_addr1\n\tlda $3800,x\n  ror\nscroll_char_right_addr2\n  ror $3800,x\n  \n  txa\n  cmp #$00\n  bne scroll_char_right_cont\n\n\trts\n\nscroll_char_left\n\tldy #$00\n  ldx #$08\n  \n\n\tlda temp_low\n  sta scroll_char_left_addr1 + 1\n  sta scroll_char_left_addr2 + 1\n\n\tlda temp_high\n  sta scroll_char_left_addr1 + 2\n  sta scroll_char_left_addr2 + 2\n  \nscroll_char_left_cont\n\n\n  dex\n\n\nscroll_char_left_addr1\n\tlda $3800,x\n  rol\nscroll_char_left_addr2\n  rol $3800,x\n\n\ttxa\n  cmp #$00\n\tbne scroll_char_left_cont\n  \n  rts\n\nanimate_bg_colors\n;\tinc $d021\n;  inc $d022\n;  inc $d023\n;  inc $d024\n \n  lda #$d0\n  sta copy_to_high\n  lda #$21\n  sta copy_to_low\n  \n  lda animated_bg_colors_table_low\n  sta copy_from_low\n  \n  lda animated_bg_colors_table_high\n  sta copy_from_high\n  \n  \nanim_bg_color_start\n  ; load number of ticks per frame\n  ldy #$00\n  lda (copy_from_low), y\n  \n  ; if value is 0 then reached end of table\n  cmp #$00\n  beq animate_bg_colors_done\n  \n  ldy #$01\n  lda (copy_from_low), y\n  tax\n  dex\n  txa\n  sta (copy_from_low), y\n  \n  bne next_anim_bg_color\n  \n  \n  ; counter has reached 0\n  \n  ; load number of ticks per frame\n  ldy #$00\n  lda (copy_from_low), y\n  \n  ; store in counter for the character\n  iny\n  sta (copy_from_low), y\n  \n  ; load in color to animate\n  iny\n  lda (copy_from_low), y\n  \n  \n  \n  clc                    ; clear carry\n  adc copy_to_low              \n  sta temp_low\n  \n  lda #$00\n  adc copy_to_high\n  sta temp_high\n  \n  ldy #$00\n  lda (temp_low), y\n  adc #$01\n;  inc \n  sta (temp_low), y\n  \n  \n\nnext_anim_bg_color\n\n\tclc\n  \n\t; add 3 to animated char table ptr\n\tlda copy_from_low\n  adc #$03              \n  sta copy_from_low\n\n\tlda copy_from_high     ; add 0 with carry to higher byte \n\tadc #00\n  sta copy_from_high\n  \n  jmp anim_bg_color_start\n\n\n\nanimate_bg_colors_done\n\n;  dec $d020\n\t\n\trts\n  \n\n  \nscan_key\n\n;    inc $d020\n\n    ;; set up the data direction registers\n    lda #$0\n    sta $dc03   ; port b ddr (input)\n    lda #$ff\n    sta $dc02   ; port a ddr (output)\n            \n    ; set which row being checked\n    lda #$00\n    sta $dc00   ; port a\n\n    lda $dc01\n    sta $11\n\n    ; get column information\n    lda $dc01       ; port b\n\n    cmp #$ff\n    beq nokey\n\n    ; got column\n    tay\n    \n\n    ; first row to test        \n    lda #$7f      ;  0111 1111\n    sta nokey2+1\n\n    ; going to check 8 rows\n    ldx #8\nnokey2\n    ;; this location has the row to check\n    lda #0\n    sta $dc00   ; port a\n    \n    ; set the carry flag\n    sec\n    ; set next row to check\n    ror nokey2+1\n\n    ; checked all rows yet?\n    dex\n    ; branch if minus\n    bmi nokey\n\n    ; get column information\n    lda $dc01       ; port b\n    cmp #$ff\n    beq nokey2\n            \n    ; got row in X\n    txa\n    sta $12\n    ora columntab,y\n\n    sta $10\n\n    sec\n    \n;    dec $d020\n    rts\n            \nnokey\n    clc\n;    dec $d020\n    lda #$0\n    sta $10\n\n    rts\n\n\ncolumntab\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$70\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$60\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$50\n\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$40\n!byte $ff,$ff,$ff,$ff,$ff,$ff,$ff,$30\n!byte $ff,$ff,$ff,$20,$ff,$10,$00,$ff\n\ninit_effects\n\trts\n\n";var C64ASM=function(){this.files=null};C64ASM.prototype={init:function(e){this.editor=e;this.files=new AssemblerFiles;var t=this.files.createFile("/main.asm");t.setContent(C64ASMSource)},editCode:function(){g_app.assemblerEditor.setFiles(this.files);g_app.showAssembler()}};var ToPRG=function(){this.editor=null;this.sidData=null;this.sidLoadAddr=0;this.sidInitAddr=0;this.sidPlayAddr=0;this.sidMultispeed=0;this.mostUsedCharacters=[];this.charsetData=[];this.extendedColorCharsetData=[];this.extendedColorCharsetMap=[];this.extendedColorBGColors=[];this.prg=[];this.blocks=[];this.exportC64=null};ToPRG.prototype={init:function(e){this.editor=e},start:function(){var t=this;if(this.exportC64==null){this.exportC64=new ExportC64;this.exportC64.init(this.editor)}if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"toPrgDialog",title:"Export C64 PRG",width:640});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/toPrg.html",function(){t.initContent();t.initEvents()});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.exportPrg();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("toPrgDialog")},initContent:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){alert("Please choose a grid layer");return}if(t&&t.getType()=="grid"&&(t.hasCellBackgroundColors()||t.getMode()==TextModeEditor.Mode.C64ECM)){$("#exportPRGColorModeExtended").prop("checked",true)}var i=this.editor.getScreenMode();if(i==TextModeEditor.Mode.C64MULTICOLOR){$("#exportPRGColorModeMulticolor").prop("checked",true)}$("#exportPRGAs").val(g_app.fileManager.filename);var r=this.editor.graphic.getFrameCount();$("#exportPRGToFrame").val(r);$("#exportPRGFromFrame").val(1);$("#exportPRGFromFrame").attr("max",r);$("#exportPRGToFrame").attr("max",r);var a=$("#playMode").val();if(a!="once"){$("#exportPRGLoopType").val(a)}this.editor.toPrg.sidData=null;clearInputFile(document.getElementById("exportPRGSIDFile"));$("#exportPRGSIDFileInfo").html("");this.monochromeColor=this.editor.currentTile.color;$("#exportPRGMonochromeColor").css("background-color","#"+e.getHexString(this.monochromeColor));var s="";var o=g_app.doc.dir("/music");var l=$("#exportPRGMusic").val();if(typeof l=="undefined"){l=false}s+='<option value="no">No Music</option>';for(var n=0;n<o.length;n++){var h="/music/"+d;var d=o[n].name;s+='<option value="/music/'+d+'"';if(!l&&n==0||h==l){s+=' selected="selected" '}s+=">"+o[n].name+"</option>"}s+='<option value="sid">Use A SID File</option>';$("#exportPRGMusic").html(s)},initEvents:function(){var a=this;document.getElementById("exportPRGSIDFile").addEventListener("change",function(e){var t=document.getElementById("exportPRGSIDFile").files[0];var i=window.URL||window.webkitURL;var r=i.createObjectURL(t);a.selectSIDFile(t)});$("input[name=exportPRGColorMode]").on("click",function(e){var t=$("input[name=exportPRGColorMode]:checked").val();if(t=="monochrome"){$("#exportPRGMonochromeSection").show()}else{$("#exportPRGMonochromeSection").hide()}});$("#exportPRGMonochromeColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){var t=a.editor.colorPaletteManager.getCurrentColorPalette();a.monochromeColor=e;$("#exportPRGMonochromeColor").css("background-color","#"+t.getHexString(e))};var i=e.pageX;var r=e.pageY;t.currentColor=a.monochromeColor;a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("#exportPRGType").on("change",function(e){var t=$(this).val();if(t=="d64"){$("#exportPRGD64Options").show()}else{$("#exportPRGD64Options").hide()}});$("#exportPRGMusic").on("change",function(e){var t=$(this).val();if(t=="sid"){$("#exportPRGSidFileSection").show()}else{$("#exportPRGSidFileSection").hide()}})},calculatePRGSize:function(){var e=1;var t=this.editor.graphic.getFrameCount();var i=this.saveAs("",e,t,false,0,false,false);var r=i.blocks;var a=0;var s=4096;for(var o=0;o<r.length;o++){var l=r[o].start-s;if(l>1e3){a+=l}s=r[o].end}var l=53248-s;if(l>1e3){a+=l}$("#editorInfo").html(a+" Bytes Free")},exportPrg:function(){var e=$("#exportPRGAs").val();var t=$("#exportPRGMonochrome").is(":checked");var i=$("#exportPRGExtendedColorMode").is(":checked");var r=parseInt($("#exportPRGFromFrame").val());if(isNaN(r)||r<1||r>this.editor.graphic.getFrameCount()){alert("Invalid From Frame");return}var a=parseInt($("#exportPRGToFrame").val());if(isNaN(a)||a<1||a>this.editor.graphic.getFrameCount()){alert("Invalid To Frame");return}if(r>a){alert("From must be greater than to");return}this.saveAs(e,r,a,t,this.monochromeColor,i)},saveAs:function(e,t,i,r,a,s,o){if(typeof o=="undefined"){o=true}var l=$("#exportPRGMusic").val();var n=$("#exportPRGLoopType").val();var h={};h.download=o;h.filename=e;h.mode=$("input[name=exportPRGColorMode]:checked").val();if(h.mode=="monochrome"){h.monochromeColor=this.monochromeColor}h.music=l;if(l=="sid"){h.sidData=this.sidData;h.sidLoadAddr=this.sidLoadAddr;h.sidInitAddr=this.sidInitAddr;h.sidPlayAddr=this.sidPlayAddr;h.sidSpeed=this.sidMultispeed}h.scrollV=false;if($("#exportPRGScrollV").is(":checked")){h.scrollV=true}h.entries=[];h.keyTriggers=[];h.instrTriggers=[];h.entries=[];if(t==i){h.entries[0]={};h.entries[0].type="frame";h.entries[0].frame=1;h.entries[0].duration=255;h.entries[1]={};h.entries[1].type="gotorow";h.entries[1].gotoRow=1}else{h.entries[0]={};h.entries[0].type="frameRange";h.entries[0].from=t;h.entries[0].to=i;if(n=="pingpong"){h.entries[1]={};h.entries[1].type="frameRange";h.entries[1].from=i-1;h.entries[1].to=t+1;h.entries[2]={};h.entries[2].type="frameJump";h.entries[2].jumpTo=1}else{h.entries[1]={};h.entries[1].type="frameJump";h.entries[1].jumpTo=1}}h.layers=$("input[name=exportPRGLayer]:checked").val();h.type=$("#exportPRGType").val();if(h.type=="d64"){h.diskName=$("#exportPRGDiskName").val();h.prgName=$("#exportPRGName").val()}var d=this.editor.layers.getSelectedLayerObject();if(!d||d.getType()!="grid"){return}if(d.getBlockModeEnabled()){d.updateTilesFromBlocks()}if(d.getColorPerMode()=="character"){d.updateGridColorsFromTiles()}var c=d.getGridWidth();var f=d.getGridHeight();h.frames=[];var u=this.editor.graphic.getFrameCount();for(var p=0;p<u;p++){var v=d.getFrameData(p);var g=v;if(c<40||f<25){g={bgColor:v.bgColor,borderColor:v.borderColor,data:[]};var m=32;var y=this.editor.colorPaletteManager.noColor;for(var b=0;b<25;b++){g.data.push([]);for(var C=0;C<40;C++){g.data[b][C]={t:m,fc:0,bc:y,fh:0,fv:0,rz:0}}}var x=Math.floor((40-c)/2);var S=Math.floor((25-f)/2);for(var b=0;b<f;b++){for(var C=0;C<c;C++){var P=C+x;var w=b+S;if(P>=0&&P<40&&w>=0&&w<25){g.data[w][P]={t:v.data[b][C].t,fc:v.data[b][C].fc,bc:v.data[b][C].bc,fh:v.data[b][C].fh,fv:v.data[b][C].fv,rz:v.data[b][C].rz}}}}}var I={};I.frameData=g;I.duration=this.editor.graphic.getFrameDuration(p);h.frames.push(I)}if(c<40||f<25){h.gridWidth=40;h.gridHeight=25}else{h.gridWidth=d.getGridWidth();h.gridHeight=d.getGridHeight()}this.editor.toPrgAdv.createPRG(h)},getSIDInfo:function(){var e=1;var t=this.sidData;var i=985248,r=50,a=3,s=65536*a*16;var o=[0,1,.6,.4];var l=new Uint8Array(32);var n=new Uint8Array(32);var h=new Uint8Array(32);var d=new Uint8Array(32);var c=4096,f=4096,u=4099,p=4099,v=0,g=1,m=0;var y=[8580,8580,8580];var b=8580;var C=[54272,0,0];var x=new Uint8Array(65536);var S=0,P=0,w=0,I=null,k=null;endcallback=null,playtime=0,ended=0;var M=i/e;var T=e/r;var D=1,E=1,_=0,B;var R=1,A=0;var F,L,U=t[7];c=t[8]+t[9]?t[8]*256+t[9]:t[U]+t[U+1]*256;for(F=0;F<32;F++){d[31-F]=t[18+(F>>3)]&Math.pow(2,7-F%8)}this.sidMultispeed=d[0];for(F=0;F<x.length;F++){x[F]=0}for(F=U+2;F<t.byteLength;F++){if(c+F-(U+2)<x.length){x[c+F-(U+2)]=t[F]}}L=1;for(F=0;F<32;F++){if(L!=0){L=l[F]=t[22+F]}else{L=l[F]=0}}L=1;for(F=0;F<32;F++){if(L!=0){L=n[F]=t[54+F]}else{L=n[F]=0}}L=1;for(F=0;F<32;F++){if(L!=0){L=h[F]=t[86+F]}else{L=h[F]=0}}f=t[10]+t[11]?t[10]*256+t[11]:c;p=u=t[12]*256+t[13];g=t[15];y[0]=(t[119]&48)>=32?8580:6581;y[1]=(t[119]&192)>=128?8580:6581;y[2]=(t[118]&3)>=3?8580:6581;C[1]=t[122]>=66&&(t[122]<128||t[122]>=224)?53248+t[122]*16:0;C[2]=t[123]>=66&&(t[123]<128||t[123]>=224)?53248+t[123]*16:0;R=1+(C[1]>0)+(C[2]>0);S=1;this.sidLoadAddr=c;this.sidInitAddr=f;this.sidPlayAddr=p;var H="";H+='<div style="margin: 2px 0 0 4px"><strong>Size:</strong> '+this.sidData.length+" bytes</div>";H+='<div style="margin: 2px 0 0 4px"><strong>Load Address:</strong> $'+c.toString(16)+"</div>";H+='<div style="margin: 2px 0 0 4px"><strong>Init Address:</strong> $'+f.toString(16)+"</div>";H+='<div style="margin: 2px 0 0 4px"><strong>Play Address:</strong> $'+p.toString(16)+"</div>";$("#exportPRGSIDFileInfo").html(H)},selectSIDFile:function(e){var t=this;var i=new FileReader;i.onload=function(e){t.sidData=new Uint8Array(e.target.result);t.getSIDInfo()};i.readAsArrayBuffer(e)}};var ToPRGAdv=function(){this.editor=null;this.effects=[{name:"Background Flash",data:";data \nbgEffectCounter\n!byte 00\nbgEffectColor \n!byte $0,$0,$b,$b,$c,$c,$f,$f,$1,$1,$f,$c,$b",init:";init\n;this code is executed once on startup\n",trigger:";on trigger\n;this code is executed when the effect is triggered\n  lda #$0d\n  sta bgEffectCounter\n",tick:"\n;on tick\n;this code is executed on every tick\n\n  lda bgEffectCounter\n  cmp #00\n  beq bgEffectDone\n    \n  ldy bgEffectCounter\n  lda bgEffectColor,y\n\n  sta $d021\n\n  dey\n  sty bgEffectCounter\n\nbgEffectDone"},{name:"Jitter",data:";data \neffectJitterCounter\n!byte 00\neffectJitterAmount\n!byte $7,$0,$3,$6,$2,$7,$4",init:";init\n;this code is executed once on startup\n",trigger:";on trigger\n;this code is executed when the effect is triggered\n  lda #$06\n  sta effectJitterCounter\n    \n  lda #$07\n  ora $d016\n",tick:";on tick\n;this code is executed on every tick\n\n  lda effectJitterCounter\n  cmp #00\n  beq effectJitterDone\n  \n  lda $d016                                    ; $d016 is a VIC-II control register which contains the horizontal scroll value\n  and #$F8           \n  sta temp      \n      \n  ldy effectJitterCounter\n  lda effectJitterAmount,y\n  \n  ora temp\n  sta $d016\n\n  dey\n  sty effectJitterCounter\n\neffectJitterDone"}];this.entries=[];this.keyTriggers=[];this.instrTriggers=[];this.mostUsedCharacters=[];this.extendedColorCharsetData=[];this.charsetMap=[];this.extendedColorBGColors=[];this.keymap={a:33,b:67,c:66,d:34,e:97,f:82,g:35,h:83,i:20,j:36,k:84,l:37,m:68,n:116,o:100,p:21,q:103,r:18,s:81,t:98,u:99,v:115,w:17,x:114,y:19,z:65,0:52,1:7,2:55,3:1,4:49,5:2,6:50,7:3,8:51,9:4,"-":53,"=":5},this.colorSchemes={vice:[0,16777215,6829867,7382194,7290246,5803331,3483769,12109679,7294757,4405504,10119001,4473924,7105644,10146436,7102133,9803157],ccs64:[1645849,16579068,9648716,11991802,13794797,6999919,5194968,16513931,14195803,8344327,15696799,5723987,10725287,12057535,10721279,15722983]};this.c64Asm=null};ToPRGAdv.prototype={init:function(t){this.editor=t;this.c64Asm=new C64ASM;this.c64Asm.init(this.editor);var s=this;$("#exportPRGAdvCancel").on("click",function(){$("#exportPRGAdvTools").hide();s.editor.setLayoutType(s.editor.saveLayout)});$("#exportPRGAdvOK").on("click",function(){var e=$("input[name=prgAdvMode]:checked").val();var t="c64.prg";var i=$("input[name=prgAdvMusic]:checked").val()=="include";if(i){i="yes"}else{i="no"}var r=$("input[name=exportPRGAdvLayer]:checked").val();var a=$("#exportPRGAdvScrollV").is(":checked");s.createPRG({mode:e,filename:t,music:i,layers:r,scrollV:a})});$("#exportPRGAdvMonochromeColor").on("click",function(e){s.editor.colorPickerPopupMenu.createColorPicker(function(e){s.monochromeColor=e;var e=s.editor.petscii.getColor(s.monochromeColor);var t=Number(e).toString(16);while(t.length<6){t="0"+t}$("#exportPRGAdvMonochromeColor").css("background-color","#"+t)});t.showPopupMenu("colorPickerPopupMenu",function(e){})});$("input[name=prgAdvMode]").on("click",function(){var e=$("input[name=prgAdvMode]:checked").val();if(e=="monochrome"){$("#exportPRGAdvMonochromeColorRow").show()}else{$("#exportPRGAdvMonochromeColorRow").hide()}});this.entries=[];this.addRow();this.entries.push({type:"frameJump",jumpTo:1});this.tableHTML();this.keyTriggersHTML();this.instrTriggersHTML()},editCode:function(){this.c64Asm.editCode()},start:function(){this.monochromeColor=this.editor.tools.currentColor;var e=this.editor.petscii.getColor(this.monochromeColor);var t=Number(e).toString(16);while(t.length<6){t="0"+t}$("#exportPRGAdvMonochromeColor").css("background-color","#"+t);this.tableHTML();this.keyTriggersHTML();this.instrTriggersHTML();$("#exportPRGAdvTools").show()},writeKeyTriggersTable:function(){var e=this.keyTriggers;var t=e.length;e=[];for(var i=0;i<t;i++){var r=$("#prgkeytrigger"+i+"_key").val();var a=parseInt($("#prgkeytrigger"+i+"_goto").val());var s=parseInt($("#prgkeytrigger"+i+"_charset").val());var o=$("#prgkeytrigger"+i+"_action").val();e.push({triggerKey:r,action:o,gotoRow:a,charsetID:s})}this.keyTriggers=e},keyTriggersHTML:function(){var e=this.keyTriggers;var t="";t+='<button id="prgAddKeyTriggerRow">Add Key Trigger</button>';t+="<table>";for(var i=0;i<this.keyTriggers.length;i++){t+="<tr>";t+="<td>";var r=e[i].triggerKey;var a=e[i].action;if(typeof a=="undefined"){a="gotorow"}if(typeof r=="undefined"){r=""}t+='<label>Key: <input size="4" id="prgkeytrigger'+i+'_key" value="';t+=r;t+='"></label>';t+="</td>";t+="<td>";t+='<select class="prgKeyTriggerAction" id="prgkeytrigger'+i+'_action">';t+='<option value="gotorow" ';if(a=="gotorow"){t+=' selected="selected" '}t+=">Goto Row</option>";t+='<option value="nextframe" ';if(a=="nextframe"){t+=' selected="selected" '}t+=">Goto Next Frame</option>";t+='<option value="changecharset" ';if(a=="changecharset"){t+=' selected="selected" '}t+=">Change Character Set</option>";for(var s=0;s<this.effects.length;s++){t+='<option value="'+s+'" ';if(parseInt(a)==s){t+=' selected="selected" '}t+=">"+this.effects[s].name+"</option>"}t+="</select>";t+="</td>";t+="<td>";var o=e[i].gotoRow;if(typeof o=="undefined"){o=1}t+='<span id="prgkeytrigger'+i+'_gotosection"';if(a!="gotorow"){t+=' style="display:none" '}t+=">";t+='<label>Goto Row: <input size="4" id="prgkeytrigger'+i+'_goto" value="';t+=o;t+='"></label>';t+="</span>";var l=e[i].charsetID;if(typeof l=="undefined"){l=0}t+='<span id="prgkeytrigger'+i+'_charsetsection"';if(a!="changecharset"){t+=' style="display:none" '}t+=">";t+='<select id="prgkeytrigger'+i+'_charset">';for(var s=0;s<this.editor.tileSets.length;s++){t+='<option value="'+s+'"';if(s==l){t+=' selected="selected" '}t+=">"+this.editor.tileSets[s].name+"</option>"}t+="</select>";t+="</span>";t+="</td>";t+="<td>";t+='<button type="button" class="prgDeleteKeyTrigger" id="prgkeytrigger'+i+'_delete">Delete Trigger</button>';t+="</td>";t+="</tr>"}t+="</table>";$("#exportPRGAdvTriggers").html(t);this.setupKeyTriggerEvents()},setupKeyTriggerEvents:function(){var a=this;$("#prgAddKeyTriggerRow").on("click",function(){a.addKeyTrigger()});$(".prgKeyTriggerAction").on("change",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);if($(this).val()=="gotorow"){$("#"+i+"_gotosection").show()}else{$("#"+i+"_gotosection").hide()}if($(this).val()=="changecharset"){$("#"+i+"_charsetsection").show()}else{$("#"+i+"_charsetsection").hide()}});$(".prgDeleteKeyTrigger").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(13));a.writeKeyTriggersTable();a.keyTriggers.splice(r,1);a.keyTriggersHTML()})},addKeyTrigger:function(e){if(typeof e=="undefined"){e=0}this.writeKeyTriggersTable();if(this.keyTriggers.length==0){this.keyTriggers.push({type:"gotorow",gotoRow:1})}else{this.keyTriggers.splice(e,0,{type:"gotorow",gotoRow:1})}this.keyTriggersHTML()},writeInstrTriggersTable:function(){var e=this.instrTriggers;var t=e.length;e=[];for(var i=0;i<t;i++){var r=$("#prginstrtrigger"+i+"_instr").val();var a=$("#prginstrtrigger"+i+"_action").val();var s=parseInt($("#prginstrtrigger"+i+"_goto").val());var o=parseInt($("#prginstrtrigger"+i+"_charset").val());e.push({triggerInstr:r,action:a,gotoRow:s,charsetID:o})}this.instrTriggers=e},instrTriggersHTML:function(){var e=this.instrTriggers;var t="";t+='<button id="prgAddInstrTriggerRow">Add Instrument Trigger (ch 1)</button>';t+="<table>";for(var i=0;i<this.instrTriggers.length;i++){t+="<tr>";t+="<td>";var r=e[i].triggerInstr;var a=e[i].action;if(typeof a=="undefined"){a="gotorow"}if(typeof r=="undefined"){r=""}t+="<label>Instrument:";t+='<select id="prginstrtrigger'+i+'_instr">';for(var s=1;s<g_app.music.instruments.instruments.length;s++){t+='<option value="'+s+'"';if(s==r){t+=' selected="selected" '}t+=">";t+=g_app.music.instruments.instruments[s].name;t+="</option>"}t+="</select>";t+="</td>";t+="<td>";t+='<select class="prgInstrTriggerAction" id="prginstrtrigger'+i+'_action">';t+='<option value="gotorow" ';if(a=="gotorow"){t+=' selected="selected" '}t+=">Goto Row</option>";t+='<option value="nextframe" ';if(a=="nextframe"){t+=' selected="selected" '}t+=">Goto Next Frame</option>";t+='<option value="changecharset" ';if(a=="changecharset"){t+=' selected="selected" '}t+=">Change Character Set</option>";for(var s=0;s<this.effects.length;s++){t+='<option value="'+s+'" ';if(parseInt(a)==s){t+=' selected="selected" '}t+=">"+this.effects[s].name+"</option>"}t+="</select>";t+="</td>";t+="<td>";var o=e[i].gotoRow;if(typeof o=="undefined"){o=1}t+='<span id="prginstrtrigger'+i+'_gotosection"';if(a!="gotorow"){t+=' style="display:none" '}t+=">";t+='<label>Goto Row: <input size="4" id="prginstrtrigger'+i+'_goto" value="';t+=o;t+='"></label>';t+="</span>";var l=e[i].charsetID;if(typeof l=="undefined"){l=0}t+='<span id="prginstrtrigger'+i+'_charsetsection"';if(a!="changecharset"){t+=' style="display:none" '}t+=">";t+='<select id="prginstrtrigger'+i+'_charset">';for(var s=0;s<this.editor.tileSets.length;s++){t+='<option value="'+s+'"';if(s==l){t+=' selected="selected" '}t+=">"+this.editor.tileSets[s].name+"</option>"}t+="</select>";t+="</span>";t+="</td>";t+="<td>";t+='<button type="button" class="prgDeleteInstrTrigger" id="prginstrtrigger'+i+'_delete">Delete Trigger</button>';t+="</td>";t+="</tr>"}t+="</table>";$("#exportPRGAdvInstrTriggers").html(t);this.setupInstrTriggerEvents()},setupInstrTriggerEvents:function(){var a=this;$("#prgAddInstrTriggerRow").on("click",function(){a.addInstrTrigger()});$(".prgInstrTriggerAction").on("change",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);if($(this).val()=="gotorow"){$("#"+i+"_gotosection").show()}else{$("#"+i+"_gotosection").hide()}if($(this).val()=="changecharset"){$("#"+i+"_charsetsection").show()}else{$("#"+i+"_charsetsection").hide()}});$(".prgDeleteInstrTrigger").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(13));a.writeInstrTriggersTable();a.instrTriggers.splice(r,1);a.instrTriggersHTML()})},addInstrTrigger:function(e){if(typeof e=="undefined"){e=0}this.writeInstrTriggersTable();if(this.instrTriggers.length==0){this.instrTriggers.push({type:"gotorow",gotoRow:1})}else{this.instrTriggers.splice(e,0,{type:"gotorow",gotoRow:1})}this.instrTriggersHTML()},tableHTML:function(){var e=1;var t=1;if(this.editor.graphic){t=this.editor.graphic.getFrameCount()}var i="Choose frames between <strong>1</strong> and <strong>"+t+"</strong>";$("#exportPRGFramesInstructions").html(i);var r="";r+='<button id="prgAddRow">Add Row</button>';r+="<table>";for(var a=0;a<this.entries.length;a++){var s=a+1;r+="<tr>";r+="<td>"+s+"</td>";r+="<td>";r+='<select class="prgrowtype" id="prgrow'+a+'_type">';r+='<option value="frame">Frame</option>';r+='<option value="frameRange"';if(this.entries[a].type=="frameRange"){r+=' selected="selected" '}r+=">Frame Range</option>";r+='<option value="frameJump"';if(this.entries[a].type=="frameJump"){r+='selected="selected" '}r+=">Jump To</option>";r+="</select>";r+="</td>";var o=1;if(typeof this.entries[a].frame!="undefined"){o=this.entries[a].frame}var l=12;if(typeof this.entries[a].duration!="undefined"){l=this.entries[a].duration}var n=1;if(typeof this.entries[a].from!="undefined"){n=this.entries[a].from}var h=1;if(typeof this.entries[a].to!="undefined"){h=this.entries[a].to}var d=1;if(typeof this.entries[a].jumpTo!="undefined"){d=this.entries[a].jumpTo}r+="<td>";r+='<span id="prgrow'+a+'_frameParams"';if(this.entries[a].type!="frame"){r+=' style="display: none" '}r+=">";r+='<label>Frame: <input size="3" value="';r+=o;r+='" id="prgrow'+a+'_frame"/></label>';r+="&nbsp;&nbsp;";r+='<label>Duration: <input size="3" value="';r+=l;r+='" id="prgrow'+a+'_duration"/> ticks</label>';r+="</span>";r+='<span id="prgrow'+a+'_frameRangeParams"';if(this.entries[a].type!="frameRange"){r+=' style="display: none" '}r+=">";r+='From: <input size="3" value="'+n+'" id="prgrow'+a+'_from"/>';r+='&nbsp;To: <input size="3" value="'+h+'" id="prgrow'+a+'_to"/>';r+="</span>";r+='<span id="prgrow'+a+'_frameJumpParams"';if(this.entries[a].type!="frameJump"){r+=' style="display: none" '}r+=">";r+='Row: <input size="3" value="'+d+'" id="prgrow'+a+'_jumpTo"/>';r+="</span>";r+="</td>";r+="<td>";r+='<button type="button" class="prgAddRow" id="prgrow'+a+'_add">Add Row</button>';r+="&nbsp;";r+='<button type="button" class="prgDeleteRow" id="prgrow'+a+'_delete">Delete Row</button>';r+="</td>";r+="</tr>"}r+="</table>";$("#exportPRGAdvTable").html(r);this.setupTableEvents()},setupTableEvents:function(){var a=this;$("#prgAddRow").on("click",function(){a.addRow()});$(".prgrowtype").on("change",function(){var e=$(this).attr("id");var t=$(this).val();var i=e.indexOf("_");var r=e.substr(0,i);if(t=="frame"){$("#"+r+"_frameParams").show();$("#"+r+"_frameRangeParams").hide();$("#"+r+"_frameJumpParams").hide()}else if(t=="frameRange"){$("#"+r+"_frameParams").hide();$("#"+r+"_frameRangeParams").show();$("#"+r+"_frameJumpParams").hide()}else if(t=="frameJump"){$("#"+r+"_frameParams").hide();$("#"+r+"_frameRangeParams").hide();$("#"+r+"_frameJumpParams").show()}});$(".prgAddRow").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(6))+1;a.addRow(r)});$(".prgDeleteRow").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(6));a.writeEntriesTable();a.entries.splice(r,1);a.tableHTML()})},writeEntriesTable:function(){var e=this.entries.length;this.entries=[];for(var t=0;t<e;t++){var i=$("#prgrow"+t+"_type").val();if(i=="frame"){var r=parseInt($("#prgrow"+t+"_frame").val());var a=parseInt($("#prgrow"+t+"_duration").val());this.entries.push({type:"frame",frame:r,duration:a})}else if(i=="frameRange"){var s=parseInt($("#prgrow"+t+"_from").val());var o=parseInt($("#prgrow"+t+"_to").val());this.entries.push({type:"frameRange",from:s,to:o})}else if(i=="frameJump"){var l=parseInt($("#prgrow"+t+"_jumpTo").val());this.entries.push({type:"frameJump",jumpTo:l})}}},addRow:function(e){if(typeof e=="undefined"){e=0}this.writeEntriesTable();if(this.entries.length==0){this.entries.push({type:"frame",frame:1,duration:12})}else{this.entries.splice(e,0,{type:"frame",frame:1,duration:12})}this.tableHTML()},getMostUsedCharacters:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=i.getTileSet();var a=r.getTileCount();if(!i||i.getType()!="grid"){alert("Please choose a grid layer");return}if(i.getScreenMode()==TextModeEditor.Mode.C64ECM){this.mostUsedCharacters=[];for(var s=0;s<a;s++){this.mostUsedCharacters.push({c:s,timesUsed:0})}}else{this.mostUsedCharacters=[];for(var s=0;s<a;s++){this.mostUsedCharacters.push({c:s,timesUsed:0})}var o=0;var l=e.gridWidth;var n=e.gridHeight;var h=e.frames;for(var d=0;d<t.length;d++){var c=t[d];for(var f=0;f<n;f++){for(var u=0;u<l;u++){var p=i.getCell({x:u,y:f,frame:c});var v=p.t;if(v<this.mostUsedCharacters.length){this.mostUsedCharacters[v].timesUsed++}}}}this.mostUsedCharacters.sort(function(e,t){return t.timesUsed-e.timesUsed})}},getCharsetData:function(e){var t=e.getTileCount();this.charsetData=[];this.charsetMap=[];var i=e.getTileWidth();var r=e.getTileHeight();var t=e.getTileCount();for(var a=0;a<t;a++){this.charsetMap[a]=0}for(var a=0;a<t;a++){var s=a;if(t>t){s=this.mostUsedCharacters[a].c;this.charsetMap[s]=a}else{this.charsetMap[a]=a}for(var o=0;o<8;o++){var l=0;for(var n=0;n<8;n++){if(n<i&&o<r){if(e.getPixel(s,n,o)){l=l|1<<7-n}}}this.charsetData.push(l)}}},getTallerCharsetData:function(e,t,i){if(typeof i=="undefined"){i=false}this.charsetData=[];this.extendedColorCharsetData=[];this.charsetMap=[];var r=e.getTileWidth();var a=e.getTileHeight();var s=e.getTileCount();for(var o=0;o<s;o++){this.charsetMap[o]=0}var l=128;if(i){l=32}for(var o=0;o<l;o++){var n=this.mostUsedCharacters[o].c;this.charsetMap[n]=o;for(var h=0;h<8;h++){var d=0;for(var c=0;c<8;c++){if(c<r&&h<a){if(e.getPixel(n,c,h)){d=d|1<<7-c}}}if(i){this.extendedColorCharsetData.push(d)}else{this.charsetData.push(d)}}}for(var o=0;o<l;o++){var n=this.mostUsedCharacters[o].c;this.charsetMap[n]=o;for(var h=8;h<16;h++){var d=0;for(var c=0;c<8;c++){if(c<r&&h<a){if(e.getPixel(n,c,h)){d=d|1<<7-c}}}if(i){this.extendedColorCharsetData.push(d)}else{this.charsetData.push(d)}}}},getExtendedColorCharsetData:function(e,t){this.extendedColorCharsetData=[];this.charsetMap=[];var i=e.getTileWidth();var r=e.getTileHeight();var a=e.getTileCount();for(var s=0;s<a;s++){this.charsetMap[s]=0}for(var s=0;s<256;s++){var o=this.mostUsedCharacters[s].c;this.charsetMap[o]=s;if(s<64){for(var l=0;l<8;l++){var n=0;for(var h=0;h<8;h++){if(h<i&&l<r){if(e.getPixel(o,h,l)){n=n|1<<7-h}}}this.extendedColorCharsetData.push(n)}}}},getExtendedColorBGColors:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){alert("Please choose a grid layer");return}this.extendedColorBGColors=[];if(i.getScreenMode()==TextModeEditor.Mode.C64ECM){var r=t[0];for(var a=0;a<4;a++){this.extendedColorBGColors.push({color:i.getC64ECMColor(a,r),timesUsed:10})}}else{var s=0;var o=e.gridWidth;var l=e.gridHeight;var n=e.frames;var h=[];for(var a=0;a<16;a++){h[a]={color:a,timesUsed:0}}for(var d=0;d<t.length;d++){var r=t[d];for(var c=0;c<l;c++){for(var f=0;f<o;f++){var u=0;var p=i.getCell({x:f,y:c,frame:r});u=p.bc;u=this.getC64Color(u);if(typeof u!="undefined"&&u!==false){h[u].timesUsed++}else{if(n[r].frameData.bgColor<16){h[n[r].frameData.bgColor].timesUsed++}}}}}h.sort(function(e,t){return t.timesUsed-e.timesUsed});for(var a=0;a<4;a++){this.extendedColorBGColors[a]=h[a]}}return true},effectsCode:function(){var e="";for(var t=0;t<this.effects.length;t++){e+="  jsr effect"+t+"_init\n"}e+="  rts\n";e+="effects_trigger\n";var i=0;var r=0;for(var t=0;t<this.effects.length;t++){i=t+4;r=i+1;e+="effect_trigger_"+i+"\n";e+="  cmp #"+i+"\n";e+="  bne effect_trigger_"+r+"\n";e+="  jmp effect"+t+"_trigger"+"\n"}e+="effect_trigger_"+r+"\n";e+="  rts\n";e+="effects_tick\n";for(var t=0;t<this.effects.length;t++){e+=" jsr effect"+t+"_tick\n"}e+="  rts\n";for(var t=0;t<this.effects.length;t++){e+="effect"+t+"_data\n";e+=this.effects[t].data+"\n";e+="effect"+t+"_init\n";e+=this.effects[t].init+"\n";e+="  rts\n";e+="effect"+t+"_trigger\n";e+=this.effects[t].trigger+"\n";e+="  rts\n";e+="effect"+t+"_tick\n";e+=this.effects[t].tick+"\n";e+="  rts\n"}return e},getC64Color:function(e){if(this.colorMap[e]!==false){return this.colorMap[e]}var t=this.editor.colorPaletteManager.getCurrentColorPalette();if(t.getIsC64Palette()){return e}var i=t.getColor(e);if(typeof i.laba=="undefined"){return e}var r=0;var a=false;for(var s=0;s<this.c64Colors.length;s++){var o=0;o+=Math.abs(i.laba.values[0]-this.c64Colors[s].laba.values[0]);o+=Math.abs(i.laba.values[1]-this.c64Colors[s].laba.values[1]);o+=Math.abs(i.laba.values[2]-this.c64Colors[s].laba.values[2]);if(a===false||o<a){a=o;r=s}}this.colorMap[e]=r;return this.colorMap[e]},assembleCode:function(e){var t=this.editor.frames.width;var i=this.editor.frames.width;var r=(i-24)*t>>8&255;var a=(i-24)*t&255;args={};args["FRAMEWIDTHHIGH"]="#0";args["FRAMEWIDTHLOW"]="#"+t;args["VERTICALSCROLLMAXHIGH"]="#"+r;args["VERTICALSCROLLMAXLOW"]="#"+a;for(var s in args){if(args.hasOwnProperty(s)){var o=args[s];e=e.replace(new RegExp(s,"g"),o)}}var l=g_app.assembler;var n=l.assemble(e,2049);if(n.success){var h=l.getMemory();var d=0;this.prg=[];this.prg[d++]=1;this.prg[d++]=8;for(var c=n.start;c<n.end;c++){this.prg[d++]=h[c]}this.blocks=n.blocks;var f="";for(var c=0;c<this.prg.length;c++){f+=this.prg[c].toString(16)+"\n"}f=l.getDisassembly();$("#c64PRGCodeEditorResult").val(f)}else{var f="ERRORS FOUND:\n";for(var c=0;c<n.errors.length;c++){f+=n.errors[c].message+"\n"}$("#c64PRGCodeEditorResult").val(f)}},getBackgroundColor:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return this.editor.colorPaletteManager.noColor}var i=t.getBackgroundColor(e);if(i!=this.editor.colorPaletteManager.noColor){return i}var r=this.editor.layers.getSelectedLayerIndex();while(r>0){r--;var t=this.editor.layers.getLayerObjectFromIndex(r);if(t&&typeof t.getBackgroundColor!="undefined"){i=t.getBackgroundColor(e);if(i!=this.editor.colorPaletteManager.noColor){return i}}}return this.editor.colorPaletteManager.noColor},getBorderColor:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return this.editor.colorPaletteManager.noColor}var t=e.getBorderColor();if(t!=this.editor.colorPaletteManager.noColor){return t}var i=this.editor.layers.getSelectedLayerIndex();while(i>0){i--;var e=this.editor.layers.getLayerObjectFromIndex(i);if(e&&typeof e.getBorderColor!="undefined"){t=e.getBorderColor();if(t!=this.editor.colorPaletteManager.noColor){return t}}}return this.editor.colorPaletteManager.noColor},createPRG:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){alert("Please choose a grid layer");return}if(t.getBlockModeEnabled()){}var i=t.getColorPalette();var r=t.getTileSet();var a=t.getColorPerMode();if(a=="character"){t.updateGridColorsFromTiles()}var s="c64.prg";var o=true;var l="current";if(typeof e.layers!="undefined"){l=e.layers}if(typeof e.download!="undefined"){o=e.download}var n=e.gridWidth;var h=e.gridHeight;if(r.getTileHeight()>8){h=h*2}var d=false;if(h>25||n>40){if(typeof e.scrollV!="undefined"){d=e.scrollV}}if(!d){if(n>40){n=40}if(h>25){h=25}}if(i.getColorCount()==16){this.colorMap=[];for(var c=0;c<i.getColorCount();c++){this.colorMap.push(c)}}else{this.colorMap=[];for(var c=0;c<i.getColorCount();c++){this.colorMap.push(false)}}this.c64Colors=[];for(var c=0;c<this.colorSchemes.vice.length;c++){var f={};f.hex=this.colorSchemes.vice[c];var u=f.hex>>16&255;var p=f.hex>>8&255;var v=f.hex&255;f.r=u/255;f.g=p/255;f.b=v/255;var g={};g.values=[u,p,v,255];f.hsv=Colour.converters[Colour.RGBA][Colour.HSVA](g);f.laba=Colour.converters[Colour.RGBA][Colour.LABA](g);this.c64Colors.push(f)}var m=e.mode=="extended";var y=e.mode=="multicolor";var b=e.mode=="monochrome";if(b&&typeof e.monochromeColor!="undefined"){this.monochromeColor=e.monochromeColor}var C=false;var x=e.music;if(typeof x=="undefined"){x="no"}var C=!r.isDefaultTileSet("c64");var S=r.getTileCount();if(S!=256){C=true}else{for(var c=0;c<S;c++){if(r.tileData[c].props.animated!==false){C=true;break}}}for(var c=0;c<S;c++){this.charsetMap[c]=c}var P=e.frames;var w=this.editor.grid.xyPosition;if(typeof e.fgPosition!="undefined"){w=e.fgPosition}var I=0;if(d){code=C64ASMScroll}else{code=this.c64Asm.files.load("/main.asm")}effectsCode="\ninit_effects\n"+this.effectsCode();code=code.replace("\ninit_effects",effectsCode);var k=n&255;var M=n>>8&255;var T=(h-24)*n>>8&255;var D=(h-24)*n&255;this.assembleCode(code);var E=[];var _=[];for(var c=0;c<this.blocks.length;c++){_.push({type:"Code",start:this.blocks[c].start,end:this.blocks[c].end,label:this.blocks[c].label})}if(typeof e.filename!="undefined"){s=e.filename}var B=[];if(typeof e.entries=="undefined"){this.writeEntriesTable();B=this.entries}else{B=e.entries}var R=[];if(typeof e.keyTriggers=="undefined"){this.writeKeyTriggersTable();R=this.keyTriggers}else{R=e.keyTriggers}var A=[];if(typeof e.instrTriggers=="undefined"){this.writeInstrTriggersTable();A=this.instrTriggers}else{A=e.instrTriggers}var F=[];var L=[];var U=-1;for(var c=0;c<B.length;c++){if(B[c].type=="frame"){var H=parseInt(B[c].frame);var O=false;var G=false;var z=false;for(var N=0;N<B.length;N++){if(B[N].type=="frameJump"){var W=parseInt(B[N].jumpTo)-1;var X=0;if(B[W].type=="frame"){X=B[W].frame}else if(B[W].type=="frameRange"){X=B[W].from}if(H==X){G=true;break}}}for(var N=0;N<R.length;N++){if(R[N].action=="gotorow"){var Y=parseInt(R[N].gotoRow)-1;var V=0;if(B[Y].type=="frame"){V=B[Y].frame}else if(B[Y].type=="frameRange"){V=B[Y].from}if(H==V){G=true;z=true;break}}}for(var N=0;N<A.length;N++){if(A[N].action=="gotorow"){var Y=parseInt(A[N].gotoRow)-1;var V=0;if(B[Y].type=="frame"){V=B[Y].frame}else if(B[Y].type=="frameRange"){V=B[Y].from}if(H==V){G=true;z=true;break}}}for(var N=0;N<F.length;N++){if(F[N].frame==H){if(U!=F[N].previousFrame){F[N].canWriteAsChanges=false}O=true;break}}if(!O){F.push({frame:H,previousFrame:U,canWriteAsRLE:!G&!z,canWriteAsChanges:U!=-1&!G});L.push(H-1)}U=H}else if(B[c].type=="frameRange"){var q=parseInt(B[c].from);var j=parseInt(B[c].to);var K=1;if(j<q){K=-1}for(var H=q;H!=j+K;H+=K){var G=false;var z=false;for(var N=0;N<B.length;N++){if(B[N].type=="frameJump"){var W=parseInt(B[N].jumpTo)-1;var X=0;if(B[W].type=="frame"){X=B[W].frame}else if(B[W].type=="frameRange"){X=B[W].from}if(H==X){G=true;break}}}for(var N=0;N<R.length;N++){if(R[N].action=="gotorow"){var Y=parseInt(R[N].gotoRow)-1;var V=0;if(B[Y].type=="frame"){V=B[Y].frame}else if(B[Y].type=="frameRange"){V=B[Y].from}if(H==V){G=true;z=true;break}}}for(var N=0;N<A.length;N++){if(A[N].action=="gotorow"){var Y=parseInt(A[N].gotoRow)-1;var V=0;if(B[Y].type=="frame"){V=B[Y].frame}else if(B[Y].type=="frameRange"){V=B[Y].from}if(H==V){G=true;z=true;break}}}var O=false;for(var N=0;N<F.length;N++){if(F[N].frame==H){if(U!=F[N].previousFrame){F[N].canWriteAsChanges=false}O=true;break}}if(!O){F.push({frame:H,previousFrame:U,canWriteAsRLE:!G&!z,canWriteAsChanges:U!=-1&!G});L.push(H-1)}U=H}}}this.sidData=null;if(x!="no"&&x!="sid"){var Z=x;if(g_app.doc.getDocRecord(Z)!=null){g_app.music.show(Z);var J=4096;this.sidHeaderLength=0;this.sidLoadAddr=J;this.sidInitAddr=J;this.sidPlayAddr=J+3;this.sidSpeed=g_app.music.sidSpeed;g_app.music.createSid();if(typeof g_app.music.musicPlayer2.songData!="undefined"&&typeof g_app.music.musicPlayer2.songData.getSIDData!="undefined"){this.sidData=g_app.music.musicPlayer2.songData.getSIDData()}else{alert("sorry, the current music play does not support sid data export");this.sidData=null}}}if(x=="no"){this.sidData=null}if(x=="sid"){this.sidHeaderLength=126;this.sidLoadAddr=e.sidLoadAddr;this.sidInitAddr=e.sidInitAddr;this.sidPlayAddr=e.sidPlayAddr;this.sidSpeed=e.sidSpeed;if(this.sidSpeed<1){this.sidSpeed=1}this.sidData=e.sidData}var Q=this.prg;var ee=new Uint8Array(64e3);var te=0;var ie=this.getBorderColor();var re=this.getBackgroundColor();te=0;var ae=te;for(var c=0;c<Q.length;c++){ee[te++]=Q[c]}le=te;E.push({type:"Code",from:ae,to:le});var se=1;if(m){if(this.getExtendedColorBGColors(e,L)){this.getMostUsedCharacters(e,L);var oe=0;for(var c=0;c<se;c++){r=t.getTileSet();if(r.getTileHeight()>8){this.getTallerCharsetData(r,c,m)}else{this.getExtendedColorCharsetData(r,c)}C=true;te=14336-2049+2-2048*oe;r.memoryLocation=7-oe<<1;var ae=te;for(var N=0;N<this.extendedColorCharsetData.length;N++){ee[te++]=this.extendedColorCharsetData[N]}var le=te;E.push({type:"Character Data",from:ae,to:le});_.push({type:"Character Set Data",start:ae+2049-2,end:le+2049-2});oe++}}else{m=false}}else{if(r.getTileHeight()>8){this.getMostUsedCharacters(e,L);var oe=0;for(var c=0;c<se;c++){r=t.getTileSet();te=14336-2049+2-2048*oe;r.memoryLocation=7-oe<<1;var ae=te;this.getTallerCharsetData(r,c);for(var N=0;N<this.charsetData.length;N++){ee[te++]=this.charsetData[N]}var le=te;_.push({type:"Character Set Data ("+r.name+")",start:ae+2049-2,end:le+2049-2});oe++}}else{var oe=0;this.getMostUsedCharacters(e,L);for(var c=0;c<se;c++){r=t.getTileSet();if(r.isDefaultTileSet("c64")){r.memoryLocation=4}else{te=14336-2049+2-2048*oe;r.memoryLocation=7-oe<<1;var ae=te;this.getCharsetData(r);for(var N=0;N<this.charsetData.length;N++){ee[te++]=this.charsetData[N]}var le=te;_.push({type:"Character Set Data ("+r.name+")",start:ae+2049-2,end:le+2049-2});oe++}}}}te=4095-2049+2;if(this.sidData){var ne=te+2049-2;if(ne>this.sidLoadAddr){this.sidData=null}else{te=this.sidLoadAddr-2049+2;var ae=te;for(var c=this.sidHeaderLength;c<this.sidData.length;c++){ee[te++]=this.sidData[c]}var le=te;E.push({type:"SID",from:ae,to:le});_.push({type:"SID",start:ae+2049-2,end:le+2049-2})}}else{}var he=te;console.log("frame ptr table addr:"+he);te+=600;var de=false;var ce=0;var ae=te;var S=r.getTileCount();for(var c=0;c<S;c++){var fe=r.getAnimatedType(c);var ue=r.getTileProperties(c);if(fe!==false){var pe=0;if(c<this.charsetMap.length){pe=this.charsetMap[c]}C=true;ee[te++]=ue.ticksPerFrame;ee[te++]=ue.ticksPerFrame;ee[te++]=pe*8&255;ee[te++]=pe*8>>8;switch(fe){case"right":ee[te++]=1;break;case"up":ee[te++]=2;break;case"down":ee[te++]=3;break;case"blink":ee[te++]=4;break;default:case"left":ee[te++]=0;break}ce++}}ee[te++]=0;var de=ae;var le=te;if(le!=ae){E.push({type:"Animated Characters Table",from:ae,to:le});_.push({type:"Animated Characters Table",start:ae+2049-2,end:le+2049-2})}var ae=te;for(var c=0;c<4;c++){ee[te++]=6;ee[te++]=6;ee[te++]=c}ee[te++]=0;var ve=ae;var le=te;if(le!=ae){E.push({type:"Animated BG Colours Table",from:ae,to:le});_.push({type:"Animated BG Colours Table",start:ae+2049-2,end:le+2049-2})}var ge=te;var me=2064-2049+2;var ye=me;ee[ye++]=this.getC64Color(ie);if(m){ee[ye++]=1}else if(y){ee[ye++]=2}else{ee[ye++]=0}if(C){ee[ye++]=1}else{ee[ye++]=0}if(this.sidData){ee[ye++]=1;ee[ye++]=this.sidSpeed;ee[ye++]=this.sidInitAddr&255;ee[ye++]=this.sidInitAddr>>8;ee[ye++]=this.sidPlayAddr&255;ee[ye++]=this.sidPlayAddr>>8}else{ee[ye++]=0;ee[ye++]=0;ee[ye++]=0;ee[ye++]=0;ee[ye++]=0;ee[ye++]=0}ee[ye++]=he+2049-2&255;ee[ye++]=he+2049-2>>8;ee[ye++]=de+2049-2&255;ee[ye++]=de+2049-2>>8;ee[ye++]=ve+2049-2&255;ee[ye++]=ve+2049-2>>8;var be=[];var Ce=0;for(var xe=0;xe<F.length;xe++){var H=F[xe].frame-1;if(m){this.getExtendedColorBGColors(e,[H])}else{this.extendedColorBGColors=[];re=this.getBackgroundColor(H);if(y){var Se=t.getC64Multi1Color();var Pe=t.getC64Multi2Color();this.extendedColorBGColors.push({color:this.getC64Color(re)});this.extendedColorBGColors.push({color:this.getC64Color(Se)});this.extendedColorBGColors.push({color:this.getC64Color(Pe)});this.extendedColorBGColors.push({color:0})}else{this.extendedColorBGColors.push({color:this.getC64Color(re)});this.extendedColorBGColors.push({color:0});this.extendedColorBGColors.push({color:0});this.extendedColorBGColors.push({color:0})}}var we=1;var Ie=[];var ke=[];var Me=[];var Te=1;var De=[];var Ee=[];for(var $e=0;$e<h;$e++){for(var _e=0;_e<n;_e++){var Be=this.editor.tileSetManager.blankCharacter;var Re=$e;var Ae=0;if(r.charHeight>8){Re=Math.floor(Re/2);if($e%2!=0){Ae=128;if(m){Ae=32}}}var f=P[H].frameData.data[Re][_e].fc;var Fe=false;if(l=="merge"){}else{Be=P[H].frameData.data[Re][_e].t}if(b){f=this.monochromeColor}if(Be<this.charsetMap.length){Be=this.charsetMap[Be]+Ae}else{Be=0}if(m){if(l!=="merge"){if(this.editor.bgInPrevLayer){Fe=P[H].frameData.data[Re][_e].fc}else{Fe=P[H].frameData.data[Re][_e].bc}}if(typeof Fe=="undefined"||Fe===false){Fe=this.getBackgroundColor(H)}if(t.getScreenMode()!==TextModeEditor.Mode.C64ECM){Fe=this.getC64Color(Fe);for(var c=0;c<this.extendedColorBGColors.length;c++){if(Fe==this.extendedColorBGColors[c].color){Fe=c;break}}Fe=Fe&3;Be=Be|Fe<<6}else{Fe=P[H].frameData.data[Re][_e].bc;if(Fe==this.editor.colorPaletteManager.noColor){}else{Fe=Fe&3;Be=Be|Fe<<6}}}Ie.push(Be);De.push(this.getC64Color(f))}}var Le=-1;var Ue=0;var He=250;for(var c=0;c<Ie.length;c++){Ue=0;Le=Ie[c];while(c<Ie.length&&Le==Ie[c]&&Ue<He){c++;Ue++}Me.push(Ue);Me.push(Le);if(Ue>0){c--}}Me.push(0);if(F[xe].canWriteAsChanges){var U=F[xe].previousFrame;var Oe=-1;for(var c=0;c<F.length;c++){if(F[c].frame==U){Oe=c;break}}if(Oe!=-1){var Ge=0;for(var c=0;c<Ie.length;c++){var ze=Ie[c];var Ne=F[Oe].frameData.charData[c];if(ze!=Ne||Ge>200){ke.push(Ge);ke.push(ze);Ge=0}Ge++}if(ke.length==1){ke.push(F[Oe].frameData.charData[0])}ke.push(0);if(ke.length<900){we=2}var Ge=0;for(var c=0;c<De.length;c++){var We=De[c];var Xe=F[Oe].frameData.colorData[c];if(We!=Xe||Ge>200){Ee.push(Ge);Ee.push(We);Ge=0}Ge++}Ee.push(0);if(Ee.length==1){Ee.push(F[Oe].frameData.colorData[0]);Ee.push(0)}if(Ee.length<240){Te=2}}}if(F[xe].canWriteAsRLE){if(we==1&&Me.length<600&&Me.length!=0){we=3}}if(d){we=1;Te=1}var Ye=P[H].duration;if(Ye>255){Ye=255}if(Ye<7){Ye=7}var Ve={charFrameType:we,colorFrameType:Te,duration:Ye,charData:Ie,charChangesData:ke,charRLEData:Me,colorData:De,colorChangesData:Ee,bgColor1:this.extendedColorBGColors[0].color,bgColor2:this.extendedColorBGColors[1].color,bgColor3:this.extendedColorBGColors[2].color,bgColor4:this.extendedColorBGColors[3].color};F[xe].frameData=Ve}var qe=14336-2049+2;var je=2048;if(m){je=this.extendedColorCharsetData.length}var te=ge;var Ke=he;var Ze=0;var Je=false;for(var c=0;c<F.length;c++){var Ve=F[c].frameData;var Qe=Ve.charData.length;var et=Ve.colorData.length;if(Ve.colorFrameType==2){et=Ve.colorChangesData.length}var tt=false;while(!tt){tt=true;for(var N=0;N<_.length;N++){if(te+2049-2<_[N].end&&te+Qe+2049-2>=_[N].start){tt=false;te=_[N].end-2049+2;var it=te+2049-2}}}var it=te+2049-2;if(te+Qe+et>53248-2049){break}var rt=te;var ae=te;if(Ve.charFrameType==1){for(var N=0;N<Ve.charData.length;N++){ee[te++]=Ve.charData[N]}}else if(Ve.charFrameType==2){for(var N=0;N<Ve.charChangesData.length;N++){ee[te++]=Ve.charChangesData[N]}}else if(Ve.charFrameType==3){for(var N=0;N<Ve.charRLEData.length;N++){ee[te++]=Ve.charRLEData[N]}}else{alert("???")}var le=te;E.push({type:"Frame Data",from:ae,to:le});_.push({type:"Frame "+c+" Char Data",start:ae+2049-2,end:le+2049-2});var at=te;var st=false;if(!d){st=true}if(Ve.colorFrameType==1){if(Je!==false&&st){var ae=Je;at=Je;for(var N=0;N<Ve.colorData.length;N++){ee[Je]=Ve.colorData[N];N++;ee[Je]=ee[Je]|Ve.colorData[N]<<4;Je+=2}var le=Je;_.push({type:"Frame "+c+" Color Data (4 bit)",start:ae+2049-2,end:le+2049-2});Je=false}else{var tt=false;while(!tt){tt=true;for(var N=0;N<_.length;N++){if(te+2049-2<_[N].end&&te+et+1+2049-2>=_[N].start){tt=false;te=_[N].end-2049+2}}}at=te;var ae=te;if(st){for(var N=0;N<Ve.colorData.length;N++){ee[te]=Ve.colorData[N];N++;ee[te]=ee[te]|Ve.colorData[N]<<4;te+=2}te++}else{for(var N=0;N<Ve.colorData.length;N++){ee[te++]=Ve.colorData[N]}te++}var le=te;E.push({type:"Frame Color Data",from:ae,to:le});Je=at+1;_.push({type:"Frame "+c+" Color Data (4 bit)",start:ae+2049-2,end:le+2049-2})}}else if(Ve.colorFrameType==2){var tt=false;while(!tt){tt=true;for(var N=0;N<_.length;N++){if(te+2049-2<_[N].end&&te+et+1+2049-2>=_[N].start){tt=false;te=_[N].end-2049+2}}}at=te;var ae=te;for(var N=0;N<Ve.colorChangesData.length;N++){ee[te++]=Ve.colorChangesData[N]}var le=te;E.push({type:"Frame Color Data",from:ae,to:le});_.push({type:"Frame "+c+" Color Data (changes)",start:ae+2049-2,end:le+2049-2})}else{alert("???")}Ze++;F[c].charAddress=rt+2049-2;F[c].colorAddress=at+2049-2;var ot=Ke+2049-2}console.log("frame table index = "+Ke);var ae=Ke;var lt=[];lt[0]=0;var nt=true;var ht=false;var dt=false;for(var c=0;c<B.length;c++){var Re=c+1;lt[Re]=Ke;if(B[c].type=="frame"){var H=parseInt(B[c].frame);for(var N=0;N<F.length;N++){if(F[N].frame==H){var Ve=F[N].frameData;var Ye=parseInt(B[c].duration);if(Ye<6){Ye=6}if(Ye>255){Ye=255}ee[Ke++]=Ve.charFrameType;ee[Ke++]=F[N].charAddress&255;ee[Ke++]=F[N].charAddress>>8;ee[Ke++]=Ye;ee[Ke++]=Ve.colorFrameType;ee[Ke++]=F[N].colorAddress&255;ee[Ke++]=F[N].colorAddress>>8;ee[Ke++]=Ve.bgColor1;ee[Ke++]=Ve.bgColor2;ee[Ke++]=Ve.bgColor3;ee[Ke++]=Ve.bgColor4;if(nt&&R.length>0){ee[Ke++]=1;ht=Ke;ee[Ke++]=0;ee[Ke++]=0}if(nt&&A.length>0){ee[Ke++]=3;dt=Ke;ee[Ke++]=0;ee[Ke++]=0}nt=false;ee[Ke++]=0}}}else if(B[c].type=="frameRange"){var q=B[c].from;var j=B[c].to;var O=false;var K=1;if(j<q){K=-1}for(var H=q;H!=j+K;H+=K){for(var N=0;N<F.length;N++){if(F[N].frame==H){var ct=Ke;var Ve=F[N].frameData;ee[Ke++]=Ve.charFrameType;ee[Ke++]=F[N].charAddress&255;ee[Ke++]=F[N].charAddress>>8;ee[Ke++]=Ve.duration;ee[Ke++]=Ve.colorFrameType;ee[Ke++]=F[N].colorAddress&255;ee[Ke++]=F[N].colorAddress>>8;ee[Ke++]=Ve.bgColor1;ee[Ke++]=Ve.bgColor2;ee[Ke++]=Ve.bgColor3;ee[Ke++]=Ve.bgColor4;if(nt&&R.length>0){ee[Ke++]=1;ht=Ke;ee[Ke++]=0;ee[Ke++]=0}if(nt&&A.length>0){ee[Ke++]=3;dt=Ke;ee[Ke++]=0;ee[Ke++]=0}nt=false;ee[Ke++]=0;var ft=Ke;break}}}}else if(B[c].type=="frameJump"){var W=B[c].jumpTo;var ut=lt[W]+2049-2;ee[Ke++]=0;ee[Ke++]=ut&255;ee[Ke++]=ut>>8}}ee[Ke++]=0;ee[Ke++]=he+2049-2&255;ee[Ke++]=he+2049-2>>8;if(R.length>0){var pt=Ke+2049-2;ee[ht++]=pt&255;ee[ht]=pt>>8}for(var c=0;c<R.length;c++){var Y=R[c].gotoRow;var ut=lt[Y]+2049-2;var vt=R[c].triggerKey.toLowerCase();ee[Ke++]=this.keymap[vt];if(R[c].action=="gotorow"){ee[Ke++]=0;ee[Ke++]=ut&255;ee[Ke++]=ut>>8}else if(R[c].action=="nextframe"){ee[Ke++]=1;ee[Ke++]=ut&255;ee[Ke++]=ut>>8}else if(R[c].action=="changecharset"){ee[Ke++]=2;var gt=R[c].charsetID;ee[Ke++]=this.editor.tileSets[gt].memoryLocation;ee[Ke++]=ut>>8}else{var mt=parseInt(R[c].action);if(!isNaN(mt)){mt+=4;ee[Ke++]=mt;ee[Ke++]=0;ee[Ke++]=0}else{alert("unknown effect "+R[c].action)}}}if(A.length>0){var yt=Ke+2049-2;ee[dt++]=yt&255;ee[dt]=yt>>8}for(var c=0;c<A.length;c++){var Y=A[c].gotoRow;var ut=lt[Y]+2049-2;var bt=parseInt(A[c].triggerInstr);ee[Ke++]=bt;if(A[c].action=="gotorow"){ee[Ke++]=0;ee[Ke++]=ut&255;ee[Ke++]=ut>>8}else if(A[c].action=="nextframe"){ee[Ke++]=1;ee[Ke++]=ut&255;ee[Ke++]=ut>>8}else if(A[c].action=="changecharset"){var gt=A[c].charsetID;ee[Ke++]=2;ee[Ke++]=this.editor.tileSets[gt].memoryLocation;ee[Ke++]=ut>>8}else{var mt=parseInt(A[c].action);if(!isNaN(mt)){mt+=4;ee[Ke++]=mt;ee[Ke++]=0;ee[Ke++]=0}else{alert("unknown effect "+A[c].action)}}}ee[Ke++]=0;var le=Ke;E.push({type:"Frame Table Data",from:ae,to:le});var Ct=te+2049-2;if(C){var xt=14336+2-2049+2048;if(Ct<xt){Ct=xt}}E.sort(function(e,t){return e.from-t.from});_.sort(function(e,t){return e.start-t.start});var St="<table>";St+="<tr><th>Start</th><th>End</th><th>Bytes</th><th>Contents</th></tr>";for(var c=0;c<_.length;c++){if(_[c].end>Ct){Ct=_[c].end}St+="<tr>";var Pt=("0000"+_[c].start.toString(16)).substr(-4);var wt=("0000"+_[c].end.toString(16)).substr(-4);var It=_[c].end-_[c].start;St+='<td style="text-align: right">';St+=Pt;St+="</td>";St+='<td style="text-align: right">';St+=wt;St+="</td>";St+='<td style="text-align: right">';St+=It;St+="</td>";St+="<td>";St+=_[c].type;if(_[c].type=="Code"&&typeof _[c].label!="undefined"){St+=" ("+_[c].label+")"}St+="</td>"}St+="</table>";$("#exportPRGAdvMemory").html(St);Ct=Ct-2049+2;var kt=new Uint8Array(Ct);for(var c=0;c<Ct;c++){kt[c]=ee[c]}if(o){var Mt="prg";if(typeof e.type!="undefined"){Mt=e.type}if(Mt=="prg"){if(s.indexOf(".prg")==-1){s+=".prg"}download(kt,s,"application/prg")}else{if(s.indexOf(".d64")==-1){s+=".d64"}var Tt=new D64;Tt.diskName=e.diskName;Tt.addFile(e.prgName,kt,"prg");Tt.createD64(s)}}return{blocks:_}}};var ExportC64Dialog=function(){this.editor=null;this.sidData=null;this.sidLoadAddr=0;this.sidInitAddr=0;this.sidPlayAddr=0;this.sidMultispeed=0;this.exportC64=null};ExportC64Dialog.prototype={init:function(e){this.editor=e},start:function(){console.log("start export c64!");var e=this;if(this.exportC64==null){this.exportC64=new ExportC64;this.exportC64.init(this.editor);this.exportC64.loadSource(function(){console.log("export c64 dialog source loaded!");$("#exportC64LoadingMessage").hide();$("#exportC64DownloadSource").show();$("#exportC64DownloadPRG").show()})}if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"toC64Dialog",title:"Export C64",width:640});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/textMode/exportC64.html",function(){e.initContent();e.initEvents()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("toC64Dialog")},initContent:function(){var e=this.editor.colorPaletteManager.getCurrentColorPalette();var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){alert("Please choose a grid layer");return}if(t&&t.getType()=="grid"&&(t.hasCellBackgroundColors()||t.getMode()==TextModeEditor.Mode.C64ECM)){$("#exportC64ColorModeExtended").prop("checked",true)}var i=this.editor.getScreenMode();if(i==TextModeEditor.Mode.C64MULTICOLOR){$("#exportC64ColorModeMulticolor").prop("checked",true)}$("#exportC64As").val(g_app.fileManager.filename);var r=this.editor.graphic.getFrameCount();$("#exportC64ToFrame").val(r);$("#exportC64FromFrame").val(1);$("#exportC64FromFrame").attr("max",r);$("#exportC64ToFrame").attr("max",r);var a=$("#playMode").val();if(a!="once"){$("#exportC64LoopType").val(a)}this.sidData=null;clearInputFile(document.getElementById("exportC64SIDFile"));$("#exportC64SIDFileInfo").html("");this.monochromeColor=this.editor.currentTile.color;$("#exportC64MonochromeColor").css("background-color","#"+e.getHexString(this.monochromeColor));var s="";var o=g_app.doc.dir("/music");var l=$("#exportC64Music").val();if(typeof l=="undefined"){l=false}s+='<option value="no">No Music</option>';for(var n=0;n<o.length;n++){var h="/music/"+d;var d=o[n].name;s+='<option value="/music/'+d+'"';if(!l&&n==0||h==l){s+=' selected="selected" '}s+=">"+o[n].name+"</option>"}s+='<option value="sid">Use A SID File</option>';$("#exportC64Music").html(s)},initEvents:function(){var a=this;document.getElementById("exportC64SIDFile").addEventListener("change",function(e){var t=document.getElementById("exportC64SIDFile").files[0];var i=window.URL||window.webkitURL;var r=i.createObjectURL(t);a.selectSIDFile(t)});$("input[name=exportC64ColorMode]").on("click",function(e){var t=$("input[name=exportC64ColorMode]:checked").val();if(t=="monochrome"){$("#exportC64MonochromeSection").show()}else{$("#exportC64MonochromeSection").hide()}});$("#exportC64MonochromeColor").on("click",function(e){var t={};t.colorPickedCallback=function(e){var t=a.editor.colorPaletteManager.getCurrentColorPalette();a.monochromeColor=e;$("#exportC64MonochromeColor").css("background-color","#"+t.getHexString(e))};var i=e.pageX;var r=e.pageY;t.currentColor=a.monochromeColor;a.editor.colorPaletteManager.showColorPicker(i,r,t)});$("#exportC64Type").on("change",function(e){var t=$(this).val();if(t=="d64"){$("#exportC64D64Options").show()}else{$("#exportC64D64Options").hide()}});$("#exportC64Music").on("change",function(e){var t=$(this).val();if(t=="sid"){$("#exportC64SidFileSection").show()}else{$("#exportC64SidFileSection").hide()}});$("#exportC64DownloadSource").on("click",function(e){e.preventDefault();console.log("do export c64 source");a.doExportC64({type:"source"})});$("#exportC64DownloadPRG").on("click",function(e){e.preventDefault();console.log("do export c64 prg");a.doExportC64({type:"prg"})})},doExportC64:function(e){var t=e.type;var i=$("#exportC64As").val();var r=$("#exportC64Monochrome").is(":checked");var a=$("#exportC64ExtendedColorMode").is(":checked");var s=parseInt($("#exportC64FromFrame").val());if(isNaN(s)||s<1||s>this.editor.graphic.getFrameCount()){alert("Invalid From Frame");return}var o=parseInt($("#exportC64ToFrame").val());if(isNaN(o)||o<1||o>this.editor.graphic.getFrameCount()){alert("Invalid To Frame");return}if(s>o){alert("From must be greater than to");return}this.saveAs(t,i,s,o,r,this.monochromeColor,a)},saveAs:function(e,t,i,r,a,s,o,l){if(typeof l=="undefined"){l=true}var n=$("#exportC64Music").val();var h=$("#exportC64LoopType").val();var d={};d.type=e;d.download=l;d.filename=t;d.mode=$("input[name=exportC64ColorMode]:checked").val();if(d.mode=="monochrome"){d.monochromeColor=this.monochromeColor}d.music=n;if(n=="sid"){d.sidData=this.sidData;d.sidLoadAddr=this.sidLoadAddr;d.sidInitAddr=this.sidInitAddr;d.sidPlayAddr=this.sidPlayAddr;d.sidSpeed=this.sidMultispeed}d.scrollV=false;if($("#exportC64ScrollV").is(":checked")){d.scrollV=true}d.entries=[];d.keyTriggers=[];d.instrTriggers=[];d.entries=[];if(i==r){d.entries[0]={};d.entries[0].type="frame";d.entries[0].frame=1;d.entries[0].duration=255;d.entries[1]={};d.entries[1].type="gotorow";d.entries[1].gotoRow=1}else{d.entries[0]={};d.entries[0].type="frameRange";d.entries[0].from=i;d.entries[0].to=r;if(h=="pingpong"){d.entries[1]={};d.entries[1].type="frameRange";d.entries[1].from=r-1;d.entries[1].to=i+1;d.entries[2]={};d.entries[2].type="frameJump";d.entries[2].jumpTo=1}else{d.entries[1]={};d.entries[1].type="frameJump";d.entries[1].jumpTo=1}}d.layers=$("input[name=exportC64Layer]:checked").val();d.type=$("#exportC64Type").val();if(d.type=="d64"){d.diskName=$("#exportC64DiskName").val();d.prgName=$("#exportC64Name").val()}if(e=="source"){d.type="source"}var c=this.editor.layers.getSelectedLayerObject();if(!c||c.getType()!="grid"){return}if(c.getBlockModeEnabled()){c.updateTilesFromBlocks()}if(c.getColorPerMode()=="character"){c.updateGridColorsFromTiles()}var f=c.getGridWidth();var u=c.getGridHeight();d.frames=[];var p=this.editor.graphic.getFrameCount();for(var v=0;v<p;v++){var g=c.getFrameData(v);var m=g;if(f<40||u<25){m={bgColor:g.bgColor,borderColor:g.borderColor,data:[]};var y=32;var b=this.editor.colorPaletteManager.noColor;for(var C=0;C<25;C++){m.data.push([]);for(var x=0;x<40;x++){m.data[C][x]={t:y,fc:0,bc:b,fh:0,fv:0,rz:0}}}var S=Math.floor((40-f)/2);var P=Math.floor((25-u)/2);for(var C=0;C<u;C++){for(var x=0;x<f;x++){var w=x+S;var I=C+P;if(w>=0&&w<40&&I>=0&&I<25){m.data[I][w]={t:g.data[C][x].t,fc:g.data[C][x].fc,bc:g.data[C][x].bc,fh:g.data[C][x].fh,fv:g.data[C][x].fv,rz:g.data[C][x].rz}}}}}var k={};k.frameData=m;k.duration=this.editor.graphic.getFrameDuration(v);d.frames.push(k)}if(f<40||u<25){d.gridWidth=40;d.gridHeight=25}else{d.gridWidth=c.getGridWidth();d.gridHeight=c.getGridHeight()}if(true){return this.exportC64.doExport(d)}else{return this.editor.toPrgAdv.createPRG(d)}},getSIDInfo:function(){var e=1;var t=this.sidData;var i=985248,r=50,a=3,s=65536*a*16;var o=[0,1,.6,.4];var l=new Uint8Array(32);var n=new Uint8Array(32);var h=new Uint8Array(32);var d=new Uint8Array(32);var c=4096,f=4096,u=4099,p=4099,v=0,g=1,m=0;var y=[8580,8580,8580];var b=8580;var C=[54272,0,0];var x=new Uint8Array(65536);var S=0,P=0,w=0,I=null,k=null;endcallback=null,playtime=0,ended=0;var M=i/e;var T=e/r;var D=1,E=1,_=0,B;var R=1,A=0;var F,L,U=t[7];c=t[8]+t[9]?t[8]*256+t[9]:t[U]+t[U+1]*256;for(F=0;F<32;F++){d[31-F]=t[18+(F>>3)]&Math.pow(2,7-F%8)}this.sidMultispeed=d[0];for(F=0;F<x.length;F++){x[F]=0}for(F=U+2;F<t.byteLength;F++){if(c+F-(U+2)<x.length){x[c+F-(U+2)]=t[F]}}L=1;for(F=0;F<32;F++){if(L!=0){L=l[F]=t[22+F]}else{L=l[F]=0}}L=1;for(F=0;F<32;F++){if(L!=0){L=n[F]=t[54+F]}else{L=n[F]=0}}L=1;for(F=0;F<32;F++){if(L!=0){L=h[F]=t[86+F]}else{L=h[F]=0}}f=t[10]+t[11]?t[10]*256+t[11]:c;p=u=t[12]*256+t[13];g=t[15];y[0]=(t[119]&48)>=32?8580:6581;y[1]=(t[119]&192)>=128?8580:6581;y[2]=(t[118]&3)>=3?8580:6581;C[1]=t[122]>=66&&(t[122]<128||t[122]>=224)?53248+t[122]*16:0;C[2]=t[123]>=66&&(t[123]<128||t[123]>=224)?53248+t[123]*16:0;R=1+(C[1]>0)+(C[2]>0);S=1;this.sidLoadAddr=c;this.sidInitAddr=f;this.sidPlayAddr=p;this.sidData=data;var H="";H+='<div style="margin: 2px 0 0 4px"><strong>Size:</strong> '+this.sidData.length+" bytes</div>";H+='<div style="margin: 2px 0 0 4px"><strong>Load Address:</strong> $'+c.toString(16)+"</div>";H+='<div style="margin: 2px 0 0 4px"><strong>Init Address:</strong> $'+f.toString(16)+"</div>";H+='<div style="margin: 2px 0 0 4px"><strong>Play Address:</strong> $'+p.toString(16)+"</div>";$("#exportC64SIDFileInfo").html(H)},selectSIDFile:function(e){var t=this;var i=new FileReader;i.onload=function(e){t.sidData=new Uint8Array(e.target.result);t.getSIDInfo()};i.readAsArrayBuffer(e)}};var ExportC64=function(){this.editor=null;this.effects=[{name:"Background Flash",data:";data \nbgEffectCounter\n!byte 00\nbgEffectColor \n!byte $0,$0,$b,$b,$c,$c,$f,$f,$1,$1,$f,$c,$b",init:";init\n;this code is executed once on startup\n",trigger:";on trigger\n;this code is executed when the effect is triggered\n  lda #$0d\n  sta bgEffectCounter\n",tick:"\n;on tick\n;this code is executed on every tick\n\n  lda bgEffectCounter\n  cmp #00\n  beq bgEffectDone\n    \n  ldy bgEffectCounter\n  lda bgEffectColor,y\n\n  sta $d021\n\n  dey\n  sty bgEffectCounter\n\nbgEffectDone"},{name:"Jitter",data:";data \neffectJitterCounter\n!byte 00\neffectJitterAmount\n!byte $7,$0,$3,$6,$2,$7,$4",init:";init\n;this code is executed once on startup\n",trigger:";on trigger\n;this code is executed when the effect is triggered\n  lda #$06\n  sta effectJitterCounter\n    \n  lda #$07\n  ora $d016\n",tick:";on tick\n;this code is executed on every tick\n\n  lda effectJitterCounter\n  cmp #00\n  beq effectJitterDone\n  \n  lda $d016                                    ; $d016 is a VIC-II control register which contains the horizontal scroll value\n  and #$F8           \n  sta temp      \n      \n  ldy effectJitterCounter\n  lda effectJitterAmount,y\n  \n  ora temp\n  sta $d016\n\n  dey\n  sty effectJitterCounter\n\neffectJitterDone"}];this.c64Asm=null;this.colorSchemes={vice:[0,16777215,6829867,7382194,7290246,5803331,3483769,12109679,7294757,4405504,10119001,4473924,7105644,10146436,7102133,9803157],ccs64:[1645849,16579068,9648716,11991802,13794797,6999919,5194968,16513931,14195803,8344327,15696799,5723987,10725287,12057535,10721279,15722983]};this.files=[]};ExportC64.prototype={init:function(e){this.editor=e;this.c64Asm=new C64ASM;this.c64Asm.init(this.editor);this.sourceList=["c64export/animatedbgcolors.asm","c64export/animatedchars.asm","c64export/checkinstrument.asm","c64export/constants.asm","c64export/copycharset.asm","c64export/copydata.asm","c64export/displaynextframe.asm","c64export/getframeinfo.asm","c64export/init.asm","c64export/keyboard.asm","c64export/main.asm","c64export/player.asm","c64export/playframes.asm","c64export/setupinterrupts.asm","c64export/triggers.asm","c64export/zeropage.asm"];this.loadedAssetCount=0;this.sourceFiles={}},assetsReady:function(){console.log("assets ready!");console.log(this.sourceFiles);this.sourceLoadedCallback()},loadNextAsset:function(){var i=this.loadedAssetCount;if(i>=this.sourceList.length){this.assetsReady();return}var e=this.sourceList[i];var t="text";var r=this;var a=new XMLHttpRequest;a.open("GET",e+"?v=0.491",true);a.responseType=t;a.onload=function(e){var t=r.sourceList[i];t=t.substr("c64export/".length);r.sourceFiles[t]=a.responseText;r.loadedAssetCount++;r.loadNextAsset()};a.send(null)},loadSource:function(e){this.loadNextAsset();this.sourceLoadedCallback=e},addSourceFile:function(e){var t=this.files.length;var i=e;var r=this.sourceFiles[e];var a="asm";this.files.push({id:t,name:i,content:r,filePath:"asm/"+i,type:a})},doExport:function(e){console.log("DO EXPORT!!!!!!!");console.log(e);this.files=[];this.files.push({id:1,name:"asm",content:"",filePath:"asm",type:"folder"});this.files.push({id:2,name:"bin",content:"",filePath:"data",type:"folder"});var i="";var t="";var r="";var a="";var s="";var o="";var l="";var n=false;var h=false;var d=e.type;var c=this.editor.layers.getSelectedLayerObject();if(!c||c.getType()!="grid"){alert("Please choose a grid layer");return}var f="c64.prg";if(typeof e.filename!="undefined"){f=e.filename}var u=true;if(typeof e.download!="undefined"){u=e.download}var p=e.mode=="extended";var v=e.mode=="multicolor";var g=e.mode=="monochrome";this.monochromeColor=6;if(g&&typeof e.monochromeColor!="undefined"){this.monochromeColor=e.monochromeColor}var m=c.getColorPalette();var y=c.getTileSet();var b=!y.isPetscii();b=true;var C=c.getColorPerMode();var x=0;var S=0;if(c.getBlockModeEnabled()){c.updateTilesFromBlocks()}if(C=="character"){c.updateGridColorsFromTiles()}var P=false;var w=e.gridWidth;var I=e.gridHeight;if(!P){if(w>40){w=40}if(I>25){I=25}}this.createColorMap(m);var k=y.getTileCount();this.charsetMap=[];for(var M=0;M<k;M++){this.charsetMap[M]=M}var T=e.frames;var D=this.c64Asm.files.load("/main.asm");effectsCode="\ninit_effects\n"+this.effectsCode();D=D.replace("\ninit_effects",effectsCode);this.assembleCode(D);var E=[];var _=[];for(var M=0;M<this.blocks.length;M++){_.push({type:"Code",start:this.blocks[M].start,end:this.blocks[M].end,label:this.blocks[M].label})}this.entries=[];if(typeof e.entries!="undefined"){this.entries=e.entries}this.keyTriggers=[];if(typeof e.keyTriggers!="undefined"){this.keyTriggers=e.keyTriggers}this.instrTriggers=[];if(typeof e.instrTriggers!="undefined"){this.instrTriggers=e.instrTriggers}if(this.entries.length==1&&this.entries[0].type=="frame"){n=true}if(this.entries.length==2&&this.entries[0].type=="frame"&&this.entries[1].type=="gotorow"){n=true}n=false;this.getNeededFrames();this.setSIDData(e);h=this.sidData!=null;var B=this.prg;var R=new Uint8Array(64e3);var A=0;var F=this.getBorderColor();var L=this.getBackgroundColor();A=0;var U=A;for(var M=0;M<B.length;M++){R[A++]=B[M]}N=A;E.push({type:"Code",from:U,to:N});var H=1;var O=[];if(p){if(this.getExtendedColorBGColors(e,this.framesToExport)){this.getMostUsedCharacters(e,this.framesToExport);var G=0;for(var M=0;M<H;M++){y=c.getTileSet();this.getExtendedColorCharsetData(y,M);b=true;A=14336-2049+2-2048*G;y.memoryLocation=7-G<<1;var U=A;for(var z=0;z<this.extendedColorCharsetData.length;z++){R[A++]=this.extendedColorCharsetData[z];O.push(this.extendedColorCharsetData[z])}var N=A;E.push({type:"Character Data",from:U,to:N});_.push({type:"Character Set Data",start:U+2049-2,end:N+2049-2});G++}}else{p=false}}else{var G=0;this.getMostUsedCharacters(e,this.framesToExport);for(var M=0;M<H;M++){y=c.getTileSet();if(y.isDefaultTileSet("c64")){y.memoryLocation=4}else{A=14336-2049+2-2048*G;y.memoryLocation=7-G<<1;var U=A;this.getCharsetData(y);for(var z=0;z<this.charsetData.length;z++){R[A++]=this.charsetData[z];O.push(this.charsetData[z])}var N=A;_.push({type:"Character Set Data ("+y.name+")",start:U+2049-2,end:N+2049-2});G++}}}a="CHARSET_DATA\n";a+=this.formatBytes(O);A=4095-2049+2;if(this.sidData){console.log("strip sid header");var W=[];for(var M=this.sidHeaderLength;M<this.sidData.length;M++){W.push(this.sidData[M])}console.log("sid bytes ===== ");console.log(W);var X="sid.bin";var Y="bin";if(d!="source"){W=bufferToBase64(W)}this.files.push({id:"sidfile",name:X,content:W,filePath:"data/"+X,type:Y});this.sidLength=W.length;this.sidEndAddress=this.sidLoadAddr+W.length}else{}var V=A;console.log("frame ptr table addr:"+V);U=A;A+=600;var N=A;if(N!=U){E.push({type:"Frames Table",from:U,to:N});_.push({type:"Frames Table",start:U+2049-2,end:N+2049-2})}var q=0;var j=A;var U=A;var k=y.getTileCount();var K=[];s="ANIMATED_CHARS_TABLE\n";for(var M=0;M<k;M++){var Z=y.getAnimatedType(M);var J=y.getTileProperties(M);if(Z!==false){console.log("tile animated type:");console.log(Z);console.log(J);console.log("--------------");var Q=0;if(M<this.charsetMap.length){Q=this.charsetMap[M]}b=true;R[A++]=J.ticksPerFrame;R[A++]=J.ticksPerFrame;R[A++]=Q*8&255;R[A++]=Q*8>>8;s+="!byte ";s+="$"+this.toHex(J.ticksPerFrame)+",";s+="$"+this.toHex(J.ticksPerFrame)+",";s+="$"+this.toHex(Q*8&255)+",";s+="$"+this.toHex(Q*8>>8)+",";switch(Z){case"right":R[A++]=1;R[A++]=0;R[A++]=0;R[A++]=0;R[A++]=0;s+="$"+this.toHex(1)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0);break;case"up":R[A++]=2;R[A++]=0;R[A++]=0;R[A++]=0;R[A++]=0;s+="$"+this.toHex(2)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0);break;case"down":R[A++]=3;R[A++]=0;R[A++]=0;R[A++]=0;R[A++]=0;s+="$"+this.toHex(3)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0);break;case"blink":R[A++]=4;R[A++]=0;R[A++]=0;R[A++]=0;R[A++]=0;s+="$"+this.toHex(4)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0);break;default:case"left":R[A++]=0;R[A++]=0;R[A++]=0;R[A++]=0;R[A++]=0;s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0)+",";s+="$"+this.toHex(0);break;case"frames":R[A++]=5;R[A++]=J.frameCount;R[A++]=0;var ee=[];for(var te=0;te<J.frameCount;te++){ee.push({frame:te,charData:this.getCharData(y,Q,te)})}s+="$"+this.toHex(5)+",";s+="$"+this.toHex(J.frameCount)+",";s+="$"+this.toHex(0)+",";s+="<ANIM_CHAR_"+K.length+",";s+=">ANIM_CHAR_"+K.length;K.push({addressPosition:A,frames:ee});R[A++]=0;R[A++]=0;break}q++;s+="\n"}}s+="!byte $00\n";R[A++]=0;console.log("TILE FRAMES!");console.log(ee);var N=A;if(N!=U){E.push({type:"Animated Characters Table",from:U,to:N});_.push({type:"Animated Characters Table",start:U+2049-2,end:N+2049-2})}U=A;for(var M=0;M<4;M++){R[A++]=6;R[A++]=6;R[A++]=M}R[A++]=0;var ie=U;var N=A;if(N!=U){E.push({type:"Animated BG Colours Table",from:U,to:N});_.push({type:"Animated BG Colours Table",start:U+2049-2,end:N+2049-2})}console.log("animated data position = "+A);var U=A;o="";for(var re=0;re<K.length;re++){var ee=K[re].frames;var ae=A+2049-2;console.log("Animated char address = "+ae);console.log("Animated char address = "+ae.toString(16));var se=K[re].addressPosition;R[se]=ae&255;R[se+1]=ae>>8&255;var oe=[];for(var M=0;M<ee.length;M++){for(var le=0;le<ee[M].charData.length;le++){R[A++]=ee[M].charData[le];oe.push(ee[M].charData[le])}}o+="ANIM_CHAR_"+re+"\n";o+=this.formatBytes(oe);o+="\n\n"}var N=A;if(N!=U){E.push({type:"Animated Chars Data",from:U,to:N});_.push({type:"Animated Chars Data",start:U+2049-2,end:N+2049-2})}var ne=A;var he=2064-2049+2;var de=he;R[de++]=this.getC64Color(F);if(b){R[de++]=1}else{R[de++]=0}if(this.sidData){R[de++]=1;R[de++]=this.sidSpeed;R[de++]=this.sidInitAddr&255;R[de++]=this.sidInitAddr>>8;R[de++]=this.sidPlayAddr&255;R[de++]=this.sidPlayAddr>>8}else{R[de++]=0;R[de++]=0;R[de++]=0;R[de++]=0;R[de++]=0;R[de++]=0}R[de++]=V+2049-2&255;R[de++]=V+2049-2>>8;R[de++]=j+2049-2&255;R[de++]=j+2049-2>>8;R[de++]=ie+2049-2&255;R[de++]=ie+2049-2>>8;for(var ce=0;ce<this.frames.length;ce++){var fe=this.frames[ce].frame-1;if(p){this.getExtendedColorBGColors(e,[fe])}else{this.extendedColorBGColors=[];L=this.getBackgroundColor(fe);if(v){var ue=c.getC64Multi1Color();var pe=c.getC64Multi2Color();this.extendedColorBGColors.push({color:this.getC64Color(L)});this.extendedColorBGColors.push({color:this.getC64Color(ue)});this.extendedColorBGColors.push({color:this.getC64Color(pe)});this.extendedColorBGColors.push({color:0})}else{this.extendedColorBGColors.push({color:this.getC64Color(L)});this.extendedColorBGColors.push({color:0});this.extendedColorBGColors.push({color:0});this.extendedColorBGColors.push({color:0})}}var ve=1;var ge=[];var me=[];var ye=[];var be=1;var Ce=[];var xe=[];for(var Se=0;Se<I;Se++){for(var Pe=0;Pe<w;Pe++){var we=this.editor.tileSetManager.blankCharacter;var Ie=Se;var ke=T[fe].frameData.data[Ie][Pe].fc;var Me=false;we=T[fe].frameData.data[Ie][Pe].t;if(g){ke=this.monochromeColor}if(we<this.charsetMap.length){we=this.charsetMap[we]}else{we=0}if(p){if(this.editor.bgInPrevLayer){Me=T[fe].frameData.data[Ie][Pe].fc}else{Me=T[fe].frameData.data[Ie][Pe].bc}if(typeof Me=="undefined"||Me===false){Me=this.getBackgroundColor(fe)}if(c.getScreenMode()!==TextModeEditor.Mode.C64ECM){Me=this.getC64Color(Me);for(var M=0;M<this.extendedColorBGColors.length;M++){if(Me==this.extendedColorBGColors[M].color){Me=M;break}}Me=Me&3;we=we|Me<<6}else{Me=T[fe].frameData.data[Ie][Pe].bc;if(Me==this.editor.colorPaletteManager.noColor){}else{Me=Me&3;we=we|Me<<6}}}ge.push(we);Ce.push(this.getC64Color(ke))}}var Te=-1;var De=0;var Ee=250;for(var M=0;M<ge.length;M++){De=0;Te=ge[M];while(M<ge.length&&Te==ge[M]&&De<Ee){M++;De++}ye.push(De);ye.push(Te);if(De>0){M--}}ye.push(0);if(this.frames[ce].canWriteAsChanges){var $e=this.frames[ce].previousFrame;var _e=-1;for(var M=0;M<this.frames.length;M++){if(this.frames[M].frame==$e){_e=M;break}}if(_e!=-1){var Be=0;for(var M=0;M<ge.length;M++){var Re=ge[M];var Ae=this.frames[_e].frameData.charData[M];if(Re!=Ae||Be>200){me.push(Be);me.push(Re);Be=0}Be++}if(me.length==1){me.push(this.frames[_e].frameData.charData[0])}me.push(0);if(me.length<900){ve=2}var Be=0;for(var M=0;M<Ce.length;M++){var Fe=Ce[M];var Le=this.frames[_e].frameData.colorData[M];if(Fe!=Le||Be>200){xe.push(Be);xe.push(Fe);Be=0}Be++}xe.push(0);if(xe.length==1){xe.push(this.frames[_e].frameData.colorData[0]);xe.push(0)}if(xe.length<240){be=2}}}if(this.frames[ce].canWriteAsRLE){if(ve==1&&ye.length<600&&ye.length!=0){ve=3}}if(P){ve=1;be=1}var Ue=T[fe].duration;if(Ue>255){Ue=255}if(Ue<7){Ue=7}var He={charFrameType:ve,colorFrameType:be,duration:Ue,charData:ge,charChangesData:me,charRLEData:ye,colorData:Ce,colorChangesData:xe,bgColor1:this.extendedColorBGColors[0].color,bgColor2:this.extendedColorBGColors[1].color,bgColor3:this.extendedColorBGColors[2].color,bgColor4:this.extendedColorBGColors[3].color};this.frames[ce].frameData=He}var Oe=14336-2049+2;var Ge=2048;if(p){Ge=this.extendedColorCharsetData.length}var A=ne;var ze=V;var Ne=0;var We=false;for(var M=0;M<this.frames.length;M++){var He=this.frames[M].frameData;var Xe=[];var Ye=[];var Ve=He.charData.length;var qe=He.colorData.length;if(He.colorFrameType==2){qe=He.colorChangesData.length}var je=false;while(!je){je=true;for(var z=0;z<_.length;z++){if(A+2049-2<_[z].end&&A+Ve+2049-2>=_[z].start){je=false;A=_[z].end-2049+2}}}if(A+Ve+qe>53248-2049){break}var Ke=A;var U=A;if(He.charFrameType==1){for(var z=0;z<He.charData.length;z++){R[A++]=He.charData[z];Xe.push(He.charData[z])}}else if(He.charFrameType==2){for(var z=0;z<He.charChangesData.length;z++){R[A++]=He.charChangesData[z];Xe.push(He.charChangesData[z])}}else if(He.charFrameType==3){for(var z=0;z<He.charRLEData.length;z++){R[A++]=He.charRLEData[z];Xe.push(He.charRLEData[z])}}else{alert("???")}var N=A;E.push({type:"Frame Data",from:U,to:N});_.push({type:"Frame "+M+" Char Data",start:U+2049-2,end:N+2049-2});var Ze="FRAME_"+M+"_MAP\n";Ze+=this.formatBytes(Xe);this.files.push({id:this.files.length+1,name:"frame_"+M+"_map.asm",content:Ze,filePath:"data/frame_"+M+"_map.asm",type:"asm"});t+='!source "data/frame_'+M+'_map.asm"\n';var Je=A;var Qe=false;if(!P){Qe=true}if(n&&!h){Qe=false}Ye=[];if(He.colorFrameType==1){if(We!==false&&Qe){var U=We;Je=We;for(var z=0;z<He.colorData.length;z++){R[We]=He.colorData[z];z++;R[We]=R[We]|He.colorData[z]<<4;Ye.push(R[We]);Ye.push(0);We+=2}var N=We;_.push({type:"Frame "+M+" Color Data (4 bit)",start:U+2049-2,end:N+2049-2});We=false}else{var je=false;while(!je){je=true;for(var z=0;z<_.length;z++){if(A+2049-2<_[z].end&&A+qe+1+2049-2>=_[z].start){je=false;A=_[z].end-2049+2}}}Je=A;var U=A;if(Qe){for(var z=0;z<He.colorData.length;z++){R[A]=He.colorData[z];z++;R[A]=R[A]|He.colorData[z]<<4;Ye.push(R[A]);Ye.push(0);A+=2}A++}else{for(var z=0;z<He.colorData.length;z++){R[A++]=He.colorData[z];Ye.push(He.colorData[z])}A++}var N=A;E.push({type:"Frame Color Data",from:U,to:N});We=Je+1;_.push({type:"Frame "+M+" Color Data (4 bit)",start:U+2049-2,end:N+2049-2})}}else if(He.colorFrameType==2){var je=false;while(!je){je=true;for(var z=0;z<_.length;z++){if(A+2049-2<_[z].end&&A+qe+1+2049-2>=_[z].start){je=false;A=_[z].end-2049+2}}}Je=A;var U=A;for(var z=0;z<He.colorChangesData.length;z++){R[A++]=He.colorChangesData[z];Ye.push(He.colorChangesData[z])}var N=A;E.push({type:"Frame Color Data",from:U,to:N});_.push({type:"Frame "+M+" Color Data (changes)",start:U+2049-2,end:N+2049-2})}else{alert("???")}var et="FRAME_"+M+"_COLORS\n";et+=this.formatBytes(Ye);this.files.push({id:this.files.length+1,name:"frame_"+M+"_colors.asm",content:et,filePath:"data/frame_"+M+"_colors.asm",type:"asm"});t+='!source "data/frame_'+M+'_colors.asm"\n';Ne++;this.frames[M].charAddress=Ke+2049-2;this.frames[M].colorAddress=Je+2049-2;var tt=ze+2049-2}var U=ze;var it=[];it[0]=0;var rt=true;var at=false;var st=false;console.log("frame table index = "+ze);l="";l+="FRAMETABLE\n";for(var M=0;M<this.entries.length;M++){var Ie=M+1;it[Ie]=ze;l+="FRAMETABLE_ROW_"+Ie+"\n";if(this.entries[M].type=="frame"){var fe=parseInt(this.entries[M].frame);for(var z=0;z<this.frames.length;z++){if(this.frames[z].frame==fe){x++;var He=this.frames[z].frameData;var Ue=parseInt(this.entries[M].duration);if(Ue<6){Ue=6}if(Ue>255){Ue=255}console.log("char frame type = "+He.charFrameType);R[ze++]=He.charFrameType;R[ze++]=this.frames[z].charAddress&255;R[ze++]=this.frames[z].charAddress>>8;R[ze++]=Ue;R[ze++]=He.colorFrameType;R[ze++]=this.frames[z].colorAddress&255;R[ze++]=this.frames[z].colorAddress>>8;R[ze++]=He.bgColor1;R[ze++]=He.bgColor2;R[ze++]=He.bgColor3;R[ze++]=He.bgColor4;l+="!byte ";l+="$"+this.toHex(He.charFrameType)+",";l+="<FRAME_"+z+"_MAP,";l+=">FRAME_"+z+"_MAP,";l+="$"+this.toHex(Ue)+",";l+="$"+this.toHex(He.colorFrameType)+",";l+="<FRAME_"+z+"_COLORS,";l+=">FRAME_"+z+"_COLORS,";S=He.bgColor1;l+="$"+this.toHex(He.bgColor1)+",";l+="$"+this.toHex(He.bgColor2)+",";l+="$"+this.toHex(He.bgColor3)+",";l+="$"+this.toHex(He.bgColor4)+",";if(rt&&this.keyTriggers.length>0){R[ze++]=1;at=ze;R[ze++]=0;R[ze++]=0}if(rt&&this.instrTriggers.length>0){R[ze++]=3;st=ze;R[ze++]=0;R[ze++]=0}rt=false;R[ze++]=0;l+="$"+this.toHex(0)+"\n"}}}else if(this.entries[M].type=="frameRange"){var ot=this.entries[M].from;var lt=this.entries[M].to;var nt=false;var ht=1;if(lt<ot){ht=-1}for(var fe=ot;fe!=lt+ht;fe+=ht){for(var z=0;z<this.frames.length;z++){if(this.frames[z].frame==fe){x++;var dt=ze;var He=this.frames[z].frameData;R[ze++]=He.charFrameType;R[ze++]=this.frames[z].charAddress&255;R[ze++]=this.frames[z].charAddress>>8;R[ze++]=He.duration;R[ze++]=He.colorFrameType;R[ze++]=this.frames[z].colorAddress&255;R[ze++]=this.frames[z].colorAddress>>8;R[ze++]=He.bgColor1;R[ze++]=He.bgColor2;R[ze++]=He.bgColor3;R[ze++]=He.bgColor4;l+="!byte ";l+="$"+this.toHex(He.charFrameType)+",";l+="<FRAME_"+z+"_MAP,";l+=">FRAME_"+z+"_MAP,";l+="$"+this.toHex(Ue)+",";l+="$"+this.toHex(He.colorFrameType)+",";l+="<FRAME_"+z+"_COLORS,";l+=">FRAME_"+z+"_COLORS,";S=He.bgColor1;l+="$"+this.toHex(He.bgColor1)+",";l+="$"+this.toHex(He.bgColor2)+",";l+="$"+this.toHex(He.bgColor3)+",";l+="$"+this.toHex(He.bgColor4)+",";if(rt&&this.keyTriggers.length>0){R[ze++]=1;at=ze;R[ze++]=0;R[ze++]=0}if(rt&&this.instrTriggers.length>0){R[ze++]=3;st=ze;R[ze++]=0;R[ze++]=0}rt=false;R[ze++]=0;l+="$"+this.toHex(0)+"\n";var ct=ze;break}}}}else if(this.entries[M].type=="frameJump"){var ft=this.entries[M].jumpTo;var ut=it[ft]+2049-2;R[ze++]=0;R[ze++]=ut&255;R[ze++]=ut>>8;l+="!byte ";l+="$"+this.toHex(0)+",";l+="<FRAMETABLE_ROW_"+ft+",";l+=">FRAMETABLE_ROW_"+ft+"\n"}}R[ze++]=0;R[ze++]=V+2049-2&255;R[ze++]=V+2049-2>>8;l+="!byte ";l+="$"+this.toHex(0)+",";l+="<FRAMETABLE_ROW_1,";l+=">FRAMETABLE_ROW_1\n";if(this.keyTriggers.length>0){var pt=ze+2049-2;R[at++]=pt&255;R[at]=pt>>8}for(var M=0;M<this.keyTriggers.length;M++){var vt=this.keyTriggers[M].gotoRow;var ut=it[vt]+2049-2;var gt=this.keyTriggers[M].triggerKey.toLowerCase();R[ze++]=this.keymap[gt];if(this.keyTriggers[M].action=="gotorow"){R[ze++]=0;R[ze++]=ut&255;R[ze++]=ut>>8}else if(this.keyTriggers[M].action=="nextframe"){R[ze++]=1;R[ze++]=ut&255;R[ze++]=ut>>8}else if(this.keyTriggers[M].action=="changecharset"){R[ze++]=2;var mt=this.keyTriggers[M].charsetID;R[ze++]=this.editor.tileSets[mt].memoryLocation;R[ze++]=ut>>8}else{var yt=parseInt(this.keyTriggers[M].action);if(!isNaN(yt)){yt+=4;R[ze++]=yt;R[ze++]=0;R[ze++]=0}else{alert("unknown effect "+this.keyTriggers[M].action)}}}if(this.instrTriggers.length>0){var bt=ze+2049-2;R[st++]=bt&255;R[st]=bt>>8}for(var M=0;M<this.instrTriggers.length;M++){var vt=this.instrTriggers[M].gotoRow;var ut=it[vt]+2049-2;var Ct=parseInt(this.instrTriggers[M].triggerInstr);R[ze++]=Ct;if(this.instrTriggers[M].action=="gotorow"){R[ze++]=0;R[ze++]=ut&255;R[ze++]=ut>>8}else if(this.instrTriggers[M].action=="nextframe"){R[ze++]=1;R[ze++]=ut&255;R[ze++]=ut>>8}else if(this.instrTriggers[M].action=="changecharset"){var mt=this.instrTriggers[M].charsetID;R[ze++]=2;R[ze++]=this.editor.tileSets[mt].memoryLocation;R[ze++]=ut>>8}else{var yt=parseInt(this.instrTriggers[M].action);if(!isNaN(yt)){yt+=4;R[ze++]=yt;R[ze++]=0;R[ze++]=0}else{alert("unknown effect "+this.instrTriggers[M].action)}}}R[ze++]=0;l+="!byte ";l+="$"+this.toHex(0)+"\n";var N=ze;E.push({type:"Frame Table Data",from:U,to:N});var xt=A+2049-2;if(b){var St=14336+2-2049+2048;if(xt<St){xt=St}}E.sort(function(e,t){return e.from-t.from});_.sort(function(e,t){return e.start-t.start});var Pt="<table>";Pt+="<tr><th>Start</th><th>End</th><th>Bytes</th><th>Contents</th></tr>";for(var M=0;M<_.length;M++){if(_[M].end>xt){xt=_[M].end}Pt+="<tr>";var wt=("0000"+_[M].start.toString(16)).substr(-4);var It=("0000"+_[M].end.toString(16)).substr(-4);var kt=_[M].end-_[M].start;Pt+='<td style="text-align: right">';Pt+=wt;Pt+="</td>";Pt+='<td style="text-align: right">';Pt+=It;Pt+="</td>";Pt+='<td style="text-align: right">';Pt+=kt;Pt+="</td>";Pt+="<td>";Pt+=_[M].type;if(_[M].type=="Code"&&typeof _[M].label!="undefined"){Pt+=" ("+_[M].label+")"}Pt+="</td>"}Pt+="</table>";$("#exportPRGAdvMemory").html(Pt);console.log("FRAME COUNT = "+x);r+="\n";r+="; border colour\n";r+="  lda #"+this.getC64Color(F)+"\n";r+="  sta $d020"+"\n";if(n&&!h){r+="; background colour\n";r+="  lda #"+this.getC64Color(S)+"\n";r+="  sta $d021"+"\n"}if(!v){r+="; turn multicolour mode off\n";r+="  lda #%00001000\n";r+="  sta $d016\n"}if(p){R[de++]=1;r+="; turn ecm on\n";r+="  lda #%01011011\n";r+="  sta $d011\n"}else if(v){R[de++]=2;r+="; turn multicolour mode on\n";r+="  lda #%00011000\n";r+="  sta $d016\n"}else{R[de++]=0}r+="\n";if(!n){r+="select_vic_bank\n";r+="  lda $dd00\n";r+="  and #%11111100\n";r+="  ora #VIC_BANK\n";r+="  sta $dd00\n\n";r+="setup_character_memory\n";r+="  lda $d018\n";r+="  and #%11110001\n";r+="  ora #CHARSET_POINTER\n";r+="  sta $d018\n";r+="\nsetup_screen\n";r+="  lda $d018\n";r+="  and #$0f\n";r+="  ora #SCREEN_MEMORY_1\n";r+="  sta $d018\n"}if(!n){r+="  lda #SCREEN_BUFFER_1\n";r+="  sta front_buffer_high\n";r+="  lda #SCREEN_BUFFER_2\n";r+="  sta back_buffer_high\n"}r+="\n";if(!n){r+="; setup the interrupt routine\n";r+="; irq in asm/player.asm is called once per frame\n";r+="  sei\n";r+='!source "asm/setupinterrupts.asm"\n';r+="; copy charset into the correct place\n";r+="  jsr copy_charset\n";r+="; load first frame into back buffer\n";r+="  lda #<FRAMETABLE\n";r+="  sta frame_ptr_low\n";r+="  lda #>FRAMETABLE\n";r+="  sta frame_ptr_high\n";r+="  jsr get_next_frame_info\n";r+="  jsr tick4\n";r+="  lda #$01\n";r+="  sta delay_counter\n";if(h){r+="\n; init sid\n";r+="  jsr SID_INIT_ADDRESS\n"}r+="; reenable interrupts\n";r+="  cli\n"}else{if(h){r+="  sei\n";r+='!source "asm/setupinterrupts.asm"\n';r+="; reenable interrupts\n";r+="  cli\n"}r+="  ldx #0\n";r+="copy_data\n";r+="  lda FRAME_0_MAP,x\n";r+="  sta $400,x\n";r+="  lda FRAME_0_MAP + $100,x\n";r+="  sta $400 + $100,x\n";r+="  lda FRAME_0_MAP + $200,x\n";r+="  sta $400 + $200,x\n";r+="  lda FRAME_0_MAP + $2e8,x\n";r+="  sta $400 + $2e8,x\n";r+="  lda FRAME_0_COLORS,x\n";r+="  sta $d800,x\n";r+="  lda FRAME_0_COLORS + $100,x\n";r+="  sta $d800 + $100,x\n";r+="  lda FRAME_0_COLORS + $200,x\n";r+="  sta $d800 + $200,x\n";r+="  lda FRAME_0_COLORS + $2e8,x\n";r+="  sta $d800 + $2e8,x\n";r+="  dex\n";r+="  bne copy_data\n"}r+="; loop forever\t\n";r+="loop\n";r+="  jmp loop\n";if(!n){r+="nmi\n";r+="  rti\n"}if(!n){i+='!source "asm/zeropage.asm"\n\n'}if(!n){i+="; constants\n";i+="VIC_BANK = $0\n";i+="; high byte of screen buffers\n";i+="SCREEN_BUFFER_1 = $c0\n";i+="SCREEN_BUFFER_2 = $c4\n";i+="; pointers to screen buffers\n";i+="SCREEN_MEMORY_1 = $00\n";i+="SCREEN_MEMORY_2 = $10\n";i+="CHARSET_ADDRESS = $c800\n";i+="CHARSET_POINTER = %00000010\n";if(h){i+="SID_INIT_ADDRESS = $"+("0000"+this.sidInitAddr.toString(16)).substr(-4)+"\n";i+="SID_PLAY_ADDRESS = $"+("0000"+this.sidPlayAddr.toString(16)).substr(-4)+"\n"}}i+="\n";i+="*=$801\n";i+="basic_start_code\n";i+="!byte    $0B, $08, $0A, $00, $9E, $32, $30, $38, $30, $00, $00, $00\n";i+="\n*=$0820\n";i+="  jmp start\n";i+="\n*=$0823 ; set this to whereever code should start..\n";i+="start";i+=r;i+="\n";if(!n){i+='!source "asm/copycharset.asm"\n';i+='!source "asm/player.asm"\n';i+='!source "asm/copydata.asm";\n';i+='!source "asm/displaynextframe.asm"\n';i+='!source "asm/getframeinfo.asm"\n';i+='!source "asm/playframes.asm"\n';i+='!source "asm/animatedchars.asm"\n'}if(n&&h){i+="irq\n";i+="  rti\n"}if(this.sidData){let e=("0000"+this.sidLoadAddr.toString(16)).substr(-4);let t=("0000"+this.sidEndAddress.toString(16)).substr(-4);i+="\n; sid file "+this.sidLength+" bytes ($"+e+" - $"+t+")\n";i+="*=$"+e+"\n";i+='!binary "data/sid.bin"\n'}if(!n){i+="\n";i+='!source "data/frameTable.asm"\n';i+='!source "data/animatedCharsTable.asm"\n';i+='!source "data/animatedCharsData.asm"\n';i+='!source "data/charset.asm"\n'}i+=t;this.files.push({id:this.files.length+1,name:"main.asm",content:i,filePath:"main.asm",type:"asm"});this.files.push({id:this.files.length+1,name:"charset.asm",content:a,filePath:"data/charset.asm",type:"asm"});if(!n){this.files.push({id:this.files.length+1,name:"animatedCharsTable.asm",content:s,filePath:"data/animatedCharsTable.asm",type:"asm"});this.files.push({id:this.files.length+1,name:"animatedCharsData.asm",content:o,filePath:"data/animatedCharsData.asm",type:"asm"});this.files.push({id:this.files.length+1,name:"frameTable.asm",content:l,filePath:"data/frameTable.asm",type:"asm"})}this.addSourceFile("copycharset.asm");if(!n){this.addSourceFile("copydata.asm");this.addSourceFile("animatedchars.asm");this.addSourceFile("displaynextframe.asm");this.addSourceFile("getframeinfo.asm");this.addSourceFile("player.asm");this.addSourceFile("playframes.asm");this.addSourceFile("setupinterrupts.asm");this.addSourceFile("zeropage.asm")}xt=xt-2049+2;var Mt=new Uint8Array(xt);for(var M=0;M<xt;M++){Mt[M]=R[M]}if(d!="source"){this.assemble(e)}else{this.downloadZip()}return;if(u){var d="prg";if(typeof e.type!="undefined"){d=e.type}if(d=="prg"){if(f.indexOf(".prg")==-1){f+=".prg"}download(Mt,f,"application/prg");var R=new Uint8Array(12261);for(var M=0;M<R.length;M++){R[M]=Mt[M+2048]}download(R,"data.bin","application/bin")}else{if(f.indexOf(".d64")==-1){f+=".d64"}var Tt=new D64;Tt.diskName=e.diskName;Tt.addFile(e.prgName,Mt,"prg");Tt.createD64(f)}}console.log(_)},downloadZip:function(){console.log("download zip!");console.log(this.files);var e=new JSZip;var t={};var i=this.files;var r="source";for(var a=0;a<i.length;a++){var s="file";var o="";var l=i[a].filePath.lastIndexOf(".");if(l!=-1){o=i[a].filePath.substr(l+1)}if(o==""&&i[a].content==""){s="folder"}var n=i[a].filePath.split("/");var h="";var d=e;var c=n.length-1;if(s=="folder"){c++}for(var f=0;f<c;f++){if(f!=0){h+="/"}h+=n[f];if(typeof t[h]=="undefined"){d=d.folder(n[f]);t[h]=d}else{d=t[h]}}if(s!="folder"){var u=n[n.length-1];var o="";var p=u.lastIndexOf(".");if(p!==-1){o=u.substr(p+1).toLowerCase()}var v="";if(o=="prg"||o=="bin"){d.file(u,i[a].content,{base64:true})}else{if(typeof i[a].content!=="string"){v=JSON.stringify(i[a].content)}else{v=i[a].content}d.file(u,v)}}}e.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}).then(function(e){console.log("download!!!");download(e,r+".zip","application/zip")})},assemble:function(e){console.log("assemble");var t=[];var i=e.filename;g_app.assemblerEditor.assemble(function(e){var t="output.prg";if(t.indexOf(".prg")==-1){t+=".prg"}download(e.prg,t,"application/prg")},this.files)},assembleCode:function(e){var t=this.editor.frames.width;var i=this.editor.frames.width;var r=(i-24)*t>>8&255;var a=(i-24)*t&255;args={};args["FRAMEWIDTHHIGH"]="#0";args["FRAMEWIDTHLOW"]="#"+t;args["VERTICALSCROLLMAXHIGH"]="#"+r;args["VERTICALSCROLLMAXLOW"]="#"+a;for(var s in args){if(args.hasOwnProperty(s)){var o=args[s];e=e.replace(new RegExp(s,"g"),o)}}var l=g_app.assembler;var n=l.assemble(e,2049);if(n.success){var h=l.getMemory();var d=0;this.prg=[];this.prg[d++]=1;this.prg[d++]=8;for(var c=n.start;c<n.end;c++){this.prg[d++]=h[c]}this.blocks=n.blocks;var f="";for(var c=0;c<this.prg.length;c++){f+=this.prg[c].toString(16)+"\n"}f=l.getDisassembly();$("#c64PRGCodeEditorResult").val(f)}else{var f="ERRORS FOUND:\n";for(var c=0;c<n.errors.length;c++){f+=n.errors[c].message+"\n"}$("#c64PRGCodeEditorResult").val(f)}},effectsCode:function(){var e="";for(var t=0;t<this.effects.length;t++){e+="  jsr effect"+t+"_init\n"}e+="  rts\n";e+="effects_trigger\n";var i=0;var r=0;for(var t=0;t<this.effects.length;t++){i=t+4;r=i+1;e+="effect_trigger_"+i+"\n";e+="  cmp #"+i+"\n";e+="  bne effect_trigger_"+r+"\n";e+="  jmp effect"+t+"_trigger"+"\n"}e+="effect_trigger_"+r+"\n";e+="  rts\n";e+="effects_tick\n";for(var t=0;t<this.effects.length;t++){e+=" jsr effect"+t+"_tick\n"}e+="  rts\n";for(var t=0;t<this.effects.length;t++){e+="effect"+t+"_data\n";e+=this.effects[t].data+"\n";e+="effect"+t+"_init\n";e+=this.effects[t].init+"\n";e+="  rts\n";e+="effect"+t+"_trigger\n";e+=this.effects[t].trigger+"\n";e+="  rts\n";e+="effect"+t+"_tick\n";e+=this.effects[t].tick+"\n";e+="  rts\n"}return e},setSIDData:function(e){console.log("set sid data");console.log(e);this.sidData=null;var t=e.music;if(typeof t=="undefined"){t="no"}if(t!="no"&&t!="sid"){var i=t;if(g_app.doc.getDocRecord(i)!=null){g_app.music.show(i);var r=4096;this.sidHeaderLength=0;this.sidLoadAddr=r;this.sidInitAddr=r;this.sidPlayAddr=r+3;this.sidSpeed=g_app.music.sidSpeed;g_app.music.createSid();if(typeof g_app.music.musicPlayer2.songData!="undefined"&&typeof g_app.music.musicPlayer2.songData.getSIDData!="undefined"){this.sidData=g_app.music.musicPlayer2.songData.getSIDData()}else{alert("sorry, the current music play does not support sid data export");this.sidData=null}}}if(t=="no"){this.sidData=null}if(t=="sid"){this.sidHeaderLength=126;this.sidLoadAddr=e.sidLoadAddr;this.sidInitAddr=e.sidInitAddr;this.sidPlayAddr=e.sidPlayAddr;this.sidSpeed=e.sidSpeed;if(this.sidSpeed<1){this.sidSpeed=1}this.sidData=e.sidData}},getExtendedColorBGColors:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){alert("Please choose a grid layer");return}this.extendedColorBGColors=[];if(i.getScreenMode()==TextModeEditor.Mode.C64ECM){var r=t[0];for(var a=0;a<4;a++){this.extendedColorBGColors.push({color:i.getC64ECMColor(a,r),timesUsed:10})}}else{var s=e.gridWidth;var o=e.gridHeight;var l=e.frames;var n=[];for(var a=0;a<16;a++){n[a]={color:a,timesUsed:0}}for(var h=0;h<t.length;h++){var r=t[h];for(var d=0;d<o;d++){for(var c=0;c<s;c++){var f=0;var u=i.getCell({x:c,y:d,frame:r});f=u.bc;f=this.getC64Color(f);if(typeof f!="undefined"&&f!==false){n[f].timesUsed++}else{if(l[r].frameData.bgColor<16){n[l[r].frameData.bgColor].timesUsed++}}}}}n.sort(function(e,t){return t.timesUsed-e.timesUsed});for(var a=0;a<4;a++){this.extendedColorBGColors[a]=n[a]}}return true},getMostUsedCharacters:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=i.getTileSet();var a=r.getTileCount();if(!i||i.getType()!="grid"){alert("Please choose a grid layer");return}if(i.getScreenMode()==TextModeEditor.Mode.C64ECM){this.mostUsedCharacters=[];for(var s=0;s<a;s++){this.mostUsedCharacters.push({c:s,timesUsed:0})}}else{this.mostUsedCharacters=[];for(var s=0;s<a;s++){this.mostUsedCharacters.push({c:s,timesUsed:0})}var o=0;var l=e.gridWidth;var n=e.gridHeight;var h=e.frames;for(var d=0;d<t.length;d++){var c=t[d];for(var f=0;f<n;f++){for(var u=0;u<l;u++){var p=i.getCell({x:u,y:f,frame:c});var v=p.t;if(v<this.mostUsedCharacters.length){this.mostUsedCharacters[v].timesUsed++}}}}this.mostUsedCharacters.sort(function(e,t){return t.timesUsed-e.timesUsed})}},getCharData:function(e,t,i){var r=[];var a=e.getTileWidth();var s=e.getTileHeight();var o=e.getTileCount();for(var l=0;l<8;l++){var n=0;for(var h=0;h<8;h++){if(h<a&&l<s){if(e.getPixel(t,h,l,i)){n=n|1<<7-h}}}r.push(n)}return r},getCharsetData:function(e){var t=e.getTileCount();this.charsetData=[];this.charsetMap=[];var i=e.getTileWidth();var r=e.getTileHeight();var t=e.getTileCount();for(var a=0;a<t;a++){this.charsetMap[a]=0}for(var a=0;a<t;a++){var s=a;if(t>t){s=this.mostUsedCharacters[a].c;this.charsetMap[s]=a}else{this.charsetMap[a]=a}for(var o=0;o<8;o++){var l=0;for(var n=0;n<8;n++){if(n<i&&o<r){if(e.getPixel(s,n,o)){l=l|1<<7-n}}}this.charsetData.push(l)}}},getExtendedColorCharsetData:function(e,t){this.extendedColorCharsetData=[];this.charsetMap=[];var i=e.getTileWidth();var r=e.getTileHeight();var a=e.getTileCount();for(var s=0;s<a;s++){this.charsetMap[s]=0}for(var s=0;s<256;s++){var o=this.mostUsedCharacters[s].c;this.charsetMap[o]=s;if(s<64){for(var l=0;l<8;l++){var n=0;for(var h=0;h<8;h++){if(h<i&&l<r){if(e.getPixel(o,h,l)){n=n|1<<7-h}}}this.extendedColorCharsetData.push(n)}}}},getBackgroundColor:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return this.editor.colorPaletteManager.noColor}var i=t.getBackgroundColor(e);if(i!=this.editor.colorPaletteManager.noColor){return i}var r=this.editor.layers.getSelectedLayerIndex();while(r>0){r--;var t=this.editor.layers.getLayerObjectFromIndex(r);if(t&&typeof t.getBackgroundColor!="undefined"){i=t.getBackgroundColor(e);if(i!=this.editor.colorPaletteManager.noColor){return i}}}return this.editor.colorPaletteManager.noColor},getBorderColor:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return this.editor.colorPaletteManager.noColor}var t=e.getBorderColor();if(t!=this.editor.colorPaletteManager.noColor){return t}var i=this.editor.layers.getSelectedLayerIndex();while(i>0){i--;var e=this.editor.layers.getLayerObjectFromIndex(i);if(e&&typeof e.getBorderColor!="undefined"){t=e.getBorderColor();if(t!=this.editor.colorPaletteManager.noColor){return t}}}return this.editor.colorPaletteManager.noColor},createColorMap:function(e){if(e.getColorCount()==16){this.colorMap=[];for(var t=0;t<e.getColorCount();t++){this.colorMap.push(t)}}else{this.colorMap=[];for(var t=0;t<e.getColorCount();t++){this.colorMap.push(false)}}this.c64Colors=[];for(var t=0;t<this.colorSchemes.vice.length;t++){var i={};i.hex=this.colorSchemes.vice[t];var r=i.hex>>16&255;var a=i.hex>>8&255;var s=i.hex&255;i.r=r/255;i.g=a/255;i.b=s/255;var o={};o.values=[r,a,s,255];i.hsv=Colour.converters[Colour.RGBA][Colour.HSVA](o);i.laba=Colour.converters[Colour.RGBA][Colour.LABA](o);this.c64Colors.push(i)}},getC64Color:function(e){if(this.colorMap[e]!==false){return this.colorMap[e]}var t=this.editor.colorPaletteManager.getCurrentColorPalette();if(t.getIsC64Palette()){return e}var i=t.getColor(e);if(typeof i.laba=="undefined"){return e}var r=0;var a=false;for(var s=0;s<this.c64Colors.length;s++){var o=0;o+=Math.abs(i.laba.values[0]-this.c64Colors[s].laba.values[0]);o+=Math.abs(i.laba.values[1]-this.c64Colors[s].laba.values[1]);o+=Math.abs(i.laba.values[2]-this.c64Colors[s].laba.values[2]);if(a===false||o<a){a=o;r=s}}this.colorMap[e]=r;return this.colorMap[e]},getIsJumpToFrame:function(e){var t=this.entries;for(var i=0;i<t.length;i++){if(t[i].type=="frameJump"){var r=parseInt(t[i].jumpTo)-1;var a=0;if(t[r].type=="frame"){a=t[r].frame}else if(t[r].type=="frameRange"){a=t[r].from}if(e==a){return true}}}return false},getIsTriggerJumpToFrame:function(e){var t=this.entries;var i=this.keyTriggers;var r=this.instrTriggers;for(var a=0;a<i.length;a++){if(i[a].action=="gotorow"){var s=parseInt(i[a].gotoRow)-1;var o=0;if(t[s].type=="frame"){o=t[s].frame}else if(t[s].type=="frameRange"){o=t[s].from}if(e==o){return true}}}for(var a=0;a<r.length;a++){if(r[a].action=="gotorow"){var s=parseInt(r[a].gotoRow)-1;var o=0;if(t[s].type=="frame"){o=t[s].frame}else if(t[s].type=="frameRange"){o=t[s].from}if(e==o){return true}}}return false},getNeededFrames:function(){this.frames=[];this.framesToExport=[];var e=-1;var t=this.entries;for(var i=0;i<t.length;i++){if(t[i].type=="frame"){var r=parseInt(t[i].frame);var a=false;var s=this.getIsJumpToFrame(r);var o=this.getIsTriggerJumpToFrame(r);if(o){s=true}for(var l=0;l<this.frames.length;l++){if(this.frames[l].frame==r){if(e!=this.frames[l].previousFrame){this.frames[l].canWriteAsChanges=false}a=true}}if(!a){this.frames.push({frame:r,previousFrame:e,canWriteAsRLE:!s&!o,canWriteAsChanges:e!=-1&!s});this.framesToExport.push(r-1)}e=r}else if(t[i].type=="frameRange"){var n=parseInt(t[i].from);var h=parseInt(t[i].to);var d=1;if(h<n){d=-1}for(var r=n;r!=h+d;r+=d){var s=this.getIsJumpToFrame(r);var o=this.getIsTriggerJumpToFrame(r);if(o){s=true}var a=false;for(var l=0;l<this.frames.length;l++){if(this.frames[l].frame==r){if(e!=this.frames[l].previousFrame){this.frames[l].canWriteAsChanges=false}a=true}}if(!a){this.frames.push({frame:r,previousFrame:e,canWriteAsRLE:!s&!o,canWriteAsChanges:e!=-1&!s});this.framesToExport.push(r-1)}e=r}}}},toHex:function(e){if(typeof e!="undefined"){return("00"+e.toString(16)).substr(-2)}return"00"},formatBytes:function(e,t){var i=true;var r="!byte ";var a="\n";var s=0;var o=16;var l="";for(var n=0;n<e.length;n++){var h=e[n];if(s!==0){l+=","}else{l+=r}if(i){l+="$";l+=("00"+h.toString(16)).substr(-2)}else{l+=h.toString(10)}s++;if(s==o){s=0;l+=a}}return l}};var ExportC64ASM=function(){this.editor=null;this.effects=[{name:"Background Flash",data:";data \nbgEffectCounter\n!byte 00\nbgEffectColor \n!byte $0,$0,$b,$b,$c,$c,$f,$f,$1,$1,$f,$c,$b",init:";init\n;this code is executed once on startup\n",trigger:";on trigger\n;this code is executed when the effect is triggered\n  lda #$0d\n  sta bgEffectCounter\n",tick:"\n;on tick\n;this code is executed on every tick\n\n  lda bgEffectCounter\n  cmp #00\n  beq bgEffectDone\n    \n  ldy bgEffectCounter\n  lda bgEffectColor,y\n\n  sta $d021\n\n  dey\n  sty bgEffectCounter\n\nbgEffectDone"},{name:"Jitter",data:";data \neffectJitterCounter\n!byte 00\neffectJitterAmount\n!byte $7,$0,$3,$6,$2,$7,$4",init:";init\n;this code is executed once on startup\n",trigger:";on trigger\n;this code is executed when the effect is triggered\n  lda #$06\n  sta effectJitterCounter\n    \n  lda #$07\n  ora $d016\n",tick:";on tick\n;this code is executed on every tick\n\n  lda effectJitterCounter\n  cmp #00\n  beq effectJitterDone\n  \n  lda $d016                                    ; $d016 is a VIC-II control register which contains the horizontal scroll value\n  and #$F8           \n  sta temp      \n      \n  ldy effectJitterCounter\n  lda effectJitterAmount,y\n  \n  ora temp\n  sta $d016\n\n  dey\n  sty effectJitterCounter\n\neffectJitterDone"}];this.entries=[];this.keyTriggers=[];this.instrTriggers=[];this.mostUsedCharacters=[];this.extendedColorCharsetData=[];this.charsetMap=[];this.extendedColorBGColors=[];this.keymap={a:33,b:67,c:66,d:34,e:97,f:82,g:35,h:83,i:20,j:36,k:84,l:37,m:68,n:116,o:100,p:21,q:103,r:18,s:81,t:98,u:99,v:115,w:17,x:114,y:19,z:65,0:52,1:7,2:55,3:1,4:49,5:2,6:50,7:3,8:51,9:4,"-":53,"=":5},this.colorSchemes={vice:[0,16777215,6829867,7382194,7290246,5803331,3483769,12109679,7294757,4405504,10119001,4473924,7105644,10146436,7102133,9803157],ccs64:[1645849,16579068,9648716,11991802,13794797,6999919,5194968,16513931,14195803,8344327,15696799,5723987,10725287,12057535,10721279,15722983]};this.c64Asm=null};ExportC64ASM.prototype={init:function(e){this.editor=e;this.c64Asm=new C64ASM;this.c64Asm.init(this.editor)},assembleCode:function(e){var t=this.editor.frames.width;var i=this.editor.frames.width;var r=(i-24)*t>>8&255;var a=(i-24)*t&255;args={};args["FRAMEWIDTHHIGH"]="#0";args["FRAMEWIDTHLOW"]="#"+t;args["VERTICALSCROLLMAXHIGH"]="#"+r;args["VERTICALSCROLLMAXLOW"]="#"+a;for(var s in args){if(args.hasOwnProperty(s)){var o=args[s];e=e.replace(new RegExp(s,"g"),o)}}var l=g_app.assembler;var n=l.assemble(e,2049);console.log(e);if(n.success){var h=l.getMemory();var d=0;this.prg=[];this.prg[d++]=1;this.prg[d++]=8;for(var c=n.start;c<n.end;c++){this.prg[d++]=h[c]}this.blocks=n.blocks;var f="";for(var c=0;c<this.prg.length;c++){f+=this.prg[c].toString(16)+"\n"}f=l.getDisassembly();console.log(f)}else{var f="ERRORS FOUND:\n";for(var c=0;c<n.errors.length;c++){f+=n.errors[c].message+"\n"}}},createPRG:function(e){console.log("create prg");console.log(e);var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){alert("Please choose a grid layer");return}var i="c64.prg";var r=true;if(typeof e.filename!="undefined"){i=e.filename}var a=t.getColorPalette();var s=t.getTileSet();var o=t.getColorPerMode();if(t.getBlockModeEnabled()){t.updateTilesFromBlocks()}if(o=="character"){t.updateGridColorsFromTiles()}var l="current";if(typeof e.layers!="undefined"){l=e.layers}if(typeof e.download!="undefined"){r=e.download}var n=e.gridWidth;var h=e.gridHeight;if(s.getTileHeight()>8){h=h*2}var d=false;if(h>25||n>40){if(typeof e.scrollV!="undefined"){d=e.scrollV}}if(!d){if(n>40){n=40}if(h>25){h=25}}this.colorMap=[];for(var c=0;c<a.getColorCount();c++){this.colorMap.push(false)}this.c64Colors=[];for(var c=0;c<this.colorSchemes.vice.length;c++){var f={};f.hex=this.colorSchemes.vice[c];var u=f.hex>>16&255;var p=f.hex>>8&255;var v=f.hex&255;f.r=u/255;f.g=p/255;f.b=v/255;var g={};g.values=[u,p,v,255];f.hsv=Colour.converters[Colour.RGBA][Colour.HSVA](g);f.laba=Colour.converters[Colour.RGBA][Colour.LABA](g);this.c64Colors.push(f)}var m=e.mode=="extended";var y=e.mode=="multicolor";var b=e.mode=="monochrome";if(b&&typeof e.monochromeColor!="undefined"){this.monochromeColor=e.monochromeColor}var C=e.music;if(typeof C=="undefined"){C="no"}var x=!s.isDefaultTileSet("c64");var S=s.getTileCount();if(S!=256){x=true}else{for(var c=0;c<S;c++){if(s.tileData[c].props.animated!==false){x=true;break}}}for(var c=0;c<S;c++){this.charsetMap[c]=c}var P=e.frames;var w=this.editor.grid.xyPosition;if(typeof e.fgPosition!="undefined"){w=e.fgPosition}var I=0;if(d){console.log("SCROLLING!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");code=C64ASMScroll}else{code=this.c64Asm.files.load("/main.asm")}effectsCode="\ninit_effects\n"+this.effectsCode();code=code.replace("\ninit_effects",effectsCode);this.assembleCode(code);var k=[];var M=[];for(var c=0;c<this.blocks.length;c++){M.push({type:"Code",start:this.blocks[c].start,end:this.blocks[c].end,label:this.blocks[c].label})}var T=[];if(typeof e.entries=="undefined"){alert("shouldnt get here??");this.writeEntriesTable();T=this.entries}else{T=e.entries}var D=[];if(typeof e.keyTriggers=="undefined"){this.writeKeyTriggersTable();D=this.keyTriggers}else{D=e.keyTriggers}var E=[];if(typeof e.instrTriggers=="undefined"){this.writeInstrTriggersTable();E=this.instrTriggers}else{E=e.instrTriggers}var $=[];var _=[];var B=-1;for(var c=0;c<T.length;c++){if(T[c].type=="frame"){var R=parseInt(T[c].frame);var A=false;var F=false;var L=false;for(var U=0;U<T.length;U++){if(T[U].type=="frameJump"){var H=parseInt(T[U].jumpTo)-1;var O=0;if(T[H].type=="frame"){O=T[H].frame}else if(T[H].type=="frameRange"){O=T[H].from}if(R==O){F=true;break}}}for(var U=0;U<D.length;U++){if(D[U].action=="gotorow"){var G=parseInt(D[U].gotoRow)-1;var z=0;if(T[G].type=="frame"){z=T[G].frame}else if(T[G].type=="frameRange"){z=T[G].from}if(R==z){F=true;L=true;break}}}for(var U=0;U<E.length;U++){if(E[U].action=="gotorow"){var G=parseInt(E[U].gotoRow)-1;var z=0;if(T[G].type=="frame"){z=T[G].frame}else if(T[G].type=="frameRange"){z=T[G].from}if(R==z){F=true;L=true;break}}}for(var U=0;U<$.length;U++){if($[U].frame==R){if(B!=$[U].previousFrame){$[U].canWriteAsChanges=false}A=true;break}}if(!A){$.push({frame:R,previousFrame:B,canWriteAsRLE:!F&!L,canWriteAsChanges:B!=-1&!F});_.push(R-1)}B=R}else if(T[c].type=="frameRange"){var N=parseInt(T[c].from);var W=parseInt(T[c].to);var X=1;if(W<N){X=-1}for(var R=N;R!=W+X;R+=X){var F=false;var L=false;for(var U=0;U<T.length;U++){if(T[U].type=="frameJump"){var H=parseInt(T[U].jumpTo)-1;var O=0;if(T[H].type=="frame"){O=T[H].frame}else if(T[H].type=="frameRange"){O=T[H].from}if(R==O){F=true;break}}}for(var U=0;U<D.length;U++){if(D[U].action=="gotorow"){var G=parseInt(D[U].gotoRow)-1;var z=0;if(T[G].type=="frame"){z=T[G].frame}else if(T[G].type=="frameRange"){z=T[G].from}if(R==z){F=true;L=true;break}}}for(var U=0;U<E.length;U++){if(E[U].action=="gotorow"){var G=parseInt(E[U].gotoRow)-1;var z=0;if(T[G].type=="frame"){z=T[G].frame}else if(T[G].type=="frameRange"){z=T[G].from}if(R==z){F=true;L=true;break}}}var A=false;for(var U=0;U<$.length;U++){if($[U].frame==R){if(B!=$[U].previousFrame){$[U].canWriteAsChanges=false}A=true;break}}if(!A){$.push({frame:R,previousFrame:B,canWriteAsRLE:!F&!L,canWriteAsChanges:B!=-1&!F});_.push(R-1)}B=R}}}this.sidData=null;if(C!="no"&&C!="sid"){var Y=C;if(g_app.doc.getDocRecord(Y)!=null){g_app.music.show(Y);var V=4096;this.sidHeaderLength=0;this.sidLoadAddr=V;this.sidInitAddr=V;this.sidPlayAddr=V+3;this.sidSpeed=g_app.music.sidSpeed;g_app.music.createSid();if(typeof g_app.music.musicPlayer2.songData!="undefined"&&typeof g_app.music.musicPlayer2.songData.getSIDData!="undefined"){this.sidData=g_app.music.musicPlayer2.songData.getSIDData()}else{alert("sorry, the current music play does not support sid data export");this.sidData=null}}}if(C=="no"){this.sidData=null}if(C=="sid"){this.sidHeaderLength=126;this.sidLoadAddr=e.sidLoadAddr;this.sidInitAddr=e.sidInitAddr;this.sidPlayAddr=e.sidPlayAddr;this.sidSpeed=e.sidSpeed;if(this.sidSpeed<1){this.sidSpeed=1}this.sidData=e.sidData}var q=this.prg;var j=new Uint8Array(64e3);var K=0;var Z=this.getBorderColor();var J=this.getBackgroundColor();K=0;var Q=K;for(var c=0;c<q.length;c++){j[K++]=q[c]}ie=K;k.push({type:"Code",from:Q,to:ie});console.log("CODE FROM TO = "+Q+","+ie);var ee=1;if(m){if(this.getExtendedColorBGColors(e,_)){this.getMostUsedCharacters(e,_);var te=0;for(var c=0;c<ee;c++){s=t.getTileSet();if(s.getTileHeight()>8){this.getTallerCharsetData(s,c,m)}else{this.getExtendedColorCharsetData(s,c)}x=true;K=14336-2049+2-2048*te;s.memoryLocation=7-te<<1;var Q=K;for(var U=0;U<this.extendedColorCharsetData.length;U++){j[K++]=this.extendedColorCharsetData[U]}var ie=K;k.push({type:"Character Data",from:Q,to:ie});M.push({type:"Character Set Data",start:Q+2049-2,end:ie+2049-2});te++}}else{m=false}}else{if(s.getTileHeight()>8){this.getMostUsedCharacters(e,_);var te=0;for(var c=0;c<ee;c++){s=t.getTileSet();K=14336-2049+2-2048*te;s.memoryLocation=7-te<<1;var Q=K;this.getTallerCharsetData(s,c);for(var U=0;U<this.charsetData.length;U++){j[K++]=this.charsetData[U]}var ie=K;M.push({type:"Character Set Data ("+s.name+")",start:Q+2049-2,end:ie+2049-2});te++}}else{var te=0;this.getMostUsedCharacters(e,_);for(var c=0;c<ee;c++){s=t.getTileSet();if(s.isDefaultTileSet("c64")){s.memoryLocation=4}else{K=14336-2049+2-2048*te;s.memoryLocation=7-te<<1;var Q=K;this.getCharsetData(s);for(var U=0;U<this.charsetData.length;U++){j[K++]=this.charsetData[U]}var ie=K;M.push({type:"Character Set Data ("+s.name+")",start:Q+2049-2,end:ie+2049-2});te++}}}}K=4095-2049+2;if(this.sidData){var re=K+2049-2;if(re>this.sidLoadAddr){this.sidData=null}else{K=this.sidLoadAddr-2049+2;var Q=K;for(var c=this.sidHeaderLength;c<this.sidData.length;c++){j[K++]=this.sidData[c]}var ie=K;k.push({type:"SID",from:Q,to:ie});M.push({type:"SID",start:Q+2049-2,end:ie+2049-2})}}else{}var ae=K;K+=600;var se=false;var oe=0;var Q=K;var S=s.getTileCount();for(var c=0;c<S;c++){var le=s.getAnimatedType(c);var ne=s.getTileProperties(c);if(le!==false){var he=0;if(c<this.charsetMap.length){he=this.charsetMap[c]}x=true;j[K++]=ne.ticksPerFrame;j[K++]=ne.ticksPerFrame;j[K++]=he*8&255;j[K++]=he*8>>8;switch(le){case"right":j[K++]=1;break;case"up":j[K++]=2;break;case"down":j[K++]=3;break;case"blink":j[K++]=4;break;default:case"left":j[K++]=0;break}oe++}}j[K++]=0;var se=Q;var ie=K;if(ie!=Q){k.push({type:"Animated Characters Table",from:Q,to:ie});M.push({type:"Animated Characters Table",start:Q+2049-2,end:ie+2049-2})}var Q=K;for(var c=0;c<4;c++){j[K++]=6;j[K++]=6;j[K++]=c}j[K++]=0;var de=Q;var ie=K;if(ie!=Q){k.push({type:"Animated BG Colours Table",from:Q,to:ie});M.push({type:"Animated BG Colours Table",start:Q+2049-2,end:ie+2049-2})}var ce=K;var fe=2064-2049+2;var ue=fe;j[ue++]=this.getC64Color(Z);if(m){j[ue++]=1}else if(y){j[ue++]=2}else{j[ue++]=0}if(x){j[ue++]=1}else{j[ue++]=0}if(this.sidData){j[ue++]=1;j[ue++]=this.sidSpeed;j[ue++]=this.sidInitAddr&255;j[ue++]=this.sidInitAddr>>8;j[ue++]=this.sidPlayAddr&255;j[ue++]=this.sidPlayAddr>>8}else{j[ue++]=0;j[ue++]=0;j[ue++]=0;j[ue++]=0;j[ue++]=0;j[ue++]=0}j[ue++]=ae+2049-2&255;j[ue++]=ae+2049-2>>8;j[ue++]=se+2049-2&255;j[ue++]=se+2049-2>>8;j[ue++]=de+2049-2&255;j[ue++]=de+2049-2>>8;var pe=[];var ve=0;for(var ge=0;ge<$.length;ge++){var R=$[ge].frame-1;if(m){this.getExtendedColorBGColors(e,[R]);console.log("extended bg colours");console.log(this.extendedColorBGColors)}else{this.extendedColorBGColors=[];J=this.getBackgroundColor(R);if(y){var me=t.getC64Multi1Color();var ye=t.getC64Multi2Color();this.extendedColorBGColors.push({color:this.getC64Color(J)});this.extendedColorBGColors.push({color:this.getC64Color(me)});this.extendedColorBGColors.push({color:this.getC64Color(ye)});this.extendedColorBGColors.push({color:0})}else{this.extendedColorBGColors.push({color:this.getC64Color(J)});this.extendedColorBGColors.push({color:0});this.extendedColorBGColors.push({color:0});this.extendedColorBGColors.push({color:0})}}var be=1;var Ce=[];var xe=[];var Se=[];var Pe=1;var we=[];var Ie=[];for(var ke=0;ke<h;ke++){for(var Me=0;Me<n;Me++){var Te=this.editor.tileSetManager.blankCharacter;var De=ke;var Ee=0;if(s.charHeight>8){De=Math.floor(De/2);if(ke%2!=0){Ee=128;if(m){Ee=32}}}var f=P[R].frameData.data[De][Me].fc;var $e=false;if(l=="merge"){}else{Te=P[R].frameData.data[De][Me].t}if(b){f=this.monochromeColor}if(Te<this.charsetMap.length){Te=this.charsetMap[Te]+Ee}else{Te=0}if(m){if(l!=="merge"){if(this.editor.bgInPrevLayer){$e=P[R].frameData.data[De][Me].fc}else{$e=P[R].frameData.data[De][Me].bc}}if(typeof $e=="undefined"||$e===false){$e=this.getBackgroundColor(R)}if(t.getScreenMode()!==TextModeEditor.Mode.C64ECM){$e=this.getC64Color($e);for(var c=0;c<this.extendedColorBGColors.length;c++){if($e==this.extendedColorBGColors[c].color){$e=c;break}}}else{if($e==this.editor.colorPaletteManager.noColor){$e=0}}$e=$e&3;Te=Te|$e<<6}Ce.push(Te);we.push(this.getC64Color(f))}}var _e=-1;var Be=0;var Re=250;for(var c=0;c<Ce.length;c++){Be=0;_e=Ce[c];while(c<Ce.length&&_e==Ce[c]&&Be<Re){c++;Be++}Se.push(Be);Se.push(_e);if(Be>0){c--}}Se.push(0);if($[ge].canWriteAsChanges){var B=$[ge].previousFrame;var Ae=-1;for(var c=0;c<$.length;c++){if($[c].frame==B){Ae=c;break}}if(Ae!=-1){var Fe=0;for(var c=0;c<Ce.length;c++){var Le=Ce[c];var Ue=$[Ae].frameData.charData[c];if(Le!=Ue||Fe>200){xe.push(Fe);xe.push(Le);Fe=0}Fe++}if(xe.length==1){xe.push($[Ae].frameData.charData[0])}xe.push(0);if(xe.length<900){be=2}var Fe=0;for(var c=0;c<we.length;c++){var He=we[c];var Oe=$[Ae].frameData.colorData[c];if(He!=Oe||Fe>200){Ie.push(Fe);Ie.push(He);Fe=0}Fe++}Ie.push(0);if(Ie.length==1){Ie.push($[Ae].frameData.colorData[0]);Ie.push(0)}if(Ie.length<240){Pe=2}}}if($[ge].canWriteAsRLE){if(be==1&&Se.length<600&&Se.length!=0){be=3}}if(d){be=1;Pe=1}var Ge=P[R].duration;if(Ge>255){Ge=255}if(Ge<7){Ge=7}var ze={charFrameType:be,colorFrameType:Pe,duration:Ge,charData:Ce,charChangesData:xe,charRLEData:Se,colorData:we,colorChangesData:Ie,bgColor1:this.extendedColorBGColors[0].color,bgColor2:this.extendedColorBGColors[1].color,bgColor3:this.extendedColorBGColors[2].color,bgColor4:this.extendedColorBGColors[3].color};$[ge].frameData=ze}var Ne=14336-2049+2;var We=2048;if(m){We=this.extendedColorCharsetData.length}var K=ce;var Xe=ae;var Ye=0;var Ve=false;for(var c=0;c<$.length;c++){var ze=$[c].frameData;var qe=ze.charData.length;var je=ze.colorData.length;if(ze.colorFrameType==2){je=ze.colorChangesData.length}var Ke=false;while(!Ke){Ke=true;for(var U=0;U<M.length;U++){if(K+2049-2<M[U].end&&K+qe+2049-2>=M[U].start){Ke=false;K=M[U].end-2049+2;var Ze=K+2049-2}}}var Ze=K+2049-2;if(K+qe+je>53248-2049){break}var Je=K;var Q=K;if(ze.charFrameType==1){console.log("USING FULL FRAME!!!!!");for(var U=0;U<ze.charData.length;U++){j[K++]=ze.charData[U]}}else if(ze.charFrameType==2){console.log("USING CHANGES DATA!!!!!!!!");console.log(ze.charChangesData);for(var U=0;U<ze.charChangesData.length;U++){j[K++]=ze.charChangesData[U]}}else if(ze.charFrameType==3){console.log("USING RLE Data");for(var U=0;U<ze.charRLEData.length;U++){j[K++]=ze.charRLEData[U]}}else{alert("???")}var ie=K;k.push({type:"Frame Data",from:Q,to:ie});M.push({type:"Frame "+c+" Char Data",start:Q+2049-2,end:ie+2049-2});var Qe=K;var et=false;if(!d){et=true}if(ze.colorFrameType==1){if(Ve!==false&&et){var Q=Ve;Qe=Ve;for(var U=0;U<ze.colorData.length;U++){j[Ve]=ze.colorData[U];U++;j[Ve]=j[Ve]|ze.colorData[U]<<4;Ve+=2}var ie=Ve;M.push({type:"Frame "+c+" Color Data (4 bit)",start:Q+2049-2,end:ie+2049-2});Ve=false}else{var Ke=false;while(!Ke){Ke=true;for(var U=0;U<M.length;U++){if(K+2049-2<M[U].end&&K+je+1+2049-2>=M[U].start){Ke=false;K=M[U].end-2049+2}}}Qe=K;var Q=K;if(et){for(var U=0;U<ze.colorData.length;U++){j[K]=ze.colorData[U];U++;j[K]=j[K]|ze.colorData[U]<<4;K+=2}K++}else{for(var U=0;U<ze.colorData.length;U++){j[K++]=ze.colorData[U]}K++}var ie=K;k.push({type:"Frame Color Data",from:Q,to:ie});Ve=Qe+1;M.push({type:"Frame "+c+" Color Data (4 bit)",start:Q+2049-2,end:ie+2049-2})}}else if(ze.colorFrameType==2){var Ke=false;while(!Ke){Ke=true;for(var U=0;U<M.length;U++){if(K+2049-2<M[U].end&&K+je+1+2049-2>=M[U].start){Ke=false;K=M[U].end-2049+2}}}Qe=K;var Q=K;for(var U=0;U<ze.colorChangesData.length;U++){j[K++]=ze.colorChangesData[U]}var ie=K;k.push({type:"Frame Color Data",from:Q,to:ie});M.push({type:"Frame "+c+" Color Data (changes)",start:Q+2049-2,end:ie+2049-2})}else{alert("???")}Ye++;$[c].charAddress=Je+2049-2;$[c].colorAddress=Qe+2049-2;var tt=Xe+2049-2}var Q=Xe;var it=[];it[0]=0;var rt=true;var at=false;var st=false;for(var c=0;c<T.length;c++){var De=c+1;it[De]=Xe;if(T[c].type=="frame"){var R=parseInt(T[c].frame);for(var U=0;U<$.length;U++){if($[U].frame==R){var ze=$[U].frameData;var Ge=parseInt(T[c].duration);if(Ge<6){Ge=6}if(Ge>255){Ge=255}j[Xe++]=ze.charFrameType;j[Xe++]=$[U].charAddress&255;j[Xe++]=$[U].charAddress>>8;j[Xe++]=Ge;j[Xe++]=ze.colorFrameType;j[Xe++]=$[U].colorAddress&255;j[Xe++]=$[U].colorAddress>>8;j[Xe++]=ze.bgColor1;j[Xe++]=ze.bgColor2;j[Xe++]=ze.bgColor3;j[Xe++]=ze.bgColor4;if(rt&&D.length>0){j[Xe++]=1;at=Xe;j[Xe++]=0;j[Xe++]=0}if(rt&&E.length>0){j[Xe++]=3;st=Xe;j[Xe++]=0;j[Xe++]=0}rt=false;j[Xe++]=0}}}else if(T[c].type=="frameRange"){var N=T[c].from;var W=T[c].to;var A=false;var X=1;if(W<N){X=-1}for(var R=N;R!=W+X;R+=X){for(var U=0;U<$.length;U++){if($[U].frame==R){var ot=Xe;var ze=$[U].frameData;j[Xe++]=ze.charFrameType;j[Xe++]=$[U].charAddress&255;j[Xe++]=$[U].charAddress>>8;j[Xe++]=ze.duration;j[Xe++]=ze.colorFrameType;j[Xe++]=$[U].colorAddress&255;j[Xe++]=$[U].colorAddress>>8;j[Xe++]=ze.bgColor1;j[Xe++]=ze.bgColor2;j[Xe++]=ze.bgColor3;j[Xe++]=ze.bgColor4;if(rt&&D.length>0){j[Xe++]=1;at=Xe;j[Xe++]=0;j[Xe++]=0}if(rt&&E.length>0){j[Xe++]=3;st=Xe;j[Xe++]=0;j[Xe++]=0}rt=false;j[Xe++]=0;var lt=Xe;break}}}}else if(T[c].type=="frameJump"){var H=T[c].jumpTo;var nt=it[H]+2049-2;j[Xe++]=0;j[Xe++]=nt&255;j[Xe++]=nt>>8}}j[Xe++]=0;j[Xe++]=ae+2049-2&255;j[Xe++]=ae+2049-2>>8;console.log("TRIGGERS::::::::::::::::::");console.log(D);if(D.length>0){var ht=Xe+2049-2;j[at++]=ht&255;j[at]=ht>>8}for(var c=0;c<D.length;c++){var G=D[c].gotoRow;var nt=it[G]+2049-2;var dt=D[c].triggerKey.toLowerCase();j[Xe++]=this.keymap[dt];if(D[c].action=="gotorow"){j[Xe++]=0;j[Xe++]=nt&255;j[Xe++]=nt>>8}else if(D[c].action=="nextframe"){j[Xe++]=1;j[Xe++]=nt&255;j[Xe++]=nt>>8}else if(D[c].action=="changecharset"){j[Xe++]=2;var ct=D[c].charsetID;j[Xe++]=this.editor.tileSets[ct].memoryLocation;j[Xe++]=nt>>8}else{var ft=parseInt(D[c].action);if(!isNaN(ft)){ft+=4;j[Xe++]=ft;j[Xe++]=0;j[Xe++]=0}else{alert("unknown effect "+D[c].action)}}}console.log("TRIGGERS::::::::::::::::::");console.log(E);if(E.length>0){var ut=Xe+2049-2;j[st++]=ut&255;j[st]=ut>>8}for(var c=0;c<E.length;c++){var G=E[c].gotoRow;var nt=it[G]+2049-2;var pt=parseInt(E[c].triggerInstr);j[Xe++]=pt;if(E[c].action=="gotorow"){j[Xe++]=0;j[Xe++]=nt&255;j[Xe++]=nt>>8}else if(E[c].action=="nextframe"){j[Xe++]=1;j[Xe++]=nt&255;j[Xe++]=nt>>8}else if(E[c].action=="changecharset"){var ct=E[c].charsetID;j[Xe++]=2;j[Xe++]=this.editor.tileSets[ct].memoryLocation;j[Xe++]=nt>>8}else{var ft=parseInt(E[c].action);if(!isNaN(ft)){ft+=4;j[Xe++]=ft;j[Xe++]=0;j[Xe++]=0}else{alert("unknown effect "+E[c].action)}}}j[Xe++]=0;var ie=Xe;k.push({type:"Frame Table Data",from:Q,to:ie});var vt=K+2049-2;if(x){var gt=14336+2-2049+2048;if(vt<gt){vt=gt}}k.sort(function(e,t){return e.from-t.from});M.sort(function(e,t){return e.start-t.start});this.displayMemoryLayout(M);console.log(k);vt=vt-2049+2;var mt=new Uint8Array(vt);for(var c=0;c<vt;c++){mt[c]=j[c]}if(r){var yt="prg";if(typeof e.type!="undefined"){yt=e.type}if(yt=="prg"){if(i.indexOf(".prg")==-1){i+=".prg"}download(mt,i,"application/prg")}else{if(i.indexOf(".d64")==-1){i+=".d64"}var bt=new D64;bt.diskName=e.diskName;bt.addFile(e.prgName,mt,"prg");bt.createD64(i)}}return{blocks:M}},displayMemoryLayout:function(e){var t="<table>";t+="<tr><th>Start</th><th>End</th><th>Bytes</th><th>Contents</th></tr>";for(var i=0;i<e.length;i++){if(e[i].end>length){length=e[i].end}t+="<tr>";var r=("0000"+e[i].start.toString(16)).substr(-4);var a=("0000"+e[i].end.toString(16)).substr(-4);var s=e[i].end-e[i].start;t+='<td style="text-align: right">';t+=r;t+="</td>";t+='<td style="text-align: right">';t+=a;t+="</td>";t+='<td style="text-align: right">';t+=s;t+="</td>";t+="<td>";t+=e[i].type;if(e[i].type=="Code"&&typeof e[i].label!="undefined"){t+=" ("+e[i].label+")"}t+="</td>"}t+="</table>";$("#exportPRGAdvMemory").html(t)},getMostUsedCharacters:function(e,t){var i=this.editor.layers.getSelectedLayerObject();var r=i.getTileSet();var a=r.getTileCount();if(!i||i.getType()!="grid"){alert("Please choose a grid layer");return}if(i.getScreenMode()==TextModeEditor.Mode.C64ECM){this.mostUsedCharacters=[];for(var s=0;s<a;s++){this.mostUsedCharacters.push({c:s,timesUsed:0})}}else{this.mostUsedCharacters=[];for(var s=0;s<a;s++){this.mostUsedCharacters.push({c:s,timesUsed:0})}var o=0;var l=e.gridWidth;var n=e.gridHeight;var h=e.frames;for(var d=0;d<t.length;d++){var c=t[d];for(var f=0;f<n;f++){for(var u=0;u<l;u++){var p=i.getCell({x:u,y:f,frame:c});var v=p.t;if(v<this.mostUsedCharacters.length){this.mostUsedCharacters[v].timesUsed++}}}}this.mostUsedCharacters.sort(function(e,t){return t.timesUsed-e.timesUsed})}},getCharsetData:function(e){var t=e.getTileCount();this.charsetData=[];this.charsetMap=[];var i=e.getTileWidth();var r=e.getTileHeight();var t=e.getTileCount();for(var a=0;a<t;a++){this.charsetMap[a]=0}for(var a=0;a<t;a++){var s=a;if(t>t){s=this.mostUsedCharacters[a].c;this.charsetMap[s]=a}else{this.charsetMap[a]=a}for(var o=0;o<8;o++){var l=0;for(var n=0;n<8;n++){if(n<i&&o<r){if(e.getPixel(s,n,o)){l=l|1<<7-n}}}this.charsetData.push(l)}}},getTallerCharsetData:function(e,t,i){if(typeof i=="undefined"){i=false}this.charsetData=[];this.extendedColorCharsetData=[];this.charsetMap=[];var r=e.getTileWidth();var a=e.getTileHeight();var s=e.getTileCount();for(var o=0;o<s;o++){this.charsetMap[o]=0}var l=128;if(i){l=32}for(var o=0;o<l;o++){var n=this.mostUsedCharacters[o].c;this.charsetMap[n]=o;for(var h=0;h<8;h++){var d=0;for(var c=0;c<8;c++){if(c<r&&h<a){if(e.getPixel(n,c,h)){d=d|1<<7-c}}}if(i){this.extendedColorCharsetData.push(d)}else{this.charsetData.push(d)}}}for(var o=0;o<l;o++){var n=this.mostUsedCharacters[o].c;this.charsetMap[n]=o;for(var h=8;h<16;h++){var d=0;for(var c=0;c<8;c++){if(c<r&&h<a){if(e.getPixel(n,c,h)){d=d|1<<7-c}}}if(i){this.extendedColorCharsetData.push(d)}else{this.charsetData.push(d)}}}},getExtendedColorCharsetData:function(e,t){this.extendedColorCharsetData=[];this.charsetMap=[];var i=e.getTileWidth();var r=e.getTileHeight();var a=e.getTileCount();for(var s=0;s<a;s++){this.charsetMap[s]=0}for(var s=0;s<64;s++){var o=this.mostUsedCharacters[s].c;this.charsetMap[o]=s;for(var l=0;l<8;l++){var n=0;for(var h=0;h<8;h++){if(h<i&&l<r){if(e.getPixel(o,h,l)){n=n|1<<7-h}}}this.extendedColorCharsetData.push(n)}}},getExtendedColorBGColors:function(e,t){var i=this.editor.layers.getSelectedLayerObject();if(!i||i.getType()!="grid"){alert("Please choose a grid layer");return}this.extendedColorBGColors=[];if(i.getScreenMode()==TextModeEditor.Mode.C64ECM){var r=t[0];for(var a=0;a<4;a++){this.extendedColorBGColors.push({color:i.getC64ECMColor(a,r),timesUsed:10})}}else{var s=0;var o=e.gridWidth;var l=e.gridHeight;var n=e.frames;var h=[];for(var a=0;a<16;a++){h[a]={color:a,timesUsed:0}}for(var d=0;d<t.length;d++){var r=t[d];for(var c=0;c<l;c++){for(var f=0;f<o;f++){var u=0;var p=i.getCell({x:f,y:c,frame:r});u=p.bc;u=this.getC64Color(u);if(typeof u!="undefined"&&u!==false){h[u].timesUsed++}else{if(n[r].frameData.bgColor<16){h[n[r].frameData.bgColor].timesUsed++}}}}}h.sort(function(e,t){return t.timesUsed-e.timesUsed});for(var a=0;a<4;a++){this.extendedColorBGColors[a]=h[a]}}return true},effectsCode:function(){var e="";for(var t=0;t<this.effects.length;t++){e+="  jsr effect"+t+"_init\n"}e+="  rts\n";e+="effects_trigger\n";var i=0;var r=0;for(var t=0;t<this.effects.length;t++){i=t+4;r=i+1;e+="effect_trigger_"+i+"\n";e+="  cmp #"+i+"\n";e+="  bne effect_trigger_"+r+"\n";e+="  jmp effect"+t+"_trigger"+"\n"}e+="effect_trigger_"+r+"\n";e+="  rts\n";e+="effects_tick\n";for(var t=0;t<this.effects.length;t++){e+=" jsr effect"+t+"_tick\n"}e+="  rts\n";for(var t=0;t<this.effects.length;t++){e+="effect"+t+"_data\n";e+=this.effects[t].data+"\n";e+="effect"+t+"_init\n";e+=this.effects[t].init+"\n";e+="  rts\n";e+="effect"+t+"_trigger\n";e+=this.effects[t].trigger+"\n";e+="  rts\n";e+="effect"+t+"_tick\n";e+=this.effects[t].tick+"\n";e+="  rts\n"}return e},getC64Color:function(e){if(this.colorMap[e]!==false){return this.colorMap[e]}var t=this.editor.colorPaletteManager.getCurrentColorPalette();if(t.getIsC64Palette()){return e}var i=t.getColor(e);if(typeof i.laba=="undefined"){return e}var r=0;var a=false;for(var s=0;s<this.c64Colors.length;s++){var o=0;o+=Math.abs(i.laba.values[0]-this.c64Colors[s].laba.values[0]);o+=Math.abs(i.laba.values[1]-this.c64Colors[s].laba.values[1]);o+=Math.abs(i.laba.values[2]-this.c64Colors[s].laba.values[2]);if(a===false||o<a){a=o;r=s}}this.colorMap[e]=r;return this.colorMap[e]},getBackgroundColor:function(e){var t=this.editor.layers.getSelectedLayerObject();if(!t||t.getType()!="grid"){return this.editor.colorPaletteManager.noColor}var i=t.getBackgroundColor(e);if(i!=this.editor.colorPaletteManager.noColor){return i}var r=this.editor.layers.getSelectedLayerIndex();while(r>0){r--;var t=this.editor.layers.getLayerObjectFromIndex(r);if(t&&typeof t.getBackgroundColor!="undefined"){i=t.getBackgroundColor(e);if(i!=this.editor.colorPaletteManager.noColor){return i}}}return this.editor.colorPaletteManager.noColor},getBorderColor:function(){var e=this.editor.layers.getSelectedLayerObject();if(!e||e.getType()!="grid"){return this.editor.colorPaletteManager.noColor}var t=e.getBorderColor();if(t!=this.editor.colorPaletteManager.noColor){return t}var i=this.editor.layers.getSelectedLayerIndex();while(i>0){i--;var e=this.editor.layers.getLayerObjectFromIndex(i);if(e&&typeof e.getBorderColor!="undefined"){t=e.getBorderColor();if(t!=this.editor.colorPaletteManager.noColor){return t}}}return this.editor.colorPaletteManager.noColor}};var D64=function(){this.diskName="DEFAULT";this.diskId="LODIS";this.diskSize=174848;this.nrTracks=35;this.extraTracksBamOffset=192;this.sectorInterleave=10;this.useTrack18=false;this.track18Split=true;this.d64Image=null;this.files=[];this.sectorsPerTrack=[21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,19,19,19,19,19,19,19,18,18,18,18,18,18,17,17,17,17,17,17,17,17,17,17]};D64.prototype={addFile:function(e,t,i){e=e.toUpperCase();this.files.push({fileType:i,filename:e,fileData:t,sectorInterleave:this.sectorInterleave,track:0,sector:0,nrSectors:0})},sectorLocation:function(e,t){if(e<1||e>this.nrTracks){console.error("Illegal track: "+e);return false}if(t<0||t>=this.sectorsPerTrack[e-1]){console.error("Illegal sector: "+t)}var i=0;for(var r=0;r<e-1;r++){i+=this.sectorsPerTrack[r]}i+=t;return i},isSectorFree:function(e,t){var i=this.sectorLocation(18,0)*256;if(e>35){e-=35;i=this.sectorLocation(18,0)*256+this.extraTracksBamOffset}var r=i+e*4+1;var a=t/8&15;var s=7-(t&7);return(this.d64Image[r+a]&1<<s)!=0},markSector:function(e,t,i){var r=this.sectorLocation(18,0)*256;if(i!=this.isSectorFree(e,t)){if(e>35){e-=35;r=this.sectorLocation(18,0)*256+this.extraTracksBamOffset}if(i){this.d64Image[r+e*4+0]++}else{this.d64Image[r+e*4+0]--}var a=r+e*4+1;var s=Math.floor(t/8);var o=7-(t&7);if(i){this.d64Image[a+s]|=1<<o}else{this.d64Image[a+s]&=~(1<<o)}}},init:function(){},createD64:function(e){this.diskSize=174848;if(this.nrTracks>35){this.diskSize+=5*17*256}this.d64Image=new Uint8Array(this.diskSize);for(var t=0;t<this.diskSize;t++){this.d64Image[t]=0}var i=this.sectorLocation(18,0)*256;this.d64Image[i+0]=18;this.d64Image[i+1]=1;this.d64Image[i+2]=65;this.d64Image[i+3]=0;for(var r=1;r<this.nrTracks;r++){for(var a=0;a<this.sectorsPerTrack[r-1];a++){this.markSector(r,a,true)}}this.diskName=this.diskName.toUpperCase();for(var t=0;t<16;t++){if(t<this.diskName.length){this.d64Image[i+144+t]=this.diskName.charCodeAt(t)}else{this.d64Image[i+144+t]=160}}this.d64Image[i+160]=160;this.d64Image[i+161]=161;for(var t=0;t<2;t++){if(t<this.diskId.length){this.d64Image[i+162+t]=this.diskId.charCodeAt(t)}else{this.d64Image[i+162+t]=160}}this.d64Image[i+164]=160;this.d64Image[i+165]=50;this.d64Image[i+166]=65;this.d64Image[i+167]=160;this.d64Image[i+168]=160;this.d64Image[i+169]=160;this.d64Image[i+170]=160;this.markSector(18,0,false);var s=1;var o=0;var l=0;var n=s;var h=o;var d=this.sectorLocation(n,h)*256;for(var t=0;t<this.files.length;t++){var c=this.files[t].fileData.length;var f=this.files[t].fileData;var u=0;var p=c;while(p>0){var v=false;var g=0;while(!v){for(var a=o;a<o+this.sectorsPerTrack[s-1];a++){g=a%this.sectorsPerTrack[s-1];if(this.isSectorFree(s,g)){v=true;break}}if(!v){s++;o=0;if(!this.useTrack18){if(s==18){if(!this.track18Split){if(this.files[t].nrSectors>0){var m=this.files[t].track;var y=this.files[t].sector;while(m!=0){this.markSector(m,y,true);var b=this.sectorLocation(m,y)*256;m=this.d64Image[b+0];y=this.d64Image[b+1];for(var C=0;C<256;C++){this.d64Image[b+C]=0}}}p=c;u=0;this.files[t].nrSectors=0}s=19}}if(s==this.nrTracks+1){console.error("disk full!");return false}}}o=g;var b=this.sectorLocation(s,o)*256;if(p==c){this.files[t].track=s;this.files[t].sector=o;n=s;h=o;d=b}else{this.d64Image[d+0]=s;this.d64Image[d+1]=o}l=254;if(p<l){l=p}for(var C=0;C<l;C++){this.d64Image[b+2+C]=f[C+u]}p-=l;u+=l;n=s;h=o;d=b;this.markSector(s,o,false);o+=this.files[t].sectorInterleave;this.files[t].nrSectors++}this.d64Image[d+0]=0;this.d64Image[d+1]=l+1}var x=0;var S=this.files.length;o=1;var P=0;while(S>0){var w=this.sectorLocation(18,o)*256+P*32;this.markSector(18,o,false);if(P==0&&S>8){this.d64Image[w+0]=18;this.d64Image[w+1]=o+1}else{this.d64Image[w+0]=0;this.d64Image[w+1]=0}var I=130;switch(this.files[x].fileType){case"del":I=128;break;case"seq":I=129;case"prg":I=130;break;case"usr":I=131;break;case"rel":I=132;break}this.d64Image[w+2]=I;this.d64Image[w+3]=this.files[x].track;this.d64Image[w+4]=this.files[x].sector;for(var t=0;t<16;t++){if(t<this.files[x].filename.length){this.d64Image[w+5+t]=this.files[x].filename.charCodeAt(t)}else{this.d64Image[w+5+t]=160}}this.d64Image[w+30]=this.files[x].nrSectors&255;this.d64Image[w+31]=this.files[x].nrSectors>>8;S--;x++;P++;if(P==8){o++;P=0}}var k=0;var M=0;for(var r=1;r<=this.nrTracks;r++){for(var a=0;a<this.sectorsPerTrack[r-1];a++){if(this.isSectorFree(r,a)){if(r!=18){k++}else{M++}}else{}}}download(this.d64Image,e,"application/d64");var T=k+M}};var Export3dGif=function(){this.editor=null;this.canvas=null;this.context=null;this.borderWidth=4*8;this.borderHeight=4*8;this.scale=1;this.playMode="loop";this.previewCanvas=null;this.previewContext=null;this.previewCanvasScale=null;this.exportGifActive=false;this.playDirection=1;this.lastFrameTime=0;this.lastTickTime=0;this.playFrames=true;this.currentFrame=0;this.tick=0;this.startFrame=0;this.endFrame=0;this.exportGIFFormat="gif";this.recordingVideo=false;this.exportLayer="all";this.previewOffsetX=0;this.previewOffsetY=0;this.previewScale=1;this.mouseIsDown=false;this.fromFrame=0;this.toFrame=0;this.shaderTime=0;this.msPerTick=50;this.totalTicks=0;this.framesTickCount=0;this.frameTick=0;this.exportProgressDialog=null;this.showPrevFrameSave=false;this.renderer=null;this.rendererCanvas=null;this.exportWidth=false;this.exportHeight=false;this.camera=null;this.orbitControls=null;this.cameraTarget=null;this.cursorEnabledSave=false};Export3dGif.prototype={initExportProgress:function(){var e="<div>";e+="<h2>Export Progress</h2>";e+='<div id="export3dGifProgressText"></div>';e+="</div>";this.exportProgressDialog=UI.create("UI.Dialog",{id:"export3dGifProgressDialog",title:"Export Progress",width:280,height:120});this.exportProgressHTML=UI.create("UI.HTMLPanel",{html:e});this.exportProgressDialog.add(this.exportProgressHTML)},init:function(e){this.editor=e},resizePreview:function(){if(this.previewCanvas==null){this.previewCanvas=document.getElementById("export3dGifPreview");$("#export3dGifPreview").on("mouseenter",function(){UI.setCursor("can-drag")});$("#export3dGifPreview").on("mouseleave",function(){})}if(this.previewCanvas==null){return}var e=$("#export3dGifPreviewHolder");var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}this.previewCanvasScale=UI.devicePixelRatio;if(this.width!=this.previewCanvas.style.width||this.height!=this.previewCanvas.style.height){if(this.width!=0&&this.height!=0){this.previewCanvas.style.width=this.width+"px";this.previewCanvas.style.height=this.height+"px";this.previewCanvas.width=this.width*this.previewCanvasScale;this.previewCanvas.height=this.height*this.previewCanvasScale}}this.previewContext=this.previewCanvas.getContext("2d");this.previewContext.imageSmoothingEnabled=false;this.previewContext.webkitImageSmoothingEnabled=false;this.previewContext.mozImageSmoothingEnabled=false;this.previewContext.msImageSmoothingEnabled=false;this.previewContext.oImageSmoothingEnabled=false},initRenderer:function(){var e=640;var t=480;this.fov=30;if(this.renderer==null){this.rendererCanvas.width=e;this.rendererCanvas.height=t;this.renderer=new THREE.WebGLRenderer({canvas:this.rendererCanvas,antialias:true});this.renderer.setSize(e,t)}this.exportWidth=e;this.exportHeight=t;this.renderer.setSize(this.exportWidth,this.exportHeight);this.renderScale=this.editor.gridView3d.getScale();this.camera.left=-this.exportWidth/this.renderScale;this.camera.right=this.exportWidth/this.renderScale;this.camera.top=this.exportHeight/this.renderScale;this.camera.bottom=-this.exportHeight/this.renderScale;this.camera.aspect=this.exportWidth/this.exportHeight;this.camera.updateProjectionMatrix()},drawFrame:function(e){if(this.rendererCanvas==null){return}var t=true;if(typeof e!="undefined"){if(typeof e.redrawLayers){t=e.redrawLayers}}this.initRenderer();if(this.previewCanvas==null){this.resizePreview()}if(this.previewCanvas==null){return}this.previewContext.fillStyle="#000000";this.previewContext.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height);if(t){var i=this.editor.grid3d;i.setCurrentFrame(this.currentFrame);var r=i.getScene();var a=i.getXYGridVisible();var s=i.getXZGridVisible();i.setGridVisible(false);this.renderer.setClearColor(2236962);i.showAll();this.renderer.setClearColor(i.getBackgroundColorRGB());this.renderer.render(r,this.camera);i.setXYGridVisible(a);i.setXZGridVisible(s)}this.previewContext.save();this.previewContext.translate(Math.floor(this.previewCanvas.width/2),Math.floor(this.previewCanvas.height/2));this.previewContext.scale(this.previewScale*this.previewCanvasScale,this.previewScale*this.previewCanvasScale);this.previewContext.drawImage(this.rendererCanvas,this.previewOffsetX-this.exportWidth/2,this.previewOffsetY-this.exportHeight/2);this.previewContext.restore()},htmlComponentLoaded:function(){this.componentsLoaded++;if(this.componentsLoaded==3){this.splitPanel.setPanelVisible("east",true);this.splitPanel.resize();var e=1;this.rendererCanvas=document.getElementById("export3dGifRenderCanvas");this.setScale(e);this.initContent();this.initEvents()}},start:function(){var t=this;this.lastTickTime=getTimestamp();this.showPrevFrameSave=this.editor.frames.getShowPrevFrame();this.editor.frames.setShowPrevFrame(false);if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"export3dGifDialog",title:"Export GIF",width:734,height:626});this.splitPanel=UI.create("UI.SplitPanel",{id:"export3dGifSplitPanel"});this.uiComponent.add(this.splitPanel);this.uiComponent.on("resize",function(){t.resizePreview()});this.componentsLoaded=0;this.exportGIFFramesPanel=UI.create("UI.HTMLPanel");this.splitPanel.addEast(this.exportGIFFramesPanel,324);this.exportGIFFramesPanel.load("html/textMode/export3dAsGifFrames.html",function(){t.htmlComponentLoaded()});this.propertiesSplit=UI.create("UI.SplitPanel");this.splitPanel.add(this.propertiesSplit);this.htmlComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.add(this.htmlComponent);this.htmlComponent.load("html/textMode/export3dAsGif.html",function(){t.htmlComponentLoaded()});this.previewComponent=UI.create("UI.HTMLPanel");this.propertiesSplit.addNorth(this.previewComponent,330);this.previewComponent.load("html/textMode/export3dAsGifPreview.html",function(){t.htmlComponentLoaded()});this.previewComponent.on("resize",function(){t.resizePreview()});this.okButton=UI.create("UI.Button",{text:"Download",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.doExport()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){t.editor.grid3d.setCursorEnabled(t.cursorEnabledSave);t.cameraTarget.visible=false;t.editor.frames.setShowPrevFrame(t.showPrevFrameSave);t.exportGifActive=false});this.initExportProgress()}else{this.initContent()}UI.showDialog("export3dGifDialog");this.exportGifActive=true},saveToGDrive:function(){g_app.gdrive.handleAuthClick()},initContent:function(){var e=this;$("#export3dGIFAs").val(g_app.fileManager.filename);var t=this.editor.grid3d.getFrameCount();this.cursorEnabledSave=this.editor.grid3d.getCursorEnabled();this.editor.grid3d.setCursorEnabled(false);$("#export3dGIFToFrame").val(t);$("#export3dGIFFromFrame").val(1);$("#export3dGIFFromFrame").attr("max",t);$("#export3dGIFToFrame").attr("max",t);this.playMode=$("#exportGIFLoopType").val();this.fov=50;if(this.camera==null){this.camera=new THREE.PerspectiveCamera(this.fov,640/480,.1,1e3);this.orbitControls=new THREE.OrbitControls(this.camera,document.getElementById("export3dGifRenderCanvas"));var i=new THREE.BoxGeometry(1,1,1);var r=new THREE.MeshBasicMaterial({color:16777215});this.cameraTarget=new THREE.Mesh(i,r);this.editor.grid3d.scene.add(this.cameraTarget)}var a=this.editor.gridView3d.getCamera();this.camera.copy(a,true);this.camera.updateProjectionMatrix();$("#export3dCameraX").val(this.camera.position.x);$("#export3dCameraY").val(this.camera.position.y);$("#export3dCameraZ").val(this.camera.position.z);$("#export3dRotationX").val(this.camera.rotation.x*180/Math.PI);$("#export3dRotationY").val(this.camera.rotation.y*180/Math.PI);$("#export3dRotationZ").val(this.camera.rotation.z*180/Math.PI);$("#export3dCameraFOV").val(this.camera.fov);this.resizePreview();this.setFrameParameters();this.setCameraType()},initEvents:function(){var i=this;$("#export3dGifPreview").on("mousedown",function(e){i.previewMouseDown(e)});$("#export3dGifPreview").on("wheel",function(e){i.previewMouseWheel(e.originalEvent)});$("#export3dGIFLoopType").on("change",function(e){i.setFrameParameters()});$("#export3dGIFToFrame").on("change",function(e){i.setFrameParameters()});$("#export3dGIFFromFrame").on("change",function(e){i.setFrameParameters()});$("#export3dGIFRepeat").on("change",function(e){i.setFrameParameters()});$("#export3dGIFSpeed").on("change",function(e){if($(this).val()=="custom"){$("#custom3dSpeedSection").show()}else{$("#custom3dSpeedSection").hide()}i.setFrameParameters()});$("#export3dGIFMSPerTick").on("change",function(){i.setFrameParameters()});$("#export3dGifPreviewScale").on("input",function(e){var t=$(this).val();i.setPreviewScale(t/100)});$("#export3dGifPreviewScaleText").on("keyup",function(e){var t=parseInt($(this).val());if(isNaN(t)){return}i.setPreviewScale(t/100)});$("#export3dGifPreviewScaleReset").on("click",function(){i.setPreviewScale(1)});$(".export3dCameraPosition").on("change",function(){i.setCameraPosition()});$(".export3dCameraRotation").on("change",function(){i.setCameraRotation()});$("#export3dCameraFOV").on("change",function(){i.setCameraFOV()});$(".export3dCameraTarget").on("change",function(){i.setCameraTarget();i.drawFrame({drawLayers:true})});$("#export3dAzimuthAngle").on("change",function(){i.setCameraTarget();i.drawFrame({drawLayers:true})});$("#export3dAltitudeAngle").on("change",function(){i.setCameraTarget();i.drawFrame({drawLayers:true})});$("#export3dCameraDistance").on("change",function(){i.setCameraTarget();i.drawFrame({drawLayers:true})});$("input[name=export3dGIFCameraType]").on("click",function(){i.setCameraType()});$("#export3dCameraAutorotate").on("click",function(){i.setCameraType()})},setCameraType:function(){this.cameraType=$("input[name=export3dGIFCameraType]:checked").val();if(this.cameraType=="position"){this.setCameraPosition();this.setCameraRotation();this.cameraTarget.visible=false;$(".export3dCameraPositionControls").show();$(".export3dCameraOrbitControls").hide()}if(this.cameraType=="orbit"){this.setCameraTarget();this.cameraTarget.visible=true;this.cameraAutorotate=$("#export3dCameraAutorotate").is(":checked");$(".export3dCameraPositionControls").hide();$(".export3dCameraOrbitControls").show()}},doAutorotate:function(e){var t=parseInt($("#export3dAzimuthAngle").val(),10);if(typeof e!=="undefined"){t=(t+e)%360}else{t=(t+1)%360}$("#export3dAzimuthAngle").val(t);this.setCameraTarget()},setCameraTarget:function(){var e=parseInt($("#export3dCameraTargetX").val(),10);var t=parseInt($("#export3dCameraTargetY").val(),10);var i=parseInt($("#export3dCameraTargetZ").val(),10);var r=parseInt($("#export3dAzimuthAngle").val(),10)*Math.PI/180;var a=parseInt($("#export3dAltitudeAngle").val(),10)*Math.PI/180;var s=parseInt($("#export3dCameraDistance").val(),10);if(isNaN(e)||isNaN(t)||isNaN(i)||isNaN(r)||isNaN(a)||isNaN(s)){return}this.camera.position.x=e;this.camera.position.y=t;this.camera.position.z=i;this.camera.position.y+=s*Math.sin(a);this.camera.position.z+=s*Math.cos(a);var o=Math.sqrt((this.camera.position.x-e)*(this.camera.position.x-e)+(this.camera.position.z-i)*(this.camera.position.z-i));this.camera.position.x=e+o*Math.cos(r);this.camera.position.z=i+o*Math.sin(r);this.cameraTarget.position.x=e;this.cameraTarget.position.y=t;this.cameraTarget.position.z=i;this.camera.lookAt(e,t,i)},setCameraPosition:function(){var e=parseInt($("#export3dCameraX").val(),10);var t=parseInt($("#export3dCameraY").val(),10);var i=parseInt($("#export3dCameraZ").val(),10);if(isNaN(e)||isNaN(t)||isNaN(i)){return}this.camera.position.x=e;this.camera.position.y=t;this.camera.position.z=i;this.drawFrame({redrawLayers:true})},setCameraRotation:function(){var e=parseInt($("#export3dRotationX").val(),10);var t=parseInt($("#export3dRotationY").val(),10);var i=parseInt($("#export3dRotationZ").val(),10);if(isNaN(e)||isNaN(t)||isNaN(i)){return}this.camera.rotation.x=e*Math.PI/180;this.camera.rotation.y=t*Math.PI/180;this.camera.rotation.z=i*Math.PI/180;this.drawFrame({redrawLayers:true})},setCameraFOV:function(){var e=parseInt($("#export3dCameraFOV").val(),10);if(isNaN(e)){return}this.camera.fov=e;this.camera.updateProjectionMatrix()},setFrameParameters:function(){this.playMode=$("#export3dGIFLoopType").val();var e=this.editor.grid3d.getFrameCount();var t=parseInt($("#export3dGIFFromFrame").val(),10);if(!isNaN(t)&&t>=1&&t<=e){this.fromFrame=t}var i=parseInt($("#export3dGIFToFrame").val(),10);if(!isNaN(i)&&i>=1&&i<=e){this.toFrame=i}this.repeat=1;this.speed=$("#export3dGIFSpeed").val();this.msPerTick=50;if(this.speed=="custom"){this.msPerTick=parseInt($("#export3dGIFMSPerTick").val(),10)}else{this.msPerTick=FRAMERATE/parseInt(this.speed,10)}},mouseDown:function(e){},setPreviewScale:function(e){this.previewScale=e;this.drawFrame({redrawLayers:false});var t=Math.floor(e*100);$("#export3dGifPreviewScale").val(t);$("#export3dGifPreviewScaleText").val(t)},previewMouseWheel:function(e){e.stopPropagation();e.preventDefault();var t=normalizeWheel(e);var i=this.previewScale-t.spinY/8;if(i>=.1){this.setPreviewScale(i)}},previewMouseDown:function(e){var t=e.offsetX;var i=e.offsetY;this.mouseDownAtX=e.clientX;this.mouseDownAtY=e.clientY;this.currentOffsetX=this.previewOffsetX;this.currentOffsetY=this.previewOffsetY;UI.setCursor("drag");this.mouseIsDown=true;UI.captureMouse(this,{cursor:"url(cursors/closedhand.png) 2 14, pointer"})},mouseMove:function(e){if(this.mouseIsDown){var t=e.clientX;var i=e.clientY;var r=t-this.mouseDownAtX;var a=i-this.mouseDownAtY;this.previewOffsetX=this.currentOffsetX+r/this.previewScale;this.previewOffsetY=this.currentOffsetY+a/this.previewScale;this.drawFrame({redrawLayers:false,applyEffects:false})}},mouseUp:function(e){this.mouseIsDown=false},setScale:function(e){var t=this.scale;this.scale=e;this.previewOffsetY=Math.floor(this.previewOffsetY*this.scale/t);this.previewOffsetX=Math.floor(this.previewOffsetX*this.scale/t)},calculateGifInfo:function(){},doExport:function(){var e=$("#export3dGIFAs").val();if(this.fromFrame>this.toFrame){alert("From must be greater than to");return}var t=this.scale;$("#export3dGifProgressText").html("");UI.showDialog("export3dGifProgressDialog");this.exportGIFFormat="gif";if(this.exportGIFFormat=="gif"){this.exportGif(e,t,this.speed,this.fromFrame,this.toFrame)}},exportGif:function(t,e,i,r,a){this.playMode="once";var s=this.cameraAutorotate;this.cameraTarget.visible=false;var o=50;if(i=="custom"){o=parseInt($("#expor3dtGIFMSPerTick").val(),10)}else{o=FRAMERATE/i}this.scale=e;var l=[];var n=this.editor.tileSetManager.getCurrentTileSet();var h=n.getAnimatedCharacterTicks();var d=false;var c=new GIF({workers:4,workerScript:"lib/gif/gif.worker.js",quality:10,width:this.rendererCanvas.width,height:this.rendererCanvas.height,background:"#000000",repeat:0});var f=30;if(true){var u=0;for(var p=r-1;p<a;p++){u+=this.editor.grid3d.getFrameDuration(p)}if(this.playMode=="pingpong"&&a!=r){u*=2}console.log("ticks = "+u);l.push(u);for(var p=0;p<h.length;p++){l.push(h[p]);if(u<h[p]){u=h[p]}}function v(e,t){return!t?e:v(t,e%t)}function g(e,t){return e*t/v(e,t)}var m=l[0];l.forEach(function(e){m=g(m,e)});u=m;var y=0;var b=r-1;var C=0;var x=0;var f=9;var S=1e3/o;var P=1;if(S>f){P=Math.ceil(S/f)}this.shaderTime=0;var w=false;n.update(y);this.currentFrame=b;this.drawFrame();var I=2;if(s){u=360/I}var k=1;for(var y=1;y<u;y++){C++;var M=n.update(y);var T=this.editor.grid3d.getFrameDuration(b)<=C;if(T){b+=k;C=0;if(b==a){if(this.playMode=="pingpong"&&a!=r){b--;k=-k}else{b=r-1}}}if(M||T||w||s){var D=(y-x)*o;if(d){c.addFrame(this.rendererCanvas,{copy:true,delay:D/2});c.addFrame(this.rendererCanvas,{copy:true,delay:D/2})}else{c.addFrame(this.rendererCanvas,{copy:true,delay:D})}x=y;this.currentFrame=b;this.drawFrame()}if(s){console.log("do auto rotate!");this.doAutorotate(I)}}var D=(y-x)*o;if(d){c.addFrame(this.rendererCanvas,{copy:true,delay:D/2})}else{c.addFrame(this.rendererCanvas,{copy:true,delay:D})}}var E=this;c.on("finished",function(e){if(t.indexOf(".gif")==-1){t+=".gif"}console.log("DOWNLOAD!!!!!");download(e,t,"application/gif");E.exportGifFinished()});c.on("progress",function(e){var t=e*100;var i=t.toFixed(2)+"%";$("#export3dGifProgressText").html(i)});c.render()},exportGifFinished:function(){UI.closeDialog();UI.closeDialog()},updateFrame:function(){this.startFrame=this.fromFrame-1;this.endFrame=this.toFrame;var e=getTimestamp();while(e-this.lastTickTime>=this.msPerTick){this.tick++;this.frameTick++;this.lastTickTime=this.lastTickTime+this.msPerTick;var t=this.editor.tileSetManager.getCurrentTileSet();t.update(this.tick);if(TextMode.tick){TextMode.tick(this.tick)}}if(this.playFrames){if(this.currentFrame<0||this.currentFrame>=this.editor.grid3d.getFrameCount()){this.currentFrame=0}var i=this.editor.grid3d.getFrameDuration(this.currentFrame);if(this.frameTick>=i){this.frameTick=0;this.framesTickCount+=i;var r=this.currentFrame;r+=this.playDirection;if(this.playMode=="pingpong"){if(r===this.startFrame){this.playDirection=1}if(r===this.endFrame-1){this.playDirection=-1}if(r>=this.endFrame){r=this.startFrame}else if(r<this.startFrame){r=this.startFrame}}else if(this.playMode=="once"){if(r>=this.endFrame){r=this.startFrame}}else{if(r>=this.endFrame){r=this.startFrame}}this.currentFrame=r;this.lastFrameTime=e}}},update:function(){if(!this.exportGifActive){return false}if(this.cameraAutorotate){this.doAutorotate()}this.updateFrame();this.drawFrame();return true}};var ExportVox=function(){this.editor=null;this.data=null;this.voxels=[];this.palette=[];this.width=0;this.height=0;this.depth=0;this.uiComponent=null};ExportVox.prototype={init:function(e){this.editor=e;for(var t=256;--t>-1;){this.palette.push(4278190080|t|t<<8|t<<16)}this.voxels=[]},start:function(){var i=this;if(this.uiComponent==null){var e="";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="exportVoxFilename">Filename:</label>';e+='  <input type="text" class="formControl submitOnEnter" id="exportVoxFilename" size="20"/>';e+="</div>";var t=200;var r=200;this.uiComponent=UI.create("UI.Dialog",{id:"exportVoxDialog",title:"Export VOX",width:t,height:r});this.exportVoxHTML=UI.create("UI.HTMLPanel",{html:e});this.uiComponent.add(this.exportVoxHTML);var a=UI.create("UI.Button",{text:"OK",color:"primary"});a.on("click",function(e){var t=$("#exportVoxFilename").val();i.doExport({filename:t});UI.closeDialog()});var s=UI.create("UI.Button",{text:"Cancel",color:"secondary"});s.on("click",function(e){UI.closeDialog()});this.uiComponent.addButton(a);this.uiComponent.addButton(s)}UI.showDialog("exportVoxDialog");this.initContent()},initContent:function(){},doExport:function(e){var t=e.filename;console.log("do export to "+t)},setVoxel:function(e,t,i,r){r|=0;e|=0;t|=0;i|=0;if(r>=0&&r<256&&e>=0&&t>=0&&i>=0&&e<this.width&&i<this.height&&t<this.depth){var a=e+"_"+t+"_"+i;if(r>0){if(!this.voxels[a])this.vcount++;this.voxels[a]=r}else{if(this.voxels[a])this.vcount--;delete this.voxels[a]}}},writeString:function(e){for(var t=0,i=e.length;t<i;++t){this.data.push(e.charCodeAt(t))}},writeUInt32:function(e){this.data.push(e&255,e>>>8&255,e>>>16&255,e>>>24&255)},writeRGBA:function(e){this.data.push(e>>>16&255,e>>>8&255,e&255,e>>>24&255)},writeVoxel:function(e){var t=e.split("_");this.data.push(t[0],t[1],t[2],this.voxels[e])},doExport:function(e){var t="Untitled";if(typeof e!="undefined"){if(typeof e.filename!="undefined"){t=e.filename}}this.data=[];this.voxels=[];this.vcount=0;var i=this.editor.grid3d;var r=i.getCurrentLayer();var a=r.getColorPalette();var s=r.getTileSet();var o=a.getColorCount();for(var l=0;l<o;l++){var n=a.getHex(l);this.palette[l]=a.getHex(l)}var h=s.getTileWidth();var d=s.getTileHeight();var c=s.getTileDepth();var f=r.getGridWidth()*h;var u=r.getGridDepth()*c;var p=r.getGridHeight()*d;var v=126;var g=Math.floor(v/h)*h;var m=Math.floor(v/c)*c;var y=Math.floor(v/d)*d;this.width=f;this.height=p;this.depth=u;if(this.width>g){this.width=g;f=g}if(this.height>y){this.height=y;p=y}if(this.depth>m){this.depth=m;u=u}var b=0;var C=f/h;var x=p/d;var S=u/c;var P=this.editor.tileSetManager.noTile;var w=0;for(var I=0;I<S;I++){for(var M=0;M<x;M++){for(var T=0;T<C;T++){var D=r.getCell(T,M,I);var E=D.t;var $=D.fc;if(E!=P){for(var _=0;_<d;_++){for(var l=0;l<h;l++){var B=l;var R=_;if(s.getPixel(E,B,R)){for(k=0;k<c;k++){this.setVoxel(T*h+l,I*c+k,M*d+_,$+1)}}else{}}}}}}}var A=this.vcount;this.writeString("VOX ");this.writeUInt32(150);this.writeString("MAIN");this.writeUInt32(0);this.writeUInt32(A*4+1076);this.writeString("SIZE");this.writeUInt32(12);this.writeUInt32(0);this.writeUInt32(f);this.writeUInt32(u);this.writeUInt32(p);this.writeString("XYZI");this.writeUInt32(4+A*4);this.writeUInt32(0);this.writeUInt32(A);for(var F in this.voxels){this.writeVoxel(F)}this.writeString("RGBA");this.writeUInt32(1024);this.writeUInt32(0);for(var l=0;l<256;l++){this.writeRGBA(this.palette[l])}var L=new Uint8Array(this.data.length);for(var l=0;l<this.data.length;l++){L[l]=this.data[l]}if(t.indexOf(".vox")==-1){t+=".vox"}download(L,t,"application/vox")}};var ExportObj=function(){this.editor=null;this.width=0;this.height=0;this.depth=0;this.uiComponent=null};ExportObj.prototype={init:function(e){this.editor=e},start:function(){var i=this;if(this.uiComponent==null){var e="";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="exportObjFilename">Filename:</label>';e+='  <input type="text" class="formControl submitOnEnter" id="exportObjFilename" size="20"/>';e+="</div>";var t=200;var r=200;this.uiComponent=UI.create("UI.Dialog",{id:"exportObjDialog",title:"Export OBJ",width:t,height:r});this.exportOBJHTML=UI.create("UI.HTMLPanel",{html:e});this.uiComponent.add(this.exportOBJHTML);var a=UI.create("UI.Button",{text:"OK",color:"primary"});a.on("click",function(e){var t=$("#exportObjFilename").val();i.doExport({filename:t});UI.closeDialog()});var s=UI.create("UI.Button",{text:"Cancel",color:"secondary"});s.on("click",function(e){UI.closeDialog()});this.uiComponent.addButton(a);this.uiComponent.addButton(s)}UI.showDialog("exportObjDialog");this.initContent()},initContent:function(){},doExport:function(e){var t=0;var i=0;var r="Untitled";if(typeof e!="undefined"){if(typeof e.filename!="undefined"){r=e.filename}}var a=this.editor.grid3d;var s=a.getCurrentLayer();var o=s.getColorPalette();var l=s.getTileSet();var n=o.getColorCount();var h="";for(var d=0;d<n;d++){var c=o.getRGBA(d);h+="newmtl color"+d+"\n";h+="Kd "+c[0]+" "+c[1]+" "+c[2]+"\n"}var f=r+".mtl";var u=new THREE.OBJExporter;var p=new JSZip;p.file(f,h);for(var v=t;v<=i;v++){var g="";g+="mtllib petscii.mtl"+"\n";g+=u.parse(s.getHolder(v));var m=r+".obj";if(t!=i){var y=v;m=r+"-"+y+".obj"}p.file(m,g)}p.generateAsync({type:"blob"}).then(function(e){download(e,r+".zip","application/zip")})}};var TextMode={};TextMode.update=null;TextMode.tick=null;TextMode.getCurrentColorPalette=function(){var e=g_app.textModeEditor.colorPaletteManager.getCurrentColorPalette();var t=new ColorPaletteAPI;t.init(e);return t};TextMode.getCurrentFrame=function(){var e=new FrameAPI;e.init(g_app.textModeEditor,g_app.textModeEditor.frames.currentFrame);return e};TextMode.getFrameCount=function(){};TextMode.on=function(e,t){switch(e){case"update":TextMode.update=t;break;case"tick":TextMode.tick=t;break}};var ScreenAPI={};ScreenAPI.getWidth=function(){var e=g_app.textModeEditor;return e.frames.getWidth()};ScreenAPI.getHeight=function(){var e=g_app.textModeEditor;return e.frames.getHeight()};ScreenAPI.clear=function(e){var t=g_app.textModeEditor;var i={};var r=t.frames.getCurrentFrame();if(typeof e!="undefined"){if(typeof e.frame!="undefined"){r=parseInt(e.frame,10);if(isNaN(r)){console.log("frame is not a number");return}if(r>=t.frames.getFrameCount()){console.log("frame too big"+r);return}}}for(var a=0;a<t.grid.depth;a++){for(var s=0;s<t.grid.height;s++){for(var o=0;o<t.grid.width;o++){if(t.grid.gridData[a][s][o].character!=32){t.grid.setCell({t:t.tileSetManager.blankCharacter,x:o,y:s,z:a})}}}}};ScreenAPI.setCell=function(e){var t=g_app.textModeEditor;var i=t.colorPaletteManager.getCurrentColorPalette();var r=t.tileSetManager.getCurrentTileSet();var a=t.grid;var s={};if(typeof e.x!="undefined"){s.x=parseInt(e.x,10);if(isNaN(s.x)){console.log("x is not a number "+e.x);return}}else{console.log("x not set!");return}if(typeof e.y!="undefined"){s.y=parseInt(a.height-1-e.y,10);if(isNaN(s.x)){console.log("y is not a number "+e.y);return}}else{console.log("y not set!")}if(typeof e.frame!="undefined"){s.frame=parseInt(e.frame,10);if(isNaN(s.frame)){console.log("frame is not a number");return}if(s.frame>=t.frames.getFrameCount()){console.log("frame count too big"+e.frame);return}}if(typeof e.t!="undefined"){s.c=e.t%r.getTileCount();if(isNaN(s.c)){console.log("t is not a number"+e.t)}}if(typeof e.fc!="undefined"){s.fc=e.fc%i.getColorCount()}if(typeof e.bc!="undefined"){s.bc=e.bc%i.getColorCount()}s.z=g_app.textModeEditor.grid.getXYGridPosition();if(typeof e.layer!="undefined"){s.z=t.layers.getLayerZFromLabel(e.layer);if(s.z===false){console.log("can't find layer '"+e.layer+"'");return}}g_app.textModeEditor.frames.setCell(s)};ScreenAPI.getCell=function(e){var t=g_app.textModeEditor;var i=t.colorPaletteManager.getCurrentColorPalette();var r=t.tileSetManager.getCurrentTileSet();var a=t.grid;var s={};if(typeof e.x!="undefined"){s.x=parseInt(e.x,10);if(isNaN(s.x)){console.log("x is not a number "+e.x);return}}else{console.log("x not set!");return}if(typeof e.y!="undefined"){s.y=parseInt(a.height-1-e.y,10);if(isNaN(s.x)){console.log("y is not a number "+e.y);return}}else{console.log("y not set!")}if(typeof e.frame!="undefined"){s.frame=parseInt(e.frame,10);if(isNaN(s.frame)){console.log("frame is not a number");return}if(s.frame>=t.frames.getFrameCount()){console.log("frame count too big"+e.frame);return}}s.z=g_app.textModeEditor.grid.getXYGridPosition();if(typeof e.layer!="undefined"){s.z=t.layers.getLayerZFromLabel(e.layer);if(s.z===false){console.log("can't find layer '"+e.layer+"'");return}}var o=t.frames.getCell(s);if(o===false){return}return{t:o.c,fc:o.fc,bc:o.bc}};FrameAPI=function(){this.frameID=0};FrameAPI.prototype={init:function(e,t){this.editor=e;this.frameID=t},clear:function(){this.showFrame();for(var e=0;e<this.editor.grid.depth;e++){for(var t=0;t<this.editor.grid.height;t++){for(var i=0;i<this.editor.grid.width;i++){if(this.editor.grid.gridData[e][t][i].character!=32){this.editor.grid.setCell({c:this.editor.tileSetManager.blankCharacter,x:i,y:t,z:e})}}}}},getCell:function(e,t,i){var r=i;if(typeof i=="undefined"){r=this.editor.grid.getXYGridPosition()}e=parseInt(e,10);t=parseInt(t,10);i=parseInt(r,10);if(!this.checkCoordinates(e,t,i)){return}var a=this.editor.frames.frames[this.frameID];return{ch:a.data[i][t][e].character,fg:a.data[i][t][e].color,bg:a.data[i][t][e].bgColor}},getWidth:function(){return this.editor.frames.width},getHeight:function(){return this.editor.frames.height},showFrame:function(){if(this.editor.frames.currentFrame!=this.frameID){this.editor.frames.setCurrentFrame(this.frameID)}},setBackgroundColor:function(e){this.showFrame();this.editor.tools.setBackgroundColor(e)},setDuration:function(e){if(this.editor.frames.currentFrame==this.frameID){$("#frameDuration").val(e)}this.editor.frames.frames[this.frameID].duration=e},checkCoordinates:function(e,t,i){if(isNaN(e)){console.log("invalid x");return false}if(isNaN(t)){console.log("invalid y");return false}if(isNaN(i)){console.log("invalid z");return false}if(e<0){console.log("x too small");return false}if(e>=this.editor.grid.width){console.log("x too big");return false}if(t<0){console.log("y too small");return false}if(t>=this.editor.grid.height){console.log("y too big");return false}if(i<0){console.log("z too small");return false}if(i>=this.editor.grid.depth){console.log("z too big");return false}return true},setCell:function(e){if(typeof e=="undefined"){console.log("no arguments");return}var t=0;var i=0;var r=this.editor.grid.getXYGridPosition();var a=0;var s=0;var o=false;if(typeof e.x!="undefined"){t=parseInt(e.x,10)}if(typeof e.y!="undefined"){i=parseInt(e.y,10)}if(typeof e.z!="undefined"){r=parseInt(e.z,10)}if(typeof e.ch!="undefined"){a=parseInt(e.ch,10)}if(typeof e.fg!="undefined"){s=parseInt(e.fg,10)}if(typeof e.bg!="undefined"){o=parseInt(e.bg,10)}if(this.editor.frames.currentFrame!=this.frameID){this.editor.frames.setCurrentFrame(this.frameID)}t=parseInt(t,10);i=parseInt(i,10);r=parseInt(r,10);if(!this.checkCoordinates(t,i,r)){return}this.editor.grid.setCell({c:a,x:t,y:i,z:r,fc:s,bc:o})}};var GraphicAPI={};GraphicAPI.initAPI=function(i,e){var t=i.createObjectProto(i.OBJECT_PROTO);i.setProperty(e,"GraphicAPI",t);r=function(){var e=GraphicAPI.getCurrentLayerDetails();return i.nativeToPseudo(e)};i.setProperty(t,"getCurrentLayerDetails",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var r=function(e){var t=GraphicAPI.getFrameCount(i.pseudoToNative(e));return i.nativeToPseudo(t)};i.setProperty(t,"getFrameCount",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var r=function(e){GraphicAPI.setFrameDuration(i.pseudoToNative(e))};i.setProperty(t,"setFrameDuration",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR);i.setProperty(t,"getGridWidth",i.createNativeFunction(GraphicAPI["getGridWidth"],false),Interpreter.NONENUMERABLE_DESCRIPTOR);i.setProperty(t,"getGridHeight",i.createNativeFunction(GraphicAPI["getGridHeight"],false),Interpreter.NONENUMERABLE_DESCRIPTOR);var r=function(e){GraphicAPI.setCell(i.pseudoToNative(e))};i.setProperty(t,"setCell",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var r=function(e){var t=GraphicAPI.getCell(i.pseudoToNative(e));return i.nativeToPseudo(t)};i.setProperty(t,"getCell",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var r=function(e){var t=GraphicAPI.getFrameData(i.pseudoToNative(e));return i.nativeToPseudo(t)};i.setProperty(t,"getFrameData",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var r=function(e){GraphicAPI.setTilePixel(i.pseudoToNative(e))};i.setProperty(t,"setTilePixel",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var r=function(e){var t=GraphicAPI.getPixel(i.pseudoToNative(e));return i.nativeToPseudo(t)};i.setProperty(t,"getTilePixel",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var r=function(e){GraphicAPI.setLayerPixel(i.pseudoToNative(e))};i.setProperty(t,"setLayerPixel",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var r=function(e){var t=GraphicAPI.getLayerPixel(i.pseudoToNative(e));return i.nativeToPseudo(t)};i.setProperty(t,"getLayerPixel",i.createNativeFunction(r,false),Interpreter.NONENUMERABLE_DESCRIPTOR)};GraphicAPI.getPreScript=function(){var e="";e+="var Layer = function() {}\n";e+="Layer.prototype = {";e+="  init: function(path, layer) {";e+="    this.path = path;";e+="    this.layer = layer;";e+="  },";e+="  setCell: function(args) {";e+="    args.path = this.path;";e+="    args.layer = this.layer;";e+="    GraphicAPI.setCell(args);";e+="  },";e+="  getCell: function(args) {";e+="    args.path = this.path;";e+="    args.layer = this.layer;";e+="    return GraphicAPI.getCell(args);";e+="  },";e+="  getFrameData: function(args) {";e+="    var frameArgs = {};";e+='    if(typeof args !== "undefined" && typeof args.frame !== "undefined") {';e+="      frameArgs.frame = args.frame;";e+="    }";e+="    frameArgs.path = this.path;";e+="    frameArgs.layer = this.layer;";e+="    return GraphicAPI.getFrameData(frameArgs);";e+="  },";e+="  setPixel: function(args) {";e+="    args.path = this.path;";e+="    args.layer = this.layer;";e+="    GraphicAPI.setLayerPixel(args);";e+="  },";e+="  getPixel: function(args) {";e+="    args.path = this.path;";e+="    args.layer = this.layer;";e+="    return GraphicAPI.getLayerPixel(args);";e+="  }";e+="};";e+="var Tileset = function() {}\n";e+="Tileset.prototype = {";e+="  init: function(path) {";e+="    this.path = path;";e+="  },";e+="  setPixel: function(args) {";e+="    args.path = this.path;";e+="    GraphicAPI.setTilePixel(args);";e+="  },";e+="  getPixel: function(args) {";e+="    args.path = this.path;";e+="    return GraphicAPI.getTilePixel(args);";e+="  }";e+="};";e+='var Graphic = function(args) { this.path = ""; }\n';e+="";e+="Graphic.prototype = {";e+=" init: function(path) { this.path = path; },";e+=" getPath: function() { return this.path; },";e+=" getFrameCount: function() {";e+="   return GraphicAPI.getFrameCount({ path: this.path });";e+=" },";e+=" setFrameDuration: function(args) {";e+="   args.path = this.path;";e+="   return GraphicAPI.setFrameDuration(args);";e+=" },";e+=" getPath: function() { return this.path; },";e+="};";e+="GraphicAPI.getGraphic = function(path) {";e+=" let graphic = new Graphic();";e+=" graphic.init({ path: path });";e+=" return graphic;";e+="};";e+="GraphicAPI.getLayer = function(args) {";e+=" let layer = new Layer();";e+=" layer.init(args.path, args.layer);";e+=" return layer";e+="};";e+="GraphicAPI.getTileset = function(args) {";e+=" let tileset = new Tileset();";e+=" tileset.init(args.path);";e+=" return tileset";e+="};";e=e.replace(";",";\n");return e};GraphicAPI.getCurrentLayerDetails=function(){var e=g_app.textModeEditor;var t=e.doc.name;var i="/screens/"+t;var r=e.layers.getSelectedLayerLabel();return{path:i,layer:r}};GraphicAPI.getFrameCount=function(e){var t=g_app.textModeEditor;return t.graphic.getFrameCount()};GraphicAPI.setFrameDuration=function(e){var t="";var i=e.frame;var r=e.duration;i=i-1;var a=g_app.textModeEditor;a.graphic.setFrameDuration(r,i);a.frames.updateFrameDuration()};GraphicAPI.getWidth=function(){var e=g_app.textModeEditor;return e.graphic.getWidth()};GraphicAPI.getGridWidth=function(){var e=g_app.textModeEditor;return e.graphic.getGridWidth()};GraphicAPI.getGridHeight=function(){var e=g_app.textModeEditor;return e.graphic.getGridHeight()};GraphicAPI.getLayer=function(e){var t=g_app.textModeEditor;var i="/screens/Untitled";if(typeof e.path!="undefined"){i=e.path}var r=null;var a="Layer 0";var s=g_app.doc;var o=s.getDocRecord(i);if(!o){return false}var l=o.data.layers;var n=false;var r=false;var h=false;for(var d=0;d<l.length;d++){if(l[d].label==a){n=d;r=l[d];return r}}return false};GraphicAPI.getFrame=function(e){var t=g_app.textModeEditor;var i="/screens/Untitled";if(typeof e.path!="undefined"){i=e.path}var r=0;var a=null;var s="Layer 0";if(a===null){a=t.layers.getSelectedLayerObject();if(a.getType()!="grid"){return}}var o=g_app.doc;var l=o.getDocRecord(i);if(!l){return false}var n=l.data.layers;var h=false;var a=false;var d=false;for(var c=0;c<n.length;c++){if(n[c].label==s){h=c;a=n[c];d=a.frames[r];break}}return d};GraphicAPI.getFrameData=function(e){var t=GraphicAPI.getLayer(e);if(t==false){return[]}var i=0;var r=t.frames[i];var a=r.data;var s=a.length;var o=a[0].length;var l=[];var n=t.blockMode;for(var h=0;h<s;h++){var d=[];for(var c=0;c<o;c++){var f={};f.t=a[h][c].t;f.fc=a[h][c].fc;f.bc=a[h][c].bc;if(n){f.b=a[h][c].b}d.push(f)}l.push(d)}return l};GraphicAPI.getCell=function(e){var t=g_app.textModeEditor;var i=GraphicAPI.getFrame(e);if(i===false){return false}if(typeof e.y!="undefined"){}if(i===false){return false}if(e.y>=i.data.length||e.x>=i.data[e.y].length){return false}return i.data[e.y][e.x]};GraphicAPI.setCell=function(e){var t=g_app.textModeEditor;var i=GraphicAPI.getFrame(e);if(i===false){return false}if(typeof e.y!="undefined"){}if(i===false){return false}if(e.y>=i.data.length||e.x>=i.data[e.y].length){return false}var r=i.data[e.y][e.x];r.t=e.t;r.fc=e.fc};GraphicAPI.setTilePixel=function(e){var t=e.path;var i=g_app.doc;var r=i.getDocRecord(t);var a=r.data.tileData;var s=r.data.width;var o=r.data.height;var l=a[e.t];var n=e.y*s+e.x;l.data[0][n]=e.p;this.alteredTiles.push(e.t)};GraphicAPI.getTilePixel=function(e){var t=e.path;var i=g_app.doc;var r=i.getDocRecord(t);var a=r.data.tileData;var s=r.data.width;var o=a[e.t];var l=e.y*s+e.x;return o.data[0][l]};GraphicAPI.setLayerPixel=function(e){var t=g_app.doc;var i=GraphicAPI.getLayer(e);if(i===false){return}var r=0;var a=i.cellHeight;var s=i.cellWidth;var o=i.tileSetId;var l=e.x%s;var n=e.y%a;var h=Math.floor(e.x/s);var d=Math.floor(e.y/a);var c=i.frames[r];if(c===false){return false}if(d>=c.data.length||h>=c.data[d].length){return false}var f=c.data[d][h];console.log(f);var u=t.getDocRecordById(o,"/tile sets");if(!u){return}var p=u.data.tileData;var v=u.data.width;var g=u.data.height;var m=p[f.t];var y=n*v+l;m.data[0][y]=e.p;this.alteredTiles.push(f.t)};GraphicAPI.getLayerPixel=function(e){var t=g_app.doc;var i=GraphicAPI.getLayer(e);if(i===false){return}var r=0;var a=i.cellHeight;var s=i.cellWidth;var o=i.tileSetId;var l=e.x%s;var n=e.y%a;var h=Math.floor(e.x/s);var d=Math.floor(e.y/a);var c=i.frames[r];if(c===false){return false}if(d>=c.data.length||h>=c.data[d].length){return false}var f=c.data[d][h];var u=t.getDocRecordById(o,"/tile sets");if(!u){return}var p=u.data.tileData;var v=u.data.width;var g=u.data.height;var m=p[f.t];var y=n*v+l;return m.data[0][y]};GraphicAPI.frameStart=function(){this.alteredTiles=[]};GraphicAPI.frameDone=function(){var e=g_app.textModeEditor;for(var t=0;t<this.alteredTiles.length;t++){e.tileSetManager.getCurrentTileSet().updateCharacterCurrentData(this.alteredTiles[t])}e.tools.drawTools.tilePalette.drawTilePalette();e.sideTilePalette.drawTilePalette();e.graphic.redraw({allCells:true})};var ColorPaletteAPI=function(){this.colorPalette=null};ColorPaletteAPI.prototype={init:function(e){}};var Music=function(){this.lastUpdate=0;this.name="Song Name";this.author="Author Name";this.copyright="Copyright";this.instruments=null;this.editInstrument=null;this.musicScripting=null;this.filters=null;this.editFilter=null;this.patternView=null;this.patterns=null;this.oscilloscopes=null;this.adsrGraph=null;this.filterGraph=null;this.view="edit";this.playheadPosition=0;this.trackView=null;this.tracks=null;this.drummer=null;this.bassist=null;this.history=null;this.sidSpeed=1;this.loopSelection=false;this.selectFrom=0;this.selectTo=16;this.sidFile=null;this.usePlayer2=true;this.scales=null;this.startTime=false;this.endTime=false;this.histories={}};Music.prototype={init:function(){this.musicPlayer2=new SidPlayer2;this.musicPlayer2.init(this);this.drummer=new Drummer;this.drummer.init(this);this.bassist=new Bassist;this.bassist.init(this);this.scales=new Scales},buildInterface:function(e){var t=UI.create("UI.SplitPanel",{id:"musicEditor"});e.add(t);var i=UI.create("UI.Panel",{id:"musicPlaybackPanel"});t.addSouth(i,34,false);var r=UI.create("UI.SplitPanel",{id:"musicSidePanel"});t.addEast(r,240);t.setMinSize("east",240);var a=UI.create("UI.Panel");r.add(a);var s=UI.create("UI.Panel");r.addSouth(s,140);var o=UI.create("UI.Panel",{id:"musicMainPanel"});t.add(o);var l=UI.create("UI.SplitPanel",{id:"musicMainSplitpanel"});o.add(l);var n=UI.create("UI.CanvasPanel",{id:"musicGraphPanel"});l.addNorth(n,120);this.viewPanel=UI.create("UI.Panel");l.add(this.viewPanel);var h=UI.create("UI.Panel",{id:"editInstrumentPanel"});this.viewPanel.add(h);var d=UI.create("UI.Panel",{id:"editFilterPanel"});this.viewPanel.add(d);var c=UI.create("UI.SplitPanel",{id:"musicEditorPanel"});this.viewPanel.add(c);var f=UI.create("UI.SplitPanel",{id:"patternEditorPanel"});c.add(f);var u=UI.create("UI.CanvasPanel",{id:"musicPatternPanel"});f.add(u);var p=UI.create("UI.Panel",{id:"musicEditControlsPanel"});f.addSouth(p,30);var v=UI.create("UI.CanvasPanel",{id:"trackPanel"});c.addSouth(v,87+styles.ui.scrollbarWidth);this.sidFile=new SidFile;this.sidFile.init(this);var g=this;UI.on("ready",function(){g.viewPanel.showOnly("musicEditorPanel");g.instruments=new C64Instruments;g.instruments.init(g);g.instruments.buildInterface(a);g.filters=new SidFilters;g.filters.init(g);g.filters.buildInterface(s);g.patternView=new PatternView2;g.patternView.init(g);g.patternView.buildInterface(u);g.patterns=new Patterns;g.patterns.init(g);g.trackView=new TrackView;g.trackView.init(g);g.trackView.buildInterface(v);g.tracks=new Tracks;g.tracks.init(g);g.playbackControls=new PlaybackControls;g.playbackControls.init(g);g.playbackControls.buildInterface(i);g.musicEditTools=new MusicEditTools;g.musicEditTools.init(g);g.musicEditTools.buildInterface(p);g.editInstrument=new EditC64Instrument;g.editInstrument.init(g);g.editInstrument.buildInterface(h);g.editFilter=new EditSidFilter;g.editFilter.init(g);g.editFilter.buildInterface(d);g.oscilloscopes=[];for(var e=0;e<3;e++){var t=e+1;g.oscilloscopes[e]=new Oscilloscope;g.oscilloscopes[e].init(g,e,n)}})},resize:function(){UI("musicPatternPanel").resize();UI("trackPanel").resize()},setView:function(e){this.view=e;switch(e){case"edit":this.viewPanel.showOnly("musicEditorPanel");break;case"editInstrument":this.viewPanel.showOnly("editInstrumentPanel");break;case"editFilter":this.viewPanel.showOnly("editFilterPanel");break}},clearAll:function(){this.tracks.clearTracks();this.patterns.clearPatterns();this.instruments.clearInstruments();this.filters.clearFilters()},isPlaying:function(){return this.musicPlayer2.isPlaying()},getTempo:function(){return parseInt($("#sidTempo").val())},setTempo:function(e){e=parseInt(e);if(isNaN(e)){return}$("#sidTempo").val(e)},setSpeed:function(e){this.sidSpeed=e},getSpeed:function(){return this.sidSpeed},setupHistory:function(){var e=this.doc.id;if(this.histories.hasOwnProperty(e)){this.history=this.histories[e]}else{this.history=new MusicHistory;this.history.init(this);this.histories[e]=this.history}},modified:function(){if(g_app.openingProject){return}g_app.doc.recordModified(this.doc,this.path)},show:function(e){if(this.isPlaying()){this.stopMusic()}this.doc=g_app.doc.getDocRecord(e);this.path=e;this.setupHistory();console.log(g_app.doc);this.trackView.tracksUpdated();this.instruments.updateInstrumentHTML();this.filters.updateFilterHTML();if(this.doc.data.tracks.length>0&&this.doc.data.tracks[0].patternInstances.length>0){this.trackView.selectPattern(0,0)}this.instruments.selectDefaultInstrument();this.patterns.getMaxNoteId()},saveSettings:function(){},startNew:function(e){var t="Untitled Music";if(typeof e!="undefined"){if(typeof e.name!="undefined"){t=e.name}}var i=g_app.doc.createDocRecord("/music",t,"music",{});this.doc=g_app.doc.getDocRecord("/music/"+t);this.doc.data.tracks=[];this.doc.data.patterns=[];if(typeof e=="undefined"){e={}}this.clearAll();if(e.defaultInstruments){this.instruments.createDefaultInstruments();this.filters.createDefaultFilters()}else{this.instruments.createMinimalInstruments();this.filters.createMinimalFilters()}this.tracks.clearTracks();this.tracks.createTrack();this.tracks.createTrack();this.tracks.createTrack();for(var r=1;r<=this.doc.data.tracks.length;r++){var a=this.patterns.createPattern("Pattern "+r,64);this.tracks.addPattern(r-1,a,0)}return i},load:function(e){this.stopMusic();this.sidFile.load(e);this.trackView.getHTML();this.trackView.selectPattern(0,0);this.setView("edit")},save:function(){var e=this.sidFile.save();e=JSON.stringify(e);var t="c64song.json";download(e,t,"application/json")},keyDown:function(e){this.shiftDown=e.shiftKey;this.ctrlDown=e.ctrlKey;this.altDown=e.altKey;this.cmdDown=e.metaKey;var t=e.keyCode;if(t==46||t==8){if(this.view=="edit"){this.patternView.clearSelected()}return}if(t==32){if(this.musicPlayer2.isPlaying()){this.stopMusic()}else{this.playMusic()}return}if((this.cmdDown||this.ctrlDown)&&e.keyCode==65){if(this.shiftDown){this.patternView.unselectAll()}else{this.patternView.selectAll()}e.preventDefault();return}if((this.cmdDown||this.ctrlDown)&&e.keyCode==90){if(this.shiftDown){this.history.redo()}else{this.history.undo()}e.preventDefault();return}if((this.cmdDown||this.ctrlDown)&&e.keyCode==89){if(this.shiftDown){this.history.undo()}else{this.history.redo()}e.preventDefault()}if(this.view=="editInstrument"){this.editInstrument.keyDown(e)}if(this.view=="edit"){this.patternView.keyDown(e)}},keyUp:function(e){this.shiftDown=e.shiftKey;this.ctrlDown=e.ctrlKey;this.altDown=e.altKey;this.cmdDown=e.metaKey;if(this.view=="editInstrument"){this.editInstrument.keyUp(e)}if(this.view=="edit"){this.patternView.keyUp(e)}},keyPress:function(e){},cut:function(){this.patternView.cut()},copy:function(){this.patternView.copy()},paste:function(){this.patternView.paste()},selectAll:function(){this.patternView.selectAll()},clearSelect:function(){this.patternView.unselectAllNotes()},setMute:function(e,t){this.musicPlayer2.setMute(e,t)},getMute:function(e){return this.musicPlayer2.getMute(e)},playMusic:function(){var e=this.playheadPosition;if(this.musicPlayer2.isPlaying()){return}if(this.loopSelection){e=this.selectFrom}this.musicPlayer2.setupAudioContext();this.musicPlayer2.play(e)},stopMusic:function(){this.patternView.started=false;this.musicPlayer2.stop()},exportAsType:function(e){this.musicPlayer2.exportAsType(e)},downloadSidAsPRG:function(){this.musicPlayer2.songData.downloadPRG()},updateSid:function(e){console.log("move this to sidplayer");this.musicPlayer.updateSid(e)},createSid:function(){return this.musicPlayer2.createSid()},getGlobalPosition:function(e,t,i){return this.tracks.getGlobalPosition(e,t,i)},setPlayheadPosition:function(e){this.musicPlayer2.setPlayheadPosition(e)},update:function(){var e=getTimestamp();var t=e-this.lastUpdate;this.lastUpdate=e;this.playheadPositionFraction=0;this.playheadPosition=this.musicPlayer2.getPlayheadPosition();if(this.playheadPosition===16&&this.startTime===false){this.startTime=getTimestamp();this.endTime=false}if(this.playheadPosition===112&&this.endTime===false){this.endTime=getTimestamp();var i=this.endTime-this.startTime;console.log("time diff = "+i);this.startTime=false}if(this.loopSelection&&(this.playheadPosition>=this.selectTo||this.playheadPosition<this.selectFrom-1)){}var r=null;if(this.view=="edit"||this.musicPlayer2.isPlaying()){if(this.musicPlayer2.isPlaying()){r=this.musicPlayer2.getChannelData()}else if(this.musicPlayer2.isPlayingInstrument()){r=this.musicPlayer2.getInstrumentChannelData()}}else if((this.view=="editInstrument"||this.view=="editFilter")&&this.usePlayer2){if(this.musicPlayer2.isPlayingInstrument()){r=this.musicPlayer2.getInstrumentChannelData()}}else if((this.view=="editInstrument"||this.view=="editFilter")&&typeof InstrumentPlayer!="undefined"){r=InstrumentPlayer.getData()}for(var a=0;a<3;a++){if(r){this.oscilloscopes[a].outputData(r[a])}else{this.oscilloscopes[a].outputData(false)}}this.trackView.render();this.patternView.render()}};var MusicHistory=function(){this.music=null;this.history=[];this.historyLength=0;this.historyPosition=0;this.changes=[];this.enabled=true;this.entryName="";this.enabled=true;this.newEntryEnabled=true};MusicHistory.prototype={init:function(e){this.music=e},setEnabled:function(e){this.enabled=e},getEnabled:function(e){return this.enabled},setNewEntryEnabled:function(e){this.newEntryEnabled=e},undo:function(){this.setEnabled(false);if(this.historyPosition>0){this.historyPosition--;if(this.historyPosition<this.historyLength){var e=this.history[this.historyPosition];var t={};for(var i=e.actions.length-1;i>=0;i--){var r=e.actions[i].name;var a=e.actions[i].params;if(r=="addNote"){this.music.patterns.eraseNote(a.patternId,a.noteId);this.music.patternView.drawPattern()}if(r=="eraseNote"){this.music.patterns.addNote(a.patternId,a);this.music.patternView.drawPattern()}if(r=="setNoteDuration"){this.music.patterns.setNoteDuration(a.patternId,a.noteId,a.oldDur);this.music.patternView.drawPattern()}if(r=="setNotePitch"){this.music.patterns.setNotePitch(a.patternId,a.noteId,a.oldPit);this.music.patternView.drawPattern()}if(r=="setNoteStart"){this.music.patterns.setNoteStart(a.patternId,a.noteId,a.oldStart);this.music.patternView.drawPattern()}}}}this.setEnabled(true)},redo:function(){this.setEnabled(false);if(this.historyPosition<this.historyLength){var e=this.history[this.historyPosition];for(var t=0;t<e.actions.length;t++){var i=e.actions[t].name;var r=e.actions[t].params;if(i=="addNote"){this.music.patterns.addNote(r.patternId,r);this.music.patternView.drawPattern()}if(i=="eraseNote"){this.music.patterns.eraseNote(r.patternId,r.noteId);this.music.patternView.drawPattern()}if(i=="setNoteDuration"){this.music.patterns.setNoteDuration(r.patternId,r.noteId,r.newDur);this.music.patternView.drawPattern()}if(i=="setNotePitch"){this.music.patterns.setNotePitch(r.patternId,r.noteId,r.newPit);this.music.patternView.drawPattern()}if(i=="setNoteStart"){this.music.patterns.setNoteStart(r.patternId,r.noteId,r.newStart);this.music.patternView.drawPattern()}}this.historyPosition++}this.setEnabled(true)},startEntry:function(e){if(!this.enabled){return}if(!this.newEntryEnabled){return}this.endEntry();this.changes=[];this.entryName=e},addAction:function(e,t){if(!this.enabled){return}this.changes.push({name:e,params:t})},endEntry:function(){if(!this.enabled){return}if(!this.newEntryEnabled){return}if(this.changes.length>0){this.history[this.historyPosition]={name:this.entryName,actions:this.changes};this.historyPosition++;this.historyLength=this.historyPosition}this.changes=[]},startPatternChange:function(e){if(!this.enabled){return}},endPatternChange:function(e){if(!this.enabled){return}}};var PlaybackControls=function(){this.music=null};PlaybackControls.prototype={init:function(e){this.music=e},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.HTMLPanel");e.add(this.uiComponent);UI.on("ready",function(){t.uiComponent.load("html/music/playbackControls.html",function(){t.initEvents()})})},initEvents:function(){var t=this;$("#musicStop").on("click",function(){t.music.stopMusic()});$("#musicPlay").on("click",function(){t.music.usePlayer2=true;if(t.music.musicPlayer2.isPlaying()){t.music.stopMusic()}else{t.music.playMusic()}});$("#playSidTest").on("click",function(){t.music.usePlayer2=false;if(t.music.musicPlayer.isPlaying()){t.music.stopMusic()}else{t.music.playMusicTest()}});$("input[type=radio][name=sidSpeed]").on("click",function(){var e=parseInt($(this).val());t.music.setSpeed(e)});$("#sidLoop").on("click",function(){t.music.loopSelection=$("#sidLoop").is(":checked")});t.music.loopSelection=$("#sidLoop").is(":checked")}};var MusicEditTools=function(){this.music=null};MusicEditTools.prototype={init:function(e){this.music=e},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.HTMLPanel");e.add(this.uiComponent);UI.on("ready",function(){t.uiComponent.load("html/music/musicEditTools.html",function(){t.initEvents()})})},initEvents:function(){var i=this;$(".musicTool").on("click",function(e){var t=$(this).attr("data-tool");i.music.patternView.setMode(t)});$("#patternCreateBeat").on("click",function(){i.music.drummer.start()});$("#patternCreateBassLine").on("click",function(){i.music.bassist.start()});$("#musicScripting").on("click",function(){if(!i.music.musicScripting){i.music.musicScripting=new MusicScripting;i.music.musicScripting.init(music)}i.music.musicScripting.start()})}};var MusicScripting=function(){this.music=null;this.scriptEditor=null;this.currentTab=0;this.tabs=[]};MusicScripting.prototype={initExamples:function(){this.drumScript='var pattern = Music.getCurrentPattern();\n\npattern.clear();\n\nvar drumPattern = [\n\t"bass drum",\n  "",\n  "bongo",\n  "",\n  "snare",\n  "",\n  "bongo",\n  "",\n\t"bass drum",\n  "bongo",\n  "bass drum",\n  "",\n  "snare",\n  "",\n  "bongo",\n  ""\n];\n\nvar patternLength = pattern.getLength();\n\nfor(var i = 0; i < patternLength; i++) {\n  var instrument = drumPattern[i % drumPattern.length];\n  if(instrument !== "") {\n  \tpattern.addNote(i, instrument, "c4", 1);\n  }\n}\n';this.scaleScript="var pattern = Music.getCurrentPattern();\n";this.scaleScript+="pattern.clear();\n\n";this.scaleScript+='var pitch = pattern.pitchToNumber("c2");\n\n';this.scaleScript+="for(var i = 0; i < 25; i++) {\n";this.scaleScript+='  pattern.addNote(i, "Bass", pitch + i, 1);\n';this.scaleScript+="}";this.portamentoScript="var pattern = Music.getCurrentPattern();\n\n";this.portamentoScript+="for(var i = 0; i < 16; i++) {\n";this.portamentoScript+="  if(i < 8) {\n";this.portamentoScript+='    pattern.addEffect(i, "pu", 600);\n';this.portamentoScript+="  } else {\n";this.portamentoScript+='    pattern.addEffect(i, "pd", 600);\n';this.portamentoScript+="  }\n";this.portamentoScript+="}\n";this.instrumentScript='var instrument = Music.getInstrument("Bass");\n';this.instrumentScript+="instrument.setADSR(0x9, 0xf, 0x9, 0xa);\n\n";this.instrumentScript+="instrument.setWavetable(\n";this.instrumentScript+="  [\n";this.instrumentScript+="    [0x41,0x0],   // pulse\n";this.instrumentScript+="    [0x21,0x0],   // sawtooth\n";this.instrumentScript+="    [0x11,0xc],   // triangle, relative pitch 0xc\n";this.instrumentScript+="    [0x81,0x0],   // noise\n";this.instrumentScript+="    [0xff,0x1]    // loop to row 1\n";this.instrumentScript+="  ]\n";this.instrumentScript+=");\n\n";this.instrumentScript+="instrument.setPulsetable(\n";this.instrumentScript+="  [\n";this.instrumentScript+="    [0x80,0x10],  // pulse width 10\n";this.instrumentScript+="    [0x20,0x40],  // for 0x20 ticks, increase width by 0x40\n";this.instrumentScript+="    [0x40,0xe0],  // for 0x40 ticks, decrease width by 0x20\n";this.instrumentScript+="    [0x40,0x20],  // for 0x40 ticks, increase width by 0x20\n";this.instrumentScript+="    [0xff, 0x3]   // loop to row 3\n";this.instrumentScript+="  ]\n";this.instrumentScript+=");\n\n";this.instrumentScript+="instrument.setFiltertable(\n";this.instrumentScript+="  [\n";this.instrumentScript+="    [0x90, 0xf7],\n";this.instrumentScript+="    [0x00, 0x00],\n";this.instrumentScript+="    [0x01, 0x01],\n";this.instrumentScript+="    [0x02, 0x00],\n";this.instrumentScript+="    [0xff, 0x03]\n";this.instrumentScript+="  ]\n";this.instrumentScript+=");\n\n";this.instrumentScript+="instrument.play();\n";this.randomScript='// random music created by\n// a repeating sequence of steps \n// each step defines what may happen at that step\n\n\n// the pattern\nvar pattern = Music.getCurrentPattern();\npattern.clear();\n\n\n// offset all notes by this number of semitones\nvar pitchOffset = 0;\n\n// the steps\nvar steps = [\n  // 1\n  {\n    noteProbability: 0.9,\n    instruments: ["bass drum", "electric piano", "c64 lead", "flute"],\n    notes: ["c3", "d3", "e3", "f3", "g3", "a3", "b3","c4", "d4", "e4", "f4", "g4", "a4", "b4"],\n    noteLengths: [1,2,4,8],\n    \n    effectProbability: 0.5,\n    effect: ["pu", "pd"],\n    effectParam: [200, 400, 800, 1200]\n  },\n  \n  // 2\n  {\n    noteProbability: 0.7,\n    instruments: ["electric piano", "electric guitar"],\n    notes: ["c3", "d3", "e3", "f3", "g3", "a3", "b3", "c4", "d4", "e4", "f4", "f#4"],\n    noteLengths: [1,2]\n  },\n  \n  // 3\n  {\n    noteProbability: 0.8,\n    instruments: ["electric piano"],\n    notes: ["c3", "e3", "g3"],\n    noteLengths: [1,2],\n    effectProbability: 0.5,\n    effect: ["pd"],\n    effectParam: [200]\n  },\n  \n  // 4\n  {\n    noteProbability: 0.3,\n    instruments: ["flute"],\n    notes: ["c3", "d3", "e3", "f3", "g3", "a3", "b3"],\n    noteLengths: [1]\n  },\n  \n  // 5\n  {\n    noteProbability: 0.9,\n    \n    // only make patterns with a snare 50% of the time\n    instruments: (Math.random() > 0.5) ? ["snare"] : ["Electric Piano"],\n    notes: ["c3"],\n    noteLengths: [1]\n  },\n  \n  // 6\n  {\n    noteProbability: 0.7,\n    instruments: ["electric piano"],\n    notes: ["c3", "d3", "e3", "f3", "g3", "a3", "b3", "c4", "d4", "e4", "f4", "f#4"],\n    noteLengths: [1]\n  },\n  \n  // 7\n  {\n    noteProbability: 0.8,\n    instruments: ["electric piano","flute"],\n    notes: ["c3", "e3", "g3"],\n    noteLengths: [1,2],\n    \n    effectProbability: 0.3,\n    effect: ["v"],\n    effectParam: [3],\n    effectParam2: [64]\n  },\n  \n  // 8\n  {\n    noteProbability: 0.3,\n    instruments: ["flute"],\n    notes: ["c3", "d3", "e3", "f3", "g3", "a3", "b3"],\n    noteLengths: [1]\n  } \n  \n];\n\nfunction chooseRandom(itemArray) {\n  var index = Math.floor(Math.random() * itemArray.length);\n  return itemArray[index];\n  \n}\n\n\n// the script to create the music from the steps\nvar patternLength = pattern.getLength();\nfor(var i = 0; i < patternLength; i+= 0) {\n  var step = steps[i % steps.length];\n  if(Math.random() > (1-step.noteProbability)) {\n    var pitch = chooseRandom(step.notes);    \n    var pitchNumber = pattern.pitchToNumber(pitch) + pitchOffset;\n        \n    var noteLength = chooseRandom(step.noteLengths);\n    var instrument = chooseRandom(step.instruments);\n    \n    pattern.addNote(i, instrument, pitchNumber, noteLength);\n\n    if(typeof step.effect != \'undefined\') {\n      for(var j = 0; j < noteLength; j++) {\n        if(Math.random() > (1-step.effectProbability)) {\n          var effect = chooseRandom(step.effect);                    \n          var effectParam = chooseRandom(step.effectParam);\n          var effectParam2 = 0;\n          \n          if(typeof step.effectParam2 != \'undefined\') {\n            effectParam2 = chooseRandom(step.effectParam2);\n          }\n          pattern.addEffect(i + j, effect, effectParam, effectParam2);\n        }\n      }\n    }\n\n    i += noteLength;\n  } else {\n    i++;\n  }\n}'},init:function(e){this.initExamples();this.music=e;this.tabs=[{tabName:"Script",code:""}];var i=this;e.editor.requireScripts(["lib/codemirror/codemirror.js"],function(){e.editor.requireScripts(["lib/codemirror/mode/javascript/javascript.js","lib/codemirror/addon/scroll/simplescrollbars.js","lib/codemirror/addon/search/search.js","lib/codemirror/addon/search/searchcursor.js","lib/codemirror/addon/dialog/dialog.js","lib/jshint/jshint.js"],function(){if(i.scriptEditor==null){var e=document.getElementById("musicScript");i.scriptEditor=CodeMirror.fromTextArea(e,{mode:"javascript",lineNumbers:true,tabSize:2});i.scriptEditor.setOption("mode","javascript");i.scriptEditor.getDoc().setValue("var pattern = Music.getCurrentPattern();\n");i.scriptEditor.focus()}i.redrawTabs();$("#musicScriptingExecute").on("click",function(){i.execute()});$("#musicScriptingClose").on("click",function(){i.music.editor.hideDialog()});$("#musicScriptDrum").on("click",function(){i.scriptEditor.getDoc().setValue(i.drumScript)});$("#musicScriptingToJSON").on("click",function(){var e=i.scriptEditor.getDoc().getValue();var t=JSON.stringify(e)+";";$("#musicScriptOutput").val(t)});$("#musicScriptScale").on("click",function(){i.scriptEditor.getDoc().setValue(i.scaleScript)});$("#musicScriptRandom").on("click",function(){i.scriptEditor.getDoc().setValue(i.randomScript)});$("#musicScriptPortamento").on("click",function(){i.scriptEditor.getDoc().setValue(i.portamentoScript)});$("#musicScriptInstrument").on("click",function(){i.scriptEditor.getDoc().setValue(i.instrumentScript)});$("#musicScriptingPlay").on("click",function(){if(i.music.sidPlayer.playing){i.music.stopMusic()}else{i.music.playMusic()}})})})},redrawTabs:function(){var e="";for(var t=0;t<this.tabs.length;t++){e+='<div tabIndex="'+t+'" id="musicScriptingTab'+t+'" style="display: inline-block; width: 100px; margin-right: 4px" class="instrumentTab ';if(t==this.currentTab){e+=" instrumentActiveTab "}e+='">'+this.tabs[t].tabName+"</div>"}e+='<div tabIndex="-1" style="display: inline-block; width: 10px; text-align: center" id="musicScriptingAddTab" class="instrumentTab">+</div>';$("#musicScriptingTabs").html(e);var i=this;$("#musicScriptingAddTab").on("click",function(){i.addTab()});$("#musicScriptingTabs .instrumentTab").on("click",function(){var e=parseInt($(this).attr("tabIndex"));i.selectTab(e)})},selectTab:function(e){if(e>=0){$("#musicScriptingTabs .instrumentTab").removeClass("instrumentActiveTab");$("#musicScriptingTab"+e).addClass("instrumentActiveTab");this.tabs[this.currentTab].code=this.scriptEditor.getDoc().getValue();console.log(this.tabs[this.currentTab].code);this.currentTab=e;this.scriptEditor.getDoc().setValue(this.tabs[this.currentTab].code)}},addTab:function(){this.tabs.push({tabName:"Script "+this.tabs.length,code:"var pattern = Music.getCurrentPattern();\n"});this.redrawTabs();this.selectTab(this.tabs.length-1)},start:function(){this.music.editor.showDialog("musicScriptingDialog");if(this.scriptEditor){this.scriptEditor.focus()}},setChannelEnabled:function(e,t){if(isNaN(parseInt(e))){this.logError("setChannelEnabled: channel must be a number");return}if(e<1||e>this.music.tracks.length){this.logError("setChannelEnabled: channel must be between 1 and "+this.music.tracks.length);return}if(typeof t=="undefined"){t=true}if(t!==false){t=true}$("#channel1").prop("checked",t);this.music.trackView.setChannels()},getCurrentPattern:function(){var e=new PatternScripting;e.init(this.music,this.music.patternView.patternID);return e},getPattern:function(e){for(var t=0;t<this.music.patterns.length;t++){if(this.music.patterns[t].name.toLowerCase()==e.toLowerCase()){var i=new PatternScripting;i.init(this.music,t);return i}}throw new ScriptingException("pattern not found "+e)},selectPattern:function(e){for(var t=0;t<this.music.patterns.length;t++){if(this.music.patterns[t].name.toLowerCase()==e.toLowerCase()){var i=this.music.tracks;for(var r=0;r<i.length;r++){for(var a=0;a<i[r].length;a++){if(i[r][a]==t){this.music.trackView.selectPattern(r,a)}}}var s=new PatternScripting;s.init(this.music,t);return s}}throw new ScriptingException("pattern not found "+e)},getInstrument:function(e){var t=e;if(!Number.isInteger(e)){var i=false;for(var r=0;r<this.music.instruments.instruments.length;r++){if(this.music.instruments.instruments[r].name.toLowerCase()==e.toLowerCase()){i=true;t=r;break}}if(!i){return null}var a=new InstrumentScripting;a.init(this.music,t);return a}},logError:function(e){var t=$("#musicScriptOutput").val();t+=e+"\n";$("#musicScriptOutput").val(t)},execute:function(){var content=this.scriptEditor.getDoc().getValue();$("#musicScriptOutput").val("");JSHINT(content);console.log("errors = ");console.log(JSHINT.errors);console.log(JSHINT.data());for(var i=0;i<JSHINT.errors.length;i++){this.logError("Error on line "+JSHINT.errors[i].line+":"+JSHINT.errors[i].reason);return}if(content!=""){console.log("eval code");try{var Music=this;eval(content)}catch(e){this.logError(e.message);this.logError(e.stack)}this.music.patternView.drawPattern();this.music.patternView.music.updatePattern(this.music.patternView.patternID,this.music.patternView.channel);this.logError("Execution Finished.")}}};InstrumentScripting=function(){this.instrumentID=0};InstrumentScripting.prototype={init:function(e,t){this.music=e;this.instrumentID=t},setADSR:function(e,t,i,r){this.music.instruments.instruments[this.instrumentID].attack=e;this.music.instruments.instruments[this.instrumentID].decay=t;this.music.instruments.instruments[this.instrumentID].sustain=i;this.music.instruments.instruments[this.instrumentID].release=r},setWavetable:function(e){console.log("instrument id = "+this.instrumentID);this.music.instruments.instruments[this.instrumentID].type="advanced";this.music.instruments.instruments[this.instrumentID].wavetable=e},setPulsetable:function(e){console.log("instrument id = "+this.instrumentID);this.music.instruments.instruments[this.instrumentID].type="advanced";this.music.instruments.instruments[this.instrumentID].pulsetable=e},setFiltertable:function(e){console.log("instrument id = "+this.instrumentID);this.music.instruments.instruments[this.instrumentID].type="advanced";this.music.instruments.instruments[this.instrumentID].filtertable=e},play:function(e,t){if(typeof e=="undefined"){e=48}if(typeof t=="undefined"){t=4}this.music.updateSid();this.music.sidPlayer.testInstrumentSetup();this.music.sidPlayer.testInstrumentStart(e,false,this.instrumentID);var i=this;setTimeout(function(){i.music.sidPlayer.testInstrumentStop()},600)}};PatternScripting=function(){this.patternID=0};PatternScripting.prototype={init:function(e,t){this.music=e;this.patternID=t},getLength:function(){var e=this.music.patterns[this.patternID];return e.getLength()},clear:function(){var e=this.music.patterns[this.patternID];e.clear()},logError:function(e){var t=$("#musicScriptOutput").val();t+=e+"\n";$("#musicScriptOutput").val(t)},filterToNumber:function(e){for(var t=0;t<this.music.filters.filters.length;t++){if(this.music.filters.filters[t].name.toLowerCase()==e.toLowerCase()){return t}}return false},pitchToNumber:function(e){if(typeof e=="undefined"){e="c4"}e=e.toLowerCase().trim();var t=e[0];var i=e[1]=="#";var r=e.substring(1);if(i){r=r.substring(1)}var a={c:0,d:2,e:4,f:5,g:7,a:8,b:10};if(!a.hasOwnProperty(t)){this.logError("Unknown pitch: "+e);return false}e=a[t];if(i){e++}e+=r*12;return e},addNote:function(e,t,i,r){var a=this.music.patterns[this.patternID];if(typeof e=="undefined"||typeof t=="undefined"){this.logError("addNote arguments: addNote(position, instrument, pitch, duration)");return}if(typeof i=="undefined"){i="c4"}if(typeof r=="undefined"){r=1}if(e>=a.getLength()){this.logError("Cannot add note in position: "+e+", pattern length is "+a.getLength());return}if(!Number.isInteger(i)){i=this.pitchToNumber(i);if(i===false){return}}if(!Number.isInteger(t)){var s=false;for(var o=0;o<this.music.instruments.instruments.length;o++){if(this.music.instruments.instruments[o].name.toLowerCase()==t.toLowerCase()){s=true;t=o;break}}if(!s){this.logError("Unknown instrument: "+t);return}}a.addNote(e,t,i,r)},eraseNote:function(e){var t=this.music.patterns[this.patternID];t.eraseNote(e)},addEffect:function(e,t,i,r){var a=this.music.patterns[this.patternID];var s={ne:0,l:17,pu:1,pd:2,pn:3,v:4,ad:5,sr:6,fon:10,frc:11,fc:12,ft:14,t:15};if(!Number.isInteger(t)){t=t.toLowerCase();if(s.hasOwnProperty(t)){t=s[t]}else{this.logError("Unknown effect: "+t);return}}else{var o=false;for(var l in s){if(s.hasOwnProperty(l)){if(s[l]==t){o=true;break}}}if(!o){this.logError("Unknown effect: "+t);return}}if(e>=a.getLength()){this.logError("Cannot add effect in position: "+e+", pattern length is "+a.getLength());return}if(t==3&&typeof r!="undefined"&&!Number.isInteger(r)){r=this.pitchToNumber(r)}if(t==10&&typeof i!="undefined"&&!Number.isInteger(i)){i=this.filterToNumber(i)}if(t==5||t==6){i=(i<<4)+r}if(t==11){i=(i<<4)+r}a.addEffect(e,t,i,r);console.log(a)},removeEffect:function(e){var t=this.music.patterns[this.patternID];t.removeEffect(e)}};var Patterns=function(){this.clipboard=[];this.monophonic=true;this.noteId=0;this.paramId=0};Patterns.prototype={init:function(e){this.music=e},validPatternId:function(e){if(e===false){return false}if(e>=this.music.doc.data.patterns.length){return false}return true},createPattern:function(e,t){var i={};if(typeof e=="undefined"){i.name="Pattern"}else{i.name=e}if(typeof t=="undefined"){i.duration=64}else{i.duration=t}i.notes=[];i.params={effects:[]};var r=this.music.doc.data.patterns.length;i.patternId=r;this.music.doc.data.patterns.push(i);this.music.modified();return r},getPatternCount:function(){return this.music.doc.data.patterns.length},getPatternId:function(e){return e},getDuration:function(e){return this.music.doc.data.patterns[e].duration},getName:function(e){return this.music.doc.data.patterns[e].name},getNotes:function(e){if(e<0){return null}return this.music.doc.data.patterns[e].notes},getNoteAt:function(e,t){var i=this.getNotes(e);for(var r=0;r<i.length;r++){if(i[r].pos===t){return i[r]}}return null},getDataCopy:function(e){return[]},setFromData:function(e,t){},usesInstrument:function(e,t){var i=this.getNotes(e);for(var r=0;r<i.length;r++){if(i[r].ins==t){return true}}return false},removeInstrument:function(e,t){var i=this.getNotes(e);for(var r=0;r<i.length;r++){if(i[r].ins==t){this.eraseNote(e,i[r].noteId)}}},removeInstrumentFromAllPatterns:function(e){for(var t=0;t<this.music.doc.data.patterns.length;t++){this.removeInstrument(this.music.doc.data.patterns[t].patternId,e)}},shiftInstrumentsAbove:function(e,t,i){console.error("should get rid of this");var r=this.getNotes(e);if(typeof i=="undefined"){i=-1}for(var a=0;a<r.lenght;a++){if(r[a].ins==t){r[a].ins+=i}}},usesFilter:function(e,t){console.error("uses filter");return false},removeFilter:function(e,t){console.error("remove filter");return false},shiftFiltersAbove:function(e,t,i){console.error("shift filters above")},setDuration:function(e,t){var i=this.music.doc.data.patterns[e];i.duration=t},setNoteStart:function(e,t,i,r){var a=this.getNote(e,t);if(!a){console.error("no note!");return false}var s={patternId:e,noteId:t,oldStart:a.pos,newStart:i};this.music.history.addAction("setNoteStart",s);a.pos=i;if(this.monophonic&&(typeof r=="undefined"||r)){this.checkNoteOverlap(e,t)}},getNoteDuration:function(e,t){var i=this.getNote(e,t);return i.dur},getNote:function(e,t){var i=this.music.doc.data.patterns[e];for(var r=0;r<i.notes.length;r++){if(i.notes[r].noteId==t){return i.notes[r]}}return null},getNoteId:function(e,t,i){var r=this.music.doc.data.patterns[e].notes;for(var a=0;a<r.length;a++){if(r[a].pit==i&&r[a].pos<=t&&r[a].pos+r[a].dur>t){return r[a].noteId}}return false},checkNoteOverlap:function(e,t){var i=this.getNotes(e);var r=this.getNote(e,t);var a=r.pos;var s=r.pos+r.dur;for(var o=0;o<i.length;o++){if(i[o].noteId!=t){if(i[o].pos<a&&i[o].pos+i[o].dur>a){var l=a-i[o].pos;var n={patternId:e,noteId:i[o].noteId,oldDur:i[o].dur,newDur:l};this.music.history.addAction("setNoteDuration",n);i[o].dur=l}else if(i[o].pos>=a&&i[o].pos<s){if(i[o].pos+i[o].dur<=s){this.eraseNote(e,i[o].noteId);o--}else{var l=i[o].dur-(s-i[o].pos);var n={patternId:e,noteId:i[o].noteId,oldDur:i[o].dur,newDur:l};this.music.history.addAction("setNoteDuration",n);i[o].dur=l;var n={patternId:e,noteId:i[o].noteId,oldStart:i[o].pos,newStart:s};this.music.history.addAction("setNoteStart",n);i[o].pos=s}}}}},setNotePitch:function(e,t,i){var r=this.getNote(e,t);r.pit=i;this.music.modified()},setNoteDuration:function(e,t,i){var r=this.music.doc.data.patterns[e];var a=this.getNote(e,t);if(a.pos+i>r.duration){return false}var s=a.dur;if(s==i){return false}var o={patternId:e,noteId:t,oldDur:a.dur,newDur:i};this.music.history.addAction("setNoteDuration",o);a.dur=i;if(this.music.history.getEnabled()){if(this.monophonic&&i>s){this.checkNoteOverlap(e,t)}}this.music.modified();return},newParamId:function(){return this.paramId++},getParams:function(e,t){var i=this.music.doc.data.patterns[e];if(typeof i.params[t]=="undefined"){return[]}return i.params[t]},addParam:function(e,t,i,r){var a=this.music.doc.data.patterns[e];if(typeof a.params[t]=="undefined"){a.params[t]=[]}var s=a.params[t];var o={};o.paramId=this.newParamId();o.pos=i;o.values={};for(var l in r){if(r.hasOwnProperty(l)){o.values[l]=r[l]}}var n=false;for(var h=0;h<s.length;h++){if(s[h].pos==i){s[h]=o;n=true}}if(!n){s.push(o)}this.music.modified();return o.paramId},removeParam:function(e,t,i){var r=this.music.doc.data.patterns[e];if(typeof r.params[t]=="undefined"){return null}var a=false;var s=r.params[t];for(var o=0;o<s.length;o++){if(s[o].position==i){a=o;break}}s.splice(a,1);this.music.modified()},getParamAt:function(e,t,i){var r=this.music.doc.data.patterns[e];if(typeof r.params[t]=="undefined"){console.error("unknown param type: "+t);return null}var a=r.params[t];for(var s=0;s<a.length;s++){if(a[s].pos==i){return a[s]}}return null},getMaxNoteId:function(){var e=this.music.doc.data.patterns;for(var t=0;t<e.length;t++){var i=e[t];for(var r=0;r<i.notes.length;r++){if(this.noteId<=i.notes[r].noteId){this.noteId=i.notes[r].noteId+1}}for(var a in i.params){var s=i.params[a];for(var r=0;r<s.length;r++){if(this.paramId<=s[r].paramId){this.paramId=s[r].paramId+1}}}}},genNoteId:function(){return this.noteId++},addNote:function(e,t){var i=false;var r=false;var a=1;var s=false;if(typeof t.position!="undefined"){i=t.position}if(typeof t.pos!=="undefined"){i=t.pos}if(typeof t.pitch!="undefined"){r=t.pitch}if(typeof t.pit!="undefined"){r=t.pit}if(typeof t.duration!="undefined"){a=t.duration}if(typeof t.dur!="undefined"){a=t.dur}if(typeof t.instrumentId!="undefined"){s=t.instrumentId}if(typeof t.ins!="undefined"){s=t.ins}if(i===false||r===false){return false}var o=0;if(typeof t.noteId!="undefined"){o=t.noteId}else{o=this.genNoteId()}var l=this.music.doc.data.patterns[e];if(i<0||i>=l.duration){console.error("position out of bounds");return false}if(i+a>l.duration){a=l.duration-i;if(a<=0){console.error("duration is negative"+a);return false}}var n={};n.noteId=o;n.pos=i;n.pit=r;n.dur=a;n.ins=s;n.vel=1;var h=false;for(var d=0;d<l.notes.length;d++){if(l.notes[d].pos>n.pos){h=d;break}}l.notes.push(n);var c={};for(var f in n){if(n.hasOwnProperty(f)){c[f]=n[f]}}c.patternId=e;this.music.history.addAction("addNote",c);if(this.monophonic){this.checkNoteOverlap(e,n.noteId)}this.music.modified();return n.noteId},setNoteSelected:function(e,t,i){var r=this.getNote(e,t);r.sel=i},getNoteSelected:function(e,t){var i=this.getNote(e,t);if(!i){return false}if(typeof i.sel=="undefined"){return false}return i.sel},selectNotesIn:function(e,t,i,r,a){var s=this.getNotes(e);for(var o=0;o<s.length;o++){var l=s[o].pos;var n=l+s[o].dur;if(l<=i&&n>t){if(s[o].pit>=r&&s[o].pit<=a){s[o].sel=true}}}},selectAllNotes:function(e){var t=this.getNotes(e);for(var i=0;i<t.length;i++){t[i].sel=true}},deselectAllNotes:function(e){var t=this.getNotes(e);for(var i=0;i<t.length;i++){t[i].sel=false}},copySelectedNotes:function(e){if(e==-1){return}this.clipboard=[];var t=this.getDuration(e);var i=0;var r=this.getNotes(e);for(var a=0;a<r.length;a++){if(typeof r[a].sel!=="undefined"&&r[a].sel){var s=r[a];if(s.pos<t){t=s.pos}if(s.pos>i){i=s.pos}var o={pos:s.pos,ins:s.ins,pit:s.pit,dur:s.dur,vel:s.vel};this.clipboard.push(o)}}for(var a=0;a<this.clipboard.length;a++){this.clipboard[a].pos-=t}},clearSelectedNotes:function(e){if(e==-1){return}var t=this.getNotes(e);for(var i=0;i<t.length;i++){if(typeof t[i].sel!="undefined"&&t[i].sel){this.eraseNote(e,t[i].noteId);i--}}},offsetSelectedNotes:function(e,t,i){console.log("need to check bounds and note overlap");var r=this.getNotes(e);if(this.monophonic){var a=this.getDuration(e);var s=a;var o=0;for(var l=0;l<r.length;l++){if(typeof r[l].sel!="undefined"&&r[l].sel){if(r[l].pos<s){s=r[l].pos}if(r[l].pos+r[l].dur>o){o=r[l].pos+r[l].dur}}}s+=t;o+=t;if(s<0){s=0}if(o<0){o=0}if(s>=a){s=a-1}if(o>=a){o=a-1}for(var l=0;l<r.length;l++){if(typeof r[l].sel=="undefined"||!r[l].sel){var n=r[l].pos;var h=r[l].pos+r[l].dur;if(h>s&&n<s){var d=s-r[l].pos;var c={patternId:e,noteId:r[l].noteId,oldDur:r[l].dur,newDur:d};this.music.history.addAction("setNoteDuration",c);r[l].dur=d}else if(n>=s&&h<=o){this.eraseNote(e,r[l].noteId);l--}else if(n<o&&h>o){var d=h-o;var c={patternId:e,noteId:r[l].noteId,oldDur:r[l].dur,newDur:d};this.music.history.addAction("setNoteDuration",c);r[l].dur=d;var c={patternId:e,noteId:r[l].noteId,oldStart:r[l].pos,newStart:o};this.music.history.addAction("setNoteStart",c);r[l].pos=o}}}}for(var l=0;l<r.length;l++){if(typeof r[l].sel!="undefined"&&r[l].sel){var f=r[l].pos+t;var c={patternId:e,noteId:r[l].noteId,oldStart:r[l].pos,newStart:f};this.music.history.addAction("setNoteStart",c);r[l].pos=f;var u=r[l].pit+i;var c={patternId:e,noteId:r[l].noteId,oldPit:r[l].pit,newPit:u};this.music.history.addAction("setNotePitch",c);r[l].pit=u}}this.music.modified()},pasteNotes:function(e,t,i){var r=this.getNotes(e);for(var a=0;a<r.length;a++){r[a].sel=false}var s=0;var o=this.getDuration(e);if(this.monophonic){var l=o;var n=0;for(var a=0;a<this.clipboard.length;a++){if(this.clipboard[a].pos<l){l=this.clipboard[a].pos}if(this.clipboard[a].pos+this.clipboard[a].dur>n){n=this.clipboard[a].pos+this.clipboard[a].dur}}l+=t;n+=t;for(var a=0;a<r.length;a++){var h=r[a].pos;var d=r[a].pos+r[a].dur;if(d>l&&h<l){r[a].dur=l-r[a].pos}else if(h>=l&&d<=n){this.eraseNote(e,r[a].noteId);a--}else if(h<n&&d>n){r[a].dur=d-n;r[a].pos=n}}}for(var a=0;a<this.clipboard.length;a++){var c={};c.position=this.clipboard[a].pos+t;c.pitch=this.clipboard[a].pit+i;c.instrumentId=this.clipboard[a].ins;c.duration=this.clipboard[a].dur;if(c.position>=0&&c.position<o){if(c.position+c.duration>o){c.duration=o-c.position}var f=this.addNote(e,c);if(f!==false){this.setNoteSelected(e,f,true);if(c.position+c.duration>s){s=c.position+c.duration}}}}this.music.modified();return s},clearPatterns:function(){this.music.doc.data.patterns=[]},clear:function(e){var t=this.music.doc.data.patterns[e];t.notes=[];this.music.modified()},eraseNote:function(e,t){var i=this.music.doc.data.patterns[e];var r=this.getNotes(e);var a=false;for(var s=0;s<r.length;s++){if(r[s].noteId==t){a=s;break}}var o=r[s];var l={};for(var n in o){if(o.hasOwnProperty(n)){l[n]=o[n]}}l.patternId=e;console.error("erase note");console.log(l);this.music.history.addAction("eraseNote",l);r.splice(a,1);this.music.modified()},instrumentUsed:function(e){for(var t=0;t<this.music.doc.data.patterns.length;t++){if(this.usesInstrument(this.music.doc.data.patterns[t].patternId,instrumentID)){return true}}return false}};var PatternView2=function(){this.cellHeight=15;this.cellWidth=20;this.gridHeight=93;this.gridWidth=100;this.pianoRollWidth=0;this.whiteKeyHeight=0;this.left=0;this.top=0;this.width=0;this.height=0;this.rulerHeight=20;this.effectsHeight=this.cellHeight;this.playheadPosition=0;this.gridCanvas=null;this.gridContext=null;this.rulerCanvas=null;this.pianoRollCanvas=null;this.pianoRollHighlightedNote=-1;this.pianoRollSelectedNote=-1;this.mouseDownAtX=0;this.mouseDownAtY=0;this.mouseDownAtGridX=0;this.mouseDownAtGridY=0;this.mouseDownAtScrollX=0;this.mouseDownAtScrollY=0;this.lastMouseX=0;this.lastMouseY=0;this.scrollX=0;this.scrollY=1300;this.xScrollSpeed=0;this.yScrollSpeed=0;this.partsPerBeat=1;this.snapToGrid=true;this.channel=0;this.patternId=-1;this.cursor={duration:1,position:0,pitch:0,visible:false};this.currentNotePosition=-1;this.currentNoteId=false;this.selectedFirstNotePosition=0;this.effectStart=-1;this.dragOffsetX=0;this.dragOffsetY=0;this.inDrag=false;this.resizeNote=false;this.resizeDirection=false;this.resizeAmount=0;this.inResize=false;this.buttons=0;this.leftMouseUp=true;this.vScrollBarWidth=styles.ui.scrollbarWidth;this.vScrollBarHeight=0;this.vScrollBarPosition=null;this.vScrollBarPositionMin=0;this.vScrollBarPositionMax=0;this.vScrollBarPositionMouseOffset=0;this.vScroll=false;this.hScrollBarHeight=styles.ui.scrollbarWidth;this.hScrollBarWidth=0;this.hScrollBarPosition=null;this.hScrollBarPositionMin=0;this.hScrollBarPositionMax=0;this.hScrollBarPositionMouseOffset=0;this.hScroll=false;this.patternViewPopup=null;this.lastTime=0;this.lastScrollTime=0;this.music=null;this.mode="draw";this.effectsChooser=null};PatternView2.prototype={setMode:function(e){this.mode=e;$(".musicTool").removeClass("musicToolSelected");$("#musicTool_"+e).addClass("musicToolSelected");switch(e){case"draw":UI.setCursor("default");break;case"erase":UI.setCursor("default");break;case"select":UI.setCursor("box-select");break}this.music.trackView.setMode(e)},getMode:function(){return this.mode},buildInterface:function(e){var a=this;this.uiComponent=e;this.uiComponent.on("resize",function(e,t,i,r){a.resize(e,t,i,r)});this.canvas=this.uiComponent.getCanvas();this.canvas.addEventListener("mousedown",function(e){a.mouseDown(e)},false);this.canvas.addEventListener("mousemove",function(e){a.mouseMove(e)},false);this.canvas.addEventListener("mouseup",function(e){a.mouseUp(e)},false);this.canvas.addEventListener("wheel",function(e){a.mouseWheel(e)},false);this.canvas.addEventListener("contextmenu",function(e){a.showContextMenu(e);e.preventDefault()},false);this.gridCanvas=document.createElement("canvas");this.pianoRollCanvas=document.createElement("canvas");this.rulerCanvas=document.createElement("canvas");this.setPatternSize(64,93);this.resize();this.scrollY=600},init:function(e){this.music=e;this.effectsChooser=new SidEffectsChooser;this.effectsChooser.init(this)},unselectAllNotes:function(){if(this.patternId==-1){return}this.music.patterns.deselectAllNotes(this.patternId)},selectNote:function(e){if(this.patternId==-1){return}if(e===false){console.error("note id is false!")}this.music.patterns.setNoteSelected(this.patternId,e,true)},unselectNote:function(e){},selectAll:function(){if(this.patternId==-1){return}this.music.patterns.selectAllNotes(this.patternId);this.drawPattern()},cut:function(){this.copy();this.clearSelected()},copy:function(){this.music.patterns.copySelectedNotes(this.patternId)},paste:function(e,t,i){if(this.patternId==-1){return}if(typeof e=="undefined"){e=Math.floor(this.playheadPosition)}if(typeof t=="undefined"){t=0}if(typeof i=="undefined"){i=true}if(this.music.isPlaying()){i=false}var r=this.music.patterns.pasteNotes(this.patternId,e,t);if(i){this.setPlayheadPosition(r)}this.drawPattern()},clearSelected:function(){if(this.patternId==-1){return}this.music.history.startPatternChange(this.patternId);this.music.patterns.clearSelectedNotes(this.patternId);this.music.history.endPatternChange(this.patternId);this.drawPattern()},getPatternId:function(){return this.patternId},patternLengthUpdated:function(){this.unselectAllNotes();var e=this.music.patterns.getDuration(this.patternId);var t=this.music.patterns.getName(this.patternId);if(e!=this.gridWidth){this.setPatternSize(e,this.gridHeight)}this.drawPattern();this.setYScroll(this.scrollY);this.setXScroll(this.scrollX)},setPattern:function(e,t,i){if(!this.music.patterns.validPatternId(e)){return false}this.unselectAllNotes();this.channel=t;this.trackIndex=i;this.patternId=e;this.patternLengthUpdated()},setPatternSize:function(e,t){this.gridWidth=e;this.gridHeight=t;this.gridCanvas.width=this.gridWidth*this.cellWidth;this.gridCanvas.height=this.gridHeight*this.cellHeight;this.gridContext=this.gridCanvas.getContext("2d");this.pianoRollWidth=3*this.cellWidth;this.pianoRollCanvas.width=this.pianoRollWidth;this.pianoRollCanvas.height=this.gridHeight*this.cellHeight;this.pianoRollContext=this.pianoRollCanvas.getContext("2d");this.rulerCanvas.width=this.gridWidth*this.cellWidth;this.rulerCanvas.height=this.rulerHeight+this.effectsHeight;this.rulerContext=this.rulerCanvas.getContext("2d");this.drawGrid();this.drawPianoRoll();this.drawRuler()},layout:function(){},setXScroll:function(e){var t=this.width-this.pianoRollWidth-this.vScrollBarWidth;if(e+t>this.gridWidth*this.cellWidth){e=this.gridWidth*this.cellWidth-t}if(e<0){e=0}this.scrollX=e},scrollToX:function(e){this.setXScroll(e)},scrollToY:function(e){this.setYScroll(e)},setYScroll:function(e){if(e<0){e=0}var t=this.height-this.rulerHeight-this.effectsHeight-this.hScrollBarHeight;if(e+t>this.gridHeight*this.cellHeight){e=this.gridHeight*this.cellHeight-t}this.scrollY=e},setPlayheadPosition:function(e){if(this.patternId<0){return}var t=this.music.patterns.getDuration(this.patternId);if(e<0||e>t){return}this.playheadPosition=e;var i=this.music.getGlobalPosition(this.channel,this.trackIndex,e);this.music.setPlayheadPosition(i)},mouseToGrid:function(e,t,i){var r=0;e-=this.pianoRollWidth;t-=this.hScrollBarHeight;if(typeof i=="undefined"){i=false}if(i){r=Math.round((e+this.scrollX)/this.cellWidth)*this.partsPerBeat}else{if(this.snapToGrid){r=Math.floor((e+this.scrollX)/this.cellWidth)*this.partsPerBeat}else{r=Math.floor((e+this.scrollX)*this.partsPerBeat/this.cellWidth)}}var a=Math.floor((t+this.scrollY)/this.cellHeight);return{x:r,y:a}},keyCodeToNote:function(e){var t=-1;switch(e){case 65:t=0;break;case 87:t=1;break;case 83:t=2;break;case 69:t=3;break;case 68:t=4;break;case 70:t=5;break;case 84:t=6;break;case 71:t=7;break;case 89:t=8;break;case 72:t=9;break;case 85:t=10;break;case 74:t=11;break;case 75:t=12;break;case 79:t=13;break;case 76:t=14;break;case 80:t=15;break;case 186:t=16;break;case 222:t=17;break}return t},keyDown:function(e){var t=e.keyCode;if(t==39){this.setPlayheadPosition(Math.floor(this.playheadPosition+1))}if(t==37){this.setPlayheadPosition(Math.floor(this.playheadPosition-1))}var i=this.keyCodeToNote(t);var r=3;if(i!=-1&&i!=this.keyboardNote){var a=i+12*r;var s=this.music.instruments.currentInstrumentId;var o=this.partsPerBeat;if(!this.snapToGrid){o=1}this.recordMode=$("#sidRecord").is(":checked");if(this.recordMode){if(!this.keyboardPlayingNote){this.music.history.startPatternChange(this.patternId)}this.lastDuration=o;var l=Math.floor(this.playheadPosition);this.music.doc.data.patterns[this.patternId].addNote(l,s,a,o);this.currentNotePosition=l;var n=$("#legato").is(":checked");if(n){this.music.patterns.addParam(this.patternId,"effects",l,{effect:17,value1:0,value2:0})}this.drawPattern()}this.keyboardPlayingNote=true;this.highlightNoteInPianoRoll(a);if(this.music){this.music.musicPlayer2.playTestInstrument(a,this.music.instruments.getInstrument(s),this.channel)}}this.keyboardNote=i},keyUp:function(e){var t=e.keyCode;if(this.keyboardPlayingNote){var i=this.keyCodeToNote(t);if(i==this.keyboardNote){this.keyboardPlayingNote=false;this.keyboardNote=-1;if(this.recordMode){if(this.currentNotePosition!=-1){var r=Math.floor(this.playheadPosition);var a=r-this.currentNotePosition;if(a>0){if(this.music.patterns.setNoteDuration(this.patternId,this.currentNotePosition,a)){}}this.currentNotePosition=-1}this.music.history.endPatternChange(this.patternId);this.drawPattern()}this.music.musicPlayer2.stopTestInstrument();this.unhighlightNoteInPianoRoll()}}},mouseDownPianoRoll:function(e,t,i){if(this.pianoRollHighlightedNote!=-1){if(this.pianoRollHighlightedNote!=this.pianoRollSelectedNote){this.pianoRollSelectedNote=this.pianoRollHighlightedNote;var r=this.music.instruments.currentInstrumentId;if(this.music){var a=this.music.instruments.getInstrument(r);if(typeof a!="undefined"&&a){this.music.musicPlayer2.playTestInstrument(this.pianoRollSelectedNote,a,this.channel)}}this.drawPianoRoll()}}},mouseDownRuler:function(e,t,i){var r=this.mouseToGrid(t,i,true);this.movingPlayHead=true;this.setPlayheadPosition(r.x)},mouseDownEffectsDraw:function(e,t,i){var r=this.mouseToGrid(t,i);this.effectStart=r.x},mouseDownGridSelect:function(e,t,i){var r=this.mouseToGrid(t,i);this.mouseDownAtGridX=r.x;this.mouseDownAtGridY=r.y;this.currentNoteId=this.gridToNoteId(r.x,r.y);if(this.currentNoteId!==false){var a=this.music.doc.data.patterns[this.patternId];this.dragOffsetX=0;this.dragOffsetY=0;if(!this.music.patterns.getNoteSelected(this.patternId,this.currentNoteId)){this.unselectAllNotes();this.selectNote(this.currentNoteId)}this.setFirstSelectedNotePosition();this.inDrag=true;this.drawPattern()}else{var s=r.x;var o=r.y;this.inSelect=true;this.selectStartX=t+this.scrollX-this.pianoRollWidth;this.selectStartY=i+this.scrollY;this.selectRight=this.selectLeft=this.selectStartX;this.selectTop=this.selectBottom=this.selectStartY;this.unselectAllNotes();this.drawPattern()}},mouseDownGridErase:function(e,t,i){var r=this.mouseToGrid(t,i);var a=this.gridToNoteId(r.x,r.y);if(a!==false){this.currentNoteId=a;this.drawPattern()}},mouseDownGridDraw:function(e,t,i){var r=this.mouseToGrid(t,i);this.mouseDownAtGridX=r.x;this.mouseDownAtGridY=r.y;var a=this.music.instruments.currentInstrumentId;var s=this.music.instruments.getInstrument(a);if(typeof s=="undefined"){return}if(this.resizeNote!==false){this.music.history.startPatternChange(this.patternId);this.inResize=true;this.resizeAmount=0;this.drawPattern();if(this.resizeDirection=="east"){}else if(this.resizeDirection=="west"){}else if(this.resizeDirection=="grab"){this.currentNoteId=this.gridToNoteId(r.x,r.y);if(this.currentNoteId!==false){UI.setCursor("move");this.dragOffsetX=0;this.dragOffsetY=0;this.unselectAllNotes();this.selectNote(this.currentNoteId);this.setFirstSelectedNotePosition();this.inDrag=true;this.drawPattern()}}else{}}else{var o=r.x;var l=r.y;var n=$("#legato").is(":checked");if(l!=this.pianoRollSelectedNote){this.pianoRollSelectedNote=l;this.drawPianoRoll()}var a=this.music.instruments.currentInstrumentId;var h=1;if(this.music){this.music.musicPlayer2.playTestInstrument(l,this.music.instruments.getInstrument(a),this.channel)}if(o>=0){if(this.patternId==-1){return}this.music.history.startEntry("addNote");this.currentNoteId=this.music.patterns.addNote(this.patternId,{position:o,instrumentId:a,pitch:l,duration:h});if(n){this.music.patterns.addParam(this.patternId,"effects",o,{effect:17,value1:0,value2:0});this.editor.history.addAction("setParam",{patternId:this.patternId,position:o,instrumentId:a,pitch:l,duration:h})}this.inResize=true;this.resizeNote=o;this.resizeAmount=0;this.resizeDirection="east";this.drawPattern()}}},showContextMenu:function(e){var t=e.pageX;var i=e.pageY;if(this.patternId==-1){return}var r=false;if(this.currentNoteId!==false){var a=this.music.patterns.getNote(this.patternId,this.currentNoteId);r=a.ins}if(this.patternViewPopup==null){this.patternViewPopup=new PatternViewPopup;var s=this;this.patternViewPopup.init(this.music,function(){s.patternViewPopup.show({selectedInstrument:r,x:t,y:i})})}else{this.patternViewPopup.show({selectedInstrument:r,x:t,y:i})}},mouseDownVScroll:function(e,t,i){i=this.height-i;if(i<this.rulerHeight+this.effectsHeight+this.vScrollBarPosition){this.setYScroll(this.scrollY+20)}else if(i>this.rulerHeight+this.effectsHeight+this.vScrollBarPosition+this.vScrollBarPositionHeight){this.setYScroll(this.scrollY-20)}else{this.vScroll=true}},mouseDownHScroll:function(e,t,i){t=t-this.pianoRollWidth;if(t<this.hScrollBarPosition){this.setXScroll(this.scrollX-20)}else if(t>this.hScrollBarPosition+this.hScrollBarPositionWidth){this.setXScroll(this.scrollX+20)}else{this.hScroll=true}},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){if(UI.os=="Mac OS"){this.buttons=2}}},mouseDown:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;i=this.height-i;var r=0;this.buttons=1;if(!UI.isMobile.any()){r=e.button;this.setButtons(e);if(this.buttons&2){return}if(this.buttons&1){this.leftMouseUp=false}UI.captureMouse(this);this.mouseIsDown=true}if(r==1){return}if(r==2){return}this.movingPlayHead=false;this.mouseDownAtX=t;this.mouseDownAtY=i;this.mouseDownAtScrollX=this.scrollX;this.mouseDownAtScrollY=this.scrollY;this.effectStart=-1;if(t>this.width-this.vScrollBarWidth&&i<this.height-(this.rulerHeight+this.effectsHeight)){return this.mouseDownVScroll(r,t,i)}if(t>this.pianoRollWidth&&i<this.hScrollBarHeight){return this.mouseDownHScroll(r,t,i)}if(t<this.pianoRollWidth){return this.mouseDownPianoRoll(r,t,i)}if(t>this.pianoRollWidth){if(i>this.height-this.rulerHeight){return this.mouseDownRuler(r,t,i)}else if(i>this.height-(this.rulerHeight+this.effectsHeight)){return this.mouseDownEffectsDraw(r,t,i)}else{if(this.mode=="draw"){return this.mouseDownGridDraw(r,t,i)}else if(this.mode=="select"){return this.mouseDownGridSelect(r,t,i)}else if(this.mode=="erase"){return this.mouseDownGridErase(r,t,i)}}}},mouseWheel:function(e,t){e.stopPropagation();e.preventDefault();var i=normalizeWheel(e);var r=4;this.setYScroll(this.scrollY-i.spinY*r);this.setXScroll(this.scrollX+i.spinX*r)},selectNotes:function(){if(this.patternId==-1){return}var e=this.music.patterns.getDuration(this.patternId);var t=false;var i=Math.floor(this.selectLeft/this.cellWidth);var r=Math.floor(this.selectRight/this.cellWidth);var a=Math.floor((this.selectTop-this.hScrollBarHeight)/this.cellHeight);var s=Math.floor((this.selectBottom-this.hScrollBarHeight)/this.cellHeight);if(!this.music.shiftDown&&!this.music.ctrlDown&&!this.music.cmdDown){this.unselectAllNotes()}if(i<0){i=0}if(r>=e){r=e-1}this.music.patterns.selectNotesIn(this.patternId,i,r,s,a);return},setFirstSelectedNotePosition:function(){var e=this.music.patterns.getNotes(this.patternId);this.selectedFirstNotePosition=this.music.patterns.getDuration(this.patternId);for(var t=0;t<e.length;t++){if(typeof e[t].sel!="undefined"&&e[t].sel){if(e[t].pos<this.selectedFirstNotePosition){this.selectedFirstNotePosition=e[t].pos}}}},mouseMoveGridSelect:function(e,t,i,r){if(this.inSelect){e=e+this.scrollX-this.pianoRollWidth;t=t+this.scrollY;if(e==this.selectStartX){e++}if(t==this.selectStartY){t++}if(e>this.selectStartX){this.selectLeft=this.selectStartX;this.selectRight=e}else{this.selectLeft=e;this.selectRight=this.selectStartX}if(t>this.selectStartY){this.selectBottom=this.selectStartY;this.selectTop=t}else{this.selectBottom=t;this.selectTop=this.selectStartY}this.selectNotes()}else{if(this.patternId==-1){return}this.resizeNote=false;this.resizeDirection=false;var a=this.mouseToGrid(e,t);var s=a.y;var o=a.x;var l=this.music.patterns.getDuration(this.patternId);if(o>=l){o=l-1}var n=this.gridToNoteId(o,s);if(n!==false){this.cursor.visible=false;this.currentNoteId=n;this.resizeDirection="grab";UI.setCursor("can-move")}else{UI.setCursor("box-select")}}},gridToNoteId:function(e,t){if(this.patternId==-1){return}if(e>=this.gridWidth||t>this.gridHeight){return false}var i=this.music.patterns.getNoteId(this.patternId,e,t);return i},setHighlightNote:function(e){if(this.highlightNoteId!==e){this.highlightNoteId=e;this.drawPattern()}},mouseMoveGridDraw:function(e,t,i,r){if(this.patternId==-1){return}var a=this.mouseToGrid(e,t);var s=a.x;var o=this.music.patterns.getDuration(this.patternId);if(s>=o){s=o-1}var l=a.y;UI.setCursor("draw");if(this.inResize&&this.currentNoteId!==false){var n=this.music.patterns.getNote(this.patternId,this.currentNoteId);var h=n.pos;var d=n.dur;if(this.resizeDirection=="east"){this.resizeAmount=s-(h+d)+1}else if(this.resizeDirection=="west"){this.resizeAmount=h-s}return}if(this.currentNotePosition!=-1){if(this.resizeDirection=="west"){this.music.patterns.setNoteStart(this.patternId,this.currentNoteId,a.x);this.drawPattern()}else if(this.resizeDirection=="east"){var c=s+1-this.currentNotePosition;if(c>0){this.music.patterns.setNoteDuration(this.patternId,this.currentNoteId,c);this.drawPattern()}}}if(this.currentNotePosition==-1){this.cursor.position=a.x;this.cursor.pitch=a.y;this.cursor.duration=1;this.cursor.visible=true;if(this.pianoRollHighlightedNote!=this.cursor.pitch){this.pianoRollHighlightedNote=this.cursor.pitch;this.drawPianoRoll()}this.resizeNote=false;this.resizeDirection=false;var f=this.gridToNoteId(s,l);if(f!==false){this.setHighlightNote(f);this.cursor.visible=false;var u=this.music.patterns.getNote(this.patternId,f);var p=u.pos;var v=this.pianoRollWidth+p*this.cellWidth-this.scrollX;var c=u.dur;var g=v+c*this.cellWidth;if(e>v&&e<v+this.cellWidth/6){this.resizeNote=p;this.currentNoteId=f;this.resizeDirection="west";UI.setCursor("w-resize")}else if(e<g&&e>g-this.cellWidth/4){this.resizeNote=p;this.currentNoteId=f;this.resizeDirection="east";UI.setCursor("e-resize")}else{if(this.currentNotePosition!==-1){if(this.resizeDirection=="east"){UI.setCursor("e-resize")}else if(this.resizeDirection=="west"){UI.setCursor("w-resize")}}else{this.resizeNote=p;this.resizeDirection="grab";UI.setCursor("can-move")}}}else{this.setHighlightNote(false)}}},mouseMovePianoRoll:function(e,t,i,r){var a=this.mouseToGrid(e,t,true);var s=a.y;if(e>this.blackKeyWidth){t=t+this.scrollY;var o=Math.floor(t/this.whiteKeyHeight);var l=Math.floor(o/7);var n=o%7;switch(n){case 0:n=0;break;case 1:n=2;break;case 2:n=4;break;case 3:n=5;break;case 4:n=7;break;case 5:n=9;break;case 6:n=11;break}var s=l*12+n}else{s=a.y}if(this.pianoRollHighlightedNote!=s){this.pianoRollHighlightedNote=s;this.drawPianoRoll()}},mouseMoveDrag:function(e,t,i,r){var a=this.mouseToGrid(e,t);this.cursor.position=a.x;this.cursor.pitch=a.y;this.dragOffsetX=a.x-this.mouseDownAtGridX;this.dragOffsetY=a.y-this.mouseDownAtGridY;if(this.selectedFirstNotePosition+this.dragOffsetX<0){this.dragOffsetX=-this.selectedFirstNotePosition}},mouseMovePlayhead:function(e,t,i,r){var a=this.mouseToGrid(e,t,true);this.setPlayheadPosition(a.x)},mouseMoveEffectsDraw:function(e,t,i,r){var a=this.mouseToGrid(e,t);this.cursor.position=a.x;this.cursor.pitch=-1;this.cursor.duration=1;this.cursor.visible=true;if(this.effectStart>-1){this.effectsEnd=a.x;this.cursor.position=this.effectStart;this.cursor.duration=this.effectsEnd-this.effectStart+1}},dragView:function(e,t,i,r){this.setYScroll(this.scrollY-r);this.setXScroll(this.scrollX-i)},mouseMoveVScroll:function(e,t,i,r){var a=this.vScrollBarHeight/(this.gridHeight*this.cellHeight);var s=(t-this.mouseDownAtY)/a;this.setYScroll(this.mouseDownAtScrollY+s)},mouseMoveHScroll:function(e,t,i,r){var a=this.hScrollBarWidth/(this.gridWidth*this.cellWidth);var s=(e-this.mouseDownAtX)/a;this.setXScroll(this.mouseDownAtScrollX+s)},mouseMove:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;i=this.height-i;var r=t-this.lastMouseX;var a=i-this.lastMouseY;this.lastMouseX=t;this.lastMouseY=i;this.cursor.visible=false;if(this.buttons&4||this.mode=="hand"&&this.buttons&1){UI.setCursor("drag-scroll");this.dragView(t,i,r,a);return}if(this.hScroll){this.mouseMoveHScroll(t,i,r,a);return}if(this.vScroll){this.mouseMoveVScroll(t,i,r,a);return}this.xScrollSpeed=0;this.yScrollSpeed=0;if(this.buttons&1&&!this.leftMouseUp){if(this.mode!="hand"){if(t>this.width){this.setXScroll(this.scrollX+2);this.xScrollSpeed=1}if(t<this.pianoRollWidth&&!this.pianoRollMouseDown){this.setXScroll(this.scrollX-2);this.xScrollSpeed=-1}if(!this.movingPlayHead&&this.effectStart==-1){if(i<0){this.setYScroll(this.scrollY-2);this.yScrollSpeed=1}if(i>this.height||this.currentNotePosition!=-1&&i>=this.height-this.rulerHeight-this.effectsHeight-2){this.setYScroll(this.scrollY+2);this.yScrollSpeed=-1}}}}if(t>this.width-this.vScrollBarWidth&&i<this.height-(this.rulerHeight+this.effectsHeight)){UI.setCursor("default");return}if(t>this.pianoRollWidth&&i<this.hScrollBarHeight){UI.setCursor("default");return}if(t<this.pianoRollWidth){UI.setCursor("pointer");this.mouseMovePianoRoll(t,i,r,a);return}if(this.movingPlayHead){return this.mouseMovePlayhead(t,i,r,a)}if(this.inDrag){this.cursor.visible=false;return this.mouseMoveDrag(t,i,r,a)}if(i>this.height-this.rulerHeight){UI.setCursor("ew-resize");return}if(i>this.height-(this.rulerHeight+this.effectsHeight)||this.effectStart>-1){if(this.mode=="erase"){UI.setCursor("erase")}if(this.mode=="draw"){UI.setCursor("draw")}return this.mouseMoveEffectsDraw(t,i,r,a)}if(t>this.pianoRollWidth){if(i>this.height-(this.rulerHeight+this.effectsHeight)){}else{if(this.mode=="erase"){UI.setCursor("erase")}if(this.mode=="draw"){return this.mouseMoveGridDraw(t,i,r,a)}if(this.mode=="select"){return this.mouseMoveGridSelect(t,i,r,a)}if(this.mode=="hand"){if(this.buttons&1){}else{UI.setCursor("can-drag-scroll")}}}}},mouseUpDrag:function(e,t,i){if(this.patternId==-1){return}this.music.history.startEntry("Move Notes");this.music.patterns.offsetSelectedNotes(this.patternId,this.dragOffsetX,this.dragOffsetY);this.music.history.endEntry()},mouseUpEffectsDraw:function(e,t,i){var r=this.mouseToGrid(t,i);this.effectEnd=r.x;if(this.mode=="erase"){if(this.effectStart==this.effectEnd){this.music.patterns.addParam(this.patternId,"effects",this.effectStart,{effect:0,value1:0,value2:0})}}else{this.effectsChooser.chooseEffect(this.effectStart,this.effectEnd)}this.effectStart=-1},mouseUpErase:function(e,t,i){var r=this.mouseToGrid(t,i);var a=this.gridToNoteId(r.x,r.y);if(a!==false&&this.currentNoteId===a){this.music.patterns.eraseNote(this.patternId,a)}this.drawPattern()},mouseUp:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;i=this.height-i;var r=this.buttons;if(!UI.isMobile.any()){this.setButtons(e)}else{this.buttons=0}if(this.buttons&1){this.leftMouseUp=false}else{this.leftMouseUp=true}this.xScrollSpeed=0;this.yScrollSpeed=0;if(this.inDrag){this.mouseUpDrag(r,t,i);if(this.mode=="draw"){this.unselectAllNotes();this.drawPattern()}this.dragOffsetX=0;this.dragOffsetY=0}else if(this.inResize){if(this.resizeAmount!=0&&this.currentNoteId!==false){if(this.resizeDirection=="west"){var a=this.music.patterns.getNote(this.patternId,this.currentNoteId);var s=a.pos-this.resizeAmount;var o=a.dur+this.resizeAmount;this.music.patterns.setNoteStart(this.patternId,this.currentNoteId,s,false);this.music.patterns.setNoteDuration(this.patternId,this.currentNoteId,o);this.drawPattern()}else if(this.resizeDirection=="east"){var l=this.music.patterns.getNoteDuration(this.patternId,this.currentNoteId)+this.resizeAmount;if(l>0){this.music.patterns.setNoteDuration(this.patternId,this.currentNoteId,l);this.drawPattern()}}this.music.history.endPatternChange(this.patternId)}}else{if(this.mode=="erase"){this.mouseUpErase(r,t,i)}if(this.currentNotePosition>=0){this.music.history.endPatternChange(this.patternId)}}if(this.effectStart>-1){this.mouseUpEffectsDraw(r,t,i)}this.currentNotePosition=-1;this.music.musicPlayer2.stopTestInstrument();this.inSelect=false;this.inDrag=false;this.effectStart=-1;this.movingPlayHead=false;this.vScroll=false;this.hScroll=false;this.inResize=false;this.resizeNote=false;this.resizeAmount=0;this.currentNoteId=false;this.drawPattern();if(this.pianoRollSelectedNote!=-1){this.pianoRollSelectedNote=-1;this.drawPianoRoll()}this.music.history.endEntry();UI.setCursor("default")},drawPianoRoll:function(){this.whiteKeyHeight=12/7*this.cellHeight;this.pianoRollWidth=3*this.cellWidth;this.pianoRollContext.fillStyle=styles.music.pianoRollWhiteKey;this.pianoRollContext.fillRect(0,0,this.pianoRollWidth,this.gridHeight*this.cellHeight);this.pianoRollContext.beginPath();this.pianoRollContext.strokeStyle=styles.music.pianoRollKeyOutline;var e=0;var t=this.pianoRollHighlightedNote;var i=this.pianoRollSelectedNote;for(var r=0;r<this.gridHeight/12*7;r++){var a=Math.floor(this.gridHeight*this.cellHeight-(r+1)*this.whiteKeyHeight);this.pianoRollContext.moveTo(0,a+.5);this.pianoRollContext.lineTo(this.pianoRollWidth,a+.5);e++;var s=r%7;var o=0;switch(s){case 0:o=0;break;case 1:o=2;break;case 2:o=4;break;case 3:o=5;break;case 4:o=7;break;case 5:o=9;break;case 6:o=11;break}o+=12*Math.floor(r/7);if(o==t&&o!=i){this.pianoRollContext.fillStyle=styles.music.pianoRollHighlightedNote;this.pianoRollContext.fillRect(0,a+.5,this.pianoRollWidth,this.whiteKeyHeight-1)}if(o==i){this.pianoRollContext.fillStyle=styles.music.pianoRollSelectedNote;this.pianoRollContext.fillRect(0,a+.5,this.pianoRollWidth,this.whiteKeyHeight-1)}}this.pianoRollContext.stroke();this.pianoRollContext.font="10px Verdana";this.pianoRollContext.fillStyle="#000000";for(var r=0;r<=e/7;r++){var l=r;var a=Math.floor(this.gridHeight*this.cellHeight-l*7*this.whiteKeyHeight)-4;this.pianoRollContext.fillText("C"+l,this.pianoRollWidth-16,a)}this.blackKeyHeight=this.cellHeight;this.blackKeyWidth=this.pianoRollWidth/2.1;for(var r=0;r<this.gridHeight;r++){var o=r%12;if(o==1||o==3||o==6||o==8||o==10){var a=Math.floor(this.gridHeight*this.cellHeight-(r+1)*this.blackKeyHeight);if(r==i){this.pianoRollContext.fillStyle=styles.music.pianoRollSelectedNote}else if(r==t){this.pianoRollContext.fillStyle=styles.music.pianoRollHighlightedNote}else{this.pianoRollContext.fillStyle=styles.music.pianoRollBlackKey}this.pianoRollContext.fillRect(0,a,this.blackKeyWidth,this.blackKeyHeight)}}},drawRuler:function(){this.rulerContext.fillStyle=styles.music.rulerBackground;this.rulerContext.fillRect(0,0,this.gridWidth*this.cellWidth,this.rulerHeight);this.rulerContext.fillStyle=styles.music.effectsBackground;this.rulerContext.fillRect(0,this.rulerHeight,this.gridWidth*this.cellWidth,this.effectsHeight);this.rulerContext.beginPath();this.rulerContext.strokeStyle=styles.music.rulerLines;for(var e=0;e<this.gridWidth;e++){var t=this.effectsHeight+4;if(e%16!=0){if(e%4==0){t+=6}var i=this.rulerHeight+this.effectsHeight-t;this.rulerContext.moveTo(e*this.cellWidth+.5,i);this.rulerContext.lineTo(e*this.cellWidth+.5,i+t)}}this.rulerContext.stroke();this.rulerContext.beginPath();this.rulerContext.strokeStyle=styles.music.rulerBarLines;this.rulerContext.font="10px Verdana";this.rulerContext.fillStyle="#eeeeee";var r=1;for(var e=0;e<this.gridWidth;e++){var t=this.effectsHeight+4;if(e%16==0){t=this.effectsHeight+this.rulerHeight;this.rulerContext.fillText(r,e*this.cellWidth+4,this.rulerHeight-4);r++;var i=this.rulerHeight+this.effectsHeight-t;this.rulerContext.moveTo(e*this.cellWidth+.5,i);this.rulerContext.lineTo(e*this.cellWidth+.5,i+t)}}this.rulerContext.stroke()},drawEffects:function(){this.drawRuler();if(this.patternId==-1||this.patternId>=this.music.doc.data.patterns.length){return}this.rulerContext.beginPath();this.rulerContext.strokeStyle=styles.music.effectsOutline;this.rulerContext.font="12px Verdana";var e=this.music.patterns.getDuration(this.patternId);for(var t=0;t<e;t++){var i=this.music.patterns.getParamAt(this.patternId,"effects",t);if(i!==null){var r=i.values.effect;var a=1;if(r&&r!=0){var s=this.cellWidth;var o=this.cellHeight;var l=this.effectsMaterial;var n="E";switch(r){case 1:n="Pu";break;case 2:n="Pd";break;case 3:n="Pn";break;case 4:n="V";break;case 5:n="AD";break;case 6:n="SR";break;case 7:break;case 8:break;case 9:break;case 10:n="Fon";break;case 11:n="FRC";break;case 12:n="FC";break;case 13:n="Mv";break;case 14:n="FT";break;case 15:n="T";break;case 16:n="Foff";break;case 17:n="L";break}var h=t*this.cellWidth;var d=this.rulerHeight;this.rulerContext.fillStyle=styles.music.effectsFill;this.rulerContext.fillRect(h,d,a*this.cellWidth,this.cellHeight);this.rulerContext.moveTo(h+.5,d+.5);this.rulerContext.lineTo(h+s+.5,d+.5);this.rulerContext.lineTo(h+s+.5,d+o+.5);this.rulerContext.lineTo(h+.5,d+o+.5);this.rulerContext.lineTo(h+.5,d+.5);this.rulerContext.fillStyle=styles.music.effectsText;var c=this.rulerContext.measureText(n).width;var f=h+(this.cellWidth-c)/2;this.rulerContext.fillText(n,f,d+12)}}}this.rulerContext.stroke()},drawOtherTrackNotes:function(){if(this.patternId<0){return}var e=this.music.patterns.getDuration(this.patternId);var t=this.music.getGlobalPosition(this.channel,this.trackIndex,0);var i=t+e;var r=this.music.doc.data.tracks;this.gridContext.globalAlpha=.15;for(var a=0;a<r.length;a++){if(a!=this.channel){for(var s=0;s<r[a].patternInstances.length;s++){var o=r[a].patternInstances[s];var l=o.patternId;var n=o.position;var e=this.music.patterns.getDuration(l);var h=n+e;var d=n-t;var c=this.music.patterns.getName(l);if(n>=t&&n<i||h>=t&&h<i){var f=null;var u=this.music.patterns.getNotes(l);for(noteIndex=0;noteIndex<u.length;noteIndex++){f=u[noteIndex];var p=f.pos+d;var v=f.pit;var g=f.ins;var m=f.dur;var y=f.sel;var b="ff0000";if(g!==false){var b=this.music.instruments.getColor(g);b=("000000"+b.toString(16)).substr(-6)}var C=this.cellWidth/this.partsPerBeat*m;var x=this.cellHeight;var S=p*this.cellWidth;var P=this.gridHeight*this.cellHeight-(v+1)*this.cellHeight;this.gridContext.fillStyle="#"+b;this.gridContext.fillRect(S,P,C,x)}}}}}this.gridContext.globalAlpha=1},drawNotes:function(){if(this.patternId==-1){return}var e=this.music.patterns.getNotes(this.patternId);this.drawOtherTrackNotes();var t=null;for(var i=0;i<e.length;i++){t=e[i];var r=t.pos;var a=t.pit;var s=t.ins;var o=t.dur;var l=t.sel;if(typeof l=="undefined"){l=false}var n="ff0000";if(s!==false){var n=this.music.instruments.getColor(s);n=("000000"+n.toString(16)).substr(-6)}if(t.noteId===this.highlightNoteId){var n=this.music.instruments.getHighlightColor(s);n=("000000"+n.toString(16)).substr(-6)}var h=this.cellWidth/this.partsPerBeat*o;var d=this.cellHeight;var c=r*this.cellWidth;var f=this.gridHeight*this.cellHeight-(a+1)*this.cellHeight;if(l){this.gridContext.globalAlpha=.2}this.gridContext.fillStyle="#"+n;this.gridContext.fillRect(c,f,h,d);if(!l){var n=this.music.instruments.getBorderColor(s);n=("000000"+n.toString(16)).substr(-6);this.gridContext.beginPath();this.gridContext.strokeStyle="#"+n;this.gridContext.moveTo(c+.5,f+.5);this.gridContext.lineTo(c+h+.5,f+.5);this.gridContext.lineTo(c+h+.5,f+d+.5);this.gridContext.lineTo(c+.5,f+d+.5);this.gridContext.lineTo(c+.5,f+.5);this.gridContext.stroke()}if(l){this.gridContext.globalAlpha=1}}this.gridContext.beginPath();this.gridContext.strokeStyle=styles.music.ghostNoteOutline;this.gridContext.strokeStyle="#ff0000";for(var i=0;i<e.length;i++){t=e[i];var r=t.pos;var a=t.pit;var s=t.ins;var o=t.dur;var l=t.sel;if(typeof l=="undefined"){l=false}if(l){var h=this.cellWidth/this.partsPerBeat*o;var d=this.cellHeight;var c=r*this.cellWidth;var f=this.gridHeight*this.cellHeight-(a+1)*this.cellHeight;this.gridContext.moveTo(c+.5,f+.5);this.gridContext.lineTo(c+h+.5,f+.5);this.gridContext.lineTo(c+h+.5,f+d+.5);this.gridContext.lineTo(c+.5,f+d+.5);this.gridContext.lineTo(c+.5,f+.5)}}this.gridContext.stroke()},drawSelectedNotes:function(){if(this.patternId<0||this.patternId===false){return}var e=this.height-this.rulerHeight-this.effectsHeight-this.hScrollBarHeight;var t=this.dragOffsetX*this.cellWidth;var i=this.dragOffsetY*this.cellHeight;this.context.beginPath();this.context.strokeStyle=styles.music.ghostNoteOutline;this.context.strokeStyle="#ff0000";var r=this.music.patterns.getNotes(this.patternId);for(var a=0;a<r.length;a++){if(typeof r[a].sel!="undefined"&&r[a].sel){var s=r[a].pos;var o=r[a].pit;var l=r[a].ins;var n=r[a].dur;var h="ff0000";if(l!=false){h=this.music.instruments.getColor(l);h=("000000"+h.toString(16)).substr(-6)}var d=this.cellWidth/this.partsPerBeat*n;var c=this.cellHeight;var f=this.pianoRollWidth-Math.round(this.scrollX)+s*this.cellWidth+t;var u=this.rulerHeight+this.effectsHeight+Math.round(this.scrollY)-(this.gridHeight*this.cellHeight-e)+this.gridHeight*this.cellHeight-(o+1)*this.cellHeight-i;this.context.globalAlpha=.8;this.context.fillStyle="#"+h;this.context.fillRect(f,u,n*this.cellWidth,this.cellHeight);this.context.globalAlpha=1;this.context.moveTo(f+.5,u+.5);this.context.lineTo(f+d+.5,u+.5);this.context.lineTo(f+d+.5,u+c+.5);this.context.lineTo(f+.5,u+c+.5);this.context.lineTo(f+.5,u+.5)}}this.context.stroke();return},drawCursorInfo:function(){this.cursorInfoPosition=this.cursor.position;this.cursorInfoPitch=this.cursor.pitch;if(this.cursorInfoPitch==-1){return}var e=this.height-this.rulerHeight-this.effectsHeight-this.hScrollBarHeight;var t=this.cellWidth/this.partsPerBeat*1.4;var i=this.cellHeight;var r=this.pianoRollWidth-Math.round(this.scrollX)+this.cursorInfoPosition*this.cellWidth;var a=0;var s="#222222";var o=-this.cellHeight;var a=this.rulerHeight+this.effectsHeight+Math.round(this.scrollY)-(this.gridHeight*this.cellHeight-e)+this.gridHeight*this.cellHeight-(this.cursorInfoPitch+1)*this.cellHeight+o;var l=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];var n=Math.floor(this.cursorInfoPitch/12);var h=l[this.cursorInfoPitch%12];var d=h+n;if(this.highlightNoteId!==false){var c=this.music.patterns.getNote(this.patternId,this.highlightNoteId);if(c){var f=c.ins;var u=this.music.instruments.getInstrument(f);d+=" "+u.name}}this.context.font="10px Verdana";var p=this.context.measureText(d).width;var t=p+4;this.context.globalAlpha=.8;this.context.fillStyle=s;this.context.fillRect(r,a,t,i);this.context.fillStyle="#cccccc";this.context.fillText(d,r+3,a+this.cellHeight-3);this.context.strokeStyle="#999999";this.context.beginPath();this.context.moveTo(r+.5,a+.5);this.context.lineTo(r+t+.5,a+.5);this.context.lineTo(r+t+.5,a+i+.5);this.context.lineTo(r+.5,a+i+.5);this.context.lineTo(r+.5,a+.5);this.context.stroke();this.context.globalAlpha=1},drawCursor:function(){if(!this.cursor.visible){return}var e=this.height-this.rulerHeight-this.effectsHeight-this.hScrollBarHeight;var t=this.cursor.pitch;var i=this.cursor.position;var r=this.music.instruments.currentInstrumentId;var a=this.cursor.duration;var s=this.cellWidth/this.partsPerBeat*a;var o=this.cellHeight;var l=this.pianoRollWidth-Math.round(this.scrollX)+i*this.cellWidth;var n=0;var h="#ff0000";if(t==-1){n=this.rulerHeight;+(this.gridHeight*this.cellHeight)-(t+1)*this.cellHeight;h=styles.music.effectsCursor}else{var d=this.music.instruments.getInstrument(r);if(typeof d!="undefined"){var c=this.music.instruments.getColor(r);h="#"+("000000"+c.toString(16)).substr(-6);var n=this.rulerHeight+this.effectsHeight+Math.round(this.scrollY)-(this.gridHeight*this.cellHeight-e)+this.gridHeight*this.cellHeight-(t+1)*this.cellHeight}}this.context.globalAlpha=.2;this.context.fillStyle=h;this.context.fillRect(l,n,s,o);if(t==-1){this.context.strokeStyle=styles.music.effectsCursorOutline}else{this.context.strokeStyle=styles.music.cursorOutline}this.context.beginPath();this.context.moveTo(l+.5,n+.5);this.context.lineTo(l+s+.5,n+.5);this.context.lineTo(l+s+.5,n+o+.5);this.context.lineTo(l+.5,n+o+.5);this.context.lineTo(l+.5,n+.5);this.context.stroke();this.context.globalAlpha=1},drawResizeNote:function(){if(this.currentNoteId===false||!this.inResize||this.inDrag){return}var e=this.height-this.rulerHeight-this.effectsHeight-this.hScrollBarHeight;var t=this.music.patterns.getNote(this.patternId,this.currentNoteId);var i=t.pos;var r=t.pit;var a=t.ins;var s=t.dur;s=s+this.resizeAmount;if(this.resizeDirection=="west"){i-=this.resizeAmount}var o="ff0000";if(a!=false){var o=this.music.instruments.getColor(a);o=("000000"+o.toString(16)).substr(-6)}var l=this.cellWidth/this.partsPerBeat*s;var n=this.cellHeight;var h=this.pianoRollWidth-Math.round(this.scrollX)+i*this.cellWidth;var d=this.rulerHeight+this.effectsHeight+Math.round(this.scrollY)-(this.gridHeight*this.cellHeight-e)+this.gridHeight*this.cellHeight-(r+1)*this.cellHeight;this.context.globalAlpha=.8;this.context.fillStyle="#"+o;this.context.fillRect(h,d,l,this.cellHeight);this.context.globalAlpha=1;this.context.beginPath();this.context.strokeStyle=styles.music.ghostNoteOutline;this.context.lineWidth=1;this.context.moveTo(h+.5,d+.5);this.context.lineTo(h+l+.5,d+.5);this.context.lineTo(h+l+.5,d+n+.5);this.context.lineTo(h+.5,d+n+.5);this.context.lineTo(h+.5,d+.5);this.context.stroke()},drawPattern:function(){if(this.patternId==-1||this.patternId>=this.music.doc.data.patterns.length){return}this.drawGrid();this.drawEffects();this.drawNotes()},drawGrid:function(){this.gridContext.fillStyle=styles.music.gridWhiteNotes;this.gridContext.fillRect(0,0,this.gridWidth*this.cellWidth,this.gridHeight*this.cellHeight);for(var e=0;e<this.gridHeight;e++){if(e>=96){}else{var t=e%12;if(t==1||t==3||t==6||t==8||t==10){this.gridContext.fillStyle=styles.music.gridBlackNotes;this.gridContext.fillRect(0,this.gridHeight*this.cellHeight-(e+1)*this.cellHeight,this.gridWidth*this.cellWidth,this.cellHeight)}}}this.gridContext.beginPath();this.gridContext.strokeStyle=styles.music.gridLines;for(var e=0;e<this.gridHeight;e++){if((e+3)%12!=0){this.gridContext.moveTo(0,e*this.cellHeight+.5);this.gridContext.lineTo(this.gridWidth*this.cellWidth,e*this.cellHeight+.5)}}for(var e=0;e<this.gridWidth;e++){if(e%16!=0){this.gridContext.moveTo(e*this.cellWidth+.5,0);this.gridContext.lineTo(e*this.cellWidth+.5,this.gridHeight*this.cellHeight)}}this.gridContext.stroke();this.gridContext.beginPath();this.gridContext.strokeStyle=styles.music.gridOctaveLines;for(var e=0;e<this.gridHeight;e++){if((e+3)%12==0){this.gridContext.moveTo(0,e*this.cellHeight+.5);this.gridContext.lineTo(this.gridWidth*this.cellWidth,e*this.cellHeight+.5)}}this.gridContext.stroke();this.gridContext.beginPath();this.gridContext.strokeStyle=styles.music.gridBeatLines;for(var e=0;e<this.gridWidth;e++){if(e%4==0&&e%16!=0){this.gridContext.moveTo(e*this.cellWidth+.5,0);this.gridContext.lineTo(e*this.cellWidth+.5,this.gridHeight*this.cellHeight)}}this.gridContext.stroke();this.gridContext.beginPath();this.gridContext.strokeStyle=styles.music.gridBarLines;for(var e=0;e<this.gridWidth;e++){if(e%16==0){this.gridContext.moveTo(e*this.cellWidth+.5,0);this.gridContext.lineTo(e*this.cellWidth+.5,this.gridHeight*this.cellHeight)}}this.gridContext.stroke()},drawPlayhead:function(){var e=this.pianoRollWidth+this.cellWidth*this.playheadPosition+.5-Math.round(this.scrollX);this.context.fillStyle="#bbbbbb";var t=13;var i=12;this.context.fillRect(e-t/2+.5,this.rulerHeight-i,t,i);this.context.beginPath();this.context.strokeStyle="#bbbbbb";this.context.moveTo(e,this.rulerHeight);this.context.lineTo(e,this.height);this.context.stroke()},updatePlayheadPosition:function(){this.playheadPosition=this.music.playheadPosition+this.music.playheadPositionFraction-this.music.getGlobalPosition(this.channel,this.trackIndex,0)},calculateScroll:function(){this.vScrollBarHeight=this.gridViewHeight;this.vScrollBarPositionHeight=this.vScrollBarHeight*this.gridViewHeight/(this.gridHeight*this.cellHeight);if(this.vScrollBarPositionHeight>this.vScrollBarHeight){this.vScrollBarPositionHeight=this.vScrollBarHeight}this.vScrollBarPosition=this.vScrollBarHeight-this.vScrollBarPositionHeight-Math.round(this.scrollY)*this.vScrollBarHeight/(this.gridHeight*this.cellHeight);this.hScrollBarWidth=this.gridViewWidth;this.hScrollBarPositionWidth=this.hScrollBarWidth*this.gridViewWidth/(this.gridWidth*this.cellWidth);if(this.hScrollBarPositionWidth>this.hScrollBarWidth){this.hScrollBarPositionWidth=this.hScrollBarWidth}this.hScrollBarPosition=this.scrollX*this.hScrollBarWidth/(this.gridWidth*this.cellWidth)},resize:function(e,t,i,r){this.left=e;this.top=t;this.width=i;this.height=r;this.context=this.canvas.getContext("2d");this.context.scale(this.uiComponent.getScale(),this.uiComponent.getScale())},render:function(){var e=getTimestamp();var t=e-this.lastTime;this.lastTime=e;if(e-this.lastScrollTime>30){if(this.xScrollSpeed!=0){this.lastScrollTime=e;this.setXScroll(this.scrollX+this.xScrollSpeed*4)}else if(this.yScrollSpeed!=0){this.lastScrollTime=e;this.setYScroll(this.scrollY-this.yScrollSpeed*4)}}if(this.context==null){this.context=this.canvas.getContext("2d")}this.context.fillStyle="#000000";this.context.clearRect(0,0,this.width,this.height);this.updatePlayheadPosition();this.gridViewWidth=this.width-this.pianoRollWidth-this.vScrollBarWidth;this.gridViewHeight=this.height-(this.effectsHeight+this.rulerHeight)-this.hScrollBarHeight;this.context.drawImage(this.gridCanvas,Math.round(this.scrollX),this.gridHeight*this.cellHeight-this.gridViewHeight-Math.round(this.scrollY),this.gridViewWidth,this.gridViewHeight,this.pianoRollWidth,this.rulerHeight+this.effectsHeight,this.gridViewWidth,this.gridViewHeight);this.drawSelectedNotes();this.drawResizeNote();if(this.cursor.visible&&this.cursor.pitch>=0){this.drawCursor()}this.drawCursorInfo();if(this.inSelect){var i=this.selectLeft-Math.round(this.scrollX)+this.pianoRollWidth;var r=this.height-(this.selectBottom-Math.round(this.scrollY));var a=this.selectRight-this.selectLeft;var s=this.selectBottom-this.selectTop;this.context.globalAlpha=.2;this.context.fillStyle=styles.music.selectFill;this.context.fillRect(i,r,a,s);this.context.globalAlpha=1;this.context.beginPath();this.context.strokeStyle=styles.music.selectOutline;this.context.moveTo(.5+this.selectLeft-Math.round(this.scrollX)+this.pianoRollWidth,.5+this.height-(this.selectBottom-Math.round(this.scrollY)));this.context.lineTo(.5+this.selectRight-Math.round(this.scrollX)+this.pianoRollWidth,.5+this.height-(this.selectBottom-Math.round(this.scrollY)));this.context.lineTo(.5+this.selectRight-Math.round(this.scrollX)+this.pianoRollWidth,.5+this.height-(this.selectTop-Math.round(this.scrollY)));this.context.lineTo(.5+this.selectLeft-Math.round(this.scrollX)+this.pianoRollWidth,.5+this.height-(this.selectTop-Math.round(this.scrollY)));this.context.lineTo(.5+this.selectLeft-Math.round(this.scrollX)+this.pianoRollWidth,.5+this.height-(this.selectBottom-Math.round(this.scrollY)));this.context.stroke()}this.context.drawImage(this.rulerCanvas,Math.round(this.scrollX),0,this.width-this.pianoRollWidth,this.rulerHeight+this.effectsHeight,this.pianoRollWidth,0,this.width-this.pianoRollWidth,this.rulerHeight+this.effectsHeight);if(this.cursor.visible&&this.cursor.pitch==-1){this.drawCursor()}this.drawPlayhead();this.context.drawImage(this.pianoRollCanvas,0,this.gridHeight*this.cellHeight-this.gridViewHeight-Math.round(this.scrollY),this.pianoRollWidth,this.gridViewHeight+this.hScrollBarHeight,0,this.rulerHeight+this.effectsHeight,this.pianoRollWidth,this.gridViewHeight+this.hScrollBarHeight);if(this.gridCanvas.width<this.gridViewWidth){this.context.fillStyle="#050505";this.context.fillRect(this.pianoRollWidth+this.gridCanvas.width,0,this.gridViewWidth-this.gridCanvas.width,this.gridViewHeight+this.rulerHeight+this.effectsHeight)}this.context.fillStyle="#111111";this.context.fillRect(0,0,this.pianoRollWidth,this.rulerHeight);this.context.fillStyle="#666666";this.context.fillRect(0,this.rulerHeight,this.pianoRollWidth,this.effectsHeight);this.context.font="10px Verdana";this.context.fillStyle="#dddddd";this.context.fillText("Effects:",4,this.rulerHeight+this.effectsHeight-4);this.calculateScroll();this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(this.pianoRollWidth,this.height-this.hScrollBarHeight,this.gridViewWidth,this.hScrollBarHeight);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.pianoRollWidth+this.hScrollBarPosition,this.height-this.hScrollBarHeight+1,this.hScrollBarPositionWidth,this.hScrollBarHeight-2);this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(this.width-this.vScrollBarWidth,this.rulerHeight+this.effectsHeight,this.vScrollBarWidth,this.gridViewHeight);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.width-this.vScrollBarWidth+1,this.rulerHeight+this.effectsHeight+this.vScrollBarPosition,this.vScrollBarWidth-2,this.vScrollBarPositionHeight)}};var PatternViewPopup=function(){this.music=null;this.uiComponent=null};PatternViewPopup.prototype={init:function(e,t){this.music=e;var i=this;this.uiComponent=UI.create("UI.Popup",{id:"patternViewPopup",width:300,height:300});this.htmlComponent=UI.create("UI.HTMLPanel",{html:'<span style="color: red">loading...</span>'});this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/music/patternViewPopup.html",function(){i.initEvents();if(typeof t!="undefined"){t()}})},initEvents:function(){var t=this;$(".patternViewPopupItem").on("click",function(){var e=$(this).attr("data-value");console.log("set mode to "+e);t.music.patternView.setMode(e);UI.hidePopup()})},recentInstrumentHtml:function(){var t=this;var e="";if(this.selectedInstrument!==false){e+='<div style="clear: both" class="ui-menu-item-separator">Selected Instrument</div>';var i=this.selectedInstrument;var r=this.music.instruments.getInstrument(i);var a="#"+((1<<24)+r.color).toString(16).slice(1);e+='<div class="ui-menu-item patternViewPopupInstrument"  data-value="'+i+'">';e+='<div style="margin-top: 2px; margin-right: 4px; display: inline-block; width: 12px; height: 12px; background-color: '+a+'"></div>';e+=r.name;e+="</div>";e+='<div class="ui-menu-item patternViewPopupEditInstrument"  data-value="'+i+'">';e+="Edit "+r.name;e+="</div>"}e+='<div style="clear: both" class="ui-menu-item-separator">Recent Instruments</div>';for(var s=this.music.instruments.recentInstruments.length-1;s>=0;s--){var i=this.music.instruments.recentInstruments[s];var r=this.music.instruments.getInstrument(i);var a="#"+((1<<24)+r.color).toString(16).slice(1);e+='<div class="ui-menu-item patternViewPopupInstrument"  data-value="'+i+'">';e+='<div style="margin-top: 2px; margin-right: 4px; display: inline-block; width: 12px; height: 12px; background-color: '+a+'"></div>';e+=r.name;e+="</div>"}$("#patternViewPopupInstruments").html(e);$(".patternViewPopupInstrument").on("click",function(){var e=parseInt($(this).attr("data-value"),10);t.music.instruments.selectInstrument(e,false);UI.hidePopup()});$(".patternViewPopupEditInstrument").on("click",function(){var e=parseInt($(this).attr("data-value"),10);t.music.setView("editInstrument");t.music.instruments.selectInstrument(e,false);t.music.editInstrument.editInstrument(parseInt(e));UI.hidePopup()})},show:function(e){var t=e.x;var i=e.y;this.selectedInstrument=false;if(typeof e["selectedInstrument"]!="undefined"){this.selectedInstrument=e["selectedInstrument"]}var r=this.music.patternView.getMode();$(".patternViewPopupCheck").html("");var a="";switch(r){case"draw":a="patternViewPopupDrawCheckmark";break;case"erase":a="patternViewPopupEraseCheckmark";break;case"select":a="patternViewPopupSelectCheckmark";break}$("#"+a).html("*");this.recentInstrumentHtml();var s=200;var o=300;this.uiComponent.setDimensions(s,o);UI.showPopup("patternViewPopup",t,i)}};var Tracks=function(){};Tracks.prototype={clearTracks:function(){this.music.doc.data.tracks=[]},createTrack:function(e){var t={};var i=this.music.doc.data.tracks.length+1;if(typeof e=="undefined"){t.name="Track "+i}else{t.name=e}t.patternInstances=[];var r=this.music.doc.data.tracks.length;t.trackId=r;this.music.doc.data.tracks.push(t);return r},init:function(e){this.music=e},removePattern:function(e,t){if(t!==false&&t<this.music.doc.data.tracks[e].patternInstances.length){this.music.doc.data.tracks[e].patternInstances.splice(t,1)}},getLength:function(e){var t=this.music.doc.data.tracks[e].patternInstances;if(t.length==0){return 0}var i=t.length-1;var r=this.music.patterns.getDuration(t[i].patternId);return t[i].position+r},getPatternIndexAt:function(e,t){var i=this.music.doc.data.tracks[e].patternInstances;var r=false;for(var a=0;a<i.length;a++){if(i[a].position>t){r=a;break}}if(r===false){if(i.length>0){r=i.length-1}}else{r=r-1}if(r<0||r===false){return false}return r},getPatternIdAtIndex:function(e,t){return this.music.doc.data.tracks[e].patternInstances[t]},getPatternPositionAtIndex:function(e,t,i){var r=this.music.doc.data.tracks[e].patternInstances;var a=this.music.patterns.getDuration(r[t].patternId);if(i>=r[t].position&&i<r[t].position+a){return i-r[t].position}return false},getPatternAt:function(e,t){var i=this.music.doc.data.tracks[e].patternInstances;var r=false;for(var a=0;a<i.length;a++){if(i[a].position>t){r=a;break}}if(r===false){if(i.length>0){r=i.length-1}}else{r=r-1}if(r<0||r===false){return false}var s=this.music.patterns.getDuration(i[r].patternId);if(t>=i[r].position&&t<i[r].position+s){return i[r].patternId}return false},getPatternPositionAt:function(e,t){var i=this.music.doc.data.tracks[e].patternInstances;var r=false;for(var a=0;a<i.length;a++){if(i[a].position>t){r=a;break}}if(r===false){if(i.length>0){r=i.length-1}}else{r=r-1}if(r<0||r===false){return false}var s=this.music.patterns.getDuration(i[r].patternId);if(t>=i[r].position&&t<i[r].position+s){return t-i[r].position}return false},getTrackData:function(e){return this.music.doc.data.tracks[e]},addPattern:function(e,t,i){var r=false;var a=this.music.doc.data.tracks[e].patternInstances;for(var s=0;s<a.length;s++){if(a[s].position>i){r=s;break}}var o=false;if(r===false){if(a.length>0){o=a.length-1}}else{if(r>0){o=r-1}}if(o!==false){if(o>=0){var l=a[o].patternId;var n=this.music.patterns.getDuration(l);var h=a[o].position+n;if(i<h){i=h}}}var d={patternId:t,position:i};if(r===false){a.push(d);return a.length-1}else{var c=this.music.patterns.getDuration(t);if(i+c>a[r].position){var f=i+c-a[r].position;for(var s=r;s<a.length;s++){a[s].position+=f}}a.splice(r,0,d);return r}},getGlobalPosition:function(e,t,i){var r=this.music.doc.data.tracks[e].patternInstances;if(t>=0&&t<r.length){return r[t].position+i}return 0}};var TrackView=function(){this.music=null;this.mode="draw";this.lastClickTime=0;this.mouseDragPlayhead=false;this.mouseCaptured=false;this.patterns=[];this.lastMouseX=0;this.lastMouseY=0;this.movingPlayhead=false;this.selectedTrack=0;this.selectedPosition=0;this.highlightedTrack=false;this.highlightedPatternIndex=false;this.selectedTrack=false;this.selectedPatternIndex=false;this.selectedpatternId=0;this.trackCanvas=null;this.trackInfoCanvas=null;this.trackHeight=22;this.trackInfoWidth=100;this.rulerHeight=20;this.patternCellWidth=2;this.cursor={track:0,duration:64,position:128,type:"add",visible:false};this.scrollClick=false;this.vScrollBarWidth=styles.ui.scrollbarWidth;this.vScrollBarHeight=0;this.vScrollBarPosition=null;this.vScrollBarPositionMin=0;this.vScrollBarPositionMax=0;this.vScrollBarPositionMouseOffset=0;this.vScroll=false;this.hScrollBarHeight=styles.ui.scrollbarWidth;this.hScrollBarWidth=0;this.hScrollBarPosition=null;this.hScrollBarPositionMin=0;this.hScrollBarPositionMax=0;this.hScrollBarPositionMouseOffset=0;this.hScroll=false;this.scrollX=0;this.scrollY=0;this.mouseDownAtScrollX=0;this.mouseDownAtScrollY=0;this.muteIcon=null;this.unmuteIcon=null;this.context=null};TrackView.prototype={buildInterface:function(e){var t=this;this.uiComponent=e;this.canvas=this.uiComponent.getCanvas();this.trackCanvas=document.createElement("canvas");this.trackInfoCanvas=document.createElement("canvas");this.rulerCanvas=document.createElement("canvas");this.initAddPatternDialog();this.initEditPatternDialog();UI.on("ready",function(){t.initEvents()})},tracksUpdated:function(){if(typeof this.music.doc.data.tracks!="undefined"){this.setTrackSize(this.music.doc.data.tracks.length,128*16)}},initEvents:function(){var a=this;this.uiComponent.on("resize",function(e,t,i,r){a.resize(e,t,i,r)});this.canvas.addEventListener("mousedown",function(e){a.mouseDown(e)},false);this.canvas.addEventListener("mousemove",function(e){a.mouseMove(e)},false);this.canvas.addEventListener("mouseup",function(e){a.mouseUp(e)},false);this.canvas.addEventListener("wheel",function(e){a.mouseWheel(e)},false);this.canvas.addEventListener("mouseleave",function(e){a.cursor.visible=false},false);this.canvas.addEventListener("mouseenter",function(e){},false)},init:function(e){this.music=e;this.patternsLoaded=false;this.selectedPatternIndex=0;this.selectedTrack=0;this.muteIcon=document.createElement("img");this.muteIcon.src="icons/svg/glyphicons-halflings-96-volume-off.svg";this.unmuteIcon=document.createElement("img");this.unmuteIcon.src="icons/svg/glyphicons-halflings-98-volume-up.svg"},loadPatterns:function(){return;this.patterns=[];for(var e=0;e<this.music.doc.data.tracks.length;e++){this.patterns[e]=[];var t=0;for(var i=0;i<this.music.doc.data.tracks[e].length;i++){var r=this.music.doc.data.tracks[e][i];if(this.music.doc.data.patterns[r].name.indexOf("BLANK")!==0){this.patterns[e].push({patternID:r,position:t})}t+=this.music.doc.data.patterns[r].getLength()}}this.setPatterns()},sortPatterns:function(e){var t=[];if(typeof e!="undefined"){t.push(e)}else{for(var i=0;i<this.patterns.length;i++){t.push(i)}}for(var i=0;i<t.length;i++){var r=t[i];this.patterns[r].sort(function(e,t){return e.position-t.position})}},setPatterns:function(){return;var e=0;this.sortPatterns();for(var t=0;t<this.music.doc.data.tracks.length;t++){var i=this.patterns[t].length-1;if(i>=0){var r=this.patterns[t][i].patternID;var a=this.patterns[t][i].position+this.music.doc.data.patterns[r].getLength();if(a>e){e=a}}}var s=[];for(var t=0;t<this.music.doc.data.tracks.length;t++){s[t]=[];var o=0;for(var l=0;l<this.patterns[t].length;l++){var n=this.patterns[t][l].patternID;var h=this.patterns[t][l].position;if(h>o){var d=h-o;var c=this.getBlankPatternID(d);s[t].push(c)}this.patterns[t][l].patternPosition=s[t].length;s[t].push(n);o=h+this.music.doc.data.patterns[n].getLength()}if(o<e){var c=this.getBlankPatternID(e-o);s[t].push(c)}}this.music.doc.data.tracks=s},getBlankPatternID:function(e){console.error("get blank pattern!!!");var t=-1;for(var i=0;i<this.music.doc.data.patterns.length;i++){if(this.music.doc.data.patterns[i].name=="BLANK "+e){if(this.music.doc.data.patterns[i].getLength()==e){return i}}}if(t<0){var r=new Pattern;r.init("BLANK "+e,e);var t=this.music.doc.data.patterns.length;this.music.doc.data.patterns.push(r)}return t},insertBlankPatterns:function(){for(var e=0;e<this.music.doc.data.tracks.length;e++){var t=this.music.doc.data.tracks[e].length-1;for(var i=this.music.doc.data.tracks[e].length-1;i>=0;i--){var r=this.music.doc.data.tracks[e][i];t=i;if(this.music.doc.data.patterns[r].name.indexOf("BLANK")===0){}else{break}}t++;if(t!=this.music.doc.data.tracks[e].length){this.music.doc.data.tracks[e].splice(t,this.music.doc.data.tracks[e].length-t)}}var a=0;var s=[];for(var e=0;e<this.music.doc.data.tracks.length;e++){s[e]=0;for(var i=0;i<this.music.doc.data.tracks[e].length;i++){var r=this.music.doc.data.tracks[e][i];s[e]+=this.music.doc.data.patterns[r].getLength()}if(s[e]>a){a=s[e]}}for(var e=0;e<s.length;e++){var o=a-s[e];if(o>0){var l=this.getBlankPatternID(o);this.music.doc.data.tracks[e].push(l)}}},movePattern:function(e,t,i,r){var a=this.music.doc.data.tracks[e];var s=a.patternInstances[t].patternId;this.music.tracks.removePattern(e,t);var o=this.music.doc.data.tracks[i];var l=this.music.tracks.addPattern(i,s,r);this.selectPattern(i,l);this.drawPatterns()},setMode:function(e){console.error("shouldnt call SET MODE??");switch(e){case"draw":$(".sidTrack").css("cursor","url(images/pen.png) 0 0, pointer");$(".sidPattern").css("cursor","default");break;case"erase":$(".sidTrack").css("cursor","url(images/eraser.png) 2 14, pointer");$(".sidPattern").css("cursor","url(images/eraser.png) 2 14, pointer");break}this.mode=e},initAddPatternDialog:function(){var s=this;this.addPatternDialog=UI.create("UI.Dialog",{id:"addPatternDialog",title:"Add A Pattern",width:640});var e="";this.addPatternDialogHTML=UI.create("UI.HTMLPanel",{html:e});this.addPatternDialog.add(this.addPatternDialogHTML);this.addPatternDialogHTML.load("html/music/addAPatternDialog.html",function(){var e="";for(var t=4;t<=256;t+=4){e+='<option value="'+t+'"';if(t==64){e+=' selected="selected" '}e+=">"+t+"</option>"}$("#sidPatternLength").html(e);$('input[name="sidAddPattern"]').on("click",s.setAddPatternType)});this.addPatternOkButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.addPatternDialog.addButton(this.addPatternOkButton);this.addPatternOkButton.on("click",function(e){var t=$('input[name="sidAddPattern"]:checked').val();if(t=="create"){var i=$("#sidPatternName").val();var r=parseInt($("#sidPatternLength").val());s.addPattern(s.selectedTrack,s.selectedPosition,r,i)}else if(t=="existing"){var a=parseInt($("#sidExistingPatterns").val());s.addExistingPattern(s.selectedTrack,s.selectedPosition,a)}s.cursor.visible=false;UI.closeDialog()});this.addPatternCloseButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.addPatternDialog.addButton(this.addPatternCloseButton);this.addPatternCloseButton.on("click",function(e){UI.closeDialog()});var t=this},initEditPatternDialog:function(){var a=this;var e="";for(var t=4;t<=256;t+=4){e+='<option value="'+t+'"';if(t==64){e+=' selected="selected" '}e+=">"+t+"</option>"}$("#sidEditPatternLength").html(e);$("#sidEditPatternDialogOK").on("click",function(){var e=$('input[name="sidEditPattern"]:checked').val();if(e=="rename"){var t=$("#sidPatternEditName").val();a.renamePattern(a.selectedPatternId,t);var i=parseInt($("#sidEditPatternLength").val());a.setPatternLength(a.selectedPatternId,i)}else if(e=="replace"){var r=parseInt($("#sidPatternReplaceWith").val());a.replacePattern(a.selectedTrack,a.selectedPosition,r)}a.music.editor.hideDialog()});$("#sidEditPatternDialogCancel").on("click",function(){a.music.editor.hideDialog()});$('input[name="sidEditPattern"]').on("click",this.setEditPatternType)},setTrackSize:function(e,t){this.trackCount=e;this.trackLength=t;this.canvasScale=this.uiComponent.getScale();this.trackCanvas.height=e*this.trackHeight*this.canvasScale;this.trackCanvas.width=t*this.patternCellWidth*this.canvasScale;this.trackContext=this.trackCanvas.getContext("2d");this.trackContext.scale(this.canvasScale,this.canvasScale);this.trackInfoCanvas.height=(e*this.trackHeight+this.rulerHeight)*this.canvasScale;this.trackInfoCanvas.width=this.trackInfoWidth*this.canvasScale;this.trackInfoContext=this.trackInfoCanvas.getContext("2d");this.trackInfoContext.scale(this.canvasScale,this.canvasScale);this.rulerCanvas.height=this.rulerHeight*this.canvasScale;this.rulerCanvas.width=t*this.patternCellWidth*this.canvasScale;this.rulerContext=this.rulerCanvas.getContext("2d");this.rulerContext.scale(this.canvasScale,this.canvasScale);this.drawGrid();this.drawRuler();this.drawTrackInfo();this.drawPatterns();this.setTrackDimensions()},getHTML:function(){console.log("TRACK VIEW GET HTML");return;var e=[true,true,true];if(typeof SIDplayer!="undefined"&&SIDplayer){e=SIDplayer.getChannelOn()}this.loadPatterns();for(var t=0;t<this.music.doc.data.tracks.length;t++){var i="";var r=t+1;i+='<div class="sidTrackLabel" style="position: absolute; ';i+=" width: 92px; top: 1px; left: 0px;";i+=' height: 16px; padding: 2px"><label><input type="checkbox" id="channel'+r+'"';if(e[t]){i+=' checked="checked" '}i+="> Channel "+r+"</label></div>";var a=this.patternStart;for(var s=0;s<this.patterns[t].length;s++){var o=this.patterns[t][s].patternID;var l=this.patterns[t][s].position;var n=this.music.doc.data.patterns[o];var h=n.getLength();a=this.patternStart+l;i+='<div class="sidPattern" channel="'+t+'" position="'+s+'" id="sidPattern'+t+"_"+s+'" pattern="'+o+'"';var d=2;var c=1;var f=h-2*d-c;i+=' style="position: absolute; padding: '+d+"px;";i+=" border: "+c+"px solid #aaaaaa;";i+=" width: "+f+"px; height: 16px;";i+=" top: 0px;";i+=" left: "+a+'px"';i+=">";i+=n.name;i+="</div>"}var f=64;i+='<div id="sidAddPattern'+t+'" ';i+=' style="position: absolute; display: none; padding: '+d+"px;";i+=" border: "+c+"px solid #aaaaaa;";i+=" width: "+f+"px; height: 16px;";i+=" top: 0px;";i+=" left: "+a+'px"';i+=">";i+="+ Pattern";i+="</div>";$("#sidTrack"+t).html(i)}},setAddPatternType:function(){var e=$('input[name="sidAddPattern"]:checked').val();if(e=="create"){$("#sidAddPatternCreateControl").show();$("#sidAddPatternLengthControl").show();$("#sidAddPatternExistingControl").hide()}else if(e=="existing"){$("#sidAddPatternCreateControl").hide();$("#sidAddPatternLengthControl").hide();$("#sidAddPatternExistingControl").show()}},showAddPattern:function(e,t,i){if(typeof i=="undefined"){i=64}$("#sidPatternLength").val(i);this.selectedTrack=e;this.selectedPosition=t;var r="";for(var a=0;a<this.music.doc.data.patterns.length;a++){r+='<option value="'+a+'">';r+=this.music.doc.data.patterns[a].name;r+="</option>"}var s=this.music.doc.data.patterns.length+1;var o="Pattern "+s;$("#sidPatternName").val(o);$("#sidExistingPatterns").html(r);this.setAddPatternType();UI.showDialog("addPatternDialog")},addPattern:function(e,t,i,r){var a=parseInt(i);var s=this.music.patterns.createPattern(r,a);var o=this.music.tracks.addPattern(e,s,t);this.selectPattern(e,o);this.drawPatterns()},addExistingPattern:function(e,t,i){var r=this.music.tracks.addPattern(e,i,t);this.selectPattern(e,r);this.drawPatterns()},erasePattern:function(e,t){this.music.tracks.removePattern(e,t);this.drawPatterns()},renamePattern:function(e,t){this.music.doc.data.patterns[e].name=t;this.drawPatterns()},setPatternLength:function(e,t){t=parseInt(t);if(this.music.patterns.getDuration(e)!=t){this.music.patterns.setDuration(e,t);this.drawPatterns();this.music.patternView.patternLengthUpdated();console.error("need to check if all pattern instances will fit")}},replacePattern:function(e,t,i){this.music.doc.data.tracks[e][t]=i;this.drawPatterns();this.music.updateSid(true)},setEditPatternType:function(){var e=$('input[name="sidEditPattern"]:checked').val();if(e=="rename"){$("#sidEditPatternNameControl").show();$("#sidEditPatternReplaceControl").hide()}else if(e=="replace"){$("#sidEditPatternNameControl").hide();$("#sidEditPatternReplaceControl").show()}},showEditPattern:function(e){var t="";for(var i=0;i<this.music.doc.data.patterns.length;i++){if(this.music.doc.data.patterns[i].name.indexOf("BLANK")!==0){t+='<option value="'+i+'">';t+=this.music.doc.data.patterns[i].name;t+="</option>"}}$("#sidPatternEditName").val(this.music.doc.data.patterns[e].name);$("#sidEditPatternLength").val(this.music.doc.data.patterns[e].duration);$("#sidPatternReplaceWith").html(t);this.setEditPatternType();this.music.editor.showDialog("sidEditPatternDialog")},selectPattern:function(e,t){this.selectedTrack=e;this.selectedPatternIndex=t;var i=this.music.doc.data.tracks[e];this.selectedPatternId=i.patternInstances[t].patternId;var r=i.patternInstances[t].position;this.music.selectFrom=r;this.music.selectTo=this.music.selectFrom+this.music.patterns.getDuration(this.selectedPatternId);this.music.patternView.setPattern(this.selectedPatternId,e,t)},mouseToTrack:function(e){e=this.height-e-3;e-=this.rulerHeight;e=e+this.scrollY/this.canvasScale;var t=Math.floor(e/this.trackHeight);if(t<0||t>=this.music.doc.data.tracks.length){t=-1}return t},mouseToPatternIndex:function(e,t){e=e-this.trackInfoWidth;if(t<0||t===false||isNaN(t)){return false}var i=this.music.doc.data.tracks;if(t>=i.length){return false}var r=i[t];if(r.patternInstances.length==0){return false}this.previousPatternIndex=-1;this.nextPatternIndex=9999;for(var a=0;a<r.patternInstances.length;a++){var s=r.patternInstances[a].patternId;var o=r.patternInstances[a].position;var l=this.music.patterns.getDuration(s);if(e>=o*this.patternCellWidth&&e<=(o+l)*this.patternCellWidth){return a}if(e>=(o+l)*this.patternCellWidth){if(this.previousPatternIndex<a){this.previousPatternIndex=a}}if(e<o*this.patternCellWidth){if(this.nextPatternIndex>a){this.nextPatternIndex=a}}}return false},mouseToTrackPosition:function(e,t){if(typeof t!="undefined"&&t<this.height-this.rulerHeight){return-1}e=e-this.trackInfoWidth;if(e<0){return-1}var i=Math.floor(e/this.patternCellWidth);return i},mouseDownVScroll:function(e,t,i){if(i*this.canvasScale<this.rulerCanvas.height+this.vScrollBarPosition){this.setYScroll(this.scrollY-40)}else if(i*this.canvasScale>this.rulerCanvas.height+this.vScrollBarPosition+this.vScrollBarPositionHeight){this.setYScroll(this.scrollY+40)}else{this.vScroll=true}this.render()},mouseDownHScroll:function(e,t,i){t=t-this.trackInfoWidth;if(t*this.canvasScale<this.hScrollBarPosition){this.setXScroll(this.scrollX-40)}else if(t*this.canvasScale>this.hScrollBarPosition+this.hScrollBarPositionWidth){this.setXScroll(this.scrollX+40)}else{this.hScroll=true}this.render()},mouseDownRuler:function(e,t,i){if(e==0){var r=this.mouseToTrackPosition(t,i);if(r>-1){this.movingPlayhead=true;this.music.setPlayheadPosition(r)}}},mouseWheel:function(e){e.stopPropagation();e.preventDefault()},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){if(UI.os=="Mac OS"){this.buttons=2}}},toggleMute:function(e){this.music.setMute(e,!this.music.getMute(e));this.drawTrackInfo();this.render()},mouseDown:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;this.mouseCaptured=false;var r=0;this.buttons=1;if(!UI.isMobile.any()){r=e.button;this.setButtons(e);if(this.buttons&2){return}if(this.buttons&1){this.leftMouseUp=false}UI.captureMouse(this);this.mouseCaptured=true;this.mouseIsDown=true}this.scrollMouseDownAtX=t;this.scrollMouseDownAtY=i;this.mouseDownAtScrollX=this.scrollX;this.mouseDownAtScrollY=this.scrollY;if(t>this.width-this.vScrollBarWidth-1&&i<this.height&&i>this.rulerHeight){this.scrollClick=true;return this.mouseDownVScroll(r,t,i)}if(t>this.trackInfoWidth&&i>this.height-this.hScrollBarHeight){this.scrollClick=true;return this.mouseDownHScroll(r,t,i)}i=this.height-i;if(r==1){return}this.movingPlayhead=false;this.cursor.type="add";this.cursor.dragPatternIndex=false;this.mouseDownAtScrollX=this.scrollX;this.mouseDownAtScrollY=this.scrollY;if(i>this.height-this.rulerHeight){t=t+this.scrollX/this.canvasScale;return this.mouseDownRuler(r,t,i)}var a=this.mouseToTrack(i);if(a<0||typeof a=="undefined"||a>=this.music.doc.data.tracks.length){return}if(t<this.trackInfoWidth){if(t<20){UI.setCursor("pointer");if(a>=0)this.toggleMute(a)}else{UI.setCursor("default")}return}t=t+this.scrollX/this.canvasScale;this.mouseDownAtX=t;this.mouseDownAtY=i;var s=this.mouseToPatternIndex(t,a);this.highlightedTrack=a;this.highlightedPatternIndex=s;if(this.highlightedTrack!==false&&this.highlightedPatternIndex!==false){this.selectedTrack=this.highlightedTrack;this.selectedPatternIndex=this.highlightedPatternIndex;var a=this.music.doc.data.tracks[this.selectedTrack];var o=a.patternInstances[this.highlightedPatternIndex].patternId;var l=a.patternInstances[this.highlightedPatternIndex].position;var n=this.music.patterns.getDuration(o);var h=(l+n)*this.patternCellWidth;var d=t-this.trackInfoWidth;if(h-d<8){this.cursor.resizePatternIndex=this.highlightedPatternIndex;this.cursor.resizePatternTrack=this.highlightedTrack;this.cursor.resizePatternId=o;this.cursor.duration=n;this.cursor.position=l;this.cursor.track=this.highlightedTrack;this.cursor.type="resize"}else{this.cursor.dragOffsetX=d-l*this.patternCellWidth;this.cursor.dragPatternIndex=this.highlightedPatternIndex;this.cursor.dragPatternTrack=this.highlightedTrack;this.cursor.dragPatternID=o;this.cursor.duration=n;this.cursor.type="drag"}if(this.mode=="draw"||this.mode=="select"){this.selectPattern(this.selectedTrack,this.selectedPatternIndex)}}this.drawPatterns()},mouseWheel:function(e,t){e.stopPropagation();e.preventDefault();var i=normalizeWheel(e);var r=4;this.setYScroll(this.scrollY+i.spinY*r);this.setXScroll(this.scrollX+i.spinX*r);this.render()},dragView:function(e,t,i,r){this.setYScroll(this.scrollY-r);this.setXScroll(this.scrollX-i);this.render()},mouseMoveVScroll:function(e,t,i,r){var a=this.vScrollBarHeight/this.tracksHeight;var s=(t-this.scrollMouseDownAtY)/a;this.setYScroll(this.mouseDownAtScrollY+s);this.render()},mouseMoveHScroll:function(e,t,i,r){var a=this.hScrollBarWidth/this.tracksWidth;var s=(e-this.scrollMouseDownAtX)/a*this.canvasScale;this.setXScroll(this.mouseDownAtScrollX+s);this.render()},mouseMove:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;var r=t-this.lastMouseX;var a=i-this.lastMouseY;this.lastMouseX=t;this.lastMouseY=i;if(this.buttons&4){UI.setCursor("drag-scroll");this.scrollClick=true;this.dragView(t,i,r,a);return}if(this.hScroll||t>this.trackInfoWidth&&i>this.height-this.hScrollBarHeight){UI.setCursor("default");if(this.hScroll){this.mouseMoveHScroll(t,i,r,a)}return}if(this.vScroll||t>this.width-this.vScrollBarWidth&&i<this.height-this.rulerHeight){UI.setCursor("default");if(this.vScroll){this.mouseMoveVScroll(t,i,r,a)}return}i=this.height-i;var s=false;var o=false;this.cursor.visible=false;if(this.movingPlayhead){t+=this.scrollX/this.canvasScale;var l=this.mouseToTrackPosition(t);if(l>-1){this.music.setPlayheadPosition(l)}this.setHighlightedPattern(s,o);return}if(i>this.height-this.rulerHeight){UI.setCursor("ew-resize");this.setHighlightedPattern(s,o);return}var n=this.mouseToTrack(i);if(n<0||isNaN(n)){UI.setCursor("default");this.setHighlightedPattern(s,o);return}if(t<this.trackInfoWidth){if(t<20){UI.setCursor("pointer")}else{UI.setCursor("default")}this.setHighlightedPattern(s,o);return}t+=this.scrollX/this.canvasScale;if(this.cursor.type=="drag"){var h=Math.floor((t-this.trackInfoWidth-this.cursor.dragOffsetX)/this.patternCellWidth);h=Math.floor(h/16)*16;if(h<0){h=0}this.cursor.track=n;this.cursor.position=h;this.cursor.visible=true;UI.setCursor("move")}else if(this.cursor.type=="resize"){var r=t-this.mouseDownAtX;var d=r/this.patternCellWidth;d=Math.floor(d/16)*16;var c=this.music.patterns.getDuration(this.cursor.resizePatternId)+d;if(c<16){c=16}this.cursor.duration=c;this.cursor.visible=true}else{var f=this.mouseToPatternIndex(t,n);s=n;o=f;if(o===false&&s!==false){if(this.mode=="erase"){UI.setCursor("default");this.cursor.visible=false}else{var h=Math.floor((t-this.trackInfoWidth)/this.patternCellWidth);h=Math.floor(h/16)*16;this.cursor.track=s;this.cursor.position=h;this.cursor.duration=64;this.cursor.visible=true;UI.setCursor("draw")}}else{if(this.mode=="erase"){UI.setCursor("erase")}else{var n=this.music.doc.data.tracks[s];var u=n.patternInstances[o].patternId;var l=n.patternInstances[o].position;var c=this.music.patterns.getDuration(u);var p=(l+c)*this.patternCellWidth;var v=t-this.trackInfoWidth;if(p-v<8){UI.setCursor("e-resize")}else{UI.setCursor("can-move")}}}}this.setHighlightedPattern(s,o)},setHighlightedPattern:function(e,t){if(this.highlightedTrack!==e||this.highlightedPatternIndex!==t){this.highlightedTrack=e;this.highlightedPatternIndex=t;this.drawPatterns()}},mouseUp:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;this.buttons=0;i=this.height-i;var r=e.ui_button;if(this.hScroll||this.vScroll||this.scrollClick){this.vScroll=false;this.hScroll=false;this.scrollClick=false}else{if(this.highlightedPatternIndex===false&&this.highlightedTrack!==false){if(this.mode!="erase"){this.cursor.track=this.highlightedTrack;this.cursor.duration=64;this.cursor.visible=true}}if(this.selectedTrack!==false&&this.highlightedPatternIndex!==false){if(this.mode=="erase"){if(confirm("Are you sure you want to delete this pattern?")){this.erasePattern(this.selectedTrack,this.selectedPatternIndex)}}}else if(this.cursor.type=="add"&&this.cursor.visible){this.showAddPattern(this.cursor.track,this.cursor.position,this.cursor.duration)}else if(this.cursor.type=="drag"&&this.cursor.visible){this.movePattern(this.cursor.dragPatternTrack,this.cursor.dragPatternIndex,this.cursor.track,this.cursor.position);this.cursor.visible=false}else if(this.cursor.type=="resize"&&this.cursor.visible){var a=this.cursor.resizePatternId;var s=this.cursor.duration;var o=this.music.patterns.getDuration(a);if(s!=o){var l=this.cursor.track;var n=this.cursor.position;this.setPatternLength(a,s);this.drawPatterns();this.cursor.visible=false}}}this.movingPlayhead=false;this.cursor.type="add";this.cursor.dragPatternIndex=false},drawRuler:function(){this.rulerContext.fillStyle="#3d3d3d";this.rulerContext.fillRect(0,0,this.rulerCanvas.width,this.rulerCanvas.height);this.rulerContext.beginPath();this.rulerContext.strokeStyle="#555555";this.rulerContext.font="8px Verdana";this.rulerContext.fillStyle="#eeeeee";for(var e=0;e<this.trackLength;e++){if(e%16==0){this.rulerContext.moveTo(e*this.patternCellWidth+.5,2);this.rulerContext.lineTo(e*this.patternCellWidth+.5,this.rulerCanvas.height/this.canvasScale);var t=1+e/16;this.rulerContext.fillText(t,e*this.patternCellWidth+4,this.rulerCanvas.height/this.canvasScale-9)}else{this.rulerContext.moveTo(e*this.patternCellWidth+.5,this.rulerCanvas.height/this.canvasScale-1*this.rulerCanvas.height/this.canvasScale/4);this.rulerContext.lineTo(e*this.patternCellWidth+.5,this.rulerCanvas.height/this.canvasScale)}}this.rulerContext.stroke()},drawPlayhead:function(){var e=this.trackInfoWidth+this.patternCellWidth*this.music.playheadPosition+.5-Math.round(this.scrollX/this.canvasScale);this.context.fillStyle="#bbbbbb";var t=8;var i=7;this.context.fillRect((e-t/2+.5)*this.canvasScale,(this.rulerHeight-i-1)*this.canvasScale,t*this.canvasScale,i*this.canvasScale);this.context.beginPath();this.context.strokeStyle="#bbbbbb";this.context.moveTo(e*this.canvasScale,(this.rulerHeight-1)*this.canvasScale);this.context.lineTo(e*this.canvasScale,(this.rulerHeight-1)*this.canvasScale+this.tracksHeight);this.context.stroke()},drawTrackInfo:function(){this.trackInfoContext.fillStyle="#333333";this.trackInfoContext.fillRect(0,0,this.trackInfoCanvas.width,this.trackInfoCanvas.height);this.trackInfoContext.fillStyle="#2e2e2e";this.trackInfoContext.fillRect(0,this.rulerHeight,this.trackInfoCanvas.width,this.trackInfoCanvas.height-this.rulerHeight);this.trackInfoContext.beginPath();this.trackInfoContext.strokeStyle="#222222";this.trackInfoContext.font="11px Verdana";this.trackInfoContext.fillStyle="#eeeeee";for(var e=0;e<this.music.doc.data.tracks.length;e++){var t=this.music.doc.data.tracks[e];this.trackInfoContext.moveTo(0,this.rulerHeight+e*this.trackHeight+.5);this.trackInfoContext.lineTo(this.trackInfoCanvas.width,this.rulerHeight+e*this.trackHeight+.5);this.trackInfoContext.fillText(t.name,26,this.rulerHeight+e*this.trackHeight+15);var i=this.unmuteIcon;if(this.music.getMute(e)){i=this.muteIcon}if(i){this.trackInfoContext.filter="invert(80%)";var r=16;var a=i.naturalWidth*r/i.naturalHeight;this.trackInfoContext.drawImage(i,5,this.rulerHeight+e*this.trackHeight+3,a,r);this.trackInfoContext.filter="none"}}this.trackInfoContext.stroke()},drawGrid:function(){this.trackContext.fillStyle="#333333";this.trackContext.fillRect(0,0,this.trackCanvas.width,this.trackCanvas.height);this.trackContext.beginPath();this.trackContext.strokeStyle="#555555";for(var e=0;e<this.trackLength;e+=16){this.trackContext.moveTo(e*this.patternCellWidth+.5,0);this.trackContext.lineTo(e*this.patternCellWidth+.5,this.trackCanvas.height)}this.trackContext.stroke();this.trackContext.beginPath();this.trackContext.strokeStyle="#222222";for(var e=0;e<this.music.doc.data.tracks.length;e++){this.trackContext.moveTo(0,e*this.trackHeight+.5);this.trackContext.lineTo(this.trackCanvas.width,e*this.trackHeight+.5)}this.trackContext.stroke()},drawCursor:function(){if(!this.cursor.visible){return}var e=this.patterns.length;var t=this.height-this.rulerHeight-this.hScrollBarHeight;var i=this.cursor.track;var r=this.cursor.position;var a=this.cursor.duration*this.patternCellWidth;var s=this.trackHeight-4;var o=this.trackInfoWidth-Math.round(this.scrollX/this.canvasScale)+r*this.patternCellWidth;var l=0;var l=this.rulerHeight-Math.round(this.scrollY/this.canvasScale)+i*this.trackHeight+2;var n="aaaaff";var h="ffffff";this.context.globalAlpha=.4;this.context.fillStyle="#"+n;this.context.fillRect(o*this.canvasScale,l*this.canvasScale,a*this.canvasScale,s*this.canvasScale);if(this.cursor.type=="add"){this.context.font="10px Verdana";this.context.fillStyle="#"+h;this.context.fillText("New Pattern",(o+4)*this.canvasScale,(l+12)*this.canvasScale)}else if(this.cursor.type=="drag"){if(this.cursor.dragPatternIndex!==false){var d=this.music.doc.data.patterns[this.cursor.dragPatternID].name;this.context.font="10px Verdana";this.context.fillStyle="#"+h;this.context.fillText(d,(o+4)*this.canvasScale,(l+12)*this.canvasScale)}}this.context.beginPath();this.context.strokeStyle="#ffffff";this.context.moveTo((o+.5)*this.canvasScale,(l+.5)*this.canvasScale);this.context.lineTo((o+a+.5)*this.canvasScale,(l+.5)*this.canvasScale);this.context.lineTo((o+a+.5)*this.canvasScale,(l+s+.5)*this.canvasScale);this.context.lineTo((o+.5)*this.canvasScale,(l+s+.5)*this.canvasScale);this.context.lineTo((o+.5)*this.canvasScale,(l+.5)*this.canvasScale);this.context.stroke();this.context.globalAlpha=1},drawPatterns:function(){var e=false;this.drawGrid();var t=this.music.doc.data.tracks;for(var i=0;i<t.length;i++){for(var r=0;r<t[i].patternInstances.length;r++){var a=t[i].patternInstances[r];var s=a.patternId;var o=a.position;var l=this.music.patterns.getDuration(s);var n=this.music.patterns.getName(s);var h=o*this.patternCellWidth;var d=i*this.trackHeight+2;var c=l*this.patternCellWidth-1;var f=this.trackHeight-4;var u="444444";var p="eeeeee";var v="555555";if(i===this.selectedTrack&&r==this.selectedPatternIndex){u="dddddd";v="dfdfdf";p="333333"}else if(i==this.highlightedTrack&&this.highlightedPatternIndex==r){u="606060";p="eeeeee"}else if(s===this.selectedPatternId){u="777777";p="333333"}this.trackContext.fillStyle="#"+u;this.trackContext.fillRect(h,d,c,f);this.trackContext.fillStyle="#"+p;this.trackContext.fillText(n,h+4,d+12);this.trackContext.beginPath();this.trackContext.font="9px Verdana";this.trackContext.strokeStyle="#"+v;this.trackContext.moveTo(h+.5,d+.5);this.trackContext.lineTo(h+c+.5,d+.5);this.trackContext.lineTo(h+c+.5,d+f+.5);this.trackContext.lineTo(h+.5,d+f+.5);this.trackContext.lineTo(h+.5,d+.5);this.trackContext.stroke()}}return;this.trackContext.beginPath();this.trackContext.strokeStyle="#aaaaaa";this.trackContext.font="9px Verdana";for(var i=0;i<this.patterns.length;i++){for(var r=0;r<this.patterns[i].length;r++){var g=this.patterns[i][r].patternID;var o=this.patterns[i][r].position;var m=this.music.doc.data.patterns[g];var y=m.getLength();var h=o*this.patternCellWidth;var d=i*this.trackHeight+2;var c=y*this.patternCellWidth-1;var f=this.trackHeight-4;var u="444444";var p="eeeeee";if(i===this.selectedTrack&&r==this.selectedPatternIndex){u="dddddd";p="333333"}else if(g==this.selectedPatternId){u="777777";p="333333"}this.trackContext.fillStyle="#"+u;this.trackContext.fillRect(h,d,c,f);this.trackContext.fillStyle="#"+p;this.trackContext.fillText(m.name,h+4,d+12);if(!e){this.trackContext.moveTo(h+.5,d+.5);this.trackContext.lineTo(h+c+.5,d+.5);this.trackContext.lineTo(h+c+.5,d+f+.5);this.trackContext.lineTo(h+.5,d+f+.5);this.trackContext.lineTo(h+.5,d+.5)}}}this.trackContext.stroke()},resize:function(e,t,i,r){if(typeof e!="undefined"){this.left=e;this.top=t;this.width=i;this.height=r}this.context=this.canvas.getContext("2d");this.setTrackDimensions()},setTrackDimensions:function(){this.tracksHeight=this.trackCount*this.trackHeight*this.canvasScale;this.tracksWidth=this.trackLength*this.patternCellWidth*this.canvasScale;this.trackViewWidth=this.canvas.width-this.trackInfoCanvas.width-this.vScrollBarWidth*this.canvasScale;this.trackViewHeight=this.canvas.height-this.rulerCanvas.height-this.hScrollBarHeight*this.canvasScale},setXScroll:function(e){if(e+this.trackViewWidth>this.tracksWidth){e=this.tracksWidth-this.trackViewWidth}if(e<0){e=0}this.scrollX=e},scrollToX:function(e){this.setXScroll(e)},scrollToY:function(e){this.setYScroll(e)},setYScroll:function(e){if(e<0){e=0}if(e+this.trackViewHeight>this.tracksHeight){e=this.tracksHeight-this.trackViewHeight}if(e<0){e=0}this.scrollY=e},calculateScroll:function(){this.vScrollBarHeight=this.trackViewHeight;this.vScrollBarPositionHeight=this.vScrollBarHeight*this.trackViewHeight/this.tracksHeight;if(this.vScrollBarPositionHeight>this.vScrollBarHeight){this.vScrollBarPositionHeight=this.vScrollBarHeight}this.vScrollBarPosition=this.scrollY*this.vScrollBarHeight/this.tracksHeight;this.hScrollBarWidth=this.trackViewWidth;this.hScrollBarPositionWidth=this.hScrollBarWidth*this.trackViewWidth/this.tracksWidth;if(this.hScrollBarPositionWidth>this.hScrollBarWidth){this.hScrollBarPositionWidth=this.hScrollBarWidth}this.hScrollBarPosition=this.scrollX*this.hScrollBarWidth/this.tracksWidth},render:function(){if(this.context==null){this.context=this.canvas.getContext("2d")}this.context.drawImage(this.trackCanvas,Math.round(this.scrollX),Math.round(this.scrollY),this.canvas.width*this.canvasScale,this.canvas.height*this.canvasScale,this.trackInfoWidth*this.canvasScale,this.rulerHeight*this.canvasScale,this.canvas.width*this.canvasScale,this.canvas.height*this.canvasScale);if(this.cursor.visible){this.drawCursor()}this.context.drawImage(this.rulerCanvas,Math.round(this.scrollX),0,this.canvas.width*this.canvasScale,this.rulerCanvas.height*this.canvasScale,this.trackInfoWidth*this.canvasScale,0,this.canvas.width*this.canvasScale,this.rulerCanvas.height*this.canvasScale);this.drawPlayhead();this.context.drawImage(this.trackInfoCanvas,0,Math.round(this.scrollY),this.trackInfoCanvas.width*this.canvasScale,this.trackInfoCanvas.height*this.canvasScale,0,0,this.trackInfoCanvas.width*this.canvasScale,this.trackInfoCanvas.height*this.canvasScale);this.calculateScroll();this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(this.trackInfoWidth*this.canvasScale,this.canvas.height-this.hScrollBarHeight*this.canvasScale,this.canvas.width-this.trackInfoWidth*this.canvasScale-this.vScrollBarWidth*this.canvasScale,this.hScrollBarHeight*this.canvasScale);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.trackInfoWidth*this.canvasScale+this.hScrollBarPosition,this.canvas.height-(this.hScrollBarHeight-1)*this.canvasScale,this.hScrollBarPositionWidth,(this.hScrollBarHeight-2)*this.canvasScale);this.context.fillStyle=styles.ui.scrollbarHolder;this.context.fillRect(this.canvas.width-this.vScrollBarWidth*this.canvasScale,this.rulerCanvas.height,this.vScrollBarWidth*this.canvasScale,this.canvas.height-this.rulerCanvas.height-this.hScrollBarHeight*this.canvasScale);this.context.fillStyle=styles.ui.scrollbar;this.context.fillRect(this.canvas.width-(this.vScrollBarWidth-1)*this.canvasScale,this.rulerCanvas.height+this.vScrollBarPosition,(this.vScrollBarWidth-2)*this.canvasScale,this.vScrollBarPositionHeight)}};var KeyboardCanvas=function(){this.canvasID="";this.keyboardCanvas=null;this.keyboardContext=null;this.whiteKeyWidth=20;this.blackKeyWidth=10;this.keyboardOctave=5;this.keyboardNote=5;this.keydownCallback=null;this.keyupCallback=null;this.mouseIsDown=true;this.whiteKey=false};KeyboardCanvas.prototype={init:function(e){this.canvasID=e;this.keyboardCanvas=document.getElementById(e);this.keyboardContext=this.keyboardCanvas.getContext("2d");this.drawKeyboard();var t=this;this.keyboardCanvas.addEventListener("mousedown",function(e){t.mouseDown(e)},false);this.keyboardCanvas.addEventListener("mousemove",function(e){t.mouseMove(e)},false);this.keyboardCanvas.addEventListener("mouseup",function(e){t.mouseUp(e)},false)},on:function(e,t){if(e=="keydown"){this.keydownCallback=t}if(e=="keyup"){this.keyupCallback=t}},mouseDown:function(e){this.mouseIsDown=true;UI.captureMouse(this);if(this.keydownCallback){this.keydownCallback(this.keyboardOctave,this.keyboardNote)}},mouseMove:function(e){if(this.mouseIsDown){return}UI.setCursor("pointer");var t=e.offsetX;var i=e.offsetY;this.mouseToKeyboard(t,i)},mouseUp:function(e){this.mouseIsDown=false;UI.releaseMouse();if(this.keyupCallback){this.keyupCallback()}},mouseToKeyboard:function(e,t){var i=$("#"+this.canvasID).offset();if(true){var r=Math.floor(e/this.whiteKeyWidth);this.whiteKey=r;var a=r%7;var s=Math.floor(r/7);r=a;if(r>=1){a++}if(r>=2){a++}if(r>=4){a++}if(r>=5){a++}if(r>=6){a++}if(t<30){var o=false;var l=(s*7+r)*this.whiteKeyWidth-this.blackKeyWidth/2;if(e>l&&e<l+this.blackKeyWidth){r--;o=r}var l=(s*7+r)*this.whiteKeyWidth+this.whiteKeyWidth-this.blackKeyWidth/2;if(e>l&&e<l+this.blackKeyWidth){o=r}if(o!==false){if(o==0){a=1;this.whiteKey=false}if(o==1){a=3;this.whiteKey=false}if(o==3){a=6;this.whiteKey=false}if(o==4){a=8;this.whiteKey=false}if(o==5){a=10;this.whiteKey=false}}}this.keyboardNote=a;this.keyboardOctave=s+1}this.drawKeyboard()},drawKeyboard:function(){var e=14;var t=styles.music.pianoRollSelectedNote;if(this.playingInstrument){t=styles.music.pianoRollHighlightedNote}this.whiteKey=false;if(this.keyboardNote!==false){if(this.keyboardNote%12==0){this.whiteKey=0}if(this.keyboardNote%12==2){this.whiteKey=1}if(this.keyboardNote%12==4){this.whiteKey=2}if(this.keyboardNote%12==5){this.whiteKey=3}if(this.keyboardNote%12==7){this.whiteKey=4}if(this.keyboardNote%12==9){this.whiteKey=5}if(this.keyboardNote%12==11){this.whiteKey=6}this.keyboardOctave+=Math.floor(this.keyboardNote/12);if(this.whiteKey!==false){this.whiteKey=this.whiteKey+(this.keyboardOctave-1)*7}}this.whiteKeyWidth=12/7*e;var i=Math.floor(this.keyboardCanvas.width/this.whiteKeyWidth)+1;if(i>48){i=48}this.keyboardContext.fillStyle=styles.music.pianoRollWhiteKey;this.keyboardContext.clearRect(0,0,this.keyboardCanvas.width,this.keyboardCanvas.height);if(this.whiteKey!==false){this.keyboardContext.fillStyle=t;this.keyboardContext.fillRect(this.whiteKey*this.whiteKeyWidth,0,this.whiteKeyWidth,this.keyboardCanvas.height)}this.keyboardContext.beginPath();for(var r=0;r<i;r++){this.keyboardContext.moveTo(r*this.whiteKeyWidth+.5,0);this.keyboardContext.lineTo(r*this.whiteKeyWidth+.5,this.keyboardCanvas.height)}this.keyboardContext.stroke();for(var r=0;r<=i/7;r++){this.keyboardContext.font="10px Verdana";this.keyboardContext.fillStyle=styles.music.pianoRollBlackKey;var a=r+1;this.keyboardContext.fillText("C"+a,r*this.whiteKeyWidth*7+2,56)}var s=this.cellHeight;this.blackKeyWidth=e;var o=this.keyboardCanvas.height/2;for(var r=0;r<i;r++){var l=r%7;var a=Math.floor(r/7)+1;if(l==1||l==2||l==4||l==5||l==6){var n=0;if(l==1){n=1}if(l==2){n=3}if(l==4){n=6}if(l==5){n=8}if(l==6){n=10}if(this.keyboardNote==n&&this.keyboardOctave==a){this.keyboardContext.fillStyle=t}else{this.keyboardContext.fillStyle=styles.music.pianoRollBlackKey}this.keyboardContext.fillRect(r*this.whiteKeyWidth-this.blackKeyWidth/2,0,this.blackKeyWidth,o)}}}};var ChannelInfo=function(){this.camera=null;this.scene=null;this.holder=null;this.sampleCount=800;this.track1=null;this.channel=0;this.prefix="sidCh";this.showControlRegister=true;this.showFilter=true;this.adsrColor="#f8a998";this.pulseWidthColor="#98c2a9"};ChannelInfo.prototype={getHTML:function(){var e="";if(this.showControlRegister){e+='<span id="'+this.prefix+this.channel+'gate" class="sidChannelInfo" style="">';e+="GATE";e+="</span>";e+='<span id="'+this.prefix+this.channel+'adsr" class="sidChannelInfo" style="display: inline-block; text-align: right; width: 22px">';e+="";e+="</span>";e+='<span id="'+this.prefix+this.channel+'sync" class="sidChannelInfo" style="">';e+="SYNC";e+="</span>";e+='<span id="'+this.prefix+this.channel+'ring" class="sidChannelInfo" style="">';e+="RING";e+="</span>";e+='<span id="'+this.prefix+this.channel+'test" class="sidChannelInfo" style="">';e+="TEST";e+="</span>";e+='<span class="sidChannelInfoSpace"></span>';e+='<span id="'+this.prefix+this.channel+'triangle" class="sidChannelInfo" style="">';e+="TRIANGLE";e+="</span>";e+='<span id="'+this.prefix+this.channel+'sawtooth" class="sidChannelInfo" style="">';e+="SAWTOOTH";e+="</span>";e+='<span id="'+this.prefix+this.channel+'pulse" class="sidChannelInfo" style="margin-right: 0">';e+="PULSE";e+="</span>";e+='<span id="'+this.prefix+this.channel+'pw" class="sidChannelInfo" style="margin-left: 0; display: inline-block; text-align: right;width: 26px">';e+="";e+="</span>";e+='<span id="'+this.prefix+this.channel+'noise" class="sidChannelInfo" style="">';e+="NOISE";e+="</span>";e+='<span id="'+this.prefix+this.channel+'freq" class="sidChannelInfo" style="display: inline-block; text-align: right;width: 48px">';e+="";e+="</span>";e+='<span id="'+this.prefix+this.channel+'note" class="sidChannelInfo" style="display: inline-block; text-align: right; width: 22px">';e+="";e+="</span>";e+='<span class="sidChannelInfoSpace"></span>'}if(this.showFilter){e+='<span id="'+this.prefix+this.channel+'lowpass" class="sidChannelInfo" style="">';e+="LOWPASS";e+="</span>";e+='<span id="'+this.prefix+this.channel+'bandpass" class="sidChannelInfo" style="">';e+="BANDPASS";e+="</span>";e+='<span id="'+this.prefix+this.channel+'highpass" class="sidChannelInfo" style="">';e+="HIGHPASS";e+="</span>";if(this.showControlRegister){e+='<span id="'+this.prefix+this.channel+'cutoff" class="sidChannelInfo" style="display: inline-block; text-align: right;width: 48px">';e+="";e+="</span>";e+='<span id="'+this.prefix+this.channel+'res" class="sidChannelInfo" style="display: inline-block; text-align: right; width: 16px">';e+="";e+="</span>"}else{e+='<span id="'+this.prefix+this.channel+'cutoffLabel" class="sidChannelInfo" style="">';e+="CUTOFF:";e+="</span>";e+='<span id="'+this.prefix+this.channel+'cutoff" class="sidChannelInfo" style="display: inline-block; text-align: right;width: 32px">';e+="";e+="</span>";e+='<span id="'+this.prefix+this.channel+'resLabel" class="sidChannelInfo" style="">';e+="RES:";e+="</span>";e+='<span id="'+this.prefix+this.channel+'res" class="sidChannelInfo" style="display: inline-block; text-align: right; width: 16px">';e+="";e+="</span>"}e+='<span class="sidChannelInfoSpace"></span>'}$("#"+this.prefix+this.channel+"Info").html(e)},init:function(e,t){if(typeof t.prefix!="undefined"){this.prefix=t.prefix}if(typeof t.showControlRegister!="undefined"){this.showControlRegister=t.showControlRegister}this.music=e;this.channel=t.channel;var i=1;var r=1e3;var a=40;var s=40;this.camera=new THREE.OrthographicCamera(a/-2,a/2,s/2,s/-2,i,r);this.camera.position.z=100;this.getHTML();this.scene=new THREE.Scene;this.holder=new THREE.Object3D;this.scene.add(this.holder)},updateInfo:function(e){if(e.waveform&1){$("#"+this.prefix+this.channel+"gate").css("background-color","#ffffff");$("#"+this.prefix+this.channel+"adsr").css("background-color",this.adsrColor)}else{$("#"+this.prefix+this.channel+"gate").css("background-color","#444444");$("#"+this.prefix+this.channel+"adsr").css("background-color","#444444")}if(e.waveform&2){$("#"+this.prefix+this.channel+"sync").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"sync").css("background-color","#444444")}if(e.waveform&4){$("#"+this.prefix+this.channel+"ring").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"ring").css("background-color","#444444")}if(e.waveform&8){$("#"+this.prefix+this.channel+"test").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"test").css("background-color","#444444")}if(e.waveform&16){$("#"+this.prefix+this.channel+"triangle").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"triangle").css("background-color","#444444")}if(e.waveform&32){$("#"+this.prefix+this.channel+"sawtooth").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"sawtooth").css("background-color","#444444")}if(e.waveform&64){$("#"+this.prefix+this.channel+"pulse").css("background-color","#ffffff");$("#"+this.prefix+this.channel+"pw").css("background-color",this.pulseWidthColor)}else{$("#"+this.prefix+this.channel+"pulse").css("background-color","#444444");$("#"+this.prefix+this.channel+"pw").css("background-color","#444444")}if(e.waveform&128){$("#"+this.prefix+this.channel+"noise").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"noise").css("background-color","#444444")}$("#"+this.prefix+this.channel+"freq").html(e.freq);$("#"+this.prefix+this.channel+"note").html(e.note);if(e.filterActive&&(e.filter&16)>>4){$("#"+this.prefix+this.channel+"lowpass").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"lowpass").css("background-color","#444444")}if(e.filterActive&&(e.filter&32)>>4){$("#"+this.prefix+this.channel+"bandpass").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"bandpass").css("background-color","#444444")}if(e.filterActive&&(e.filter&64)>>4){$("#"+this.prefix+this.channel+"highpass").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"highpass").css("background-color","#444444")}if(e.filterActive){$("#"+this.prefix+this.channel+"cutoff").css("background-color","#ffffff");$("#"+this.prefix+this.channel+"res").css("background-color","#ffffff")}else{$("#"+this.prefix+this.channel+"cutoff").css("background-color","#444444");$("#"+this.prefix+this.channel+"res").css("background-color","#444444")}$("#"+this.prefix+this.channel+"cutoff").html(e.cutoff);$("#"+this.prefix+this.channel+"res").html(e.res);var t=("0000"+e.adsr.toString(16)).substr(-4);$("#"+this.prefix+this.channel+"adsr").html("$"+t);$("#"+this.prefix+this.channel+"pw").html(e.pulsewidth)},render:function(e,t,i,r){this.holder.position.x=-i/2;this.scale=1;this.camera.left=-i/(2*this.scale);this.camera.right=i/(2*this.scale);this.camera.top=r/(2*this.scale);this.camera.bottom=-r/(2*this.scale);this.camera.updateProjectionMatrix();renderer.render(this.scene,this.camera)}};var PitchDetect=function(){this.music=null;this.audioContext=null;this.MAX_SIZE=0;this.MIN_SAMPLES=0;this.GOOD_ENOUGH_CORRELATION=.9;this.buflen=1024;this.buf=new Float32Array(this.buflen);this.notes={432:[{note:"C0",frequency:16.05},{note:"C#0",frequency:17.01},{note:"D0",frequency:18.02},{note:"D#0",frequency:19.09},{note:"E0",frequency:20.23},{note:"F0",frequency:21.43},{note:"F#0",frequency:22.7},{note:"G0",frequency:24.05},{note:"G#0",frequency:25.48},{note:"A0",frequency:27},{note:"A#0",frequency:28.61},{note:"B0",frequency:30.31},{note:"C1",frequency:32.11},{note:"C#1",frequency:34.02},{note:"D1",frequency:36.04},{note:"D#1",frequency:38.18},{note:"E1",frequency:40.45},{note:"F1",frequency:42.86},{note:"F#1",frequency:45.41},{note:"G1",frequency:48.11},{note:"G#1",frequency:50.97},{note:"A1",frequency:54},{note:"A#1",frequency:57.21},{note:"B1",frequency:60.61},{note:"C2",frequency:64.22},{note:"C#2",frequency:68.04},{note:"D2",frequency:72.08},{note:"D#2",frequency:76.37},{note:"E2",frequency:80.91},{note:"F2",frequency:85.72},{note:"F#2",frequency:90.82},{note:"G2",frequency:96.22},{note:"G#2",frequency:101.94},{note:"A2",frequency:108},{note:"A#2",frequency:114.42},{note:"B2",frequency:121.23},{note:"C3",frequency:128.43},{note:"C#3",frequency:136.07},{note:"D3",frequency:144.16},{note:"D#3",frequency:152.74},{note:"E3",frequency:161.82},{note:"F3",frequency:171.44},{note:"F#3",frequency:181.63},{note:"G3",frequency:192.43},{note:"G#3",frequency:203.88},{note:"A3",frequency:216},{note:"A#3",frequency:228.84},{note:"B3",frequency:242.45},{note:"C4",frequency:256.87},{note:"C#4",frequency:272.14},{note:"D4",frequency:288.33},{note:"D#4",frequency:305.47},{note:"E4",frequency:323.63},{note:"F4",frequency:342.88},{note:"F#4",frequency:363.27},{note:"G4",frequency:384.87},{note:"G#4",frequency:407.75},{note:"A4",frequency:432},{note:"A#4",frequency:457.69},{note:"B4",frequency:484.9},{note:"C5",frequency:513.74},{note:"C#5",frequency:544.29},{note:"D5",frequency:576.65},{note:"D#5",frequency:610.94},{note:"E5",frequency:647.27},{note:"F5",frequency:685.76},{note:"F#5",frequency:726.53},{note:"G5",frequency:769.74},{note:"G#5",frequency:815.51},{note:"A5",frequency:864},{note:"A#5",frequency:915.38},{note:"B5",frequency:969.81},{note:"C6",frequency:1027.47},{note:"C#6",frequency:1088.57},{note:"D6",frequency:1153.3},{note:"D#6",frequency:1221.88},{note:"E6",frequency:1294.54},{note:"F6",frequency:1371.51},{note:"F#6",frequency:1453.07},{note:"G6",frequency:1539.47},{note:"G#6",frequency:1631.01},{note:"A6",frequency:1728},{note:"A#6",frequency:1830.75},{note:"B6",frequency:1939.61},{note:"C7",frequency:2054.95},{note:"C#7",frequency:2177.14},{note:"D7",frequency:2306.6},{note:"D#7",frequency:2443.76},{note:"E7",frequency:2589.07},{note:"F7",frequency:2743.03},{note:"F#7",frequency:2906.14},{note:"G7",frequency:3078.95},{note:"G#7",frequency:3262.03},{note:"A7",frequency:3456},{note:"A#7",frequency:3661.5},{note:"B7",frequency:3879.23},{note:"C8",frequency:4109.9},{note:"C#8",frequency:4354.29},{note:"D8",frequency:4613.21},{note:"D#8",frequency:4887.52},{note:"E8",frequency:5178.15},{note:"F8",frequency:5486.06},{note:"F#8",frequency:5812.28},{note:"G8",frequency:6157.89},{note:"G#8",frequency:6524.06},{note:"A8",frequency:6912},{note:"A#8",frequency:7323.01},{note:"B8",frequency:7758.46}],434:[{note:"C0",frequency:16.13},{note:"C#0",frequency:17.09},{note:"D0",frequency:18.1},{note:"D#0",frequency:19.18},{note:"E0",frequency:20.32},{note:"F0",frequency:21.53},{note:"F#0",frequency:22.81},{note:"G0",frequency:24.17},{note:"G#0",frequency:25.6},{note:"A0",frequency:27.12},{note:"A#0",frequency:28.74},{note:"B0",frequency:30.45},{note:"C1",frequency:32.26},{note:"C#1",frequency:34.18},{note:"D1",frequency:36.21},{note:"D#1",frequency:38.36},{note:"E1",frequency:40.64},{note:"F1",frequency:43.06},{note:"F#1",frequency:45.62},{note:"G1",frequency:48.33},{note:"G#1",frequency:51.21},{note:"A1",frequency:54.25},{note:"A#1",frequency:57.48},{note:"B1",frequency:60.89},{note:"C2",frequency:64.51},{note:"C#2",frequency:68.35},{note:"D2",frequency:72.42},{note:"D#2",frequency:76.72},{note:"E2",frequency:81.28},{note:"F2",frequency:86.12},{note:"F#2",frequency:91.24},{note:"G2",frequency:96.66},{note:"G#2",frequency:102.41},{note:"A2",frequency:108.5},{note:"A#2",frequency:114.95},{note:"B2",frequency:121.79},{note:"C3",frequency:129.03},{note:"C#3",frequency:136.7},{note:"D3",frequency:144.83},{note:"D#3",frequency:153.44},{note:"E3",frequency:162.57},{note:"F3",frequency:172.23},{note:"F#3",frequency:182.47},{note:"G3",frequency:193.32},{note:"G#3",frequency:204.82},{note:"A3",frequency:217},{note:"A#3",frequency:229.9},{note:"B3",frequency:243.57},{note:"C4",frequency:258.06},{note:"C#4",frequency:273.4},{note:"D4",frequency:289.66},{note:"D#4",frequency:306.88},{note:"E4",frequency:325.13},{note:"F4",frequency:344.47},{note:"F#4",frequency:364.95},{note:"G4",frequency:386.65},{note:"G#4",frequency:409.64},{note:"A4",frequency:434},{note:"A#4",frequency:459.81},{note:"B4",frequency:487.15},{note:"C5",frequency:516.12},{note:"C#5",frequency:546.81},{note:"D5",frequency:579.32},{note:"D#5",frequency:613.77},{note:"E5",frequency:650.27},{note:"F5",frequency:688.93},{note:"F#5",frequency:729.9},{note:"G5",frequency:773.3},{note:"G#5",frequency:819.28},{note:"A5",frequency:868},{note:"A#5",frequency:919.61},{note:"B5",frequency:974.3},{note:"C6",frequency:1032.23},{note:"C#6",frequency:1093.61},{note:"D6",frequency:1158.64},{note:"D#6",frequency:1227.54},{note:"E6",frequency:1300.53},{note:"F6",frequency:1377.86},{note:"F#6",frequency:1459.8},{note:"G6",frequency:1546.6},{note:"G#6",frequency:1638.57},{note:"A6",frequency:1736},{note:"A#6",frequency:1839.23},{note:"B6",frequency:1948.59},{note:"C7",frequency:2064.46},{note:"C#7",frequency:2187.22},{note:"D7",frequency:2317.28},{note:"D#7",frequency:2455.07},{note:"E7",frequency:2601.06},{note:"F7",frequency:2755.73},{note:"F#7",frequency:2919.59},{note:"G7",frequency:3093.2},{note:"G#7",frequency:3277.13},{note:"A7",frequency:3472},{note:"A#7",frequency:3678.46},{note:"B7",frequency:3897.19},{note:"C8",frequency:4128.93},{note:"C#8",frequency:4374.44},{note:"D8",frequency:4634.56},{note:"D#8",frequency:4910.15},{note:"E8",frequency:5202.12},{note:"F8",frequency:5511.46},{note:"F#8",frequency:5839.18},{note:"G8",frequency:6186.4},{note:"G#8",frequency:6554.26},{note:"A8",frequency:6944},{note:"A#8",frequency:7356.91},{note:"B8",frequency:7794.38}],436:[{note:"C0",frequency:16.2},{note:"C#0",frequency:17.17},{note:"D0",frequency:18.19},{note:"D#0",frequency:19.27},{note:"E0",frequency:20.41},{note:"F0",frequency:21.63},{note:"F#0",frequency:22.91},{note:"G0",frequency:24.28},{note:"G#0",frequency:25.72},{note:"A0",frequency:27.25},{note:"A#0",frequency:28.87},{note:"B0",frequency:30.59},{note:"C1",frequency:32.41},{note:"C#1",frequency:34.33},{note:"D1",frequency:36.37},{note:"D#1",frequency:38.54},{note:"E1",frequency:40.83},{note:"F1",frequency:43.26},{note:"F#1",frequency:45.83},{note:"G1",frequency:48.55},{note:"G#1",frequency:51.44},{note:"A1",frequency:54.5},{note:"A#1",frequency:57.74},{note:"B1",frequency:61.17},{note:"C2",frequency:64.81},{note:"C#2",frequency:68.67},{note:"D2",frequency:72.75},{note:"D#2",frequency:77.07},{note:"E2",frequency:81.66},{note:"F2",frequency:86.51},{note:"F#2",frequency:91.66},{note:"G2",frequency:97.11},{note:"G#2",frequency:102.88},{note:"A2",frequency:109},{note:"A#2",frequency:115.48},{note:"B2",frequency:122.35},{note:"C3",frequency:129.62},{note:"C#3",frequency:137.33},{note:"D3",frequency:145.5},{note:"D#3",frequency:154.15},{note:"E3",frequency:163.32},{note:"F3",frequency:173.03},{note:"F#3",frequency:183.32},{note:"G3",frequency:194.22},{note:"G#3",frequency:205.76},{note:"A3",frequency:218},{note:"A#3",frequency:230.96},{note:"B3",frequency:244.7},{note:"C4",frequency:259.25},{note:"C#4",frequency:274.66},{note:"D4",frequency:290.99},{note:"D#4",frequency:308.3},{note:"E4",frequency:326.63},{note:"F4",frequency:346.05},{note:"F#4",frequency:366.63},{note:"G4",frequency:388.43},{note:"G#4",frequency:411.53},{note:"A4",frequency:436},{note:"A#4",frequency:461.93},{note:"B4",frequency:489.39},{note:"C5",frequency:518.49},{note:"C#5",frequency:549.33},{note:"D5",frequency:581.99},{note:"D#5",frequency:616.6},{note:"E5",frequency:653.26},{note:"F5",frequency:692.11},{note:"F#5",frequency:733.26},{note:"G5",frequency:776.86},{note:"G#5",frequency:823.06},{note:"A5",frequency:872},{note:"A#5",frequency:923.85},{note:"B5",frequency:978.79},{note:"C6",frequency:1036.99},{note:"C#6",frequency:1098.65},{note:"D6",frequency:1163.98},{note:"D#6",frequency:1233.19},{note:"E6",frequency:1306.52},{note:"F6",frequency:1384.21},{note:"F#6",frequency:1466.52},{note:"G6",frequency:1553.73},{note:"G#6",frequency:1646.12},{note:"A6",frequency:1744},{note:"A#6",frequency:1847.7},{note:"B6",frequency:1957.57},{note:"C7",frequency:2073.98},{note:"C#7",frequency:2197.3},{note:"D7",frequency:2327.96},{note:"D#7",frequency:2466.39},{note:"E7",frequency:2613.05},{note:"F7",frequency:2768.43},{note:"F#7",frequency:2933.05},{note:"G7",frequency:3107.45},{note:"G#7",frequency:3292.23},{note:"A7",frequency:3488},{note:"A#7",frequency:3695.41},{note:"B7",frequency:3915.15},{note:"C8",frequency:4147.95},{note:"C#8",frequency:4394.6},{note:"D8",frequency:4655.92},{note:"D#8",frequency:4932.78},{note:"E8",frequency:5226.09},{note:"F8",frequency:5536.85},{note:"F#8",frequency:5866.09},{note:"G8",frequency:6214.91},{note:"G#8",frequency:6584.47},{note:"A8",frequency:6976},{note:"A#8",frequency:7390.81},{note:"B8",frequency:7830.3}],438:[{note:"C0",frequency:16.28},{note:"C#0",frequency:17.25},{note:"D0",frequency:18.27},{note:"D#0",frequency:19.36},{note:"E0",frequency:20.51},{note:"F0",frequency:21.73},{note:"F#0",frequency:23.02},{note:"G0",frequency:24.39},{note:"G#0",frequency:25.84},{note:"A0",frequency:27.38},{note:"A#0",frequency:29},{note:"B0",frequency:30.73},{note:"C1",frequency:32.55},{note:"C#1",frequency:34.49},{note:"D1",frequency:36.54},{note:"D#1",frequency:38.71},{note:"E1",frequency:41.02},{note:"F1",frequency:43.46},{note:"F#1",frequency:46.04},{note:"G1",frequency:48.78},{note:"G#1",frequency:51.68},{note:"A1",frequency:54.75},{note:"A#1",frequency:58.01},{note:"B1",frequency:61.45},{note:"C2",frequency:65.11},{note:"C#2",frequency:68.98},{note:"D2",frequency:73.08},{note:"D#2",frequency:77.43},{note:"E2",frequency:82.03},{note:"F2",frequency:86.91},{note:"F#2",frequency:92.08},{note:"G2",frequency:97.55},{note:"G#2",frequency:103.35},{note:"A2",frequency:109.5},{note:"A#2",frequency:116.01},{note:"B2",frequency:122.91},{note:"C3",frequency:130.22},{note:"C#3",frequency:137.96},{note:"D3",frequency:146.16},{note:"D#3",frequency:154.86},{note:"E3",frequency:164.06},{note:"F3",frequency:173.82},{note:"F#3",frequency:184.16},{note:"G3",frequency:195.11},{note:"G#3",frequency:206.71},{note:"A3",frequency:219},{note:"A#3",frequency:232.02},{note:"B3",frequency:245.82},{note:"C4",frequency:260.44},{note:"C#4",frequency:275.92},{note:"D4",frequency:292.33},{note:"D#4",frequency:309.71},{note:"E4",frequency:328.13},{note:"F4",frequency:347.64},{note:"F#4",frequency:368.31},{note:"G4",frequency:390.21},{note:"G#4",frequency:413.42},{note:"A4",frequency:438},{note:"A#4",frequency:464.04},{note:"B4",frequency:491.64},{note:"C5",frequency:520.87},{note:"C#5",frequency:551.85},{note:"D5",frequency:584.66},{note:"D#5",frequency:619.43},{note:"E5",frequency:656.26},{note:"F5",frequency:695.28},{note:"F#5",frequency:736.63},{note:"G5",frequency:780.43},{note:"G#5",frequency:826.83},{note:"A5",frequency:876},{note:"A#5",frequency:928.09},{note:"B5",frequency:983.28},{note:"C6",frequency:1041.74},{note:"C#6",frequency:1103.69},{note:"D6",frequency:1169.32},{note:"D#6",frequency:1238.85},{note:"E6",frequency:1312.52},{note:"F6",frequency:1390.56},{note:"F#6",frequency:1473.25},{note:"G6",frequency:1560.85},{note:"G#6",frequency:1653.67},{note:"A6",frequency:1752},{note:"A#6",frequency:1856.18},{note:"B6",frequency:1966.55},{note:"C7",frequency:2083.49},{note:"C#7",frequency:2207.38},{note:"D7",frequency:2338.64},{note:"D#7",frequency:2477.7},{note:"E7",frequency:2625.03},{note:"F7",frequency:2781.13},{note:"F#7",frequency:2946.5},{note:"G7",frequency:3121.71},{note:"G#7",frequency:3307.34},{note:"A7",frequency:3504},{note:"A#7",frequency:3712.36},{note:"B7",frequency:3933.11},{note:"C8",frequency:4166.98},{note:"C#8",frequency:4414.76},{note:"D8",frequency:4677.28},{note:"D#8",frequency:4955.4},{note:"E8",frequency:5250.07},{note:"F8",frequency:5562.25},{note:"F#8",frequency:5893},{note:"G8",frequency:6243.42},{note:"G#8",frequency:6614.67},{note:"A8",frequency:7008},{note:"A#8",frequency:7424.72},{note:"B8",frequency:7866.21}],440:[{note:"C0",frequency:16.35},{note:"C#0",frequency:17.32},{note:"D0",frequency:18.35},{note:"D#0",frequency:19.45},{note:"E0",frequency:20.6},{note:"F0",frequency:21.83},{note:"F#0",frequency:23.12},{note:"G0",frequency:24.5},{note:"G#0",frequency:25.96},{note:"A0",frequency:27.5},{note:"A#0",frequency:29.14},{note:"B0",frequency:30.87},{note:"C1",frequency:32.7},{note:"C#1",frequency:34.65},{note:"D1",frequency:36.71},{note:"D#1",frequency:38.89},{note:"E1",frequency:41.2},{note:"F1",frequency:43.65},{note:"F#1",frequency:46.25},{note:"G1",frequency:49},{note:"G#1",frequency:51.91},{note:"A1",frequency:55},{note:"A#1",frequency:58.27},{note:"B1",frequency:61.74},{note:"C2",frequency:65.41},{note:"C#2",frequency:69.3},{note:"D2",frequency:73.42},{note:"D#2",frequency:77.78},{note:"E2",frequency:82.41},{note:"F2",frequency:87.31},{note:"F#2",frequency:92.5},{note:"G2",frequency:98},{note:"G#2",frequency:103.83},{note:"A2",frequency:110},{note:"A#2",frequency:116.54},{note:"B2",frequency:123.47},{note:"C3",frequency:130.81},{note:"C#3",frequency:138.59},{note:"D3",frequency:146.83},{note:"D#3",frequency:155.56},{note:"E3",frequency:164.81},{note:"F3",frequency:174.61},{note:"F#3",frequency:185},{note:"G3",frequency:196},{note:"G#3",frequency:207.65},{note:"A3",frequency:220},{note:"A#3",frequency:233.08},{note:"B3",frequency:246.94},{note:"C4",frequency:261.63},{note:"C#4",frequency:277.18},{note:"D4",frequency:293.66},{note:"D#4",frequency:311.13},{note:"E4",frequency:329.63},{note:"F4",frequency:349.23},{note:"F#4",frequency:369.99},{note:"G4",frequency:392},{note:"G#4",frequency:415.3},{note:"A4",frequency:440},{note:"A#4",frequency:466.16},{note:"B4",frequency:493.88},{note:"C5",frequency:523.25},{note:"C#5",frequency:554.37},{note:"D5",frequency:587.33},{note:"D#5",frequency:622.25},{note:"E5",frequency:659.25},{note:"F5",frequency:698.46},{note:"F#5",frequency:739.99},{note:"G5",frequency:783.99},{note:"G#5",frequency:830.61},{note:"A5",frequency:880},{note:"A#5",frequency:932.33},{note:"B5",frequency:987.77},{note:"C6",frequency:1046.5},{note:"C#6",frequency:1108.73},{note:"D6",frequency:1174.66},{note:"D#6",frequency:1244.51},{note:"E6",frequency:1318.51},{note:"F6",frequency:1396.91},{note:"F#6",frequency:1479.98},{note:"G6",frequency:1567.98},{note:"G#6",frequency:1661.22},{note:"A6",frequency:1760},{note:"A#6",frequency:1864.66},{note:"B6",frequency:1975.53},{note:"C7",frequency:2093},{note:"C#7",frequency:2217.46},{note:"D7",frequency:2349.32},{note:"D#7",frequency:2489.02},{note:"E7",frequency:2637.02},{note:"F7",frequency:2793.83},{note:"F#7",frequency:2959.96},{note:"G7",frequency:3135.96},{note:"G#7",frequency:3322.44},{note:"A7",frequency:3520},{note:"A#7",frequency:3729.31},{note:"B7",frequency:3951.07},{note:"C8",frequency:4186.01},{note:"C#8",frequency:4434.92},{note:"D8",frequency:4698.63},{note:"D#8",frequency:4978.03},{note:"E8",frequency:5274.04},{note:"F8",frequency:5587.65},{note:"F#8",frequency:5919.91},{note:"G8",frequency:6271.93},{note:"G#8",frequency:6644.88},{note:"A8",frequency:7040},{note:"A#8",frequency:7458.62},{note:"B8",frequency:7902.13}],442:[{note:"C0",frequency:16.43},{note:"C#0",frequency:17.4},{note:"D0",frequency:18.44},{note:"D#0",frequency:19.53},{note:"E0",frequency:20.7},{note:"F0",frequency:21.93},{note:"F#0",frequency:23.23},{note:"G0",frequency:24.61},{note:"G#0",frequency:26.07},{note:"A0",frequency:27.62},{note:"A#0",frequency:29.27},{note:"B0",frequency:31.01},{note:"C1",frequency:32.85},{note:"C#1",frequency:34.81},{note:"D1",frequency:36.87},{note:"D#1",frequency:39.07},{note:"E1",frequency:41.39},{note:"F1",frequency:43.85},{note:"F#1",frequency:46.46},{note:"G1",frequency:49.22},{note:"G#1",frequency:52.15},{note:"A1",frequency:55.25},{note:"A#1",frequency:58.54},{note:"B1",frequency:62.02},{note:"C2",frequency:65.7},{note:"C#2",frequency:69.61},{note:"D2",frequency:73.75},{note:"D#2",frequency:78.14},{note:"E2",frequency:82.78},{note:"F2",frequency:87.7},{note:"F#2",frequency:92.92},{note:"G2",frequency:98.44},{note:"G#2",frequency:104.3},{note:"A2",frequency:110.5},{note:"A#2",frequency:117.07},{note:"B2",frequency:124.03},{note:"C3",frequency:131.41},{note:"C#3",frequency:139.22},{note:"D3",frequency:147.5},{note:"D#3",frequency:156.27},{note:"E3",frequency:165.56},{note:"F3",frequency:175.41},{note:"F#3",frequency:185.84},{note:"G3",frequency:196.89},{note:"G#3",frequency:208.6},{note:"A3",frequency:221},{note:"A#3",frequency:234.14},{note:"B3",frequency:248.06},{note:"C4",frequency:262.81},{note:"C#4",frequency:278.44},{note:"D4",frequency:295},{note:"D#4",frequency:312.54},{note:"E4",frequency:331.13},{note:"F4",frequency:350.82},{note:"F#4",frequency:371.68},{note:"G4",frequency:393.78},{note:"G#4",frequency:417.19},{note:"A4",frequency:442},{note:"A#4",frequency:468.28},{note:"B4",frequency:496.13},{note:"C5",frequency:525.63},{note:"C#5",frequency:556.88},{note:"D5",frequency:590},{note:"D#5",frequency:625.08},{note:"E5",frequency:662.25},{note:"F5",frequency:701.63},{note:"F#5",frequency:743.35},{note:"G5",frequency:787.55},{note:"G#5",frequency:834.38},{note:"A5",frequency:884},{note:"A#5",frequency:936.57},{note:"B5",frequency:992.26},{note:"C6",frequency:1051.26},{note:"C#6",frequency:1113.77},{note:"D6",frequency:1180},{note:"D#6",frequency:1250.16},{note:"E6",frequency:1324.5},{note:"F6",frequency:1403.26},{note:"F#6",frequency:1486.7},{note:"G6",frequency:1575.11},{note:"G#6",frequency:1668.77},{note:"A6",frequency:1768},{note:"A#6",frequency:1873.13},{note:"B6",frequency:1984.51},{note:"C7",frequency:2102.52},{note:"C#7",frequency:2227.54},{note:"D7",frequency:2360},{note:"D#7",frequency:2500.33},{note:"E7",frequency:2649.01},{note:"F7",frequency:2806.52},{note:"F#7",frequency:2973.41},{note:"G7",frequency:3150.22},{note:"G#7",frequency:3337.54},{note:"A7",frequency:3536},{note:"A#7",frequency:3746.26},{note:"B7",frequency:3969.03},{note:"C8",frequency:4205.03},{note:"C#8",frequency:4455.08},{note:"D8",frequency:4719.99},{note:"D#8",frequency:5000.66},{note:"E8",frequency:5298.01},{note:"F8",frequency:5613.05},{note:"F#8",frequency:5946.82},{note:"G8",frequency:6300.44},{note:"G#8",frequency:6675.08},{note:"A8",frequency:7072},{note:"A#8",frequency:7492.52},{note:"B8",frequency:7938.05}],444:[{note:"C0",frequency:16.5},{note:"C#0",frequency:17.48},{note:"D0",frequency:18.52},{note:"D#0",frequency:19.62},{note:"E0",frequency:20.79},{note:"F0",frequency:22.03},{note:"F#0",frequency:23.33},{note:"G0",frequency:24.72},{note:"G#0",frequency:26.19},{note:"A0",frequency:27.75},{note:"A#0",frequency:29.4},{note:"B0",frequency:31.15},{note:"C1",frequency:33},{note:"C#1",frequency:34.96},{note:"D1",frequency:37.04},{note:"D#1",frequency:39.24},{note:"E1",frequency:41.58},{note:"F1",frequency:44.05},{note:"F#1",frequency:46.67},{note:"G1",frequency:49.44},{note:"G#1",frequency:52.39},{note:"A1",frequency:55.5},{note:"A#1",frequency:58.8},{note:"B1",frequency:62.3},{note:"C2",frequency:66},{note:"C#2",frequency:69.93},{note:"D2",frequency:74.08},{note:"D#2",frequency:78.49},{note:"E2",frequency:83.16},{note:"F2",frequency:88.1},{note:"F#2",frequency:93.34},{note:"G2",frequency:98.89},{note:"G#2",frequency:104.77},{note:"A2",frequency:111},{note:"A#2",frequency:117.6},{note:"B2",frequency:124.59},{note:"C3",frequency:132},{note:"C#3",frequency:139.85},{note:"D3",frequency:148.17},{note:"D#3",frequency:156.98},{note:"E3",frequency:166.31},{note:"F3",frequency:176.2},{note:"F#3",frequency:186.68},{note:"G3",frequency:197.78},{note:"G#3",frequency:209.54},{note:"A3",frequency:222},{note:"A#3",frequency:235.2},{note:"B3",frequency:249.19},{note:"C4",frequency:264},{note:"C#4",frequency:279.7},{note:"D4",frequency:296.33},{note:"D#4",frequency:313.96},{note:"E4",frequency:332.62},{note:"F4",frequency:352.4},{note:"F#4",frequency:373.36},{note:"G4",frequency:395.56},{note:"G#4",frequency:419.08},{note:"A4",frequency:444},{note:"A#4",frequency:470.4},{note:"B4",frequency:498.37},{note:"C5",frequency:528.01},{note:"C#5",frequency:559.4},{note:"D5",frequency:592.67},{note:"D#5",frequency:627.91},{note:"E5",frequency:665.25},{note:"F5",frequency:704.81},{note:"F#5",frequency:746.72},{note:"G5",frequency:791.12},{note:"G#5",frequency:838.16},{note:"A5",frequency:888},{note:"A#5",frequency:940.8},{note:"B5",frequency:996.75},{note:"C6",frequency:1056.02},{note:"C#6",frequency:1118.81},{note:"D6",frequency:1185.34},{note:"D#6",frequency:1255.82},{note:"E6",frequency:1330.5},{note:"F6",frequency:1409.61},{note:"F#6",frequency:1493.43},{note:"G6",frequency:1582.24},{note:"G#6",frequency:1676.32},{note:"A6",frequency:1776},{note:"A#6",frequency:1881.61},{note:"B6",frequency:1993.49},{note:"C7",frequency:2112.03},{note:"C#7",frequency:2237.62},{note:"D7",frequency:2370.67},{note:"D#7",frequency:2511.64},{note:"E7",frequency:2660.99},{note:"F7",frequency:2819.22},{note:"F#7",frequency:2986.86},{note:"G7",frequency:3164.47},{note:"G#7",frequency:3352.64},{note:"A7",frequency:3552},{note:"A#7",frequency:3763.21},{note:"B7",frequency:3986.99},{note:"C8",frequency:4224.06},{note:"C#8",frequency:4475.24},{note:"D8",frequency:4741.35},{note:"D#8",frequency:5023.29},{note:"E8",frequency:5321.99},{note:"F8",frequency:5638.45},{note:"F#8",frequency:5973.73},{note:"G8",frequency:6328.94},{note:"G#8",frequency:6705.28},{note:"A8",frequency:7104},{note:"A#8",frequency:7526.43},{note:"B8",frequency:7973.97}],446:[{note:"C0",frequency:16.57},{note:"C#0",frequency:17.56},{note:"D0",frequency:18.6},{note:"D#0",frequency:19.71},{note:"E0",frequency:20.88},{note:"F0",frequency:22.12},{note:"F#0",frequency:23.44},{note:"G0",frequency:24.83},{note:"G#0",frequency:26.31},{note:"A0",frequency:27.88},{note:"A#0",frequency:29.53},{note:"B0",frequency:31.29},{note:"C1",frequency:33.15},{note:"C#1",frequency:35.12},{note:"D1",frequency:37.21},{note:"D#1",frequency:39.42},{note:"E1",frequency:41.77},{note:"F1",frequency:44.25},{note:"F#1",frequency:46.88},{note:"G1",frequency:49.67},{note:"G#1",frequency:52.62},{note:"A1",frequency:55.75},{note:"A#1",frequency:59.07},{note:"B1",frequency:62.58},{note:"C2",frequency:66.3},{note:"C#2",frequency:70.24},{note:"D2",frequency:74.42},{note:"D#2",frequency:78.84},{note:"E2",frequency:83.53},{note:"F2",frequency:88.5},{note:"F#2",frequency:93.76},{note:"G2",frequency:99.34},{note:"G#2",frequency:105.24},{note:"A2",frequency:111.5},{note:"A#2",frequency:118.13},{note:"B2",frequency:125.15},{note:"C3",frequency:132.6},{note:"C#3",frequency:140.48},{note:"D3",frequency:148.83},{note:"D#3",frequency:157.68},{note:"E3",frequency:167.06},{note:"F3",frequency:177},{note:"F#3",frequency:187.52},{note:"G3",frequency:198.67},{note:"G#3",frequency:210.48},{note:"A3",frequency:223},{note:"A#3",frequency:236.26},{note:"B3",frequency:250.31},{note:"C4",frequency:265.19},{note:"C#4",frequency:280.96},{note:"D4",frequency:297.67},{note:"D#4",frequency:315.37},{note:"E4",frequency:334.12},{note:"F4",frequency:353.99},{note:"F#4",frequency:375.04},{note:"G4",frequency:397.34},{note:"G#4",frequency:420.97},{note:"A4",frequency:446},{note:"A#4",frequency:472.52},{note:"B4",frequency:500.62},{note:"C5",frequency:530.39},{note:"C#5",frequency:561.92},{note:"D5",frequency:595.34},{note:"D#5",frequency:630.74},{note:"E5",frequency:668.24},{note:"F5",frequency:707.98},{note:"F#5",frequency:750.08},{note:"G5",frequency:794.68},{note:"G#5",frequency:841.94},{note:"A5",frequency:892},{note:"A#5",frequency:945.04},{note:"B5",frequency:1001.24},{note:"C6",frequency:1060.77},{note:"C#6",frequency:1123.85},{note:"D6",frequency:1190.68},{note:"D#6",frequency:1261.48},{note:"E6",frequency:1336.49},{note:"F6",frequency:1415.96},{note:"F#6",frequency:1500.16},{note:"G6",frequency:1589.36},{note:"G#6",frequency:1683.87},{note:"A6",frequency:1784},{note:"A#6",frequency:1890.08},{note:"B6",frequency:2002.47},{note:"C7",frequency:2121.54},{note:"C#7",frequency:2247.7},{note:"D7",frequency:2381.35},{note:"D#7",frequency:2522.96},{note:"E7",frequency:2672.98},{note:"F7",frequency:2831.92},{note:"F#7",frequency:3000.32},{note:"G7",frequency:3178.73},{note:"G#7",frequency:3367.74},{note:"A7",frequency:3568},{note:"A#7",frequency:3780.16},{note:"B7",frequency:4004.95},{note:"C8",frequency:4243.09},{note:"C#8",frequency:4495.4},{note:"D8",frequency:4762.71},{note:"D#8",frequency:5045.91},{note:"E8",frequency:5345.96},{note:"F8",frequency:5663.85},{note:"F#8",frequency:6000.64},{note:"G8",frequency:6357.45},{note:"G#8",frequency:6735.49},{note:"A8",frequency:7136},{note:"A#8",frequency:7560.33},{note:"B8",frequency:8009.89}]};this.noteStrings=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];this.currentFrequency=-1;this.currentCentsOff=-1;this.currentNote=-1;this.currentNoteString="";this.active=false};PitchDetect.prototype={init:function(e){this.music=e;var t=window.MediaStream;if(typeof t==="undefined"&&typeof webkitMediaStream!=="undefined"){t=webkitMediaStream}if(typeof t!=="undefined"&&!("stop"in t.prototype)){t.prototype.stop=function(){this.getAudioTracks().forEach(function(e){e.stop()});this.getVideoTracks().forEach(function(e){e.stop()})}}},isGetUserMediaSupported:function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.getUserMedia){return true}return false},start:function(){if(!this.isGetUserMediaSupported()){alert("no access to microphone");return false}if(this.audioContext==null){this.audioContext=new AudioContext;this.MAX_SIZE=Math.max(4,Math.floor(this.audioContext.sampleRate/5e3))}var e={audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}};var t=function(e){alert("error!"+e)};var i=this;var r=function(e){i.mediaStreamSource=i.audioContext.createMediaStreamSource(e);i.analyser=i.audioContext.createAnalyser();i.analyser.fftSize=2048;i.mediaStreamSource.connect(i.analyser);i.active=true};var a=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices):function(i){return new Promise(function(e,t){navigator.getUserMedia(i,e,t)})};a({audio:true}).then(r).catch(t)},stop:function(){this.active=false;if(this.mediaStreamSource&&this.mediaStreamSource.mediaStream&&this.mediaStreamSource.mediaStream.stop){this.mediaStreamSource.mediaStream.stop()}this.mediaStreamSource=null;this.analyser=null},noteFromPitch:function(e){var t=12*(Math.log(e/440)/Math.log(2));return Math.round(t)+69},frequencyFromNoteNumber:function(e){return 440*Math.pow(2,(e-69)/12)},centsOffFromPitch:function(e,t){return Math.floor(1200*Math.log(e/this.frequencyFromNoteNumber(t))/Math.log(2))},autoCorrelate:function(e,t){var i=e.length;var r=Math.floor(i/2);var a=-1;var s=0;var o=0;var l=false;var n=new Array(r);for(var h=0;h<i;h++){var d=e[h];o+=d*d}o=Math.sqrt(o/i);if(o<.01)return-1;var c=1;for(var f=this.MIN_SAMPLES;f<r;f++){var u=0;for(var h=0;h<r;h++){u+=Math.abs(e[h]-e[h+f])}u=1-u/r;n[f]=u;if(u>this.GOOD_ENOUGH_CORRELATION&&u>c){l=true;if(u>s){s=u;a=f}}else if(l){}c=u}if(s>.01){return t/a}return-1},updatePitch:function(e){this.analyser.getFloatTimeDomainData(this.buf);var t=this.autoCorrelate(this.buf,this.audioContext.sampleRate);var i=false;var r=false;var a="";var s=false;if(t==-1){}else{r=t;i=this.noteFromPitch(r);s=Math.floor(i/12);a=this.noteStrings[i%12]}$("#sidPitch").html(r+","+i+","+a)},findFundamentalFreq:function(e,t){var i=1024;var r=-1;var a=0;for(var s=8;s<=1e3;s++){var o=0;for(var l=0;l<i;l++){o+=(e[l]-128)/128*((e[l+s]-128)/128)}var n=o/(i+s);if(n>a){a=n;r=s}if(n>.9){break}}if(a>.0025){var h=t/r;return h}else{return-1}},findClosestNote:function(e,t){var i=-1;var r=t.length;while(r-i>1){var a=Math.round((i+r)/2);if(t[a].frequency<=e){i=a}else{r=a}}if(Math.abs(t[r].frequency-e)<=Math.abs(t[i].frequency-e)){this.currentNote=r;return t[r]}this.currentNote=i;return t[i]},findCentsOffPitch:function(e,t){var i=.6931471805599453;var r=e/t;var a=Math.floor(1200*(Math.log(r)/i));return a},detectPitch:function(e){if(!this.active){return}var t=new Uint8Array(this.analyser.fftSize);this.analyser.getByteTimeDomainData(t);var i=this.findFundamentalFreq(t,this.audioContext.sampleRate);if(i!==-1){var r=this.findClosestNote(i,this.notes["440"]);var a=this.findCentsOffPitch(i,r.frequency);var s=parseInt($("#sidPitchDetectOffset").val());if(s!=0){this.currentNote+=s;if(this.currentNote>=0&&this.currentNote<this.notes["440"].length){r=this.notes["440"][this.currentNote]}}this.currentCentsOff=a;this.currentFrequency=i;this.currentNoteString=r.note;$("#sidPitch").html(this.currentNoteString);$("#sidPitchCents").html(a+" cents");$("#sidPitchFrequency").html(i)}else{$("#sidPitch").html("--");$("#sidPitchCents").html("--"+" cents");$("#sidPitchFrequency").html("--");this.currentNote=-1;this.currentFrequency=-1;this.currentNoteString="--"}}};var Notes={};Notes.centsOffFromPitch=function(e,t){return Math.floor(1200*Math.log(e/t)/Math.log(2))},Notes.findClosestNote=function(e){var t=Notes.notes["440"];var i=-1;var r=t.length;while(r-i>1){var a=Math.round((i+r)/2);if(t[a].frequency<=e){i=a}else{r=a}}if(i<0||r<0||i>t.length-1||r>t.length-1){return{note:"-",frequency:0,index:0}}if(Math.abs(t[r].frequency-e)<=Math.abs(t[i].frequency-e)){this.currentNote=r;t[r].index=r;return t[r]}this.currentNote=i;t[i].index=i;return t[i]};Notes.notes={432:[{note:"C0",frequency:16.05},{note:"C#0",frequency:17.01},{note:"D0",frequency:18.02},{note:"D#0",frequency:19.09},{note:"E0",frequency:20.23},{note:"F0",frequency:21.43},{note:"F#0",frequency:22.7},{note:"G0",frequency:24.05},{note:"G#0",frequency:25.48},{note:"A0",frequency:27},{note:"A#0",frequency:28.61},{note:"B0",frequency:30.31},{note:"C1",frequency:32.11},{note:"C#1",frequency:34.02},{note:"D1",frequency:36.04},{note:"D#1",frequency:38.18},{note:"E1",frequency:40.45},{note:"F1",frequency:42.86},{note:"F#1",frequency:45.41},{note:"G1",frequency:48.11},{note:"G#1",frequency:50.97},{note:"A1",frequency:54},{note:"A#1",frequency:57.21},{note:"B1",frequency:60.61},{note:"C2",frequency:64.22},{note:"C#2",frequency:68.04},{note:"D2",frequency:72.08},{note:"D#2",frequency:76.37},{note:"E2",frequency:80.91},{note:"F2",frequency:85.72},{note:"F#2",frequency:90.82},{note:"G2",frequency:96.22},{note:"G#2",frequency:101.94},{note:"A2",frequency:108},{note:"A#2",frequency:114.42},{note:"B2",frequency:121.23},{note:"C3",frequency:128.43},{note:"C#3",frequency:136.07},{note:"D3",frequency:144.16},{note:"D#3",frequency:152.74},{note:"E3",frequency:161.82},{note:"F3",frequency:171.44},{note:"F#3",frequency:181.63},{note:"G3",frequency:192.43},{note:"G#3",frequency:203.88},{note:"A3",frequency:216},{note:"A#3",frequency:228.84},{note:"B3",frequency:242.45},{note:"C4",frequency:256.87},{note:"C#4",frequency:272.14},{note:"D4",frequency:288.33},{note:"D#4",frequency:305.47},{note:"E4",frequency:323.63},{note:"F4",frequency:342.88},{note:"F#4",frequency:363.27},{note:"G4",frequency:384.87},{note:"G#4",frequency:407.75},{note:"A4",frequency:432},{note:"A#4",frequency:457.69},{note:"B4",frequency:484.9},{note:"C5",frequency:513.74},{note:"C#5",frequency:544.29},{note:"D5",frequency:576.65},{note:"D#5",frequency:610.94},{note:"E5",frequency:647.27},{note:"F5",frequency:685.76},{note:"F#5",frequency:726.53},{note:"G5",frequency:769.74},{note:"G#5",frequency:815.51},{note:"A5",frequency:864},{note:"A#5",frequency:915.38},{note:"B5",frequency:969.81},{note:"C6",frequency:1027.47},{note:"C#6",frequency:1088.57},{note:"D6",frequency:1153.3},{note:"D#6",frequency:1221.88},{note:"E6",frequency:1294.54},{note:"F6",frequency:1371.51},{note:"F#6",frequency:1453.07},{note:"G6",frequency:1539.47},{note:"G#6",frequency:1631.01},{note:"A6",frequency:1728},{note:"A#6",frequency:1830.75},{note:"B6",frequency:1939.61},{note:"C7",frequency:2054.95},{note:"C#7",frequency:2177.14},{note:"D7",frequency:2306.6},{note:"D#7",frequency:2443.76},{note:"E7",frequency:2589.07},{note:"F7",frequency:2743.03},{note:"F#7",frequency:2906.14},{note:"G7",frequency:3078.95},{note:"G#7",frequency:3262.03},{note:"A7",frequency:3456},{note:"A#7",frequency:3661.5},{note:"B7",frequency:3879.23},{note:"C8",frequency:4109.9},{note:"C#8",frequency:4354.29},{note:"D8",frequency:4613.21},{note:"D#8",frequency:4887.52},{note:"E8",frequency:5178.15},{note:"F8",frequency:5486.06},{note:"F#8",frequency:5812.28},{note:"G8",frequency:6157.89},{note:"G#8",frequency:6524.06},{note:"A8",frequency:6912},{note:"A#8",frequency:7323.01},{note:"B8",frequency:7758.46}],434:[{note:"C0",frequency:16.13},{note:"C#0",frequency:17.09},{note:"D0",frequency:18.1},{note:"D#0",frequency:19.18},{note:"E0",frequency:20.32},{note:"F0",frequency:21.53},{note:"F#0",frequency:22.81},{note:"G0",frequency:24.17},{note:"G#0",frequency:25.6},{note:"A0",frequency:27.12},{note:"A#0",frequency:28.74},{note:"B0",frequency:30.45},{note:"C1",frequency:32.26},{note:"C#1",frequency:34.18},{note:"D1",frequency:36.21},{note:"D#1",frequency:38.36},{note:"E1",frequency:40.64},{note:"F1",frequency:43.06},{note:"F#1",frequency:45.62},{note:"G1",frequency:48.33},{note:"G#1",frequency:51.21},{note:"A1",frequency:54.25},{note:"A#1",frequency:57.48},{note:"B1",frequency:60.89},{note:"C2",frequency:64.51},{note:"C#2",frequency:68.35},{note:"D2",frequency:72.42},{note:"D#2",frequency:76.72},{note:"E2",frequency:81.28},{note:"F2",frequency:86.12},{note:"F#2",frequency:91.24},{note:"G2",frequency:96.66},{note:"G#2",frequency:102.41},{note:"A2",frequency:108.5},{note:"A#2",frequency:114.95},{note:"B2",frequency:121.79},{note:"C3",frequency:129.03},{note:"C#3",frequency:136.7},{note:"D3",frequency:144.83},{note:"D#3",frequency:153.44},{note:"E3",frequency:162.57},{note:"F3",frequency:172.23},{note:"F#3",frequency:182.47},{note:"G3",frequency:193.32},{note:"G#3",frequency:204.82},{note:"A3",frequency:217},{note:"A#3",frequency:229.9},{note:"B3",frequency:243.57},{note:"C4",frequency:258.06},{note:"C#4",frequency:273.4},{note:"D4",frequency:289.66},{note:"D#4",frequency:306.88},{note:"E4",frequency:325.13},{note:"F4",frequency:344.47},{note:"F#4",frequency:364.95},{note:"G4",frequency:386.65},{note:"G#4",frequency:409.64},{note:"A4",frequency:434},{note:"A#4",frequency:459.81},{note:"B4",frequency:487.15},{note:"C5",frequency:516.12},{note:"C#5",frequency:546.81},{note:"D5",frequency:579.32},{note:"D#5",frequency:613.77},{note:"E5",frequency:650.27},{note:"F5",frequency:688.93},{note:"F#5",frequency:729.9},{note:"G5",frequency:773.3},{note:"G#5",frequency:819.28},{note:"A5",frequency:868},{note:"A#5",frequency:919.61},{note:"B5",frequency:974.3},{note:"C6",frequency:1032.23},{note:"C#6",frequency:1093.61},{note:"D6",frequency:1158.64},{note:"D#6",frequency:1227.54},{note:"E6",frequency:1300.53},{note:"F6",frequency:1377.86},{note:"F#6",frequency:1459.8},{note:"G6",frequency:1546.6},{note:"G#6",frequency:1638.57},{note:"A6",frequency:1736},{note:"A#6",frequency:1839.23},{note:"B6",frequency:1948.59},{note:"C7",frequency:2064.46},{note:"C#7",frequency:2187.22},{note:"D7",frequency:2317.28},{note:"D#7",frequency:2455.07},{note:"E7",frequency:2601.06},{note:"F7",frequency:2755.73},{note:"F#7",frequency:2919.59},{note:"G7",frequency:3093.2},{note:"G#7",frequency:3277.13},{note:"A7",frequency:3472},{note:"A#7",frequency:3678.46},{note:"B7",frequency:3897.19},{note:"C8",frequency:4128.93},{note:"C#8",frequency:4374.44},{note:"D8",frequency:4634.56},{note:"D#8",frequency:4910.15},{note:"E8",frequency:5202.12},{note:"F8",frequency:5511.46},{note:"F#8",frequency:5839.18},{note:"G8",frequency:6186.4},{note:"G#8",frequency:6554.26},{note:"A8",frequency:6944},{note:"A#8",frequency:7356.91},{note:"B8",frequency:7794.38}],436:[{note:"C0",frequency:16.2},{note:"C#0",frequency:17.17},{note:"D0",frequency:18.19},{note:"D#0",frequency:19.27},{note:"E0",frequency:20.41},{note:"F0",frequency:21.63},{note:"F#0",frequency:22.91},{note:"G0",frequency:24.28},{note:"G#0",frequency:25.72},{note:"A0",frequency:27.25},{note:"A#0",frequency:28.87},{note:"B0",frequency:30.59},{note:"C1",frequency:32.41},{note:"C#1",frequency:34.33},{note:"D1",frequency:36.37},{note:"D#1",frequency:38.54},{note:"E1",frequency:40.83},{note:"F1",frequency:43.26},{note:"F#1",frequency:45.83},{note:"G1",frequency:48.55},{note:"G#1",frequency:51.44},{note:"A1",frequency:54.5},{note:"A#1",frequency:57.74},{note:"B1",frequency:61.17},{note:"C2",frequency:64.81},{note:"C#2",frequency:68.67},{note:"D2",frequency:72.75},{note:"D#2",frequency:77.07},{note:"E2",frequency:81.66},{note:"F2",frequency:86.51},{note:"F#2",frequency:91.66},{note:"G2",frequency:97.11},{note:"G#2",frequency:102.88},{note:"A2",frequency:109},{note:"A#2",frequency:115.48},{note:"B2",frequency:122.35},{note:"C3",frequency:129.62},{note:"C#3",frequency:137.33},{note:"D3",frequency:145.5},{note:"D#3",frequency:154.15},{note:"E3",frequency:163.32},{note:"F3",frequency:173.03},{note:"F#3",frequency:183.32},{note:"G3",frequency:194.22},{note:"G#3",frequency:205.76},{note:"A3",frequency:218},{note:"A#3",frequency:230.96},{note:"B3",frequency:244.7},{note:"C4",frequency:259.25},{note:"C#4",frequency:274.66},{note:"D4",frequency:290.99},{note:"D#4",frequency:308.3},{note:"E4",frequency:326.63},{note:"F4",frequency:346.05},{note:"F#4",frequency:366.63},{note:"G4",frequency:388.43},{note:"G#4",frequency:411.53},{note:"A4",frequency:436},{note:"A#4",frequency:461.93},{note:"B4",frequency:489.39},{note:"C5",frequency:518.49},{note:"C#5",frequency:549.33},{note:"D5",frequency:581.99},{note:"D#5",frequency:616.6},{note:"E5",frequency:653.26},{note:"F5",frequency:692.11},{note:"F#5",frequency:733.26},{note:"G5",frequency:776.86},{note:"G#5",frequency:823.06},{note:"A5",frequency:872},{note:"A#5",frequency:923.85},{note:"B5",frequency:978.79},{note:"C6",frequency:1036.99},{note:"C#6",frequency:1098.65},{note:"D6",frequency:1163.98},{note:"D#6",frequency:1233.19},{note:"E6",frequency:1306.52},{note:"F6",frequency:1384.21},{note:"F#6",frequency:1466.52},{note:"G6",frequency:1553.73},{note:"G#6",frequency:1646.12},{note:"A6",frequency:1744},{note:"A#6",frequency:1847.7},{note:"B6",frequency:1957.57},{note:"C7",frequency:2073.98},{note:"C#7",frequency:2197.3},{note:"D7",frequency:2327.96},{note:"D#7",frequency:2466.39},{note:"E7",frequency:2613.05},{note:"F7",frequency:2768.43},{note:"F#7",frequency:2933.05},{note:"G7",frequency:3107.45},{note:"G#7",frequency:3292.23},{note:"A7",frequency:3488},{note:"A#7",frequency:3695.41},{note:"B7",frequency:3915.15},{note:"C8",frequency:4147.95},{note:"C#8",frequency:4394.6},{note:"D8",frequency:4655.92},{note:"D#8",frequency:4932.78},{note:"E8",frequency:5226.09},{note:"F8",frequency:5536.85},{note:"F#8",frequency:5866.09},{note:"G8",frequency:6214.91},{note:"G#8",frequency:6584.47},{note:"A8",frequency:6976},{note:"A#8",frequency:7390.81},{note:"B8",frequency:7830.3}],438:[{note:"C0",frequency:16.28},{note:"C#0",frequency:17.25},{note:"D0",frequency:18.27},{note:"D#0",frequency:19.36},{note:"E0",frequency:20.51},{note:"F0",frequency:21.73},{note:"F#0",frequency:23.02},{note:"G0",frequency:24.39},{note:"G#0",frequency:25.84},{note:"A0",frequency:27.38},{note:"A#0",frequency:29},{note:"B0",frequency:30.73},{note:"C1",frequency:32.55},{note:"C#1",frequency:34.49},{note:"D1",frequency:36.54},{note:"D#1",frequency:38.71},{note:"E1",frequency:41.02},{note:"F1",frequency:43.46},{note:"F#1",frequency:46.04},{note:"G1",frequency:48.78},{note:"G#1",frequency:51.68},{note:"A1",frequency:54.75},{note:"A#1",frequency:58.01},{note:"B1",frequency:61.45},{note:"C2",frequency:65.11},{note:"C#2",frequency:68.98},{note:"D2",frequency:73.08},{note:"D#2",frequency:77.43},{note:"E2",frequency:82.03},{note:"F2",frequency:86.91},{note:"F#2",frequency:92.08},{note:"G2",frequency:97.55},{note:"G#2",frequency:103.35},{note:"A2",frequency:109.5},{note:"A#2",frequency:116.01},{note:"B2",frequency:122.91},{note:"C3",frequency:130.22},{note:"C#3",frequency:137.96},{note:"D3",frequency:146.16},{note:"D#3",frequency:154.86},{note:"E3",frequency:164.06},{note:"F3",frequency:173.82},{note:"F#3",frequency:184.16},{note:"G3",frequency:195.11},{note:"G#3",frequency:206.71},{note:"A3",frequency:219},{note:"A#3",frequency:232.02},{note:"B3",frequency:245.82},{note:"C4",frequency:260.44},{note:"C#4",frequency:275.92},{note:"D4",frequency:292.33},{note:"D#4",frequency:309.71},{note:"E4",frequency:328.13},{note:"F4",frequency:347.64},{note:"F#4",frequency:368.31},{note:"G4",frequency:390.21},{note:"G#4",frequency:413.42},{note:"A4",frequency:438},{note:"A#4",frequency:464.04},{note:"B4",frequency:491.64},{note:"C5",frequency:520.87},{note:"C#5",frequency:551.85},{note:"D5",frequency:584.66},{note:"D#5",frequency:619.43},{note:"E5",frequency:656.26},{note:"F5",frequency:695.28},{note:"F#5",frequency:736.63},{note:"G5",frequency:780.43},{note:"G#5",frequency:826.83},{note:"A5",frequency:876},{note:"A#5",frequency:928.09},{note:"B5",frequency:983.28},{note:"C6",frequency:1041.74},{note:"C#6",frequency:1103.69},{note:"D6",frequency:1169.32},{note:"D#6",frequency:1238.85},{note:"E6",frequency:1312.52},{note:"F6",frequency:1390.56},{note:"F#6",frequency:1473.25},{note:"G6",frequency:1560.85},{note:"G#6",frequency:1653.67},{note:"A6",frequency:1752},{note:"A#6",frequency:1856.18},{note:"B6",frequency:1966.55},{note:"C7",frequency:2083.49},{note:"C#7",frequency:2207.38},{note:"D7",frequency:2338.64},{note:"D#7",frequency:2477.7},{note:"E7",frequency:2625.03},{note:"F7",frequency:2781.13},{note:"F#7",frequency:2946.5},{note:"G7",frequency:3121.71},{note:"G#7",frequency:3307.34},{note:"A7",frequency:3504},{note:"A#7",frequency:3712.36},{note:"B7",frequency:3933.11},{note:"C8",frequency:4166.98},{note:"C#8",frequency:4414.76},{note:"D8",frequency:4677.28},{note:"D#8",frequency:4955.4},{note:"E8",frequency:5250.07},{note:"F8",frequency:5562.25},{note:"F#8",frequency:5893},{note:"G8",frequency:6243.42},{note:"G#8",frequency:6614.67},{note:"A8",frequency:7008},{note:"A#8",frequency:7424.72},{note:"B8",frequency:7866.21}],440:[{note:"C0",frequency:16.35},{note:"C#0",frequency:17.32},{note:"D0",frequency:18.35},{note:"D#0",frequency:19.45},{note:"E0",frequency:20.6},{note:"F0",frequency:21.83},{note:"F#0",frequency:23.12},{note:"G0",frequency:24.5},{note:"G#0",frequency:25.96},{note:"A0",frequency:27.5},{note:"A#0",frequency:29.14},{note:"B0",frequency:30.87},{note:"C1",frequency:32.7},{note:"C#1",frequency:34.65},{note:"D1",frequency:36.71},{note:"D#1",frequency:38.89},{note:"E1",frequency:41.2},{note:"F1",frequency:43.65},{note:"F#1",frequency:46.25},{note:"G1",frequency:49},{note:"G#1",frequency:51.91},{note:"A1",frequency:55},{note:"A#1",frequency:58.27},{note:"B1",frequency:61.74},{note:"C2",frequency:65.41},{note:"C#2",frequency:69.3},{note:"D2",frequency:73.42},{note:"D#2",frequency:77.78},{note:"E2",frequency:82.41},{note:"F2",frequency:87.31},{note:"F#2",frequency:92.5},{note:"G2",frequency:98},{note:"G#2",frequency:103.83},{note:"A2",frequency:110},{note:"A#2",frequency:116.54},{note:"B2",frequency:123.47},{note:"C3",frequency:130.81},{note:"C#3",frequency:138.59},{note:"D3",frequency:146.83},{note:"D#3",frequency:155.56},{note:"E3",frequency:164.81},{note:"F3",frequency:174.61},{note:"F#3",frequency:185},{note:"G3",frequency:196},{note:"G#3",frequency:207.65},{note:"A3",frequency:220},{note:"A#3",frequency:233.08},{note:"B3",frequency:246.94},{note:"C4",frequency:261.63},{note:"C#4",frequency:277.18},{note:"D4",frequency:293.66},{note:"D#4",frequency:311.13},{note:"E4",frequency:329.63},{note:"F4",frequency:349.23},{note:"F#4",frequency:369.99},{note:"G4",frequency:392},{note:"G#4",frequency:415.3},{note:"A4",frequency:440},{note:"A#4",frequency:466.16},{note:"B4",frequency:493.88},{note:"C5",frequency:523.25},{note:"C#5",frequency:554.37},{note:"D5",frequency:587.33},{note:"D#5",frequency:622.25},{note:"E5",frequency:659.25},{note:"F5",frequency:698.46},{note:"F#5",frequency:739.99},{note:"G5",frequency:783.99},{note:"G#5",frequency:830.61},{note:"A5",frequency:880},{note:"A#5",frequency:932.33},{note:"B5",frequency:987.77},{note:"C6",frequency:1046.5},{note:"C#6",frequency:1108.73},{note:"D6",frequency:1174.66},{note:"D#6",frequency:1244.51},{note:"E6",frequency:1318.51},{note:"F6",frequency:1396.91},{note:"F#6",frequency:1479.98},{note:"G6",frequency:1567.98},{note:"G#6",frequency:1661.22},{note:"A6",frequency:1760},{note:"A#6",frequency:1864.66},{note:"B6",frequency:1975.53},{note:"C7",frequency:2093},{note:"C#7",frequency:2217.46},{note:"D7",frequency:2349.32},{note:"D#7",frequency:2489.02},{note:"E7",frequency:2637.02},{note:"F7",frequency:2793.83},{note:"F#7",frequency:2959.96},{note:"G7",frequency:3135.96},{note:"G#7",frequency:3322.44},{note:"A7",frequency:3520},{note:"A#7",frequency:3729.31},{note:"B7",frequency:3951.07},{note:"C8",frequency:4186.01},{note:"C#8",frequency:4434.92},{note:"D8",frequency:4698.63},{note:"D#8",frequency:4978.03},{note:"E8",frequency:5274.04},{note:"F8",frequency:5587.65},{note:"F#8",frequency:5919.91},{note:"G8",frequency:6271.93},{note:"G#8",frequency:6644.88},{note:"A8",frequency:7040},{note:"A#8",frequency:7458.62},{note:"B8",frequency:7902.13}],442:[{note:"C0",frequency:16.43},{note:"C#0",frequency:17.4},{note:"D0",frequency:18.44},{note:"D#0",frequency:19.53},{note:"E0",frequency:20.7},{note:"F0",frequency:21.93},{note:"F#0",frequency:23.23},{note:"G0",frequency:24.61},{note:"G#0",frequency:26.07},{note:"A0",frequency:27.62},{note:"A#0",frequency:29.27},{note:"B0",frequency:31.01},{note:"C1",frequency:32.85},{note:"C#1",frequency:34.81},{note:"D1",frequency:36.87},{note:"D#1",frequency:39.07},{note:"E1",frequency:41.39},{note:"F1",frequency:43.85},{note:"F#1",frequency:46.46},{note:"G1",frequency:49.22},{note:"G#1",frequency:52.15},{note:"A1",frequency:55.25},{note:"A#1",frequency:58.54},{note:"B1",frequency:62.02},{note:"C2",frequency:65.7},{note:"C#2",frequency:69.61},{note:"D2",frequency:73.75},{note:"D#2",frequency:78.14},{note:"E2",frequency:82.78},{note:"F2",frequency:87.7},{note:"F#2",frequency:92.92},{note:"G2",frequency:98.44},{note:"G#2",frequency:104.3},{note:"A2",frequency:110.5},{note:"A#2",frequency:117.07},{note:"B2",frequency:124.03},{note:"C3",frequency:131.41},{note:"C#3",frequency:139.22},{note:"D3",frequency:147.5},{note:"D#3",frequency:156.27},{note:"E3",frequency:165.56},{note:"F3",frequency:175.41},{note:"F#3",frequency:185.84},{note:"G3",frequency:196.89},{note:"G#3",frequency:208.6},{note:"A3",frequency:221},{note:"A#3",frequency:234.14},{note:"B3",frequency:248.06},{note:"C4",frequency:262.81},{note:"C#4",frequency:278.44},{note:"D4",frequency:295},{note:"D#4",frequency:312.54},{note:"E4",frequency:331.13},{note:"F4",frequency:350.82},{note:"F#4",frequency:371.68},{note:"G4",frequency:393.78},{note:"G#4",frequency:417.19},{note:"A4",frequency:442},{note:"A#4",frequency:468.28},{note:"B4",frequency:496.13},{note:"C5",frequency:525.63},{note:"C#5",frequency:556.88},{note:"D5",frequency:590},{note:"D#5",frequency:625.08},{note:"E5",frequency:662.25},{note:"F5",frequency:701.63},{note:"F#5",frequency:743.35},{note:"G5",frequency:787.55},{note:"G#5",frequency:834.38},{note:"A5",frequency:884},{note:"A#5",frequency:936.57},{note:"B5",frequency:992.26},{note:"C6",frequency:1051.26},{note:"C#6",frequency:1113.77},{note:"D6",frequency:1180},{note:"D#6",frequency:1250.16},{note:"E6",frequency:1324.5},{note:"F6",frequency:1403.26},{note:"F#6",frequency:1486.7},{note:"G6",frequency:1575.11},{note:"G#6",frequency:1668.77},{note:"A6",frequency:1768},{note:"A#6",frequency:1873.13},{note:"B6",frequency:1984.51},{note:"C7",frequency:2102.52},{note:"C#7",frequency:2227.54},{note:"D7",frequency:2360},{note:"D#7",frequency:2500.33},{note:"E7",frequency:2649.01},{note:"F7",frequency:2806.52},{note:"F#7",frequency:2973.41},{note:"G7",frequency:3150.22},{note:"G#7",frequency:3337.54},{note:"A7",frequency:3536},{note:"A#7",frequency:3746.26},{note:"B7",frequency:3969.03},{note:"C8",frequency:4205.03},{note:"C#8",frequency:4455.08},{note:"D8",frequency:4719.99},{note:"D#8",frequency:5000.66},{note:"E8",frequency:5298.01},{note:"F8",frequency:5613.05},{note:"F#8",frequency:5946.82},{note:"G8",frequency:6300.44},{note:"G#8",frequency:6675.08},{note:"A8",frequency:7072},{note:"A#8",frequency:7492.52},{note:"B8",frequency:7938.05}],444:[{note:"C0",frequency:16.5},{note:"C#0",frequency:17.48},{note:"D0",frequency:18.52},{note:"D#0",frequency:19.62},{note:"E0",frequency:20.79},{note:"F0",frequency:22.03},{note:"F#0",frequency:23.33},{note:"G0",frequency:24.72},{note:"G#0",frequency:26.19},{note:"A0",frequency:27.75},{note:"A#0",frequency:29.4},{note:"B0",frequency:31.15},{note:"C1",frequency:33},{note:"C#1",frequency:34.96},{note:"D1",frequency:37.04},{note:"D#1",frequency:39.24},{note:"E1",frequency:41.58},{note:"F1",frequency:44.05},{note:"F#1",frequency:46.67},{note:"G1",frequency:49.44},{note:"G#1",frequency:52.39},{note:"A1",frequency:55.5},{note:"A#1",frequency:58.8},{note:"B1",frequency:62.3},{note:"C2",frequency:66},{note:"C#2",frequency:69.93},{note:"D2",frequency:74.08},{note:"D#2",frequency:78.49},{note:"E2",frequency:83.16},{note:"F2",frequency:88.1},{note:"F#2",frequency:93.34},{note:"G2",frequency:98.89},{note:"G#2",frequency:104.77},{note:"A2",frequency:111},{note:"A#2",frequency:117.6},{note:"B2",frequency:124.59},{note:"C3",frequency:132},{note:"C#3",frequency:139.85},{note:"D3",frequency:148.17},{note:"D#3",frequency:156.98},{note:"E3",frequency:166.31},{note:"F3",frequency:176.2},{note:"F#3",frequency:186.68},{note:"G3",frequency:197.78},{note:"G#3",frequency:209.54},{note:"A3",frequency:222},{note:"A#3",frequency:235.2},{note:"B3",frequency:249.19},{note:"C4",frequency:264},{note:"C#4",frequency:279.7},{note:"D4",frequency:296.33},{note:"D#4",frequency:313.96},{note:"E4",frequency:332.62},{note:"F4",frequency:352.4},{note:"F#4",frequency:373.36},{note:"G4",frequency:395.56},{note:"G#4",frequency:419.08},{note:"A4",frequency:444},{note:"A#4",frequency:470.4},{note:"B4",frequency:498.37},{note:"C5",frequency:528.01},{note:"C#5",frequency:559.4},{note:"D5",frequency:592.67},{note:"D#5",frequency:627.91},{note:"E5",frequency:665.25},{note:"F5",frequency:704.81},{note:"F#5",frequency:746.72},{note:"G5",frequency:791.12},{note:"G#5",frequency:838.16},{note:"A5",frequency:888},{note:"A#5",frequency:940.8},{note:"B5",frequency:996.75},{note:"C6",frequency:1056.02},{note:"C#6",frequency:1118.81},{note:"D6",frequency:1185.34},{note:"D#6",frequency:1255.82},{note:"E6",frequency:1330.5},{note:"F6",frequency:1409.61},{note:"F#6",frequency:1493.43},{note:"G6",frequency:1582.24},{note:"G#6",frequency:1676.32},{note:"A6",frequency:1776},{note:"A#6",frequency:1881.61},{note:"B6",frequency:1993.49},{note:"C7",frequency:2112.03},{note:"C#7",frequency:2237.62},{note:"D7",frequency:2370.67},{note:"D#7",frequency:2511.64},{note:"E7",frequency:2660.99},{note:"F7",frequency:2819.22},{note:"F#7",frequency:2986.86},{note:"G7",frequency:3164.47},{note:"G#7",frequency:3352.64},{note:"A7",frequency:3552},{note:"A#7",frequency:3763.21},{note:"B7",frequency:3986.99},{note:"C8",frequency:4224.06},{note:"C#8",frequency:4475.24},{note:"D8",frequency:4741.35},{note:"D#8",frequency:5023.29},{note:"E8",frequency:5321.99},{note:"F8",frequency:5638.45},{note:"F#8",frequency:5973.73},{note:"G8",frequency:6328.94},{note:"G#8",frequency:6705.28},{note:"A8",frequency:7104},{note:"A#8",frequency:7526.43},{note:"B8",frequency:7973.97}],446:[{note:"C0",frequency:16.57},{note:"C#0",frequency:17.56},{note:"D0",frequency:18.6},{note:"D#0",frequency:19.71},{note:"E0",frequency:20.88},{note:"F0",frequency:22.12},{note:"F#0",frequency:23.44},{note:"G0",frequency:24.83},{note:"G#0",frequency:26.31},{note:"A0",frequency:27.88},{note:"A#0",frequency:29.53},{note:"B0",frequency:31.29},{note:"C1",frequency:33.15},{note:"C#1",frequency:35.12},{note:"D1",frequency:37.21},{note:"D#1",frequency:39.42},{note:"E1",frequency:41.77},{note:"F1",frequency:44.25},{note:"F#1",frequency:46.88},{note:"G1",frequency:49.67},{note:"G#1",frequency:52.62},{note:"A1",frequency:55.75},{note:"A#1",frequency:59.07},{note:"B1",frequency:62.58},{note:"C2",frequency:66.3},{note:"C#2",frequency:70.24},{note:"D2",frequency:74.42},{note:"D#2",frequency:78.84},{note:"E2",frequency:83.53},{note:"F2",frequency:88.5},{note:"F#2",frequency:93.76},{note:"G2",frequency:99.34},{note:"G#2",frequency:105.24},{note:"A2",frequency:111.5},{note:"A#2",frequency:118.13},{note:"B2",frequency:125.15},{note:"C3",frequency:132.6},{note:"C#3",frequency:140.48},{note:"D3",frequency:148.83},{note:"D#3",frequency:157.68},{note:"E3",frequency:167.06},{note:"F3",frequency:177},{note:"F#3",frequency:187.52},{note:"G3",frequency:198.67},{note:"G#3",frequency:210.48},{note:"A3",frequency:223},{note:"A#3",frequency:236.26},{note:"B3",frequency:250.31},{note:"C4",frequency:265.19},{note:"C#4",frequency:280.96},{note:"D4",frequency:297.67},{note:"D#4",frequency:315.37},{note:"E4",frequency:334.12},{note:"F4",frequency:353.99},{note:"F#4",frequency:375.04},{note:"G4",frequency:397.34},{note:"G#4",frequency:420.97},{note:"A4",frequency:446},{note:"A#4",frequency:472.52},{note:"B4",frequency:500.62},{note:"C5",frequency:530.39},{note:"C#5",frequency:561.92},{note:"D5",frequency:595.34},{note:"D#5",frequency:630.74},{note:"E5",frequency:668.24},{note:"F5",frequency:707.98},{note:"F#5",frequency:750.08},{note:"G5",frequency:794.68},{note:"G#5",frequency:841.94},{note:"A5",frequency:892},{note:"A#5",frequency:945.04},{note:"B5",frequency:1001.24},{note:"C6",frequency:1060.77},{note:"C#6",frequency:1123.85},{note:"D6",frequency:1190.68},{note:"D#6",frequency:1261.48},{note:"E6",frequency:1336.49},{note:"F6",frequency:1415.96},{note:"F#6",frequency:1500.16},{note:"G6",frequency:1589.36},{note:"G#6",frequency:1683.87},{note:"A6",frequency:1784},{note:"A#6",frequency:1890.08},{note:"B6",frequency:2002.47},{note:"C7",frequency:2121.54},{note:"C#7",frequency:2247.7},{note:"D7",frequency:2381.35},{note:"D#7",frequency:2522.96},{note:"E7",frequency:2672.98},{note:"F7",frequency:2831.92},{note:"F#7",frequency:3000.32},{note:"G7",frequency:3178.73},{note:"G#7",frequency:3367.74},{note:"A7",frequency:3568},{note:"A#7",frequency:3780.16},{note:"B7",frequency:4004.95},{note:"C8",frequency:4243.09},{note:"C#8",frequency:4495.4},{note:"D8",frequency:4762.71},{note:"D#8",frequency:5045.91},{note:"E8",frequency:5345.96},{note:"F8",frequency:5663.85},{note:"F#8",frequency:6000.64},{note:"G8",frequency:6357.45},{note:"G#8",frequency:6735.49},{note:"A8",frequency:7136},{note:"A#8",frequency:7560.33},{note:"B8",frequency:8009.89}]};var Drummer=function(){this.patternView=null;this.music=null;this.uiComponent=null;this.savedPattern=null;this.saveLoopCurrentPattern=false;this.keys=[];this.drumPatterns=[{name:"Drum pattern 1",pattern:{bass:[[1,0,0,0],[0,0,0,0],[1,0,2,0],[0,0,0,0],[1,0,0,0],[0,0,0,2],[1,0,2,0],[0,0,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,3,0],[1,0,2,0]],hihatClosed:[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 2",pattern:{bass:[[1,0,0,0],[0,0,0,0],[1,2,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,2],[1,2,0,0],[0,0,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,2,0,0],[1,0,3,0]],hihatClosed:[[0,0,1,2],[0,0,1,0],[0,0,1,2],[0,0,1,0],[0,0,1,2],[0,0,1,0],[0,0,2,1],[0,0,1,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 3",pattern:{bass:[[1,0,0,0],[0,0,0,0],[1,0,1,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,1,0],[0,0,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0]],hihatClosed:[[0,1,1,1],[0,0,1,1],[0,1,0,1],[0,0,1,1],[0,1,1,1],[0,0,1,1],[0,1,1,1],[0,0,1,1]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 4",pattern:{bass:[[1,0,0,3],[0,0,0,0],[1,0,2,0],[0,0,0,3],[1,0,0,0],[0,0,0,3],[1,0,2,0],[0,0,0,3]],snare:[[0,3,0,0],[1,0,0,2],[0,3,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,2,0,0],[1,0,0,0]],hihatClosed:[[0,0,1,0],[0,0,2,0],[0,3,0,3],[0,3,1,0],[0,3,1,0],[0,0,2,0],[0,0,0,3],[0,3,1,0]]},settings:{bass:{value:2},snare:{value:2},hihatClosed:{value:2}}},{name:"Drum pattern 5",pattern:{bass:[[1,0,0,0],[0,0,0,0],[1,2,0,0],[0,0,0,0],[1,0,2,0],[0,0,3,2],[0,0,2,0],[0,0,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,2],[0,0,0,0],[1,0,0,0],[0,0,0,3],[1,0,0,0]],hihatClosed:[[3,3,1,0],[0,0,0,2],[0,0,1,0],[0,0,1,0],[3,3,0,0],[0,0,0,0],[3,3,0,0],[0,0,0,0]],hihatOpen:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,0],[0,0,0,0]]},settings:{bass:{value:2},snare:{value:2},hihatClosed:{value:2},hihatOpen:{value:2}}},{name:"Drum pattern 6",pattern:{bass:[[1,0,0,1],[0,0,1,0],[1,0,0,1],[0,0,1,1],[1,0,0,1],[0,0,0,1],[0,0,1,0],[0,0,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0]],hihatClosed:[[0,0,1,0],[0,1,0,1],[0,1,1,0],[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,1,0]]},settings:{bass:{value:2},snare:{value:2},hihatClosed:{value:2},hihatOpen:{value:2}}},{name:"Drum pattern 7",pattern:{bass:[[1,0,0,0],[0,0,0,0],[1,0,2,0],[0,0,0,3],[1,0,0,0],[0,0,0,0],[1,0,2,0],[0,0,0,3]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0]],bongo:[[0,2,1,3],[0,3,1,0],[0,1,0,2],[0,0,1,0],[0,2,1,3],[0,3,1,0],[0,1,0,2],[0,0,1,0]]},settings:{bass:{value:2},snare:{value:1},bongo:{value:1}}},{name:"Drum pattern 8",pattern:{bass:[[1,0,0,0],[0,0,0,0],[1,0,2,0],[0,0,0,3],[1,0,0,0],[0,0,0,0],[1,0,2,0],[0,0,0,3]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0]],tom:[[0,0,0,0],[0,0,0,1],[0,0,0,0],[0,1,0,1],[0,1,0,1],[0,0,0,0],[0,1,1,1],[0,1,1,1]],hihatClosed:[[0,2,1,3],[0,3,1,0],[0,0,1,2],[0,0,1,0],[0,2,1,3],[0,3,1,0],[0,0,0,2],[0,0,0,0]]},settings:{bass:{value:1},snare:{value:1},tom:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 9",pattern:{bass:[[1,0,0,0],[0,0,0,0],[3,2,1,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[3,2,1,0],[0,0,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,2,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,2,0]],hihatClosed:[[0,0,1,0],[0,0,1,0],[2,0,0,0],[0,0,1,0],[0,0,1,0],[0,0,1,0],[2,0,0,0],[0,0,1,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 10",pattern:{bass:[[1,0,0,1],[0,0,0,0],[1,0,1,0],[0,0,0,1],[1,2,0,1],[0,0,0,0],[1,0,1,0],[0,0,0,1]],snare:[[0,0,0,0],[1,0,0,0],[0,2,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,2,0,0],[1,0,0,0]],hihatClosed:[[0,0,1,0],[0,0,1,2],[0,0,0,2],[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,0,2],[0,0,1,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 11",pattern:{bass:[[1,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[0,0,0,0]],hihatOpen:[[0,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0]],hihatClosed:[[0,0,1,0],[0,0,1,0],[0,0,1,0],[1,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,2,0],[1,0,1,0]],woodblock:[[0,0,0,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,1],[0,1,0,0],[0,0,0,0],[0,0,0,0]]},settings:{bass:{value:1},snare:{value:1},hihatOpen:{value:1},hihatClosed:{value:1},woodblock:{value:1}}},{name:"Drum pattern 12",pattern:{bass:[[1,0,0,1],[0,0,0,0],[0,0,1,0],[0,0,0,1],[2,3,0,1],[0,0,0,0],[1,2,1,0],[0,0,0,2]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0]],hihatClosed:[[0,0,1,0],[0,0,1,2],[1,0,0,2],[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,0,2],[0,0,1,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 13",pattern:{bass:[[1,0,0,0],[0,0,0,0],[0,0,1,0],[0,0,0,0],[1,0,0,0],[0,0,0,1],[0,0,1,0],[0,0,0,2]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0]],hihatClosed:[[0,0,1,0],[0,0,1,0],[1,0,0,0],[0,0,1,0],[0,0,1,0],[0,0,1,0],[1,0,0,0],[0,0,1,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 14",pattern:{bass:[[1,0,2,0],[0,0,0,3],[0,1,0,2],[0,0,0,0],[1,0,2,0],[0,0,0,3],[0,2,0,1],[0,0,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,2],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,2]],hihatClosed:[[0,1,0,0],[0,0,1,0],[0,0,0,0],[0,0,1,0],[0,1,0,0],[0,0,1,0],[0,0,0,0],[0,0,1,0]],woodblock:[[0,0,0,1],[0,1,0,3],[2,0,0,0],[0,0,0,0],[0,0,0,1],[0,1,0,0],[2,0,0,0],[0,0,0,0]]},settings:{bass:{value:2},snare:{value:1},hihatClosed:{value:1},woodblock:{value:1}}},{name:"Drum pattern 15",pattern:{bass:[[1,0,0,0],[0,0,0,3],[0,1,0,1],[0,0,0,0],[1,0,0,0],[0,0,0,0],[0,1,0,2],[0,2,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,2],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,2]],hihatClosed:[[0,0,1,0],[0,0,1,0],[1,0,1,0],[1,0,1,0],[0,0,1,0],[0,0,1,0],[1,0,1,0],[0,0,1,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 16",pattern:{bass:[[1,0,1,0],[0,0,0,3],[0,0,1,1],[0,0,0,0],[1,0,1,0],[0,0,0,0],[0,0,1,2],[0,2,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,2],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,2]],hihatClosed:[[0,0,0,0],[0,0,1,0],[1,0,0,0],[0,0,1,0],[0,0,0,0],[0,0,1,0],[1,0,0,0],[0,0,1,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 17",pattern:{bass:[[0,0,0,1],[0,1,0,0],[1,0,0,1],[0,1,0,0],[0,0,0,1],[0,1,0,0],[1,0,1,1],[0,1,0,1]],snare:[[0,0,1,0],[1,0,0,0],[0,0,1,0],[1,0,0,0],[0,0,1,0],[1,0,0,0],[0,0,0,0],[1,0,0,0]],hihatClosed:[[1,0,0,0],[0,0,0,1],[0,0,0,0],[0,0,0,1],[1,0,0,0],[0,0,0,1],[1,0,1,0],[0,0,1,0]],hihatOpen:[[0,0,0,0],[0,0,0,0],[0,1,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,1,0,0],[0,0,0,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1},hihatOpen:{value:1}}},{name:"Drum pattern 18",pattern:{bass:[[1,0,0,0],[0,0,0,0],[0,0,1,0],[0,0,0,0],[1,0,0,0],[0,0,0,1],[0,0,1,0],[0,0,0,0]],snare:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0]],hihatClosed:[[0,0,1,0],[0,0,1,0],[1,0,0,0],[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,0,0],[0,0,1,1]],hihatOpen:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1},hihatOpen:{value:1}}},{name:"Drum pattern 19",pattern:{bass:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0]],snare:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,1,0,0],[0,0,0,0]],hihatClosed:[[1,2,1,2],[0,2,1,2],[1,2,1,2],[0,2,1,2],[1,2,1,2],[0,2,1,2],[1,0,0,2],[0,2,1,2]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}},{name:"Drum pattern 20",pattern:{bass:[[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,0,0],[0,0,0,0]],clap:[[0,0,0,0],[1,0,0,0],[0,0,0,0],[1,0,1,0],[0,0,0,0],[1,0,0,0],[0,1,0,1],[1,0,1,0]],hihatClosed:[[0,2,2,2],[0,0,2,2],[0,0,2,2],[0,0,0,0],[0,2,2,2],[0,0,2,2],[0,0,0,0],[0,0,0,0]]},settings:{bass:{value:1},snare:{value:1},hihatClosed:{value:1}}}]};Drummer.prototype={init:function(e){this.music=e},start:function(){var t=this;this.patternId=this.music.patternView.getPatternId();this.savedPattern=this.music.patterns.getDataCopy(this.patternId);var e=this.music.patterns.getDuration(this.patternId);this.bars=Math.ceil(e/16);while(this.keys.length<this.bars){this.keys.push({key:0,scale:"major"})}if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"drummerDialog",title:"Create A Beat",width:640});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/music/drummer.html",function(){t.initContent()});this.okButton=UI.create("UI.Button",{text:"Import",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){t.music.loopSelection=t.saveLoopCurrentPattern;UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){t.music.patterns.setFromData(t.patternId,t.savedPattern);t.music.patternView.drawPattern();t.music.loopSelection=t.saveLoopCurrentPattern;UI.closeDialog()})}else{this.chooseDrumPattern(false)}this.saveLoopCurrentPattern=this.music.loopSelection;this.music.loopSelection=true;UI.showDialog("drummerDialog")},initContent:function(){var t=this;var e="";for(var i=0;i<this.drumPatterns.length;i++){var r=this.drumPatterns[i].name;e+='<div class="drummerPatternListEntry ';e+='" value="'+i+'">'+r+"</div>"}$("#drummerPatterns").html(e);$(".drummerPatternListEntry").on("click",function(){var e=parseInt($(this).attr("value"),10);$(".drummerPatternListEntry").removeClass("drummerPatternListEntrySelected");$(this).addClass("drummerPatternListEntrySelected");t.chooseDrumPattern(e)})},keyChooserHTML:function(){var e="";var t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];for(var i=0;i<this.bars;i++){e+="<div>";var r=i+1;e+="Bar "+r;e+="Key:";e+='<select class="drummerBarKey"  data-bar="'+i+'" id="drummerBarKey_'+i+'">';for(var a=0;a<t.length;a++){e+='<option value="'+a+'" ';if(a==this.keys[i].key){e+=' selected="selected" '}e+=">";e+=t[a];e+="</option>"}e+="</select>";e+="Scale:";e+='<select class="drummerBarScale"  data-bar="'+i+'" id="drummerBarScale_'+i+'">';for(var s in this.music.scales.scales){e+='<option value="'+s+'" ';if(s==this.keys[i].scale){e+=' selected="selected" '}e+=">";e+=this.music.scales.scales[s].name;e+="</option>"}e+="</select>";e+="</div>"}$("#drummerKeys").html("KEYS"+e);var o=this;$(".drummerBarKey").on("change",function(){var e=$(this).attr("data-bar");var t=parseInt($("#drummerBarKey_"+e).val(),10);console.log("set key to "+t);o.keys[e].key=t;o.applyDrumPattern()});$(".drummerBarScale").on("change",function(){var e=$(this).attr("data-bar");var t=$("#drummerBarScale_"+e).val();console.log("set scale to "+t);o.keys[e].scale=t;o.applyDrumPattern()})},setVolumeValues:function(e){this.drumPatterns[this.selectedDrumPatternIndex].settings[e].volume=[];for(var t=0;t<4;t++){var i=parseInt($("#drummerInstrumentEffect_"+e+"_volume_"+t).val(),10);this.drumPatterns[this.selectedDrumPatternIndex].settings[e].volume.push(i)}},setPortamentoValues:function(e){this.drumPatterns[this.selectedDrumPatternIndex].settings[e].portamento=[];for(var t=0;t<4;t++){var i=parseInt($("#drummerInstrumentEffect_"+e+"_portamento_"+t).val(),10);this.drumPatterns[this.selectedDrumPatternIndex].settings[e].portamento.push(i)}},chooseDrumPattern:function(e){if(e===false){this.patternId=false;$("#drummerParameters").html("Choose a Drum Pattern");return}var t={};t["snare"]=1;t["tom"]=2;t["bass"]=3;t["hihatOpen"]=4;t["hihatClosed"]=5;t["clap"]=7;t["bongo"]=8;t["woodblock"]=9;this.selectedDrumPatternIndex=e;this.patternId=this.music.patternView.getPatternId();var i=this.drumPatterns[e].pattern;var r="";for(var a in i){if(i.hasOwnProperty(a)){var s=0;var o=1;for(var l=0;l<i[a].length;l++){for(var n=0;n<i[a][l].length;n++){if(i[a][l][n]<s){s=i[a][l][n]}if(i[a][l][n]>o){o=i[a][l][n]}}}var h=1;var d=t[a];if(typeof this.drumPatterns[e].settings=="undefined"){this.drumPatterns[e].settings={}}if(typeof this.drumPatterns[e].settings[a]=="undefined"){this.drumPatterns[e].settings[a]={}}if(typeof this.drumPatterns[e].settings[a].value!="undefined"){h=this.drumPatterns[e].settings[a].value}else{this.drumPatterns[e].settings[a]={value:h}}if(typeof this.drumPatterns[e].settings[a].mappedTo=="undefined"){this.drumPatterns[e].settings[a].mappedTo=d}else{d=this.drumPatterns[e].settings[a].mappedTo}var c="none";if(typeof this.drumPatterns[e].settings[a].effect=="undefined"){this.drumPatterns[e].settings[a].effect="none"}else{c=this.drumPatterns[e].settings[a].effect}var f="constant";if(typeof this.drumPatterns[e].settings[a].pitch=="undefined"){this.drumPatterns[e].settings[a].pitch="constant"}else{f=this.drumPatterns[e].settings[a].pitch}var u=0;if(typeof this.drumPatterns[e].settings[a].key=="undefined"){this.drumPatterns[e].settings[a].key=0}else{u=this.drumPatterns[e].settings[a].key}var p="major";if(typeof this.drumPatterns[e].settings[a].scale=="undefined"){this.drumPatterns[e].settings[a].scale=p}else{p=this.drumPatterns[e].settings[a].scale}var v=[0,2,4];if(typeof this.drumPatterns[e].settings[a].notes=="undefined"){this.drumPatterns[e].settings[a].notes=v}else{v=this.drumPatterns[e].settings[a].notes}var g=[4];if(typeof this.drumPatterns[e].settings[a].octaves=="undefined"){this.drumPatterns[e].settings[a].octaves=g}else{g=this.drumPatterns[e].settings[a].octaves}var m=a;switch(m){case"bass":m="Kick";break;case"snare":m="Snare";break;case"hihatClosed":m="Hihat Closed";break;case"hihatOpen":m="Hihat Open";break;case"tom":m="Tom";break;case"bongo":m="Bongo";break;case"woodblock":m="Woodblock";break}r+='<div style="padding-bottom: 4px">';r+='<h3 style="margin: 8px 0 2px 0; padding-bottom: 4px; font-size: 16px; border-bottom: 1px solid #aaaaaa">'+m+"</h3>";r+='<div class="formRow">';r+='<label class="controlLabel">Amount</label>';r+='<input style="width: 300px" type="range" min="'+s+'" max="'+o+'" value="'+h+'" class="drummerInstrumentSlider" data-instrument="'+a+'" id="drummerInstrument-'+a+'">';r+="</div>";r+='<div class="formRow">';r+='<label class="controlLabel">Mapped To</label>';r+='<select class="drummerInstrumentMapping" data-instrument="'+a+'" id="drummerInstrumentMapping-'+a+'">';for(var l=1;l<this.music.doc.data.instruments.length;l++){r+='<option value="'+l+'" ';if(d==l){r+=' selected="selected" '}r+=">"+this.music.doc.data.instruments[l].name+"</option>"}r+="</select>";r+="</div>";r+='<div class="formRow">';r+='<label class="controlLabel">Effect</label>';r+='<label><input type="radio" ';if(c=="none"){r+=' checked="checked" '}r+=' class="drummerInstrumentEffect"  name="drummerInstrumentEffect_'+a+'" value="none" data-instrument="'+a+'">None</label>';r+='<label><input type="radio" ';if(c=="volume"){r+=' checked="checked" '}r+=' class="drummerInstrumentEffect"  name="drummerInstrumentEffect_'+a+'" value="volume" data-instrument="'+a+'">Volume</label>';r+='<label><input type="radio" ';if(c=="portamento"){r+=' checked="checked" '}r+=' class="drummerInstrumentEffect"  name="drummerInstrumentEffect_'+a+'" value="portamento" data-instrument="'+a+'">Portamento</label>';r+="</div>";r+='<div class="formRow" id="drummerInstrumentVolumeRow_'+a+'" ';if(c!="volume"){r+=' style="display: none" '}r+=">";r+='<label class="controlLabel">Volume</label>';for(var l=0;l<4;l++){var y=12;switch(l){case 0:y=14;break;case 1:y=8;break;case 2:y=10;break;case 3:y=5;break}if(typeof this.drumPatterns[e].settings[a].volume!="undefined"&&this.drumPatterns[e].settings[a].volume.length>l){y=this.drumPatterns[e].settings[a].volume[l]}r+='<select class="drummerVolume" data-instrument="'+a+'" id="drummerInstrumentEffect_'+a+"_volume_"+l+'">';for(var n=0;n<16;n++){r+='<option value="'+n+'" ';if(n==y){r+=' selected="selected" '}r+=">"+n+"</optiopn>"}r+="</select>";r+="&nbsp;&nbsp;"}r+="</div>";r+='<div class="formRow" id="drummerInstrumentPortamentoRow_'+a+'" ';if(c!="portamento"){r+=' style="display: none" '}r+=">";r+='<label class="controlLabel">Portamento</label>';for(var l=0;l<4;l++){var b=12;switch(l){case 0:b=14;break;case 1:b=8;break;case 2:b=10;break;case 3:b=5;break}if(typeof this.drumPatterns[e].settings[a].portamento!="undefined"&&this.drumPatterns[e].settings[a].portamento.length>l){b=this.drumPatterns[e].settings[a].portamento[l]}r+='<select class="drummerPortamento" data-instrument="'+a+'" id="drummerInstrumentEffect_'+a+"_portamento_"+l+'">';for(var n=0;n<64;n++){var h=n-32;r+='<option value="'+h+'" ';if(h==b){r+=' selected="selected" '}r+=">"+h+"</optiopn>"}r+="</select>";r+="&nbsp;&nbsp;"}r+="</div>";r+='<div class="formRow">';r+='<label class="controlLabel">Pitch</label>';r+='<label><input type="radio" ';if(f=="constant"){r+=' checked="checked" '}r+=' class="drummerInstrumentPitch"  name="drummerInstrumentPitch_'+a+'" value="constant" data-instrument="'+a+'">Constant</label>';r+='<label><input type="radio" ';if(f=="variable"){r+=' checked="checked" '}r+=' class="drummerInstrumentPitch"  name="drummerInstrumentPitch_'+a+'" value="variable" data-instrument="'+a+'">Variable</label>';r+="</div>";r+='<div class="formRow" id="drummerInstrumentNotesHolder_'+a+'" ';if(f!="variable"){r+=' style="display: none" '}r+=">";r+='<label class="controlLabel">Notes</label>';for(var l=0;l<this.music.scales.scales[p].intervals.length;l++){var C="";for(var n=0;n<v.length;n++){if(v[n]==l){C=' checked="checked" '}}var x=l+1;r+='<label> <input type="checkbox"  '+C+' value="'+l+'" class="drummerInstrumentNotes"  data-instrument="'+a+'" name="drummerInstrumentNotes_'+a+'">'+x+"</label>&nbsp;&nbsp"}r+="</div>";r+='<div class="formRow" id="drummerInstrumentOctavesHolder_'+a+'" ';if(f!="variable"){r+=' style="display: none" '}r+=">";r+='<label class="controlLabel">Octaves</label>';for(var l=0;l<8;l++){var C="";for(var n=0;n<g.length;n++){if(g[n]==l){C=' checked="checked" '}}r+='<label> <input type="checkbox"  '+C+' value="'+l+'" class="drummerInstrumentOctaves"  data-instrument="'+a+'" name="drummerInstrumentOctaves_'+a+'">'+l+"</label>&nbsp;&nbsp"}r+="</div>"}}r+='<div id="drummerKeys"></div>';$("#drummerParameters").html(r);var S=this;$(".drummerInstrumentSlider").on("input",function(){var e=$(this).val();var t=$(this).attr("id");var i=$(this).attr("data-instrument");console.log("instrument = "+i+" value = "+e);S.drumPatterns[S.selectedDrumPatternIndex].settings[i].value=parseInt(e,10);S.applyDrumPattern()});$(".drummerInstrumentMapping").on("change",function(){var e=$(this).val();var t=$(this).attr("data-instrument");S.drumPatterns[S.selectedDrumPatternIndex].settings[t].mappedTo=parseInt(e,10);S.applyDrumPattern()});$(".drummerInstrumentEffect").on("click",function(){var e=$(this).attr("data-instrument");var t=$("input[name=drummerInstrumentEffect_"+e+"]:checked").val();S.drumPatterns[S.selectedDrumPatternIndex].settings[e].effect=t;if(t=="volume"){$("#drummerInstrumentVolumeRow_"+e).show();S.setVolumeValues(e)}else{$("#drummerInstrumentVolumeRow_"+e).hide()}if(t=="portamento"){$("#drummerInstrumentPortamentoRow_"+e).show();S.setPortamentoValues(e)}else{$("#drummerInstrumentPortamentoRow_"+e).hide()}S.applyDrumPattern()});$(".drummerVolume").on("change",function(){var e=$(this).attr("data-instrument");S.setVolumeValues(e);S.applyDrumPattern()});$(".drummerPortamento").on("change",function(){var e=$(this).attr("data-instrument");S.setPortamentoValues(e);S.applyDrumPattern()});$(".drummerInstrumentPitch").on("click",function(){var e=$(this).attr("data-instrument");var t=$("input[name=drummerInstrumentPitch_"+e+"]:checked").val();console.log("set pitch to "+t);if(t==="variable"){$("#drummerInstrumentNotesHolder_"+e).show();$("#drummerInstrumentOctavesHolder_"+e).show()}else{$("#drummerInstrumentNotesHolder_"+e).hide();$("#drummerInstrumentOctavesHolder_"+e).hide()}S.drumPatterns[S.selectedDrumPatternIndex].settings[e].pitch=t;S.applyDrumPattern()});$(".drummerInstrumentNotes").on("click",function(){var e=$(this).attr("data-instrument");var t=[];$("input[name=drummerInstrumentNotes_"+e+"]:checked").each(function(){t.push(parseInt($(this).val(),10))});S.drumPatterns[S.selectedDrumPatternIndex].settings[e].notes=t;S.applyDrumPattern()});$(".drummerInstrumentOctaves").on("click",function(){var e=$(this).attr("data-instrument");var t=[];$("input[name=drummerInstrumentOctaves_"+e+"]:checked").each(function(){t.push(parseInt($(this).val(),10))});S.drumPatterns[S.selectedDrumPatternIndex].settings[e].octaves=t;S.applyDrumPattern()});this.keyChooserHTML();this.applyDrumPattern()},setMappings:function(){var i=this;$(".drummerInstrumentMapping").each(function(){var e=$(this).val();var t=$(this).attr("data-instrument");i.drumPatterns[i.selectedDrumPatternIndex].settings[t].mappedTo=parseInt(e,10)})},applyDrumPattern:function(){var e=this.patternId;if(e===false){return}this.setMappings();var t=this.drumPatterns[this.selectedDrumPatternIndex];this.music.patterns.clear(e);var i=this.music.patterns.getDuration(e);var r=[];for(var a in t.pattern){if(t.pattern.hasOwnProperty(a)){r.push(a)}}for(var s=r.length-1;s>=0;s--){var a=r[s];var o=this.drumPatterns[this.selectedDrumPatternIndex].settings[a].mappedTo;if(typeof o!="undefined"){var l=t.pattern[a];var n=t.settings[a].value;var h=t.settings[a];for(var d=0;d<i;d+=this.music.sidSpeed){var c=Math.floor(d/16);var f=Math.floor(d/(4*this.music.sidSpeed));f=f%l.length;var u=d/this.music.sidSpeed%4;if(l[f][u]&&l[f][u]<=n){var p=48;var v=this.music.patternView.partsPerBeat;if(h.pitch=="variable"){var g=this.keys[c].key;var m=this.keys[c].scale;var y=h.notes;var b=h.octaves;var C=this.music.scales.getIntervals(m);var x=Math.floor(Math.random()*y.length);x=x%y.length;var S=y[x];var P=Math.floor(Math.random()*b.length);P=P%b.length;var w=b[P];var p=g+w*12;for(var u=0;u<S;u++){p+=C[u]}}this.music.patterns.addNote(e,{position:d,instrumentId:o,pitch:p,duration:v});if(h.effect=="volume"){var I=h.volume;var k=6;var a=this.music.instruments.getInstrument(o);var M=a.sustain;var T=a.release;var D=d%4;M=I[D];var E=k;var $=(M<<4)+T;var _=0;this.music.patterns.addParam(e,"effects",d,{effect:E,value1:$,value2:_})}if(h.effect=="portamento"){var E=1;var $=5e3;var _=0;var B=h.portamento;var D=d%4;$=B[D];if($<0){$=-$;E=2}$=$*100;this.music.patterns.addParam(e,"effects",d,{effect:E,value1:$,value2:_})}}}}}this.music.patternView.drawPattern();this.music.playMusic()}};var Bassist=function(){this.patternView=null;this.music=null;this.uiComponent=null;this.savedPattern=null;this.applyAccents=false;this.saveLoopCurrentPattern=false;this.patternDataBackup=[];this.bassPatterns=[{name:"Bass pattern 1"},{name:"Bass pattern 2"}]};Bassist.prototype={init:function(e){this.music=e},start:function(){var i=this;this.pattern=this.music.patternView.getPattern();this.savedPattern=this.pattern.getDataCopy();if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"bassistDialog",title:"Create A Bass Line",width:640});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/music/bassist.html",function(){i.initContent()});this.okButton=UI.create("UI.Button",{text:"Import"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){i.music.loopSelection=i.saveLoopCurrentPattern;UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){var t=i.music.patternView.getPattern();t.setFromData(i.savedPattern);i.music.patternView.drawPattern();i.music.loopSelection=i.saveLoopCurrentPattern;UI.closeDialog()})}this.saveLoopCurrentPattern=this.music.loopSelection;this.music.loopSelection=true;UI.showDialog("bassistDialog")},initContent:function(){var t=this;var e="";for(var i=0;i<this.bassPatterns.length;i++){var r=this.bassPatterns[i].name;e+='<div class="bassistPatternListEntry ';e+='" value="'+i+'">'+r+"</div>"}$("#bassistPatterns").html(e);$(".bassistPatternListEntry").on("click",function(){var e=parseInt($(this).attr("value"),10);$(".bassistPatternListEntry").removeClass("bassistPatternListEntrySelected");$(this).addClass("bassistPatternListEntrySelected");t.chooseBassPattern(e)})},chooseBassPattern:function(e){console.log("choose bass pattern "+e)}};function outCallback(e){}var Oscilloscope=function(){this.visible=true;this.sampleCount=800;this.track1=null;this.width=0;this.height=0;this.left=0;this.bottom=0;this.waveformMeshes=[]};Oscilloscope.prototype={init:function(e,t,i){this.music=e;this.channel=t;this.canvas=i.getCanvas()},outputData:function(e){if(!this.visible){return}this.width=Math.floor(this.canvas.width/this.music.doc.data.tracks.length);this.height=this.canvas.height;var t=this.width*this.channel;this.context=this.canvas.getContext("2d");var i=.002;var r=e.length/5.2;this.context.fillStyle=styles.music.oscilloscopeBackground;this.context.fillRect(t,0,this.width,this.height);this.context.beginPath();this.context.strokeStyle=styles.music.oscilloscopeLines;this.context.lineWidth=2;if(e===false){var a=t;var s=this.height/2;this.context.moveTo(a,s);this.context.lineTo(t+this.width,s);this.context.stroke();return}var o=0;while(e[o]<6e3&&o<1e3){o++}while(e[o]>=5990&&o<1e3){o++}var l=0;var n=Math.floor(o+l)%2048;var a=t;var s=this.height/2-e[n]*i;this.context.moveTo(a,s);var h=r/this.width;var d=this.height/2;for(var a=1;a<this.width;a++){l+=h;n=Math.floor(o+l)%2048;s=d-e[n]*i;this.context.lineTo(t+a,s)}this.context.stroke()},resize:function(){this.canvas.width=this.width;this.canvas.height=this.height;this.context=this.canvas.getContext("2d")},render:function(e,t,i,r){if(!this.visible){return}if(this.left!=e){this.left=e;this.canvas.style.left=e+"px"}if(this.bottom!=t){this.bottom=t;this.canvas.style.bottom=t+"px"}if(i!=this.width||r!=this.height){this.width=i;this.height=r;this.resize()}}};var HistoryGraph=function(){this.visible=false;this.segments=512;this.maximumValue=255;this.data=[];this.waveformMeshes=[];this.historyLine=null;this.cursor=0;this.canvas=null;this.context=null;this.width=10;this.height=10;this.left=0;this.bottom=0};HistoryGraph.prototype={init:function(e,t){if(typeof t!="undefined"){if(typeof t.max!="undefined"){this.maximumValue=t.max}if(typeof t.segments!="undefined"){this.segments=t.segments}}this.music=e;return;this.canvas=document.createElement("canvas");document.body.appendChild(this.canvas);this.canvas.style.zIndex=100;this.canvas.style.position="absolute";this.canvas.style.display="none";this.canvas.className+=" historyGraph";this.resize();for(var i=0;i<this.segments;i++){this.data.push(0)}},setVisible:function(e){if(e!=this.visible){this.visible=e;if(e){this.canvas.style.display="block"}else{this.canvas.style.display="none"}}},setMaximumValue:function(e){this.maximumValue=e},addValue:function(e){this.data[this.cursor++]=e;if(this.cursor>=this.segments){this.cursor=0}},outputData:function(){if(!this.visible){return}this.context.fillStyle="#060606";this.context.fillRect(0,0,this.width,this.height);this.context.beginPath();this.context.strokeStyle="#e6e6e6";var e=1;var t=this.width/this.segments;var i=this.segments;var r=this.cursor-i;if(r<0){r+=this.segments}var a=0;var s=this.height-e*(this.data[r++]/this.maximumValue*this.height);this.context.moveTo(a,s);for(var o=1;o<i;o++){var a=o*t;var s=this.height-e*(this.data[r++]/this.maximumValue*this.height);this.context.lineTo(a,s);if(r>=this.segments){r=0}}for(var o=i;o<this.segments;o++){console.log("HEREEEEE!!!");var a=o*t;var s=this.height-0;this.context.lineTo(a,s)}this.context.lineWidth=2;this.context.stroke()},resize:function(){this.canvas.width=this.width;this.canvas.height=this.height;this.context=this.canvas.getContext("2d")},render:function(e,t,i,r){if(!this.visible){return}if(this.left!=e){this.left=e;this.canvas.style.left=e+"px"}if(this.bottom!=t){this.bottom=t;this.canvas.style.bottom=t+"px"}if(i!=this.width||r!=this.height){this.width=i;this.height=r;this.resize()}}};var Scales=function(){this.scales={major:{name:"Major",steps:"T T s T T T s",intervals:[2,2,1,2,2,2,1]},melodic:{name:"Melodic Minor",steps:"T s T T T T s",intervals:[2,1,2,2,2,2,1]},harmonic:{name:"Harmonic Minor",steps:"T s T T s Ts s",intervals:[2,1,2,2,1,3,1]},dorian:{name:"Dorian",steps:"T s T T T s T",intervals:[2,1,2,2,2,1,2]},phrygian:{name:"Phrygian",steps:"s T T T s T T",intervals:[1,2,2,2,1,2,2]},lydian:{name:"Lydian",steps:"T T T s T T s",intervals:[2,2,2,1,2,2,1]},mixolydian:{name:"Mixolydian",steps:"T T s T T s T",intervals:[2,2,1,2,2,1,2]},aeolian:{name:"Aeolian",steps:"T s T T s T T",intervals:[2,1,2,2,1,2,2]},locrian:{name:"Locrian",steps:"s T T s T T T",intervals:[1,2,2,1,2,2,2]}}};Scales.prototype={init:function(){},getIntervals:function(e){return this.scales[e].intervals}};function jsSID(e,t,i){var a=[];var s=[];var o=new Uint8Array(65536);this.getData=function(){return s};this.getMemory=function(){return o};this.getEnvCnt=function(){return xe};this.getSampleRate=function(){return l};this.resetChannelDataPos=function(){a[0]=0;a[1]=0;a[2]=0};for(var r=0;r<3;r++){s[r]=[];a[r]=0}this.author="Hermit";this.sourcecode="http://hermit.sidrip.com";this.version="0.9.1";this.year="2016";var l=i;this.loadstart=function(e,t){this.loadinit(e,t);if(_!==null)_();this.playcont()};this.setMemory=function(e,t,i){if(typeof i=="undefined"){i=1}T=0;this.pause();it();S=t;y=4096;b=4096;x=4099;C=4099;P=1;for(r=0;r<32;r++){m[31-r]=0}for(r=0;r<o.length;r++){o[r]=0}for(var r=4096;r<e.length;r++){o[r]=e[r]}I[0]=8580;H=1;T=1;G(S,i);console.log("frame sample period ==== "+R)};this.initFromData=function(e){var t,i,r=e[7];y=e[8]+e[9]?e[8]*256+e[9]:e[r]+e[r+1]*256;for(t=0;t<32;t++){m[31-t]=e[18+(t>>3)]&Math.pow(2,7-t%8)}for(t=0;t<o.length;t++){o[t]=0}for(t=r+2;t<e.byteLength;t++){if(y+t-(r+2)<o.length)o[y+t-(r+2)]=e[t]}i=1;for(t=0;t<32;t++){if(i!=0)i=p[t]=e[22+t];else i=p[t]=0}i=1;for(t=0;t<32;t++){if(i!=0)i=v[t]=e[54+t];else i=v[t]=0}i=1;for(t=0;t<32;t++){if(i!=0)i=g[t]=e[86+t];else i=g[t]=0}b=e[10]+e[11]?e[10]*256+e[11]:y;x=C=e[12]*256+e[13];P=e[15];console.log("subtune amounr = "+P);I[0]=(e[119]&48)>=32?8580:6581;I[1]=(e[119]&192)>=128?8580:6581;I[2]=(e[118]&3)>=3?8580:6581;M[1]=e[122]>=66&&(e[122]<128||e[122]>=224)?53248+e[122]*16:0;M[2]=e[123]>=66&&(e[123]<128||e[123]>=224)?53248+e[123]*16:0;H=1+(M[1]>0)+(M[2]>0);T=1;if($!==null)$();G(S)};this.start=function(e){G(e);if(_!==null)_();this.playcont()};this.playcont=function(){};this.pause=function(){if(T&&D)jsSID_scriptNode.disconnect(jsSID_audioCtx.destination)};this.stop=function(){this.pause();G(S)};this.gettitle=function(){return String.fromCharCode.apply(null,p)};this.getauthor=function(){return String.fromCharCode.apply(null,v)};this.getinfo=function(){return String.fromCharCode.apply(null,g)};this.getsubtunes=function(){return P};this.getprefmodel=function(){return I[0]};this.getmodel=function(){return k};this.getoutput=function(){return tt/c*(o[54296]&15)};this.getplaytime=function(){return parseInt(playtime)};this.setmodel=function(e){k=e};this.setvolume=function(e){F=e};this.setloadcallback=function(e){$=e};this.setstartcallback=function(e){_=e};this.setendcallback=function(e,t){endcallback=e;w=t};this.getframeperiod=function(e){var t=1;if(m[e]||o[56325]){console.log("cia timing!!");if(!o[56325]){o[56324]=36;o[56325]=64}frameperiod=o[56324]+o[56325]*256}else{frameperiod=l/(h*t)}return frameperiod};this.getspeed=function(e){var t="";if(m[e]||o[56325]){t="CIA";console.log("cia timing!!");console.log(m);if(!o[56325]){console.log("couldnt find timing");o[56324]=36;o[56325]=64}frameperiod=o[56324]+o[56325]*256;console.log("frameperiod = "+frameperiod);var i=19654;var r=Math.round(i/frameperiod);t="CIA "+r+"x"}else{t="Vsync 1x";frameperiod=l/(h*1)}return t};this.setSamplePeriod=function(e){n=985248*e;h=50*e;B=n/l;if(m[S]||o[56325]){if(!o[56325]){o[56324]=36;o[56325]=64}R=(o[56324]+o[56325]*256)/B}else{R=l/h}};var n=985248,h=50,d=3,c=65536*d*16;var f=[0,1,.6,.4];var u=[true,true,true];var p=new Uint8Array(32);var v=new Uint8Array(32);var g=new Uint8Array(32);var m=new Uint8Array(32);var y=4096,b=4096,C=4099,x=4099,S=0,P=1,w=0;var I=[8580,8580,8580];var k=8580;var M=[54272,0,0];var T=0,D=0,E=0,$=null,_=null;endcallback=null,playtime=0,ended=0;var B=n/l;var R=l/h;var A=1,F=1,L=0,U;var H=1,O=0;function G(e,t){if(typeof t=="undefined"){t=1}if(T){D=0;S=e;te(b);it();X=S;o[1]=55;o[56325]=0;for(var i=1e5;i>=0;i--){if(ie())break}if(m[S]||o[56325]){if(!o[56325]){o[56324]=36;o[56325]=64}R=(o[56324]+o[56325]*256)/B}else{R=l/(h*t)}if(C==0)x=(o[1]&3)<2?o[65534]+o[65535]*256:o[788]+o[789]*256;else{x=C;if(x>=57344&&o[1]==55)o[1]=53}te(x);A=1;E=0;L=0;playtime=0;ended=0;D=1}}this.doCPU=function(){ie();return W};this.getChannelOn=function(){return u};this.setChannelOn=function(e,t,i){u[0]=e;if(!e){for(var r=0;r<s[0].length;r++){s[0][r]=0}}u[1]=t;if(!t){for(var r=0;r<s[1].length;r++){s[1][r]=0}}u[2]=i;if(!i){for(var r=0;r<s[2].length;r++){s[2][r]=0}}};this.play=function(){if(T&&D){A--;playtime+=1/l;if(A<=0){A=R;E=0;W=x;j=255}if(E==0){while(L<=B){U=W;if(ie()>=254){E=1;break}else{L+=Q}if((o[1]&3)>1&&U<57344&&(W==59953||W==60033)){console.log("finished!");E=1;break}if((Z==56325||Z==56324)&&o[1]&3&&m[S]){R=(o[56324]+o[56325]*256)/B}if(ee>=54304&&ee<55296&&o[1]&3){if(!(M[1]<=ee&&ee<M[1]+31)&&!(M[2]<=ee&&ee<M[2]+31))o[ee&54303]=o[ee]}if(Z==54276&&!(o[54276]&1)){be[0]&=62}if(Z==54283&&!(o[54283]&1)){be[1]&=62}if(Z==54290&&!(o[54290]&1)){be[2]&=62}}L-=B}}if(w>0&&parseInt(playtime)==parseInt(w)&&endcallback!==null&&ended==0){ended=1;endcallback()}O=rt(0,54272);if(M[1]){O+=rt(1,M[1])}if(M[2])O+=rt(2,M[2]);return O*F*f[H]+(Math.random()*t-t/2)};var z=[1,33,4,36,0,64,8,40],N=[128,64,1,2];var W=0,X=0,Y=0,V=0,q=0,j=255,K=0,Z=0,J=0,Q=0,ee=0;function te(e){W=e;X=0;V=0;q=0;J=0;j=255}function ie(){K=o[W];Q=2;ee=0;if(K&1){switch(K&31){case 1:case 3:Z=o[o[++W]+V]+o[o[W]+V+1]*256;Q=6;break;case 17:case 19:Z=o[o[++W]]+o[o[W]+1]*256+q;Q=6;break;case 25:case 31:Z=o[++W]+o[++W]*256+q;Q=5;break;case 29:Z=o[++W]+o[++W]*256+V;Q=5;break;case 13:case 15:Z=o[++W]+o[++W]*256;Q=4;break;case 21:Z=o[++W]+V;Q=4;break;case 5:case 7:Z=o[++W];Q=3;break;case 23:Z=o[++W]+q;Q=4;break;case 9:case 11:Z=++W;Q=2}Z&=65535;switch(K&224){case 96:Y=X;X+=o[Z]+(J&1);J&=20;J|=X&128|X>255;X&=255;J|=!X<<1|(!((Y^o[Z])&128)&&(Y^X)&128)>>1;break;case 224:Y=X;X-=o[Z]+!(J&1);J&=20;J|=X&128|X>=0;X&=255;J|=!X<<1|((Y^o[Z])&128&&(Y^X)&128)>>1;break;case 192:Y=X-o[Z];J&=124;J|=!(Y&255)<<1|Y&128|Y>=0;break;case 0:X|=o[Z];J&=125;J|=!X<<1|X&128;break;case 32:X&=o[Z];J&=125;J|=!X<<1|X&128;break;case 64:X^=o[Z];J&=125;J|=!X<<1|X&128;break;case 160:X=o[Z];J&=125;J|=!X<<1|X&128;if((K&3)==3)V=X;break;case 128:o[Z]=X&((K&3)==3?V:255);ee=Z}}else if(K&2){switch(K&31){case 30:Z=o[++W]+o[++W]*256+((K&192)!=128?V:q);Q=5;break;case 14:Z=o[++W]+o[++W]*256;Q=4;break;case 22:Z=o[++W]+((K&192)!=128?V:q);Q=4;break;case 6:Z=o[++W];Q=3;break;case 2:Z=++W;Q=2}Z&=65535;switch(K&224){case 0:J&=254;case 32:if((K&15)==10){X=(X<<1)+(J&1);J&=60;J|=X&128|X>255;X&=255;J|=!X<<1}else{Y=(o[Z]<<1)+(J&1);J&=60;J|=Y&128|Y>255;Y&=255;J|=!Y<<1;o[Z]=Y;Q+=2}break;case 64:J&=254;case 96:if((K&15)==10){Y=X;X=(X>>1)+(J&1)*128;J&=60;J|=X&128|Y&1;X&=255;J|=!X<<1}else{Y=(o[Z]>>1)+(J&1)*128;J&=60;J|=Y&128|o[Z]&1;Y&=255;J|=!Y<<1;o[Z]=Y;Q+=2}break;case 192:if(K&4){o[Z]--;o[Z]&=255;J&=125;J|=!o[Z]<<1|o[Z]&128;Q+=2}else{V--;V&=255;J&=125;J|=!V<<1|V&128}break;case 160:if((K&15)!=10)V=o[Z];else if(K&16){V=j;break}else V=X;J&=125;J|=!V<<1|V&128;break;case 128:if(K&4){o[Z]=V;ee=Z}else if(K&16)j=V;else{X=V;J&=125;J|=!X<<1|X&128}break;case 224:if(K&4){o[Z]++;o[Z]&=255;J&=125;J|=!o[Z]<<1|o[Z]&128;Q+=2}}}else if((K&12)==8){switch(K&240){case 96:j++;j&=255;X=o[256+j];J&=125;J|=!X<<1|X&128;Q=4;break;case 192:q++;q&=255;J&=125;J|=!q<<1|q&128;break;case 224:V++;V&=255;J&=125;J|=!V<<1|V&128;break;case 128:q--;q&=255;J&=125;J|=!q<<1|q&128;break;case 0:o[256+j]=J;j--;j&=255;Q=3;break;case 32:j++;j&=255;J=o[256+j];Q=4;break;case 64:o[256+j]=X;j--;j&=255;Q=3;break;case 144:X=q;J&=125;J|=!X<<1|X&128;break;case 160:q=X;J&=125;J|=!q<<1|q&128;break;default:if(z[K>>5]&32)J|=z[K>>5]&223;else J&=255-(z[K>>5]&223)}}else{if((K&31)==16){W++;Y=o[W];if(Y&128)Y-=256;if(K&32){if(J&N[K>>6]){W+=Y;Q=3}}else{if(!(J&N[K>>6])){W+=Y;Q=3}}}else{switch(K&31){case 0:Z=++W;Q=2;break;case 28:Z=o[++W]+o[++W]*256+V;Q=5;break;case 12:Z=o[++W]+o[++W]*256;Q=4;break;case 20:Z=o[++W]+V;Q=4;break;case 4:Z=o[++W];Q=3}Z&=65535;switch(K&224){case 0:o[256+j]=W%256;j--;j&=255;o[256+j]=W/256;j--;j&=255;o[256+j]=J;j--;j&=255;W=o[65534]+o[65535]*256-1;Q=7;break;case 32:if(K&15){J&=61;J|=o[Z]&192|!(X&o[Z])<<1}else{o[256+j]=(W+2)%256;j--;j&=255;o[256+j]=(W+2)/256;j--;j&=255;W=o[Z]+o[Z+1]*256-1;Q=6}break;case 64:if(K&15){W=Z-1;Q=3}else{if(j>=255)return 254;j++;j&=255;J=o[256+j];j++;j&=255;Y=o[256+j];j++;j&=255;W=o[256+j]+Y*256-1;Q=6}break;case 96:if(K&15){W=o[Z]+o[Z+1]*256-1;Q=5}else{if(j>=255)return 255;j++;j&=255;Y=o[256+j];j++;j&=255;W=o[256+j]+Y*256-1;Q=6}break;case 192:Y=q-o[Z];J&=124;J|=!(Y&255)<<1|Y&128|Y>=0;break;case 224:Y=V-o[Z];J&=124;J|=!(Y&255)<<1|Y&128|Y>=0;break;case 160:q=o[Z];J&=125;J|=!q<<1|q&128;break;case 128:o[Z]=q;ee=Z}}}W++;W&=65535;return 0}var re=1,ae=2,se=4,oe=8,le=16,ne=32,he=64,de=128,ce=16,fe=64,ue=128,pe=[1,2,4,1,2,4,1,2,4],ve=16,ge=32,me=64,ye=128;var be=[0,0,0,0,0,0,0,0,0],Ce=[0,0,0,0,0,0,0,0,0],xe=[0,0,0,0,0,0,0,0,0],Se=[0,0,0,0,0,0,0,0,0],Pe=[0,0,0,0,0,0,0,0,0];var we=[0,0,0,0,0,0,0,0,0],Ie=[0,0,0,0,0,0,0,0,0],ke=[0,0,0],Me=[0,0,0];var Te=[8388600,8388600,8388600,8388600,8388600,8388600,8388600,8388600,8388600];var De=[0,0,0,0,0,0,0,0,0],Ee=[0,0,0,0,0,0,0,0,0],$e;var _e=[0,0,0],Be=[0,0,0],Re=-2*3.14*(12500/256)/l,Ae=-2*3.14*(2e4/256)/l;var Fe=[0,0,0],Le=[0,0,0];var Ue,He,Oe,Ge,ze,Ne,We,Xe,Ye,Ve,qe,je,Ke,Ze,Je,Qe,et,tt;function it(){for(var e=54272;e<=55295;e++)o[e]=0;for(var e=56832;e<=57343;e++)o[e]=0;for(var e=0;e<9;e++){be[e]=ce;Ce[e]=xe[e]=Se[e]=Pe[e]=0}}function rt(e,t){et=0;tt=0;for(var i=e*d;i<(e+1)*d;i++){Ue=be[i]&re;He=t+(i-e*d)*7;Oe=o[He+4];Ge=Oe&240;ze=Oe&oe;Xe=o[He+6];qe=0;if(Ue!=(Oe&re)){if(Ue){be[i]&=255-(re|ue|fe)}else{be[i]=re|ue|fe;if((Xe&15)>(Pe[i]&15))qe=1}}Pe[i]=Xe;Ce[i]+=B;if(Ce[i]>=32768)Ce[i]-=32768;if(be[i]&ue){We=o[He+5]>>4;Ne=lt[We]}else if(be[i]&fe){We=o[He+5]&15;Ne=lt[We]}else{We=Xe&15;Ne=lt[We]}We=nt[We];if(Ce[i]>=Ne&&Ce[i]<Ne+B&&qe==0){Ce[i]-=Ne;if(be[i]&ue||++Se[i]==ht[xe[i]]){if(!(be[i]&ce)){if(be[i]&ue){xe[i]+=We;if(xe[i]>=255){xe[i]=255;be[i]&=255-ue}}else if(!(be[i]&fe)||xe[i]>(Xe>>4)+(Xe&240)){xe[i]-=We;if(xe[i]<=0&&xe[i]+We!=0){xe[i]=0;be[i]|=ce}}}Se[i]=0}}xe[i]&=255;Ye=(o[He]+o[He+1]*256)*B;if(ze||Oe&ae&&ke[e]){we[i]=0}else{we[i]+=Ye;if(we[i]>16777215)we[i]-=16777216}Ve=we[i]&8388608;ke[e]=Ve>(Ie[i]&8388608)?1:0;if(Ge&de){qe=Te[i];if((we[i]&1048576)!=(Ie[i]&1048576)||Ye>=1048576){We=qe&4194304^(qe&131072)<<5;qe=(qe<<1)+(We>0||ze)&8388607;Te[i]=qe}Ze=Ge&112?0:((qe&1048576)>>5)+((qe&262144)>>4)+((qe&16384)>>1)+((qe&2048)<<1)+((qe&512)<<2)+((qe&32)<<5)+((qe&4)<<7)+((qe&1)<<8)}else if(Ge&he){je=(o[He+2]+(o[He+3]&15)*256)*16;qe=Ye>>9;if(0<je&&je<qe)je=qe;qe^=65535;if(je>qe)je=qe;qe=we[i]>>8;if(Ge==he){We=256/(Ye>>16);if(ze)Ze=65535;else if(qe<je){Ke=(65535-je)*We;if(Ke>65535)Ke=65535;Ze=Ke-(je-qe)*We;if(Ze<0)Ze=0}else{Ke=je*We;if(Ke>65535)Ke=65535;Ze=(65535-qe)*We-Ke;if(Ze>=0)Ze=65535;Ze&=65535}}else{Ze=qe>=je||ze?65535:0;if(Ge&le){if(Ge&ne){Ze=Ze?at(i,PulseTriSaw_8580,qe>>4,1):0}else{qe=we[i]^(Oe&se?Me[e]:0);Ze=Ze?at(i,PulseSaw_8580,(qe^(qe&8388608?16777215:0))>>11,0):0}}else if(Ge&ne)Ze=Ze?at(i,PulseSaw_8580,qe>>4,1):0}}else if(Ge&ne){Ze=we[i]>>8;if(Ge&le)Ze=at(i,TriSaw_8580,Ze>>4,1);else{We=Ye/18874368;Ze+=Ze*We;if(Ze>65535)Ze=65535-(Ze-65536)/We}}else if(Ge&le){qe=we[i]^(Oe&se?Me[e]:0);Ze=(qe^(qe&8388608?16777215:0))>>7}if(Ge)De[i]=Ze;else{Ze=De[i]}Ie[i]=we[i];Me[e]=Ve;if(o[t+23]&pe[i]){var r=(Ze-32768)*(xe[i]/256);Je=(o[t+21]&7)/8+o[t+22]+.2;if(k==8580){Je=1-Math.exp(Je*Re);Qe=Math.pow(2,(4-(o[t+23]>>4))/8)}else{if(Je<24)Je=.035;else Je=1-1.263*Math.exp(Je*Ae);Qe=o[t+23]>95?8/(o[t+23]>>4):1.41}qe=r+Le[i]*Qe+Fe[i];if(o[t+24]&me)r-=qe;qe=Le[i]-qe*Je;Le[i]=qe;if(o[t+24]&ge)r-=qe;qe=Fe[i]+qe*Je;Fe[i]=qe;if(o[t+24]&ve)r+=qe;if(u[i]){s[i][a[i]++]=r;et+=(Ze-32768)*(xe[i]/256)}}else if(i%d!=2||!(o[t+24]&ye)){if(u[i]){s[i][a[i]++]=(Ze-32768)*(xe[i]/256);tt+=(Ze-32768)*(xe[i]/256)}}}if(o[1]&3)o[t+27]=Ze>>8;o[t+28]=xe[3];Je=(o[t+21]&7)/8+o[t+22]+.2;if(k==8580){Je=1-Math.exp(Je*Re);Qe=Math.pow(2,(4-(o[t+23]>>4))/8)}else{if(Je<24)Je=.035;else Je=1-1.263*Math.exp(Je*Ae);Qe=o[t+23]>95?8/(o[t+23]>>4):1.41}qe=et+Be[e]*Qe+_e[e];if(o[t+24]&me)tt-=qe;qe=Be[e]-qe*Je;Be[e]=qe;if(o[t+24]&ge)tt-=qe;qe=_e[e]+qe*Je;_e[e]=qe;if(o[t+24]&ve)tt+=qe;return tt/c*(o[t+24]&15)}function at(e,t,i,r){if(r&&k==6581)i&=2047;$e=(t[i]+Ee[e])/2;Ee[e]=t[i];return $e}function st(e,t,i,r){for(var a=0;a<4096;a++){e[a]=0;for(var s=0;s<12;s++){var o=0;for(var l=0;l<12;l++){o+=t/Math.pow(i,Math.abs(l-s))*((a>>l&1)-.5)}e[a]+=o>=r?Math.pow(2,s):0}e[a]*=12}}TriSaw_8580=new Array(4096);st(TriSaw_8580,.8,2.4,.64);PulseSaw_8580=new Array(4096);st(PulseSaw_8580,1.4,1.9,.68);PulseTriSaw_8580=new Array(4096);st(PulseTriSaw_8580,.8,2.5,.64);var ot=Math.max(B,9);var lt=[ot,32*1,63*1,95*1,149*1,220*1,267*1,313*1,392*1,977*1,1954*1,3126*1,3907*1,11720*1,19532*1,31251*1];var nt=[Math.ceil(ot/9),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];var ht=[1,30,30,30,30,30,30,16,16,16,16,16,16,16,16,8,8,8,8,8,8,8,8,8,8,8,8,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}var SidPlayer=function(){this.music=null;this.patternMap=[];this.c64PatternMap=[];this.a8Map=[];this.songData=null;this.testInstrumentData=null;this.testInstrumentIsSetup=false;this.playingSid=false;this.playingInstrument=false;this.requestStopInstrument=false;this.currentSongPointer=[0,0,0];this.currentPattern=[0,0,0];this.currentPatternPointer=[0,0,0];this.currentPatternRow=[0,0,0];this.currentPatternTempo=[0,0,0];this.currentPatternCounter=[0,0,0];this.playheadPosition=[0,0,0];this.playing=false;this.testingInstrument=false;var u=null;var p={MT_CHNSONGPTR0:5230,MT_CHNPATTPTR0:5233,MT_CHNSONGNUM0:5272,MT_CHNPATTNUM0:5273,MT_CHNTEMPO0:5274,MT_CHNCOUNTER0:5275,MT_CHNSONGPTR1:5230+7,MT_CHNPATTPTR1:5233+7,MT_CHNSONGNUM1:5272+7,MT_CHNPATTNUM1:5273+7,MT_CHNTEMPO1:5274+7,MT_CHNCOUNTER1:5275+7,MT_CHNSONGPTR2:5230+14,MT_CHNPATTPTR2:5233+14,MT_CHNSONGNUM2:5272+14,MT_CHNPATTNUM2:5273+14,MT_CHNTEMPO2:5274+14,MT_CHNCOUNTER2:5275+14};this.setPointers=function(e){if(typeof SIDplayer=="undefined"){return}var t=SIDplayer.getMemory();for(var i in e){if(e.hasOwnProperty(i)){var r=p[i];t[r]=e[i]}}};this.calculatePointers=function(){var e=SIDplayer.getMemory();var t=this.songData.patternRowPositions;for(var i=0;i<3;i++){var r=e[p["MT_CHNPATTNUM"+i]];var a=e[p["MT_CHNPATTPTR"+i]];var s=0;if(r<t.length&&a<t[r].length){s=t[r][a]}var o=e[p["MT_CHNSONGPTR"+i]];this.currentSongPointer[i]=o;this.currentPattern[i]=r;this.currentPatternPointer[i]=a;this.currentPatternRow[i]=s;if(o>0&&o-1<this.songData.a8s[i].length){var l=this.songData.a8s[i][o-1]+s;this.playheadPosition[i]=l}}};this.setupAudioContext=function(){if(typeof u!="undefined"&&u!=null){return}console.log("setup audio context");var f=this;u=null;if(typeof AudioContext!=="undefined"){u=new AudioContext}else{u=new webkitAudioContext}var e=u.sampleRate;var t=4096;SIDplayer=new jsSID(t,5e-4,e);InstrumentPlayer=new jsSID(t,5e-4,e);jsSID_scriptNode=null;if(typeof u.createJavaScriptNode==="function"){jsSID_scriptNode=u.createJavaScriptNode(t,0,1)}else{jsSID_scriptNode=u.createScriptProcessor(t,0,1)}jsSID_scriptNode.onaudioprocess=function(e){SIDplayer.resetChannelDataPos();InstrumentPlayer.resetChannelDataPos();var t=e.outputBuffer;var i=t.getChannelData(0);if(f.playingSid){for(var r=0;r<t.length;r++){i[r]=SIDplayer.play()}if(f.playingInstrument){for(var r=0;r<t.length;r++){i[r]+=InstrumentPlayer.play()}}}else if(f.playingInstrument){for(var r=0;r<t.length;r++){i[r]=InstrumentPlayer.play()}}else{for(var r=0;r<t.length;r++){i[r]=0}}var a=SIDplayer.getMemory();var s=f.songData.patternRowPositions;for(var o=0;o<3;o++){var l=a[p["MT_CHNPATTNUM"+o]];var n=a[p["MT_CHNPATTPTR"+o]];var h=0;if(l<s.length&&n<s[l].length){h=s[l][n]}var d=a[p["MT_CHNSONGPTR"+o]];f.currentSongPointer[o]=d;f.currentPattern[o]=l;f.currentPatternPointer[o]=n;f.currentPatternRow[o]=h;if(d>0&&d-1<f.songData.a8s[o].length){f.playheadPosition[o]=f.songData.a8s[o][d-1]+h}f.currentPatternTempo[o]=a[p["MT_CHNTEMPO"+o]];f.currentPatternCounter[o]=a[p["MT_CHNCOUNTER"+o]];f.currentPatternCounter[o]-=3;if(f.currentPatternCounter[o]<0){f.currentPatternCounter[o]+=f.currentPatternTempo[o]+1}f.currentPatternCounter[o]=f.currentPatternTempo[o]-f.currentPatternCounter[o]}if(f.testingInstrument){var a=InstrumentPlayer.getMemory();var l=a[p["MT_CHNPATTNUM0"]];var n=a[p["MT_CHNPATTPTR0"]];var c=a[p["MT_CHNCOUNTER"+o]];if(n>10&&!this.testingInstrumentCleared){f.testInstrumentClearStart();this.testingInstrumentCleared=true}}};if(!UI.isMobile){this.tuna=new Tuna(u);this.convolver=new this.tuna.Convolver({highCut:22050,lowCut:20,dryLevel:.8,wetLevel:.7,level:1,impulse:"impulses/impulse_rev.wav",bypass:0});this.chorus=new this.tuna.Chorus({rate:1.5,feedback:.2,delay:.0045,bypass:1});this.overdrive=new this.tuna.Overdrive({outputGain:.1,drive:.7,curveAmount:1,algorithmIndex:0,bypass:1});this.convolver.wetLevel=0;jsSID_scriptNode.connect(this.overdrive);this.overdrive.connect(this.chorus);this.chorus.connect(this.convolver);this.convolver.connect(u.destination)}else{jsSID_scriptNode.connect(u.destination)}};this.setOverdrive=function(e){console.log("set overdrive");console.log(e);if(e.overdriveOn){this.overdrive.bypass=0;this.overdrive.outputGain=e.gain;this.overdrive.drive=e.drive;this.overdrive.curveAmount=e.curve}else{this.overdrive.bypass=1}};this.setReverb=function(e){console.log("set reverb");if(e.reverbOn){console.log("reveb on!!");this.convolver.wetLevel=e.wet;this.convolver.dryLevel=e.dry;var t="impulses/impulse_rev.wav";switch(e.type){case"default":t="impulses/impulse_rev.wav";break;case"bottleHall":t="impulses/Bottle Hall.wav";break;case"deepSpace":t="impulses/Deep Space.wav";break;case"dampedLargeRoom":t="impulses/Highly Damped Large Room.wav";break;case"drumRoom":t="impulses/Nice Drum Room.wav";break;case"cave":t="impulses/Small Prehistoric Cave.wav";break;case"garage":t="impulses/Parking Garage.wav";break;case"echoHall":t="impulses/Large Wide Echo Hall.wav";break;case"church":t="impulses/St Nicolaes Church.wav";break;case"rays":t="impulses/Rays.wav";break;case"church":t="impulses/On a Star";break;case"outside":t="impulses/Chateau de Logne Outside.wav";break}this.convolver.impulse=t;this.convolver.buffer=t}else{this.convolver.wetLevel=0;this.convolver.dryLevel=1}};this.setPatternRow=function(e,t){var i=this.currentPattern[e];var r=this.songData.patternRowPositions;var a=0;for(var s=0;s<r[i].length;s++){if(r[i][s]==t){a=s;break}}var o=SIDplayer.getMemory();o[p["MT_CHNPATTPTR"+e]]=a};this.init=function(e){this.music=e;this.songData=new SongData;this.songData.init();this.testInstrumentData=new SongData;this.testInstrumentData.init();if(e&&e.oscilloscopes){}};this.setChannels=function(e){console.log("set channels not done yet")};this.setup=function(){this.testInstrumentSetup()};this.testInstrumentSetup=function(e){if(!u){return}this.testInstrumentData.tracks=[[0],[1],[2]];this.testInstrumentData.patterns=[];for(var t=0;t<3;t++){this.testInstrumentData.patterns[t]=[];for(var i=0;i<64;i++){this.testInstrumentData.patterns[t].push(189);this.testInstrumentData.patterns[t].push(0);this.testInstrumentData.patterns[t].push(0);this.testInstrumentData.patterns[t].push(0)}this.testInstrumentData.patterns[t].push(255);this.testInstrumentData.patterns[t].push(0);this.testInstrumentData.patterns[t].push(0);this.testInstrumentData.patterns[t].push(0)}this.testInstrumentData.instruments=[];for(var i=1;i<this.music.instruments.instruments.length;i++){this.testInstrumentData.instruments.push(this.music.instruments.instruments[i])}if(typeof e=="undefined"){this.testInstrumentData.filters=[];for(var i=1;i<this.music.filters.filters.length;i++){this.testInstrumentData.filters.push(this.music.filters.filters[i])}}else{this.testInstrumentData.filters=[];this.testInstrumentData.filters.push(e);this.testInstrumentData.filters.push(e)}this.testInstrumentData.writeSid();InstrumentPlayer.setMemory(this.testInstrumentData.memory,0,this.music.sidSpeed);this.testInstrumentIsSetup=true},this.testInstrumentStart=function(e,t,i,r,a){if(u==null){this.setupAudioContext()}this.testInstrumentSetup(a);if(typeof r=="undefined"){r=0}this.playingInstrument=false;for(var s=0;s<3;s++){var o=0;for(var l=0;l<64;l++){this.testInstrumentData.patterns[s][o++]=189;this.testInstrumentData.patterns[s][o++]=0;this.testInstrumentData.patterns[s][o++]=0;this.testInstrumentData.patterns[s][o++]=0}}this.testInstrumentData.patterns[r][0]=e+96;this.testInstrumentData.patterns[r][1]=parseInt(i);if(a){this.testInstrumentData.patterns[r][2]=10;this.testInstrumentData.patterns[r][3]=1}if(t){}var n=InstrumentPlayer.getMemory();var h=r;var d=this.testInstrumentData.packpattern2(h);address=this.testInstrumentData.labels["mt_patt"+h];for(var l=0;l<d.length-2;l++){n[address++]=d[l]}n[p["MT_CHNSONGPTR0"]]=1;n[p["MT_CHNPATTPTR0"]]=0;n[p["MT_CHNPATTNUM0"]]=0;n[p["MT_CHNCOUNTER0"]]=0;n[p["MT_CHNSONGPTR1"]]=1;n[p["MT_CHNPATTPTR1"]]=0;n[p["MT_CHNPATTNUM1"]]=1;n[p["MT_CHNCOUNTER1"]]=0;n[p["MT_CHNSONGPTR2"]]=1;n[p["MT_CHNPATTPTR2"]]=0;n[p["MT_CHNPATTNUM2"]]=2;n[p["MT_CHNCOUNTER2"]]=0;for(var l=0;l<8192;l++){var c=InstrumentPlayer.doCPU()}this.testingInstrument=true;this.testingInstrumentCleared=false;this.playingInstrument=true},this.testInstrumentSingleStart=function(e,t,i,r){if(u==null){this.setupAudioContext()}this.testInstrumentIsSetup=false;if(typeof r=="undefined"){r=0}this.testInstrumentData.tracks=[[0],[1],[2]];this.testInstrumentData.patterns=[];for(var a=0;a<3;a++){this.testInstrumentData.patterns[a]=[];for(var s=0;s<64;s++){this.testInstrumentData.patterns[a].push(189);this.testInstrumentData.patterns[a].push(0);this.testInstrumentData.patterns[a].push(0);this.testInstrumentData.patterns[a].push(0)}this.testInstrumentData.patterns[a].push(255);this.testInstrumentData.patterns[a].push(0);this.testInstrumentData.patterns[a].push(0);this.testInstrumentData.patterns[a].push(0)}this.testInstrumentData.patterns[r][0]=e+96;this.testInstrumentData.patterns[r][1]=1;if(t){this.testInstrumentData.patterns[r][t*4]=190}this.testInstrumentData.instruments=[];this.testInstrumentData.instruments[0]=i;this.testInstrumentData.instruments[1]=i;this.testInstrumentData.filters=[];for(var s=1;s<this.music.filters.filters.length;s++){this.testInstrumentData.filters.push(this.music.filters.filters[s])}this.testInstrumentData.writeSid();this.testingInstrument=true;this.testingInstrumentCleared=false;InstrumentPlayer.setMemory(this.testInstrumentData.memory,0,this.music.sidSpeed);this.playingInstrument=true};this.testInstrumentClearStart=function(){this.testInstrumentData.tracks=[[0],[1],[2]];this.testInstrumentData.patterns=[];for(var e=0;e<3;e++){this.testInstrumentData.patterns[e]=[];for(var t=0;t<64;t++){this.testInstrumentData.patterns[e].push(189);this.testInstrumentData.patterns[e].push(0);this.testInstrumentData.patterns[e].push(0);this.testInstrumentData.patterns[e].push(0)}this.testInstrumentData.patterns[e].push(255);this.testInstrumentData.patterns[e].push(0);this.testInstrumentData.patterns[e].push(0);this.testInstrumentData.patterns[e].push(0)}var i=InstrumentPlayer.getMemory();for(var e=0;e<3;e++){var r=this.testInstrumentData.packpattern2(e);address=this.testInstrumentData.labels["mt_patt"+e];for(var t=0;t<r.length-2;t++){i[address++]=r[t]}}};this.testInstrumentStop=function(){if(!this.testingInstrument){return}this.testInstrumentData.tracks=[[0],[1],[2]];this.testInstrumentData.patterns=[];for(var e=0;e<3;e++){this.testInstrumentData.patterns[e]=[];for(var t=0;t<64;t++){this.testInstrumentData.patterns[e].push(190);this.testInstrumentData.patterns[e].push(0);this.testInstrumentData.patterns[e].push(0);this.testInstrumentData.patterns[e].push(0)}this.testInstrumentData.patterns[e].push(255);this.testInstrumentData.patterns[e].push(0);this.testInstrumentData.patterns[e].push(0);this.testInstrumentData.patterns[e].push(0)}var i=InstrumentPlayer.getMemory();for(var e=0;e<3;e++){var r=this.testInstrumentData.packpattern2(e);address=this.testInstrumentData.labels["mt_patt"+e];for(var t=0;t<r.length-2;t++){i[address++]=r[t]}}};this.createSid=function(){this.songData.patterns=[];this.c64PatternMap=[];this.patternMap=[];this.a8Map=[];for(var e=0;e<this.music.patterns.length;e++){var t=this.music.patterns[e].getPatternData();this.patternMap[e]=[];var i=0;for(var r=0;r<t.length;r++){this.patternMap[e].push(this.songData.patterns.length);this.c64PatternMap.push({pattern:e,offset:i,length:t[r].length});this.songData.patterns.push(t[r]);i+=t[r].length/4}}this.songData.tracks=[];for(var e=0;e<this.music.tracks.length;e++){this.a8Map[e]=[];var a=[];for(var r=0;r<this.music.tracks[e].length;r++){var s=this.patternMap[this.music.tracks[e][r]];for(var o=0;o<s.length;o++){a.push(s[o]);this.a8Map[e].push(r)}}this.songData.tracks.push(a)}this.songData.instruments=[];for(var e=1;e<this.music.instruments.instruments.length;e++){this.songData.instruments.push(this.music.instruments.instruments[e])}this.songData.filters=[];for(var e=1;e<this.music.filters.filters.length;e++){this.songData.filters.push(this.music.filters.filters[e])}return this.songData.writeSid()},this.updateSid=function(e){if(typeof e=="undefined"){e=false}if(this.isPlaying()||e){var t=this.isPlaying();this.playingSid=false;var i=this.music.playheadPosition;this.createSid();if(typeof SIDplayer!="undefined"){SIDplayer.setMemory(this.songData.memory,0,this.music.sidSpeed);for(var r=0;r<296;r++){var a=SIDplayer.doCPU()}}this.setPlayheadPosition(i);this.playingSid=t}};this.patternUpdated=function(e,t){console.log("pattern updated!");if(!this.isPlaying()){return}if(e>=this.music.patterns.length){console.log("pattern index too big "+e);return}if(!this.songData.labels){console.log("no song labels");return}var i=this.currentPatternPointer[t];var r=this.currentPatternRow[t];var a=this.music.patterns[e].getPatternData();var s=this.patternMap[e];var o=SIDplayer.getMemory();for(var l=0;l<s.length;l++){var n=s[l];this.songData.patterns[n]=a[l];var h=this.songData.packpattern2(n);var d=this.songData.labels["mt_patt"+n];for(var c=0;c<h.length-2;c++){o[d++]=h[c]}}this.setPatternRow(t,r)};this.getPlayheadPosition=function(){var e=this.playheadPosition[0]-2;if(e<0){e=0}return e};this.setPlayheadPosition=function(e){if(!this.patternMap||this.patternMap.length==0){this.createSid()}var t=64;var i=this.songData.patternRowPositions;var r={};for(var a=0;a<3;a++){if(a<this.music.tracks.length){var s=0;var o=0;var l=0;for(var n=0;n<this.music.tracks[a].length;n++){s=n;l+=this.music.patterns[this.music.tracks[a][n]].duration;if(l>e){o=e-(l-this.music.patterns[this.music.tracks[a][n]].duration);break}}var h=this.music.tracks[a][s];this.music.currentPattern[a]=s;var d=Math.floor(o/t);var c=this.patternMap[h][d];var f=0;for(var n=0;n<this.a8Map[a].length;n++){if(this.a8Map[a][n]==s){f=n+d;break}}f++;c64PatternPosition=o-d*t;var u=0;for(var n=0;n<i[c].length;n++){var p=i[c][n];if(p==c64PatternPosition){u=n;break}}r["MT_CHNSONGPTR"+a]=f;r["MT_CHNPATTPTR"+a]=u;r["MT_CHNPATTNUM"+a]=c;r["MT_CHNTEMPO"+a]=parseInt($("#sidTempo").val()-1);r["MT_CHNCOUNTER"+a]=0}}this.setPointers(r)};this.downloadWAV=function(e){this.setupAudioContext();var t=$("#exportWAVChannel1").is(":checked");var i=$("#exportWAVChannel2").is(":checked");var r=$("#exportWAVChannel3").is(":checked");var a=$("input[name=exportWAVSpeed]:checked").val();if(a=="custom"){var s=6;var o=4;var l=$("#exportWAVBPM").val();l=parseInt(l);if(isNaN(l)){return}var n=50;a=l*s*o/(n*60)}var h=new Pattern;h.init("End Pattern",16);var d=this.music.patterns.length;this.music.patterns.push(h);this.music.tracks[0].push(d);this.music.tracks[1].push(d);this.music.tracks[2].push(d);this.createSid();SIDplayer.setMemory(this.songData.memory,0,a);SIDplayer.resetChannelDataPos();SIDplayer.setChannelOn(t,i,r);var c=0,f=.1,u=SIDplayer.getSampleRate(),p=new Wav({sampleRate:u,channels:1});var v=-1;var g=[];var m=false;while(c<u*600){var y=SIDplayer.play();if(!m&&(y>=.006||y<=-.006||c>9500)){console.log("starting at "+c+"!!!!!!!!!!!!!!!!!!!!!!!");m=true}if(m){g.push(y)}c++;this.calculatePointers();var b=this.currentPattern[0];if(b<this.c64PatternMap.length){var C=this.c64PatternMap[b].pattern;if(v!=C){if(C==d){console.log("reached end!!!");break}v=C}}}this.music.tracks[0].splice(this.music.tracks[0].length-1,1);this.music.tracks[1].splice(this.music.tracks[1].length-1,1);this.music.tracks[2].splice(this.music.tracks[2].length-1,1);this.music.patterns.splice(this.music.patterns.length-1,1);var x=new Float32Array(g.length);for(var c=0;c<x.length;c++){x[c]=g[c]}p.setBuffer(x);if(e.indexOf(".wav")==-1){e+=".wav"}p.download(e);var t=$("#channel1").is(":checked");var i=$("#channel2").is(":checked");var r=$("#channel3").is(":checked");SIDplayer.setChannelOn(t,i,r);SIDplayer.resetChannelDataPos();this.music.playheadPosition=0;this.updateSid(true)};this.download=function(e,t){switch(t){case"wav":return this.downloadWAV(e);break;case"sid":return this.downloadSID(e);break;case"prg":return this.downloadPRG(e);break;case"goat":return this.downloadGoat(e);break}};this.isPlaying=function(){return this.playingSid};this.stop=function(){this.playingSid=false};this.play=function(){if(u==null){this.setupAudioContext()}this.playingSid=true}};SidPlayer.c0=[23,39,57,75,95,116,138,161,186,212,240,14,45,78,113,150,190,232,20,67,116,169,225,28,90,156,226,45,124,207,40,133,232,82,193,55,180,57,197,90,247,158,79,10,209,163,130,110,104,113,138,179,238,60,158,21,162,70,4,220,208,226,20,103,221,121,60,41,68,141,8,184,161,197,40,205,186,241,120,83,135,26,16,113,66,137,79,155,116,226,240,166,14,51,32,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];SidPlayer.c1=[1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,3,3,3,3,3,4,4,4,4,5,5,5,6,6,6,7,7,8,8,9,9,10,10,11,12,13,13,14,15,16,17,18,19,20,21,23,24,26,27,29,31,32,34,36,39,41,43,46,49,52,55,58,62,65,69,73,78,82,87,92,98,104,110,117,124,131,139,147,156,165,175,185,196,208,221,234,248,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];function jsSID2(e,t,i){var a=[];var s=[];for(var r=0;r<3;r++){s[r]=[];a[r]=0}var o=new Uint8Array(65536);this.getData=function(){return s};this.getMemory=function(){return o};this.getEnvCnt=function(){return te};this.getSampleRate=function(){return l};this.resetChannelDataPos=function(){a[0]=0;a[1]=0;a[2]=0};for(var r=0;r<3;r++){s[r]=[];a[r]=0}this.author="Hermit";this.sourcecode="http://hermit.sidrip.com";this.version="0.9.1";this.year="2016";var l=i;this.getprefmodel=function(){return p[0]};this.getmodel=function(){return v};this.setmodel=function(e){v=e};var n=985248,h=50,d=3,c=65536*d*16;var f=[0,1,.6,.4];var u=[true,true,true];var p=[8580,8580,8580];var v=8580;var g=[54272,0,0];var m=n/l;var y=l/h;var b=1;var C=1,x=0;this.getChannelOn=function(){return u};this.setMute=function(e,t){u[e]=!t;if(t){for(var i=0;i<s[e].length;i++){s[e][i]=0}}};this.getMute=function(e){return!u[e]};this.setChannelOn=function(e,t,i){u[0]=e;if(!e){for(var r=0;r<s[0].length;r++){s[0][r]=0}}u[1]=t;if(!t){for(var r=0;r<s[1].length;r++){s[1][r]=0}}u[2]=i;if(!i){for(var r=0;r<s[2].length;r++){s[2][r]=0}}};this.setWave=function(e){if(e==54276&&!(o[54276]&1)){Q[0]&=62}if(e==54283&&!(o[54283]&1)){Q[1]&=62}if(e==54290&&!(o[54290]&1)){Q[2]&=62}};this.play=function(){x=Fe(0,54272);if(g[1]){x+=Fe(1,g[1])}if(g[2]){x+=Fe(2,g[2])}return x*b*f[C]};var S=[1,33,4,36,0,64,8,40],P=[128,64,1,2];var w=0,I=0,k=0,M=0,T=0,D=255,E=0,$=0,_=0,B=0,R=0;function A(e){w=e;I=0;M=0;T=0;_=0;D=255}function F(){E=o[w];B=2;R=0;if(E&1){switch(E&31){case 1:case 3:$=o[o[++w]+M]+o[o[w]+M+1]*256;B=6;break;case 17:case 19:$=o[o[++w]]+o[o[w]+1]*256+T;B=6;break;case 25:case 31:$=o[++w]+o[++w]*256+T;B=5;break;case 29:$=o[++w]+o[++w]*256+M;B=5;break;case 13:case 15:$=o[++w]+o[++w]*256;B=4;break;case 21:$=o[++w]+M;B=4;break;case 5:case 7:$=o[++w];B=3;break;case 23:$=o[++w]+T;B=4;break;case 9:case 11:$=++w;B=2}$&=65535;switch(E&224){case 96:k=I;I+=o[$]+(_&1);_&=20;_|=I&128|I>255;I&=255;_|=!I<<1|(!((k^o[$])&128)&&(k^I)&128)>>1;break;case 224:k=I;I-=o[$]+!(_&1);_&=20;_|=I&128|I>=0;I&=255;_|=!I<<1|((k^o[$])&128&&(k^I)&128)>>1;break;case 192:k=I-o[$];_&=124;_|=!(k&255)<<1|k&128|k>=0;break;case 0:I|=o[$];_&=125;_|=!I<<1|I&128;break;case 32:I&=o[$];_&=125;_|=!I<<1|I&128;break;case 64:I^=o[$];_&=125;_|=!I<<1|I&128;break;case 160:I=o[$];_&=125;_|=!I<<1|I&128;if((E&3)==3)M=I;break;case 128:o[$]=I&((E&3)==3?M:255);R=$}}else if(E&2){switch(E&31){case 30:$=o[++w]+o[++w]*256+((E&192)!=128?M:T);B=5;break;case 14:$=o[++w]+o[++w]*256;B=4;break;case 22:$=o[++w]+((E&192)!=128?M:T);B=4;break;case 6:$=o[++w];B=3;break;case 2:$=++w;B=2}$&=65535;switch(E&224){case 0:_&=254;case 32:if((E&15)==10){I=(I<<1)+(_&1);_&=60;_|=I&128|I>255;I&=255;_|=!I<<1}else{k=(o[$]<<1)+(_&1);_&=60;_|=k&128|k>255;k&=255;_|=!k<<1;o[$]=k;B+=2}break;case 64:_&=254;case 96:if((E&15)==10){k=I;I=(I>>1)+(_&1)*128;_&=60;_|=I&128|k&1;I&=255;_|=!I<<1}else{k=(o[$]>>1)+(_&1)*128;_&=60;_|=k&128|o[$]&1;k&=255;_|=!k<<1;o[$]=k;B+=2}break;case 192:if(E&4){o[$]--;o[$]&=255;_&=125;_|=!o[$]<<1|o[$]&128;B+=2}else{M--;M&=255;_&=125;_|=!M<<1|M&128}break;case 160:if((E&15)!=10)M=o[$];else if(E&16){M=D;break}else M=I;_&=125;_|=!M<<1|M&128;break;case 128:if(E&4){o[$]=M;R=$}else if(E&16)D=M;else{I=M;_&=125;_|=!I<<1|I&128}break;case 224:if(E&4){o[$]++;o[$]&=255;_&=125;_|=!o[$]<<1|o[$]&128;B+=2}}}else if((E&12)==8){switch(E&240){case 96:D++;D&=255;I=o[256+D];_&=125;_|=!I<<1|I&128;B=4;break;case 192:T++;T&=255;_&=125;_|=!T<<1|T&128;break;case 224:M++;M&=255;_&=125;_|=!M<<1|M&128;break;case 128:T--;T&=255;_&=125;_|=!T<<1|T&128;break;case 0:o[256+D]=_;D--;D&=255;B=3;break;case 32:D++;D&=255;_=o[256+D];B=4;break;case 64:o[256+D]=I;D--;D&=255;B=3;break;case 144:I=T;_&=125;_|=!I<<1|I&128;break;case 160:T=I;_&=125;_|=!T<<1|T&128;break;default:if(S[E>>5]&32)_|=S[E>>5]&223;else _&=255-(S[E>>5]&223)}}else{if((E&31)==16){w++;k=o[w];if(k&128)k-=256;if(E&32){if(_&P[E>>6]){w+=k;B=3}}else{if(!(_&P[E>>6])){w+=k;B=3}}}else{switch(E&31){case 0:$=++w;B=2;break;case 28:$=o[++w]+o[++w]*256+M;B=5;break;case 12:$=o[++w]+o[++w]*256;B=4;break;case 20:$=o[++w]+M;B=4;break;case 4:$=o[++w];B=3}$&=65535;switch(E&224){case 0:o[256+D]=w%256;D--;D&=255;o[256+D]=w/256;D--;D&=255;o[256+D]=_;D--;D&=255;w=o[65534]+o[65535]*256-1;B=7;break;case 32:if(E&15){_&=61;_|=o[$]&192|!(I&o[$])<<1}else{o[256+D]=(w+2)%256;D--;D&=255;o[256+D]=(w+2)/256;D--;D&=255;w=o[$]+o[$+1]*256-1;B=6}break;case 64:if(E&15){w=$-1;B=3}else{if(D>=255)return 254;D++;D&=255;_=o[256+D];D++;D&=255;k=o[256+D];D++;D&=255;w=o[256+D]+k*256-1;B=6}break;case 96:if(E&15){w=o[$]+o[$+1]*256-1;B=5}else{if(D>=255)return 255;D++;D&=255;k=o[256+D];D++;D&=255;w=o[256+D]+k*256-1;B=6}break;case 192:k=T-o[$];_&=124;_|=!(k&255)<<1|k&128|k>=0;break;case 224:k=M-o[$];_&=124;_|=!(k&255)<<1|k&128|k>=0;break;case 160:T=o[$];_&=125;_|=!T<<1|T&128;break;case 128:o[$]=T;R=$}}}w++;w&=65535;return 0}var L=1,U=2,H=4,O=8,G=16,z=32,N=64,W=128,X=16,Y=64,V=128,q=[1,2,4,1,2,4,1,2,4],j=16,K=32,Z=64,J=128;var Q=[0,0,0,0,0,0,0,0,0],ee=[0,0,0,0,0,0,0,0,0],te=[0,0,0,0,0,0,0,0,0],ie=[0,0,0,0,0,0,0,0,0],re=[0,0,0,0,0,0,0,0,0];var ae=[0,0,0,0,0,0,0,0,0],se=[0,0,0,0,0,0,0,0,0],oe=[0,0,0],le=[0,0,0];var ne=[8388600,8388600,8388600,8388600,8388600,8388600,8388600,8388600,8388600];var he=[0,0,0,0,0,0,0,0,0],de=[0,0,0,0,0,0,0,0,0],ce;var fe=[0,0,0],ue=[0,0,0],pe=-2*3.14*(12500/256)/l,ve=-2*3.14*(2e4/256)/l;var ge=[0,0,0],me=[0,0,0];var ye,be,Ce,xe,Se,Pe,we,Ie,ke,Me,Te,De,Ee,$e,_e,Be,Re,Ae;this.initSID=function(){p[0]=8580;C=1;loaded=1;for(var e=54272;e<=55295;e++){o[e]=0}for(var e=56832;e<=57343;e++){o[e]=0}for(var e=0;e<9;e++){Q[e]=X;ee[e]=te[e]=ie[e]=re[e]=0}};function Fe(e,t){Re=0;Ae=0;for(var i=e*d;i<(e+1)*d;i++){ye=Q[i]&L;be=t+(i-e*d)*7;Ce=o[be+4];xe=Ce&240;Se=Ce&O;Ie=o[be+6];Te=0;if(ye!=(Ce&L)){if(ye){Q[i]&=255-(L|V|Y)}else{Q[i]=L|V|Y;if((Ie&15)>(re[i]&15))Te=1}}re[i]=Ie;ee[i]+=m;if(ee[i]>=32768)ee[i]-=32768;if(Q[i]&V){we=o[be+5]>>4;Pe=Oe[we]}else if(Q[i]&Y){we=o[be+5]&15;Pe=Oe[we]}else{we=Ie&15;Pe=Oe[we]}we=Ge[we];if(ee[i]>=Pe&&ee[i]<Pe+m&&Te==0){ee[i]-=Pe;if(Q[i]&V||++ie[i]==ze[te[i]]){if(!(Q[i]&X)){if(Q[i]&V){te[i]+=we;if(te[i]>=255){te[i]=255;Q[i]&=255-V}}else if(!(Q[i]&Y)||te[i]>(Ie>>4)+(Ie&240)){te[i]-=we;if(te[i]<=0&&te[i]+we!=0){te[i]=0;Q[i]|=X}}}ie[i]=0}}te[i]&=255;ke=(o[be]+o[be+1]*256)*m;if(Se||Ce&U&&oe[e]){ae[i]=0}else{ae[i]+=ke;if(ae[i]>16777215)ae[i]-=16777216}Me=ae[i]&8388608;oe[e]=Me>(se[i]&8388608)?1:0;if(xe&W){Te=ne[i];if((ae[i]&1048576)!=(se[i]&1048576)||ke>=1048576){we=Te&4194304^(Te&131072)<<5;Te=(Te<<1)+(we>0||Se)&8388607;ne[i]=Te}$e=xe&112?0:((Te&1048576)>>5)+((Te&262144)>>4)+((Te&16384)>>1)+((Te&2048)<<1)+((Te&512)<<2)+((Te&32)<<5)+((Te&4)<<7)+((Te&1)<<8)}else if(xe&N){De=(o[be+2]+(o[be+3]&15)*256)*16;Te=ke>>9;if(0<De&&De<Te)De=Te;Te^=65535;if(De>Te)De=Te;Te=ae[i]>>8;if(xe==N){we=256/(ke>>16);if(Se)$e=65535;else if(Te<De){Ee=(65535-De)*we;if(Ee>65535)Ee=65535;$e=Ee-(De-Te)*we;if($e<0)$e=0}else{Ee=De*we;if(Ee>65535)Ee=65535;$e=(65535-Te)*we-Ee;if($e>=0)$e=65535;$e&=65535}}else{$e=Te>=De||Se?65535:0;if(xe&G){if(xe&z){$e=$e?Le(i,PulseTriSaw_8580,Te>>4,1):0}else{Te=ae[i]^(Ce&H?le[e]:0);$e=$e?Le(i,PulseSaw_8580,(Te^(Te&8388608?16777215:0))>>11,0):0}}else if(xe&z)$e=$e?Le(i,PulseSaw_8580,Te>>4,1):0}}else if(xe&z){$e=ae[i]>>8;if(xe&G)$e=Le(i,TriSaw_8580,$e>>4,1);else{we=ke/18874368;$e+=$e*we;if($e>65535)$e=65535-($e-65536)/we}}else if(xe&G){Te=ae[i]^(Ce&H?le[e]:0);$e=(Te^(Te&8388608?16777215:0))>>7}if(xe)he[i]=$e;else{$e=he[i]}se[i]=ae[i];le[e]=Me;if(o[t+23]&q[i]){var r=($e-32768)*(te[i]/256);_e=(o[t+21]&7)/8+o[t+22]+.2;if(v==8580){_e=1-Math.exp(_e*pe);Be=Math.pow(2,(4-(o[t+23]>>4))/8)}else{if(_e<24)_e=.035;else _e=1-1.263*Math.exp(_e*ve);Be=o[t+23]>95?8/(o[t+23]>>4):1.41}Te=r+me[i]*Be+ge[i];if(o[t+24]&Z)r-=Te;Te=me[i]-Te*_e;me[i]=Te;if(o[t+24]&K)r-=Te;Te=ge[i]+Te*_e;ge[i]=Te;if(o[t+24]&j)r+=Te;if(u[i]){s[i][a[i]++]=r;Re+=($e-32768)*(te[i]/256)}}else if(i%d!=2||!(o[t+24]&J)){if(u[i]){s[i][a[i]++]=($e-32768)*(te[i]/256);Ae+=($e-32768)*(te[i]/256)}}}if(o[1]&3)o[t+27]=$e>>8;o[t+28]=te[3];_e=(o[t+21]&7)/8+o[t+22]+.2;if(v==8580){_e=1-Math.exp(_e*pe);Be=Math.pow(2,(4-(o[t+23]>>4))/8)}else{if(_e<24)_e=.035;else _e=1-1.263*Math.exp(_e*ve);Be=o[t+23]>95?8/(o[t+23]>>4):1.41}Te=Re+ue[e]*Be+fe[e];if(o[t+24]&Z)Ae-=Te;Te=ue[e]-Te*_e;ue[e]=Te;if(o[t+24]&K)Ae-=Te;Te=fe[e]+Te*_e;fe[e]=Te;if(o[t+24]&j)Ae+=Te;return Ae/c*(o[t+24]&15)}function Le(e,t,i,r){if(r&&v==6581)i&=2047;ce=(t[i]+de[e])/2;de[e]=t[i];return ce}function Ue(e,t,i,r){for(var a=0;a<4096;a++){e[a]=0;for(var s=0;s<12;s++){var o=0;for(var l=0;l<12;l++){o+=t/Math.pow(i,Math.abs(l-s))*((a>>l&1)-.5)}e[a]+=o>=r?Math.pow(2,s):0}e[a]*=12}}TriSaw_8580=new Array(4096);Ue(TriSaw_8580,.8,2.4,.64);PulseSaw_8580=new Array(4096);Ue(PulseSaw_8580,1.4,1.9,.68);PulseTriSaw_8580=new Array(4096);Ue(PulseTriSaw_8580,.8,2.5,.64);var He=Math.max(m,9);var Oe=[He,32*1,63*1,95*1,149*1,220*1,267*1,313*1,392*1,977*1,1954*1,3126*1,3907*1,11720*1,19532*1,31251*1];var Ge=[Math.ceil(He/9),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];var ze=[1,30,30,30,30,30,30,16,16,16,16,16,16,16,16,8,8,8,8,8,8,8,8,8,8,8,8,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}var audioContext=null;var scriptNode=null;var SidPlayer2=function(){this.music=null;this.musicPlayer=null;this.instrumentPlayer=null;this.bufferLength=2048*2;this.exportGoatTracker=null;this.exportSID=null};SidPlayer2.prototype={init:function(e){this.music=e;this.musicPlayer=new SidPatternPlayer;this.musicPlayer.init(e);this.instrumentPlayer=new SidPatternPlayer;this.instrumentPlayer.init(e);this.songData=new SongData;this.songData.init()},setupAudioContext:function(){if(audioContext!=null){return}audioContext=null;if(typeof AudioContext!=="undefined"){audioContext=new AudioContext}else{audioContext=new webkitAudioContext}this.musicPlayer.setup(audioContext.sampleRate,this.bufferLength);this.instrumentPlayer.setup(audioContext.sampleRate,this.bufferLength);scriptNode=null;if(typeof audioContext.createJavaScriptNode==="function"){scriptNode=audioContext.createJavaScriptNode(this.bufferLength,0,1)}else{scriptNode=audioContext.createScriptProcessor(this.bufferLength,0,1)}var a=this;scriptNode.onaudioprocess=function(e){var t=e.outputBuffer;var i=t.getChannelData(0);a.musicPlayer.sid.resetChannelDataPos();a.instrumentPlayer.sid.resetChannelDataPos();if(a.musicPlayer.playing&&!a.instrumentPlayer.playing){var r=0;for(r=0;r<t.length;r++){i[r]=a.musicPlayer.nextSample()}}else if(!a.musicPlayer.playing&&a.instrumentPlayer.playing){for(var r=0;r<t.length;r++){i[r]=a.instrumentPlayer.nextSample()}}else if(a.musicPlayer.playing&&a.instrumentPlayer.playing){for(var r=0;r<t.length;r++){i[r]=a.musicPlayer.nextSample()+a.instrumentPlayer.nextSample()}}else{for(var r=0;r<t.length;r++){i[r]=0}}};if(!UI.isMobile){this.tuna=new Tuna(audioContext);this.convolver=new this.tuna.Convolver({highCut:22050,lowCut:20,dryLevel:.8,wetLevel:.7,level:1,impulse:"impulses/impulse_rev.wav",bypass:0});this.chorus=new this.tuna.Chorus({rate:1.5,feedback:.2,delay:.0045,bypass:1});this.overdrive=new this.tuna.Overdrive({outputGain:.1,drive:.7,curveAmount:1,algorithmIndex:0,bypass:1});this.filter=new this.tuna.Filter({frequency:440,Q:1,gain:0,b5:"lowpass",bypass:0});this.cabinet=new this.tuna.Cabinet({makeupGain:1,impulsePath:"impulses/impulse_guitar.wav",bypass:0});this.moog=new this.tuna.MoogFilter({cutoff:.765,resonance:.5,bufferSize:4096});this.convolver.wetLevel=0;scriptNode.connect(this.moog);this.moog.connect(audioContext.destination)}else{scriptNode.connect(audioContext.destination)}},setPlayheadPosition:function(e){return this.musicPlayer.setPlayheadPosition(e)},getPlayheadPosition:function(){return this.musicPlayer.getPlayheadPosition()},setMute:function(e,t){this.musicPlayer.setMute(e,t)},getMute:function(e){return this.musicPlayer.getMute(e)},getPlayheadPositionFraction:function(){var e=this.musicPlayer.getTick();var t=this.musicPlayer.getTempo();return e/(t+1)},getInstrumentChannelData:function(){return this.instrumentPlayer.getChannelData()},getChannelData:function(){return this.musicPlayer.getChannelData()},isPlayingInstrument:function(){return this.instrumentPlayer.isPlaying()},isPlaying:function(){return this.musicPlayer.isPlaying()},play:function(e){this.musicPlayer.play(e)},stop:function(){this.musicPlayer.stop()},playTestInstrument:function(e,t,i){this.setupAudioContext();this.instrumentPlayer.playTestInstrument(e,t,i)},stopTestInstrument:function(){this.instrumentPlayer.stopTestInstrument()},getBlankPatternData:function(e){if(e==0){return}var t=[];for(var i=0;i<e;i++){t.push(190);t.push(0);t.push(0);t.push(0)}return t},getC64PatternData:function(e){this.maxc64PatternLength=64;var t=[];var i=this.music.patterns.getNotes(e);var r=this.music.patterns.getDuration(e);var t=[];for(var a=0;a<r;a++){t.push({instrument:0,start:false,duration:0,pitch:0,effect:0,effectParam:0,effectParam2:0})}for(var a=0;a<i.length;a++){var s=i[a];for(var o=s.pos;o<s.pos+s.dur;o++){if(o<t.length){t[o].instrument=s.ins;t[o].start=o==s.pos;t[o].duration=s.dur;t[o].pitch=s.pit}}}var l=this.music.patterns.getParams(e,"effects");for(var a=0;a<l.length;a++){var n=l[a].pos;if(n<t.length){t[n].effect=l[a].values.effect;t[n].effectParam=l[a].values.value1;t[n].effectParam2=l[a].values.value2}}var h=[];var d=[];var c=-1;var f=0;var a=0;var u=0;while(a<t.length){var p=parseInt(t[a].instrument);var v=0;var g=0;if(p==0){var m=0;var y=true;c=0;while(a<t.length&&t[a].instrument==0){var b=0;var C=0;if(t[a].effect){b=parseInt(t[a].effect);C=parseInt(t[a].effectParam);x=parseInt(t[a].effectParam2);if(b==16){b=11;C=0;x=0}if(b==17){b=0}}a++;m++;if(y){h.push(190)}else{h.push(189)}h.push(0);h.push(b);h.push(C);if(h.length>=this.maxc64PatternLength*4){d.push(h);h=[]}}}else if(t[a].start){var m=t[a].duration;var b=0;var C=0;var x=0;v=t[a].pitch;if(t[a].effect){b=parseInt(t[a].effect);C=parseInt(t[a].effectParam);x=parseInt(t[a].effectParam2);if(b==16){b=11;C=0;x=0}if(b==17){if(c==p){b=3;C=0;x=v}else{b=0}}}a++;if(b==3){h.push(x+96)}else{h.push(v+96)}h.push(p);h.push(b);h.push(C);m--;if(h.length>=this.maxc64PatternLength*4){d.push(h);h=[]}c=p;while(m>0){var b=0;var C=0;var x=0;if(t[a].effect){b=parseInt(t[a].effect);C=parseInt(t[a].effectParam);x=parseInt(t[a].effectParam2);if(b==16){b=11;C=0;x=0}if(b==17){b=0}}if(b==3){h.push(x+96)}else{h.push(189)}h.push(0);h.push(b);h.push(C);m--;a++;if(h.length>=this.maxc64PatternLength*4){d.push(h);h=[]}}}else{h.push(189);h.push(0);h.push(0);h.push(0);a++;m++}}if(h.length>0){d.push(h)}return d},exportAsType:function(e){switch(e){case"goattracker":if(this.exportGoatTracker==null){this.exportGoatTracker=new ExportGoatTracker;this.exportGoatTracker.init(this)}this.exportGoatTracker.start();break;case"prg":if(this.exportPRG==null){this.exportPRG=new ExportSIDPRG;this.exportPRG.init(this)}this.exportPRG.start();break;case"sid":if(this.exportSID==null){this.exportSID=new ExportSID;this.exportSID.init(this)}this.exportSID.start();break;case"wav":break}},createSid:function(){this.songData.patterns=[];this.c64PatternMap=[];this.patternMap=[];var e=this.music.doc.data.tracks;var t=0;for(var i=0;i<e.length;i++){var r=e[i].trackId;var a=this.music.tracks.getLength(r);if(a>t){t=a}}var s=this.music.patterns.getPatternCount();for(var i=0;i<s;i++){var o=this.music.patterns.getPatternId(i);var l=this.music.patterns.getDuration(o);var n=this.getC64PatternData(o);this.patternMap[i]=[];var h=0;for(var d=0;d<n.length;d++){this.patternMap[i].push(this.songData.patterns.length);this.c64PatternMap.push({pattern:i,offset:h,length:n[d].length});this.songData.patterns.push(n[d]);h+=n[d].length/4}}var c={};for(var i=0;i<this.music.doc.data.tracks.length;i++){var f=this.music.doc.data.tracks[i].patternInstances;var u=0;for(var d=0;d<f.length;d++){var p=f[d].position;var o=f[d].patternId;var v=p+this.music.patterns.getDuration(o);var g=p-u;u=v;if(g>64){var m=g%64;if(typeof c[64]=="undefined"){var y=this.getBlankPatternData(64);var b=this.songData.patterns.length;this.songData.patterns.push(y);c[64]=b}if(m>0&&typeof c[m]=="undefined"){var y=this.getBlankPatternData(m);var b=this.songData.patterns.length;this.songData.patterns.push(y);c[m]=b}}else{if(g!=0&&typeof c[g]=="undefined"){var y=this.getBlankPatternData(g);var b=this.songData.patterns.length;this.songData.patterns.push(y);c[g]=b}}}var C=t-u;if(C>64){var m=C%64;if(typeof c[64]=="undefined"){var y=this.getBlankPatternData(64);var b=this.songData.patterns.length;this.songData.patterns.push(y);c[64]=b}if(m>0&&typeof c[m]=="undefined"){var y=this.getBlankPatternData(m);var b=this.songData.patterns.length;this.songData.patterns.push(y);c[m]=b}}else{if(C!=0&&typeof c[C]=="undefined"){var y=this.getBlankPatternData(C);var b=this.songData.patterns.length;this.songData.patterns.push(y);c[C]=b}}}this.songData.tracks=[];for(var i=0;i<this.music.doc.data.tracks.length;i++){var f=this.music.doc.data.tracks[i].patternInstances;var x=[];var u=0;for(var d=0;d<f.length;d++){var p=f[d].position;var o=f[d].patternId;var v=p+this.music.patterns.getDuration(o);var g=p-u;u=v;var S=Math.floor(g/64);var P=g%64;for(var w=0;w<S;w++){var b=c[64];x.push(b)}if(P>0){var b=c[P];x.push(b)}var I=this.patternMap[f[d].patternId];for(var w=0;w<I.length;w++){x.push(I[w])}}var C=t-u;var S=Math.floor(C/64);var P=C%64;for(var w=0;w<S;w++){var b=c[64];x.push(b)}if(P>0){var b=c[P];x.push(b)}this.songData.tracks.push(x)}this.songData.instruments=[];for(var i=1;i<this.music.doc.data.instruments.length;i++){this.songData.instruments.push(this.music.instruments.getInstrument(i))}this.songData.filters=[];for(var i=1;i<this.music.doc.data.filters.length;i++){this.songData.filters.push(this.music.doc.data.filters[i])}return this.songData.writeSid()}};var g_tick=0;var SidPatternPlayer=function(){this.music=null;this.playing=false;this.channels=[];this.channelCount=3;this.b5=0;this.filterCommand=0;this.a0=0;this.b9=[6,6];this.sampleRate=0;this.sid=null;this.c2=null;this.framecnt=0;this.a4=3840;this.playheadPosition=0;this.newPlayheadPosition=0;this.testInstrument=null;this.testInstrumentChannel=false};SidPatternPlayer.prototype={init:function(e){this.music=e;this.initChannels()},initChannels:function(){this.channels=[];for(var e=0;e<this.channelCount;e++){var t={};t.instrument=1;t.mute=false;this.channels.push(t)}},setMute:function(e,t){this.channels[e].mute=t},getMute:function(e){return this.channels[e].mute},setup:function(e,t){this.sampleRate=e;this.bufferLength=t;var i=1;var r=1;this.C64_PAL_CPUCLK=985248*i;this.PAL_FRAMERATE=50*i;this.clk_ratio=this.C64_PAL_CPUCLK/this.sampleRate;this.sid=new jsSID2(t,5e-4,this.sampleRate);this.c2=this.sid.getMemory();this.frame_sampleperiod=this.sampleRate/(this.PAL_FRAMERATE*r);this.c9=54272;this.debugData=[];this.lastTime=getTimestamp();this.sampleCount=0;this.lastCalledPlay=0},nextSample:function(){this.sampleCount++;this.framecnt--;if(this.framecnt<=0){this.framecnt=this.frame_sampleperiod;this.playRoutine()}return this.sid.play()},getPlayheadPosition:function(){var e=this.playheadPosition;if(e<0){return 0}return e},getTick:function(){if(this.channels.length==0){return 0}return this.channels[0].tick},getTempo:function(){if(this.channels.length==0){return 0}return this.channels[0].tempo},getChannelData:function(){return this.sid.getData()},isPlaying:function(){return this.playing},play:function(e){this.debugData=[];this.startSong(e);this.playing=true},stop:function(){this.playing=false},setPlayheadPosition:function(e){for(var t=0;t<3;t++){if(t<this.music.doc.data.tracks.length){var i=0;var r=0;var a=0;var s=this.music.tracks.getPatternAt(t,e);this.channels[t].a8=e;this.channels[t].patternPosition=this.music.tracks.getPatternPositionAt(t,e)}}this.playheadPosition=e;this.newPlayheadPosition=e},playTestInstrument:function(e,t,i){this.startSong();this.testInstrumentChannel=i;if(typeof this.testInstrumentChannel=="undefined"){this.testInstrumentChannel=0}this.testInstrument=t;this.channels[this.testInstrumentChannel].newNote=e+96;if(this.testInstrument.gateTimer&64){this.channels[this.testInstrumentChannel].gate=254;if(!(t.gateTimer&128)){this.c2[this.c9+5+this.testInstrumentChannel*7]=this.a4>>8;this.c2[this.c9+6+this.testInstrumentChannel*7]=this.a4&255}}this.channels[this.testInstrumentChannel].gate=255;this.channels[this.testInstrumentChannel].tick=1;this.playing=true;this.b2=15},stopTestInstrument:function(){if(this.testInstrumentChannel!==false){this.channels[this.testInstrumentChannel].gate=254}},startSong:function(e){if(typeof e=="undefined"){e=0}var t=1;this.playheadPosition=0;this.sid.initSID();for(var i=0;i<this.channelCount;i++){this.c2[this.c9+0+7*i]=0;this.c2[this.c9+1+7*i]=0;this.c2[this.c9+2+7*i]=0;this.c2[this.c9+3+7*i]=0;this.c2[this.c9+4+7*i]=0;this.c2[this.c9+5+7*i]=0;this.c2[this.c9+6+7*i]=0;this.channels[i].a8=0;this.channels[i].patternPosition=0;this.channels[i].newNote=0;this.channels[i].gateTimer=this.music.instruments.getInstrument(1).gateTimer&63;this.channels[i].gate=254;this.channels[i].command=0;this.channels[i].b3=0;this.channels[i].b6=0;this.channels[i].a6=0;this.channels[i].instrument=0;this.channels[i].a2=0;this.channels[i].wave=0;this.channels[i].c4=0;this.channels[i].a3=0;this.channels[i].pulse=0;this.channels[i].b7=0;this.channels[i].a1=0;this.channels[i].speedtablePosition=0;this.channels[i].c8=0;this.channels[i].c3=0;this.channels[i].c6=0;this.channels[i].c7=0;this.channels[i].tempo=this.music.getTempo()-1;this.channels[i].tick=this.channels[i].tempo-1;this.channels[i].finished=false}this.b1=0;this.a7=0;this.b5=0;this.a0=0;this.filtertable=[];this.filterTime=0;this.b2=15;this.testInstrument=null;this.setPlayheadPosition(e)},playRoutine:function(){if(this.a0>0&&this.a0<=this.filtertable.length&&this.filtertable[this.a0-1][0]==255){this.a0=this.filtertable[this.a0-1][1]}if(this.a0&&this.a0<=this.filtertable.length){var e=this.filtertable[this.a0-1][0]&255;var t=this.filtertable[this.a0-1][1]&255;if(this.filterTime==0){if(e>=128){this.b5=e&112;this.a7=t;this.a0++;if(this.a0<this.filtertable.length&&this.filtertable[this.a0-1][0]==0){this.b1=this.filtertable[this.a0-1][1];this.a0++}}else{if(e){this.filterTime=e}else{this.b1=t;this.a0++}}}if(this.filterTime){this.b1+=t&255;this.filterTime--;if(this.filterTime==0){this.a0++}}}this.c2[this.c9+21]=0;this.c2[this.c9+22]=this.b1;this.c2[this.c9+23]=this.a7;this.c2[this.c9+24]=this.b5|this.b2;var i=false;for(var r=0;r<this.channels.length;r++){var a=this.channels[r];var s=true;var o=true;var l=true;var n=true;if(true){var h=null;if(this.testInstrument!=null){n=false;if(r==this.testInstrumentChannel){h=this.testInstrument}else{continue}}else{h=this.music.instruments.getInstrument(a.instrument)}a.tick-=1;if(a.tick<0){if(a.tempo>=2){a.tick=a.tempo}else{a.tick=this.b9[a.tempo];a.tempo^=1}if(a.gateTimer>a.tick){console.log("illegal gatetimer!!")}a.a8++;if(!i){this.playheadPosition=this.newPlayheadPosition;this.newPlayheadPosition=this.playheadPosition+1;i=true}var d=this.music.doc.data.tracks[r];if(a.a8>=this.music.tracks.getLength(r)){a.finished=true}else{a.finished=false;if(this.testInstrument==null){var c=this.music.tracks.getPatternIndexAt(r,a.a8);if(c!==false){var f=this.music.tracks.getPatternIdAtIndex(r,c);if(f!==false){if(f>=this.music.doc.data.patterns.length){a.finished=true}else{a.patternPosition=this.music.tracks.getPatternPositionAtIndex(r,c,a.a8)}}}}}}else if(a.tick==0){a.gateTimer=h.gateTimer&63;if(a.newNote){a.note=a.newNote-96;a.command=0;a.c3=h.vibratoDelay+1;a.c6=h.vibratoSpeed;a.c7=h.vibratoDepth;a.b3=h.speedtable[0];if(a.b6!=3){if(h.firstWave){if(h.firstWave>=254){a.gate=h.firstWave}else{a.wave=h.firstWave;a.gate=255}}a.wavetable=h.wavetable;a.a3=0;if(a.wavetable.length>0){a.a3=1}a.pulsetable=h.pulsetable;a.a1=0;if(a.pulsetable.length>0){a.a1=1}a.b7=0;a.speedtable=h.speedtable;a.speedtablePosition=0;if(h.filtertable.length>0){this.filtertable=h.filtertable;this.a0=0;if(this.filtertable.length>0){this.a0=1}}this.c2[this.c9+5+7*r]=(h.attack<<4)+h.decay;this.c2[this.c9+6+7*r]=(h.sustain<<4)+h.release}}switch(a.b6){case 0:a.command=0;a.b3=0;break;case 1:case 2:a.c8=0;a.command=a.b6;a.b3=a.a6;a.speed=a.newSpeed;a.b8=a.b0;a.b4=a.a9;break;case 3:case 4:a.command=a.b6;a.b3=a.a6;a.speed=a.newSpeed;a.b8=a.b0;a.b4=a.a9;break;case 5:this.c2[this.c9+5+7*r]=a.a6;break;case 6:this.c2[this.c9+6+7*r]=a.a6;break;case 7:a.wave=a.a6;break;case 10:var u=a.a6;if(u<this.music.doc.data.filters.length){this.filtertable=this.music.doc.data.filters[u].filtertable;if(this.filtertable.length>0){this.a0=1;this.filterTime=0}}break;case 16:this.filtertable=[];this.a0=0;this.b5=0;this.fitlerTime=0;this.a7=0;this.b1=0;break;case 11:this.a7=a.a6;if(!this.a7){this.a0=0}break;case 12:this.b1=a.a6;break;case 13:if(a.a6<16){this.b2=a.a6}break;case 14:a.speed=a.newSpeed;a.b8=a.b0;a.b4=a.a9;for(var p=0;p<this.channels.length;p++){this.channels[p].tempo=0}this.b9[0]=a.b8-1;this.b9[1]=a.b4-1;break;case 15:{var v=a.a6&127;if(v>=3){v--}if(a.a6>=128){a.tempo=v}else{for(var p=0;p<this.channels.length;p++){this.channels[p].tempo=v}}}break}if(a.newNote){a.newNote=0;if(a.b6!=3){s=false;o=false;l=false;n=false}}}if(s){if(a.a3!==0&&a.a3<=a.wavetable.length){var g=a.wavetable[a.a3-1][0];var m=a.wavetable[a.a3-1][1];if(g>15){if(g<224){a.wave=g}if(g>=224&&g<=239){a.wave=g&15}if(g>=240&&g<=254){var y=a.wavetable[a.a3-1][1];switch(g&15){case 0:case 8:case 14:break;case 1:{var b=0;if(y&&y<=a.speedtable.length){b=(a.speedtable[y-1][0]<<8)+a.speedtable[y-1][1]}if(b>=32768){b=SidPlayer.c0[a.c5+1]|SidPlayer.c1[a.c5+1]<<8;b-=SidPlayer.c0[a.c5]|SidPlayer.c1[a.c5]<<8;b>>=a.speedtable[y-1][1]}a.freq+=b}break;case 2:{var b=0;if(y&&y<=a.speedtable.length){b=(a.speedtable[y-1][0]<<8)+a.speedtable[y-1][1]}if(b>=32768){b=SidPlayer.c0[a.c5+1]|SidPlayer.c1[a.c5+1]<<8;b-=SidPlayer.c0[a.c5]|SidPlayer.c1[a.c5]<<8;b>>=a.speedtable[y-1][1]}a.freq-=b}break;case 3:{var C=SidPlayer.c0[a.note]|SidPlayer.c1[a.note]<<8;var b=0;if(!y){a.freq=C;a.c8=0}else{b=(a.speedtable[y-1][0]<<8)+a.speedtable[y-1][1];if(b>=32768){b=SidPlayer.c0[a.c5+1]|SidPlayer.c1[a.c5+1]<<8;b-=SidPlayer.c0[a.c5]|SidPlayer.c1[a.c5]<<8;b>>=a.speedtable[y-1][1]}if(a.freq<C){a.freq+=b;if(a.freq>C){a.freq=C;a.c8=0}}if(a.freq>C){a.freq-=b;if(a.freq<C){a.freq=C;a.c8=0}}}}break;case 4:{var b=0;var x=0;if(y){x=a.speedtable[y-1][0]&255;b=a.speedtable[y-1][1]}if(x>=128){x&=127;b=SidPlayer.c0[a.c5+1]|SidPlayer.c1[a.c5+1]<<8;b-=SidPlayer.c0[a.c5]|SidPlayer.c1[a.c5]<<8;b>>=a.speedtable[y-1][1]}if(a.c8<128&&a.c8>x){a.c8^=255}a.c8+=2;if(a.c8&1){a.freq-=b}else{a.freq+=b}}break;case 5:this.c2[this.c9+5+7*r]=y;break;case 6:this.c2[this.c9+6+7*r]=y;break;case 7:a.wave=y;break;case 11:this.a7=y;if(!a7){this.filterPointer=0}break;case 12:this.b1=y;break;case 13:if(a.a6<16)this.b2=y;break}}}else{if(a.c4!=g){a.c4++;s=false}}if(s){a.c4=0;a.a3++;if(a.wavetable[a.a3-1][0]==255){a.a3=a.wavetable[a.a3-1][1]}if(g>=240&&g<=254){s=false;o=false}if(s){if(m!=128){if(m<128){m+=a.note}m&=127;a.freq=SidPlayer.c0[m]|SidPlayer.c1[m]<<8;a.c8=0;a.c5=m;o=false}}}}}if(o&&a.tick){switch(a.command){case 1:{var b=0;if(a.speed){b=a.speed}if(b>=32768){b=SidPlayer.c0[a.c5+1]|SidPlayer.c1[a.c5+1]<<8;b-=SidPlayer.c0[a.c5]|SidPlayer.c1[a.c5]<<8;b>>=a.b4}a.freq+=b}break;case 2:{var b=0;if(a.speed){b=a.speed}if(b>=32768){b=SidPlayer.c0[a.c5+1]|SidPlayer.c1[a.c5+1]<<8;b-=SidPlayer.c0[a.c5]|SidPlayer.c1[a.c5]<<8;b>>=a.b4}a.freq-=b}break;case 0:if(!a.c3){break}if(a.c3>1){a.c3--;break}case 4:{var b=a.c6;var S=a.c7;if(a.command==4){b=a.b8&255;S=a.b4&255}if(b==0||S==0){break}if(b>=128){var P=S;b&=127;S=SidPlayer.c0[a.c5+1]|SidPlayer.c1[a.c5+1]<<8;S-=SidPlayer.c0[a.c5]|SidPlayer.c1[a.c5]<<8;S>>=S}if(a.c8<128&&a.c8>b){a.c8^=255}a.c8=a.c8+2&255;if(a.c8&1){a.freq-=S}else{a.freq+=S}}break;case 3:{var C=SidPlayer.c0[a.note]|SidPlayer.c1[a.note]<<8;var b=0;if(!a.speed){a.freq=C;a.c8=0}else{b=a.speed;if(b>=32768){b=SidPlayer.c0[a.c5+1]|SidPlayer.c1[a.c5+1]<<8;b-=SidPlayer.c0[a.c5]|SidPlayer.c1[a.c5]<<8;b>>=a.b4}if(a.freq<C){a.freq+=b;if(a.freq>C){a.freq=C;a.c8=0}}if(a.freq>C){a.freq-=b;if(a.freq<C){a.freq=C;a.c8=0}}}}break}}if(l&&a.tick){if(a.a1>0&&a.a1<=a.pulsetable.length){var w=a.pulsetable[a.a1-1][0];var I=a.pulsetable[a.a1-1][1];if(w==255){a.a1=I;if(a.a1!=0){w=a.pulsetable[a.a1-1][0];I=a.pulsetable[a.a1-1][1]}else{l=false}}if(l){if(a.b7==0){if(w>=128){a.pulse=(w&15)<<8;a.pulse|=I;a.a1++}else{a.b7=w}}if(a.b7!=0){var b=I&255;if(b<128){a.pulse+=b;a.pulse&=4095}else{a.pulse+=b;a.pulse-=256;a.pulse&=4095}a.b7--;if(a.b7==0){a.a1++}}}}}var d=this.music.doc.data.tracks[r];var f=this.music.tracks.getPatternAt(r,a.a8);var k=0;if(f!==false){k=this.music.patterns.getDuration(f)}else{if(a.tick==0){a.gate=254}}if(f!==false&&n){if(a.tick==a.gateTimer&&a.patternPosition<k){if(a.patternPosition<k){var M=this.music.patterns.getParamAt(f,"effects",a.patternPosition);if(M!=null){a.b6=M.values.effect;a.a6=M.values.value1;a.a5=M.values.value2}else{a.b6=0;a.a6=0;a.a5=0}if(typeof a.b6=="undefined"){a.b6=0}if(typeof a.a6=="undefined"){a.a6=0}var T=this.music.patterns.getNoteAt(f,a.patternPosition);if(T!==null){a.newNote=T.pit+96;if(a.b6==17&&a.instrument==T.ins){a.b6=3;a.a6=0}a.instrument=T.ins;a.a2=T.dur;if(a.newNote<=188){if(a.b6!=3){if(!(this.music.instruments.getInstrument(a.instrument).gateTimer&64)){a.gate=254;if(!(this.music.instruments.getInstrument(a.instrument).gateTimer&128)){this.c2[this.c9+5+7*r]=this.a4>>8&255;this.c2[this.c9+6+7*r]=this.a4&255}}}}}else{if(a.a2>0){a.a2--;if(a.a2==0){a.gate=254}else{if(a.b6==3){a.newNote=M.values.value2+96}}}else{}}if(a.b6==1||a.b6==2||a.b6==3||a.b6==4||a.b6==14){a.newSpeed=a.a6;a.b0=a.newSpeed>>8;a.a9=a.newSpeed&255;if(a.b6==14){}}}}}else{}if(a.tick==0){}if(a.mute){this.c2[this.c9+4+7*r]=8;this.sid.setWave(this.c9+4)}else{this.c2[this.c9+0+7*r]=a.freq&255;this.c2[this.c9+1+7*r]=a.freq>>8;this.c2[this.c9+2+7*r]=a.pulse&254;this.c2[this.c9+3+7*r]=a.pulse>>8;var D=this.c2[this.c9+4+7*r];if(a.gate==255||a.gate==254){this.c2[this.c9+4+7*r]=a.wave&a.gate}if(D!=this.c2[this.c9+4+7*r]){this.sid.setWave(this.c9+4+7*r)}}}}var E=true;for(var $=0;$<this.channels.length;$++){if(!this.channels[$].finished){E=false}}if(E){this.playheadPosition=0;this.newPlayheadPosition=0;for(var $=0;$<this.channels.length;$++){this.channels[$].a8=0;this.channels[$].patternPosition=0;this.channels[$].finished=false;this.channels[$].tick=this.channels[$].tempo-1}}}};var SidEffectsChooser=function(){this.patternView=null;this.patternId=false;this.uiComponent=null;this.currentEffects=[];this.newEffects=[];this.effectStart=false;this.effectEnd=false;this.paramCanvas=null;this.mouseInBar=false;this.mouseDownInParams=false;this.paramMaxValue=255;this.paramMinValue=0;this.effect=0;this.editingParam=1};SidEffectsChooser.prototype={init:function(e){this.patternView=e;this.music=this.patternView.music},chooseEffect:function(e,t){var i=this;this.effectStart=e;this.effectEnd=t;this.currentEffects=[];this.newEffects=[];this.patternId=this.patternView.getPatternId();for(var r=this.effectStart;r<=this.effectEnd;r++){var a=this.music.patterns.getParamAt(this.patternId,"effects",r);var s=0;var o=0;var l=0;if(a){s=a.values.effect;o=a.values.value1;l=a.values.value2}this.currentEffects.push({effect:s,param:o,param2:l});switch(s){case 4:l=o&255;o=o>>8&255;break;case 5:l=o&15;o=o>>4&15;break;case 6:l=o&15;o=o>>4&15;break;case 11:if(r==this.effectStart){$("#sidEffectFilterChannel_1").prop("checked",(o&1)!=0);$("#sidEffectFilterChannel_2").prop("checked",(o&2)!=0);$("#sidEffectFilterChannel_3").prop("checked",(o&4)!=0)}o=o>>4&255;break}this.newEffects.push({param:o,param2:l})}if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"sidEffectsChooser",title:"Effect",width:640});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/music/sid/sidEffectsChooser.html",function(){i.initContent();i.initEvents();UI.showDialog("sidEffectsChooser")});this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.uiComponent.addButton(this.okButton);this.okButton.on("click",function(e){i.ok()});this.closeButton=UI.create("UI.Button",{text:"Cancel"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){i.cancel()})}else{this.initContent();UI.showDialog("sidEffectsChooser")}},ok:function(){UI.closeDialog()},cancel:function(){UI.closeDialog()},setEffect:function(){this.effect=parseInt($("#sidEffect").val());var e=0;var t=0;this.editingParam=1;switch(this.effect){case 1:case 2:e=parseInt($("#sidEffectPortamentoSpeed").val());this.paramMinValue=0;this.paramMaxValue=65535;this.paramMaxValue=1024;this.editingParam=1;break;case 3:e=parseInt($("#sidEffectPortamentoSpeed").val());t=parseInt($("#sidEffectPortamentoTo").val());this.paramMinValue=0;this.paramMaxValue=92;this.editingParam=2;break;case 4:this.paramMinValue=0;this.paramMaxValue=127;break;case 5:this.paramMinValue=0;this.paramMaxValue=15;var i=parseInt($("#sidEffectAttack").val());var r=parseInt($("#sidEffectDecay").val());e=(i<<4)+r;break;case 6:this.paramMinValue=0;this.paramMaxValue=15;var a=parseInt($("#sidEffectSustain").val());var s=parseInt($("#sidEffectRelease").val());e=(a<<4)+s;break;case 10:e=parseInt($("#sidEffectFilter").val());break;case 16:this.effect=16;e=0;break;case 11:this.paramMinValue=0;this.paramMaxValue=15;e=parseInt($("#sidEffectFilterResonance").val());e=e<<4;if($("#sidEffectFilterChannel_1").is(":checked")){e=e+1}if($("#sidEffectFilterChannel_2").is(":checked")){e=e+2}if($("#sidEffectFilterChannel_3").is(":checked")){e=e+4}break;case 12:this.effect=12;e=parseInt($("#sidEffectFilterCutoff").val());this.editingParam=1;this.paramMinValue=0;this.paramMaxValue=255;break;case 13:this.effect=13;this.paramMinValue=0;this.paramMaxValue=15;break;case 14:this.effect=14;e=parseInt($("#sidEffectTempo1").val())<<8;e+=parseInt($("#sidEffectTempo2").val())&255;break;case 15:this.effect=15;e=parseInt($("#sidEffectTempo").val());break;case 17:this.effect=17;break}this.updatePattern();this.patternView.drawPattern();this.drawParamCanvas()},updatePattern:function(){var e=this.music.patterns.getDuration(this.patternId);for(var t=this.effectStart;t<=this.effectEnd;t++){if(t>=0&&t<e){var i=this.newEffects[t-this.effectStart].param;var r=this.newEffects[t-this.effectStart].param2;switch(this.effect){case 3:i=parseInt($("#sidEffectPortamentoSpeed").val(),10);r=this.newEffects[t-this.effectStart].param2;break;case 4:i=(i<<8)+(r&255);r=0;break;case 5:var a=i;var s=r;i=(a<<4)+s;break;case 6:var o=i;var l=r;i=(o<<4)+l;break;case 10:i=parseInt($("#sidEffectFilter").val());break;case 11:i=i<<4;if($("#sidEffectFilterChannel_1").is(":checked")){i=i+1}if($("#sidEffectFilterChannel_2").is(":checked")){i=i+2}if($("#sidEffectFilterChannel_3").is(":checked")){i=i+4}break;case 14:i=parseInt($("#sidEffectTempo1").val())<<8;i+=parseInt($("#sidEffectTempo2").val())&255;break;case 15:i=parseInt($("#sidEffectTempo").val());break}if(typeof i=="undefined"){i=0}if(typeof r=="undefined"){r=0}this.music.patterns.addParam(this.patternId,"effects",t,{effect:this.effect,value1:i,value2:r})}}},initEvents:function(){var t=this;$("#sidEffect").on("change",function(){var e=$("#sidEffect").val();t.setEffectParamVisible();t.setEffect();UI("sidEffectsChooser").fitContent()});$("input[name=sidEffectVibratoEditParam]").on("click",function(){t.setVibratoEditParam()});$("input[name=sidEffectAttackDecayEditParam]").on("click",function(){t.setAttackDecayEditParam()});$("input[name=sidEffectSustainReleaseEditParam]").on("click",function(){t.setSustainReleaseEditParam()});$("#sidEffectTempo1").on("change",function(){t.updatePattern()});$("#sidEffectTempo2").on("change",function(){t.updatePattern()});$("#sidEffectTempo").on("change",function(){t.updatePattern()});var e=document.getElementById("sidEffectsChooser");e.addEventListener("mousedown",function(e){t.mouseDown(e)},false);e.addEventListener("mousemove",function(e){t.mouseMove(e)},false);e.addEventListener("mouseup",function(e){t.mouseUp(e)},false)},initContent:function(){var e=this;this.drawParamCanvas();this.noteMap=[];for(var t=0;t<92;t++){this.noteMap[t]=""}var i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];var r="";r='<select name="sidEffectPortamentoTo" class="formControl" id="sidEffectPortamentoTo">';for(var t=92;t>=0;t--){var a=t%12;var s=Math.floor(t/12);var o=i[a]+s;this.noteMap[t]=o;r+='<option value="'+t+'" >'+o+"</option>"}r+="</select>";$("#sidEffectPortamentoToControl").html(r);var l="";l='<select id="sidEffectFilter" class="formControl">';var n=1;for(var h=1;h<this.music.doc.data.filters.length;h++){n=h;l+='<option value="'+n+'">'+this.music.doc.data.filters[h].name+"</option>";n+=this.music.doc.data.filters[h].filtertable.length}l+="</select>";$("#sidEffectFilterControl").html(l);$("#sidEffectFilter").on("change",function(){e.updatePattern()});if(this.currentEffects.length==0){return}$("#sidEffect").val(this.currentEffects[0].effect);this.setEffectParamVisible()},setVibratoEditParam:function(){var e=$("input[name=sidEffectVibratoEditParam]:checked").val();if(e=="speed"){$("#sidEffectParamSetVibratoSpeed").hide();$("#sidEffectParamSetVibratoDepth").hide();this.paramMaxValue=127;this.editingParam=1}if(e=="depth"){$("#sidEffectParamSetVibratoSpeed").hide();$("#sidEffectParamSetVibratoDepth").hide();this.paramMaxValue=255;this.editingParam=2}this.drawParamCanvas()},setAttackDecayEditParam:function(){var e=$("input[name=sidEffectAttackDecayEditParam]:checked").val();if(e=="attack"){$("#sidEffectParamAttack").hide();$("#sidEffectParamDecay").hide();this.editingParam=1}if(e=="decay"){$("#sidEffectParamAttack").hide();$("#sidEffectParamDecay").hide();this.editingParam=2}this.drawParamCanvas()},setSustainReleaseEditParam:function(){var e=$("input[name=sidEffectSustainReleaseEditParam]:checked").val();if(e=="sustain"){$("#sidEffectParamSustain").hide();$("#sidEffectParamRelease").hide();this.editingParam=1}if(e=="release"){$("#sidEffectParamSustain").hide();$("#sidEffectParamRelease").hide();this.editingParam=2}this.drawParamCanvas()},setEffectParamVisible:function(){var e=parseInt($("#sidEffect").val());$(".sidEffectParam").hide();$("#sidEffectsParamGraph").hide();switch(e){case 1:case 2:$("#sidEffectsParamGraph").show();break;case 3:$("#sidEffectsParamGraph").show();break;case 4:$("#sidEffectVibrato").show();$("#sidEffectVibratoEditParam_speed").prop("checked",true);$("#sidEffectsParamGraph").show();this.setVibratoEditParam();break;case 5:$("#sidEffectAttackDecay").show();$("#sidEffectAttackDecayEditParam_attack").prop("checked",true);$("#sidEffectsParamGraph").show();this.setAttackDecayEditParam();break;case 6:$("#sidEffectSustainRelease").show();$("#sidEffectSustainReleaseEditParam_sustain").prop("checked",true);$("#sidEffectsParamGraph").show();this.setSustainReleaseEditParam();break;case 10:$("#sidEffectParamFilter").show();break;case 11:$("#sidEffectParamFilterResonance").show();$("#sidEffectParamFilterChannels").show();$("#sidEffectsParamGraph").show();break;case 12:$("#sidEffectsParamGraph").show();break;case 13:$("#sidEffectsParamGraph").show();break;case 14:$("#sidEffectParamTempo1").show();$("#sidEffectParamTempo2").show();break;case 15:$("#sidEffectParamTempo").show();break;case 17:break}},setParamValueFromMouse:function(){var e=this.paramMaxValue;var t=this.paramCanvas.height;var i=Math.ceil((t-this.mouseBarY)/t*e);if(this.editingParam==1){this.newEffects[this.mouseInBar].param=i}else{this.newEffects[this.mouseInBar].param2=i}this.updatePattern();this.drawParamCanvas();this.updateEffectParamInfo()},mouseDown:function(e){var t=e.clientX;var i=e.clientY;var r=$("#sidEffectParamCanvas").offset();if(t>=r.left&&t<r.left+this.paramCanvas.width&&i>=r.top&&i<r.top+this.paramCanvas.height){this.setParamValueFromMouse();this.mouseDownInParams=true}},updateEffectParamInfo:function(){var e="";var t=this.mouseInBar;var i=this.effectEnd-this.effectStart+1;if(this.mouseInBar!==false&&this.mouseInBar<i){var r=this.effectStart+this.mouseInBar;e+="<div>";e+="Position: "+r;e+="</div>";var a=0;if(this.editingParam==1){a=this.newEffects[this.mouseInBar].param}else{a=this.newEffects[this.mouseInBar].param2}if(typeof a=="undefined"){a=""}else{a=parseInt(a,10);if(isNaN(a)){a=""}else{if(this.effect==3){if(a>=0&&a<=this.noteMap.length){a=this.noteMap[a]}}}}e+="<div>";e+="Value:"+a;e+="</div>"}else{e=""}$("#sidEffectsParamGraphInfo").html(e)},drawParamCanvas:function(){if(this.paramCanvas==null){this.paramCanvas=document.getElementById("sidEffectParamCanvas");this.paramContext=this.paramCanvas.getContext("2d")}this.paramContext.fillStyle="#000000";this.paramContext.fillRect(0,0,this.paramCanvas.width,this.paramCanvas.height);var e=this.paramCanvas.width;var t=this.paramCanvas.height;var i=this.effectEnd-this.effectStart+1;this.barHolderWidth=e/i;this.barGap=2;var r=t;for(var a=0;a<i;a++){var s=a*this.barHolderWidth+this.barGap;var o=this.paramMaxValue;var l=0;if(this.editingParam==1){l=this.newEffects[a].param}else{l=this.newEffects[a].param2}var n=r*l/o;var h=100;if(a===this.mouseInBar){this.paramContext.beginPath();this.paramContext.strokeStyle=styles.music.oscilloscopeLines;this.paramContext.lineWidth=1;this.paramContext.moveTo(s,this.mouseBarY+.5);this.paramContext.lineTo(s+this.barHolderWidth-2*this.barGap,this.mouseBarY+.5);this.paramContext.stroke();this.paramContext.fillStyle="#eeeeee"}else{this.paramContext.fillStyle="#aaaaaa"}this.paramContext.fillRect(s,t-n,this.barHolderWidth-2*this.barGap,n)}},mouseMove:function(e){var t=e.clientX;var i=e.clientY;var r=$("#sidEffectParamCanvas").offset();if(t>=r.left&&t<r.left+this.paramCanvas.width&&i>=r.top&&i<r.top+this.paramCanvas.height){var a=t-r.left;var s=this.paramCanvas.height-(i-r.top);var o=Math.floor(a/this.barHolderWidth);if(o!=this.mouseInBar||this.mouseBarY!=i-r.top){this.mouseInBar=o;this.mouseBarY=i-r.top;this.updateEffectParamInfo();if(this.mouseDownInParams){this.setParamValueFromMouse()}else{this.drawParamCanvas()}}}},mouseUp:function(e){this.mouseDownInParams=false}};function LightenDarkenColor(e,t){var i=(e>>16)+t;if(i>255)i=255;else if(i<0)i=0;var r=(e>>8&255)+t;if(r>255)r=255;else if(r<0)r=0;var a=(e&255)+t;if(a>255)a=255;else if(a<0)a=0;return a|r<<8|i<<16}var C64Instruments=function(){this.music=null;this.currentInstrumentId=1;this.colorIndex=0;this.recentInstruments=[5,4,3,2,1];this.defaultColors=[16772045,255,9055202,10824234,14596231,6266528,8388352,13789470,16744272,6591981,16775388,14423100,65535,139,35723,12092939,11119017,25600,12433259,9109643,5597999,16747520,10040012,9109504,15308410,9419919,4734347,3100495,52945,9699539,16716947,49151,6908265,2003199,11674146,16775920,2263842,16711935,14474460,16316671,16766720,14329120,8421504,32768,11403055,15794160,16738740,13458524,4915330,16777200,15787660,15132410,15792383,16444375,65535,8388564,15794175,16119260,16770244]};C64Instruments.prototype={init:function(e){this.music=e},buildInterface:function(e){var t='<div id="sidInstruments" class="panelFill" style="background-color: #444444;">';t+='<h4 style="margin-left: 10px; margin-bottom: 4px; margin-top: 6px">Instruments</h4>';t+='<div id="instrumentsHolder" style="background-color: #333333; margin: 10px; position: absolute; top: 14px; bottom: 24px; left:0; right: 0px; overflow-y: auto; overflow-x: hidden"></div>';t+='  <div style="position: absolute; bottom: 6px" class="instrumentButtons">';t+='    <button type="button" id="editInstrumentButton">Edit</button>';t+='    <button type="button" id="addInstrumentButton">Add</button>';t+='    <button type="button" id="duplicateInstrumentButton">Duplicate</button>';t+='    <button type="button" id="deleteInstrumentButton">Delete</button>';t+="  </div>";t+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{html:t});e.add(this.uiComponent);this.initEvents()},initEvents:function(){var e=this;$("#editInstrumentButton").on("click",function(){e.music.setView("editInstrument");e.music.editInstrument.editInstrument(parseInt(e.currentInstrumentId))});$("#addInstrumentButton").on("click",function(){e.music.setView("editInstrument");e.music.editInstrument.newInstrument()});$("#deleteInstrumentButton").on("click",function(){e.deleteInstrument(parseInt(e.currentInstrumentId))});$("#duplicateInstrumentButton").on("click",function(){e.duplicateInstrument(parseInt(e.currentInstrumentId))})},getJSON:function(){},clearInstruments:function(){this.music.doc.data.instruments=[]},getInstrument:function(e){return this.music.doc.data.instruments[e]},getColor:function(e){return this.music.doc.data.instruments[e].color},getHighlightColor:function(e){if(typeof this.music.doc.data.instruments[e].highlightColor=="undefined"){this.music.doc.data.instruments[e].highlightColor=LightenDarkenColor(this.music.doc.data.instruments[e].color,20)}return this.music.doc.data.instruments[e].highlightColor},getBorderColor:function(e){if(typeof this.music.doc.data.instruments[e].borderColor=="undefined"){this.music.doc.data.instruments[e].borderColor=LightenDarkenColor(this.music.doc.data.instruments[e].color,-20)}return this.music.doc.data.instruments[e].borderColor},selectDefaultInstrument:function(){this.selectInstrument(this.defaultInstrument,false)},selectInstrument:function(e,t){var i=false;for(var r=0;r<this.recentInstruments.length;r++){if(this.recentInstruments[r]==e){i=true;break}}if(!i){this.recentInstruments.push(e);if(this.recentInstruments.length>8){this.recentInstruments.shift()}}this.currentInstrumentId=parseInt(e);$(".instrument").removeClass("selectedInstrument");var a="instrument"+this.currentInstrumentId;$("#"+a).addClass("selectedInstrument");if(this.music&&this.music.musicPlayer2&&(typeof t=="undefined"||t)){var s=48;var o=0;if(typeof this.music.patternView.channel!="undefined"){o=this.music.patternView.channel}this.music.musicPlayer2.playTestInstrument(s,this.music.doc.data.instruments[this.currentInstrumentId]);var l=this;setTimeout(function(){l.music.musicPlayer2.stopTestInstrument()},600)}},mouseWheel:function(e,t){},mouseDown:function(e,t){},mouseMove:function(e,t){t=window.innerHeight-t-1},mouseUp:function(e,t){},updateInstrumentHTML:function(){var t=this;var e="";for(var i=1;i<this.music.doc.data.instruments.length;i++){var r=i;e+='<div class="instrument" id="instrument'+r+'">';var a="#"+((1<<24)+this.music.doc.data.instruments[i].color).toString(16).slice(1);e+='<div style="margin-top: 2px; margin-right: 4px; display: inline-block; width: 12px; height: 12px; background-color: '+a+'"></div>';e+='<span style="margin-bottom: 2px" id="instrumentName'+r+'">';e+=this.music.doc.data.instruments[i].name;e+="</span>";e+="</div>"}$("#instrumentsHolder").html(e);$(".instrument").on("click",function(){var e=$(this).attr("id");e=e.replace("instrument","");t.selectInstrument(e,true)});this.defaultInstrument=10;if(this.music.doc.data.instruments.length<10){this.defaultInstrument=1}this.selectInstrument(this.defaultInstrument,false)},createInstrument:function(e){var t=this.music.doc.data.instruments.length;this.music.doc.data.instruments.push(e);return t},createMinimalInstruments:function(){var e={name:"instrument 0",color:0,attack:0,decay:0,sustain:0,release:0,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:0,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:0,firstWave:0,wavetable:[],pulsetable:[],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"C64 Lead",type:"advanced",color:5583735,attack:2,decay:0,sustain:5,release:5,vibratoSpeed:1,vibratoDepth:24,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[65,0],[255,0]],pulsetable:[[128,16],[32,64],[64,224],[64,32],[255,3]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);for(var t=0;t<this.music.doc.data.instruments.length;t++){if(t<this.defaultColors.length){this.music.doc.data.instruments[t].color=this.defaultColors[this.colorIndex++]}}this.updateInstruments()},createDefaultInstruments:function(){this.music.doc.data.instruments=[];this.colorIndex=0;var e={name:"instrument 0",color:0,attack:0,decay:0,sustain:0,release:0,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:0,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:0,firstWave:0,wavetable:[],pulsetable:[],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Snare",type:"drum",color:5583735,attack:0,decay:2,sustain:8,release:8,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[129,208],[65,170],[65,164],[128,212],[128,209],[255,0]],pulsetable:[[136,0],[255,0]],filtertable:[],speedtable:[],drumType:"snare",drumWaveform:64};this.music.doc.data.instruments.push(e);var e={name:"Tomdrum",type:"drum",color:5583735,attack:0,decay:2,sustain:8,release:8,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[129,200],[65,0],[65,127],[64,126],[64,125],[0,124],[0,123],[0,122],[0,121],[0,120],[0,119],[0,118],[0,117],[255,0]],pulsetable:[[136,0],[255,0]],filtertable:[],speedtable:[],drumType:"tom",drumWaveform:64};this.music.doc.data.instruments.push(e);var e={name:"Kick Drum",type:"drum",color:5583735,attack:0,decay:0,sustain:10,release:8,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[129,216],[17,166],[17,160],[16,152],[0,148],[255,0]],pulsetable:[[136,0],[24,64],[8,192],[8,64],[255,0]],filtertable:[],speedtable:[],drumType:"bass",drumWaveform:16};this.music.doc.data.instruments.push(e);var e={name:"Hihat open",type:"drum",color:5583735,attack:0,decay:0,sustain:8,release:9,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[129,222],[128,220],[255,0]],pulsetable:[[136,0],[24,64],[8,192],[8,64],[255,0]],filtertable:[],speedtable:[],drumType:"hihat",drumWaveform:0};this.music.doc.data.instruments.push(e);var e={name:"Hihat closed",type:"drum",color:5583735,attack:0,decay:0,sustain:4,release:2,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[129,222],[128,220],[255,0]],pulsetable:[[136,0],[24,64],[8,192],[8,64],[255,0]],filtertable:[],speedtable:[],drumType:"hihat",drumWaveform:0};this.music.doc.data.instruments.push(e);var e={name:"Rim Click",type:"advanced",color:5583735,attack:0,decay:2,sustain:1,release:8,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[129,0],[128,0],[255,0]],pulsetable:[],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Clap",type:"advanced",color:5583735,attack:0,decay:0,sustain:11,release:5,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[129,200],[65,155],[129,200],[128,184],[255,0]],pulsetable:[[136,0],[255,0]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Bongo",type:"advanced",color:5583735,attack:0,decay:3,sustain:7,release:4,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:1,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[113,158],[17,0],[2,0],[16,0],[255,0]],pulsetable:[[136,0],[255,0]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Woodblock",type:"advanced",color:5583735,attack:0,decay:0,sustain:0,release:3,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:1,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[17,205],[16,202],[255,0]],pulsetable:[],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Square Wave",type:"basic",color:16711680,attack:0,decay:0,sustain:6,release:9,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[65,0],[255,0]],pulsetable:[[137,153],[255,0]],filtertable:[],speedtable:[],basicWaveform:64,basicEffect:"none",pulseWidth:50,pulseModulationSpeed:0,pulseModulationDepth:0};this.music.doc.data.instruments.push(e);var e={name:"Electric Piano",type:"advanced",color:5583735,attack:0,decay:0,sustain:6,release:8,vibratoSpeed:1,vibratoDepth:11,vibratoDelay:0,wavePtr:1,pulsePtr:1,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[17,0],[81,0],[255,0]],pulsetable:[[132,0],[255,0]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Electric Guitar",type:"advanced",color:5583735,attack:0,decay:0,sustain:6,release:6,vibratoSpeed:4,vibratoDepth:6,vibratoDelay:0,wavePtr:1,pulsePtr:1,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[33,0],[1,0],[65,0],[255,0]],pulsetable:[[134,0],[255,0]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Bass (filtered on ch1)",type:"advanced",color:16711680,attack:2,decay:0,sustain:6,release:9,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:1,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[65,0],[255,0]],pulsetable:[[137,153],[255,0]],filtertable:[[144,241],[0,12],[2,1],[255,0]],speedtable:[],basicWaveform:64,basicEffect:"none",pulseWidth:60,pulseModulationSpeed:0,pulseModulationDepth:0};this.music.doc.data.instruments.push(e);var e={name:"Flute",type:"advanced",color:5583735,attack:8,decay:10,sustain:8,release:9,vibratoSpeed:1,vibratoDepth:12,vibratoDelay:1,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[65,0],[17,0],[255,0]],pulsetable:[[136,0],[255,0]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"C64 Lead",type:"advanced",color:5583735,attack:2,decay:0,sustain:5,release:5,vibratoSpeed:1,vibratoDepth:24,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[65,0],[255,0]],pulsetable:[[128,16],[32,64],[64,224],[64,32],[255,3]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Major Arp",type:"basic",color:65280,attack:11,decay:9,sustain:4,release:6,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[65,0],[1,123],[1,120],[1,0],[255,2]],pulsetable:[[130,102],[255,0]],filtertable:[],speedtable:[],basicWaveform:64,basicEffect:"arpeggio",pulseWidth:15,pulseModulationSpeed:0,pulseModulationDepth:0,arpeggioSpeed:1,arpeggioType:"major",arpeggioDirection:"up"};this.music.doc.data.instruments.push(e);var e={name:"instrument 3",type:"basic",color:65280,attack:11,decay:9,sustain:8,release:12,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[17,0],[255,0]],pulsetable:[[136,0],[255,0]],filtertable:[],speedtable:[],basicWaveform:16,pulseWidth:0,pulseModulationSpeed:0,pulseModulationDepth:0,arpeggioSpeed:0,arpeggioType:"none",arpeggioDirection:"up"};this.music.doc.data.instruments.push(e);var e={name:"instrument 4",type:"advanced",color:255,attack:0,decay:9,sustain:0,release:9,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[129,0],[0,12],[0,108],[255,1]],pulsetable:[],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"instrument 5",type:"advanced",attack:0,decay:8,sustain:5,release:0,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[65,0],[0,12],[0,108],[255,0]],pulsetable:[[136,0],[255,0]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"instrument 6",type:"advanced",attack:9,decay:0,sustain:15,release:0,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[65,127],[2,126],[2,125],[2,124],[2,123],[50,122],[2,0],[255,0]],pulsetable:[[136,0],[255,0]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"instrument 7",type:"advanced",attack:0,decay:6,sustain:0,release:10,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[129,0],[129,0],[65,127],[11,126],[11,125],[11,124],[255,0]],pulsetable:[[136,0],[255,0]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"instrument 8",type:"advanced",attack:0,decay:7,sustain:7,release:0,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:1,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[17,0],[255,0]],pulsetable:[],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Tremolo",type:"advanced",attack:10,decay:0,sustain:13,release:3,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:7,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[17,0],[1,128],[16,128],[1,128],[17,128],[255,2]],pulsetable:[],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Solo",type:"advanced",attack:0,decay:3,sustain:9,release:0,vibratoSpeed:1,vibratoDepth:7,vibratoDelay:1,wavePtr:7,pulsePtr:0,filtPtr:0,vibParam:7,c3:1,gateTimer:2,firstWave:9,wavetable:[[23,0],[255,0]],pulsetable:[],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Chord",type:"advanced",attack:14,decay:5,sustain:4,release:14,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:7,pulsePtr:0,filtPtr:0,vibParam:0,c3:0,gateTimer:2,firstWave:9,wavetable:[[65,0],[65,0],[65,0],[65,0],[65,7],[65,7],[65,7],[65,7],[65,12],[65,12],[65,12],[65,12],[65,7],[65,7],[65,7],[65,7],[255,1]],pulsetable:[[132,0],[32,32],[32,224],[255,1]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Solo",type:"advanced",attack:0,decay:0,sustain:8,release:9,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:7,pulsePtr:0,filtPtr:0,vibParam:7,c3:1,gateTimer:2,firstWave:9,wavetable:[[65,0],[255,0]],pulsetable:[[132,0],[24,80],[24,176],[255,1]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Bass",type:"advanced",attack:0,decay:0,sustain:15,release:8,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:7,pulsePtr:0,filtPtr:0,vibParam:7,c3:1,gateTimer:2,firstWave:9,wavetable:[[65,0],[65,0],[64,0],[255,0]],pulsetable:[[128,48],[32,80],[255,0]],filtertable:[[144,243],[0,47],[10,255],[128,0],[255,0]],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Kick",type:"advanced",attack:0,decay:0,sustain:15,release:10,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:7,pulsePtr:0,filtPtr:0,vibParam:7,c3:1,gateTimer:2,firstWave:9,wavetable:[[129,223],[17,170],[17,167],[17,165],[16,160],[16,155],[16,146],[255,0]],pulsetable:[],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);var e={name:"Glass",type:"advanced",attack:0,decay:0,sustain:6,release:6,vibratoSpeed:0,vibratoDepth:0,vibratoDelay:0,wavePtr:7,pulsePtr:0,filtPtr:0,vibParam:7,c3:1,gateTimer:2,firstWave:9,wavetable:[[129,218],[64,12],[16,0],[255,0]],pulsetable:[[136,0],[1,64],[255,2]],filtertable:[],speedtable:[]};this.music.doc.data.instruments.push(e);for(var t=0;t<this.music.doc.data.instruments.length;t++){if(t<this.defaultColors.length){this.music.doc.data.instruments[t].color=this.defaultColors[this.colorIndex++]}}this.updateInstruments()},duplicateInstrument:function(e){var t={};for(var i in this.music.doc.data.instruments[e]){if(i=="wavetable"||i=="filtertable"||i=="pulsetable"||i=="speedtable"){t[i]=[];for(var r=0;r<this.music.doc.data.instruments[e][i].length;r++){t[i].push([this.music.doc.data.instruments[e][i][r][0],this.music.doc.data.instruments[e][i][r][1]])}}else{t[i]=this.music.doc.data.instruments[e][i]}}t.color=this.defaultColors[this.colorIndex];this.colorIndex=(this.colorIndex+1)%this.defaultColors.length;var a=e+1;t.name+=" Copy";this.music.doc.data.instruments.splice(a,0,t);console.error(" fix duplicate instrument");for(var r=0;r<this.music.doc.data.patterns.length;r++){this.music.doc.data.patterns[r].shiftInstrumentsAbove(e,1)}this.updateInstruments();this.music.sidPlayer.testInstrumentSetup();this.music.patternView.drawPattern();this.selectInstrument(a,false)},deleteInstrument:function(e){console.error("fix delete instrument");var t=this.music.patterns.instrumentUsed(e);if(t){if(!confirm("This instrument is being used, are you sure you want to delete it?")){return}this.music.patterns.removeInstrumentFromAllPatterns(e)}this.music.doc.data.instruments.splice(e,1);for(var i=0;i<this.music.doc.data.patterns.length;i++){this.music.doc.data.patterns[i].shiftInstrumentsAbove(e)}if(this.music.doc.data.instruments.length==1){this.music.doc.data.instruments=[];this.createMinimalInstruments()}this.updateInstruments();this.music.sidPlayer.testInstrumentSetup();this.music.updateSid(true);this.music.patternView.drawPattern();this.music.patternView.updatePattern()},updateInstruments:function(){for(var e=0;e<this.music.doc.data.instruments.length;e++){if(typeof this.music.doc.data.instruments[e].color=="undefined"){if(e<this.defaultColors.length){this.music.doc.data.instruments[e].color=this.defaultColors[this.colorIndex];this.colorIndex=(this.colorIndex+1)%this.defaultColors.length}}}this.updateInstrumentHTML()}};var EditC64Instrument=function(){this.music=null;this.wavetable=[];this.pulsetable=[];this.speedtable=[];this.filtertable=[];this.keyboardCanvas=null;this.keyboardContext=null;this.whiteKeyWidth=20;this.blackKeyWidth=10;this.keyboardOctave=5;this.keyboardNote=5;this.whiteKey=false;this.playingInstrument=false;this.instrumentId=-1;this.arpeggioSteps=2};EditC64Instrument.prototype={init:function(e){this.music=e},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.HTMLPanel");e.add(this.uiComponent);UI.on("ready",function(){t.uiComponent.load("html/music/sid/editInstrument.html",function(){t.initContent();t.initEvents()})})},initContent:function(){this.keyboard=new KeyboardCanvas;this.keyboard.init("editInstrumentKeyboard")},initEvents:function(){var i=this;this.keyboard.on("keydown",function(e,t){i.editInstrumentPlay(e,t)});this.keyboard.on("keyup",function(){i.music.musicPlayer2.stopTestInstrument();i.playingInstrument=false});$("input[name=editInstrumentArpeggioMode]").on("change",function(){i.setInstrumentData()});$("input[name=editInstrumentArpeggioSteps]").on("change",function(){i.setInstrumentData();var e=$("input[name=editInstrumentArpeggioSteps]:checked").val();i.setArpeggioSteps(e)});$("input[name=editInstrumentType]").on("click",function(){var e=$(this).val();i.setInstrumentType(e);i.setInstrumentData()});$("#editInstrumentAttack").on("change",function(){i.setInstrumentData()});$("#editInstrumentDecay").on("change",function(){i.setInstrumentData()});$("#editInstrumentSustain").on("change",function(){i.setInstrumentData()});$("#editInstrumentRelease").on("change",function(){i.setInstrumentData()});$("input[name=vibrato]").on("click",function(){var e=$(this).val();if(e=="on"){$("#vibratoControls").show()}else{$("#vibratoControls").hide()}i.setInstrumentData()});$("#editInstrumentVibratoDepth").on("change",function(){i.setInstrumentData()});$("#editInstrumentVibratoDepth").on("keyup",function(){i.setInstrumentData()});$("#editInstrumentVibratoSpeed").on("change",function(){i.setInstrumentData()});$("#editInstrumentVibratoSpeed").on("keyup",function(){i.setInstrumentData()});$("#editInstrumentVibratoDelay").on("change",function(){i.setInstrumentData()});$("#editInstrumentVibratoDelay").on("keyup",function(){i.setInstrumentData()});$("#editInstrumentWaveform_triangle").on("click",function(){i.setInstrumentData()});$("#editInstrumentWaveform_sawtooth").on("click",function(){i.setInstrumentData()});$("#editInstrumentWaveform_pulse").on("click",function(){i.setInstrumentData()});$("#editInstrumentWaveform_noise").on("click",function(){i.setInstrumentData()});$("#editInstrumentWaveform_pulse").on("click",function(){if($(this).is(":checked")){$("#pulseControls").show()}else{$("#pulseControls").hide()}i.setInstrumentData()});$("#editInstrumentPMWidth").on("change",function(){i.setInstrumentData()});$("#editInstrumentPMWidth").on("keyup",function(){i.setInstrumentData()});$("#editInstrumentPMSpeed").on("change",function(){i.setInstrumentData()});$("#editInstrumentPMSpeed").on("keyup",function(){i.setInstrumentData()});$("#editInstrumentPMDepth").on("change",function(){i.setInstrumentData()});$("#editInstrumentPMDepth").on("keyup",function(){i.setInstrumentData()});$("#editInstrumentTremoloOnSpeed").on("change",function(){i.setInstrumentData()});$("#editInstrumentTremoloOffSpeed").on("change",function(){i.setInstrumentData()});$('input[name="editInstrumentBasicEffect"]').on("click",function(){i.setBasicEffectVisibility();i.setInstrumentData()});$("#editInstrumentArpeggioSpeed").on("change",function(){i.setInstrumentData()});$("#wavetableTab").on("click",function(){i.showTable("wavetable")});$("#pulsetableTab").on("click",function(){i.showTable("pulsetable")});$("#filtertableTab").on("click",function(){i.showTable("filtertable")});$("#editInstrumentOK").on("click",function(){i.setInstrumentData();i.backToMusicEditor()});$("#editInstrumentApply").on("click",function(){i.setInstrumentData()});$("#editInstrumentCancel").on("click",function(){i.music.doc.data.instruments[i.instrumentId]=i.instrumentSave;i.backToMusicEditor()})},backToMusicEditor:function(){this.music.setView("edit");this.music.resize()},mouseWheel:function(e,t){var i=$("#editInstrumentHolder").scrollTop();var r=e.deltaFactor;$("#editInstrumentHolder").scrollTop(i-e.deltaY*r)},filtertableHTML:function(){var e="";var t="";var i="";var r=0;if(this.filtertable.length>0){r=this.filtertable[this.filtertable.length-1][1];if(r==0){r=this.filtertable.length}}e+='<table width="100%">';e+="<thead>";e+="<tr>";e+="<th>Loop&nbsp;To</th>";e+="<th>Action</th>";e+="<th>Parameters</th>";e+="<th>&nbsp;</th>";e+="</tr>";e+="</thead>";e+="<tbody>";if(this.filtertable.length<=1){e+="<tr>";e+='<td colspan="4">';e+='<button type="button" class="filtertableAdd" id="row_add">Add Row</button>';e+="</td>";e+="</tr>"}for(var a=0;a<this.filtertable.length;a++){var s=this.filtertable[a][0];var o=this.filtertable[a][1];e+="<tr>";e+="<td>";var t="";if(r==a+1){t=' checked="checked" '}e+='<input type="radio" name="filtertableLoop" id="row'+a+'_filtertableLoop" value="'+a+'" '+t+">";e+="</td>";if(a==this.filtertable.length-1){e+='<td colspan="3">&nbsp;</td>'}else{e+="<td>";e+='<select id="row'+a+'_filterrowtype" class="filtertableRowType">';i="";if(this.filtertable[a][0]==0){i=' selected="selected" '}e+='<option value="cutoff" '+i+">Set Cutoff</option>";i="";if(this.filtertable[a][0]>=1&&this.filtertable[a][0]<=127){i=' selected="selected" '}e+='<option value="modulate" '+i+">Modulate Filter</option>";i="";if(this.filtertable[a][0]>=128&&this.filtertable[a][0]<=240){i=' selected="selected" '}e+='<option value="filter" '+i+">Set Filter</option>";e+="</select>";e+="</td>";e+="<td>";e+='<span id="row'+a+'_filtercutoffParams" ';if(s!=0){e+=' style="display:none" '}e+=">";var l=o;e+="<label>Cutoff :</label>";e+='<input id="row'+a+'_filtercutoff" class="number editInstrumentFilterCutoff" min="0" max="255" size="4" value="'+l+'"> (0-255)';e+="</span>";e+='<span id="row'+a+'_filtermodulateParams" ';if(s<1||s>127){e+='style="display:none" '}e+=">";var n=s;e+="<label>Modulate for: </label>";e+='<input id="row'+a+'_filtertime" class="number editInstrumentFilterTime" min="0" max="127" size="4" value="'+n+'"> Ticks (0-127)';var h=o;if(h>127){h=h-256}if(h>127){h=127}e+="&nbsp;&nbsp;";e+="<label>Amount :</label>";e+='<input id="row'+a+'_filterspeed" size="4" class="number editInstrumentFilterSpeed" min="-127" max="127" value="'+h+'"> / Tick (-127 - 127)';e+="</span>";e+='<span id="row'+a+'_filterParams" ';if(s<=127){e+=' style="display:none" '}e+=">";e+='<label><input type="checkbox" id="row'+a+'_filtertypelow" value="low" class="editInstrumentFilterChannel" ';if(s&16){e+=' checked="checked" '}e+="> Lowpass</label>";e+='<label><input type="checkbox" id="row'+a+'_filtertypeband" value="band" class="editInstrumentFilterChannel" ';if(s&32){e+=' checked="checked" '}e+="> Bandpass</label>";e+='<label><input type="checkbox" id="row'+a+'_filtertypehigh" value="high" class="editInstrumentFilterChannel" ';if(s&64){e+=' checked="checked" '}e+="> Highpass</label>";var d=(o&240)>>4;var c=o&15;e+="  <label>Resonance :</label>";e+='<input id="row'+a+'_resonance" class="number editInstrumentFilterResonance" min="0" max="15" size="4" value="'+d+'"> (0-15)';e+='<label><input type="checkbox" id="row'+a+'_channel1" class="editInstrumentFilterChannel" ';if(c&1){e+=' checked="checked" '}e+="> Channel 1</label>&nbsp;";e+='<label><input type="checkbox" id="row'+a+'_channel2" class="editInstrumentFilterChannel" ';if(c&2){e+=' checked="checked" '}e+="> Channel 2</label>&nbsp;";e+='<label><input type="checkbox" id="row'+a+'_channel3" class="editInstrumentFilterChannel" ';if(c&4){e+=' checked="checked" '}e+="> Channel 3</label>";e+="</span>";e+="</td>";e+="<td>";e+='<button type="button" class="filtertableAdd" id="row'+a+'_add">Add Row</button>';e+='<button type="button" class="filtertableDelete" id="row'+a+'_delete">Delete Row</button>';e+="</td>"}e+="</tr>"}e+="</tbody>";e+="</table>";$("#editFiltertable").html("");$("#editInstrumentFiltertable").html(e);UI.number.initControls("#editInstrumentFiltertable .number");this.setupFiltertableEvents()},setupFiltertableEvents:function(){var a=this;$(".filtertableRowType").on("change",function(){var e=$(this).attr("id");var t=$(this).val();var i=e.indexOf("_");var r=e.substr(0,i);if(t=="cutoff"){$("#"+r+"_filtercutoffParams").show();$("#"+r+"_filtermodulateParams").hide();$("#"+r+"_filterParams").hide()}else if(t=="modulate"){$("#"+r+"_filtercutoffParams").hide();$("#"+r+"_filtermodulateParams").show();$("#"+r+"_filterParams").hide()}else if(t=="filter"){$("#"+r+"_filtercutoffParams").hide();$("#"+r+"_filtermodulateParams").hide();$("#"+r+"_filterParams").show()}a.setInstrumentData()});$(".editInstrumentFilterType").on("click",function(){a.setInstrumentData()});$(".editInstrumentFilterChannel").on("click",function(){a.setInstrumentData()});$(".editInstrumentFilterResonance").on("keyup",function(){a.setInstrumentData()});$(".editInstrumentFilterResonance").on("change",function(){a.setInstrumentData()});$(".editInstrumentFilterCutoff").on("keyup",function(){a.setInstrumentData()});$(".editInstrumentFilterCutoff").on("change",function(){a.setInstrumentData()});$(".editInstrumentFilterSpeed").on("keyup",function(){a.setInstrumentData()});$(".editInstrumentFilterSpeed").on("change",function(){a.setInstrumentData()});$(".editInstrumentFilterTime").on("keyup",function(){a.setInstrumentData()});$(".editInstrumentFilterTime").on("change",function(){a.setInstrumentData()});$(".filtertableAdd").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=-1;if(t>3){i=parseInt(e.substr(3))}a.writeFiltertable();if(a.filtertable.length==0){a.filtertable.push([144,247]);a.filtertable.push([255,0])}else{a.filtertable.splice(i+1,0,[0,0])}a.filtertableHTML();a.setInstrumentData()});$(".filtertableDelete").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(3));a.writeFiltertable();a.filtertable.splice(r,1);a.filtertableHTML();a.setInstrumentData()})},writeFiltertable:function(){var e=this.filtertable.length;this.filtertable=[];for(var t=0;t<e-1;t++){var i=0;var r=0;var a=$("#row"+t+"_filterrowtype").val();if(a=="cutoff"){i=0;r=$("#row"+t+"_filtercutoff").val()}else if(a=="modulate"){i=$("#row"+t+"_filtertime").val();if(i<0){i=1}if(i>127){i=127}speed=parseInt($("#row"+t+"_filterspeed").val());r=speed;if(r<0){r=256+speed}}else if(a=="filter"){i=128;if($("#row"+t+"_filtertypelow").is(":checked")){i=i|16}if($("#row"+t+"_filtertypeband").is(":checked")){i=i|32}if($("#row"+t+"_filtertypehigh").is(":checked")){i=i|64}var s=parseInt($("#row"+t+"_resonance").val());var o=0;if($("#row"+t+"_channel1").is(":checked")){o|=1}if($("#row"+t+"_channel2").is(":checked")){o|=2}if($("#row"+t+"_channel3").is(":checked")){o|=4}r=s<<4|o}this.filtertable.push([parseInt(i),parseInt(r)])}if(this.filtertable.length==0){return}var l=parseInt($("input[name=filtertableLoop]:checked").val());if(l==this.filtertable.length){l=0}else{l+=1}if(isNaN(l)){l=0}this.filtertable.push([255,l]);if(this.filtertable.length==1){this.filtertable=[]}this.logTable("filtertable",this.filtertable)},pulsetableHTML:function(){var e="";e+='<table width="100%"">';e+="<thead>";e+="<tr>";e+="<th>Loop&nbsp;To</th>";e+="<th>Action</th>";e+="<th>Parameters</th>";e+="<th>&nbsp;</th>";e+="</tr>";e+="</thead>";e+="<tbody>";var t=0;if(this.pulsetable.length>0){t=this.pulsetable[this.pulsetable.length-1][1];if(t==0){t=this.pulsetable.length}}for(var i=0;i<this.pulsetable.length;i++){var r=this.pulsetable[i][0];var a=this.pulsetable[i][1];e+="<tr>";if(this.pulsetable.length<=1){e+='<td colspan="5">';e+='<button type="button" class="pulsetableAdd" id="row'+i+'_pulsetableAdd">Add Row</button>';e+="</td>"}else{var s="";if(i+1==t){s=' checked="checked" '}e+="<td>";e+='<input type="radio" name="pulsetableLoop" id="row'+i+'_pulsetableLoop" value="'+i+'" '+s+">";e+="</td>";if(i<this.pulsetable.length-1){e+="<td>";e+='<select class="pulsetableType" id="row'+i+'_pulseTableType">';selected="";if(r<=127){selected=' selected="selected" '}e+='<option value="stepPulse" '+selected+">Step Pulse Modulation</option>";selected="";if(r>127){selected=' selected="selected" '}e+='<option value="setPulse" '+selected+">Set Pulse Width</option>";e+="</select>";e+="</td>";e+="<td>";e+='<span id="row'+i+'_stepPulseValues"';if(r>127){e+=' style="display: none"'}e+=">";e+="Time:";var o=r;if(o>127){o=127}e+='<input id="row'+i+'_pulsetableTime" class="editInstrumentPulsetableTime" size="4" class="number" min="0" max="127" value="'+o+'"> (1-127)';e+="Speed:";var l=a;if(l>127){l=l-256}if(l>127){l=127}e+='<input id="row'+i+'_pulsetableSpeed" class="editInstrumentPulsetableSpeed" class="" size="4" class="number" min="-127" max="127" value="'+l+'"> (-127 - +127)';e+="</span>";e+='<span id="row'+i+'_setPulseValues"';if(r<=127){e+=' style="display: none"'}e+=">";pulseWidth=(r&15)*256;pulseWidth+=a;e+='Width: <input class="editInstrumentPulseWidth" id="row'+i+'_pulseWidth" class="number" min="0" max="4095" size="6" value="'+pulseWidth+'"> (0-4095)';e+="</span>";e+="</td>";e+="<td>";e+='<button type="button" class="pulsetableAdd" id="row'+i+'_pulsetableAdd">Add Row</button>';e+='<button type="button" class="pulsetableDelete" id="row'+i+'_pulsetableDelete">Delete Row</button>';e+="</td>"}else{e+='<td colspan="3">&nbsp;</td>'}}e+="</tr>"}e+="</tbody>";e+="</table>";$("#editInstrumentPulsetable").html(e);this.setupPulsetableEvents();UI.number.initControls("#editInstrumentPulsetable .number")},setupPulsetableEvents:function(){var a=this;$(".pulsetableType").on("change",function(){var e=$(this).attr("id");var t=$(this).val();var i=e.indexOf("_");var r=e.substr(0,i);if(t=="stepPulse"){$("#"+r+"_stepPulseValues").show();$("#"+r+"_setPulseValues").hide()}if(t=="setPulse"){$("#"+r+"_stepPulseValues").hide();$("#"+r+"_setPulseValues").show()}a.setInstrumentData()});$(".pulsetableAdd").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(3));a.writePulsetable();if(a.pulsetable.length<=1){a.pulsetable=[[136,0],[255,0]]}else{a.pulsetable.splice(r+1,0,[0,0])}a.pulsetableHTML();a.setInstrumentData()});$(".pulsetableDelete").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(3));a.writePulsetable();a.pulsetable.splice(r,1);a.pulsetableHTML();a.setInstrumentData()});$(".editInstrumentPulseWidth").on("change",function(){a.setInstrumentData()});$(".editInstrumentPulseWidth").on("keyup",function(){a.setInstrumentData()});$(".editInstrumentPulsetableTime").on("keyup",function(){a.setInstrumentData()});$(".editInstrumentPulsetableTime").on("change",function(){a.setInstrumentData()});$(".editInstrumentPulsetableSpeed").on("keyup",function(){a.setInstrumentData()});$(".editInstrumentPulsetableSpeed").on("change",function(){a.setInstrumentData()})},wavetableHTML:function(){var e="";var t="";var i="";e+='<table width="100%">';e+="<thead>";e+="<tr>";e+="<th>Loop&nbsp;To</th>";e+="<th>Action</th>";e+="<th>Parameters</th>";e+="<th>Gate</th>";e+="<th>Pitch</th>";e+="</tr>";e+="</thead>";e+="<tbody>";var r=0;if(this.wavetable.length>0){r=this.wavetable[this.wavetable.length-1][1];if(r==0){r=this.wavetable.length}}for(var a=0;a<this.wavetable.length;a++){e+="<tr>";if(this.wavetable.length<=1){e+='<td colspan="5">';e+='<button type="button" class="wavetableAdd" id="row'+a+'_add">Add Row</button>';e+="</td>"}else{e+="<td>";var t="";if(r==a+1){t=' checked="checked" '}e+='<input type="radio" name="wavetableLoop" id="row'+a+'_wavetableLoop" value="'+a+'" '+t+">";e+="</td>";if(a==this.wavetable.length-1){e+='<td colspan="5">&nbsp;</td>'}else{e+="<td>";e+='<select id="row'+a+'_type" class="wavetableRowType">';i="";if(this.wavetable[a][0]>=16){i=' selected="selected" '}e+='<option value="wave" '+i+">Set Wave</option>";i="";if(this.wavetable[a][0]<=15){i=' selected="selected" '}e+='<option value="delay" '+i+">Delay</option>";i="";if(this.wavetable[a][0]==242){i=' selected="selected" '}e+='<option value="portamentodown" '+i+">Portamento Down</option>";i="";if(this.wavetable[a][0]==241){i=' selected="selected" '}e+='<option value="portamentoup" '+i+">Portamento Up</option>";i="";if(this.wavetable[a][0]==244){i=' selected="selected" '}e+='<option value="vibrato" '+i+">Vibrato</option>";i="";if(this.wavetable[a][0]==245){i=' selected="selected" '}e+='<option value="attackDecay" '+i+">Set Attack/Decay</option>";i="";if(this.wavetable[a][0]==246){i=' selected="selected" '}e+='<option value="sustainRelease" '+i+">Set Sustain/Release</option>";e+="</select>";e+="</td><td>";var s=0;e+='<span id="row'+a+'_portamentoSpeed"';if(this.wavetable[a][0]!=241&&this.wavetable[a][0]!=242){e+=' style="display: none" '}else{var o=this.wavetable[a][1]-1;if(this.speedtable&&o<this.speedtable.length){s=(this.speedtable[o][0]<<8)+this.speedtable[o][1]}}e+=">";e+='Speed: <input size="4" value="'+s+'" class="number editInstrumentWavetableParam" min="0" max="65535" id="row'+a+'_portamentoSpeedValue"/> (0-65535)';e+="</span>";var l=0;var n=0;e+='<span id="row'+a+'_vibrato"';if(this.wavetable[a][0]!=244){e+=' style="display: none" '}else{var o=this.wavetable[a][1]-1;if(this.speedtable&&o<this.speedtable.length){l=this.speedtable[o][0];n=this.speedtable[o][1]}}e+=">";e+="<label>";e+="Cycle Time";e+='<input size="4" class="number editInstrumentWavetableParam" min="0"  max="127" value="'+l+'" id="row'+a+'_vibratoSpeed"/> Ticks (0-127)';e+="</label>";e+="&nbsp;&nbsp;";e+="<label>";e+="Depth";e+='<input size="4" class="number editInstrumentWavetableParam" min="0" max="255" value="'+n+'" id="row'+a+'_vibratoDepth"/> / Tick (0-255)';e+="</label>";e+="</span>";var h=0;var d=0;var s=this.wavetable[a][1];e+='<span id="row'+a+'_attackDecay"';if(this.wavetable[a][0]!=245){e+=' style="display: none" '}else{h=(s&240)>>4;d=s&15}e+=">";e+="<label>";e+="Attack ";e+='<input size="4" class="number editInstrumentWavetableParam" min="0" max="15" value="'+h+'" id="row'+a+'_attack"/> (0-15)';e+="</label>";e+="<label>";e+="Decay ";e+='<input size="4" class="number editInstrumentWavetableParam" min="0" max="15" value="'+d+'" id="row'+a+'_decay"/> (0-15)';e+="</label>";e+="</span>";var c=0;var f=0;var s=this.wavetable[a][1];e+='<span id="row'+a+'_sustainRelease"';if(this.wavetable[a][0]!=246){e+=' style="display: none" '}else{c=(s&240)>>4;f=s&15}e+=">";e+="<label>";e+="Sustain ";e+='<input size="4" class="number editInstrumentWavetableParam" min="0" max="15" value="'+c+'" id="row'+a+'_sustain"/> (0-15)';e+="</label>";e+="<label>";e+="Release ";e+='<input size="4" class="number editInstrumentWavetableParam" min="0" max="15" value="'+f+'" id="row'+a+'_release"/> (0-15)';e+="</label>";e+="</span>";e+='<span id="row'+a+'_delay"';if(this.wavetable[a][0]>15){e+=' style="display: none" '}e+=">";e+="Delay:";e+='<select id="row'+a+'_delayAmount" value="'+this.wavetable[a][0]+'">';for(var u=0;u<=15;u++){i="";if(u==this.wavetable[a][0]){i=' selected="selected" '}var p=u+1;e+='<option value="'+u+'" '+i+">"+p+"</option>"}e+="</select>";e+="</span>";e+='<span id="row'+a+'_waveTypes"';if(this.wavetable[a][0]<=15||this.wavetable[a][0]>240){e+=' style="display: none" '}e+=">";var t="";if(this.wavetable[a][0]&16){t=' checked="checked" '}e+='<label><input id="row'+a+'_tri" class="advWavetableWaveform" type="checkbox" '+t+">Tri</label>&nbsp;";var t="";if(this.wavetable[a][0]&32){t=' checked="checked" '}e+='<label><input id="row'+a+'_saw" class="advWavetableWaveform" type="checkbox" '+t+">Saw</label>&nbsp;";var t="";if(this.wavetable[a][0]&64){t=' checked="checked" '}e+='<label><input id="row'+a+'_pulse" class="advWavetableWaveform" type="checkbox" '+t+">Pulse</label>&nbsp;";var t="";if(this.wavetable[a][0]&128){t=' checked="checked" '}e+='<label><input id="row'+a+'_noise" class="advWavetableWaveform" type="checkbox" '+t+">Noise</label>&nbsp;";var t="";if(this.wavetable[a][0]&2){t=' checked="checked" '}e+='<label><input id="row'+a+'_sync" class="advWavetableWaveform" type="checkbox" '+t+">Sync</label>&nbsp;";var t="";if(this.wavetable[a][0]&4){t=' checked="checked" '}e+='<label><input id="row'+a+'_ring" class="advWavetableWaveform" type="checkbox" '+t+">Ring Mod</label>&nbsp;";var t="";if(this.wavetable[a][0]&8){t=' checked="checked" '}e+='<label><input id="row'+a+'_test" class="advWavetableWaveform" type="checkbox" '+t+">Testbit</label>&nbsp;";e+="</span>";e+="</td>";e+="<td>";var t="";if(this.wavetable[a][0]&1){t=' checked="checked" '}e+='<input  id="row'+a+'_gate" class="advWavetableGate" type="checkbox" '+t;if(this.wavetable[a][0]<=15||this.wavetable[a][0]>240){e+=' style="display: none" '}e+=">";e+="</td>";e+="<td>";e+='<span id="row'+a+'_pitch"';if(this.wavetable[a][0]>240){e+=' style="display:none" '}e+=">";e+='<select class="wavetablePitchType" id="row'+a+'_pitchType" name="row'+a+'_pitchType">';i="";if(this.wavetable[a][1]==128){i=' selected="selected" '}e+='<option value="noChange" '+i+">No Change</option>";i="";if(this.wavetable[a][1]<=127){i=' selected="selected" '}e+='<option value="relative" '+i+">Relative</option>";i="";if(this.wavetable[a][1]>128){i=' selected="selected" '}e+='<option value="absolute" '+i+">Absolute</option>";e+="</select>";e+='<select class="advPitchRelative" id="row'+a+'_pitchRelative"';if(this.wavetable[a][1]>=128){e+=' style="display:none" '}e+=">";for(var u=94;u>0;u--){var i="";if(this.wavetable[a][1]==u){i=' selected="selected" '}e+='<option value="'+u+'" '+i+">+"+u+"</option>"}i="";if(this.wavetable[a][1]==0||this.wavetable[a][1]==128){i=' selected="selected" '}e+='<option value="0" '+i+">+0</option>";for(var u=1;u>-30;u--){var i="";if(this.wavetable[a][1]==128+u){i=' selected="selected" '}e+='<option value="'+u+'" '+i+">"+u+"</option>"}e+="</select>";var v=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];e+='<select class="advPitchAbsolute" id="row'+a+'_pitchAbsolute"';i="";if(this.wavetable[a][1]<=128){e+=' style="display: none" '}e+=">";for(var u=92;u>=0;u--){var i="";var g=u%12;var m=Math.floor(u/12);var y=v[g]+m;if(u+129==this.wavetable[a][1]){i=' selected="selected" '}e+='<option value="'+u+'" '+i+">"+y+"</option>"}e+="</select>";e+="</span>";e+="</td>";e+="<td>";e+='<button type="button" class="wavetableAdd" id="row'+a+'_add">Add Row</button>';e+='<button type="button" class="wavetableDelete" id="row'+a+'_delete">Delete Row</button>';e+="</td>"}}e+="</tr>"}e+="</tbody>";e+="</table>";$("#editInstrumentWavetable").html(e);UI.number.initControls("#editInstrumentWavetable .number");this.setupWavetableEvents()},setupWavetableEvents:function(){var a=this;$(".wavetablePitchType").on("change",function(){var e=$(this).attr("id");var t=$(this).val();var i=e.indexOf("_");var r=e.substr(0,i);if(t=="noChange"){$("#"+r+"_pitchAbsolute").hide();$("#"+r+"_pitchRelative").hide()}else if(t=="absolute"){$("#"+r+"_pitchAbsolute").val(48);$("#"+r+"_pitchAbsolute").show();$("#"+r+"_pitchRelative").hide()}else{$("#"+r+"_pitchRelative").val(0);$("#"+r+"_pitchAbsolute").hide();$("#"+r+"_pitchRelative").show()}a.setInstrumentData()});$(".wavetableRowType").on("change",function(){var e=$(this).attr("id");var t=$(this).val();var i=e.indexOf("_");var r=e.substr(0,i);if(t=="wave"){$("#"+r+"_waveTypes").show();$("#"+r+"_gate").show();$("#"+r+"_delay").hide();$("#"+r+"_pitch").show();$("#"+r+"_portamentoSpeed").hide();$("#"+r+"_vibrato").hide();$("#"+r+"_attackDecay").hide();$("#"+r+"_sustainRelease").hide()}else if(t=="delay"){$("#"+r+"_waveTypes").hide();$("#"+r+"_gate").hide();$("#"+r+"_delay").show();$("#"+r+"_pitch").show();$("#"+r+"_portamentoSpeed").hide();$("#"+r+"_vibrato").hide();$("#"+r+"_attackDecay").hide();$("#"+r+"_sustainRelease").hide()}else if(t=="portamentoup"||t=="portamentodown"){$("#"+r+"_waveTypes").hide();$("#"+r+"_gate").hide();$("#"+r+"_delay").hide();$("#"+r+"_pitch").hide();$("#"+r+"_portamentoSpeed").show();$("#"+r+"_vibrato").hide();$("#"+r+"_attackDecay").hide();$("#"+r+"_sustainRelease").hide()}else if(t=="vibrato"){$("#"+r+"_waveTypes").hide();$("#"+r+"_gate").hide();$("#"+r+"_delay").hide();$("#"+r+"_pitch").hide();$("#"+r+"_portamentoSpeed").hide();$("#"+r+"_vibrato").show();$("#"+r+"_attackDecay").hide();$("#"+r+"_sustainRelease").hide()}else if(t=="attackDecay"){$("#"+r+"_waveTypes").hide();$("#"+r+"_gate").hide();$("#"+r+"_delay").hide();$("#"+r+"_pitch").hide();$("#"+r+"_portamentoSpeed").hide();$("#"+r+"_vibrato").hide();$("#"+r+"_attackDecay").show();$("#"+r+"_sustainRelease").hide()}else if(t=="sustainRelease"){$("#"+r+"_waveTypes").hide();$("#"+r+"_gate").hide();$("#"+r+"_delay").hide();$("#"+r+"_pitch").hide();$("#"+r+"_portamentoSpeed").hide();$("#"+r+"_vibrato").hide();$("#"+r+"_attackDecay").hide();$("#"+r+"_sustainRelease").show()}a.setInstrumentData()});$(".wavetableAdd").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(3));a.writeWaveTable();if(a.wavetable.length<=1){a.wavetable=[[65,0],[255,0]]}else{a.wavetable.splice(r+1,0,[0,0])}a.wavetableHTML();a.setInstrumentData()});$(".wavetableDelete").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(3));a.writeWaveTable();a.wavetable.splice(r,1);a.wavetableHTML();a.setInstrumentData()});$(".advWavetableWaveform").on("click",function(){a.setInstrumentData()});$(".advWavetableGate").on("click",function(){a.setInstrumentData()});$(".advPitchAbsolute").on("change",function(){a.setInstrumentData()});$(".advPitchRelative").on("change",function(){console.log("adv pitch relative");a.setInstrumentData()});$(".advWavetableWaveform").on("change",function(){a.setInstrumentData()});$("input[name=wavetableLoop]").on("click",function(){a.setInstrumentData()});$(".editInstrumentWavetableParam").on("change",function(){a.setInstrumentData()});$(".editInstrumentWavetableParam").on("keyup",function(){a.setInstrumentData()})},writePulsetable:function(){var e=$("input:radio[name=editInstrumentType]:checked").val();if(e=="basic"){var t=parseInt($("#editInstrumentPMWidth").val());t=Math.floor(4096*t/100);var i=$("#editInstrumentPMSpeed").val();var r=$("#editInstrumentPMDepth").val();if(r>127){r=127}this.pulsetable=[];var a=t&3840;a=a>>8;a=a|128;n=t&255;this.pulsetable.push([a,n]);if(i==0){this.pulsetable.push([255,0])}else{var s=i;while(s>127){this.pulsetable.push([127,r]);s-=127}this.pulsetable.push([s,r]);r=256-r;var s=i;while(s>127){this.pulsetable.push([127,r]);s-=127}this.pulsetable.push([s,r]);this.pulsetable.push([255,2])}this.pulsetableHTML()}else if(e=="advanced"){var o=this.pulsetable.length;this.pulsetable=[];for(var l=0;l<o-1;l++){var a=0;var n=0;var h=$("#row"+l+"_pulseTableType").val();if(h=="stepPulse"){a=parseInt($("#row"+l+"_pulsetableTime").val());if(a>127){a=127;$("#row"+l+"_pulsetableTime").val(a)}n=parseInt($("#row"+l+"_pulsetableSpeed").val());if(n>127){n=127;$("#row"+l+"_pulsetableSpeed").val(n)}if(n<-127){n=-127;$("#row"+l+"_pulsetableSpeed").val(n)}if(n<0){n=256+n}}if(h=="setPulse"){var d=parseInt($("#row"+l+"_pulseWidth").val());var a=128+((d&3840)>>8);var n=d&255}this.pulsetable.push([a,n])}var c=parseInt($("input[name=pulsetableLoop]:checked").val());if(c==this.pulsetable.length){c=0}else{c+=1}this.pulsetable.push([255,c])}else if(e=="drum"){var f=$("input:radio[name=editInstrumentDrumType]:checked").val();this.pulsetable=[];switch(f){case"bass":this.pulsetable.push([136,0]);this.pulsetable.push([255,0]);break;case"tom":this.pulsetable.push([136,0]);this.pulsetable.push([255,0]);break;case"snare":this.pulsetable.push([136,0]);this.pulsetable.push([255,0]);break;case"hihat":this.pulsetable.push([136,0]);this.pulsetable.push([255,0]);break}this.pulsetableHTML()}if(this.pulsetable.length==1){this.pulsetable=[]}},getArpeggioIntervals:function(e){var t=e.mode;var i=e.steps;if(i==2){return[0,12]}var r=[];if(i==3){r=[1,3,5]}if(i==4){r=[1,2,3,5]}if(i==8){r=[1,2,3,4,5,6,7,8]}console.log("get arpeggio intervals = "+t+","+i);var a=this.music.scales.getIntervals(t);var s=[];for(var o=0;o<r.length;o++){var l=r[o];var n=0;var h=Math.floor(l/8);var l=l%8;n=h*12;for(var d=0;d<l-1;d++){n+=a[d]}s.push(n)}console.log(a);console.log("arp intervals:");console.log(s);return s},writeWaveTable:function(){var e=$("input:radio[name=editInstrumentType]:checked").val();this.speedtable=[];if(e=="basic"){this.wavetable=[];var t=1;var i=0;if($("#editInstrumentWaveform_triangle").is(":checked")){t=t|16}if($("#editInstrumentWaveform_sawtooth").is(":checked")){t=t|32}if($("#editInstrumentWaveform_pulse").is(":checked")){t=t|64}if($("#editInstrumentWaveform_noise").is(":checked")){t=t|128}this.wavetable.push([t,i]);var r=t;var a=$("input[name=editInstrumentBasicEffect]:checked").val();if(a=="tremolo"){var s=parseInt($("#editInstrumentTremoloOnSpeed").val())-2;var o=parseInt($("#editInstrumentTremoloOffSpeed").val())-2;var l=r&240;if(s>=0){this.wavetable.push([s,128])}this.wavetable.push([l,128]);if(o>=0){this.wavetable.push([o,128])}this.wavetable.push([r,128]);this.wavetable.push([255,2])}else if(a=="arpeggio"){var n=parseInt($("#editInstrumentArpeggioSpeed").val());var h=$("input[name=editInstrumentArpeggioMode]:checked").val();var d=$("input[name=editInstrumentArpeggioSteps]:checked").val();if(n!=0){var c=this.getArpeggioIntervals({mode:h,steps:d});if(c.length==0){}else{this.wavetable.pop();var f=c[0];this.wavetable.push([t,f]);t=n-1;if(t<0){t=0}for(var u=1;u<c.length;u++){var p=t;if(u==1&&p>1){p--}var f=c[u];this.wavetable.push([p,f])}if(t>1){this.wavetable.push([t,128])}this.wavetable.push([255,1])}}}else if(a=="pitch"){var v=$("input[name=editInstrumentPitchEffect]:checked").val();var g=parseInt($("#editInstrumentPitchEffectTicks").val());var m=parseInt($("#editInstrumentPitchEffectSpeed").val());if(v=="bendup"){t=242;var y=g*m;var b=(y&65280)>>8;var C=y&255;this.speedtable.push([b,C]);i=this.speedtable.length;this.wavetable.push([t,i]);var x=m;var b=(x&65280)>>8;var C=x&255;this.speedtable.push([b,C]);t=241;i=this.speedtable.length;for(var u=0;u<g;u++){this.wavetable.push([t,i])}this.wavetable.push([255,0])}if(v=="benddown"){t=241;var y=g*m;var b=(y&65280)>>8;var C=y&255;this.speedtable.push([b,C]);i=this.speedtable.length;this.wavetable.push([t,i]);var x=m;var b=(x&65280)>>8;var C=x&255;this.speedtable.push([b,C]);t=242;i=this.speedtable.length;for(var u=0;u<g;u++){this.wavetable.push([t,i])}this.wavetable.push([255,0])}if(v=="drop"){t=242;var y=g*m;var b=(y&65280)>>8;var C=y&255;this.speedtable.push([b,C]);i=this.speedtable.length;this.wavetable.push([t,i]);this.wavetable.push([255,this.wavetable.length])}if(v=="rise"){t=241;var x=g*m;var b=(x&65280)>>8;var C=x&255;this.speedtable.push([b,C]);i=this.speedtable.length;this.wavetable.push([t,i]);this.wavetable.push([255,this.wavetable.length])}}else{this.wavetable.push([255,0])}this.wavetableHTML()}else if(e=="advanced"){var S=this.wavetable.length;for(var u=0;u<S-1;u++){var t=0;var i=0;var P=$("#row"+u+"_type").val();if(P=="portamentodown"||P=="portamentoup"){if(P=="portamentoup"){t=241}else{t=242}var m=parseInt($("#row"+u+"_portamentoSpeedValue").val());var b=(m&65280)>>8;var C=m&255;this.speedtable.push([b,C]);i=this.speedtable.length}else if(P=="vibrato"){t=244;var m=parseInt($("#row"+u+"_vibratoSpeed").val());var w=parseInt($("#row"+u+"_vibratoDepth").val());this.speedtable.push([m,w]);i=this.speedtable.length}else if(P=="delay"){t=parseInt($("#row"+u+"_delayAmount").val())}else if(P=="wave"){if($("#row"+u+"_tri").is(":checked")){t=t|16}if($("#row"+u+"_saw").is(":checked")){t=t|32}if($("#row"+u+"_pulse").is(":checked")){t=t|64}if($("#row"+u+"_noise").is(":checked")){t=t|128}if($("#row"+u+"_sync").is(":checked")){t=t|2}if($("#row"+u+"_ring").is(":checked")){t=t|4}if($("#row"+u+"_test").is(":checked")){t=t|8}if($("#row"+u+"_gate").is(":checked")){t=t|1}}else if(P=="attackDecay"){t=245;var I=parseInt($("#row"+u+"_attack").val())&15;var k=parseInt($("#row"+u+"_decay").val())&15;i=(I<<4)+k}else if(P=="sustainRelease"){t=246;var M=parseInt($("#row"+u+"_sustain").val())&15;var T=parseInt($("#row"+u+"_release").val())&15;i=(M<<4)+T}if(P!="portamentodown"&&P!="portamentoup"&&P!="vibrato"&&P!="attackDecay"&&P!="sustainRelease"){if($("#row"+u+"_pitchType").val()=="noChange"){i=128}else if($("#row"+u+"_pitchType").val()=="absolute"){i=129+parseInt($("#row"+u+"_pitchAbsolute").val())}else{i=parseInt($("#row"+u+"_pitchRelative").val());if(i<=0){if(i!=0){i=128+i}}else{i=i}}}this.wavetable[u]=[t,i]}var D=parseInt($("input[name=wavetableLoop]:checked").val());if(D==this.wavetable.length-1){D=0}else{D+=1}this.wavetable[this.wavetable.length-1]=[255,D]}else if(e=="drum"){var E=$("input:radio[name=editInstrumentDrumType]:checked").val();t=0;if($("#editInstrumentDrumWaveform_triangle").is(":checked")){t=t|16}if($("#editInstrumentDrumWaveform_sawtooth").is(":checked")){t=t|32}if($("#editInstrumentDrumWaveform_pulse").is(":checked")){t=t|64}if(t==0){t=64}this.wavetable=[];switch(E){case"bass":this.wavetable.push([129,216]);this.wavetable.push([t|1,166]);this.wavetable.push([t|1,160]);this.wavetable.push([t,152]);this.wavetable.push([0,148]);this.wavetable.push([255,0]);break;case"tom":this.wavetable.push([129,200]);this.wavetable.push([t|1,0]);this.wavetable.push([t|1,127]);this.wavetable.push([t,126]);this.wavetable.push([t,125]);this.wavetable.push([0,124]);this.wavetable.push([0,123]);this.wavetable.push([0,122]);this.wavetable.push([0,121]);this.wavetable.push([0,120]);this.wavetable.push([0,119]);this.wavetable.push([0,118]);this.wavetable.push([0,117]);this.wavetable.push([255,0]);break;case"snare":this.wavetable.push([129,208]);this.wavetable.push([t|1,170]);this.wavetable.push([t|1,164]);this.wavetable.push([128,212]);this.wavetable.push([128,209]);this.wavetable.push([255,0]);break;case"hihat":this.wavetable.push([129,222]);this.wavetable.push([128,220]);this.wavetable.push([255,0]);break}this.wavetableHTML()}if(this.wavetable.length==1){this.wavetable=[]}},setInstrumentType:function(e){switch(e){case"basic":$("#editInstrumentAdvanced").hide();$("#editInstrumentBasic").show();$("#editInstrumentDrum").hide();this.setBasicEffectVisibility();break;case"advanced":$("#editInstrumentAdvanced").show();$("#editInstrumentBasic").hide();$("#editInstrumentDrum").hide();this.showTable("wavetable");break;case"drum":$("#editInstrumentAdvanced").hide();$("#editInstrumentBasic").hide();$("#editInstrumentDrum").show();break}},showTable:function(e){switch(e){case"wavetable":$("#wavetableTab").addClass("instrumentActiveTab");$("#pulsetableTab").removeClass("instrumentActiveTab");$("#filtertableTab").removeClass("instrumentActiveTab");$("#editInstrumentWavetable").show();$("#editInstrumentPulsetable").hide();$("#editInstrumentFiltertable").hide();break;case"pulsetable":$("#wavetableTab").removeClass("instrumentActiveTab");$("#pulsetableTab").addClass("instrumentActiveTab");$("#filtertableTab").removeClass("instrumentActiveTab");$("#editInstrumentWavetable").hide();$("#editInstrumentPulsetable").show();$("#editInstrumentFiltertable").hide();break;case"filtertable":$("#wavetableTab").removeClass("instrumentActiveTab");$("#pulsetableTab").removeClass("instrumentActiveTab");$("#filtertableTab").addClass("instrumentActiveTab");$("#editInstrumentWavetable").hide();$("#editInstrumentPulsetable").hide();$("#editInstrumentFiltertable").show();break}},setArpeggioSteps:function(e){this.arpeggioValues=[];for(var t=0;t<this.arpeggioSteps;t++){var i=$("#editInstrumentArpeggioStep"+t).val();if(typeof i=="undefined"||i==""){i=0}this.arpeggioValues.push(i)}this.arpeggioSteps=e;var r="";for(var t=0;t<this.arpeggioSteps;t++){var a=0;if(t<this.arpeggioValues.length){a=this.arpeggioValues[t]}r+='<input size="1" class="number" value="'+a+'" id="editInstrumentArpeggioStep'+t+'">&nbsp;'}$("#editInstrumentsArpeggioSteps").html(r);UI.number.initControls("#editInstrumentsArpeggioSteps .number")},keyDown:function(e){var t=e.keyCode;var i=this.music.patternView.keyCodeToNote(t);var r=3;if(i!=-1&&i!==this.keyboardNote){this.keyboardPlayingNote=true;if(this.music&&this.music.musicPlayer){this.editInstrumentPlay(r,i)}}this.keyboardNote=i},keyUp:function(e){this.music.musicPlayer2.stopTestInstrument();this.playingInstrument=false;this.keyboardNote=false},setBasicEffectVisibility:function(){var e=$("input[name=editInstrumentBasicEffect]:checked").val();$(".editInstrumentBasicEffect").hide();switch(e){case"tremolo":$("#editInstrumentTremolo").show();break;case"arpeggio":$("#editInstrumentArpeggio").show();break;case"pitch":$("#editInstrumentPitch").show();break}},newInstrument:function(){this.instrumentId=-1;$("#instrumentName").val("New Instrument");this.setInstrumentType("basic");$("#editInstrumentAttack").val(0);$("#editInstrumentDecay").val(0);$("#editInstrumentSustain").val(4);$("#editInstrumentRelease").val(4);$("#editInstrumentVibratoSpeed").val(0);$("#editInstrumentVibratoDepth").val(0);$("#editInstrumentVibratoDelay").val(0);var e="none";$('input[name="editInstrumentBasicEffect"][value="'+e+'"]').prop("checked",true);$('input[name="vibrato"][value="off"]').prop("checked",true);$("#vibratoControls").hide();this.setBasicEffectVisibility();$("#editInstrumentWaveform_triangle").prop("checked",false);$("#editInstrumentWaveform_sawtooth").prop("checked",false);$("#editInstrumentWaveform_pulse").prop("checked",true);$("#pulseControls").show();$("#editInstrumentWaveform_noise").prop("checked",false);$("#editInstrumentPMWidth").val(50);$("#editInstrumentPMSpeed").val(0);$("#editInstrumentPMDepth").val(0)},editInstrument:function(e){this.instrumentId=e;var t=this.music.instruments.getInstrument(this.instrumentId);this.instrumentSave=$.extend(true,{},t);var i=t.data;$("#instrumentName").val(t.name);this.setInstrumentType(t.type);if(t.type=="basic"){$("#editInstrumentType_basic").prop("checked",true);var r=t.basicEffect;if(typeof r=="undefined"){r="none"}$('input[name="editInstrumentBasicEffect"][value="'+r+'"]').prop("checked",true);if(t.basicWaveform&16){$("#editInstrumentWaveform_triangle").prop("checked",true)}else{$("#editInstrumentWaveform_triangle").prop("checked",false)}if(t.basicWaveform&32){$("#editInstrumentWaveform_sawtooth").prop("checked",true)}else{$("#editInstrumentWaveform_sawtooth").prop("checked",false)}if(t.basicWaveform&64){$("#editInstrumentWaveform_pulse").prop("checked",true);$("#pulseControls").show()}else{$("#editInstrumentWaveform_pulse").prop("checked",false);$("#pulseControls").hide()}if(t.basicWaveform&128){$("#editInstrumentWaveform_noise").prop("checked",true)}else{$("#editInstrumentWaveform_noise").prop("checked",false)}this.setBasicEffectVisibility();if(!t.pulseWidth){t.pulseWidth=50}$("#editInstrumentPMWidth").val(t.pulseWidth);$("#editInstrumentPMSpeed").val(t.pulseModulationSpeed);$("#editInstrumentPMDepth").val(t.pulseModulationDepth);var a=t.arpeggioSpeed;if(typeof a=="undefined"||a<1){a=3}$("#editInstrumentArpeggioSpeed").val(a);if(!t.arpeggioType){t.arpeggioType="none"}if(typeof t.tremoloOn=="undefined"){t.tremoloOn=6}if(typeof t.tremoloOff=="undefined"){t.tremoloOff=6}$("#editInstrumentTremoloOnSpeed").val(t.tremoloOn);$("#editInstrumentTremoloOffSpeed").val(t.tremoloOff)}if(t.type=="advanced"){$("#editInstrumentType_advanced").prop("checked",true)}if(t.type=="drum"){$("#editInstrumentType_drum").prop("checked",true);$("#editInstrumentDrumType_"+t.drumType).prop("checked",true);if(t.drumWaveform&16){$("#editInstrumentDrumWaveform_triangle").prop("checked",true)}else{$("#editInstrumentDrumWaveform_triangle").prop("checked",false)}if(t.drumWaveform&32){$("#editInstrumentDrumWaveform_sawtooth").prop("checked",true)}else{$("#editInstrumentDrumWaveform_sawtooth").prop("checked",false)}if(t.drumWaveform&64){$("#editInstrumentDrumWaveform_pulse").prop("checked",true)}else{$("#editInstrumentDrumWaveform_pulse").prop("checked",false)}}$(".instrumentCheckbox").prop("checked",false);$("#editInstrumentAttack").val(t.attack);$("#editInstrumentDecay").val(t.decay);$("#editInstrumentSustain").val(t.sustain);$("#editInstrumentRelease").val(t.release);if(t.vibratoSpeed==0){$('input[name="vibrato"][value="off"]').prop("checked",true);$("#vibratoControls").hide()}else{$('input[name="vibrato"][value="on"]').prop("checked",true);$("#vibratoControls").show();$("#editInstrumentVibratoSpeed").val(t.vibratoSpeed);$("#editInstrumentVibratoDepth").val(t.vibratoDepth);$("#editInstrumentVibratoDelay").val(t.vibratoDelay)}this.wavetable=[];for(var s=0;s<t.wavetable.length;s++){this.wavetable.push([t.wavetable[s][0],t.wavetable[s][1]])}if(this.wavetable.length>0){var o=this.wavetable[0][0];var l=this.wavetable[0][1];if(o&16){$("#editInstrumentWaveform_triangle").prop("checked",true)}else{$("#editInstrumentWaveform_triangle").prop("checked",false)}if(o&32){$("#editInstrumentWaveform_sawtooth").prop("checked",true)}else{$("#editInstrumentWaveform_sawtooth").prop("checked",false)}if(o&64){$("#editInstrumentWaveform_pulse").prop("checked",true);$("#pulseControls").show()}else{$("#editInstrumentWaveform_pulse").prop("checked",false);$("#pulseControls").hide()}if(o&128){$("#editInstrumentWaveform_noise").prop("checked",true)}else{$("#editInstrumentWaveform_noise").prop("checked",false)}}this.wavetableHTML();this.pulsetable=[];for(var s=0;s<t.pulsetable.length;s++){this.pulsetable.push([t.pulsetable[s][0],t.pulsetable[s][1]])}this.pulsetableHTML();this.speedtable=[];for(var s=0;s<t.speedtable.length;s++){this.speedtable.push([t.speedtable[s][0],t.speedtable[s][1]])}this.filtertable=[];for(var s=0;s<t.filtertable.length;s++){this.filtertable.push([t.filtertable[s][0],t.filtertable[s][1]])}this.filtertableHTML()},setInstrumentData:function(){if(this.instrumentId==-1){this.instrumentId=this.music.instruments.createInstrument({name:$("#instrumentName").val(),wavetable:[],pulsetable:[],filtertable:[],speedtable:[],gateTimer:2,firstWave:9});this.music.instruments.updateInstruments();this.music.instruments.selectInstrument(this.instrumentId,false)}var e=this.music.instruments.currentInstrumentId;var t=this.music.instruments.getInstrument(e);t.name=$("#instrumentName").val();t.type=$("input:radio[name=editInstrumentType]:checked").val();t.attack=parseInt($("#editInstrumentAttack").val());t.decay=parseInt($("#editInstrumentDecay").val());t.sustain=parseInt($("#editInstrumentSustain").val());t.release=parseInt($("#editInstrumentRelease").val());var i=$('input[name="vibrato"]:checked').val();if(i=="on"){t.vibratoSpeed=parseInt($("#editInstrumentVibratoSpeed").val());t.vibratoDepth=parseInt($("#editInstrumentVibratoDepth").val());t.vibratoDelay=parseInt($("#editInstrumentVibratoDelay").val());if(!t.vibratoDepth||!t.vibratoSpeed){t.vibratoDelay=0}}else{t.vibratoSpeed=0;t.vibratoDepth=0;t.vibratoDelay=0}if(t.type=="basic"){t.basicWaveform=0;if($("#editInstrumentWaveform_triangle").is(":checked")){t.basicWaveform|=16}if($("#editInstrumentWaveform_sawtooth").is(":checked")){t.basicWaveform|=32}if($("#editInstrumentWaveform_pulse").is(":checked")){t.basicWaveform|=64}if($("#editInstrumentWaveform_noise").is(":checked")){t.basicWaveform|=128}t.pulseWidth=parseInt($("#editInstrumentPMWidth").val());t.pulseModulationSpeed=parseInt($("#editInstrumentPMSpeed").val());t.pulseModulationDepth=parseInt($("#editInstrumentPMDepth").val());t.basicEffect=$("input[name=editInstrumentBasicEffect]:checked").val();t.arpeggioSpeed=parseInt($("#editInstrumentArpeggioSpeed").val());t.arpeggioMode=$("input[name=editInstrumentArpeggioMode]:checked").val();t.arpeggioSteps=parseInt($("input[name=editInstrumentArpeggioMode]:checked").val());if(t.basicEffect=="arpeggio"&&t.arpeggioType=="custom"){t.arpeggioValues=[];for(var r=0;r<this.arpeggioSteps;r++){var a=$("#editInstrumentArpeggioStep"+r).val();if(typeof a=="undefined"||a==""){a=0}t.arpeggioValues.push(a)}}t.tremoloOn=parseInt($("#editInstrumentTremoloOnSpeed").val());t.tremoloOff=parseInt($("#editInstrumentTremoloOffSpeed").val());for(var s in t){if(t.hasOwnProperty(s)){if(isNaN(t[s])){}}}}if(t.type=="drum"){t.drumType=$("input:radio[name=editInstrumentDrumType]:checked").val();t.drumWaveform=0;if($("#editInstrumentDrumWaveform_triangle").is(":checked")){t.drumWaveform|=16}if($("#editInstrumentDrumWaveform_sawtooth").is(":checked")){t.drumWaveform|=32}if($("#editInstrumentDrumWaveform_pulse").is(":checked")){t.drumWaveform|=64}}t.speedtable=[];this.writeWaveTable();t.wavetable=[];for(var r=0;r<this.wavetable.length;r++){t.wavetable[r]=[this.wavetable[r][0],this.wavetable[r][1]]}this.writePulsetable();t.pulsetable=[];for(var r=0;r<this.pulsetable.length;r++){t.pulsetable[r]=[this.pulsetable[r][0],this.pulsetable[r][1]]}this.writeFiltertable();t.filtertable=[];for(var r=0;r<this.filtertable.length;r++){t.filtertable[r]=[this.filtertable[r][0],this.filtertable[r][1]]}for(var r=0;r<this.speedtable.length;r++){t.speedtable[r]=[this.speedtable[r][0],this.speedtable[r][1]]}$("#instrumentName"+e).html($("#instrumentName").val())},editInstrumentPlay:function(e,t){if(this.playingInstrument&&this.playingNote==t){return}this.playingInstrument=true;this.playingNote=t;var i={};i.attack=parseInt($("#editInstrumentAttack").val());i.decay=parseInt($("#editInstrumentDecay").val());i.sustain=parseInt($("#editInstrumentSustain").val());i.release=parseInt($("#editInstrumentRelease").val());var r=$('input[name="vibrato"]:checked').val();if(r=="on"){i.vibratoSpeed=parseInt($("#editInstrumentVibratoSpeed").val());i.vibratoDepth=parseInt($("#editInstrumentVibratoDepth").val());i.vibratoDelay=parseInt($("#editInstrumentVibratoDelay").val());if(!i.vibratoDepth||!i.vibratoSpeed){i.vibratoDelay=0}}else{i.vibratoSpeed=0;i.vibratoDepth=0;i.vibratoDelay=0}i.speedtable=[];i.gateTimer=2;i.firstWave=9;this.writeWaveTable();i.wavetable=[];for(var a=0;a<this.wavetable.length;a++){i.wavetable[a]=[this.wavetable[a][0],this.wavetable[a][1]]}this.writePulsetable();i.pulsetable=[];for(var a=0;a<this.pulsetable.length;a++){i.pulsetable[a]=[this.pulsetable[a][0],this.pulsetable[a][1]]}this.writeFiltertable();i.filtertable=[];for(var a=0;a<this.filtertable.length;a++){i.filtertable[a]=[this.filtertable[a][0],this.filtertable[a][1]]}for(var a=0;a<this.speedtable.length;a++){i.speedtable[a]=[this.speedtable[a][0],this.speedtable[a][1]]}var s=e*12+t;var o=8;o=false;this.music.musicPlayer2.playTestInstrument(s,i);this.keyboard.keyboardOctave=e;this.keyboard.keyboardNote=t;this.keyboard.drawKeyboard();this.keyboard.playingInstrument=true},logTable:function(e,t){console.log("table: "+e);for(var i=0;i<t.length;i++){var r=i+1;r=r.toString(16);var a=t[i][0].toString(16);var s=t[i][1].toString(16);console.log(r+":"+a+","+s)}}};var SidFilters=function(){this.music=null;this.currentFilter=1;this.defaultColors=[16772045,255,9055202,10824234,14596231,6266528,8388352,13789470,16744272,6591981,16775388,14423100,65535,139,35723,12092939,11119017,25600,12433259,9109643,5597999,16747520,10040012,9109504,15308410,9419919,4734347,3100495,52945,9699539,16716947,49151,6908265,2003199,11674146,16775920,2263842,16711935,14474460,16316671,16766720,14329120,8421504,32768,11403055,15794160,16738740,13458524,4915330,16777200,15787660,15132410,15792383,16444375,65535,8388564,15794175,16119260,16770244]};SidFilters.prototype={init:function(e){this.music=e},buildInterface:function(e){var t='<div id="sidFilters" class="panelFill" style="background-color: #444444;">';t+=' <h4 style="margin-left: 10px; margin-bottom: 4px; margin-top: 6px">Filters</h4>';t+='  <div style="background-color: #333333; margin: 10px; position: absolute; top: 14px; bottom: 24px; left:0; right: 0; overflow-y: auto; overflow-x: hidden" id="filtersHolder">';t+="  </div>";t+='  <div style="" class="instrumentButtons">';t+='    <button type="button" id="editFilterButton">Edit</button>';t+='    <button type="button" id="addFilterButton">Add</button>';t+='    <button type="button" id="duplicateFilterButton">Duplicate</button>';t+='    <button type="button" id="deleteFilterButton">Delete</button>';t+="  </div>";t+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{html:t});e.add(this.uiComponent);this.initEvents()},initEvents:function(){var e=this;$("#editFilterButton").on("click",function(){e.music.setView("editFilter");e.music.editFilter.editFilter(e.currentFilter)});$("#addFilterButton").on("click",function(){e.music.setView("editFilter");e.music.editFilter.newFilter()});$("#deleteFilterButton").on("click",function(){e.deleteFilter(parseInt(e.currentFilter))});$("#duplicateFilterButton").on("click",function(){e.duplicateFilter(parseInt(e.currentFilter))})},getJSON:function(){},clearFilters:function(){this.music.doc.data.filters=[]},selectFilter:function(e){this.currentFilter=e;$(".filter").removeClass("selectedFilter");var t="filter"+this.currentFilter;$("#"+t).addClass("selectedFilter")},createMinimalFilters:function(){this.music.doc.data.filters.push({name:"Filter 0",filtertable:[]});this.music.doc.data.filters.push({name:"Lowpass Sweep Up",type:"advanced",filtertable:[[144,247],[0,0],[1,1],[2,0],[255,3]]});this.updateFilters()},createDefaultFilters:function(){this.music.doc.data.filters=[];this.music.doc.data.filters.push({name:"Filter 0",filtertable:[]});this.music.doc.data.filters.push({name:"Lowpass Sweep Up",type:"basic",filtertable:[[144,247],[0,0],[1,1],[2,0],[255,3]],basicFilterType:16,basicFilterResonance:15,basicFilterChannels:7,basicCutoff:64,basicModulationDirection:"up",basicModulationTime:1,basicModulationSpeed:1,basicModulationRepeat:1});this.music.doc.data.filters.push({name:"Bandpass Sweep Up/Down",type:"advanced",filtertable:[[160,247],[0,0],[24,1],[24,255],[255,3]]});this.music.doc.data.filters.push({name:"Highpass Sweep Down",type:"advanced",filtertable:[[192,247],[0,100],[1,255],[3,0],[255,3]]});this.music.doc.data.filters.push({name:"Tremolo",type:"advanced",filtertable:[[144,247],[0,255],[5,0],[0,0],[5,0],[255,2]],basicFilterType:16,basicFilterResonance:15,basicFilterChannels:7,basicCutoff:64,basicModulationDirection:"up",basicModulationTime:1,basicModulationSpeed:1,basicModulationRepeat:1});this.updateFilters()},updateFilterHTML:function(){var t=this;var e="";for(var i=1;i<this.music.doc.data.filters.length;i++){var r=i;e+='<div class="filter" id="filter'+r+'">';var a="#"+((1<<24)+this.music.doc.data.filters[i].color).toString(16).slice(1);e+='<div style="margin-top: 2px; margin-right: 4px; display: inline-block; width: 12px; height: 12px; background-color: '+a+'"></div>';e+='<span style="margin-bottom: 2px" id="filterName'+r+'">';e+=this.music.doc.data.filters[i].name;e+="</span>";e+="</div>"}$("#filtersHolder").html(e);$(".filter").on("click",function(){var e=$(this).attr("id");e=e.replace("filter","");t.selectFilter(e)});this.selectFilter(1)},duplicateFilter:function(e){var t={};for(var i in this.music.doc.data.filters[e]){if(i=="filtertable"){t[i]=[];for(var r=0;r<this.music.doc.data.filters[e][i].length;r++){t[i].push([this.music.doc.data.filters[e][i][r][0],this.music.doc.data.filters[e][i][r][1]])}}else{t[i]=this.music.doc.data.filters[e][i]}}var a=e+1;t.name+=" Copy";this.music.doc.data.filters.splice(a,0,t);for(var r=0;r<this.music.patterns.length;r++){this.music.patterns[r].shiftFiltersAbove(e,1)}this.updateFilters();this.music.sidPlayer.testInstrumentSetup();this.music.updateSid(true);this.music.patternView.drawPattern();this.selectFilter(a,false)},deleteFilter:function(e){var t=false;for(var i=0;i<this.music.patterns.length;i++){if(this.music.patterns[i].usesFilter(e)){t=true}}if(t){if(!confirm("This filter is being used, are you sure you want to delete it?")){return}for(var i=0;i<this.music.patterns.length;i++){this.music.patterns[i].removeFilter(e)}}this.music.doc.data.filters.splice(e,1);for(var i=0;i<this.music.patterns.length;i++){this.music.patterns[i].shiftFiltersAbove(e)}if(this.music.doc.data.filters.length==1){this.music.doc.data.filters=[];this.createMinimalFilters()}this.updateFilters();this.music.sidPlayer.testInstrumentSetup();this.music.updateSid(true);this.music.patternView.drawPattern();this.music.patternView.updatePattern()},updateFilters:function(){this.updateFilterHTML()}};var EditSidFilter=function(){this.music=null;this.filterId=0;this.filtertable=[];this.b5="basic"};EditSidFilter.prototype={init:function(e){this.music=e},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.HTMLPanel");e.add(this.uiComponent);UI.on("ready",function(){t.uiComponent.load("html/music/sid/editFilter.html",function(){t.initContent();t.initEvents()})})},initContent:function(){this.keyboard=new KeyboardCanvas;this.keyboard.init("editFilterKeyboard")},initEvents:function(){var i=this;this.keyboard.on("keydown",function(e,t){i.testFilterOn(e,t)});this.keyboard.on("keyup",function(){i.testFilterOff()});$("#editFilterOK").on("click",function(){i.setFilterData();i.music.setView("edit")});$("#editFilterApply").on("click",function(){i.setFilterData()});$("#editFilterCancel").on("click",function(){i.music.setView("edit")});$("input[name=editFilterType]").on("click",function(){var e=$("input[name=editFilterType]:checked").val();i.setFilterType(e)})},testFilterOn:function(e,t){this.writeFiltertable();var i={filtertable:this.filtertable};var r=e*12+t},testFilterOff:function(){},newFilter:function(){this.filterId=-1;this.filtertable=[[255,0]];$("#filterName").val("New Filter");this.filtertableHTML()},editFilter:function(e){this.filterId=e;var t=this.music.doc.data.filters[e];if(typeof t.type=="undefined"||t.type=="advanced"){this.setFilterType("advanced");this.filtertable=[];for(var i=0;i<t.filtertable.length;i++){this.filtertable.push([t.filtertable[i][0],t.filtertable[i][1]])}}else{this.setFilterType("basic");var r=t.basicCutoff;if(typeof r=="undefined"){r=64}$("#filterBasicCutoff").val(r);var a=t.basicFilterType;if(typeof a=="undefined"){a=16}$("#filterBasicType_low").prop("checked",a&16);$("#filterBasicType_band").prop("checked",a&32);$("#filterBasicType_high").prop("checked",a&64);var s=t.basicFilterResonance;if(typeof s=="undefined"){s=15}$("#filterBasicResonance").val(s);var o=t.basicFilterChannels;if(typeof o=="undefined"){o=7}$("#filterBasicAffects_channel1").prop("checked",o&1);$("#filterBasicAffects_channel2").prop("checked",o&2);$("#filterBasicAffects_channel3").prop("checked",o&4);$("input[name=filterBasicModulateType][value="+t.basicModulationDirection+"]").prop("checked",true);$("#filterBasicModulateTicks").val(t.basicModulationTime);$("#filterBasicModulateAmount").val(t.basicModulationSpeed);if(t.basicModulationRepeat==1){$("#filterBasicModulateRepeat").prop("checked",true)}else{$("#filterBasicModulateRepeat").prop("checked",false)}this.writeFiltertable()}$("#filterName").val(t.name);this.filtertableHTML()},setFilterType:function(e){if(e=="basic"){$("#editFilterBasic").show();$("#editFilterAdvanced").hide();$("#editFilterType_basic").prop("checked",true)}else{this.writeFiltertable();this.filtertableHTML();$("#editFilterBasic").hide();$("#editFilterAdvanced").show();$("#editFilterType_advanced").prop("checked",true)}this.b5=e},setFilterData:function(){if(this.filterId==-1){this.music.doc.data.filters.push({name:$("#filterName").val(),filtertable:[]});this.filterId=this.music.doc.data.filters.length-1;this.music.filters.updateFilters();this.music.filters.selectFilter(this.filterId)}var e=this.music.doc.data.filters[this.filterId];e.name=$("#filterName").val();e.type="advanced";this.writeFiltertable();e.filtertable=[];for(var t=0;t<this.filtertable.length;t++){e.filtertable.push([this.filtertable[t][0],this.filtertable[t][1]])}if(this.b5=="basic"){e.type="basic";var i=0;var r=0;if($("#filterBasicAffects_channel1").is(":checked")){i|=1}if($("#filterBasicAffects_channel2").is(":checked")){i|=2}if($("#filterBasicAffects_channel3").is(":checked")){i|=4}if($("#filterBasicType_low").is(":checked")){r=r|16}if($("#filterBasicType_band").is(":checked")){r=r|32}if($("#filterBasicType_high").is(":checked")){r=r|64}e.basicFilterType=r;e.basicFilterResonance=$("#filterBasicResonance").val();e.basicFilterChannels=i;e.basicCutoff=$("#filterBasicCutoff").val();e.basicModulationDirection=$("input[name=filterBasicModulateType]:checked").val();e.basicModulationTime=parseInt($("#filterBasicModulateTicks").val());e.basicModulationSpeed=parseInt($("#filterBasicModulateAmount").val());if($("#filterBasicModulateRepeat").is(":checked")){e.basicModulationRepeat=1}else{e.basicModulationRepeat=0}}$("#filterName"+this.filterId).html(e.name)},filtertableHTML:function(){var e="";var t="";var i="";var r=0;if(this.filtertable.length>0){r=this.filtertable[this.filtertable.length-1][1];if(r==0){r=this.filtertable.length}}e+='<table width="100%">';e+="<tr>";e+="<th>loop to</th>";e+="<th>type</th>";e+="<th>filter</th>";e+="<th>pitch</th>";e+="</tr>";if(this.filtertable.length<=1){e+="<tr>";e+='<td colspan="4">';e+='<button type="button" class="filtertableAdd" id="row_add">Add Row</button>';e+="</td>";e+="</tr>"}for(var a=0;a<this.filtertable.length;a++){var s=this.filtertable[a][0];var o=this.filtertable[a][1];e+="<tr>";e+="<td>";var t="";if(r==a+1){t=' checked="checked" '}e+='<input type="radio" name="filtertableLoop" id="row'+a+'_filtertableLoop" value="'+a+'" '+t+">";e+="</td>";if(a==this.filtertable.length-1){e+='<td colspan="3">&nbsp;</td>'}else{e+="<td>";e+='<select id="row'+a+'_filterrowtype" class="filtertableRowType">';i="";if(this.filtertable[a][0]==0){i=' selected="selected" '}e+='<option value="cutoff" '+i+">Set Cutoff</option>";i="";if(this.filtertable[a][0]>=1&&this.filtertable[a][0]<=127){i=' selected="selected" '}e+='<option value="modulate" '+i+">Modulate Filter</option>";i="";if(this.filtertable[a][0]>=128&&this.filtertable[a][0]<=240){i=' selected="selected" '}e+='<option value="filter" '+i+">Set Filter</option>";e+="</select>";e+="</td>";e+="<td>";e+='<span id="row'+a+'_filtercutoffParams" ';if(s!=0){e+=' style="display:none" '}e+=">";var l=o;e+="<label>Cutoff :</label>";e+='<input id="row'+a+'_filtercutoff" class="number" min="0" max="255" size="4" value="'+l+'"> (0-255)';e+="</span>";e+='<span id="row'+a+'_filtermodulateParams" ';if(s<1||s>127){e+='style="display:none" '}e+=">";var n=s;e+="<label>Modulate For:</label>";e+='<input id="row'+a+'_filtertime" class="number" min="0" max="127" size="4" value="'+n+'"> Ticks(0-127)';var h=o;if(h>127){h=h-256}if(h>127){h=127}e+="&nbsp;&nbsp;";e+="<label>Amount :</label>";e+='<input id="row'+a+'_filterspeed" size="4" class="number" min="-127" max="127" value="'+h+'"> per Tick(-127 - 127)';e+="</span>";e+='<span id="row'+a+'_filterParams" ';if(s<=127){e+=' style="display:none" '}e+=">";e+='<label><input type="checkbox" id="row'+a+'_filtertypelow" value="low" ';if(s&16){e+=' checked="checked" '}e+="> Lowpass</label>";e+='<label><input type="checkbox" id="row'+a+'_filtertypeband" value="band" ';if(s&32){e+=' checked="checked" '}e+="> Bandpass</label>";e+='<label><input type="checkbox" id="row'+a+'_filtertypehigh" value="high" ';if(s&64){e+=' checked="checked" '}e+="> Highpass</label>";var d=(o&240)>>4;var c=o&15;e+="<label>Resonance :</label>";e+='<input id="row'+a+'_resonance" class="number" min="0" max="15" size="4" value="'+d+'"> (0-15)';e+='<label><input type="checkbox" id="row'+a+'_channel1" ';if(c&1){e+=' checked="checked" '}e+="> Channel 1</label>&nbsp;";e+='<label><input type="checkbox" id="row'+a+'_channel2" ';if(c&2){e+=' checked="checked" '}e+="> Channel 2</label>&nbsp;";e+='<label><input type="checkbox" id="row'+a+'_channel3" ';if(c&4){e+=' checked="checked" '}e+="> Channel 3</label>";e+="</span>";e+="</td>";e+="<td>";e+='<button type="button" class="filtertableAdd" id="row'+a+'_add">Add Row</button>';e+='<button type="button" class="filtertableDelete" id="row'+a+'_delete">Delete Row</button>';e+="</td>"}e+="</tr>"}e+="</table>";$("#editFiltertable").html(e);$("#editInstrumentFiltertable").html("");this.setupFiltertableEvents();UI.number.initControls("#editFiltertable .number")},setupFiltertableEvents:function(){var a=this;$(".filtertableRowType").on("change",function(){var e=$(this).attr("id");var t=$(this).val();var i=e.indexOf("_");var r=e.substr(0,i);if(t=="cutoff"){$("#"+r+"_filtercutoffParams").show();$("#"+r+"_filtermodulateParams").hide();$("#"+r+"_filterParams").hide()}else if(t=="modulate"){$("#"+r+"_filtercutoffParams").hide();$("#"+r+"_filtermodulateParams").show();$("#"+r+"_filterParams").hide()}else if(t=="filter"){$("#"+r+"_filtercutoffParams").hide();$("#"+r+"_filtermodulateParams").hide();$("#"+r+"_filterParams").show()}});$(".filtertableAdd").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(3));a.writeFiltertable();if(a.filtertable.length==0){a.filtertable.push([144,247]);a.filtertable.push([255,0])}else if(a.filtertable.length==1){a.filtertable.splice(r+1,0,[144,247])}else{a.filtertable.splice(r+1,0,[0,0])}a.filtertableHTML()});$(".filtertableDelete").on("click",function(){var e=$(this).attr("id");var t=e.indexOf("_");var i=e.substr(0,t);var r=parseInt(e.substr(3));a.writeFiltertable();a.filtertable.splice(r,1);a.filtertableHTML()})},writeFiltertable:function(){if(this.b5=="basic"){this.filtertable=[];var e=0;var t=0;e=128;if($("#filterBasicType_low").is(":checked")){e=e|16}if($("#filterBasicType_band").is(":checked")){e=e|32}if($("#filterBasicType_high").is(":checked")){e=e|64}var i=parseInt($("#filterBasicResonance").val());var r=0;if($("#filterBasicAffects_channel1").is(":checked")){r|=1}if($("#filterBasicAffects_channel2").is(":checked")){r|=2}if($("#filterBasicAffects_channel3").is(":checked")){r|=4}t=i<<4|r;this.filtertable.push([parseInt(e),parseInt(t)]);e=0;t=parseInt($("#filterBasicCutoff").val());this.filtertable.push([parseInt(e),parseInt(t)]);var a=$("input[name=filterBasicModulateType]:checked").val();var s=$("#filterBasicModulateTicks").val();var o=$("#filterBasicModulateAmount").val();var l=$("#filterBasicModulateRepeat").is(":checked");if(a=="up"){e=s;t=o;this.filtertable.push([parseInt(e),parseInt(t)]);e=255;if(l){t=3}else{t=0}this.filtertable.push([parseInt(e),parseInt(t)])}else if(a=="down"){e=s;t=-o+256;this.filtertable.push([parseInt(e),parseInt(t)]);e=255;if(l){t=3}else{t=0}this.filtertable.push([parseInt(e),parseInt(t)])}else if(a=="updown"){e=s;t=o;this.filtertable.push([parseInt(e),parseInt(t)]);e=s;t=-o+256;this.filtertable.push([parseInt(e),parseInt(t)]);e=255;if(l){t=3}else{t=0}this.filtertable.push([parseInt(e),parseInt(t)])}else{var n=0;this.filtertable.push([255,n])}}else{var h=this.filtertable.length;this.filtertable=[];for(var d=0;d<h-1;d++){var e=0;var t=0;var c=$("#row"+d+"_filterrowtype").val();if(c=="cutoff"){e=0;t=$("#row"+d+"_filtercutoff").val()}else if(c=="modulate"){e=$("#row"+d+"_filtertime").val();if(e<0){e=1}if(e>127){e=127}speed=parseInt($("#row"+d+"_filterspeed").val());t=speed;if(t<0){t=256+speed}}else if(c=="filter"){e=128;if($("#row"+d+"_filtertypelow").is(":checked")){e=e|16}if($("#row"+d+"_filtertypeband").is(":checked")){e=e|32}if($("#row"+d+"_filtertypehigh").is(":checked")){e=e|64}var i=parseInt($("#row"+d+"_resonance").val());var r=0;if($("#row"+d+"_channel1").is(":checked")){r|=1}if($("#row"+d+"_channel2").is(":checked")){r|=2}if($("#row"+d+"_channel3").is(":checked")){r|=4}t=i<<4|r}this.filtertable.push([parseInt(e),parseInt(t)])}var n=parseInt($("input[name=filtertableLoop]:checked").val());if(n==this.filtertable.length){n=0}else{n+=1}this.filtertable.push([255,n])}this.logTable("filter",this.filtertable)},mouseDown:function(e,t,i){this.keyboard.mouseDown(t,i)},mouseUp:function(e,t,i){this.keyboard.mouseUp(t,i)},mouseMove:function(e,t,i,r){this.keyboard.mouseToKeyboard(e,t)},logTable:function(e,t){console.log("table: "+e);for(var i=0;i<t.length;i++){var r=i+1;r=r.toString(16);var a=t[i][0].toString(16);var s=t[i][1].toString(16);console.log(r+":0x"+a+",0x"+s)}}};SidPlayer.driver=[];SidPlayer.driver[0]=1;SidPlayer.driver[1]=8;SidPlayer.driver[2]=11;SidPlayer.driver[3]=8;SidPlayer.driver[4]=10;SidPlayer.driver[5]=0;SidPlayer.driver[6]=158;SidPlayer.driver[7]=51;SidPlayer.driver[8]=48;SidPlayer.driver[9]=55;SidPlayer.driver[10]=50;SidPlayer.driver[11]=0;SidPlayer.driver[12]=0;SidPlayer.driver[13]=0;SidPlayer.driver[14]=0;SidPlayer.driver[15]=0;SidPlayer.driver[16]=0;SidPlayer.driver[17]=0;SidPlayer.driver[18]=0;SidPlayer.driver[19]=0;SidPlayer.driver[20]=0;SidPlayer.driver[21]=0;SidPlayer.driver[22]=0;SidPlayer.driver[23]=0;SidPlayer.driver[24]=0;SidPlayer.driver[25]=0;SidPlayer.driver[26]=0;SidPlayer.driver[27]=0;SidPlayer.driver[28]=0;SidPlayer.driver[29]=0;SidPlayer.driver[30]=0;SidPlayer.driver[31]=0;SidPlayer.driver[32]=0;SidPlayer.driver[33]=0;SidPlayer.driver[34]=0;SidPlayer.driver[35]=0;SidPlayer.driver[36]=0;SidPlayer.driver[37]=0;SidPlayer.driver[38]=0;SidPlayer.driver[39]=0;SidPlayer.driver[40]=0;SidPlayer.driver[41]=0;SidPlayer.driver[42]=0;SidPlayer.driver[43]=0;SidPlayer.driver[44]=0;SidPlayer.driver[45]=0;SidPlayer.driver[46]=0;SidPlayer.driver[47]=0;SidPlayer.driver[48]=0;SidPlayer.driver[49]=0;SidPlayer.driver[50]=0;SidPlayer.driver[51]=0;SidPlayer.driver[52]=0;SidPlayer.driver[53]=0;SidPlayer.driver[54]=0;SidPlayer.driver[55]=0;SidPlayer.driver[56]=0;SidPlayer.driver[57]=0;SidPlayer.driver[58]=0;SidPlayer.driver[59]=0;SidPlayer.driver[60]=0;SidPlayer.driver[61]=0;SidPlayer.driver[62]=0;SidPlayer.driver[63]=0;SidPlayer.driver[64]=0;SidPlayer.driver[65]=0;SidPlayer.driver[66]=0;SidPlayer.driver[67]=0;SidPlayer.driver[68]=0;SidPlayer.driver[69]=0;SidPlayer.driver[70]=0;SidPlayer.driver[71]=0;SidPlayer.driver[72]=0;SidPlayer.driver[73]=0;SidPlayer.driver[74]=0;SidPlayer.driver[75]=0;SidPlayer.driver[76]=0;SidPlayer.driver[77]=0;SidPlayer.driver[78]=0;SidPlayer.driver[79]=0;SidPlayer.driver[80]=0;SidPlayer.driver[81]=0;SidPlayer.driver[82]=0;SidPlayer.driver[83]=0;SidPlayer.driver[84]=0;SidPlayer.driver[85]=0;SidPlayer.driver[86]=0;SidPlayer.driver[87]=0;SidPlayer.driver[88]=0;SidPlayer.driver[89]=0;SidPlayer.driver[90]=0;SidPlayer.driver[91]=0;SidPlayer.driver[92]=0;SidPlayer.driver[93]=0;SidPlayer.driver[94]=0;SidPlayer.driver[95]=0;SidPlayer.driver[96]=0;SidPlayer.driver[97]=0;SidPlayer.driver[98]=0;SidPlayer.driver[99]=0;SidPlayer.driver[100]=0;SidPlayer.driver[101]=0;SidPlayer.driver[102]=0;SidPlayer.driver[103]=0;SidPlayer.driver[104]=0;SidPlayer.driver[105]=0;SidPlayer.driver[106]=0;SidPlayer.driver[107]=0;SidPlayer.driver[108]=0;SidPlayer.driver[109]=0;SidPlayer.driver[110]=0;SidPlayer.driver[111]=0;SidPlayer.driver[112]=0;SidPlayer.driver[113]=0;SidPlayer.driver[114]=0;SidPlayer.driver[115]=0;SidPlayer.driver[116]=0;SidPlayer.driver[117]=0;SidPlayer.driver[118]=0;SidPlayer.driver[119]=0;SidPlayer.driver[120]=0;SidPlayer.driver[121]=0;SidPlayer.driver[122]=0;SidPlayer.driver[123]=0;SidPlayer.driver[124]=0;SidPlayer.driver[125]=0;SidPlayer.driver[126]=0;SidPlayer.driver[127]=0;SidPlayer.driver[128]=0;SidPlayer.driver[129]=0;SidPlayer.driver[130]=0;SidPlayer.driver[131]=0;SidPlayer.driver[132]=0;SidPlayer.driver[133]=0;SidPlayer.driver[134]=0;SidPlayer.driver[135]=0;SidPlayer.driver[136]=0;SidPlayer.driver[137]=0;SidPlayer.driver[138]=0;SidPlayer.driver[139]=0;SidPlayer.driver[140]=0;SidPlayer.driver[141]=0;SidPlayer.driver[142]=0;SidPlayer.driver[143]=0;SidPlayer.driver[144]=0;SidPlayer.driver[145]=0;SidPlayer.driver[146]=0;SidPlayer.driver[147]=0;SidPlayer.driver[148]=0;SidPlayer.driver[149]=0;SidPlayer.driver[150]=0;SidPlayer.driver[151]=0;SidPlayer.driver[152]=0;SidPlayer.driver[153]=0;SidPlayer.driver[154]=0;SidPlayer.driver[155]=0;SidPlayer.driver[156]=0;SidPlayer.driver[157]=0;SidPlayer.driver[158]=0;SidPlayer.driver[159]=0;SidPlayer.driver[160]=0;SidPlayer.driver[161]=0;SidPlayer.driver[162]=0;SidPlayer.driver[163]=0;SidPlayer.driver[164]=0;SidPlayer.driver[165]=0;SidPlayer.driver[166]=0;SidPlayer.driver[167]=0;SidPlayer.driver[168]=0;SidPlayer.driver[169]=0;SidPlayer.driver[170]=0;SidPlayer.driver[171]=0;SidPlayer.driver[172]=0;SidPlayer.driver[173]=0;SidPlayer.driver[174]=0;SidPlayer.driver[175]=0;SidPlayer.driver[176]=0;SidPlayer.driver[177]=0;SidPlayer.driver[178]=0;SidPlayer.driver[179]=0;SidPlayer.driver[180]=0;SidPlayer.driver[181]=0;SidPlayer.driver[182]=0;SidPlayer.driver[183]=0;SidPlayer.driver[184]=0;SidPlayer.driver[185]=0;SidPlayer.driver[186]=0;SidPlayer.driver[187]=0;SidPlayer.driver[188]=0;SidPlayer.driver[189]=0;SidPlayer.driver[190]=0;SidPlayer.driver[191]=0;SidPlayer.driver[192]=0;SidPlayer.driver[193]=0;SidPlayer.driver[194]=0;SidPlayer.driver[195]=0;SidPlayer.driver[196]=0;SidPlayer.driver[197]=0;SidPlayer.driver[198]=0;SidPlayer.driver[199]=0;SidPlayer.driver[200]=0;SidPlayer.driver[201]=0;SidPlayer.driver[202]=0;SidPlayer.driver[203]=0;SidPlayer.driver[204]=0;SidPlayer.driver[205]=0;SidPlayer.driver[206]=0;SidPlayer.driver[207]=0;SidPlayer.driver[208]=0;SidPlayer.driver[209]=0;SidPlayer.driver[210]=0;SidPlayer.driver[211]=0;SidPlayer.driver[212]=0;SidPlayer.driver[213]=0;SidPlayer.driver[214]=0;SidPlayer.driver[215]=0;SidPlayer.driver[216]=0;SidPlayer.driver[217]=0;SidPlayer.driver[218]=0;SidPlayer.driver[219]=0;SidPlayer.driver[220]=0;SidPlayer.driver[221]=0;SidPlayer.driver[222]=0;SidPlayer.driver[223]=0;SidPlayer.driver[224]=0;SidPlayer.driver[225]=0;SidPlayer.driver[226]=0;SidPlayer.driver[227]=0;SidPlayer.driver[228]=0;SidPlayer.driver[229]=0;SidPlayer.driver[230]=0;SidPlayer.driver[231]=0;SidPlayer.driver[232]=0;SidPlayer.driver[233]=0;SidPlayer.driver[234]=0;SidPlayer.driver[235]=0;SidPlayer.driver[236]=0;SidPlayer.driver[237]=0;SidPlayer.driver[238]=0;SidPlayer.driver[239]=0;SidPlayer.driver[240]=0;SidPlayer.driver[241]=0;SidPlayer.driver[242]=0;SidPlayer.driver[243]=0;SidPlayer.driver[244]=0;SidPlayer.driver[245]=0;SidPlayer.driver[246]=0;SidPlayer.driver[247]=0;SidPlayer.driver[248]=0;SidPlayer.driver[249]=0;SidPlayer.driver[250]=0;SidPlayer.driver[251]=0;SidPlayer.driver[252]=0;SidPlayer.driver[253]=0;SidPlayer.driver[254]=0;SidPlayer.driver[255]=0;SidPlayer.driver[256]=0;SidPlayer.driver[257]=0;SidPlayer.driver[258]=0;SidPlayer.driver[259]=0;SidPlayer.driver[260]=0;SidPlayer.driver[261]=0;SidPlayer.driver[262]=0;SidPlayer.driver[263]=0;SidPlayer.driver[264]=0;SidPlayer.driver[265]=0;SidPlayer.driver[266]=0;SidPlayer.driver[267]=0;SidPlayer.driver[268]=0;SidPlayer.driver[269]=0;SidPlayer.driver[270]=0;SidPlayer.driver[271]=0;SidPlayer.driver[272]=0;SidPlayer.driver[273]=0;SidPlayer.driver[274]=0;SidPlayer.driver[275]=0;SidPlayer.driver[276]=0;SidPlayer.driver[277]=0;SidPlayer.driver[278]=0;SidPlayer.driver[279]=0;SidPlayer.driver[280]=0;SidPlayer.driver[281]=0;SidPlayer.driver[282]=0;SidPlayer.driver[283]=0;SidPlayer.driver[284]=0;SidPlayer.driver[285]=0;SidPlayer.driver[286]=0;SidPlayer.driver[287]=0;SidPlayer.driver[288]=0;SidPlayer.driver[289]=0;SidPlayer.driver[290]=0;SidPlayer.driver[291]=0;SidPlayer.driver[292]=0;SidPlayer.driver[293]=0;SidPlayer.driver[294]=0;SidPlayer.driver[295]=0;SidPlayer.driver[296]=0;SidPlayer.driver[297]=0;SidPlayer.driver[298]=0;SidPlayer.driver[299]=0;SidPlayer.driver[300]=0;SidPlayer.driver[301]=0;SidPlayer.driver[302]=0;SidPlayer.driver[303]=0;SidPlayer.driver[304]=0;SidPlayer.driver[305]=0;SidPlayer.driver[306]=0;SidPlayer.driver[307]=0;SidPlayer.driver[308]=0;SidPlayer.driver[309]=0;SidPlayer.driver[310]=0;SidPlayer.driver[311]=0;SidPlayer.driver[312]=0;SidPlayer.driver[313]=0;SidPlayer.driver[314]=0;SidPlayer.driver[315]=0;SidPlayer.driver[316]=0;SidPlayer.driver[317]=0;SidPlayer.driver[318]=0;SidPlayer.driver[319]=0;SidPlayer.driver[320]=0;SidPlayer.driver[321]=0;SidPlayer.driver[322]=0;SidPlayer.driver[323]=0;SidPlayer.driver[324]=0;SidPlayer.driver[325]=0;SidPlayer.driver[326]=0;SidPlayer.driver[327]=0;SidPlayer.driver[328]=0;SidPlayer.driver[329]=0;SidPlayer.driver[330]=0;SidPlayer.driver[331]=0;SidPlayer.driver[332]=0;SidPlayer.driver[333]=0;SidPlayer.driver[334]=0;SidPlayer.driver[335]=0;SidPlayer.driver[336]=0;SidPlayer.driver[337]=0;SidPlayer.driver[338]=0;SidPlayer.driver[339]=0;SidPlayer.driver[340]=0;SidPlayer.driver[341]=0;SidPlayer.driver[342]=0;SidPlayer.driver[343]=0;SidPlayer.driver[344]=0;SidPlayer.driver[345]=0;SidPlayer.driver[346]=0;SidPlayer.driver[347]=0;SidPlayer.driver[348]=0;SidPlayer.driver[349]=0;SidPlayer.driver[350]=0;SidPlayer.driver[351]=0;SidPlayer.driver[352]=0;SidPlayer.driver[353]=0;SidPlayer.driver[354]=0;SidPlayer.driver[355]=0;SidPlayer.driver[356]=0;SidPlayer.driver[357]=0;SidPlayer.driver[358]=0;SidPlayer.driver[359]=0;SidPlayer.driver[360]=0;SidPlayer.driver[361]=0;SidPlayer.driver[362]=0;SidPlayer.driver[363]=0;SidPlayer.driver[364]=0;SidPlayer.driver[365]=0;SidPlayer.driver[366]=0;SidPlayer.driver[367]=0;SidPlayer.driver[368]=0;SidPlayer.driver[369]=0;SidPlayer.driver[370]=0;SidPlayer.driver[371]=0;SidPlayer.driver[372]=0;SidPlayer.driver[373]=0;SidPlayer.driver[374]=0;SidPlayer.driver[375]=0;SidPlayer.driver[376]=0;SidPlayer.driver[377]=0;SidPlayer.driver[378]=0;SidPlayer.driver[379]=0;SidPlayer.driver[380]=0;SidPlayer.driver[381]=0;SidPlayer.driver[382]=0;SidPlayer.driver[383]=0;SidPlayer.driver[384]=0;SidPlayer.driver[385]=0;SidPlayer.driver[386]=0;SidPlayer.driver[387]=0;SidPlayer.driver[388]=0;SidPlayer.driver[389]=0;SidPlayer.driver[390]=0;SidPlayer.driver[391]=0;SidPlayer.driver[392]=0;SidPlayer.driver[393]=0;SidPlayer.driver[394]=0;SidPlayer.driver[395]=0;SidPlayer.driver[396]=0;SidPlayer.driver[397]=0;SidPlayer.driver[398]=0;SidPlayer.driver[399]=0;SidPlayer.driver[400]=0;SidPlayer.driver[401]=0;SidPlayer.driver[402]=0;SidPlayer.driver[403]=0;SidPlayer.driver[404]=0;SidPlayer.driver[405]=0;SidPlayer.driver[406]=0;SidPlayer.driver[407]=0;SidPlayer.driver[408]=0;SidPlayer.driver[409]=0;SidPlayer.driver[410]=0;SidPlayer.driver[411]=0;SidPlayer.driver[412]=0;SidPlayer.driver[413]=0;SidPlayer.driver[414]=0;SidPlayer.driver[415]=0;SidPlayer.driver[416]=0;SidPlayer.driver[417]=0;SidPlayer.driver[418]=0;SidPlayer.driver[419]=0;SidPlayer.driver[420]=0;SidPlayer.driver[421]=0;SidPlayer.driver[422]=0;SidPlayer.driver[423]=0;SidPlayer.driver[424]=0;SidPlayer.driver[425]=0;SidPlayer.driver[426]=0;SidPlayer.driver[427]=0;SidPlayer.driver[428]=0;SidPlayer.driver[429]=0;SidPlayer.driver[430]=0;SidPlayer.driver[431]=0;SidPlayer.driver[432]=0;SidPlayer.driver[433]=0;SidPlayer.driver[434]=0;SidPlayer.driver[435]=0;SidPlayer.driver[436]=0;SidPlayer.driver[437]=0;SidPlayer.driver[438]=0;SidPlayer.driver[439]=0;SidPlayer.driver[440]=0;SidPlayer.driver[441]=0;SidPlayer.driver[442]=0;SidPlayer.driver[443]=0;SidPlayer.driver[444]=0;SidPlayer.driver[445]=0;SidPlayer.driver[446]=0;SidPlayer.driver[447]=0;SidPlayer.driver[448]=0;SidPlayer.driver[449]=0;SidPlayer.driver[450]=0;SidPlayer.driver[451]=0;SidPlayer.driver[452]=0;SidPlayer.driver[453]=0;SidPlayer.driver[454]=0;SidPlayer.driver[455]=0;SidPlayer.driver[456]=0;SidPlayer.driver[457]=0;SidPlayer.driver[458]=0;SidPlayer.driver[459]=0;SidPlayer.driver[460]=0;SidPlayer.driver[461]=0;SidPlayer.driver[462]=0;SidPlayer.driver[463]=0;SidPlayer.driver[464]=0;SidPlayer.driver[465]=0;SidPlayer.driver[466]=0;SidPlayer.driver[467]=0;SidPlayer.driver[468]=0;SidPlayer.driver[469]=0;SidPlayer.driver[470]=0;SidPlayer.driver[471]=0;SidPlayer.driver[472]=0;SidPlayer.driver[473]=0;SidPlayer.driver[474]=0;SidPlayer.driver[475]=0;SidPlayer.driver[476]=0;SidPlayer.driver[477]=0;SidPlayer.driver[478]=0;SidPlayer.driver[479]=0;SidPlayer.driver[480]=0;SidPlayer.driver[481]=0;SidPlayer.driver[482]=0;SidPlayer.driver[483]=0;SidPlayer.driver[484]=0;SidPlayer.driver[485]=0;SidPlayer.driver[486]=0;SidPlayer.driver[487]=0;SidPlayer.driver[488]=0;SidPlayer.driver[489]=0;SidPlayer.driver[490]=0;SidPlayer.driver[491]=0;SidPlayer.driver[492]=0;SidPlayer.driver[493]=0;SidPlayer.driver[494]=0;SidPlayer.driver[495]=0;SidPlayer.driver[496]=0;SidPlayer.driver[497]=0;SidPlayer.driver[498]=0;SidPlayer.driver[499]=0;SidPlayer.driver[500]=0;SidPlayer.driver[501]=0;SidPlayer.driver[502]=0;SidPlayer.driver[503]=0;SidPlayer.driver[504]=0;SidPlayer.driver[505]=0;SidPlayer.driver[506]=0;SidPlayer.driver[507]=0;SidPlayer.driver[508]=0;SidPlayer.driver[509]=0;SidPlayer.driver[510]=0;SidPlayer.driver[511]=0;SidPlayer.driver[512]=0;SidPlayer.driver[513]=0;SidPlayer.driver[514]=0;SidPlayer.driver[515]=0;SidPlayer.driver[516]=0;SidPlayer.driver[517]=0;SidPlayer.driver[518]=0;SidPlayer.driver[519]=0;SidPlayer.driver[520]=0;SidPlayer.driver[521]=0;SidPlayer.driver[522]=0;SidPlayer.driver[523]=0;SidPlayer.driver[524]=0;SidPlayer.driver[525]=0;SidPlayer.driver[526]=0;SidPlayer.driver[527]=0;SidPlayer.driver[528]=0;SidPlayer.driver[529]=0;SidPlayer.driver[530]=0;SidPlayer.driver[531]=0;SidPlayer.driver[532]=0;SidPlayer.driver[533]=0;SidPlayer.driver[534]=0;SidPlayer.driver[535]=0;SidPlayer.driver[536]=0;SidPlayer.driver[537]=0;SidPlayer.driver[538]=0;SidPlayer.driver[539]=0;SidPlayer.driver[540]=0;SidPlayer.driver[541]=0;SidPlayer.driver[542]=0;SidPlayer.driver[543]=0;SidPlayer.driver[544]=0;SidPlayer.driver[545]=0;SidPlayer.driver[546]=0;SidPlayer.driver[547]=0;SidPlayer.driver[548]=0;SidPlayer.driver[549]=0;SidPlayer.driver[550]=0;SidPlayer.driver[551]=0;SidPlayer.driver[552]=0;SidPlayer.driver[553]=0;SidPlayer.driver[554]=0;SidPlayer.driver[555]=0;SidPlayer.driver[556]=0;SidPlayer.driver[557]=0;SidPlayer.driver[558]=0;SidPlayer.driver[559]=0;SidPlayer.driver[560]=0;SidPlayer.driver[561]=0;SidPlayer.driver[562]=0;SidPlayer.driver[563]=0;SidPlayer.driver[564]=0;SidPlayer.driver[565]=0;SidPlayer.driver[566]=0;SidPlayer.driver[567]=0;SidPlayer.driver[568]=0;SidPlayer.driver[569]=0;SidPlayer.driver[570]=0;SidPlayer.driver[571]=0;SidPlayer.driver[572]=0;SidPlayer.driver[573]=0;SidPlayer.driver[574]=0;SidPlayer.driver[575]=0;SidPlayer.driver[576]=0;SidPlayer.driver[577]=0;SidPlayer.driver[578]=0;SidPlayer.driver[579]=0;SidPlayer.driver[580]=0;SidPlayer.driver[581]=0;SidPlayer.driver[582]=0;SidPlayer.driver[583]=0;SidPlayer.driver[584]=0;SidPlayer.driver[585]=0;SidPlayer.driver[586]=0;SidPlayer.driver[587]=0;SidPlayer.driver[588]=0;SidPlayer.driver[589]=0;SidPlayer.driver[590]=0;SidPlayer.driver[591]=0;SidPlayer.driver[592]=0;SidPlayer.driver[593]=0;SidPlayer.driver[594]=0;SidPlayer.driver[595]=0;SidPlayer.driver[596]=0;SidPlayer.driver[597]=0;SidPlayer.driver[598]=0;SidPlayer.driver[599]=0;SidPlayer.driver[600]=0;SidPlayer.driver[601]=0;SidPlayer.driver[602]=0;SidPlayer.driver[603]=0;SidPlayer.driver[604]=0;SidPlayer.driver[605]=0;SidPlayer.driver[606]=0;SidPlayer.driver[607]=0;SidPlayer.driver[608]=0;SidPlayer.driver[609]=0;SidPlayer.driver[610]=0;SidPlayer.driver[611]=0;SidPlayer.driver[612]=0;SidPlayer.driver[613]=0;SidPlayer.driver[614]=0;SidPlayer.driver[615]=0;SidPlayer.driver[616]=0;SidPlayer.driver[617]=0;SidPlayer.driver[618]=0;SidPlayer.driver[619]=0;SidPlayer.driver[620]=0;SidPlayer.driver[621]=0;SidPlayer.driver[622]=0;SidPlayer.driver[623]=0;SidPlayer.driver[624]=0;SidPlayer.driver[625]=0;SidPlayer.driver[626]=0;SidPlayer.driver[627]=0;SidPlayer.driver[628]=0;SidPlayer.driver[629]=0;SidPlayer.driver[630]=0;SidPlayer.driver[631]=0;SidPlayer.driver[632]=0;SidPlayer.driver[633]=0;SidPlayer.driver[634]=0;SidPlayer.driver[635]=0;SidPlayer.driver[636]=0;SidPlayer.driver[637]=0;SidPlayer.driver[638]=0;SidPlayer.driver[639]=0;SidPlayer.driver[640]=0;SidPlayer.driver[641]=0;SidPlayer.driver[642]=0;SidPlayer.driver[643]=0;SidPlayer.driver[644]=0;SidPlayer.driver[645]=0;SidPlayer.driver[646]=0;SidPlayer.driver[647]=0;SidPlayer.driver[648]=0;SidPlayer.driver[649]=0;SidPlayer.driver[650]=0;SidPlayer.driver[651]=0;SidPlayer.driver[652]=0;SidPlayer.driver[653]=0;SidPlayer.driver[654]=0;SidPlayer.driver[655]=0;SidPlayer.driver[656]=0;SidPlayer.driver[657]=0;SidPlayer.driver[658]=0;SidPlayer.driver[659]=0;SidPlayer.driver[660]=0;SidPlayer.driver[661]=0;SidPlayer.driver[662]=0;SidPlayer.driver[663]=0;SidPlayer.driver[664]=0;SidPlayer.driver[665]=0;SidPlayer.driver[666]=0;SidPlayer.driver[667]=0;SidPlayer.driver[668]=0;SidPlayer.driver[669]=0;SidPlayer.driver[670]=0;SidPlayer.driver[671]=0;SidPlayer.driver[672]=0;SidPlayer.driver[673]=0;SidPlayer.driver[674]=0;SidPlayer.driver[675]=0;SidPlayer.driver[676]=0;SidPlayer.driver[677]=0;SidPlayer.driver[678]=0;SidPlayer.driver[679]=0;SidPlayer.driver[680]=0;SidPlayer.driver[681]=0;SidPlayer.driver[682]=0;SidPlayer.driver[683]=0;SidPlayer.driver[684]=0;SidPlayer.driver[685]=0;SidPlayer.driver[686]=0;SidPlayer.driver[687]=0;SidPlayer.driver[688]=0;SidPlayer.driver[689]=0;SidPlayer.driver[690]=0;SidPlayer.driver[691]=0;SidPlayer.driver[692]=0;SidPlayer.driver[693]=0;SidPlayer.driver[694]=0;SidPlayer.driver[695]=0;SidPlayer.driver[696]=0;SidPlayer.driver[697]=0;SidPlayer.driver[698]=0;SidPlayer.driver[699]=0;SidPlayer.driver[700]=0;SidPlayer.driver[701]=0;SidPlayer.driver[702]=0;SidPlayer.driver[703]=0;SidPlayer.driver[704]=0;SidPlayer.driver[705]=0;SidPlayer.driver[706]=0;SidPlayer.driver[707]=0;SidPlayer.driver[708]=0;SidPlayer.driver[709]=0;SidPlayer.driver[710]=0;SidPlayer.driver[711]=0;SidPlayer.driver[712]=0;SidPlayer.driver[713]=0;SidPlayer.driver[714]=0;SidPlayer.driver[715]=0;SidPlayer.driver[716]=0;SidPlayer.driver[717]=0;SidPlayer.driver[718]=0;SidPlayer.driver[719]=0;SidPlayer.driver[720]=0;SidPlayer.driver[721]=0;SidPlayer.driver[722]=0;SidPlayer.driver[723]=0;SidPlayer.driver[724]=0;SidPlayer.driver[725]=0;SidPlayer.driver[726]=0;SidPlayer.driver[727]=0;SidPlayer.driver[728]=0;SidPlayer.driver[729]=0;SidPlayer.driver[730]=0;SidPlayer.driver[731]=0;SidPlayer.driver[732]=0;SidPlayer.driver[733]=0;SidPlayer.driver[734]=0;SidPlayer.driver[735]=0;SidPlayer.driver[736]=0;SidPlayer.driver[737]=0;SidPlayer.driver[738]=0;SidPlayer.driver[739]=0;SidPlayer.driver[740]=0;SidPlayer.driver[741]=0;SidPlayer.driver[742]=0;SidPlayer.driver[743]=0;SidPlayer.driver[744]=0;SidPlayer.driver[745]=0;SidPlayer.driver[746]=0;SidPlayer.driver[747]=0;SidPlayer.driver[748]=0;SidPlayer.driver[749]=0;SidPlayer.driver[750]=0;SidPlayer.driver[751]=0;SidPlayer.driver[752]=0;SidPlayer.driver[753]=0;SidPlayer.driver[754]=0;SidPlayer.driver[755]=0;SidPlayer.driver[756]=0;SidPlayer.driver[757]=0;SidPlayer.driver[758]=0;SidPlayer.driver[759]=0;SidPlayer.driver[760]=0;SidPlayer.driver[761]=0;SidPlayer.driver[762]=0;SidPlayer.driver[763]=0;SidPlayer.driver[764]=0;SidPlayer.driver[765]=0;SidPlayer.driver[766]=0;SidPlayer.driver[767]=0;SidPlayer.driver[768]=0;SidPlayer.driver[769]=0;SidPlayer.driver[770]=0;SidPlayer.driver[771]=0;SidPlayer.driver[772]=0;SidPlayer.driver[773]=0;SidPlayer.driver[774]=0;SidPlayer.driver[775]=0;SidPlayer.driver[776]=0;SidPlayer.driver[777]=0;SidPlayer.driver[778]=0;SidPlayer.driver[779]=0;SidPlayer.driver[780]=0;SidPlayer.driver[781]=0;SidPlayer.driver[782]=0;SidPlayer.driver[783]=0;SidPlayer.driver[784]=0;SidPlayer.driver[785]=0;SidPlayer.driver[786]=0;SidPlayer.driver[787]=0;SidPlayer.driver[788]=0;SidPlayer.driver[789]=0;SidPlayer.driver[790]=0;SidPlayer.driver[791]=0;SidPlayer.driver[792]=0;SidPlayer.driver[793]=0;SidPlayer.driver[794]=0;SidPlayer.driver[795]=0;SidPlayer.driver[796]=0;SidPlayer.driver[797]=0;SidPlayer.driver[798]=0;SidPlayer.driver[799]=0;SidPlayer.driver[800]=0;SidPlayer.driver[801]=0;SidPlayer.driver[802]=0;SidPlayer.driver[803]=0;SidPlayer.driver[804]=0;SidPlayer.driver[805]=0;SidPlayer.driver[806]=0;SidPlayer.driver[807]=0;SidPlayer.driver[808]=0;SidPlayer.driver[809]=0;SidPlayer.driver[810]=0;SidPlayer.driver[811]=0;SidPlayer.driver[812]=0;SidPlayer.driver[813]=0;SidPlayer.driver[814]=0;SidPlayer.driver[815]=0;SidPlayer.driver[816]=0;SidPlayer.driver[817]=0;SidPlayer.driver[818]=0;SidPlayer.driver[819]=0;SidPlayer.driver[820]=0;SidPlayer.driver[821]=0;SidPlayer.driver[822]=0;SidPlayer.driver[823]=0;SidPlayer.driver[824]=0;SidPlayer.driver[825]=0;SidPlayer.driver[826]=0;SidPlayer.driver[827]=0;SidPlayer.driver[828]=0;SidPlayer.driver[829]=0;SidPlayer.driver[830]=0;SidPlayer.driver[831]=0;SidPlayer.driver[832]=0;SidPlayer.driver[833]=0;SidPlayer.driver[834]=0;SidPlayer.driver[835]=0;SidPlayer.driver[836]=0;SidPlayer.driver[837]=0;SidPlayer.driver[838]=0;SidPlayer.driver[839]=0;SidPlayer.driver[840]=0;SidPlayer.driver[841]=0;SidPlayer.driver[842]=0;SidPlayer.driver[843]=0;SidPlayer.driver[844]=0;SidPlayer.driver[845]=0;SidPlayer.driver[846]=0;SidPlayer.driver[847]=0;SidPlayer.driver[848]=0;SidPlayer.driver[849]=0;SidPlayer.driver[850]=0;SidPlayer.driver[851]=0;SidPlayer.driver[852]=0;SidPlayer.driver[853]=0;SidPlayer.driver[854]=0;SidPlayer.driver[855]=0;SidPlayer.driver[856]=0;SidPlayer.driver[857]=0;SidPlayer.driver[858]=0;SidPlayer.driver[859]=0;SidPlayer.driver[860]=0;SidPlayer.driver[861]=0;SidPlayer.driver[862]=0;SidPlayer.driver[863]=0;SidPlayer.driver[864]=0;SidPlayer.driver[865]=0;SidPlayer.driver[866]=0;SidPlayer.driver[867]=0;SidPlayer.driver[868]=0;SidPlayer.driver[869]=0;SidPlayer.driver[870]=0;SidPlayer.driver[871]=0;SidPlayer.driver[872]=0;SidPlayer.driver[873]=0;SidPlayer.driver[874]=0;SidPlayer.driver[875]=0;SidPlayer.driver[876]=0;SidPlayer.driver[877]=0;SidPlayer.driver[878]=0;SidPlayer.driver[879]=0;SidPlayer.driver[880]=0;SidPlayer.driver[881]=0;SidPlayer.driver[882]=0;SidPlayer.driver[883]=0;SidPlayer.driver[884]=0;SidPlayer.driver[885]=0;SidPlayer.driver[886]=0;SidPlayer.driver[887]=0;SidPlayer.driver[888]=0;SidPlayer.driver[889]=0;SidPlayer.driver[890]=0;SidPlayer.driver[891]=0;SidPlayer.driver[892]=0;SidPlayer.driver[893]=0;SidPlayer.driver[894]=0;SidPlayer.driver[895]=0;SidPlayer.driver[896]=0;SidPlayer.driver[897]=0;SidPlayer.driver[898]=0;SidPlayer.driver[899]=0;SidPlayer.driver[900]=0;SidPlayer.driver[901]=0;SidPlayer.driver[902]=0;SidPlayer.driver[903]=0;SidPlayer.driver[904]=0;SidPlayer.driver[905]=0;SidPlayer.driver[906]=0;SidPlayer.driver[907]=0;SidPlayer.driver[908]=0;SidPlayer.driver[909]=0;SidPlayer.driver[910]=0;SidPlayer.driver[911]=0;SidPlayer.driver[912]=0;SidPlayer.driver[913]=0;SidPlayer.driver[914]=0;SidPlayer.driver[915]=0;SidPlayer.driver[916]=0;SidPlayer.driver[917]=0;SidPlayer.driver[918]=0;SidPlayer.driver[919]=0;SidPlayer.driver[920]=0;SidPlayer.driver[921]=0;SidPlayer.driver[922]=0;SidPlayer.driver[923]=0;SidPlayer.driver[924]=0;SidPlayer.driver[925]=0;SidPlayer.driver[926]=0;SidPlayer.driver[927]=0;SidPlayer.driver[928]=0;SidPlayer.driver[929]=0;SidPlayer.driver[930]=0;SidPlayer.driver[931]=0;SidPlayer.driver[932]=0;SidPlayer.driver[933]=0;SidPlayer.driver[934]=0;SidPlayer.driver[935]=0;SidPlayer.driver[936]=0;SidPlayer.driver[937]=0;SidPlayer.driver[938]=0;SidPlayer.driver[939]=0;SidPlayer.driver[940]=0;SidPlayer.driver[941]=0;SidPlayer.driver[942]=0;SidPlayer.driver[943]=0;SidPlayer.driver[944]=0;SidPlayer.driver[945]=0;SidPlayer.driver[946]=0;SidPlayer.driver[947]=0;SidPlayer.driver[948]=0;SidPlayer.driver[949]=0;SidPlayer.driver[950]=0;SidPlayer.driver[951]=0;SidPlayer.driver[952]=0;SidPlayer.driver[953]=0;SidPlayer.driver[954]=0;SidPlayer.driver[955]=0;SidPlayer.driver[956]=0;SidPlayer.driver[957]=0;SidPlayer.driver[958]=0;SidPlayer.driver[959]=0;SidPlayer.driver[960]=0;SidPlayer.driver[961]=0;SidPlayer.driver[962]=0;SidPlayer.driver[963]=0;SidPlayer.driver[964]=0;SidPlayer.driver[965]=0;SidPlayer.driver[966]=0;SidPlayer.driver[967]=0;SidPlayer.driver[968]=0;SidPlayer.driver[969]=0;SidPlayer.driver[970]=0;SidPlayer.driver[971]=0;SidPlayer.driver[972]=0;SidPlayer.driver[973]=0;SidPlayer.driver[974]=0;SidPlayer.driver[975]=0;SidPlayer.driver[976]=0;SidPlayer.driver[977]=0;SidPlayer.driver[978]=0;SidPlayer.driver[979]=0;SidPlayer.driver[980]=0;SidPlayer.driver[981]=0;SidPlayer.driver[982]=0;SidPlayer.driver[983]=0;SidPlayer.driver[984]=0;SidPlayer.driver[985]=0;SidPlayer.driver[986]=0;SidPlayer.driver[987]=0;SidPlayer.driver[988]=0;SidPlayer.driver[989]=0;SidPlayer.driver[990]=0;SidPlayer.driver[991]=0;SidPlayer.driver[992]=0;SidPlayer.driver[993]=0;SidPlayer.driver[994]=0;SidPlayer.driver[995]=0;SidPlayer.driver[996]=0;SidPlayer.driver[997]=0;SidPlayer.driver[998]=0;SidPlayer.driver[999]=0;SidPlayer.driver[1e3]=0;SidPlayer.driver[1001]=0;SidPlayer.driver[1002]=0;SidPlayer.driver[1003]=0;SidPlayer.driver[1004]=0;SidPlayer.driver[1005]=0;SidPlayer.driver[1006]=0;SidPlayer.driver[1007]=0;SidPlayer.driver[1008]=0;SidPlayer.driver[1009]=0;SidPlayer.driver[1010]=0;SidPlayer.driver[1011]=0;SidPlayer.driver[1012]=0;SidPlayer.driver[1013]=0;SidPlayer.driver[1014]=0;SidPlayer.driver[1015]=0;SidPlayer.driver[1016]=0;SidPlayer.driver[1017]=0;SidPlayer.driver[1018]=0;SidPlayer.driver[1019]=0;SidPlayer.driver[1020]=0;SidPlayer.driver[1021]=0;SidPlayer.driver[1022]=0;SidPlayer.driver[1023]=0;SidPlayer.driver[1024]=0;SidPlayer.driver[1025]=169;SidPlayer.driver[1026]=3;SidPlayer.driver[1027]=141;SidPlayer.driver[1028]=32;SidPlayer.driver[1029]=208;SidPlayer.driver[1030]=120;SidPlayer.driver[1031]=169;SidPlayer.driver[1032]=48;SidPlayer.driver[1033]=162;SidPlayer.driver[1034]=12;SidPlayer.driver[1035]=141;SidPlayer.driver[1036]=20;SidPlayer.driver[1037]=3;SidPlayer.driver[1038]=142;SidPlayer.driver[1039]=21;SidPlayer.driver[1040]=3;SidPlayer.driver[1041]=169;SidPlayer.driver[1042]=27;SidPlayer.driver[1043]=162;SidPlayer.driver[1044]=0;SidPlayer.driver[1045]=160;SidPlayer.driver[1046]=127;SidPlayer.driver[1047]=141;SidPlayer.driver[1048]=17;SidPlayer.driver[1049]=208;SidPlayer.driver[1050]=142;SidPlayer.driver[1051]=18;SidPlayer.driver[1052]=208;SidPlayer.driver[1053]=140;SidPlayer.driver[1054]=13;SidPlayer.driver[1055]=220;SidPlayer.driver[1056]=169;SidPlayer.driver[1057]=1;SidPlayer.driver[1058]=141;SidPlayer.driver[1059]=26;SidPlayer.driver[1060]=208;SidPlayer.driver[1061]=141;SidPlayer.driver[1062]=25;SidPlayer.driver[1063]=208;SidPlayer.driver[1064]=169;SidPlayer.driver[1065]=0;SidPlayer.driver[1066]=32;SidPlayer.driver[1067]=0;SidPlayer.driver[1068]=16;SidPlayer.driver[1069]=88;SidPlayer.driver[1070]=76;SidPlayer.driver[1071]=45;SidPlayer.driver[1072]=12;SidPlayer.driver[1073]=169;SidPlayer.driver[1074]=1;SidPlayer.driver[1075]=141;SidPlayer.driver[1076]=25;SidPlayer.driver[1077]=208;SidPlayer.driver[1078]=169;SidPlayer.driver[1079]=9;SidPlayer.driver[1080]=141;SidPlayer.driver[1081]=32;SidPlayer.driver[1082]=208;SidPlayer.driver[1083]=32;SidPlayer.driver[1084]=3;SidPlayer.driver[1085]=16;SidPlayer.driver[1086]=169;SidPlayer.driver[1087]=10;SidPlayer.driver[1088]=141;SidPlayer.driver[1089]=32;SidPlayer.driver[1090]=208;SidPlayer.driver[1091]=76;SidPlayer.driver[1092]=49;SidPlayer.driver[1093]=234;SidPlayer.driver[1094]=0;SidPlayer.driver[1095]=0;SidPlayer.driver[1096]=0;SidPlayer.driver[1097]=0;SidPlayer.driver[1098]=0;SidPlayer.driver[1099]=0;SidPlayer.driver[1100]=0;SidPlayer.driver[1101]=0;SidPlayer.driver[1102]=0;SidPlayer.driver[1103]=0;SidPlayer.driver[1104]=0;SidPlayer.driver[1105]=0;SidPlayer.driver[1106]=0;SidPlayer.driver[1107]=0;SidPlayer.driver[1108]=0;SidPlayer.driver[1109]=0;SidPlayer.driver[1110]=0;SidPlayer.driver[1111]=0;SidPlayer.driver[1112]=0;SidPlayer.driver[1113]=0;SidPlayer.driver[1114]=0;SidPlayer.driver[1115]=0;SidPlayer.driver[1116]=0;SidPlayer.driver[1117]=0;SidPlayer.driver[1118]=0;SidPlayer.driver[1119]=0;SidPlayer.driver[1120]=0;SidPlayer.driver[1121]=0;SidPlayer.driver[1122]=0;SidPlayer.driver[1123]=0;SidPlayer.driver[1124]=0;SidPlayer.driver[1125]=0;SidPlayer.driver[1126]=0;SidPlayer.driver[1127]=0;SidPlayer.driver[1128]=0;SidPlayer.driver[1129]=0;SidPlayer.driver[1130]=0;SidPlayer.driver[1131]=0;SidPlayer.driver[1132]=0;SidPlayer.driver[1133]=0;SidPlayer.driver[1134]=0;SidPlayer.driver[1135]=0;SidPlayer.driver[1136]=0;SidPlayer.driver[1137]=0;SidPlayer.driver[1138]=0;SidPlayer.driver[1139]=0;SidPlayer.driver[1140]=0;SidPlayer.driver[1141]=0;SidPlayer.driver[1142]=0;SidPlayer.driver[1143]=0;SidPlayer.driver[1144]=0;SidPlayer.driver[1145]=0;SidPlayer.driver[1146]=0;SidPlayer.driver[1147]=0;SidPlayer.driver[1148]=0;SidPlayer.driver[1149]=0;SidPlayer.driver[1150]=0;SidPlayer.driver[1151]=0;SidPlayer.driver[1152]=0;SidPlayer.driver[1153]=0;SidPlayer.driver[1154]=0;SidPlayer.driver[1155]=0;SidPlayer.driver[1156]=0;SidPlayer.driver[1157]=0;SidPlayer.driver[1158]=0;SidPlayer.driver[1159]=0;SidPlayer.driver[1160]=0;SidPlayer.driver[1161]=0;SidPlayer.driver[1162]=0;SidPlayer.driver[1163]=0;SidPlayer.driver[1164]=0;SidPlayer.driver[1165]=0;SidPlayer.driver[1166]=0;SidPlayer.driver[1167]=0;SidPlayer.driver[1168]=0;SidPlayer.driver[1169]=0;SidPlayer.driver[1170]=0;SidPlayer.driver[1171]=0;SidPlayer.driver[1172]=0;SidPlayer.driver[1173]=0;SidPlayer.driver[1174]=0;SidPlayer.driver[1175]=0;SidPlayer.driver[1176]=0;SidPlayer.driver[1177]=0;SidPlayer.driver[1178]=0;SidPlayer.driver[1179]=0;SidPlayer.driver[1180]=0;SidPlayer.driver[1181]=0;SidPlayer.driver[1182]=0;SidPlayer.driver[1183]=0;SidPlayer.driver[1184]=0;SidPlayer.driver[1185]=0;SidPlayer.driver[1186]=0;SidPlayer.driver[1187]=0;SidPlayer.driver[1188]=0;SidPlayer.driver[1189]=0;SidPlayer.driver[1190]=0;SidPlayer.driver[1191]=0;SidPlayer.driver[1192]=0;SidPlayer.driver[1193]=0;SidPlayer.driver[1194]=0;SidPlayer.driver[1195]=0;SidPlayer.driver[1196]=0;SidPlayer.driver[1197]=0;SidPlayer.driver[1198]=0;SidPlayer.driver[1199]=0;SidPlayer.driver[1200]=0;SidPlayer.driver[1201]=0;SidPlayer.driver[1202]=0;SidPlayer.driver[1203]=0;SidPlayer.driver[1204]=0;SidPlayer.driver[1205]=0;SidPlayer.driver[1206]=0;SidPlayer.driver[1207]=0;SidPlayer.driver[1208]=0;SidPlayer.driver[1209]=0;SidPlayer.driver[1210]=0;SidPlayer.driver[1211]=0;SidPlayer.driver[1212]=0;SidPlayer.driver[1213]=0;SidPlayer.driver[1214]=0;SidPlayer.driver[1215]=0;SidPlayer.driver[1216]=0;SidPlayer.driver[1217]=0;SidPlayer.driver[1218]=0;SidPlayer.driver[1219]=0;SidPlayer.driver[1220]=0;SidPlayer.driver[1221]=0;SidPlayer.driver[1222]=0;SidPlayer.driver[1223]=0;SidPlayer.driver[1224]=0;SidPlayer.driver[1225]=0;SidPlayer.driver[1226]=0;SidPlayer.driver[1227]=0;SidPlayer.driver[1228]=0;SidPlayer.driver[1229]=0;SidPlayer.driver[1230]=0;SidPlayer.driver[1231]=0;SidPlayer.driver[1232]=0;SidPlayer.driver[1233]=0;SidPlayer.driver[1234]=0;SidPlayer.driver[1235]=0;SidPlayer.driver[1236]=0;SidPlayer.driver[1237]=0;SidPlayer.driver[1238]=0;SidPlayer.driver[1239]=0;SidPlayer.driver[1240]=0;SidPlayer.driver[1241]=0;SidPlayer.driver[1242]=0;SidPlayer.driver[1243]=0;SidPlayer.driver[1244]=0;SidPlayer.driver[1245]=0;SidPlayer.driver[1246]=0;SidPlayer.driver[1247]=0;SidPlayer.driver[1248]=0;SidPlayer.driver[1249]=0;SidPlayer.driver[1250]=0;SidPlayer.driver[1251]=0;SidPlayer.driver[1252]=0;SidPlayer.driver[1253]=0;SidPlayer.driver[1254]=0;SidPlayer.driver[1255]=0;SidPlayer.driver[1256]=0;SidPlayer.driver[1257]=0;SidPlayer.driver[1258]=0;SidPlayer.driver[1259]=0;SidPlayer.driver[1260]=0;SidPlayer.driver[1261]=0;SidPlayer.driver[1262]=0;SidPlayer.driver[1263]=0;SidPlayer.driver[1264]=0;SidPlayer.driver[1265]=0;SidPlayer.driver[1266]=0;SidPlayer.driver[1267]=0;SidPlayer.driver[1268]=0;SidPlayer.driver[1269]=0;SidPlayer.driver[1270]=0;SidPlayer.driver[1271]=0;SidPlayer.driver[1272]=0;SidPlayer.driver[1273]=0;SidPlayer.driver[1274]=0;SidPlayer.driver[1275]=0;SidPlayer.driver[1276]=0;SidPlayer.driver[1277]=0;SidPlayer.driver[1278]=0;SidPlayer.driver[1279]=0;SidPlayer.driver[1280]=0;SidPlayer.driver[1281]=0;SidPlayer.driver[1282]=0;SidPlayer.driver[1283]=0;SidPlayer.driver[1284]=0;SidPlayer.driver[1285]=0;SidPlayer.driver[1286]=0;SidPlayer.driver[1287]=0;SidPlayer.driver[1288]=0;SidPlayer.driver[1289]=0;SidPlayer.driver[1290]=0;SidPlayer.driver[1291]=0;SidPlayer.driver[1292]=0;SidPlayer.driver[1293]=0;SidPlayer.driver[1294]=0;SidPlayer.driver[1295]=0;SidPlayer.driver[1296]=0;SidPlayer.driver[1297]=0;SidPlayer.driver[1298]=0;SidPlayer.driver[1299]=0;SidPlayer.driver[1300]=0;SidPlayer.driver[1301]=0;SidPlayer.driver[1302]=0;SidPlayer.driver[1303]=0;SidPlayer.driver[1304]=0;SidPlayer.driver[1305]=0;SidPlayer.driver[1306]=0;SidPlayer.driver[1307]=0;SidPlayer.driver[1308]=0;SidPlayer.driver[1309]=0;SidPlayer.driver[1310]=0;SidPlayer.driver[1311]=0;SidPlayer.driver[1312]=0;SidPlayer.driver[1313]=0;SidPlayer.driver[1314]=0;SidPlayer.driver[1315]=0;SidPlayer.driver[1316]=0;SidPlayer.driver[1317]=0;SidPlayer.driver[1318]=0;SidPlayer.driver[1319]=0;SidPlayer.driver[1320]=0;SidPlayer.driver[1321]=0;SidPlayer.driver[1322]=0;SidPlayer.driver[1323]=0;SidPlayer.driver[1324]=0;SidPlayer.driver[1325]=0;SidPlayer.driver[1326]=0;SidPlayer.driver[1327]=0;SidPlayer.driver[1328]=0;SidPlayer.driver[1329]=0;SidPlayer.driver[1330]=0;SidPlayer.driver[1331]=0;SidPlayer.driver[1332]=0;SidPlayer.driver[1333]=0;SidPlayer.driver[1334]=0;SidPlayer.driver[1335]=0;SidPlayer.driver[1336]=0;SidPlayer.driver[1337]=0;SidPlayer.driver[1338]=0;SidPlayer.driver[1339]=0;SidPlayer.driver[1340]=0;SidPlayer.driver[1341]=0;SidPlayer.driver[1342]=0;SidPlayer.driver[1343]=0;SidPlayer.driver[1344]=0;SidPlayer.driver[1345]=0;SidPlayer.driver[1346]=0;SidPlayer.driver[1347]=0;SidPlayer.driver[1348]=0;SidPlayer.driver[1349]=0;SidPlayer.driver[1350]=0;SidPlayer.driver[1351]=0;SidPlayer.driver[1352]=0;SidPlayer.driver[1353]=0;SidPlayer.driver[1354]=0;SidPlayer.driver[1355]=0;SidPlayer.driver[1356]=0;SidPlayer.driver[1357]=0;SidPlayer.driver[1358]=0;SidPlayer.driver[1359]=0;SidPlayer.driver[1360]=0;SidPlayer.driver[1361]=0;SidPlayer.driver[1362]=0;SidPlayer.driver[1363]=0;SidPlayer.driver[1364]=0;SidPlayer.driver[1365]=0;SidPlayer.driver[1366]=0;SidPlayer.driver[1367]=0;SidPlayer.driver[1368]=0;SidPlayer.driver[1369]=0;SidPlayer.driver[1370]=0;SidPlayer.driver[1371]=0;SidPlayer.driver[1372]=0;SidPlayer.driver[1373]=0;SidPlayer.driver[1374]=0;SidPlayer.driver[1375]=0;SidPlayer.driver[1376]=0;SidPlayer.driver[1377]=0;SidPlayer.driver[1378]=0;SidPlayer.driver[1379]=0;SidPlayer.driver[1380]=0;SidPlayer.driver[1381]=0;SidPlayer.driver[1382]=0;SidPlayer.driver[1383]=0;SidPlayer.driver[1384]=0;SidPlayer.driver[1385]=0;SidPlayer.driver[1386]=0;SidPlayer.driver[1387]=0;SidPlayer.driver[1388]=0;SidPlayer.driver[1389]=0;SidPlayer.driver[1390]=0;SidPlayer.driver[1391]=0;SidPlayer.driver[1392]=0;SidPlayer.driver[1393]=0;SidPlayer.driver[1394]=0;SidPlayer.driver[1395]=0;SidPlayer.driver[1396]=0;SidPlayer.driver[1397]=0;SidPlayer.driver[1398]=0;SidPlayer.driver[1399]=0;SidPlayer.driver[1400]=0;SidPlayer.driver[1401]=0;SidPlayer.driver[1402]=0;SidPlayer.driver[1403]=0;SidPlayer.driver[1404]=0;SidPlayer.driver[1405]=0;SidPlayer.driver[1406]=0;SidPlayer.driver[1407]=0;SidPlayer.driver[1408]=0;SidPlayer.driver[1409]=0;SidPlayer.driver[1410]=0;SidPlayer.driver[1411]=0;SidPlayer.driver[1412]=0;SidPlayer.driver[1413]=0;SidPlayer.driver[1414]=0;SidPlayer.driver[1415]=0;SidPlayer.driver[1416]=0;SidPlayer.driver[1417]=0;SidPlayer.driver[1418]=0;SidPlayer.driver[1419]=0;SidPlayer.driver[1420]=0;SidPlayer.driver[1421]=0;SidPlayer.driver[1422]=0;SidPlayer.driver[1423]=0;SidPlayer.driver[1424]=0;SidPlayer.driver[1425]=0;SidPlayer.driver[1426]=0;SidPlayer.driver[1427]=0;SidPlayer.driver[1428]=0;SidPlayer.driver[1429]=0;SidPlayer.driver[1430]=0;SidPlayer.driver[1431]=0;SidPlayer.driver[1432]=0;SidPlayer.driver[1433]=0;SidPlayer.driver[1434]=0;SidPlayer.driver[1435]=0;SidPlayer.driver[1436]=0;SidPlayer.driver[1437]=0;SidPlayer.driver[1438]=0;SidPlayer.driver[1439]=0;SidPlayer.driver[1440]=0;SidPlayer.driver[1441]=0;SidPlayer.driver[1442]=0;SidPlayer.driver[1443]=0;SidPlayer.driver[1444]=0;SidPlayer.driver[1445]=0;SidPlayer.driver[1446]=0;SidPlayer.driver[1447]=0;SidPlayer.driver[1448]=0;SidPlayer.driver[1449]=0;SidPlayer.driver[1450]=0;SidPlayer.driver[1451]=0;SidPlayer.driver[1452]=0;SidPlayer.driver[1453]=0;SidPlayer.driver[1454]=0;SidPlayer.driver[1455]=0;SidPlayer.driver[1456]=0;SidPlayer.driver[1457]=0;SidPlayer.driver[1458]=0;SidPlayer.driver[1459]=0;SidPlayer.driver[1460]=0;SidPlayer.driver[1461]=0;SidPlayer.driver[1462]=0;SidPlayer.driver[1463]=0;SidPlayer.driver[1464]=0;SidPlayer.driver[1465]=0;SidPlayer.driver[1466]=0;SidPlayer.driver[1467]=0;SidPlayer.driver[1468]=0;SidPlayer.driver[1469]=0;SidPlayer.driver[1470]=0;SidPlayer.driver[1471]=0;SidPlayer.driver[1472]=0;SidPlayer.driver[1473]=0;SidPlayer.driver[1474]=0;SidPlayer.driver[1475]=0;SidPlayer.driver[1476]=0;SidPlayer.driver[1477]=0;SidPlayer.driver[1478]=0;SidPlayer.driver[1479]=0;SidPlayer.driver[1480]=0;SidPlayer.driver[1481]=0;SidPlayer.driver[1482]=0;SidPlayer.driver[1483]=0;SidPlayer.driver[1484]=0;SidPlayer.driver[1485]=0;SidPlayer.driver[1486]=0;SidPlayer.driver[1487]=0;SidPlayer.driver[1488]=0;SidPlayer.driver[1489]=0;SidPlayer.driver[1490]=0;SidPlayer.driver[1491]=0;SidPlayer.driver[1492]=0;SidPlayer.driver[1493]=0;SidPlayer.driver[1494]=0;SidPlayer.driver[1495]=0;SidPlayer.driver[1496]=0;SidPlayer.driver[1497]=0;SidPlayer.driver[1498]=0;SidPlayer.driver[1499]=0;SidPlayer.driver[1500]=0;SidPlayer.driver[1501]=0;SidPlayer.driver[1502]=0;SidPlayer.driver[1503]=0;SidPlayer.driver[1504]=0;SidPlayer.driver[1505]=0;SidPlayer.driver[1506]=0;SidPlayer.driver[1507]=0;SidPlayer.driver[1508]=0;SidPlayer.driver[1509]=0;SidPlayer.driver[1510]=0;SidPlayer.driver[1511]=0;SidPlayer.driver[1512]=0;SidPlayer.driver[1513]=0;SidPlayer.driver[1514]=0;SidPlayer.driver[1515]=0;SidPlayer.driver[1516]=0;SidPlayer.driver[1517]=0;SidPlayer.driver[1518]=0;SidPlayer.driver[1519]=0;SidPlayer.driver[1520]=0;SidPlayer.driver[1521]=0;SidPlayer.driver[1522]=0;SidPlayer.driver[1523]=0;SidPlayer.driver[1524]=0;SidPlayer.driver[1525]=0;SidPlayer.driver[1526]=0;SidPlayer.driver[1527]=0;SidPlayer.driver[1528]=0;SidPlayer.driver[1529]=0;SidPlayer.driver[1530]=0;SidPlayer.driver[1531]=0;SidPlayer.driver[1532]=0;SidPlayer.driver[1533]=0;SidPlayer.driver[1534]=0;SidPlayer.driver[1535]=0;SidPlayer.driver[1536]=0;SidPlayer.driver[1537]=0;SidPlayer.driver[1538]=0;SidPlayer.driver[1539]=0;SidPlayer.driver[1540]=0;SidPlayer.driver[1541]=0;SidPlayer.driver[1542]=0;SidPlayer.driver[1543]=0;SidPlayer.driver[1544]=0;SidPlayer.driver[1545]=0;SidPlayer.driver[1546]=0;SidPlayer.driver[1547]=0;SidPlayer.driver[1548]=0;SidPlayer.driver[1549]=0;SidPlayer.driver[1550]=0;SidPlayer.driver[1551]=0;SidPlayer.driver[1552]=0;SidPlayer.driver[1553]=0;SidPlayer.driver[1554]=0;SidPlayer.driver[1555]=0;SidPlayer.driver[1556]=0;SidPlayer.driver[1557]=0;SidPlayer.driver[1558]=0;SidPlayer.driver[1559]=0;SidPlayer.driver[1560]=0;SidPlayer.driver[1561]=0;SidPlayer.driver[1562]=0;SidPlayer.driver[1563]=0;SidPlayer.driver[1564]=0;SidPlayer.driver[1565]=0;SidPlayer.driver[1566]=0;SidPlayer.driver[1567]=0;SidPlayer.driver[1568]=0;SidPlayer.driver[1569]=0;SidPlayer.driver[1570]=0;SidPlayer.driver[1571]=0;SidPlayer.driver[1572]=0;SidPlayer.driver[1573]=0;SidPlayer.driver[1574]=0;SidPlayer.driver[1575]=0;SidPlayer.driver[1576]=0;SidPlayer.driver[1577]=0;SidPlayer.driver[1578]=0;SidPlayer.driver[1579]=0;SidPlayer.driver[1580]=0;SidPlayer.driver[1581]=0;SidPlayer.driver[1582]=0;SidPlayer.driver[1583]=0;SidPlayer.driver[1584]=0;SidPlayer.driver[1585]=0;SidPlayer.driver[1586]=0;SidPlayer.driver[1587]=0;SidPlayer.driver[1588]=0;SidPlayer.driver[1589]=0;SidPlayer.driver[1590]=0;SidPlayer.driver[1591]=0;SidPlayer.driver[1592]=0;SidPlayer.driver[1593]=0;SidPlayer.driver[1594]=0;SidPlayer.driver[1595]=0;SidPlayer.driver[1596]=0;SidPlayer.driver[1597]=0;SidPlayer.driver[1598]=0;SidPlayer.driver[1599]=0;SidPlayer.driver[1600]=0;SidPlayer.driver[1601]=0;SidPlayer.driver[1602]=0;SidPlayer.driver[1603]=0;SidPlayer.driver[1604]=0;SidPlayer.driver[1605]=0;SidPlayer.driver[1606]=0;SidPlayer.driver[1607]=0;SidPlayer.driver[1608]=0;SidPlayer.driver[1609]=0;SidPlayer.driver[1610]=0;SidPlayer.driver[1611]=0;SidPlayer.driver[1612]=0;SidPlayer.driver[1613]=0;SidPlayer.driver[1614]=0;SidPlayer.driver[1615]=0;SidPlayer.driver[1616]=0;SidPlayer.driver[1617]=0;SidPlayer.driver[1618]=0;SidPlayer.driver[1619]=0;SidPlayer.driver[1620]=0;SidPlayer.driver[1621]=0;SidPlayer.driver[1622]=0;SidPlayer.driver[1623]=0;SidPlayer.driver[1624]=0;SidPlayer.driver[1625]=0;SidPlayer.driver[1626]=0;SidPlayer.driver[1627]=0;SidPlayer.driver[1628]=0;SidPlayer.driver[1629]=0;SidPlayer.driver[1630]=0;SidPlayer.driver[1631]=0;SidPlayer.driver[1632]=0;SidPlayer.driver[1633]=0;SidPlayer.driver[1634]=0;SidPlayer.driver[1635]=0;SidPlayer.driver[1636]=0;SidPlayer.driver[1637]=0;SidPlayer.driver[1638]=0;SidPlayer.driver[1639]=0;SidPlayer.driver[1640]=0;SidPlayer.driver[1641]=0;SidPlayer.driver[1642]=0;SidPlayer.driver[1643]=0;SidPlayer.driver[1644]=0;SidPlayer.driver[1645]=0;SidPlayer.driver[1646]=0;SidPlayer.driver[1647]=0;SidPlayer.driver[1648]=0;SidPlayer.driver[1649]=0;SidPlayer.driver[1650]=0;SidPlayer.driver[1651]=0;SidPlayer.driver[1652]=0;SidPlayer.driver[1653]=0;SidPlayer.driver[1654]=0;SidPlayer.driver[1655]=0;SidPlayer.driver[1656]=0;SidPlayer.driver[1657]=0;SidPlayer.driver[1658]=0;SidPlayer.driver[1659]=0;SidPlayer.driver[1660]=0;SidPlayer.driver[1661]=0;SidPlayer.driver[1662]=0;SidPlayer.driver[1663]=0;SidPlayer.driver[1664]=0;SidPlayer.driver[1665]=0;SidPlayer.driver[1666]=0;SidPlayer.driver[1667]=0;SidPlayer.driver[1668]=0;SidPlayer.driver[1669]=0;SidPlayer.driver[1670]=0;SidPlayer.driver[1671]=0;SidPlayer.driver[1672]=0;SidPlayer.driver[1673]=0;SidPlayer.driver[1674]=0;SidPlayer.driver[1675]=0;SidPlayer.driver[1676]=0;SidPlayer.driver[1677]=0;SidPlayer.driver[1678]=0;SidPlayer.driver[1679]=0;SidPlayer.driver[1680]=0;SidPlayer.driver[1681]=0;SidPlayer.driver[1682]=0;SidPlayer.driver[1683]=0;SidPlayer.driver[1684]=0;SidPlayer.driver[1685]=0;SidPlayer.driver[1686]=0;SidPlayer.driver[1687]=0;SidPlayer.driver[1688]=0;SidPlayer.driver[1689]=0;SidPlayer.driver[1690]=0;SidPlayer.driver[1691]=0;SidPlayer.driver[1692]=0;SidPlayer.driver[1693]=0;SidPlayer.driver[1694]=0;SidPlayer.driver[1695]=0;SidPlayer.driver[1696]=0;SidPlayer.driver[1697]=0;SidPlayer.driver[1698]=0;SidPlayer.driver[1699]=0;SidPlayer.driver[1700]=0;SidPlayer.driver[1701]=0;SidPlayer.driver[1702]=0;SidPlayer.driver[1703]=0;SidPlayer.driver[1704]=0;SidPlayer.driver[1705]=0;SidPlayer.driver[1706]=0;SidPlayer.driver[1707]=0;SidPlayer.driver[1708]=0;SidPlayer.driver[1709]=0;SidPlayer.driver[1710]=0;SidPlayer.driver[1711]=0;SidPlayer.driver[1712]=0;SidPlayer.driver[1713]=0;SidPlayer.driver[1714]=0;SidPlayer.driver[1715]=0;SidPlayer.driver[1716]=0;SidPlayer.driver[1717]=0;SidPlayer.driver[1718]=0;SidPlayer.driver[1719]=0;SidPlayer.driver[1720]=0;SidPlayer.driver[1721]=0;SidPlayer.driver[1722]=0;SidPlayer.driver[1723]=0;SidPlayer.driver[1724]=0;SidPlayer.driver[1725]=0;SidPlayer.driver[1726]=0;SidPlayer.driver[1727]=0;SidPlayer.driver[1728]=0;SidPlayer.driver[1729]=0;SidPlayer.driver[1730]=0;SidPlayer.driver[1731]=0;SidPlayer.driver[1732]=0;SidPlayer.driver[1733]=0;SidPlayer.driver[1734]=0;SidPlayer.driver[1735]=0;SidPlayer.driver[1736]=0;SidPlayer.driver[1737]=0;SidPlayer.driver[1738]=0;SidPlayer.driver[1739]=0;SidPlayer.driver[1740]=0;SidPlayer.driver[1741]=0;SidPlayer.driver[1742]=0;SidPlayer.driver[1743]=0;SidPlayer.driver[1744]=0;SidPlayer.driver[1745]=0;SidPlayer.driver[1746]=0;SidPlayer.driver[1747]=0;SidPlayer.driver[1748]=0;SidPlayer.driver[1749]=0;SidPlayer.driver[1750]=0;SidPlayer.driver[1751]=0;SidPlayer.driver[1752]=0;SidPlayer.driver[1753]=0;SidPlayer.driver[1754]=0;SidPlayer.driver[1755]=0;SidPlayer.driver[1756]=0;SidPlayer.driver[1757]=0;SidPlayer.driver[1758]=0;SidPlayer.driver[1759]=0;SidPlayer.driver[1760]=0;SidPlayer.driver[1761]=0;SidPlayer.driver[1762]=0;SidPlayer.driver[1763]=0;SidPlayer.driver[1764]=0;SidPlayer.driver[1765]=0;SidPlayer.driver[1766]=0;SidPlayer.driver[1767]=0;SidPlayer.driver[1768]=0;SidPlayer.driver[1769]=0;SidPlayer.driver[1770]=0;SidPlayer.driver[1771]=0;SidPlayer.driver[1772]=0;SidPlayer.driver[1773]=0;SidPlayer.driver[1774]=0;SidPlayer.driver[1775]=0;SidPlayer.driver[1776]=0;SidPlayer.driver[1777]=0;SidPlayer.driver[1778]=0;SidPlayer.driver[1779]=0;SidPlayer.driver[1780]=0;SidPlayer.driver[1781]=0;SidPlayer.driver[1782]=0;SidPlayer.driver[1783]=0;SidPlayer.driver[1784]=0;SidPlayer.driver[1785]=0;SidPlayer.driver[1786]=0;SidPlayer.driver[1787]=0;SidPlayer.driver[1788]=0;SidPlayer.driver[1789]=0;SidPlayer.driver[1790]=0;SidPlayer.driver[1791]=0;SidPlayer.driver[1792]=0;SidPlayer.driver[1793]=0;SidPlayer.driver[1794]=0;SidPlayer.driver[1795]=0;SidPlayer.driver[1796]=0;SidPlayer.driver[1797]=0;SidPlayer.driver[1798]=0;SidPlayer.driver[1799]=0;SidPlayer.driver[1800]=0;SidPlayer.driver[1801]=0;SidPlayer.driver[1802]=0;SidPlayer.driver[1803]=0;SidPlayer.driver[1804]=0;SidPlayer.driver[1805]=0;SidPlayer.driver[1806]=0;SidPlayer.driver[1807]=0;SidPlayer.driver[1808]=0;SidPlayer.driver[1809]=0;SidPlayer.driver[1810]=0;SidPlayer.driver[1811]=0;SidPlayer.driver[1812]=0;SidPlayer.driver[1813]=0;SidPlayer.driver[1814]=0;SidPlayer.driver[1815]=0;SidPlayer.driver[1816]=0;SidPlayer.driver[1817]=0;SidPlayer.driver[1818]=0;SidPlayer.driver[1819]=0;SidPlayer.driver[1820]=0;SidPlayer.driver[1821]=0;SidPlayer.driver[1822]=0;SidPlayer.driver[1823]=0;SidPlayer.driver[1824]=0;SidPlayer.driver[1825]=0;SidPlayer.driver[1826]=0;SidPlayer.driver[1827]=0;SidPlayer.driver[1828]=0;SidPlayer.driver[1829]=0;SidPlayer.driver[1830]=0;SidPlayer.driver[1831]=0;SidPlayer.driver[1832]=0;SidPlayer.driver[1833]=0;SidPlayer.driver[1834]=0;SidPlayer.driver[1835]=0;SidPlayer.driver[1836]=0;SidPlayer.driver[1837]=0;SidPlayer.driver[1838]=0;SidPlayer.driver[1839]=0;SidPlayer.driver[1840]=0;SidPlayer.driver[1841]=0;SidPlayer.driver[1842]=0;SidPlayer.driver[1843]=0;SidPlayer.driver[1844]=0;SidPlayer.driver[1845]=0;SidPlayer.driver[1846]=0;SidPlayer.driver[1847]=0;SidPlayer.driver[1848]=0;SidPlayer.driver[1849]=0;SidPlayer.driver[1850]=0;SidPlayer.driver[1851]=0;SidPlayer.driver[1852]=0;SidPlayer.driver[1853]=0;SidPlayer.driver[1854]=0;SidPlayer.driver[1855]=0;SidPlayer.driver[1856]=0;SidPlayer.driver[1857]=0;SidPlayer.driver[1858]=0;SidPlayer.driver[1859]=0;SidPlayer.driver[1860]=0;SidPlayer.driver[1861]=0;SidPlayer.driver[1862]=0;SidPlayer.driver[1863]=0;SidPlayer.driver[1864]=0;SidPlayer.driver[1865]=0;SidPlayer.driver[1866]=0;SidPlayer.driver[1867]=0;SidPlayer.driver[1868]=0;SidPlayer.driver[1869]=0;SidPlayer.driver[1870]=0;SidPlayer.driver[1871]=0;SidPlayer.driver[1872]=0;SidPlayer.driver[1873]=0;SidPlayer.driver[1874]=0;SidPlayer.driver[1875]=0;SidPlayer.driver[1876]=0;SidPlayer.driver[1877]=0;SidPlayer.driver[1878]=0;SidPlayer.driver[1879]=0;SidPlayer.driver[1880]=0;SidPlayer.driver[1881]=0;SidPlayer.driver[1882]=0;SidPlayer.driver[1883]=0;SidPlayer.driver[1884]=0;SidPlayer.driver[1885]=0;SidPlayer.driver[1886]=0;SidPlayer.driver[1887]=0;SidPlayer.driver[1888]=0;SidPlayer.driver[1889]=0;SidPlayer.driver[1890]=0;SidPlayer.driver[1891]=0;SidPlayer.driver[1892]=0;SidPlayer.driver[1893]=0;SidPlayer.driver[1894]=0;SidPlayer.driver[1895]=0;SidPlayer.driver[1896]=0;SidPlayer.driver[1897]=0;SidPlayer.driver[1898]=0;SidPlayer.driver[1899]=0;SidPlayer.driver[1900]=0;SidPlayer.driver[1901]=0;SidPlayer.driver[1902]=0;SidPlayer.driver[1903]=0;SidPlayer.driver[1904]=0;SidPlayer.driver[1905]=0;SidPlayer.driver[1906]=0;SidPlayer.driver[1907]=0;SidPlayer.driver[1908]=0;SidPlayer.driver[1909]=0;SidPlayer.driver[1910]=0;SidPlayer.driver[1911]=0;SidPlayer.driver[1912]=0;SidPlayer.driver[1913]=0;SidPlayer.driver[1914]=0;SidPlayer.driver[1915]=0;SidPlayer.driver[1916]=0;SidPlayer.driver[1917]=0;SidPlayer.driver[1918]=0;SidPlayer.driver[1919]=0;SidPlayer.driver[1920]=0;SidPlayer.driver[1921]=0;SidPlayer.driver[1922]=0;SidPlayer.driver[1923]=0;SidPlayer.driver[1924]=0;SidPlayer.driver[1925]=0;SidPlayer.driver[1926]=0;SidPlayer.driver[1927]=0;SidPlayer.driver[1928]=0;SidPlayer.driver[1929]=0;SidPlayer.driver[1930]=0;SidPlayer.driver[1931]=0;SidPlayer.driver[1932]=0;SidPlayer.driver[1933]=0;SidPlayer.driver[1934]=0;SidPlayer.driver[1935]=0;SidPlayer.driver[1936]=0;SidPlayer.driver[1937]=0;SidPlayer.driver[1938]=0;SidPlayer.driver[1939]=0;SidPlayer.driver[1940]=0;SidPlayer.driver[1941]=0;SidPlayer.driver[1942]=0;SidPlayer.driver[1943]=0;SidPlayer.driver[1944]=0;SidPlayer.driver[1945]=0;SidPlayer.driver[1946]=0;SidPlayer.driver[1947]=0;SidPlayer.driver[1948]=0;SidPlayer.driver[1949]=0;SidPlayer.driver[1950]=0;SidPlayer.driver[1951]=0;SidPlayer.driver[1952]=0;SidPlayer.driver[1953]=0;SidPlayer.driver[1954]=0;SidPlayer.driver[1955]=0;SidPlayer.driver[1956]=0;SidPlayer.driver[1957]=0;SidPlayer.driver[1958]=0;SidPlayer.driver[1959]=0;SidPlayer.driver[1960]=0;SidPlayer.driver[1961]=0;SidPlayer.driver[1962]=0;SidPlayer.driver[1963]=0;SidPlayer.driver[1964]=0;SidPlayer.driver[1965]=0;SidPlayer.driver[1966]=0;SidPlayer.driver[1967]=0;SidPlayer.driver[1968]=0;SidPlayer.driver[1969]=0;SidPlayer.driver[1970]=0;SidPlayer.driver[1971]=0;SidPlayer.driver[1972]=0;SidPlayer.driver[1973]=0;SidPlayer.driver[1974]=0;SidPlayer.driver[1975]=0;SidPlayer.driver[1976]=0;SidPlayer.driver[1977]=0;SidPlayer.driver[1978]=0;SidPlayer.driver[1979]=0;SidPlayer.driver[1980]=0;SidPlayer.driver[1981]=0;SidPlayer.driver[1982]=0;SidPlayer.driver[1983]=0;SidPlayer.driver[1984]=0;SidPlayer.driver[1985]=0;SidPlayer.driver[1986]=0;SidPlayer.driver[1987]=0;SidPlayer.driver[1988]=0;SidPlayer.driver[1989]=0;SidPlayer.driver[1990]=0;SidPlayer.driver[1991]=0;SidPlayer.driver[1992]=0;SidPlayer.driver[1993]=0;SidPlayer.driver[1994]=0;SidPlayer.driver[1995]=0;SidPlayer.driver[1996]=0;SidPlayer.driver[1997]=0;SidPlayer.driver[1998]=0;SidPlayer.driver[1999]=0;SidPlayer.driver[2e3]=0;SidPlayer.driver[2001]=0;SidPlayer.driver[2002]=0;SidPlayer.driver[2003]=0;SidPlayer.driver[2004]=0;SidPlayer.driver[2005]=0;SidPlayer.driver[2006]=0;SidPlayer.driver[2007]=0;SidPlayer.driver[2008]=0;SidPlayer.driver[2009]=0;SidPlayer.driver[2010]=0;SidPlayer.driver[2011]=0;SidPlayer.driver[2012]=0;SidPlayer.driver[2013]=0;SidPlayer.driver[2014]=0;SidPlayer.driver[2015]=0;SidPlayer.driver[2016]=0;SidPlayer.driver[2017]=0;SidPlayer.driver[2018]=0;SidPlayer.driver[2019]=0;SidPlayer.driver[2020]=0;SidPlayer.driver[2021]=0;SidPlayer.driver[2022]=0;SidPlayer.driver[2023]=0;SidPlayer.driver[2024]=0;SidPlayer.driver[2025]=0;SidPlayer.driver[2026]=0;SidPlayer.driver[2027]=0;SidPlayer.driver[2028]=0;SidPlayer.driver[2029]=0;SidPlayer.driver[2030]=0;SidPlayer.driver[2031]=0;SidPlayer.driver[2032]=0;SidPlayer.driver[2033]=0;SidPlayer.driver[2034]=0;SidPlayer.driver[2035]=0;SidPlayer.driver[2036]=0;SidPlayer.driver[2037]=0;SidPlayer.driver[2038]=0;SidPlayer.driver[2039]=0;SidPlayer.driver[2040]=0;SidPlayer.driver[2041]=0;SidPlayer.driver[2042]=0;SidPlayer.driver[2043]=0;SidPlayer.driver[2044]=0;SidPlayer.driver[2045]=0;SidPlayer.driver[2046]=0;SidPlayer.driver[2047]=0;SidPlayer.driver[2048]=0;SidPlayer.data=[];SidPlayer.data[0]=76;SidPlayer.data[1]=254;SidPlayer.data[2]=16;SidPlayer.data[3]=76;SidPlayer.data[4]=2;SidPlayer.data[5]=17;SidPlayer.data[6]=76;SidPlayer.data[7]=81;SidPlayer.data[8]=16;SidPlayer.data[9]=185;SidPlayer.data[10]=247;SidPlayer.data[11]=20;SidPlayer.data[12]=76;SidPlayer.data[13]=22;SidPlayer.data[14]=16;SidPlayer.data[15]=168;SidPlayer.data[16]=169;SidPlayer.data[17]=0;SidPlayer.data[18]=157;SidPlayer.data[19]=173;SidPlayer.data[20]=20;SidPlayer.data[21]=152;SidPlayer.data[22]=157;SidPlayer.data[23]=132;SidPlayer.data[24]=20;SidPlayer.data[25]=189;SidPlayer.data[26]=115;SidPlayer.data[27]=20;SidPlayer.data[28]=157;SidPlayer.data[29]=131;SidPlayer.data[30]=20;SidPlayer.data[31]=96;SidPlayer.data[32]=157;SidPlayer.data[33]=220;SidPlayer.data[34]=20;SidPlayer.data[35]=96;SidPlayer.data[36]=157;SidPlayer.data[37]=221;SidPlayer.data[38]=20;SidPlayer.data[39]=96;SidPlayer.data[40]=157;SidPlayer.data[41]=135;SidPlayer.data[42]=20;SidPlayer.data[43]=96;SidPlayer.data[44]=157;SidPlayer.data[45]=134;SidPlayer.data[46]=20;SidPlayer.data[47]=169;SidPlayer.data[48]=0;SidPlayer.data[49]=157;SidPlayer.data[50]=175;SidPlayer.data[51]=20;SidPlayer.data[52]=96;SidPlayer.data[53]=157;SidPlayer.data[54]=136;SidPlayer.data[55]=20;SidPlayer.data[56]=169;SidPlayer.data[57]=0;SidPlayer.data[58]=157;SidPlayer.data[59]=137;SidPlayer.data[60]=20;SidPlayer.data[61]=96;SidPlayer.data[62]=160;SidPlayer.data[63]=0;SidPlayer.data[64]=140;SidPlayer.data[65]=72;SidPlayer.data[66]=17;SidPlayer.data[67]=141;SidPlayer.data[68]=68;SidPlayer.data[69]=17;SidPlayer.data[70]=96;SidPlayer.data[71]=141;SidPlayer.data[72]=146;SidPlayer.data[73]=17;SidPlayer.data[74]=240;SidPlayer.data[75]=247;SidPlayer.data[76]=96;SidPlayer.data[77]=141;SidPlayer.data[78]=141;SidPlayer.data[79]=17;SidPlayer.data[80]=96;SidPlayer.data[81]=141;SidPlayer.data[82]=153;SidPlayer.data[83]=17;SidPlayer.data[84]=96;SidPlayer.data[85]=168;SidPlayer.data[86]=185;SidPlayer.data[87]=0;SidPlayer.data[88]=21;SidPlayer.data[89]=141;SidPlayer.data[90]=108;SidPlayer.data[91]=20;SidPlayer.data[92]=185;SidPlayer.data[93]=1;SidPlayer.data[94]=21;SidPlayer.data[95]=141;SidPlayer.data[96]=109;SidPlayer.data[97]=20;SidPlayer.data[98]=169;SidPlayer.data[99]=0;SidPlayer.data[100]=240;SidPlayer.data[101]=2;SidPlayer.data[102]=48;SidPlayer.data[103]=10;SidPlayer.data[104]=141;SidPlayer.data[105]=154;SidPlayer.data[106]=20;SidPlayer.data[107]=141;SidPlayer.data[108]=161;SidPlayer.data[109]=20;SidPlayer.data[110]=141;SidPlayer.data[111]=168;SidPlayer.data[112]=20;SidPlayer.data[113]=96;SidPlayer.data[114]=41;SidPlayer.data[115]=127;SidPlayer.data[116]=157;SidPlayer.data[117]=154;SidPlayer.data[118]=20;SidPlayer.data[119]=96;SidPlayer.data[120]=222;SidPlayer.data[121]=174;SidPlayer.data[122]=20;SidPlayer.data[123]=76;SidPlayer.data[124]=68;SidPlayer.data[125]=19;SidPlayer.data[126]=240;SidPlayer.data[127]=251;SidPlayer.data[128]=189;SidPlayer.data[129]=174;SidPlayer.data[130]=20;SidPlayer.data[131]=208;SidPlayer.data[132]=243;SidPlayer.data[133]=185;SidPlayer.data[134]=0;SidPlayer.data[135]=21;SidPlayer.data[136]=48;SidPlayer.data[137]=4;SidPlayer.data[138]=160;SidPlayer.data[139]=0;SidPlayer.data[140]=132;SidPlayer.data[141]=253;SidPlayer.data[142]=41;SidPlayer.data[143]=127;SidPlayer.data[144]=141;SidPlayer.data[145]=153;SidPlayer.data[146]=16;SidPlayer.data[147]=189;SidPlayer.data[148]=173;SidPlayer.data[149]=20;SidPlayer.data[150]=48;SidPlayer.data[151]=8;SidPlayer.data[152]=201;SidPlayer.data[153]=0;SidPlayer.data[154]=144;SidPlayer.data[155]=5;SidPlayer.data[156]=240;SidPlayer.data[157]=2;SidPlayer.data[158]=73;SidPlayer.data[159]=255;SidPlayer.data[160]=24;SidPlayer.data[161]=105;SidPlayer.data[162]=2;SidPlayer.data[163]=157;SidPlayer.data[164]=173;SidPlayer.data[165]=20;SidPlayer.data[166]=74;SidPlayer.data[167]=144;SidPlayer.data[168]=40;SidPlayer.data[169]=176;SidPlayer.data[170]=61;SidPlayer.data[171]=152;SidPlayer.data[172]=240;SidPlayer.data[173]=74;SidPlayer.data[174]=169;SidPlayer.data[175]=0;SidPlayer.data[176]=201;SidPlayer.data[177]=2;SidPlayer.data[178]=144;SidPlayer.data[179]=29;SidPlayer.data[180]=240;SidPlayer.data[181]=50;SidPlayer.data[182]=188;SidPlayer.data[183]=156;SidPlayer.data[184]=20;SidPlayer.data[185]=189;SidPlayer.data[186]=215;SidPlayer.data[187]=20;SidPlayer.data[188]=249;SidPlayer.data[189]=153;SidPlayer.data[190]=20;SidPlayer.data[191]=72;SidPlayer.data[192]=189;SidPlayer.data[193]=216;SidPlayer.data[194]=20;SidPlayer.data[195]=249;SidPlayer.data[196]=154;SidPlayer.data[197]=20;SidPlayer.data[198]=168;SidPlayer.data[199]=104;SidPlayer.data[200]=176;SidPlayer.data[201]=23;SidPlayer.data[202]=101;SidPlayer.data[203]=252;SidPlayer.data[204]=152;SidPlayer.data[205]=101;SidPlayer.data[206]=253;SidPlayer.data[207]=16;SidPlayer.data[208]=39;SidPlayer.data[209]=189;SidPlayer.data[210]=215;SidPlayer.data[211]=20;SidPlayer.data[212]=101;SidPlayer.data[213]=252;SidPlayer.data[214]=157;SidPlayer.data[215]=215;SidPlayer.data[216]=20;SidPlayer.data[217]=189;SidPlayer.data[218]=216;SidPlayer.data[219]=20;SidPlayer.data[220]=101;SidPlayer.data[221]=253;SidPlayer.data[222]=76;SidPlayer.data[223]=65;SidPlayer.data[224]=19;SidPlayer.data[225]=229;SidPlayer.data[226]=252;SidPlayer.data[227]=152;SidPlayer.data[228]=229;SidPlayer.data[229]=253;SidPlayer.data[230]=48;SidPlayer.data[231]=16;SidPlayer.data[232]=189;SidPlayer.data[233]=215;SidPlayer.data[234]=20;SidPlayer.data[235]=229;SidPlayer.data[236]=252;SidPlayer.data[237]=157;SidPlayer.data[238]=215;SidPlayer.data[239]=20;SidPlayer.data[240]=189;SidPlayer.data[241]=216;SidPlayer.data[242]=20;SidPlayer.data[243]=229;SidPlayer.data[244]=253;SidPlayer.data[245]=76;SidPlayer.data[246]=65;SidPlayer.data[247]=19;SidPlayer.data[248]=189;SidPlayer.data[249]=156;SidPlayer.data[250]=20;SidPlayer.data[251]=76;SidPlayer.data[252]=47;SidPlayer.data[253]=19;SidPlayer.data[254]=141;SidPlayer.data[255]=16;SidPlayer.data[256]=17;SidPlayer.data[257]=96;SidPlayer.data[258]=162;SidPlayer.data[259]=24;SidPlayer.data[260]=189;SidPlayer.data[261]=215;SidPlayer.data[262]=20;SidPlayer.data[263]=157;SidPlayer.data[264]=0;SidPlayer.data[265]=212;SidPlayer.data[266]=202;SidPlayer.data[267]=16;SidPlayer.data[268]=247;SidPlayer.data[269]=162;SidPlayer.data[270]=0;SidPlayer.data[271]=160;SidPlayer.data[272]=0;SidPlayer.data[273]=48;SidPlayer.data[274]=48;SidPlayer.data[275]=138;SidPlayer.data[276]=162;SidPlayer.data[277]=41;SidPlayer.data[278]=157;SidPlayer.data[279]=110;SidPlayer.data[280]=20;SidPlayer.data[281]=202;SidPlayer.data[282]=16;SidPlayer.data[283]=250;SidPlayer.data[284]=141;SidPlayer.data[285]=236;SidPlayer.data[286]=20;SidPlayer.data[287]=141;SidPlayer.data[288]=146;SidPlayer.data[289]=17;SidPlayer.data[290]=141;SidPlayer.data[291]=68;SidPlayer.data[292]=17;SidPlayer.data[293]=142;SidPlayer.data[294]=16;SidPlayer.data[295]=17;SidPlayer.data[296]=170;SidPlayer.data[297]=32;SidPlayer.data[298]=51;SidPlayer.data[299]=17;SidPlayer.data[300]=162;SidPlayer.data[301]=7;SidPlayer.data[302]=32;SidPlayer.data[303]=51;SidPlayer.data[304]=17;SidPlayer.data[305]=162;SidPlayer.data[306]=14;SidPlayer.data[307]=169;SidPlayer.data[308]=5;SidPlayer.data[309]=157;SidPlayer.data[310]=154;SidPlayer.data[311]=20;SidPlayer.data[312]=169;SidPlayer.data[313]=1;SidPlayer.data[314]=157;SidPlayer.data[315]=155;SidPlayer.data[316]=20;SidPlayer.data[317]=157;SidPlayer.data[318]=157;SidPlayer.data[319]=20;SidPlayer.data[320]=76;SidPlayer.data[321]=28;SidPlayer.data[322]=20;SidPlayer.data[323]=160;SidPlayer.data[324]=0;SidPlayer.data[325]=240;SidPlayer.data[326]=69;SidPlayer.data[327]=169;SidPlayer.data[328]=0;SidPlayer.data[329]=208;SidPlayer.data[330]=35;SidPlayer.data[331]=185;SidPlayer.data[332]=2;SidPlayer.data[333]=21;SidPlayer.data[334]=240;SidPlayer.data[335]=18;SidPlayer.data[336]=16;SidPlayer.data[337]=25;SidPlayer.data[338]=10;SidPlayer.data[339]=141;SidPlayer.data[340]=151;SidPlayer.data[341]=17;SidPlayer.data[342]=185;SidPlayer.data[343]=3;SidPlayer.data[344]=21;SidPlayer.data[345]=141;SidPlayer.data[346]=146;SidPlayer.data[347]=17;SidPlayer.data[348]=185;SidPlayer.data[349]=3;SidPlayer.data[350]=21;SidPlayer.data[351]=208;SidPlayer.data[352]=31;SidPlayer.data[353]=200;SidPlayer.data[354]=185;SidPlayer.data[355]=3;SidPlayer.data[356]=21;SidPlayer.data[357]=141;SidPlayer.data[358]=141;SidPlayer.data[359]=17;SidPlayer.data[360]=76;SidPlayer.data[361]=125;SidPlayer.data[362]=17;SidPlayer.data[363]=141;SidPlayer.data[364]=72;SidPlayer.data[365]=17;SidPlayer.data[366]=185;SidPlayer.data[367]=3;SidPlayer.data[368]=21;SidPlayer.data[369]=24;SidPlayer.data[370]=109;SidPlayer.data[371]=141;SidPlayer.data[372]=17;SidPlayer.data[373]=141;SidPlayer.data[374]=141;SidPlayer.data[375]=17;SidPlayer.data[376]=206;SidPlayer.data[377]=72;SidPlayer.data[378]=17;SidPlayer.data[379]=208;SidPlayer.data[380]=17;SidPlayer.data[381]=185;SidPlayer.data[382]=3;SidPlayer.data[383]=21;SidPlayer.data[384]=201;SidPlayer.data[385]=255;SidPlayer.data[386]=200;SidPlayer.data[387]=152;SidPlayer.data[388]=144;SidPlayer.data[389]=3;SidPlayer.data[390]=185;SidPlayer.data[391]=3;SidPlayer.data[392]=21;SidPlayer.data[393]=141;SidPlayer.data[394]=68;SidPlayer.data[395]=17;SidPlayer.data[396]=169;SidPlayer.data[397]=0;SidPlayer.data[398]=141;SidPlayer.data[399]=237;SidPlayer.data[400]=20;SidPlayer.data[401]=169;SidPlayer.data[402]=0;SidPlayer.data[403]=141;SidPlayer.data[404]=238;SidPlayer.data[405]=20;SidPlayer.data[406]=169;SidPlayer.data[407]=0;SidPlayer.data[408]=9;SidPlayer.data[409]=15;SidPlayer.data[410]=141;SidPlayer.data[411]=239;SidPlayer.data[412]=20;SidPlayer.data[413]=32;SidPlayer.data[414]=167;SidPlayer.data[415]=17;SidPlayer.data[416]=162;SidPlayer.data[417]=7;SidPlayer.data[418]=32;SidPlayer.data[419]=167;SidPlayer.data[420]=17;SidPlayer.data[421]=162;SidPlayer.data[422]=14;SidPlayer.data[423]=222;SidPlayer.data[424]=155;SidPlayer.data[425]=20;SidPlayer.data[426]=240;SidPlayer.data[427]=43;SidPlayer.data[428]=16;SidPlayer.data[429]=21;SidPlayer.data[430]=189;SidPlayer.data[431]=154;SidPlayer.data[432]=20;SidPlayer.data[433]=201;SidPlayer.data[434]=2;SidPlayer.data[435]=176;SidPlayer.data[436]=11;SidPlayer.data[437]=168;SidPlayer.data[438]=73;SidPlayer.data[439]=1;SidPlayer.data[440]=157;SidPlayer.data[441]=154;SidPlayer.data[442]=20;SidPlayer.data[443]=185;SidPlayer.data[444]=108;SidPlayer.data[445]=20;SidPlayer.data[446]=233;SidPlayer.data[447]=0;SidPlayer.data[448]=157;SidPlayer.data[449]=155;SidPlayer.data[450]=20;SidPlayer.data[451]=76;SidPlayer.data[452]=154;SidPlayer.data[453]=18;SidPlayer.data[454]=233;SidPlayer.data[455]=208;SidPlayer.data[456]=254;SidPlayer.data[457]=112;SidPlayer.data[458]=20;SidPlayer.data[459]=221;SidPlayer.data[460]=112;SidPlayer.data[461]=20;SidPlayer.data[462]=208;SidPlayer.data[463]=76;SidPlayer.data[464]=169;SidPlayer.data[465]=0;SidPlayer.data[466]=157;SidPlayer.data[467]=112;SidPlayer.data[468]=20;SidPlayer.data[469]=240;SidPlayer.data[470]=64;SidPlayer.data[471]=188;SidPlayer.data[472]=115;SidPlayer.data[473]=20;SidPlayer.data[474]=185;SidPlayer.data[475]=87;SidPlayer.data[476]=20;SidPlayer.data[477]=141;SidPlayer.data[478]=140;SidPlayer.data[479]=18;SidPlayer.data[480]=141;SidPlayer.data[481]=152;SidPlayer.data[482]=18;SidPlayer.data[483]=189;SidPlayer.data[484]=113;SidPlayer.data[485]=20;SidPlayer.data[486]=208;SidPlayer.data[487]=52;SidPlayer.data[488]=188;SidPlayer.data[489]=152;SidPlayer.data[490]=20;SidPlayer.data[491]=185;SidPlayer.data[492]=251;SidPlayer.data[493]=20;SidPlayer.data[494]=133;SidPlayer.data[495]=252;SidPlayer.data[496]=185;SidPlayer.data[497]=252;SidPlayer.data[498]=20;SidPlayer.data[499]=133;SidPlayer.data[500]=253;SidPlayer.data[501]=188;SidPlayer.data[502]=110;SidPlayer.data[503]=20;SidPlayer.data[504]=177;SidPlayer.data[505]=252;SidPlayer.data[506]=201;SidPlayer.data[507]=255;SidPlayer.data[508]=144;SidPlayer.data[509]=6;SidPlayer.data[510]=200;SidPlayer.data[511]=177;SidPlayer.data[512]=252;SidPlayer.data[513]=168;SidPlayer.data[514]=177;SidPlayer.data[515]=252;SidPlayer.data[516]=201;SidPlayer.data[517]=224;SidPlayer.data[518]=144;SidPlayer.data[519]=8;SidPlayer.data[520]=233;SidPlayer.data[521]=240;SidPlayer.data[522]=157;SidPlayer.data[523]=111;SidPlayer.data[524]=20;SidPlayer.data[525]=200;SidPlayer.data[526]=177;SidPlayer.data[527]=252;SidPlayer.data[528]=201;SidPlayer.data[529]=208;SidPlayer.data[530]=176;SidPlayer.data[531]=178;SidPlayer.data[532]=157;SidPlayer.data[533]=153;SidPlayer.data[534]=20;SidPlayer.data[535]=200;SidPlayer.data[536]=152;SidPlayer.data[537]=157;SidPlayer.data[538]=110;SidPlayer.data[539]=20;SidPlayer.data[540]=188;SidPlayer.data[541]=157;SidPlayer.data[542]=20;SidPlayer.data[543]=185;SidPlayer.data[544]=239;SidPlayer.data[545]=20;SidPlayer.data[546]=157;SidPlayer.data[547]=199;SidPlayer.data[548]=20;SidPlayer.data[549]=189;SidPlayer.data[550]=133;SidPlayer.data[551]=20;SidPlayer.data[552]=240;SidPlayer.data[553]=106;SidPlayer.data[554]=56;SidPlayer.data[555]=233;SidPlayer.data[556]=96;SidPlayer.data[557]=157;SidPlayer.data[558]=156;SidPlayer.data[559]=20;SidPlayer.data[560]=169;SidPlayer.data[561]=0;SidPlayer.data[562]=157;SidPlayer.data[563]=131;SidPlayer.data[564]=20;SidPlayer.data[565]=157;SidPlayer.data[566]=133;SidPlayer.data[567]=20;SidPlayer.data[568]=185;SidPlayer.data[569]=240;SidPlayer.data[570]=20;SidPlayer.data[571]=157;SidPlayer.data[572]=174;SidPlayer.data[573]=20;SidPlayer.data[574]=185;SidPlayer.data[575]=247;SidPlayer.data[576]=20;SidPlayer.data[577]=157;SidPlayer.data[578]=132;SidPlayer.data[579]=20;SidPlayer.data[580]=189;SidPlayer.data[581]=115;SidPlayer.data[582]=20;SidPlayer.data[583]=201;SidPlayer.data[584]=3;SidPlayer.data[585]=240;SidPlayer.data[586]=73;SidPlayer.data[587]=185;SidPlayer.data[588]=241;SidPlayer.data[589]=20;SidPlayer.data[590]=240;SidPlayer.data[591]=12;SidPlayer.data[592]=201;SidPlayer.data[593]=254;SidPlayer.data[594]=176;SidPlayer.data[595]=5;SidPlayer.data[596]=157;SidPlayer.data[597]=135;SidPlayer.data[598]=20;SidPlayer.data[599]=169;SidPlayer.data[600]=255;SidPlayer.data[601]=157;SidPlayer.data[602]=158;SidPlayer.data[603]=20;SidPlayer.data[604]=185;SidPlayer.data[605]=242;SidPlayer.data[606]=20;SidPlayer.data[607]=240;SidPlayer.data[608]=8;SidPlayer.data[609]=157;SidPlayer.data[610]=136;SidPlayer.data[611]=20;SidPlayer.data[612]=169;SidPlayer.data[613]=0;SidPlayer.data[614]=157;SidPlayer.data[615]=137;SidPlayer.data[616]=20;SidPlayer.data[617]=185;SidPlayer.data[618]=243;SidPlayer.data[619]=20;SidPlayer.data[620]=240;SidPlayer.data[621]=8;SidPlayer.data[622]=141;SidPlayer.data[623]=68;SidPlayer.data[624]=17;SidPlayer.data[625]=169;SidPlayer.data[626]=0;SidPlayer.data[627]=141;SidPlayer.data[628]=72;SidPlayer.data[629]=17;SidPlayer.data[630]=185;SidPlayer.data[631]=244;SidPlayer.data[632]=20;SidPlayer.data[633]=157;SidPlayer.data[634]=134;SidPlayer.data[635]=20;SidPlayer.data[636]=185;SidPlayer.data[637]=245;SidPlayer.data[638]=20;SidPlayer.data[639]=157;SidPlayer.data[640]=221;SidPlayer.data[641]=20;SidPlayer.data[642]=185;SidPlayer.data[643]=246;SidPlayer.data[644]=20;SidPlayer.data[645]=157;SidPlayer.data[646]=220;SidPlayer.data[647]=20;SidPlayer.data[648]=189;SidPlayer.data[649]=116;SidPlayer.data[650]=20;SidPlayer.data[651]=32;SidPlayer.data[652]=9;SidPlayer.data[653]=16;SidPlayer.data[654]=76;SidPlayer.data[655]=28;SidPlayer.data[656]=20;SidPlayer.data[657]=76;SidPlayer.data[658]=44;SidPlayer.data[659]=20;SidPlayer.data[660]=189;SidPlayer.data[661]=116;SidPlayer.data[662]=20;SidPlayer.data[663]=32;SidPlayer.data[664]=9;SidPlayer.data[665]=16;SidPlayer.data[666]=188;SidPlayer.data[667]=134;SidPlayer.data[668]=20;SidPlayer.data[669]=240;SidPlayer.data[670]=58;SidPlayer.data[671]=185;SidPlayer.data[672]=252;SidPlayer.data[673]=20;SidPlayer.data[674]=201;SidPlayer.data[675]=16;SidPlayer.data[676]=176;SidPlayer.data[677]=10;SidPlayer.data[678]=221;SidPlayer.data[679]=175;SidPlayer.data[680]=20;SidPlayer.data[681]=240;SidPlayer.data[682]=14;SidPlayer.data[683]=254;SidPlayer.data[684]=175;SidPlayer.data[685]=20;SidPlayer.data[686]=208;SidPlayer.data[687]=41;SidPlayer.data[688]=233;SidPlayer.data[689]=16;SidPlayer.data[690]=201;SidPlayer.data[691]=224;SidPlayer.data[692]=176;SidPlayer.data[693]=3;SidPlayer.data[694]=157;SidPlayer.data[695]=135;SidPlayer.data[696]=20;SidPlayer.data[697]=185;SidPlayer.data[698]=253;SidPlayer.data[699]=20;SidPlayer.data[700]=201;SidPlayer.data[701]=255;SidPlayer.data[702]=200;SidPlayer.data[703]=152;SidPlayer.data[704]=144;SidPlayer.data[705]=3;SidPlayer.data[706]=185;SidPlayer.data[707]=253;SidPlayer.data[708]=20;SidPlayer.data[709]=157;SidPlayer.data[710]=134;SidPlayer.data[711]=20;SidPlayer.data[712]=169;SidPlayer.data[713]=0;SidPlayer.data[714]=157;SidPlayer.data[715]=175;SidPlayer.data[716]=20;SidPlayer.data[717]=185;SidPlayer.data[718]=251;SidPlayer.data[719]=20;SidPlayer.data[720]=201;SidPlayer.data[721]=224;SidPlayer.data[722]=176;SidPlayer.data[723]=189;SidPlayer.data[724]=185;SidPlayer.data[725]=252;SidPlayer.data[726]=20;SidPlayer.data[727]=208;SidPlayer.data[728]=79;SidPlayer.data[729]=189;SidPlayer.data[730]=155;SidPlayer.data[731]=20;SidPlayer.data[732]=240;SidPlayer.data[733]=105;SidPlayer.data[734]=188;SidPlayer.data[735]=131;SidPlayer.data[736]=20;SidPlayer.data[737]=140;SidPlayer.data[738]=175;SidPlayer.data[739]=16;SidPlayer.data[740]=185;SidPlayer.data[741]=103;SidPlayer.data[742]=20;SidPlayer.data[743]=141;SidPlayer.data[744]=38;SidPlayer.data[745]=19;SidPlayer.data[746]=188;SidPlayer.data[747]=132;SidPlayer.data[748]=20;SidPlayer.data[749]=185;SidPlayer.data[750]=0;SidPlayer.data[751]=21;SidPlayer.data[752]=48;SidPlayer.data[753]=10;SidPlayer.data[754]=133;SidPlayer.data[755]=253;SidPlayer.data[756]=185;SidPlayer.data[757]=1;SidPlayer.data[758]=21;SidPlayer.data[759]=133;SidPlayer.data[760]=252;SidPlayer.data[761]=76;SidPlayer.data[762]=37;SidPlayer.data[763]=19;SidPlayer.data[764]=185;SidPlayer.data[765]=1;SidPlayer.data[766]=21;SidPlayer.data[767]=141;SidPlayer.data[768]=24;SidPlayer.data[769]=19;SidPlayer.data[770]=140;SidPlayer.data[771]=34;SidPlayer.data[772]=19;SidPlayer.data[773]=188;SidPlayer.data[774]=200;SidPlayer.data[775]=20;SidPlayer.data[776]=185;SidPlayer.data[777]=154;SidPlayer.data[778]=20;SidPlayer.data[779]=56;SidPlayer.data[780]=249;SidPlayer.data[781]=153;SidPlayer.data[782]=20;SidPlayer.data[783]=133;SidPlayer.data[784]=252;SidPlayer.data[785]=185;SidPlayer.data[786]=155;SidPlayer.data[787]=20;SidPlayer.data[788]=249;SidPlayer.data[789]=154;SidPlayer.data[790]=20;SidPlayer.data[791]=160;SidPlayer.data[792]=0;SidPlayer.data[793]=240;SidPlayer.data[794]=6;SidPlayer.data[795]=74;SidPlayer.data[796]=102;SidPlayer.data[797]=252;SidPlayer.data[798]=136;SidPlayer.data[799]=208;SidPlayer.data[800]=250;SidPlayer.data[801]=160;SidPlayer.data[802]=0;SidPlayer.data[803]=133;SidPlayer.data[804]=253;SidPlayer.data[805]=76;SidPlayer.data[806]=126;SidPlayer.data[807]=16;SidPlayer.data[808]=16;SidPlayer.data[809]=5;SidPlayer.data[810]=125;SidPlayer.data[811]=156;SidPlayer.data[812]=20;SidPlayer.data[813]=41;SidPlayer.data[814]=127;SidPlayer.data[815]=157;SidPlayer.data[816]=200;SidPlayer.data[817]=20;SidPlayer.data[818]=168;SidPlayer.data[819]=169;SidPlayer.data[820]=0;SidPlayer.data[821]=157;SidPlayer.data[822]=173;SidPlayer.data[823]=20;SidPlayer.data[824]=185;SidPlayer.data[825]=153;SidPlayer.data[826]=20;SidPlayer.data[827]=157;SidPlayer.data[828]=215;SidPlayer.data[829]=20;SidPlayer.data[830]=185;SidPlayer.data[831]=154;SidPlayer.data[832]=20;SidPlayer.data[833]=157;SidPlayer.data[834]=216;SidPlayer.data[835]=20;SidPlayer.data[836]=189;SidPlayer.data[837]=155;SidPlayer.data[838]=20;SidPlayer.data[839]=221;SidPlayer.data[840]=199;SidPlayer.data[841]=20;SidPlayer.data[842]=240;SidPlayer.data[843]=78;SidPlayer.data[844]=188;SidPlayer.data[845]=136;SidPlayer.data[846]=20;SidPlayer.data[847]=240;SidPlayer.data[848]=70;SidPlayer.data[849]=29;SidPlayer.data[850]=113;SidPlayer.data[851]=20;SidPlayer.data[852]=240;SidPlayer.data[853]=65;SidPlayer.data[854]=189;SidPlayer.data[855]=137;SidPlayer.data[856]=20;SidPlayer.data[857]=208;SidPlayer.data[858]=20;SidPlayer.data[859]=185;SidPlayer.data[860]=254;SidPlayer.data[861]=20;SidPlayer.data[862]=16;SidPlayer.data[863]=12;SidPlayer.data[864]=157;SidPlayer.data[865]=218;SidPlayer.data[866]=20;SidPlayer.data[867]=185;SidPlayer.data[868]=255;SidPlayer.data[869]=20;SidPlayer.data[870]=157;SidPlayer.data[871]=217;SidPlayer.data[872]=20;SidPlayer.data[873]=76;SidPlayer.data[874]=136;SidPlayer.data[875]=19;SidPlayer.data[876]=157;SidPlayer.data[877]=137;SidPlayer.data[878]=20;SidPlayer.data[879]=185;SidPlayer.data[880]=255;SidPlayer.data[881]=20;SidPlayer.data[882]=24;SidPlayer.data[883]=16;SidPlayer.data[884]=3;SidPlayer.data[885]=222;SidPlayer.data[886]=218;SidPlayer.data[887]=20;SidPlayer.data[888]=125;SidPlayer.data[889]=217;SidPlayer.data[890]=20;SidPlayer.data[891]=157;SidPlayer.data[892]=217;SidPlayer.data[893]=20;SidPlayer.data[894]=144;SidPlayer.data[895]=3;SidPlayer.data[896]=254;SidPlayer.data[897]=218;SidPlayer.data[898]=20;SidPlayer.data[899]=222;SidPlayer.data[900]=137;SidPlayer.data[901]=20;SidPlayer.data[902]=208;SidPlayer.data[903]=15;SidPlayer.data[904]=185;SidPlayer.data[905]=255;SidPlayer.data[906]=20;SidPlayer.data[907]=201;SidPlayer.data[908]=255;SidPlayer.data[909]=200;SidPlayer.data[910]=152;SidPlayer.data[911]=144;SidPlayer.data[912]=3;SidPlayer.data[913]=185;SidPlayer.data[914]=255;SidPlayer.data[915]=20;SidPlayer.data[916]=157;SidPlayer.data[917]=136;SidPlayer.data[918]=20;SidPlayer.data[919]=76;SidPlayer.data[920]=28;SidPlayer.data[921]=20;SidPlayer.data[922]=188;SidPlayer.data[923]=153;SidPlayer.data[924]=20;SidPlayer.data[925]=185;SidPlayer.data[926]=5;SidPlayer.data[927]=21;SidPlayer.data[928]=133;SidPlayer.data[929]=252;SidPlayer.data[930]=185;SidPlayer.data[931]=6;SidPlayer.data[932]=21;SidPlayer.data[933]=133;SidPlayer.data[934]=253;SidPlayer.data[935]=188;SidPlayer.data[936]=113;SidPlayer.data[937]=20;SidPlayer.data[938]=177;SidPlayer.data[939]=252;SidPlayer.data[940]=201;SidPlayer.data[941]=64;SidPlayer.data[942]=144;SidPlayer.data[943]=24;SidPlayer.data[944]=201;SidPlayer.data[945]=96;SidPlayer.data[946]=144;SidPlayer.data[947]=30;SidPlayer.data[948]=201;SidPlayer.data[949]=192;SidPlayer.data[950]=144;SidPlayer.data[951]=46;SidPlayer.data[952]=189;SidPlayer.data[953]=114;SidPlayer.data[954]=20;SidPlayer.data[955]=208;SidPlayer.data[956]=2;SidPlayer.data[957]=177;SidPlayer.data[958]=252;SidPlayer.data[959]=105;SidPlayer.data[960]=0;SidPlayer.data[961]=157;SidPlayer.data[962]=114;SidPlayer.data[963]=20;SidPlayer.data[964]=240;SidPlayer.data[965]=77;SidPlayer.data[966]=208;SidPlayer.data[967]=84;SidPlayer.data[968]=157;SidPlayer.data[969]=157;SidPlayer.data[970]=20;SidPlayer.data[971]=200;SidPlayer.data[972]=177;SidPlayer.data[973]=252;SidPlayer.data[974]=201;SidPlayer.data[975]=96;SidPlayer.data[976]=176;SidPlayer.data[977]=20;SidPlayer.data[978]=201;SidPlayer.data[979]=80;SidPlayer.data[980]=41;SidPlayer.data[981]=15;SidPlayer.data[982]=157;SidPlayer.data[983]=115;SidPlayer.data[984]=20;SidPlayer.data[985]=240;SidPlayer.data[986]=6;SidPlayer.data[987]=200;SidPlayer.data[988]=177;SidPlayer.data[989]=252;SidPlayer.data[990]=157;SidPlayer.data[991]=116;SidPlayer.data[992]=20;SidPlayer.data[993]=176;SidPlayer.data[994]=48;SidPlayer.data[995]=200;SidPlayer.data[996]=177;SidPlayer.data[997]=252;SidPlayer.data[998]=201;SidPlayer.data[999]=189;SidPlayer.data[1e3]=144;SidPlayer.data[1001]=6;SidPlayer.data[1002]=240;SidPlayer.data[1003]=39;SidPlayer.data[1004]=9;SidPlayer.data[1005]=240;SidPlayer.data[1006]=208;SidPlayer.data[1007]=32;SidPlayer.data[1008]=125;SidPlayer.data[1009]=111;SidPlayer.data[1010]=20;SidPlayer.data[1011]=157;SidPlayer.data[1012]=133;SidPlayer.data[1013]=20;SidPlayer.data[1014]=189;SidPlayer.data[1015]=115;SidPlayer.data[1016]=20;SidPlayer.data[1017]=201;SidPlayer.data[1018]=3;SidPlayer.data[1019]=240;SidPlayer.data[1020]=22;SidPlayer.data[1021]=189;SidPlayer.data[1022]=157;SidPlayer.data[1023]=20;SidPlayer.data[1024]=201;SidPlayer.data[1025]=12;SidPlayer.data[1026]=176;SidPlayer.data[1027]=34;SidPlayer.data[1028]=169;SidPlayer.data[1029]=0;SidPlayer.data[1030]=157;SidPlayer.data[1031]=221;SidPlayer.data[1032]=20;SidPlayer.data[1033]=169;SidPlayer.data[1034]=15;SidPlayer.data[1035]=157;SidPlayer.data[1036]=220;SidPlayer.data[1037]=20;SidPlayer.data[1038]=169;SidPlayer.data[1039]=254;SidPlayer.data[1040]=157;SidPlayer.data[1041]=158;SidPlayer.data[1042]=20;SidPlayer.data[1043]=200;SidPlayer.data[1044]=177;SidPlayer.data[1045]=252;SidPlayer.data[1046]=240;SidPlayer.data[1047]=1;SidPlayer.data[1048]=152;SidPlayer.data[1049]=157;SidPlayer.data[1050]=113;SidPlayer.data[1051]=20;SidPlayer.data[1052]=189;SidPlayer.data[1053]=135;SidPlayer.data[1054]=20;SidPlayer.data[1055]=61;SidPlayer.data[1056]=158;SidPlayer.data[1057]=20;SidPlayer.data[1058]=157;SidPlayer.data[1059]=219;SidPlayer.data[1060]=20;SidPlayer.data[1061]=96;SidPlayer.data[1062]=201;SidPlayer.data[1063]=12;SidPlayer.data[1064]=144;SidPlayer.data[1065]=228;SidPlayer.data[1066]=176;SidPlayer.data[1067]=231;SidPlayer.data[1068]=41;SidPlayer.data[1069]=15;SidPlayer.data[1070]=133;SidPlayer.data[1071]=252;SidPlayer.data[1072]=185;SidPlayer.data[1073]=252;SidPlayer.data[1074]=20;SidPlayer.data[1075]=133;SidPlayer.data[1076]=253;SidPlayer.data[1077]=164;SidPlayer.data[1078]=252;SidPlayer.data[1079]=192;SidPlayer.data[1080]=5;SidPlayer.data[1081]=176;SidPlayer.data[1082]=14;SidPlayer.data[1083]=140;SidPlayer.data[1084]=175;SidPlayer.data[1085]=16;SidPlayer.data[1086]=185;SidPlayer.data[1087]=103;SidPlayer.data[1088]=20;SidPlayer.data[1089]=141;SidPlayer.data[1090]=38;SidPlayer.data[1091]=19;SidPlayer.data[1092]=164;SidPlayer.data[1093]=253;SidPlayer.data[1094]=76;SidPlayer.data[1095]=237;SidPlayer.data[1096]=18;SidPlayer.data[1097]=185;SidPlayer.data[1098]=87;SidPlayer.data[1099]=20;SidPlayer.data[1100]=141;SidPlayer.data[1101]=82;SidPlayer.data[1102]=20;SidPlayer.data[1103]=165;SidPlayer.data[1104]=253;SidPlayer.data[1105]=32;SidPlayer.data[1106]=9;SidPlayer.data[1107]=16;SidPlayer.data[1108]=76;SidPlayer.data[1109]=68;SidPlayer.data[1110]=19;SidPlayer.data[1111]=9;SidPlayer.data[1112]=15;SidPlayer.data[1113]=15;SidPlayer.data[1114]=22;SidPlayer.data[1115]=22;SidPlayer.data[1116]=32;SidPlayer.data[1117]=36;SidPlayer.data[1118]=40;SidPlayer.data[1119]=44;SidPlayer.data[1120]=53;SidPlayer.data[1121]=62;SidPlayer.data[1122]=71;SidPlayer.data[1123]=77;SidPlayer.data[1124]=81;SidPlayer.data[1125]=85;SidPlayer.data[1126]=102;SidPlayer.data[1127]=126;SidPlayer.data[1128]=174;SidPlayer.data[1129]=174;SidPlayer.data[1130]=171;SidPlayer.data[1131]=133;SidPlayer.data[1132]=8;SidPlayer.data[1133]=5;SidPlayer.data[1134]=0;SidPlayer.data[1135]=0;SidPlayer.data[1136]=0;SidPlayer.data[1137]=0;SidPlayer.data[1138]=0;SidPlayer.data[1139]=0;SidPlayer.data[1140]=0;SidPlayer.data[1141]=0;SidPlayer.data[1142]=0;SidPlayer.data[1143]=0;SidPlayer.data[1144]=0;SidPlayer.data[1145]=0;SidPlayer.data[1146]=0;SidPlayer.data[1147]=0;SidPlayer.data[1148]=0;SidPlayer.data[1149]=0;SidPlayer.data[1150]=0;SidPlayer.data[1151]=0;SidPlayer.data[1152]=0;SidPlayer.data[1153]=0;SidPlayer.data[1154]=0;SidPlayer.data[1155]=0;SidPlayer.data[1156]=0;SidPlayer.data[1157]=0;SidPlayer.data[1158]=0;SidPlayer.data[1159]=0;SidPlayer.data[1160]=0;SidPlayer.data[1161]=0;SidPlayer.data[1162]=0;SidPlayer.data[1163]=0;SidPlayer.data[1164]=0;SidPlayer.data[1165]=0;SidPlayer.data[1166]=0;SidPlayer.data[1167]=0;SidPlayer.data[1168]=0;SidPlayer.data[1169]=0;SidPlayer.data[1170]=0;SidPlayer.data[1171]=0;SidPlayer.data[1172]=0;SidPlayer.data[1173]=0;SidPlayer.data[1174]=0;SidPlayer.data[1175]=0;SidPlayer.data[1176]=0;SidPlayer.data[1177]=0;SidPlayer.data[1178]=0;SidPlayer.data[1179]=0;SidPlayer.data[1180]=0;SidPlayer.data[1181]=1;SidPlayer.data[1182]=254;SidPlayer.data[1183]=1;SidPlayer.data[1184]=0;SidPlayer.data[1185]=0;SidPlayer.data[1186]=0;SidPlayer.data[1187]=0;SidPlayer.data[1188]=1;SidPlayer.data[1189]=254;SidPlayer.data[1190]=2;SidPlayer.data[1191]=0;SidPlayer.data[1192]=0;SidPlayer.data[1193]=0;SidPlayer.data[1194]=0;SidPlayer.data[1195]=1;SidPlayer.data[1196]=254;SidPlayer.data[1197]=0;SidPlayer.data[1198]=0;SidPlayer.data[1199]=0;SidPlayer.data[1200]=0;SidPlayer.data[1201]=0;SidPlayer.data[1202]=0;SidPlayer.data[1203]=0;SidPlayer.data[1204]=0;SidPlayer.data[1205]=0;SidPlayer.data[1206]=0;SidPlayer.data[1207]=0;SidPlayer.data[1208]=0;SidPlayer.data[1209]=0;SidPlayer.data[1210]=0;SidPlayer.data[1211]=0;SidPlayer.data[1212]=0;SidPlayer.data[1213]=0;SidPlayer.data[1214]=0;SidPlayer.data[1215]=0;SidPlayer.data[1216]=0;SidPlayer.data[1217]=0;SidPlayer.data[1218]=0;SidPlayer.data[1219]=0;SidPlayer.data[1220]=0;SidPlayer.data[1221]=0;SidPlayer.data[1222]=0;SidPlayer.data[1223]=0;SidPlayer.data[1224]=0;SidPlayer.data[1225]=0;SidPlayer.data[1226]=0;SidPlayer.data[1227]=0;SidPlayer.data[1228]=0;SidPlayer.data[1229]=0;SidPlayer.data[1230]=0;SidPlayer.data[1231]=0;SidPlayer.data[1232]=0;SidPlayer.data[1233]=0;SidPlayer.data[1234]=0;SidPlayer.data[1235]=0;SidPlayer.data[1236]=0;SidPlayer.data[1237]=0;SidPlayer.data[1238]=0;SidPlayer.data[1239]=0;SidPlayer.data[1240]=0;SidPlayer.data[1241]=0;SidPlayer.data[1242]=0;SidPlayer.data[1243]=0;SidPlayer.data[1244]=0;SidPlayer.data[1245]=0;SidPlayer.data[1246]=0;SidPlayer.data[1247]=0;SidPlayer.data[1248]=0;SidPlayer.data[1249]=0;SidPlayer.data[1250]=0;SidPlayer.data[1251]=0;SidPlayer.data[1252]=0;SidPlayer.data[1253]=0;SidPlayer.data[1254]=0;SidPlayer.data[1255]=0;SidPlayer.data[1256]=0;SidPlayer.data[1257]=0;SidPlayer.data[1258]=0;SidPlayer.data[1259]=0;SidPlayer.data[1260]=0;SidPlayer.data[1261]=0;SidPlayer.data[1262]=0;SidPlayer.data[1263]=0;var SongData=function(){this.sidStart=4096;this.sidEnd=0;this.tracks=[];this.patterns=[];this.instruments=[];this.filters=[];this.patternRowPositions=[];this.a8s=[[],[],[]];this.wavetable=[];this.pulsetable=[];this.speedtable=[];this.filtertable=[];this.memory=null;var C=[23,39,57,75,95,116,138,161,186,212,240,14,45,78,113,150,190,232,20,67,116,169,225,28,90,156,226,45,124,207,40,133,232,82,193,55,180,57,197,90,247,158,79,10,209,163,130,110,104,113,138,179,238,60,158,21,162,70,4,220,208,226,20,103,221,121,60,41,68,141,8,184,161,197,40,205,186,241,120,83,135,26,16,113,66,137,79,155,116,226,240,166,14,51,32,255];var x=[1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,3,3,3,3,3,4,4,4,4,5,5,5,6,6,6,7,7,8,8,9,9,10,10,11,12,13,13,14,15,16,17,18,19,20,21,23,24,26,27,29,31,32,34,36,39,41,43,46,49,52,55,58,62,65,69,73,78,82,87,92,98,104,110,117,124,131,139,147,156,165,175,185,196,208,221,234,248,255];var w=189;var I=[];var S=false;var P=false;var k={mt_insvibparamminus1:[4106,4671],mt_speedlefttblminus1:[4183,4230,4846],mt_speedrighttblminus1:[4189,4853,4861],mt_c0:[4285,4877,4921],mt_c0plus1:[4873],mt_c1:[4292,4885,4927],mt_c1plus1:[4882],mt_filttimetbl:[4445,4478],mt_filttimetblminus1:[4428],mt_filtspdtblminus1:[4439,4451,4463,4487],mt_songtbllo:[4588],mt_songtblhi:[4593],mt_insgatetimerminus1:[4640],mt_insvibdelayminus1:[4665],mt_insfirstwaveminus1:[4684],mt_inspulseptrminus1:[4701],mt_insfiltptrminus1:[4714],mt_inswaveptrminus1:[4727],mt_inssrminus1:[4733],mt_insadminus1:[4739],mt_wavetblminus2:[4814],mt_wavetblminus1:[4768],mt_wavetbl:[4794],mt_notetblminus1:[4803],mt_notetblminus2:[4821,5169],mt_pulsetimetblminus1:[4956],mt_pulsespdtblminus1:[4964,4976,5010],mt_pulsetimetbl:[5001],mt_patttbllo:[5022],mt_patttblhi:[5027]};this.init=function(){this.memory=new Uint8Array(65536);for(var e=0;e<this.memory.length;e++){this.memory[e]=0}for(var e=0;e<256;e++){I[e]=e}};this.remapInstruments=function(){for(var e=0;e<this.instruments.length;e++){this.instruments[e].originalIndex=e+1;this.instruments[e].isUsed=true;if(this.instruments[e].gateTimer&64){this.instruments[e].gateType="legato"}else if(this.instruments[e].gateTimer&128){this.instruments[e].gateType="nohr"}else{this.instruments[e].gateType="normal"}}this.instruments.sort(function(e,t){if(e.originalIndex==0){return-1}if(e.gateType==t.gateType){return 0}if(e.gateType=="normal"){return-1}if(t.gateType=="normal"){return 1}if(e.gateType=="nohr"){return-1}if(t.gateType=="nohr"){return 1}return 0});P=false;S=false;for(var e=0;e<this.instruments.length;e++){if(this.instruments[e].gateType=="legato"&&S===false){S=e}if(this.instruments[e].gateType=="nohr"&&P===false){P=e}I[this.instruments[e].originalIndex]=e+1}};this.buildTables=function(){this.wavetable=[];this.pulsetable=[];this.speedtable=[];this.filtertable=[];for(var e=0;e<this.filters.length;e++){this.filters[e].filterPtr=this.filtertable.length+1;for(var t=0;t<this.filters[e].filtertable.length;t++){var i=this.filters[e].filtertable[t][0];var r=this.filters[e].filtertable[t][1];if(i==255){if(r!=0){r=r+this.filters[e].filterPtr-1}}else if(i>128){i=(i&112)>>1|128}this.filtertable.push([i,r])}}for(var e=0;e<this.instruments.length;e++){this.instruments[e].filtPtr=0;if(this.instruments[e].filtertable.length>0){this.instruments[e].filtPtr=this.filtertable.length+1;for(var t=0;t<this.instruments[e].filtertable.length;t++){var i=this.instruments[e].filtertable[t][0];var r=this.instruments[e].filtertable[t][1];if(i==255){if(r!=0){r=r+this.instruments[e].filtPtr-1}}else if(i>128){i=(i&112)>>1|128}this.filtertable.push([i,r])}}}var a=false;for(var e=0;e<this.instruments.length;e++){this.instruments[e].wavePtr=this.wavetable.length+1;for(var t=0;t<this.instruments[e].wavetable.length;t++){var s=this.instruments[e].wavetable[t][0];if(s>=224&&s<=239){s&=15}if(s>15&&s<=239&&!a){s+=16}var o=this.instruments[e].wavetable[t][1];if(s==255){if(o!=0){o=o+this.instruments[e].wavePtr-1}}else if(this.instruments[e].wavetable[t][0]>=240&&this.instruments[e].wavetable[t][0]<=254){switch(this.instruments[e].wavetable[t][0]-240){case 1:case 2:case 3:case 4:case 14:var l=this.instruments[e].speedtable[o-1][0];var n=this.instruments[e].speedtable[o-1][1];var h=false;for(var d=0;d<this.speedtable.length;d++){if(this.speedtable[d][0]==l&&this.speedtable[d][1]==n){o=d+1;h=true}}if(!h){o=this.speedtable.length+1;this.speedtable.push([l,n])}break;case 9:break;case 10:break;default:break}}else if(s!=255){o=this.instruments[e].wavetable[t][1]^128}this.wavetable.push([s,o])}}for(var e=0;e<this.instruments.length;e++){this.instruments[e].pulsePtr=0;if(this.instruments[e].pulsetable.length>0){this.instruments[e].pulsePtr=this.pulsetable.length+1;for(var t=0;t<this.instruments[e].pulsetable.length;t++){var i=this.instruments[e].pulsetable[t][0];var r=this.instruments[e].pulsetable[t][1];if(i==255){if(r!=0){r=r+this.instruments[e].pulsePtr-1}}this.pulsetable.push([i,r])}}}for(var e=0;e<this.instruments.length;e++){this.instruments[e].vibParam=0;if(this.instruments[e].vibratoSpeed&&this.instruments[e].vibratoDepth){this.instruments[e].vibParam=this.speedtable.length+1;this.speedtable.push([this.instruments[e].vibratoSpeed,this.instruments[e].vibratoDepth])}for(var t=0;t<this.instruments[e].speedtable.length;t++){}}};this.packpattern=function(e){var t=e.length/4;this.buildTables();var i=[];var r=[];var a=[];var s=0;var o=-1;var l=-1;var n=0;var h=0;var d=0;var c=0;for(d=0;d<t;d++){if(d&&e[d*4+1]&&e[d*4+1]==s){i[d*4]=e[d*4];i[d*4+1]=0;i[d*4+2]=e[d*4+2];i[d*4+3]=e[d*4+3]}else{i[d*4]=e[d*4];i[d*4+1]=e[d*4+1];i[d*4+2]=e[d*4+2];i[d*4+3]=e[d*4+3];if(e[d*4+1]){s=e[d*4+1]}}}for(d=0;d<t;d++){if(i[d*4+1]){r[n++]=I[0+i[d*4+1]]}if(i[d*4]==w){if(i[d*4+2]!=o||i[d*4+3]!=l){o=i[d*4+2];l=i[d*4+3];r[n++]=80+o;if(o)r[n++]=l}else r[n++]=w}else{if(i[d*4+2]!=o||i[d*4+3]!=l){o=i[d*4+2];l=i[d*4+3];r[n++]=64+o;if(o)r[n++]=l}r[n++]=i[d*4]}}for(d=0;d<n;){var f=1;if(!d){f=0}if(r[d]<64){a[h++]=r[d++];f=0}var u=false;if(r[d]>=80&&r[d]<96){var p=r[d]-80;a[h++]=r[d++];if(p)a[h++]=r[d++];f=0;u=true}if(!u){if(r[d]<80){var p=r[d]-64;a[h++]=r[d++];if(p)a[h++]=r[d++];f=0}if(r[d]!=w){f=0}if(!f){a[h++]=r[d++]}else{for(c=d;c<n;){if(r[c]==w){c++;if(c-d==64)break}else break}c-=d;if(c>1){a[h++]=-c;d+=c}else a[h++]=r[d++]}}}if(h>256){alert("pattern too big!");return false}if(h<256){a[h++]=0}return a};this.packpattern2=function(e){var t=this.patterns[e];var i=t.length/4;var r=[];var a=[];var s=[];var o=0;var l=-1;var n=-1;var h=0;var d=0;var c=0;var f=0;for(c=0;c<i;c++){if(c&&t[c*4+1]&&t[c*4+1]==o){r[c*4]=t[c*4];r[c*4+1]=t[c*4+1];r[c*4+2]=t[c*4+2];r[c*4+3]=t[c*4+3]}else{r[c*4]=t[c*4];r[c*4+1]=t[c*4+1];r[c*4+2]=t[c*4+2];r[c*4+3]=t[c*4+3];if(t[c*4+1]){o=t[c*4+1]}}switch(r[c*4+2]){case 15:if((r[c*4+3]&127)>=3){r[c*4+3]--}break;case 1:case 2:case 3:case 4:case 14:noportamento=0;var u=r[c*4+3];if(r[c*4+2]==3&&u==0){r[c*4+3]=0}else{var p=u>>8;var v=u&255;var g=false;for(var m=0;m<this.speedtable.length;m++){if(this.speedtable[m][0]==p&&this.speedtable[m][1]==v){g=true;r[c*4+3]=m+1;break}}if(!g){r[c*4+3]=this.speedtable.length+1;this.speedtable.push([p,v])}if(r[c*4+2]==4){}}break;case 10:var y=r[c*4+3]-1;r[c*4+3]=this.filters[y].filterPtr;break}}var b=[];for(c=0;c<i;c++){var C=c;if(r[c*4+1]){b[h]=C;a[h++]=I[0+r[c*4+1]]}if(r[c*4]==w){if(r[c*4+2]!=l||r[c*4+3]!=n){l=r[c*4+2];n=r[c*4+3];b[h]=C;a[h++]=80+l;if(l){b[h]=C;a[h++]=n}}else{b[h]=C;a[h++]=w}}else{if(r[c*4+2]!=l||r[c*4+3]!=n){l=r[c*4+2];n=r[c*4+3];b[h]=C;a[h++]=64+l;if(l){b[h]=C;a[h++]=n}}b[h]=C;a[h++]=r[c*4]}}this.patternRowPositions[e]=b;for(c=0;c<h;){var x=1;x=0;if(!c){x=0}if(a[c]<64){s[d++]=a[c++];x=0}var S=false;if(a[c]>=80&&a[c]<96){var P=a[c]-80;s[d++]=a[c++];if(P)s[d++]=a[c++];x=0;S=true}if(!S){if(a[c]<80){var P=a[c]-64;s[d++]=a[c++];if(P)s[d++]=a[c++];x=0}if(a[c]!=w){x=0}if(!x){s[d++]=a[c++]}else{for(f=c;f<h;){if(a[f]==w){f++;if(f-c==64)break}else break}f-=c;if(f>1){s[d++]=-f;c+=f}else s[d++]=a[c++]}}}if(d>256){alert("too big");return false}while(d<255){s[d++]=0}if(d<256){s[d++]=0}return s};this.writeSid=function(e){var t={};var i=[];if(typeof e=="undefined"){e=true}this.a8s=[[],[],[]];for(var r=0;r<3;r++){if(r<this.tracks.length){this.a8s[r]=[];var a=0;for(var s=0;s<this.tracks[r].length;s++){this.a8s[r][s]=a;var o=this.tracks[r][s];a+=this.patterns[o].length/4}}}this.testingInstrument=false;this.buildTables();this.labels={};var l=4096;var n=l;i.push({name:"Player",address:n});t["playerAddress"]=n;for(var h=0;h<SidPlayer.data.length;h++){if(e){this.memory[n++]=SidPlayer.data[h]}else{n++}}i.push({name:"Freq Table Lo",address:n});this.labels.mt_c0=n;for(var h=0;h<C.length;h++){this.memory[n++]=C[h]}i.push({name:"Freq Table Hi",address:n});this.labels.mt_c1=n;for(var h=0;h<x.length;h++){this.memory[n++]=x[h]}t["sidDataAddress"]=n;i.push({name:"Song Table Lo",address:n});this.labels.mt_songtbllo=n;n++;n++;n++;i.push({name:"Song Table Hi",address:n});this.labels.mt_songtblhi=n;n++;n++;n++;i.push({name:"Pattern Table Lo",address:n});this.labels.mt_patttbllo=n;n+=this.patterns.length;i.push({name:"Pattern Table Hi",address:n});this.labels.mt_patttblhi=n;n+=this.patterns.length;i.push({name:"Instruments AD",address:n});this.labels.mt_insad=n;for(var h=0;h<this.instruments.length;h++){this.memory[n]=this.instruments[h].attack<<4;this.memory[n]+=this.instruments[h].decay;n++}i.push({name:"Instruments SR",address:n});this.labels.mt_inssr=n;for(var h=0;h<this.instruments.length;h++){this.memory[n]=this.instruments[h].sustain<<4;this.memory[n]+=this.instruments[h].release;n++}i.push({name:"Instruments Wave Ptr",address:n});this.labels.mt_inswaveptr=n;for(var h=0;h<this.instruments.length;h++){this.memory[n]=this.instruments[h].wavePtr;n++}i.push({name:"Instruments Pulse Ptr",address:n});this.labels.mt_inspulseptr=n;for(var h=0;h<this.instruments.length;h++){this.memory[n]=this.instruments[h].pulsePtr;n++}i.push({name:"Instruments Filter Ptr",address:n});this.labels.mt_insfiltptr=n;for(var h=0;h<this.instruments.length;h++){this.memory[n]=this.instruments[h].filtPtr;n++}i.push({name:"Instruments Vibrato Param",address:n});this.labels.mt_insvibparam=n;for(var h=0;h<this.instruments.length;h++){this.memory[n]=this.instruments[h].vibParam;n++}i.push({name:"Instruments Vibrato Delay",address:n});this.labels.mt_insvibdelay=n;for(var h=0;h<this.instruments.length;h++){this.memory[n]=this.instruments[h].vibratoDelay;n++}i.push({name:"Instruments Gate Timer",address:n});this.labels.mt_insgatetimer=n;for(var h=0;h<this.instruments.length;h++){this.memory[n]=this.instruments[h].gateTimer&63;n++}i.push({name:"Instruments First Wave",address:n});this.labels.mt_insfirstwave=n;for(var h=0;h<this.instruments.length;h++){this.memory[n]=this.instruments[h].firstWave;n++}i.push({name:"Wave Table Left",address:n});this.labels.mt_wavetbl=n;for(var h=0;h<this.wavetable.length;h++){this.memory[n++]=this.wavetable[h][0]}i.push({name:"Wave Table Right",address:n});this.labels.mt_notetbl=n;for(var h=0;h<this.wavetable.length;h++){this.memory[n++]=this.wavetable[h][1]}i.push({name:"Pulse Table Left",address:n});this.labels.mt_pulsetimetbl=n;for(var h=0;h<this.pulsetable.length;h++){this.memory[n++]=this.pulsetable[h][0]}i.push({name:"Pulse Table Right",address:n});this.labels.mt_pulsespdtbl=n;for(var h=0;h<this.pulsetable.length;h++){this.memory[n++]=this.pulsetable[h][1]}i.push({name:"Filter Table Left",address:n});this.labels.mt_filttimetbl=n;for(var h=0;h<this.filtertable.length;h++){this.memory[n++]=this.filtertable[h][0]}i.push({name:"Filter Table Right",address:n});this.labels.mt_filtspdtbl=n;for(var h=0;h<this.filtertable.length;h++){this.memory[n++]=this.filtertable[h][1]}if(this.filtertable.length==0){this.memory[n++]=0}var d=[];for(var c=0;c<this.patterns.length;c++){var f=this.packpattern2(c);d.push(f)}this.memory[n++]=0;i.push({name:"Speed Table Left",address:n});this.labels.mt_speedlefttbl=n;for(var h=0;h<this.speedtable.length;h++){this.memory[n++]=this.speedtable[h][0]}this.memory[n++]=0;i.push({name:"Speed Table Right",address:n});this.labels.mt_speedrighttbl=n;for(var h=0;h<this.speedtable.length;h++){this.memory[n++]=this.speedtable[h][1]}if(this.speedtable.length==0){this.memory[n++]=0}for(var s=0;s<this.tracks.length;s++){this.labels["mt_song"+s]=n;this.memory[this.labels.mt_songtbllo+s]=n&255;this.memory[this.labels.mt_songtblhi+s]=n>>8;i.push({name:"Track "+s+" Patterns",address:n});for(var h=0;h<this.tracks[s].length;h++){this.memory[n++]=this.tracks[s][h]}this.memory[n++]=255;this.memory[n++]=0}for(var c=0;c<this.patterns.length;c++){i.push({name:"Pattern "+c,address:n});this.memory[this.labels.mt_patttbllo+c]=n&255;this.memory[this.labels.mt_patttblhi+c]=n>>8;this.labels["mt_patt"+c]=n;var f=d[c];for(var h=0;h<f.length-2;h++){this.memory[n++]=f[h]}this.memory[n++]=0}this.sidEnd=n;t["sidEndAddress"]=n;var u=parseInt($("#sidTempo").val());if(P===false){P=254}if(S===false){S=255}this.memory[4404]=u-1;this.memory[5121]=P;this.memory[5159]=S;for(var p in k){var a=0;var v=k[p];var g=p.indexOf("minus1");if(g!=-1){a=-1;p=p.substring(0,g)}var g=p.indexOf("minus2");if(g!=-1){a=-2;p=p.substring(0,g)}var g=p.indexOf("plus1");if(g!=-1){a=1;p=p.substring(0,g)}if(p=="mt_c0"){}if(p=="mt_c1"){}var m=this.labels[p]+a;var y=m&255;var b=m>>8;for(var h=0;h<v.length;h++){this.memory[v[h]]=y;this.memory[v[h]+1]=b}}console.log(i);return t};this.getSIDData=function(){var e=[];var t=0;for(var i=0;i<SidPlayer.driver.length;i++){}for(var i=this.sidStart;i<this.sidEnd;i++){e[t++]=this.memory[i]}return e;var r=t;var a=new Uint8Array(r);for(var i=0;i<r;i++){a[i]=e[i]}e=null;return a};this.downloadPRG=function(e){console.log("download prg: ");console.log(e);var t="music";var i=true;var r="prg";if(typeof e!="undefined"){if(typeof e.filename!="undefined"){t=e.filename}if(typeof e.allInstruments!="undefined"){i=e.allInstruments}if(typeof e.type!="undefined"){r=e.type}}var a=[];var s=0;if(r=="prg"){for(var o=0;o<SidPlayer.driver.length;o++){a[s++]=SidPlayer.driver[o]}}for(var o=this.sidStart;o<this.sidEnd;o++){a[s++]=this.memory[o]}var l=a.length;var n=new Uint8Array(l);for(var o=0;o<l;o++){n[o]=a[o]}if(r=="prg"){if(t.indexOf(".prg")==-1){t+=".prg"}download(n,t,"application/prg")}else{if(t.indexOf(".bin")==-1){t+=".bin"}download(n,t,"application/bin")}};this.downloadGoat=function(e){var t="music";var i="SID Title";var r="SID Author";var a="SID Released";var s=true;if(typeof e!="undefined"){if(typeof e.filename!="undefined"){t=e.filename}if(typeof e.title!="undefined"){i=e.title}if(typeof e.author!="undefined"){r=e.author}if(typeof e.released!="undefined"){a=e.released}if(typeof e.allInstruments!="undefined"){s=e.allInstruments}}var o=[];var l=0;var n="GTS5";for(var h=0;h<n.length;h++){o[l++]=n.charCodeAt(h)}var d=i;if(d.length>32){d=d.substring(0,32)}for(var h=0;h<d.length;h++){o[l++]=d.charCodeAt(h)}for(var h=d.length;h<32;h++){o[l++]=0}var c=r;if(c.length>32){c=c.substring(0,32)}for(var h=0;h<c.length;h++){o[l++]=c.charCodeAt(h)}for(var h=c.length;h<32;h++){o[l++]=0}var f=a;if(f.length>32){f=f.substring(0,32)}for(var h=0;h<f.length;h++){o[l++]=f.charCodeAt(h)}for(var h=f.length;h<32;h++){o[l++]=0}o[l++]=1;for(var h=0;h<this.tracks.length;h++){o[l++]=this.tracks[h].length+1;for(var u=0;u<this.tracks[h].length;u++){o[l++]=this.tracks[h][u]}o[l++]=255;o[l++]=0}var p=[];var v=[];var g=[];var m=[];var y=[];for(var h=0;h<this.filters.length;h++){var b=m.length;for(var u=0;u<this.filters[h].filtertable.length;u++){var C=this.filters[h].filtertable[u][0];var x=this.filters[h].filtertable[u][1];if(C==255){if(x!=0){x=x+b}}m.push([C,x])}}for(var h=0;h<this.instruments.length;h++){y[h]={};y[h].wavetableStart=p.length;if(this.instruments[h].wavetable.length>1){for(var u=0;u<this.instruments[h].wavetable.length;u++){var C=this.instruments[h].wavetable[u][0];var x=this.instruments[h].wavetable[u][1];switch(this.instruments[h].wavetable[u][0]-240){case 1:case 2:case 3:case 4:case 14:var S=this.instruments[h].speedtable[x-1][0];var P=this.instruments[h].speedtable[x-1][1];var w=false;for(var I=0;I<g.length;I++){if(g[I][0]==S&&g[I][1]==P){x=I+1;w=true}}if(!w){x=g.length+1;g.push([S,P])}break;case 9:break;case 10:break;default:break}if(C==255&&x!=0){x=x+y[h].wavetableStart}p.push([C,x])}}else{y[h].wavetableStart=-1}y[h].pulsetableStart=v.length;if(this.instruments[h].pulsetable.length>1){var k=false;for(var I=0;I<=v.length-this.instruments[h].pulsetable.length;I++){k=true;for(var u=0;u<this.instruments[h].pulsetable.length;u++){if(v[I+u][0]!=this.instruments[h].pulsetable[u][0]||v[I+u][1]!=this.instruments[h].pulsetable[u][1]){k=false;break}}if(k){y[h].pulsetableStart=I;break}}if(!k){for(var u=0;u<this.instruments[h].pulsetable.length;u++){var C=this.instruments[h].pulsetable[u][0];var x=this.instruments[h].pulsetable[u][1];if(C==255&&x!=0){x=x+y[h].pulsetableStart}v.push([C,x])}}}else{y[h].pulsetableStart=-1}this.instruments[h].vibParam=0;if(this.instruments[h].vibratoSpeed&&this.instruments[h].vibratoDepth){var M=this.instruments[h].vibratoSpeed;var T=this.instruments[h].vibratoDepth;var w=false;for(var I=0;I<g.length;I++){if(g[I][0]==M&&g[I][1]==T){w=true;this.instruments[h].vibParam=I+1;break}}if(!w){this.instruments[h].vibParam=g.length+1;g.push([M,T])}}for(var u=0;u<this.instruments[h].speedtable.length;u++){g.push([this.instruments[h].speedtable[u][0],this.instruments[h].speedtable[u][1]])}this.instruments[h].filtPtr=0;if(this.instruments[h].filtertable.length>0){this.instruments[h].filtPtr=m.length+1;for(var u=0;u<this.instruments[h].filtertable.length;u++){var C=this.instruments[h].filtertable[u][0];var x=this.instruments[h].filtertable[u][1];if(C==255){if(x!=0){x=x+this.instruments[h].filtPtr-1}}m.push([C,x])}}}for(var h=0;h<this.patterns.length;h++){for(var u=0;u<this.patterns[h].length;u+=4){var D=this.patterns[h][u];var E=this.patterns[h][u+1];var $=this.patterns[h][u+2];var _=this.patterns[h][u+3];switch($){case 1:case 2:case 3:case 4:case 14:noportamento=0;var B=_;if($==3&&B==0){this.patterns[h][u+3]=0}else{var M=B>>8;var T=B&255;var w=false;for(var I=0;I<g.length;I++){if(g[I][0]==M&&g[I][1]==T){w=true;this.patterns[h][u+3]=I+1;break}}if(!w){this.patterns[h][u+3]=g.length+1;g.push([M,T])}}break;case 10:var R=_-1;this.patterns[h][u+3]=this.filters[R].filterPtr;break}}}o[l++]=this.instruments.length;for(var h=0;h<this.instruments.length;h++){o[l++]=(this.instruments[h].attack<<4)+this.instruments[h].decay;o[l++]=(this.instruments[h].sustain<<4)+this.instruments[h].release;o[l++]=y[h].wavetableStart+1;o[l++]=y[h].pulsetableStart+1;o[l++]=this.instruments[h].filtPtr;o[l++]=this.instruments[h].vibParam;if(this.instruments[h].vibParam!=0){o[l++]=this.instruments[h].vibratoDelay+1}else{o[l++]=this.instruments[h].vibratoDelay}o[l++]=this.instruments[h].gateTimer;o[l++]=this.instruments[h].firstWave;var A=this.instruments[h].name;if(A.length>16){A=A.substring(0,16)}for(var u=0;u<A.length;u++){o[l++]=A.charCodeAt(u)}for(var u=A.length;u<16;u++){o[l++]=0}}o[l++]=p.length;for(var h=0;h<p.length;h++){o[l++]=p[h][0]}for(var h=0;h<p.length;h++){o[l++]=p[h][1]}o[l++]=v.length;for(var h=0;h<v.length;h++){o[l++]=v[h][0]}for(var h=0;h<v.length;h++){o[l++]=v[h][1]}o[l++]=m.length;for(var h=0;h<m.length;h++){o[l++]=m[h][0]}for(var h=0;h<m.length;h++){o[l++]=m[h][1]}o[l++]=g.length;for(var h=0;h<g.length;h++){o[l++]=g[h][0]}for(var h=0;h<g.length;h++){o[l++]=g[h][1]}o[l++]=this.patterns.length;for(var h=0;h<this.patterns.length;h++){o[l++]=this.patterns[h].length/4+1;for(var u=0;u<this.patterns[h].length;u++){o[l++]=this.patterns[h][u]}o[l++]=255;o[l++]=0;o[l++]=0;o[l++]=0}var F=l;var L=new Uint8Array(F);for(var h=0;h<F;h++){L[h]=o[h]}if(t.indexOf(".sng")==-1){t+=".sng"}download(L,t,"application/sng")};this.downloadSID=function(e){var t="music";var i="SID Title";var r="SID Author";var a="SID Released";var s=true;if(typeof e!="undefined"){if(typeof e.filename!="undefined"){t=e.filename}if(typeof e.title!="undefined"){i=e.title}if(typeof e.author!="undefined"){r=e.author}if(typeof e.released!="undefined"){a=e.released}if(typeof e.allInstruments!="undefined"){s=e.allInstruments}}var o=[];var l=0;o[l++]=80;o[l++]=83;o[l++]=73;o[l++]=68;o[l++]=0;o[l++]=2;o[l++]=0;o[l++]=124;o[l++]=16;o[l++]=0;o[l++]=16;o[l++]=0;o[l++]=16;o[l++]=3;o[l++]=0;o[l++]=1;o[l++]=0;o[l++]=1;o[l++]=0;o[l++]=0;o[l++]=0;o[l++]=0;if(i.length>32){i=i.substring(0,32)}for(var n=0;n<i.length;n++){o[l++]=i.charCodeAt(n)}for(var n=i.length;n<32;n++){o[l++]=0}if(r.length>32){r=r.substring(0,32)}for(var n=0;n<r.length;n++){o[l++]=r.charCodeAt(n)}for(var n=r.length;n<32;n++){o[l++]=0}if(a.length>32){a=a.substring(0,32)}for(var n=0;n<a.length;n++){o[l++]=a.charCodeAt(n)}for(var n=a.length;n<32;n++){o[l++]=0}o[l++]=0;o[l++]=0;o[l++]=0;o[l++]=0;o[l++]=0;o[l++]=0;for(var n=this.sidStart;n<this.sidEnd;n++){o[l++]=this.memory[n]}var h=l;var d=new Uint8Array(h);for(var n=0;n<h;n++){d[n]=o[n]}if(t.indexOf(".sid")==-1){t+=".sid"}download(d,t,"application/sid")};this.logTable=function(e,t){console.log("table: "+e);for(var i=0;i<t.length;i++){var r=i+1;r=r.toString(16);var a=t[i][0].toString(16);var s=t[i][1].toString(16);console.log(r+":"+a+","+s)}}};var SidFile=function(){this.music=null};SidFile.prototype={init:function(e){this.music=e},limitString:function(e,t){if(!e){return}if(e.length>t){e=e.substring(0,t)}return e},isArray:function(e){if(e.constructor===Array){return true}console.log("is not array");return false},load:function(e){var t=this.music;t.clearAll();if(typeof e.header=="undefined"){console.log("no header");return}t.name=this.limitString(e.header.name,32);t.author=this.limitString(e.header.author,32);t.copyright=this.limitString(e.header.copyright,32);t.tempo=parseInt(e.header.tempo);t.setTempo(t.tempo);var i=1;if(e.header.speed){i=parseInt(e.header.speed)}t.setSpeed(i);t.tracks=[];if(!this.isArray(e.tracks)){return}if(e.tracks.length!=3){console.log("not 3 channel"+e.tracks.length);return}for(var r=0;r<e.tracks.length;r++){t.tracks[r]=[];for(var a=0;a<e.tracks[r].length;a++){t.tracks[r][a]=e.tracks[r][a]}}if(!this.isArray(e.instruments)){return}var s=[];for(var r=0;r<e.instruments.length;r++){var o={};o.name=this.limitString(e.instruments[r].name,16);o.type=this.limitString(e.instruments[r].type,16);o.color=parseInt(e.instruments[r].color);o.attack=parseInt(e.instruments[r].a);o.decay=parseInt(e.instruments[r].d);o.sustain=parseInt(e.instruments[r].s);o.release=parseInt(e.instruments[r].r);o.vibratoSpeed=parseInt(e.instruments[r].vSp);o.vibratoDepth=parseInt(e.instruments[r].vDp);o.vibratoDelay=parseInt(e.instruments[r].vDl);o.gateTimer=parseInt(e.instruments[r].gT);o.firstWave=parseInt(e.instruments[r].fW);o.vibParam=0;o.wavetable=[];o.filtertable=[];o.pulsetable=[];o.speedtable=[];if(o.type=="basic"){o.basicWaveform=parseInt(e.instruments[r].bW);if(typeof e.instruments[r].bE=="undefined"){e.instruments[r].bE="none"}o.basicEffect=this.limitString(e.instruments[r].bE,16);o.pulseWidth=parseInt(e.instruments[r].pW);o.pulseModulationSpeed=parseInt(e.instruments[r].pMS);o.pulseModulationDepth=parseInt(e.instruments[r].pMD);if(o.basicEffect=="arpeggio"){o.arpeggioSpeed=parseInt(e.instruments[r].aS);o.arpeggioType=this.limitString(e.instruments[r].aT,16);o.arpeggioDirection=this.limitString(e.instruments[r].aD,8);if(o.arpeggioType=="custom"){o.arpeggioValues=[];for(var a=0;a<e.instruments[r].aV.length;a++){o.arpeggioValues.push(e.instruments[r].aV[a])}}}if(o.basicEffect=="tremolo"){o.tremoloOn=parseInt(e.instruments[r].tOn);o.tremoloOff=parseInt(e.instruments[r].tOf)}}else if(o.type=="drum"){o.drumType=e.instruments[r].dT;o.drumWaveform=e.instruments[r].dW}else if(o.type=="advanced"){o.wavetable=[];for(var a=0;a<e.instruments[r].wt.length;a++){o.wavetable.push([e.instruments[r].wt[a][0],e.instruments[r].wt[a][1]])}o.pulsetable=[];for(var a=0;a<e.instruments[r].pt.length;a++){o.pulsetable.push([e.instruments[r].pt[a][0],e.instruments[r].pt[a][1]])}o.filtertable=[];for(var a=0;a<e.instruments[r].ft.length;a++){o.filtertable.push([e.instruments[r].ft[a][0],e.instruments[r].ft[a][1]])}o.speedtable=[];for(var a=0;a<e.instruments[r].st.length;a++){o.speedtable.push([e.instruments[r].st[a][0],e.instruments[r].st[a][1]])}}if(o.wavetable.length>0){o.wavePtr=1}else{o.wavePtr=0}if(o.pulsetable.length>0){o.pulsePtr=1}else{o.pulsePtr=0}if(o.filtertable.length>0){o.filtPtr=1}else{o.filtPtr=0}s.push(o)}t.instruments.instruments=s;for(var r=0;r<t.instruments.instruments.length;r++){t.instruments.currentInstrument=r;if(t.instruments.instruments[r].type=="basic"){t.editInstrument.editInstrument(r);t.editInstrument.setInstrumentData()}if(t.instruments.instruments[r].type=="drum"){t.editInstrument.editInstrument(r);t.editInstrument.setInstrumentData()}}t.instruments.updateInstrumentHTML();t.instruments.updateInstruments();if(typeof t.sidPlayer!="undefined"){t.sidPlayer.testInstrumentSetup()}if(!this.isArray(e.filters)){console.log("filters is not array");return}var l=[];for(var r=0;r<e.filters.length;r++){var n={};n.name=this.limitString(e.filters[r].name,16);n.type=e.filters[r].type;if(n.type=="undefined"){n.type="advanced"}n.color=parseInt(e.filters[r].color);if(isNaN(n.color)){n.color=0}n.filtertable=[];for(var a=0;a<e.filters[r].ft.length;a++){n.filtertable.push([e.filters[r].ft[a][0],e.filters[r].ft[a][1]])}if(n.type=="basic"){n.basicFilterType=e.filters[r].bFt;n.basicFilterResonance=parseInt(e.filters[r].bRes);n.basicFilterChannels=parseInt(e.filters[r].bCh);n.basicCutoff=parseInt(e.filters[r].bCu);n.basicModulationDirection=e.filters[r].bMd;n.basicModulationTime=parseInt(e.filters[r].bMt);n.basicModulationSpeed=parseInt(e.filters[r].bMs);n.basicModulationRepeat=parseInt(e.filters[r].bRe)}l.push(n)}t.filters.filters=l;for(var r=0;r<t.filters.filters.length;r++){if(t.filters.filters[r].type=="basic"){t.editFilter.editFilter(r);t.editFilter.setFilterData()}}t.filters.updateFilterHTML();if(!this.isArray(e.patterns)){console.log("patterns is not array");return}for(var r=0;r<e.patterns.length;r++){var h=e.patterns[r].data.length;var d=e.patterns[r].name;var c=new Pattern;c.init(d,h);t.patterns.push(c);for(var a=0;a<e.patterns[r].data.length;a++){var f=e.patterns[r].data[a];t.patterns[r].data[a].start=f[0]==a;t.patterns[r].data[a].startPosition=f[0];t.patterns[r].data[a].instrument=f[1];t.patterns[r].data[a].pitch=f[2];t.patterns[r].data[a].duration=f[3];t.patterns[r].data[a].effect=f[4];t.patterns[r].data[a].effectParam=f[5];t.patterns[r].data[a].effectParam2=f[6]}}t.trackView.drawPatterns()},getSaveData:function(){var e=this.music;var t={};var i={};i.name=this.limitString(e.name,32);i.author=this.limitString(e.author,32);i.copyright=this.limitString(e.copyright,32);i.tempo=e.getTempo();i.speed=e.getSpeed();t.header=i;var r=[];for(var a=0;a<e.tracks.length;a++){r[a]=[];for(var s=0;s<e.tracks[a].length;s++){r[a][s]=e.tracks[a][s]}}t.tracks=r;var o=[];var l=e.instruments.instruments;for(var a=0;a<l.length;a++){var n={};n.name=this.limitString(l[a].name,16);if(typeof l[a].type=="undefined"){l[a].type="advanced"}n.type=this.limitString(l[a].type,16);n.color=l[a].color;n.a=l[a].attack;n.d=l[a].decay;n.s=l[a].sustain;n.r=l[a].release;n.vSp=l[a].vibratoSpeed;n.vDp=l[a].vibratoDepth;n.vDl=l[a].vibratoDelay;n.gT=l[a].gateTimer;n.fW=l[a].firstWave;if(n.type=="basic"){n.bW=l[a].basicWaveform;n.bE=l[a].basicEffect;if(typeof n.bE=="undefined"){n.bE="none"}n.pW=l[a].pulseWidth;n.pMS=l[a].pulseModulationSpeed;n.pMD=l[a].pulseModulationDepth;if(n.bE=="arpeggio"){n.aS=l[a].arpeggioSpeed;n.aT=l[a].arpeggioType;n.aD=l[a].arpeggioDirection;if(l[a].arpeggioType=="custom"){n.aV=[];for(var s=0;s<l[a].arpeggioValues.length;s++){n.aV.push(l[a].arpeggioValues[s])}}}if(n.bE=="tremolo"){n.tOn=l[a].tremoloOn;n.tOf=l[a].tremoloOff}}else if(n.type=="advanced"){n.wt=[];for(var s=0;s<l[a].wavetable.length;s++){n.wt.push([l[a].wavetable[s][0],l[a].wavetable[s][1]])}n.pt=[];for(var s=0;s<l[a].pulsetable.length;s++){n.pt.push([l[a].pulsetable[s][0],l[a].pulsetable[s][1]])}n.ft=[];for(var s=0;s<l[a].filtertable.length;s++){n.ft.push([l[a].filtertable[s][0],l[a].filtertable[s][1]])}n.st=[];for(var s=0;s<l[a].speedtable.length;s++){n.st.push([l[a].speedtable[s][0],l[a].speedtable[s][1]])}}else if(n.type=="drum"){n.dT=l[a].drumType;n.dW=l[a].drumWaveform}o.push(n)}t.instruments=o;var h=[];var d=e.filters.filters;for(var a=0;a<d.length;a++){var c={};c.name=d[a].name;c.type=d[a].type;if(c.type=="basic"){c.bFt=parseInt(d[a].basicFilterType);c.bRes=parseInt(d[a].basicFilterResonance);c.bCh=parseInt(d[a].basicFilterChannels);c.bCu=parseInt(d[a].basicCutoff);c.bMd=d[a].basicModulationDirection;c.bMt=parseInt(d[a].basicModulationTime);c.bMs=parseInt(d[a].basicModulationSpeed);c.bRe=parseInt(d[a].basicModulationRepeat)}c.ft=[];for(var s=0;s<d[a].filtertable.length;s++){c.ft.push([d[a].filtertable[s][0],d[a].filtertable[s][1]])}h.push(c)}t.filters=h;var f=[];for(var a=0;a<e.patterns.length;a++){var u={};u.name=e.patterns[a].name;u.data=[];for(var s=0;s<e.patterns[a].data.length;s++){var p=[];var v=parseInt(e.patterns[a].data[s].startPosition);if(e.patterns[a].data[s].start){v=s}p[0]=v;p[1]=parseInt(e.patterns[a].data[s].instrument);p[2]=parseInt(e.patterns[a].data[s].pitch);p[3]=parseInt(e.patterns[a].data[s].duration);p[4]=parseInt(e.patterns[a].data[s].effect);p[5]=parseInt(e.patterns[a].data[s].effectParam);p[6]=parseInt(e.patterns[a].data[s].effectParam2);for(var g=0;g<p.length;g++){if(typeof p[g]=="undefined"||isNaN(p[g])||p[g]==null){p[g]=0}}u.data.push(p)}f.push(u)}t.patterns=f;return t}};var ExportGoatTracker=function(){this.editor=null;this.uiComponent=null};ExportGoatTracker.prototype={init:function(e){this.editor=e},start:function(){var r=this;if(this.uiComponent==null){var e="";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="exportGTFilename">Filename:</label>';e+='  <input type="text" class="formControl submitOnEnter" id="exportGTFilename" value="Untitled" size="20"/>';e+="</div>";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="exportGTInstruments">Include:</label>';e+='<div class="checkboxGroup">';e+="  <div>";e+='    <label class="rb-container">All Instruments ';e+='      <input type="radio" checked="checked" id="exportGTInstruments_all" name="exportGTInstruments" value="all">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="  </div>";e+="  <div>";e+='    <label class="rb-container">Only Used Instruments';e+='      <input type="radio" id="exportGTInstruments_used" name="exportGTInstruments" value="used">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="  </div>";e+="</div>";e+="</div>";var t=310;var i=200;this.uiComponent=UI.create("UI.Dialog",{id:"exportGTDialog",title:"Export GoatTracker V2",width:t,height:i});this.exportGTHTML=UI.create("UI.HTMLPanel",{html:e});this.uiComponent.add(this.exportGTHTML);var a=UI.create("UI.Button",{text:"OK",color:"primary"});a.on("click",function(e){var t=$("#exportGTFilename").val();var i=$("input[name=exportGTInstruments]:checked").val();r.doExport({filename:t,instruments:i});UI.closeDialog()});var s=UI.create("UI.Button",{text:"Cancel",color:"secondary"});s.on("click",function(e){UI.closeDialog()});this.uiComponent.addButton(a);this.uiComponent.addButton(s)}UI.showDialog("exportGTDialog");this.initContent()},initContent:function(){},doExport:function(e){this.editor.createSid();this.editor.songData.downloadGoat(e)}};var ExportSID=function(){this.editor=null;this.uiComponent=null};ExportSID.prototype={init:function(e){this.editor=e},start:function(){var i=this;if(this.uiComponent==null){var e="";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="exportSIDFilename">Filename:</label>';e+='  <input type="text" class="formControl submitOnEnter" id="exportSIDFilename" value="Untitled" size="20"/>';e+="</div>";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="exportSIDInstruments">Include:</label>';e+='<div class="checkboxGroup">';e+="  <div>";e+='    <label class="rb-container">All Instruments ';e+='      <input type="radio" checked="checked" id="exportSIDInstruments_all" name="exportSIDInstruments" value="all">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="  </div>";e+="  <div>";e+='    <label class="rb-container">Only Used Instruments';e+='      <input type="radio" id="exportSIDInstruments_used" name="exportSIDInstruments" value="used">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="  </div>";e+="</div>";e+="</div>";var t=260;var r=200;this.uiComponent=UI.create("UI.Dialog",{id:"exportSIDDialog",title:"Export SID",width:t,height:r});this.exportOBJHTML=UI.create("UI.HTMLPanel",{html:e});this.uiComponent.add(this.exportOBJHTML);var a=UI.create("UI.Button",{text:"OK",color:"primary"});a.on("click",function(e){var t=$("#exportSIDFilename").val();i.doExport({filename:t});UI.closeDialog()});var s=UI.create("UI.Button",{text:"Cancel",color:"secondary"});s.on("click",function(e){UI.closeDialog()});this.uiComponent.addButton(a);this.uiComponent.addButton(s)}UI.showDialog("exportSIDDialog");this.initContent()},initContent:function(){},doExport:function(e){this.editor.createSid();this.editor.songData.downloadSID(e)}};var ExportSIDPRG=function(){this.editor=null;this.uiComponent=null};ExportSIDPRG.prototype={init:function(e){this.editor=e},start:function(){var a=this;if(this.uiComponent==null){var e="";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="exportSIDPRGFilename">Filename:</label>';e+='  <input type="text" class="formControl submitOnEnter" id="exportSIDPRGFilename" value="Untitled" size="20"/>';e+="</div>";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="exportSIDPRGFilename">Type:</label>';e+='<div class="checkboxGroup">';e+="  <div>";e+='    <label class="rb-container">PRG ';e+='      <input type="radio" checked="checked" id="exportSIDPRGType_prg" name="exportSIDPRGType" value="prg">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="  </div>";e+="  <div>";e+='    <label class="rb-container">BIN';e+='      <input type="radio" id="exportSIDPRGType_bin" name="exportSIDPRGType" value="bin">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="  </div>";e+="</div>";e+="</div>";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="exportSIDPRGInstruments">Include:</label>';e+='<div class="checkboxGroup">';e+="  <div>";e+='    <label class="rb-container">All Instruments ';e+='      <input type="radio" checked="checked" id="exportSIDPRGInstruments_all" name="exportSIDPRGInstruments" value="all">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="  </div>";e+="  <div>";e+='    <label class="rb-container">Only Used Instruments';e+='      <input type="radio" id="exportSIDPRGInstruments_used" name="exportSIDPRGInstruments" value="used">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="  </div>";e+="</div>";e+="</div>";var t=360;var i=260;this.uiComponent=UI.create("UI.Dialog",{id:"exportSIDPRGDialog",title:"Export PRG",width:t,height:i});this.exportOBJHTML=UI.create("UI.HTMLPanel",{html:e});this.uiComponent.add(this.exportOBJHTML);var r=UI.create("UI.Button",{text:"OK",color:"primary"});r.on("click",function(e){var t=$("#exportSIDPRGFilename").val();var i=$("input[name=exportSIDPRGType]:checked").val();var r=$("input[name=exportSIDPRGInstruments]:checked").val();a.doExport({filename:t,type:i,instruments:r});UI.closeDialog()});var s=UI.create("UI.Button",{text:"Cancel",color:"secondary"});s.on("click",function(e){UI.closeDialog()});this.uiComponent.addButton(r);this.uiComponent.addButton(s)}UI.showDialog("exportSIDPRGDialog");this.initContent()},initContent:function(){},doExport:function(e){console.log(e);this.editor.createSid();this.editor.songData.downloadPRG(e)}};var CodeEditor=function(){this.eventHandlers={};this.annotations=[];this.lastLine=false;this.fontSize=14;this.lineHeight=1.4;this.theme="tomorrow_night";this.showInvisibles=true;this.tabIndentation=false;this.autocomplete=true;this.assemblerEditor=null};CodeEditor.prototype={init:function(e,t){this.mode="ace/mode/assembly_6502";if(typeof e!="undefined"){this.mode=e}if(typeof t!="undefined"){this.assemblerEditor=t}else{this.assemblerEditor=g_app.assemblerEditor}},buildInterface:function(e){this.id=UI.getID();var t='<div class="panelFill" style="background-color:#333333;">';t+='  <div style="position: absolute; top: 0; bottom: 0; left: 0; right: 0" id="codeEditor'+this.id+'"></div>';t+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{html:t});e.add(this.uiComponent);var i=this;UI.on("ready",function(){i.initContent()});this.uiComponent.on("resize",function(){i.resize()})},on:function(e,t){this.eventHandlers[e]=t},initContent:function(){var a=this;var e=document.getElementById("codeEditor"+this.id);ace.config.set("basePath","lib/ace/src");ace.require("ace/ext/language_tools");this.editor=ace.edit("codeEditor"+this.id);this.editor.setOptions({enableBasicAutocompletion:true,enableLiveAutocompletion:true});this.theme=g_app.getPref("codeeditor.theme");if(this.theme==null){this.theme="tomorrow_night"}this.editor.setTheme("ace/theme/"+this.theme);if(this.mode!="javascript"&&this.mode!="json"&&this.mode!="text"&&this.mode!="c64basic"){this.editor.completers=[];this.editor.completers.push({getCompletions:function(e,t,i,r,a){var s=t.getLine(i.row);var o=g_app.assemblerEditor.getCompletions(s,i);a(null,o)}})}else{if(this.mode=="javascript"){this.editor.completers.push({getCompletions:function(e,t,i,r,a){var s=t.getLine(i.row)}})}}this.editor.getSession().setTabSize(2);this.editor.getSession().setUseSoftTabs(true);this.fontSize=parseInt(g_app.getPref("codeeditor.fontsize"),10);this.editor.container.style.lineHeight=this.lineHeight;this.editor.renderer.updateFontSize();this.editor.on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});this.editor.on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});this.selection=this.editor.getSelection();this.selection.on("changeCursor",function(){a.changeCursor()});this.editor.on("change",function(e){a.change(e)});this.editor.on("guttermousedown",function(e){var t=e.domEvent.target;if(t.className.indexOf("ace_gutter-cell")==-1){return}var i=e.editor.session.getBreakpoints();var r=e.getDocumentPosition().row;if(typeof i[r]===typeof undefined){if(typeof a.eventHandlers["setbreakpoint"]!="undefined"){a.eventHandlers["setbreakpoint"](r)}e.editor.session.setBreakpoint(r)}else{if(typeof a.eventHandlers["clearbreakpoint"]!="undefined"){a.eventHandlers["clearbreakpoint"](r)}e.editor.session.clearBreakpoint(r)}e.stop()});this.editor.commands.addCommand({name:"run",bindKey:{win:"F5",mac:"F5"},exec:function(e){if(typeof a.eventHandlers["run"]!="undefined"){a.eventHandlers["run"]()}else{a.assemblerEditor.run()}}});this.editor.commands.addCommand({name:"build",bindKey:{win:"F6",mac:"F6"},exec:function(e){a.assemblerEditor.build()}});this.editor.commands.addCommand({name:"playpause",bindKey:{win:"F9",mac:"F9"},exec:function(e){a.assemblerEditor.machinePlay()}});this.editor.commands.addCommand({name:"stepover",bindKey:{win:"F10",mac:"F10"},exec:function(e){a.assemblerEditor.machineStepOver()}});this.editor.commands.addCommand({name:"stepinto",bindKey:{win:"F11",mac:"F11"},exec:function(e){a.assemblerEditor.machineStepInto()}});this.editor.commands.addCommand({name:"projectexplorer",bindKey:{win:"Ctrl-P",mac:"Cmd-P"},exec:function(e){g_app.projectNavigator.toggleVisible()}});this.editor.commands.addCommand({name:"f3search",bindKey:{win:"F3",mac:"F3"},exec:function(){var e=a.editor.getLastSearchOptions();e={};a.editor.findNext(e,true)}});var t="ace/mode/assembly_6502";if(this.mode=="javascript"){t="ace/mode/text"}if(this.mode=="text"){t="ace/mode/text"}if(this.mode=="c64basic"){t="ace/mode/c64basic"}this.editor.getSession().setMode(t);this.showInvisibles=g_app.getPref("codeeditor.hideinvisibles")!=="yes";this.setShowInvisibles(this.showInvisibles);this.tabIndentation=g_app.getPref("codeeditor.tabindentation")=="yes";this.setTabIndentation(this.tabIndentation);this.setAutocomplete(g_app.getPref("codeeditor.autocomplete")!="no");this.editor.gotoLine(1)},on:function(e,t){this.eventHandlers[e]=t},change:function(e){if(e.lines.length>1){}if(this.eventHandlers.hasOwnProperty("change")){this.eventHandlers.change(e)}},undo:function(){this.editor.undo()},redo:function(){this.editor.redo()},setFontSize:function(e){this.fontSize=e;if(typeof this.editor!="undefined"){this.editor.setFontSize(this.fontSize)}},getScrollTop:function(){var e=this.editor.getSession();return e.getScrollTop()},getEditSession:function(){return this.editor.getSession()},setEditSession:function(e){this.editor.setSession(e)},setScrollTop:function(e){var t=this.editor.getSession();return t.setScrollTop(e)},setTheme:function(e){console.log("SET THEME"+e);this.theme=e;this.editor.setTheme("ace/theme/"+this.theme);g_app.setPref("codeeditor.theme",this.theme)},setShowInvisibles:function(e){this.showInvisibles=e;this.editor.setShowInvisibles(this.showInvisibles);g_app.setPref("codeeditor.hideinvisibles",this.showInvisibles?"no":"yes");UI("view-toggle-invisible-characters").setChecked(this.showInvisibles);if(UI.exists("c64-view-toggle-invisible-characters")){UI("c64-view-toggle-invisible-characters").setChecked(this.showInvisibles)}},toggleInvisibles:function(){this.setShowInvisibles(!this.showInvisibles)},setAutocomplete:function(e){this.autocomplete=e;UI("view-toggle-autocomplete").setChecked(this.autocomplete);if(UI.exists("c64-view-toggle-autocomplete")){UI("c64-view-toggle-autocomplete").setChecked(this.autocomplete)}this.editor.setOptions({enableBasicAutocompletion:this.autocomplete,enableLiveAutocompletion:this.autocomplete});g_app.setPref("codeeditor.autocomplete",this.autocomplete?"yes":"no")},toggleAutocomplete:function(){this.setAutocomplete(!this.autocomplete)},setTabIndentation:function(e){var t=this.editor.getSession();if(!t){return}if(typeof e!="undefined"){this.tabIndentation=e}UI("view-toggle-tabindentation").setChecked(this.tabIndentation);if(UI.exists("c64-view-toggle-tabindentation")){UI("c64-view-toggle-tabindentation").setChecked(this.tabIndentation)}if(this.tabIndentation){t.setTabSize(2);t.setUseSoftTabs(true)}else{t.setTabSize(2);t.setUseSoftTabs(false)}g_app.setPref("codeeditor.tabindentation",this.tabIndentation?"yes":"no")},toggleTabIndentation:function(){this.setTabIndentation(!this.tabIndentation)},changeCursor:function(){var e=this.selection.getCursor();var t=parseInt(e.row,10);if(!isNaN(t)){if(this.eventHandlers.hasOwnProperty("changeCursor")){this.eventHandlers.changeCursor(e)}}},resize:function(){if(this.editor&&this.editor.resize){this.editor.resize()}},getValue:function(){return this.editor.getValue()},setValue:function(e){this.editor.setValue(e,-1)},gotoLine:function(e){this.editor.gotoLine(e,0,false)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},clearAnnotations:function(){this.annotations=[];this.editor.getSession().setAnnotations(this.annotations)},addAnnotation:function(e){this.annotations.push(e);this.editor.getSession().setAnnotations(this.annotations)},start:function(){}};var TextEditor=function(){this.doc=null;this.path="";this.uiComponent=null;this.codeEditor=null};TextEditor.prototype={modified:function(){if(g_app.openingProject){return}g_app.doc.recordModified(this.doc,this.path)},init:function(e){this.parentPanel=e.parentPanel},show:function(){if(!this.uiComponent){this.buildInterface()}},buildInterface:function(e){if(this.uiComponent!=null){return}this.uiComponent=UI.create("UI.Panel",{id:"textEditor"});e.add(this.uiComponent);var t=UI.create("UI.Panel");this.uiComponent.add(t);this.codeEditor=new CodeEditor;this.codeEditor.init("text");this.codeEditor.buildInterface(t);this.codeEditor.on("change",function(e){i.codeEditorChange()});var i=this;UI.on("ready",function(){i.initEvents()})},initEvents:function(){},codeEditorChange:function(){if(this.doc!=null){this.modified();this.doc.data=this.codeEditor.getValue()}},saveSettings:function(e){e[this.path]={scrollTop:this.codeEditor.getScrollTop(),editSession:this.codeEditor.getEditSession()}},load:function(e,t,i){console.log("current path = "+this.path);console.log("new path = "+e);if(typeof t=="undefined"&&e==this.path){return}this.doc=null;this.path=e;var r=g_app.doc.getDocRecord(e);if(r!=null){this.doc=r;if(typeof i!="undefined"&&typeof i[e]!="undefined"){console.log("set edit session");this.codeEditor.setEditSession(i[e].editSession)}else{console.log("create edit session");var a=r.data;if(!isString(r.data)){a=JSON.stringify(a,null,2)}this.codeEditor.setEditSession(ace.createEditSession(a,"ace/mode/text"))}if(typeof t!="undefined"){this.codeEditor.gotoLine(t)}}}};var Assembler=function(){this.memory=null;this.pc=4096;this.labels={};this.lines=[];this.start=0;this.end=0;this.errors=[];this.opcodes={adc:{im:105,zp:101,zpx:117,abs:109,absx:125,absy:121,indx:97,indy:113},and:{im:41,zp:37,zpx:53,abs:45,absx:61,absy:57,indx:33,indy:49},asl:{zp:6,zpx:22,abs:14,absx:30,sngl:10},bit:{zp:36,abs:44},bpl:{bra:16},bmi:{bra:48},bvc:{bra:80},bvs:{bra:112},bcc:{bra:144},bcs:{bra:176},bne:{bra:208},beq:{bra:240},brk:{sngl:0},cmp:{im:201,zp:197,zpx:213,abs:205,absx:221,absy:217,indx:193,indy:209},cpx:{im:224,zp:228,abs:236},cpy:{im:192,zp:196,abs:204},dec:{zp:198,zpx:214,abs:206,absx:222},eor:{im:73,zp:69,zpx:85,abs:77,absx:93,absy:89,indx:65,indy:81},clc:{sngl:24},sec:{sngl:56},cli:{sngl:88},sei:{sngl:120},clv:{sngl:184},cld:{sngl:216},sed:{sngl:248},inc:{zp:230,zpx:246,abs:238,absx:254},jmp:{abs:76,ind:108},jsr:{abs:32},lda:{im:169,zp:165,zpx:181,abs:173,absx:189,absy:185,indx:161,indy:177},ldx:{im:162,zp:166,zpy:182,abs:174,absy:190},ldy:{im:160,zp:164,zpx:180,abs:172,absx:188},lsr:{zp:70,zpx:86,abs:78,absx:94,sngl:74},nop:{sngl:234},ora:{im:9,zp:5,zpx:21,abs:13,absx:29,absy:25,indx:1,indy:17},tax:{sngl:170},txa:{sngl:138},dex:{sngl:202},inx:{sngl:232},tay:{sngl:168},tya:{sngl:152},dey:{sngl:136},iny:{sngl:200},ror:{zp:102,zpx:118,abs:110,absx:126,sngl:106},rol:{zp:38,zpx:54,abs:46,absx:62,sngl:42},rti:{sngl:64},rts:{sngl:96},sbc:{im:233,zp:229,zpx:245,abs:237,absx:253,absy:249,indx:225,indy:241},sta:{zp:133,zpx:149,abs:141,absx:157,absy:153,indx:129,indy:145},txs:{sngl:154},tsx:{sngl:186},pha:{sngl:72},pla:{sngl:104},php:{sngl:8},plp:{sngl:40},stx:{zp:134,zpy:150,abs:142},sty:{zp:132,zpx:148,abs:140}}};Assembler.prototype={init:function(){this.memory=new Uint8Array(65536)},getMemory:function(){return this.memory},logError:function(e){this.errors.push({line:this.lineNumber,message:e})},assembleLine:function(e,t){this.pc=t;var i=this.pc;var r=e.split(/\ +/);if(r.length>0){var a=r[0].toLowerCase();var s="";for(var o=1;o<r.length;o++){s+=r[o].trim()}if(this.opcodes.hasOwnProperty(a)){if(this.opcodeLine(this.opcodes[a],s,false)===false){return{success:false,error:"Invalid param: "+s}}}else{console.log("unknown instruction: "+a);return{success:false,error:"Unknown instruction: "+a}}}var l=[];var n=this.pc;for(var t=i;t<n;t++){l.push(this.memory[t])}var h={success:true,bytes:l};return h},assemble:function(e,t){var i=[];this.errors=[];if(typeof t=="undefined"){t=2049}this.lines=[];this.labels={};for(var r=0;r<this.memory.length;r++){this.memory[r]=0}var a={};this.pc=t;this.start=this.pc;a.start=this.pc;var s=e.split("\n");for(var o=0;o<s.length;o++){var l=s[o];this.lineNumber=o;var n=l;var h=this.pc;var d=l.indexOf(";");if(d!=-1){l=l.substring(0,d)}l=l.trim();if(l!=""){if(l.length>1&&l[0]=="*"&&l[1]=="="){l=l.substring(2).trim();a.end=this.pc;if(a.end!=a.start){i.push(a)}a={};if(l.match(/^\$[0-9a-f]{3,4}$/i)){this.pc=parseInt(l.replace(/^\$/,""),16)&65535}else{this.logError("bad address: "+l)}a.start=this.pc}else if(l.indexOf("=")!==-1){var c=l.split("=");if(c.length>1){var f=c[0].trim();var u=c[1].trim();if(u=="*"){this.addLabel(f,this.pc)}else{var p=false;if(u.match(/^\$[0-9a-f]{1,2}$/i)){p=parseInt(u.replace(/^\$/,""),16)&255;this.addLabel(f,p)}else if(u.match(/^\$[0-9a-f]{3,4}$/i)){p=parseInt(u.replace(/^\$/,""),16)&65535;this.addLabel(f,p)}else if(!isNaN(parseInt(u))){p=parseInt(u);this.addLabel(f,p)}else{p=this.parseParam(u);if(p!==false){this.addLabel(f,p)}}}}}else{var c=l.split(/\ +/);if(c.length>0){var v=c[0].toLowerCase();var u="";for(var r=1;r<c.length;r++){u+=c[r].trim()}if(v=="byte"||v=="!byte"){this.bytesLine(u)}else if(this.opcodes.hasOwnProperty(v)){this.opcodeLine(this.opcodes[v],u)}else{var f=c[0];if(this.pc==a.start&&typeof a.label=="undefined"){a.label=f}this.addLabel(f,this.pc)}}}}var g=this.pc;this.lines.push({src:n,lineIndex:o+r,memStart:h,memEnd:g})}this.processLabels();this.end=this.pc;a.end=this.pc;if(a.end!=a.start){i.push(a)}var m=this.errors.length==0;return{success:m,errors:this.errors,start:this.start,end:this.end,blocks:i}},parseParam:function(param){var action=false;if(param[0]=="<"){action="lowerbyte";param=param.substr(1)}else if(param[0]==">"){action="upperbyte";param=param.substr(1)}var error=false;var parts=param.split(/(?:\+|\-| )+/);for(var i=0;i<parts.length;i++){var key=parts[i];if(this.labels.hasOwnProperty(key)){param=param.replace(key,this.labels[key].value)}else if(isNaN(key)){this.logError("unknown value: "+param);error=true}}if(!error){value=eval(param);if(action=="lowerbyte"){value=value&255}else if(action=="upperbyte"){value=value>>8&255}return value}else{this.logError("unknown value: "+param)}return false},getDisassembly:function(){var e="";for(var t=0;t<this.lines.length;t++){var i=("0000"+this.lines[t].memStart.toString(16)).substr(-4);e+=i;e+="  ";for(var r=this.lines[t].memStart;r<this.lines[t].memEnd;r++){var a=this.memory[r].toString(16);if(a.length==1){a="0"+a}e+=a+" "}for(var r=0;r<4-(this.lines[t].memEnd-this.lines[t].memStart);r++){e+="   "}e+=this.lines[t].src;e+="\n"}return e},addLabel:function(e,t){if(typeof this.labels[e]=="undefined"){this.labels[e]={}}this.labels[e].value=t},processLabels:function(){for(var e in this.labels){var t=this.parseParam(e);if(t===false){this.logError("undefined label: "+e)}else{for(var i in this.labels[e]){switch(i){case"w":for(var r=0;r<this.labels[e]["w"].length;r++){var a=this.labels[e][i][r].location;var s=this.labels[e][i][r].offset;t+=s;this.memory[a++]=t&255;this.memory[a]=t>>8&255}break;case"r":for(var r=0;r<this.labels[e]["r"].length;r++){var a=this.labels[e][i][r].location;var s=this.labels[e][i][r].offset;t+=s;if(t<a){this.memory[a++]=255-(a-t)+1}else{this.memory[a++]=t-a}}break;case"h":for(var r=0;r<this.labels[e]["h"].length;r++){var a=this.labels[e][i][r].location;var s=this.labels[e][i][r].offset;t+=s;this.memory[a]=t>>8&255}break;case"l":for(var r=0;r<this.labels[e]["l"].length;r++){var a=this.labels[e][i][r].location;var s=this.labels[e][i][r].offset;t+=s;this.memory[a]=t&255}break}}}}},addLabelPlaceholder:function(e,t,i,r){if(typeof this.labels[e]=="undefined"){this.labels[e]={}}if(i=="w"){if(typeof this.labels[e]["w"]=="undefined"){this.labels[e]["w"]=[]}this.labels[e]["w"].push({location:t,offset:r})}else if(i=="r"){if(typeof this.labels[e]["r"]=="undefined"){this.labels[e]["r"]=[]}this.labels[e]["r"].push({location:t,offset:r})}else if(i=="h"){if(typeof this.labels[e]["h"]=="undefined"){this.labels[e]["h"]=[]}this.labels[e]["h"].push({location:t,offset:r})}else{if(typeof this.labels[e]["l"]=="undefined"){this.labels[e]["l"]=[]}this.labels[e]["l"].push({location:t,offset:r})}},bytesLine:function(e){var t=e.split(",");for(var i=0;i<t.length;i++){var r=false;if(t[i].match(/^\$[0-9a-f]{1,2}$/i)){r=parseInt(t[i].replace(/^\$/,""),16)&255}else if(!isNaN(parseInt(t[i]))){r=parseInt(t[i])}else{r=this.parseParam(t[i])}if(r===false||isNaN(r)){this.logError("unrecognised byte: "+t[i])}else{this.memory[this.pc++]=r}}},opcodeLine:function(e,t,i){if(t==""){if(!e.hasOwnProperty("sngl")){this.logError("missing parameter");return false}this.memory[this.pc++]=e["sngl"];return true}var r=true;if(typeof i!="undefined"){r=i}var a=0;var s;var o=0;if(e.hasOwnProperty("im")){if(t.match(/^#\$[0-9a-f]{1,2}$/i)){a=parseInt(t.replace(/^#\$/,""),16)&255;var l=a.toString(16);this.memory[this.pc++]=e["im"];this.memory[this.pc++]=a;return"im"}if(t.match(/^#\%[0-1]{1,8}$/i)){a=parseInt(t.replace(/^#\%/,""),2)&255;var l=a.toString(16);this.memory[this.pc++]=e["im"];this.memory[this.pc++]=a;return"im"}if(t.match(/^#[0-9]{1,3}$/i)){a=parseInt(t.replace(/^#/,""),10)&255;if(!e.hasOwnProperty("im")){return false}this.memory[this.pc++]=e["im"];this.memory[this.pc++]=a;return"im"}if(r){if(t.match(/^#[<>]\w+$/)){n=t.replace(/^#[<>](\w+)$/,"$1");hl=t.replace(/^#([<>]).*$/,"$1");this.memory[this.pc++]=e["im"];if(hl==">"){this.addLabelPlaceholder(n,this.pc,"h",o);this.memory[this.pc++]=0}else{this.addLabelPlaceholder(n,this.pc,"l",o);this.memory[this.pc++]=0}return true}}if(r){if(t[0]=="#"){n=t.substr(1);this.memory[this.pc++]=e["im"];this.addLabelPlaceholder(n,this.pc,"l",o);this.memory[this.pc++]=0;return true}}}if(e.hasOwnProperty("zp")){if(t.match(/^\$[0-9a-f]{1,2}$/i)){a=parseInt(t.replace(/^\$/,""),16)&255;this.memory[this.pc++]=e["zp"];this.memory[this.pc++]=a;return true}if(r){if(this.labels.hasOwnProperty(t)&&this.labels[t].hasOwnProperty("value")&&this.labels[t].value<=255){this.memory[this.pc++]=e["zp"];this.memory[this.pc++]=this.labels[t].value;return true}}}if(e.hasOwnProperty("zpx")){if(t.match(/^\$[0-9a-f]{1,2},x/i)){a=parseInt(t.replace(/^\$([0-9a-f]{1,2}),x/i,"$1"),16)&255;this.memory[this.pc++]=e["zpx"];this.memory[this.pc++]=a;return"zpx"}if(r){if(t.match(/^\w+,x$/i)){var n=t.replace(/,x$/i,"");if(this.labels.hasOwnProperty(n)&&this.labels[n].hasOwnProperty("value")&&this.labels[n].value<=255){this.memory[this.pc++]=e["zpx"];this.memory[this.pc++]=this.labels[n].value;returntrue}}}}if(e.hasOwnProperty("zpy")){if(t.match(/^\$[0-9a-f]{1,2},y/i)){a=parseInt(t.replace(/^\$([0-9a-f]{1,2}),y/i,"$1"),16)&255;this.memory[this.pc++]=e["zpy"];this.memory[this.pc++]=a;return"zpy"}if(r){if(t.match(/^\w+,y$/i)){var n=t.replace(/,y$/i,"");if(this.labels.hasOwnProperty(n)&&this.labels[n].hasOwnProperty("value")&&this.labels[n].value<=255){this.memory[this.pc++]=e["zpy"];this.memory[this.pc++]=this.labels[n].value;return true}}}}if(e.hasOwnProperty("absx")){if(t.match(/^\$[0-9a-f]{3,4},x$/i)){a=parseInt(t.replace(/^\$([0-9a-f]*),x/i,"$1"),16)&65535;this.memory[this.pc++]=e["absx"];this.memory[this.pc++]=a&255;this.memory[this.pc++]=a>>8;return true}if(r){if(t.match(/^\w+,x$/i)){var n=t.replace(/,x$/i,"");this.memory[this.pc++]=e["absx"];this.addLabelPlaceholder(n,this.pc,"w",o);this.memory[this.pc++]=0;this.memory[this.pc++]=0;return true}}}if(e.hasOwnProperty("absy")){if(t.match(/^\$[0-9a-f]{3,4},y$/i)){a=parseInt(t.replace(/^\$([0-9a-f]*),y/i,"$1"),16)&65535;this.memory[this.pc++]=e["absy"];this.memory[this.pc++]=a&255;this.memory[this.pc++]=a>>8;return"aby"}if(r){if(t.indexOf(",y")!=-1&&t[0]!="("){var n=t.replace(/,y$/i,"");this.memory[this.pc++]=e["absy"];this.addLabelPlaceholder(n,this.pc,"w",o);this.memory[this.pc++]=0;this.memory[this.pc++]=0;return"absy"}}}if(e.hasOwnProperty("ind")){if(t.match(/^\(\$[0-9a-f]{4}\)$/i)){a=parseInt(t.replace(/^\(\$([0-9a-f]{4}).*$/i,"$1"),16)&65535;this.memory[this.pc++]=e["ind"];this.memory[this.pc++]=a&255;this.memory[this.pc++]=a>>8;return"ind"}}if(e.hasOwnProperty("indx")){if(t.match(/^\(\$[0-9a-f]{1,2},x\)$/i)){a=parseInt(t.replace(/^\(\$([0-9a-f]{1,2}).*$/i,"$1"),16)&255;this.memory[this.pc++]=e["indx"];this.memory[this.pc++]=a&255;return"indx"}if(r){if(t.match(/^\(\w+\,x\)$/i)){var n=t.replace(/,x\)$/i,"");n=n.substring(1);if(this.labels.hasOwnProperty(n)&&this.labels[n].hasOwnProperty("value")&&this.labels[n].value<=255){this.memory[this.pc++]=e["indx"];this.memory[this.pc++]=this.labels[n].value;return true}}}}if(e.hasOwnProperty("indy")){if(t.match(/^\(\$[0-9a-f]{1,2}\),y$/i)){a=parseInt(t.replace(/^\([\$]([0-9a-f]{1,2}).*$/i,"$1"),16)&255;alert(a);this.memory[this.pc++]=e["indy"];this.memory[this.pc++]=a&255;return"indy"}if(r){if(t.match(/^\(\w+\),y$/i)){var n=t.replace(/\),y$/i,"");n=n.substring(1);if(this.labels.hasOwnProperty(n)&&this.labels[n].hasOwnProperty("value")&&this.labels[n].value<=255){this.memory[this.pc++]=e["indy"];this.memory[this.pc++]=this.labels[n].value;return true}}}}if(e.hasOwnProperty("abs")){if(t.match(/^\$[0-9a-f]{3,4}$/i)){a=parseInt(t.replace(/^\$/,""),16)&65535;this.memory[this.pc++]=e["abs"];this.memory[this.pc++]=a&255;this.memory[this.pc++]=a>>8;return"abs"}if(r){this.memory[this.pc++]=e["abs"];this.addLabelPlaceholder(t,this.pc,"w",o);this.memory[this.pc++]=0;this.memory[this.pc++]=0;return"abs"}}if(e.hasOwnProperty("bra")){if(t.indexOf("$")===0){this.memory[this.pc++]=e["bra"];var h=t.substr(1);h=parseInt(h,16);var d=h-(this.pc+1);if(d<0){d=256+d}this.memory[this.pc++]=d;return true}else if(t.match(/\w+/)){if(r){this.memory[this.pc++]=e["bra"];this.addLabelPlaceholder(t,this.pc,"r",o);this.memory[this.pc++]=0;return true}}}return false}};var AssemblerEditor=function(){this.files=new AssemblerFiles;this.codeEditor=null;this.doc=null;this.path=false;this.acmeAssembler=null;this.acmeWorker=null;this.exomizerWorker=null;this.ca65Assembler=null;this.preprocessor=null;this.debuggerCompact=null;this.useAssembler="acme";this.acmeParser=null;this.targetMachine="x16";this.lastEditorLine=false;this.inResize=false;this.fontSize=10;this.breakpoints={};this.prefix="";this.assembleCallback=false};AssemblerEditor.prototype={init:function(){this.preprocessor=new AssemblerPreprocessor;this.preprocessor.init(this)},modified:function(){if(g_app.openingProject){return}g_app.doc.recordModified(this.doc,this.path)},willReceiveKeyboardEvents:function(e){if(e==false){if(this.debuggerCompact){this.debuggerCompact.blurMachine()}}},buildC64DebuggerInterface:function(e){this.prefix="c64debugger";var t=UI.create("UI.SplitPanel",{id:this.prefix+"assemblerContent"});e.add(t);var i=420;var r=30;var a=UI.create("UI.SplitPanel");t.add(a);var s=UI.create("UI.Panel",{id:this.prefix+"codeEditorPanel"});a.add(s);var o=UI.create("UI.Panel");a.addSouth(o,r,false);var l=UI.create("UI.Panel");t.addEast(l,i,true);this.codeEditor=new CodeEditor;this.codeEditor.init("ace/mode/assembly_6502",this);this.codeEditor.buildInterface(s);var n=this;this.codeEditor.on("change",function(e){n.codeEditorChange(e)});this.codeEditor.on("changeCursor",function(e){n.codeEditorChangeCursor(e)});this.codeEditor.on("setbreakpoint",function(e){n.breakpointSet(e)});this.codeEditor.on("clearbreakpoint",function(e){n.breakpointCleared(e)});this.acmeParser=new AcmeParser;this.acmeParser.init(this);this.buildControls=new BuildControls;this.buildControls.init(this,this.prefix);this.buildControls.buildInterface(o);this.assemblerOutput=new AssemblerOutput;this.assemblerOutput.init(this,this.prefix);this.assemblerOutput.buildInterface(l);UI.on("ready",function(){UI(n.prefix+"assemblerContent").resize()})},buildInterface:function(e){var r=this;var t=g_app.isMobile();var i=30;var a=200;if(t){i=50;a=120}var s=UI.create("UI.SplitPanel",{id:"assembler"});e.add(s);var o=false;if(t){o=true}var l=UI.create("UI.SplitPanel",{id:"toolsSplitPanel"});var n=g_app.getPref("assembler-tools-panelsizeh");if(typeof n=="undefined"||n==null){n=780}else{n=parseInt(n,10)}if(isNaN(n)||n<10){n=780}s.addEast(l,n,true,o);s.on("resizeeast",function(e){g_app.setPref("assembler-tools-panelsizeh",e)});var h=UI.create("UI.SplitPanel",{id:"assemblerLibraryPanel"});var n=g_app.getPref("assembler-library-panelsizeh");if(typeof n=="undefined"||n==null){n=360}else{n=parseInt(n,10)}if(isNaN(n)||n<10){n=360}l.addEast(h,n,true,o);l.on("resizeeast",function(e){g_app.setPref("assembler-library-panelsizeh",e)});this.tabPanel=UI.create("UI.TabPanel",{canCloseTabs:false});this.tabPanel.addTab({key:"mos6502OpcodesPanel",title:"Docs",isTemp:false},true);this.tabPanel.addTab({key:"calculatorPanel",title:"Calculator",isTemp:false},false);this.tabPanel.on("tabfocus",function(e,t){var i=r.tabPanel.getTabIndex(e);if(i>=0){r.showContent(e)}});h.addNorth(this.tabPanel,30);var d=UI.create("UI.Panel",{id:"assemblerToolsPanel"});h.add(d);this.calculator=new Calculator;this.calculator.init(this,"assembler");this.calculator.buildInterface(d);this.mos6502Opcodes=new MOS6502Opcodes;this.mos6502Opcodes.init(this,"assembler");this.mos6502Opcodes.buildInterface(d);this.c64MemoryMap=new C64MemoryMap;this.c64MemoryMap.init(this);this.c64MemoryMap.buildInterface(d);var c=UI.create("UI.SplitPanel",{id:"assemblerContent"});s.add(c);var f=UI.create("UI.SplitPanel");c.addSouth(f,a,true);var u=UI.create("UI.Panel",{id:"codeEditorPanel"});c.add(u);var p=false;if(t){p=true}var v=UI.create("UI.Panel",{id:"codeEditorEmulator"});l.add(v);if(!p){this.debuggerCompact=new C64Debugger;this.debuggerCompact.init({type:"compact"});this.debuggerCompact.buildInterface(v);var r=this;UI.on("ready",function(){UI("assemblerToolsPanel").showOnly("assembler"+"mos6502OpcodesPanel")})}UI.on("ready",function(){UI("codeEditorPanel").on("resize",function(){r.codeEditorPanelResize()})});var g=UI.create("UI.Panel");f.addNorth(g,i,false);var m=UI.create("UI.Panel");f.add(m);this.codeEditor=new CodeEditor;this.codeEditor.init(this);this.codeEditor.buildInterface(u);this.codeEditor.on("change",function(e){r.codeEditorChange(e)});this.codeEditor.on("changeCursor",function(e){r.codeEditorChangeCursor(e)});this.codeEditor.on("setbreakpoint",function(e){r.breakpointSet(e)});this.codeEditor.on("clearbreakpoint",function(e){r.breakpointCleared(e)});this.acmeParser=new AcmeParser;this.acmeParser.init(this);this.buildControls=new BuildControls;this.buildControls.init(this);this.buildControls.buildInterface(g);this.assemblerOutput=new AssemblerOutput;this.assemblerOutput.init(this);this.assemblerOutput.buildInterface(m)},showContent:function(e){UI("assemblerToolsPanel").showOnly("assembler"+e)},keyDown:function(e){if(this.debuggerCompact){this.debuggerCompact.keyDown(e)}},keyUp:function(e){if(this.debuggerCompact){this.debuggerCompact.keyUp(e)}},saveSettings:function(e){e[this.path]={editSession:this.codeEditor.getEditSession()}},breakpointSet:function(e){if(this.prefix=="c64debugger"){this.debuggerCompact=g_app.c64Debugger}e++;var t=this.path;var i="/asm/";t=t.substr(i.length);if(typeof this.assemblerReport!="undefined"&&typeof this.assemblerReport.lineMap[t]!="undefined"&&typeof this.assemblerReport.lineMap[t][e]!="undefined"){var r=this.assemblerReport.lineMap[t][e];if(this.debuggerCompact){this.debuggerCompact.addPCBreakpoint({address:r,file:t,lineNumber:e})}}this.debuggerCompact.breakpoints.drawBreakpoints()},breakpointCleared:function(e){if(this.prefix=="c64debugger"){this.debuggerCompact=g_app.c64Debugger}e++;var t=this.path;var i="/asm/";t=t.substr(i.length);if(typeof this.assemblerReport!="undefined"&&typeof this.assemblerReport.lineMap[t]!="undefined"&&typeof this.assemblerReport.lineMap[t][e]!="undefined"){var r=this.assemblerReport.lineMap[t][e];if(this.debuggerCompact){this.debuggerCompact.removePCBreakpoint({address:r,file:t,lineNumber:e})}}this.debuggerCompact.breakpoints.drawBreakpoints()},setFontSize:function(e){var t=e;if(typeof e=="undefined"){e=g_app.getFontSize()}this.codeEditor.setFontSize(e);if(this.debuggerCompact){this.debuggerCompact.setFontSize(e)}},toggleInvisibles:function(){this.codeEditor.toggleInvisibles()},toggleAutocomplete:function(){this.codeEditor.toggleAutocomplete()},toggleTabIndentation:function(){this.codeEditor.toggleTabIndentation()},setTheme:function(e){this.codeEditor.setTheme(e)},undo:function(){this.codeEditor.undo()},redo:function(){this.codeEditor.redo()},codeEditorPanelResize:function(){if(this.inResize){return}if(!g_app.isMobile()){return}var e=UI("codeEditorPanel").id;var t=UI.getScreenHeight();if(g_app.isMobile()&&t<500){this.inResize=true;UI("assemblerContent").resizeThePanel({panel:"south",size:50});this.saveHeight=170;this.inResize=false}else{this.inResize=true;this.saveHeight=170;UI("assemblerContent").resizeThePanel({panel:"south",size:this.saveHeight});this.inResize=false}},show:function(){this.setFontSize();if(this.debuggerCompact){this.debuggerCompact.show();this.debuggerCompact.resize()}},getCompletions:function(e,t){return this.acmeParser.getCompletions(e,t)},codeEditorChange:function(e){if(this.doc!=null){this.modified();this.doc.data=this.codeEditor.getValue();this.acmeParser.process(this.doc.id,this.doc.data)}},codeEditorChangeCursor:function(e){var t=e.row;if(t!=this.lastEditorLine){this.lastEditorLine=t}},updateBreakpoints:function(){var e=this.codeEditor.getEditSession();var t=e.getBreakpoints();var i=this.path;this.breakpoints[this.path]=[];for(key in t){this.breakpoints[this.path].push(parseInt(key,10)+1)}},setBreakpoints:function(e){if(this.prefix=="c64debugger"){this.debuggerCompact=g_app.c64Debugger}this.debuggerCompact.clearPCBreakpoints();for(var e in this.breakpoints){var t="/asm/";var i=this.breakpoints[e];e=e.substr(t.length);for(var r=0;r<i.length;r++){var a=i[r];if(typeof this.assemblerReport!="undefined"&&typeof this.assemblerReport.lineMap[e]!="undefined"&&typeof this.assemblerReport.lineMap[e][a]!="undefined"){var s=this.assemblerReport.lineMap[e][a];if(this.debuggerCompact){this.debuggerCompact.addPCBreakpoint({address:s,file:e,lineNumber:a})}}}}if(this.debuggerCompact.breakpoints){this.debuggerCompact.breakpoints.drawBreakpoints()}},showFile:function(e,t,i,r){var a=t;var s=false;if(typeof r!="undefined"){s=r}this.acmeParser.parseAllFiles();this.codeEditor.focus();if(e==this.path&&!s){if(typeof a!="undefined"&&a!==false){this.codeEditor.gotoLine(a)}return}this.doc=null;this.path=e;var o=g_app.doc.getDocRecord(e);if(o!=null){this.doc=o;var l=this;if(!s&&typeof i!="undefined"&&typeof i[e]!="undefined"&&typeof i[e].editSession!="undefined"){this.codeEditor.setEditSession(i[e].editSession)}else{var n=ace.createEditSession(o.data,"ace/mode/assembly_6502");n.on("changeBreakpoint",function(e){l.updateBreakpoints()});this.codeEditor.setEditSession(n)}this.codeEditor.clearAnnotations();this.assemblerOutput.addAnnotationsToEditor();this.codeEditor.setTabIndentation()}},readConfig:function(){var e={assembler:"acme",flags:"--format cbm --msvc -r report",files:"main.asm",output:"out.prg",target:"c64"};var t=null;var i=g_app.doc.getDocRecord("/config/assembler.json");if(i){try{if(isString(i.data)){t=$.parseJSON(i.data)}else{t=i.data}}catch(e){console.log(e.name);console.log(e.message);return{error:true,message:e.message}}return t}return e},setConfig:function(e){var t=g_app.doc.getDocRecord("/config/assembler.json");t.data=e},processAssemblerResponse:function(e,t){var r=this;var i=this.assemblerOutput;if(e.success){i.setReport(e.reportRaw);this.assemblerOutput.addOutputLine({text:"Done"});var a=e.prg.length;this.assemblerOutput.addOutputLine({text:"Size: "+a.toLocaleString()});this.assemblerMemoryMap=[];if(typeof e.report.memoryMap!=="undefined"){var s=e.report.memoryMap;for(var o=0;o<s.length;o++){var l="";l+=("0000"+s[o].address.toString(16)).substr(-4);l+=": "+s[o].label;this.assemblerMemoryMap.push(l)}}t(e);if(true){this.assemblerOutput.addOutputLine({text:"Running Exomizer..."});this.runExomizer(e.prg,function(e){var t=e.prg.length;console.log(e);r.assemblerOutput.addOutputLine({text:"Exomizer Size: "+t.toLocaleString()});for(var i=0;i<r.assemblerMemoryMap.length;i++){r.assemblerOutput.addOutputLine({text:r.assemblerMemoryMap[i]})}r.assemblerOutput.showOutput()})}}else{if(typeof e.errors!="undefined"){for(var o=0;o<e.errors.length;o++){i.addOutputLine(e.errors[o])}}i.showOutput();i.setReport("")}},runExomizer:function(e,t){if(this.exomizerWorker==null){var i=this;this.exomizerWorker=new Worker("lib/exomizer/exomizerWorker.js");this.exomizerWorker.onmessage=function(e){if(e.data.success){t(e.data)}}}this.exomizerWorker.postMessage({file:e,config:{}})},assemble:function(t,e){var i=this;this.assembleCallback=t;var r=this.readConfig();this.assemblerOutput.clear();if(typeof r.error!="undefined"&&r.error){this.assemblerOutput.addOutputLine({text:"Error in assembler config file"});if(typeof r.message!="undefined"){this.assemblerOutput.addOutputLine({text:r.message})}this.assemblerOutput.showOutput();return}var a=r.assembler;if(typeof a=="undefined"){this.assemblerOutput.addOutputLine({text:"Assembler not specified, using ACME"});a="acme"}a=a.toLowerCase();if(a!="acme"&&a!="ca65"){this.assemblerOutput.addOutputLine({text:"Unknown assembler '"+a+"' in config file"});this.assemblerOutput.showOutput();return}if(a=="ca65"){this.assemblerOutput.addOutputLine({text:"Building with CA65.."})}else{this.assemblerOutput.addOutputLine({text:"Building with ACME 0.97..."})}this.assemblerOutput.showOutput();var s=[];if(typeof e!="undefined"){s=e}else{i.collectSourceFiles("/asm",s,["asm","folder"]);var o=i.preprocessor.preprocessSourceFiles(s);if(o.success===false){this.processAssemblerResponse(o,t);return}i.collectSourceFiles("/asm",s,["bin"])}console.log("assemble files");console.log(s);if(a=="ca65"){if(i.ca65Assembler==null){i.ca65Assembler=new CA65Assembler;i.ca65Assembler.init(i)}i.ca65Assembler.assemble(s,r,function(e){i.assemblerOutput.addOutputLine({text:"Done"});i.assemblerOutput.showOutput();t(e)})}else{if(false&&this.acmeWorker){this.acmeWorker.terminate();this.acmeWorker=null}if(i.acmeWorker==null){console.log("create new acme worker");i.acmeWorker=new Worker("lib/acme097/acmeAssemblerWorker.js");i.acmeWorker.onmessage=function(e){console.log("assembler response:");console.log(e);i.processAssemblerResponse(e.data,i.assembleCallback)}}i.acmeWorker.postMessage({files:s,config:r})}},machinePlay:function(){if(this.prefix=="c64debugger"){this.debuggerCompact=g_app.c64Debugger}if(this.debuggerCompact){this.debuggerCompact.play()}},machineStep:function(){if(this.prefix=="c64debugger"){this.debuggerCompact=g_app.c64Debugger}if(this.debuggerCompact){this.debuggerCompact.step()}},machineStepOver:function(){if(this.prefix=="c64debugger"){this.debuggerCompact=g_app.c64Debugger}if(this.debuggerCompact){this.debuggerCompact.stepOver()}},machineStepInto:function(){if(this.prefix=="c64debugger"){this.debuggerCompact=g_app.c64Debugger}if(this.debuggerCompact){this.debuggerCompact.stepInto()}},run:function(){var i=this;var e=this.readConfig();if(typeof e.error!="undefined"&&e.error){this.assemblerOutput.clear();this.assemblerOutput.addOutputLine({text:"Error in assembler config file"});if(typeof e.message!="undefined"){this.assemblerOutput.addOutputLine({text:e.message})}this.assemblerOutput.showOutput();return}var r=e.target;if(typeof r=="undefined"){r="c64"}if(r!="c64"&&r!="x16"&&r!="nes"){this.assemblerOutput.clear();this.assemblerOutput.addOutputLine({text:"Unknown target: '"+r+"'"});this.assemblerOutput.showOutput();return}this.build(function(e,t){if(i.prefix=="c64debugger"){e.startC64=true;i.assemblerReport=e.report;i.codeEditor.blur();i.setBreakpoints();g_app.c64Debugger.setPRG(e);g_app.c64Debugger.focusMachine()}else if(r=="c64"&&i.debuggerCompact&&!g_app.isMobile()){e.startC64=true;i.assemblerReport=e.report;i.codeEditor.blur();i.setBreakpoints();i.debuggerCompact.setPRG(e);i.debuggerCompact.focusMachine()}else{if(g_app.isMobile()){if(r=="x16"){g_app.setMode("x16");g_app.x16Debugger.setPRG(e.prg)}else{g_app.setMode("c64");g_app.c64Debugger.setPRG({prg:e.prg,backLink:i.path})}}else{g_app.projectNavigator.setPrgHandler(r);g_app.projectNavigator.selectDocRecord(t)}}})},collectSourceFiles:function(e,t,i){var r=g_app.doc;var a=r.dir(e);for(var s=0;s<a.length;s++){var o=a[s];if(i.indexOf(o.type)!=-1){t.push({id:o.id,name:o.name,content:o.data,filePath:o.name,type:o.type})}if(o.type=="folder"){var l=o.name;var n=r.dir(e+"/"+l);for(var h=0;h<n.length;h++){var d=n[h].name;var c=n[h].data;var f=l+"/"+d;var u=n[h].type;if(i.indexOf(u)!=-1){t.push({id:n[h].id,name:n[h].name,content:n[h].data,filePath:l+"/"+n[h].name,type:n[h].type})}}console.log("SOURCE FILES = ");console.log(t)}}return t},build:function(n){var h=this;this.assemble(function(e){var t=h.readConfig();var i=bufferToBase64(e.prg);var r="build.prg";if(t.target=="nes"){r="build.nes"}var a="/build/"+r;var s=g_app.doc;var o=s.getDocRecord(a);if(o){o.data=i}else{var l=s.createDocRecord("/build",r,"prg",i)}g_app.projectNavigator.reloadTreeBranch("/build");g_app.projectNavigator.treeRoot.refreshChildren();if(typeof n!="undefined"){n(e,a)}})},buildAndDownload:function(){var i=this;this.assemble(function(e){console.log("build and download result");console.log(e);var t=i.readConfig();if(t.target=="nes"){download(e.prg,"build.nes","application/prg")}else{download(e.prg,"build.prg","application/prg")}})},update:function(){if(this.debuggerCompact){this.debuggerCompact.update()}}};var BuildControls=function(){this.settingsDialog=null;this.c64Cfg="";this.c64Cfg+="FEATURES {\n";this.c64Cfg+="STARTADDRESS: default = $0801;\n";this.c64Cfg+="}\n";this.c64Cfg+="SYMBOLS {\n";this.c64Cfg+="__LOADADDR__: type = import;\n";this.c64Cfg+="}\n";this.c64Cfg+="MEMORY {\n";this.c64Cfg+='ZP:       file = "", start = $0002,  size = $00FE,      define = yes;\n';this.c64Cfg+="  LOADADDR: file = %O, start = %S - 2, size = $0002;\n";this.c64Cfg+="  MAIN:     file = %O, start = %S,     size = $D000 - %S;\n";this.c64Cfg+="}\n";this.c64Cfg+="SEGMENTS {\n";this.c64Cfg+="  ZEROPAGE: load = ZP,       type = zp,  optional = yes;\n";this.c64Cfg+="  LOADADDR: load = LOADADDR, type = ro;\n";this.c64Cfg+="  EXEHDR:   load = MAIN,     type = ro,  optional = yes;\n";this.c64Cfg+="  CODE:     load = MAIN,     type = rw;\n";this.c64Cfg+="  RODATA:   load = MAIN,     type = ro,  optional = yes;\n";this.c64Cfg+="  DATA:     load = MAIN,     type = rw,  optional = yes;\n";this.c64Cfg+="  BSS:      load = MAIN,     type = bss, optional = yes, define = yes;\n";this.c64Cfg+="}";this.nesCfg="";this.nesCfg+="MEMORY { \n";this.nesCfg+='  ZP:     start = $00,    size = $0100, type = rw, file = "";\n';this.nesCfg+='  OAM:    start = $0200,  size = $0100, type = rw, file = "";\n';this.nesCfg+='  RAM:    start = $0300,  size = $0500, type = rw, file = "";\n';this.nesCfg+="  HDR:    start = $0000,  size = $0010, type = ro, file = %O, fill = yes, fillval = $00;\n";this.nesCfg+="  PRG:    start = $8000,  size = $8000, type = ro, file = %O, fill = yes, fillval = $00;\n";this.nesCfg+="  CHR:    start = $0000,  size = $2000, type = ro, file = %O, fill = yes, fillval = $00;\n";this.nesCfg+="}\n";this.nesCfg+="SEGMENTS {\n";this.nesCfg+="  ZEROPAGE: load = ZP,  type = zp;\n";this.nesCfg+="  OAM:      load = OAM, type = bss, align = $100;\n";this.nesCfg+="  BSS:      load = RAM, type = bss;\n";this.nesCfg+="  HEADER:   load = HDR, type = ro;\n";this.nesCfg+="  CODE:     load = PRG, type = ro,  start = $8000;\n";this.nesCfg+="  RODATA:   load = PRG, type = ro;\n";this.nesCfg+="  VECTORS:  load = PRG, type = ro,  start = $FFFA;\n";this.nesCfg+="  TILES:    load = CHR, type = ro;\n";this.nesCfg+="}\n";this.prefix=""};BuildControls.prototype={init:function(e,t){this.editor=e;if(typeof t!="undefined"){this.prefix=t}},buildInterface:function(e){var t='<div class="panelFill" style="background-color:#333333;">';t+='<div class="ui-button ui-button-primary" style="margin: 0px 5px" id="'+this.prefix+'assemblerRun" ><div class="rippleJS"></div>';t+='<i class="halflings halflings-play"></i>&nbsp;';t+="Build and Run";if(!g_app.isMobile()){t+=" (F5)"}t+="</div>";t+='<div class="ui-button ui-button-secondary" style="margin: 0px 5px"  id="'+this.prefix+'assemblerBuild"><div class="rippleJS"></div>Build';if(!g_app.isMobile()){t+=" (F6)"}t+="</div>";t+='<span>Assembler <a href="https://sourceforge.net/projects/acme-crossass/" target="_blank">ACME 0.97</a></span>';t+='<div class="ui-button ui-button-secondary" style="margin: 0px 5px"  id="'+this.prefix+'assemblerBuildAndDownload"><div class="rippleJS"></div>';t+='<img src="icons/svg/glyphicons-basic-199-save.svg">&nbsp;';t+="Build and Download</div>";if(this.prefix=="c64debugger"){t+='<div style="margin-right: 6px" class="ui-button ui-button-secondary" id="'+this.prefix+'assemblerShare"><img src="icons/material/share-24px.svg">&nbsp;Share</div>'}t+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{html:t});e.add(this.uiComponent);var i=this;UI.on("ready",function(){i.initEvents()})},initContent:function(){},build:function(){this.editor.build()},run:function(){this.editor.run()},runBuildAndDownload:function(){this.editor.buildAndDownload()},showShare:function(){var e=[];this.editor.collectSourceFiles("/asm",e,["asm","folder"]);this.editor.collectSourceFiles("/asm",e,["bin"]);for(var t=0;t<e.length;t++){e[t].filePath="asm/"+e[t].filePath}var i=g_app.doc.getDocRecord("/config/assembler.json");if(i){var r=i.data;if(!isString(r)){r=JSON.stringify(r,null,2)}e.push({name:"assembler.json",filePath:"config/assembler.json",content:r})}else{console.log("no config!!")}var a={};for(var t=0;t<e.length;t++){if(e[t].type!="folder"){var s=e[t].filePath;s=s.replace(/\//g,g_gistPathSeparator);a[s]={content:e[t].content}}}g_app.gist.share({files:a})},assemblerSettings:function(){var t=this;if(this.settingsDialog==null){var e="";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="assemblerTarget">Target:</label>';e+='  <select name="assemblerTarget" id="assemblerTarget">';e+='    <option value="c64" selected="selected">C64</option>';e+='    <option value="nes">NES</option>';e+='    <option value="x16">X16</option>';e+="  </select>";e+="</div>";e+='<div class="formGroup">';e+='  <label class="controlLabel" for="useAssembler">Assembler:</label>';e+='  <select name="useAssembler" id="useAssembler">';e+='    <option value="acme" selected="selected">ACME</option>';e+='    <option value="ca65">CA65</option>';e+="  </select>";e+="</div>";e+='<div class="formGroup" id="cc65configfilegroup">';e+='  <label class="controlLabel" for="assemblerConfigFilePath">Config File:</label>';e+='  <input id="assemblerConfigFilePath" type="text" value="">';e+="</div>";var i=300;var r=200;this.settingsDialog=UI.create("UI.Dialog",{id:"assemblerSettingsDialog",title:"Assembler Settings",width:i,height:r});this.settingsHTML=UI.create("UI.HTMLPanel",{html:e});this.settingsDialog.add(this.settingsHTML);var a=UI.create("UI.Button",{text:"OK",color:"primary"});a.on("click",function(e){t.setSettings();UI.closeDialog()});var s=UI.create("UI.Button",{text:"Cancel",color:"secondary"});s.on("click",function(e){UI.closeDialog()});this.settingsDialog.addButton(a);this.settingsDialog.addButton(s)}UI.showDialog("assemblerSettingsDialog");this.initSettingsContent()},initSettingsContent:function(){console.log("init settings");var e=this.editor.readConfig();var t="c64";var i="acme";var r="cfg/nes-asm.cfg";if(e!=null&&typeof e.error=="undefined"){if(typeof e.target!="undefined"){t=e.target}if(typeof e.assembler!="undefined"){i=e.assembler}if(typeof e.cc65ConfigFile!="undefined"){r=e.cc65ConfigFile}}$("#assemblerTarget").val(t);$("#useAssembler").val(i);$("#assemblerConfigFilePath").val(r)},setSettings:function(){var e=this.editor.readConfig();if(e==null||typeof e.error!="undefined"){e={}}var t=$("#assemblerTarget").val();var i=$("#useAssembler").val();var r=$("#assemblerConfigFilePath").val();e.target=t;e.assembler=i;if(i=="ca65"){e.cc65ConfigFile=r}else{delete e.cc65ConfigFile}console.log("SET SETTINGS");console.log(e);this.editor.setConfig(e);if(i=="ca65"){this.createCfg(e.cc65ConfigFile,t)}},createCfg:function(e,t){console.log("create config for "+t);var i="/asm";var r=g_app.doc;var a=g_app.doc.getDocRecord(i+"/cfg");if(!a){g_app.doc.createDocRecord(i,"cfg","folder",{});g_app.projectNavigator.refreshTreeNodeFromPath(i)}if(t=="c64"){g_app.doc.createDocRecord(i+"/cfg","c64-asm.cfg","cfg",this.c64Cfg)}if(t=="nes"){g_app.doc.createDocRecord(i+"/cfg","nes-asm.cfg","cfg",this.nesCfg)}g_app.projectNavigator.refreshTreeNodeFromPath(i+"/cfg");g_app.projectNavigator.treeRoot.refreshChildren();console.log(g_app.doc)},initEvents:function(){var e=this;$("#"+this.prefix+"assemblerBuild").on("click",function(){e.build()});$("#"+this.prefix+"assemblerRun").on("click",function(){e.run()});$("#"+this.prefix+"assemblerBuildAndDownload").on("click",function(){e.runBuildAndDownload()});$("#"+this.prefix+"assemblerShare").on("click",function(){if(g_app.c64Debugger){g_app.c64Debugger.share({type:"assembly"})}})},start:function(){}};function htmlEntities(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}var AssemblerOutput=function(){this.lines=[];this.prefix=""};AssemblerOutput.prototype={init:function(e,t){this.editor=e;if(typeof t!="undefined"){this.prefix=t}},buildInterface:function(e){var r=this;this.uiComponent=UI.create("UI.SplitPanel",{id:this.prefix+"assemblerOutputSplitPanel"});e.add(this.uiComponent);this.tabPanel=UI.create("UI.TabPanel",{canCloseTabs:false});this.tabPanel.addTab({key:"result",title:"Result",isTemp:false},true);this.tabPanel.addTab({key:"output",title:"Output",isTemp:false},false);this.tabPanel.on("tabfocus",function(e,t){var i=r.tabPanel.getTabIndex(e);if(i>=0){r.showOutputContent(e)}});this.uiComponent.addNorth(this.tabPanel,30,false);this.contentPanel=UI.create("UI.Panel",{id:this.prefix+"assemblerOutputContent"});this.uiComponent.add(this.contentPanel);var t="";t+='<div class="panelFill" id="'+this.prefix+'buildOutputPanel" style="background-color: #111111; color: #cccccc; overflow: auto"></div>';this.resultPanel=UI.create("UI.HTMLPanel",{html:t,id:this.prefix+"assemblerResultPanel"});this.contentPanel.add(this.resultPanel);t="";t+='<div class="panelFill" id="'+this.prefix+'assemblerOutputPanel" style="background-color: #111111; color: #cccccc; overflow: auto"></div>';this.outputPanel=UI.create("UI.HTMLPanel",{html:t,id:this.prefix+"assemblerOutputPanel"});this.contentPanel.add(this.outputPanel);var r=this;UI.on("ready",function(){r.initEvents();r.showOutputContent("result")})},showOutputContent:function(e){switch(e){case"result":this.contentPanel.showOnly(this.prefix+"assemblerResultPanel");break;case"output":this.contentPanel.showOnly(this.prefix+"assemblerOutputPanel");break}},initEvents:function(){var t=this;$("#"+this.prefix+"buildOutputPanel").on("click",".assemblerOutputLine",function(){var e=$(this).attr("data-line-id");t.selectLine(e)})},clear:function(){this.lines=[];$("#"+this.prefix+"buildOutputPanel").html("");this.editor.codeEditor.clearAnnotations()},addOutputLine:function(e){var t={};t.text=e.text;t.file="";if(typeof e.file!="undefined"){t.file=e.file}t.lineNumber=false;if(typeof e.lineNumber!="undefined"){t.lineNumber=e.lineNumber}var i=this.lines.length;this.lines.push(t);if(t.text.indexOf(": Error")!==-1){if("/asm/"+t.file==this.editor.path){this.editor.codeEditor.addAnnotation({row:t.lineNumber-1,column:0,text:t.text,type:"error"})}}},showOutput:function(){var e="";for(var t=0;t<this.lines.length;t++){var i=this.lines[t].text;var r=i.indexOf("Error")!==-1&&this.lines[t].lineNumber!==false;e+='<div class="assemblerOutputLine';if(r){e+=" error "}e+='" id="assemblerOutputLine'+t+'" data-line-id="'+t+'">';if(r){e+='<div class="assemblerOutputErrorIcon" ><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>'}e+=this.lines[t].text;e+="</div>"}var a=this;$("#"+this.prefix+"buildOutputPanel").html(e)},addAnnotationsToEditor:function(){for(var e=0;e<this.lines.length;e++){var t=this.lines[e];if(t.file!=""&&t.lineNumber!==false){var i="/asm/"+t.file;if(i==this.editor.path){this.editor.codeEditor.addAnnotation({row:t.lineNumber-1,column:0,text:t.text,type:"error"})}}}},setReport:function(e){$("#"+this.prefix+"assemblerOutputPanel").html("<pre>"+htmlEntities(e)+"</pre>")},selectLine:function(e){if(e>=this.lines.length){return}$(".assemblerOutputLine").removeClass("selected");$("#assemblerOutputLine"+e).addClass("selected");var t=this.lines[e];if(t.file!=""&&t.lineNumber!==false){var i="/asm/"+t.file;if(this.prefix!="c64debugger"){g_app.projectNavigator.showDocRecord(i)}this.editor.showFile(i,t.lineNumber);this.editor.codeEditor.addAnnotation({row:t.lineNumber-1,column:0,text:t.text,type:"error"})}}};var AcmeParser=function(){this.labels=[];this.macros=[];this.fileLabels={};this.fileMacros={}};AcmeParser.prototype={init:function(e){this.editor=e},parseAllFiles:function(){this.labels=[];this.macros=[];this.fileLabels={};this.fileMacros={};var e=[];this.editor.collectSourceFiles("/asm",e,["asm","folder"]);for(var t=0;t<e.length;t++){if(e[t].type=="asm"){this.process(e[t].id,e[t].content)}}},getCompletions:function(e,t){var i=[];var r=false;var a=false;var s=false;var o=/^[0-9a-zA-Z]+$/;var l=/^[0-9]+$/;var n=false;var h=false;var d=t.column;var c=e.length;var f=false;while(d>=0&&e[d]!=" "&&e[d]!="\t"){n=e[d];if(d+1<c){h=e[d+1]}else{h=false}if(d+1<c&&(e[d]=="$"||e[d]=="#")){var u=e[d+1];if(u>="0"&&u<="9"){console.log("typing number");f=true}}if(e[d]>="0"&&e[d]<="9"){f=true}d--}d=t.column;while(d>=0){if(e[d]==";"){return i}d--}var p=false;for(var v=0;v<t.column;v++){var g=e[v];if(g!=" "&&g!="\t"&&r===false){r=v}if((g==" "||g=="\t")&&a===false){a=v}if((g==" "||g=="\t")&&r!==false&&s===false){s=v}if(g==","){p=true}}if(a===false){if(n!="+"){var m="!";if(n=="!"){m=""}for(var v=0;v<AcmePseudoOpcodes.length;v++){i.push({value:m+AcmePseudoOpcodes[v].cmd,meta:AcmePseudoOpcodes[v].desc})}}if(n!="!"){var m="+";if(n=="+"){m=""}for(var v=0;v<this.macros.length;v++){i.push({value:m+this.macros[v].value,meta:"macro"})}}}else if(a!==false&&s===false){if(n!="+"){for(var v=0;v<MOS6510OpcodeCmds.length;v++){i.push({value:MOS6510OpcodeCmds[v].cmd.toLowerCase(),meta:MOS6510OpcodeCmds[v].name})}var m="!";if(n=="!"){m=""}for(var v=0;v<AcmePseudoOpcodes.length;v++){i.push({value:m+AcmePseudoOpcodes[v].cmd,meta:AcmePseudoOpcodes[v].desc})}}if(n!="!"){for(var v=0;v<this.macros.length;v++){var m="+";if(n=="+"){m=""}i.push({value:this.macros[v].value,meta:"macro"})}}}else{if(!p){if(!f){for(var v=0;v<this.labels.length;v++){i.push({value:this.labels[v].value,meta:this.labels[v].meta})}}if(n=="$"){if(h=="d"||h=="f"){for(var v=0;v<C64IORegisters.length;v++){var y=C64IORegisters[v].label;if(typeof C64IORegisters[v].chip!="undefined"){y=C64IORegisters[v].chip+": "+y}i.push({value:"$"+C64IORegisters[v].address,meta:y})}}}}}return i},process:function(e,t){var i=[];var r=[];var a=t.split("\n");for(var s=0;s<a.length;s++){var o=a[s];var l=o.indexOf(";");if(l!=-1){o=o.substring(0,l)}o=o.trim();if(o!=""){if(o.length>1&&o[0]=="*"&&o[1]=="="){}else if(o.indexOf("=")!==-1){var n=o.split("=");if(n.length>1){var h=n[0].trim();var d=n[1].trim();if(d=="*"){i.push({value:h,meta:""})}else{var c=false;if(d.match(/^\$[0-9a-f]{1,2}$/i)){c=d;i.push({value:h,meta:c})}else if(d.match(/^\$[0-9a-f]{3,4}$/i)){c=d;i.push({value:h,meta:c})}else if(!isNaN(parseInt(d))){c=d;i.push({value:h,meta:c})}else{c=d;i.push({value:h,meta:c})}}}}else{o=o.replace(/\t/g," ");var n=o.split(/\ +/);if(n.length>0){var f=n[0].toLowerCase();if(f=="macro"||f=="!macro"){r.push({value:n[1],meta:""})}else if(f=="byte"||f=="!byte"){}else{var h=n[0];if(h.length>0&&h[0]!="!"&&h[0]!="+"&&h[0]!="}"){if(h[h.length-1]==":"){h=h.substring(0,h.length-1)}i.push({value:h,meta:""})}}}this.fileLabels[e]=i;this.fileMacros[e]=r}}}this.combine()},combine:function(){this.labels=[];for(var e in this.fileLabels){for(var t=0;t<this.fileLabels[e].length;t++){this.labels.push({value:this.fileLabels[e][t].value,meta:this.fileLabels[e][t].meta})}}this.macros=[];for(var e in this.fileMacros){for(var t=0;t<this.fileMacros[e].length;t++){this.macros.push({value:this.fileMacros[e][t].value,meta:this.fileMacros[e][t].meta})}}}};var AssemblerFileRecord=function(e,t){this.filename=e;this.type=t;this.children=[];this.content=""};AssemblerFileRecord.prototype={createChild:function(e,t){var i=new AssemblerFileRecord(e,t);this.children.push(i);return i},createFile:function(e){return this.createChild(e,"file")},createFolder:function(e){return this.createChild(e,"folder")},getChild:function(e){for(var t=0;t<this.children.length;t++){if(this.children[t].filename==e){return this.children[t]}}return null},setContent:function(e){this.content=e},getContent:function(){return this.content}};var AssemblerFiles=function(){this.editor=null;this.currentDirectory="/";this.root=new AssemblerFileRecord("/","dir")};AssemblerFiles.prototype={init:function(e){this.editor=e},getParentPath:function(e){var t=e.lastIndexOf("/");if(t==-1){return""}return e.substring(0,t+1)},getFilename:function(e){var t=e.lastIndexOf("/");if(t==-1){return e}return e.substring(t+1)},getFileRecord:function(e){if(e=="/"){return this.root}e=e.trim();if(e.length==0||e[0]!="/"){e=this.currentDirectory+e}var t=e.split("/");var i=this.root;for(var r=1;r<t.length;r++){var a=t[r];i=i.getChild(a);if(i==null){return null}}return i},dir:function(e){var t=this.getFileRecord(e);if(t==null){return null}return t.children},createFile:function(e,t){if(typeof t=="undefined"){t="file"}var i=this.getParentPath(e);var r=this.getFilename(e);var a=this.getFileRecord(i);if(!a){return null}return a.createChild(r,t)},createFolder:function(e){return this.createFile(e,"folder")},deleteFile:function(e){var t=this.getParentPath(e);var i=this.getFilename(e);var r=this.getFileRecord(t);if(!r){return false}return r.deleteChild(i)},load:function(e){var t=this.getFileRecord(e);if(t==null){return"<no file>"}return t.getContent()},save:function(e,t){var i=this.getFileRecord(e);if(i==null){return false}return i.setContent(t)}};var c64Asm_macro="";c64Asm_macro+=";; Start of BASIC program\n";c64Asm_macro+="basic = $0801\n";c64Asm_macro+="!macro start_at .address {\n";c64Asm_macro+="  * = basic\n";c64Asm_macro+="  !byte $0c,$08,$00,$00,$9e\n";c64Asm_macro+="  !if .address >= 10000 { !byte 48 + ((.address / 10000) % 10) }\n";c64Asm_macro+="  !if .address >=  1000 { !byte 48 + ((.address /  1000) % 10) }\n";c64Asm_macro+="  !if .address >=   100 { !byte 48 + ((.address /   100) % 10) }\n";c64Asm_macro+="  !if .address >=    10 { !byte 48 + ((.address /    10) % 10) }\n";c64Asm_macro+="  !byte $30 + (.address % 10), $00, $00, $00\n";c64Asm_macro+="  * = .address\n";c64Asm_macro+="}\n";var c64Asm_example="";c64Asm_example+='!source "inc/macros.asm"\n\n';c64Asm_example+="; macro to create the basic program to start code\n";c64Asm_example+="+start_at $0900\n\n";c64Asm_example+="  lda #00   \n";c64Asm_example+="  sta $d020  ; border colour\n";c64Asm_example+="  sta $d021  ; background colour\n";c64Asm_example+="loop\n";c64Asm_example+="  inc $d021    ; increase background colour\n";c64Asm_example+="  jmp loop     ; loop forever\n";var AssemblerPreprocessor=function(){this.editor=null;this.scriptProcessor=null;this.output="";this.lineMap=[]};AssemblerPreprocessor.prototype={init:function(e){this.editor=e;var i=this;this.scriptProcessor=new Scripting;this.scriptProcessor.init();this.scriptProcessor.registerAPI(function(e,t){i.initAPI(e,t)})},initAPI:function(i,e){var r=this;var t=function(e,t){r.output+=e+"\n";if(typeof t!="undefined"){r.lineMap[r.currentLine]=t}else{r.lineMap[r.currentLine]=r.lineMap[r.currentLine-1]}r.currentLine++};var a=function(e,t){r.output+=e};i.setProperty(e,"writeLn",i.createNativeFunction(t,false),Interpreter.NONENUMERABLE_DESCRIPTOR);i.setProperty(e,"write",i.createNativeFunction(a,false),Interpreter.NONENUMERABLE_DESCRIPTOR);var s=function(e){console.log("CREATE BIN!!!!")};var o=function(e){var t=g_app.textModeEditor.createBin(i.pseudoToNative(e));if(t.success){return'"'+t.path+'"'}else{return"error!!!"}};i.setProperty(e,"createBin",i.createNativeFunction(o,false),Interpreter.NONENUMERABLE_DESCRIPTOR)},preprocess:function(e){var t="";var i="";var r=false;var a="normal";var s=false;var o=0;if(e[e.length-1]!="\n"){e+="\n"}var l=e.length;for(var n=0;n<l;n++){var h=e[n];var d="";if(n<l+1){d=e[n+1]}if(h=="\r"){}else if(h=="\n"){if(r){switch(a){case"normal":t+=i+"\n";break}}else{t+="writeLn("+JSON.stringify(i)+", "+o+");"+"\n"}o++;i=""}else if(h=="<"&&d=="%"){r=true;s=true;if(i!=""){t+="write("+JSON.stringify(i)+", "+o+");"+"\n";i=""}n++;a="normal";if(n<l+1){d=e[n+1]}if(d=="="){a="output";n++}}else if(h=="%"&&d==">"){r=false;n++;if(i.trim()!=""){switch(a){case"normal":t+=i;break;case"output":t+="write("+i+", "+o+");";break}}i=""}else{i+=h}}this.lineMap=[];if(s){this.output="";this.lineMap=[];this.currentLine=0;var c=[];this.scriptProcessor.runScripts([{content:t,filePath:"asmcode"}],{errorHandler:function(e){c.push(e)}});if(c.length>0){return{success:false,errors:c}}else{return{success:true,content:this.output,lineMap:this.lineMap}}}else{return{success:true,content:e,lineMap:this.lineMap}}},preprocessSourceFiles:function(e){var t=g_app.doc;var i=t.dir("/asm");var r=[];for(var a=0;a<e.length;a++){var s=e[a];if(s.type==="asm"){var o=s.content;var l=this.preprocess(o);if(l.success){s.content=l.content;s.lineMap=l.lineMap}else{for(var n=0;n<l.errors.length;n++){r.push({filePath:s.filePath,file:s.filePath,lineNumber:l.errors[n].lineNumber,message:l.errors[n].message,text:l.errors[n].message})}}}}if(r.length===0){return{success:true}}else{return{success:false,errors:r}}}};var ASMParser=function(){};ASMParser.prototype={init:function(e){},process:function(e){}};var formatNumber=function(e,t,i){var r="";var a=e.length;for(var s=0;s<a;s++){var o=e[a-1-s];if(s%t==0&&s!=0){r=i+r}r=o+r}return r};var Calculator=function(){this.operators=[{id:"or",numOperands:2,symbol:" or ",calc:function(e,t){return e|t}},{id:"and",numOperands:2,symbol:" and ",calc:function(e,t){return e&t}},{id:"xor",numOperands:2,symbol:" xor ",calc:function(e,t){return e^t}},{id:"negate",numOperands:1,symbol:" -",calc:function(e){return-e}},{id:"multiply",numOperands:2,symbol:" x ",calc:function(e,t){return e*t}},{id:"divide",numOperands:2,symbol:"  ",calc:function(e,t){return e/t}},{id:"plus",numOperands:2,symbol:" + ",calc:function(e,t){return e+t}},{id:"subtract",numOperands:2,symbol:" - ",calc:function(e,t){return e-t}}];this.roundPlaces=15;this.numberSize="ubyte";this.tokenList=[];this.mode="dec";this.prefix="dev"};Calculator.prototype={init:function(e,t){this.editor=e;if(typeof t!="undefined"){this.prefix=t}},buildInterface:function(e){var t=this;UI.on("ready",function(){this.uiComponent=UI.create("UI.HTMLPanel",{id:t.prefix+"calculatorPanel"});e.add(this.uiComponent);this.uiComponent.load("html/assemblerUtils/calculator.html",function(){t.initEvents()})})},initEvents:function(){var i=this;$(".calculator-button").click(function(e){$(e.target).blur();i.processButton(e.target)});$(".calculator-mode").on("click",function(e){var t=$(this).attr("data-mode");i.setMode(t)});$("input[name=calculator-size]").on("click",function(){var e=$("input[name=calculator-size]:checked").val();$(".calculator").focus();i.setNumberSize(e)});$(".calculator").on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});$(".calculator").on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});$(".calculator").on("keydown",function(e){i.keyDown(e)});$(".calculator").on("keyup",function(e){i.keyUp(e)});this.setMode("dec")},keyDown:function(e){if(typeof e.key!="undefined"){switch(e.key.toLowerCase()){case"(":this.addToken("bracket-left");break;case")":this.addToken("bracket-right");break;case"0":this.addToken("0");break;case"1":this.addToken("1");break;case"2":this.addToken("2");break;case"3":this.addToken("3");break;case"4":this.addToken("4");break;case"5":this.addToken("5");break;case"6":this.addToken("6");break;case"7":this.addToken("7");break;case"8":this.addToken("8");break;case"9":this.addToken("9");break;case"*":this.addToken("multiply");break;case"enter":case"=":this.calculate();break;case"backspace":case"delete":this.deleteLast();break;case"+":this.addToken("plus");break;case"-":this.addToken("subtract");break}if(this.mode=="hex"){switch(e.key.toLowerCase()){case"a":this.addToken("A");break;case"b":this.addToken("B");break;case"c":this.addToken("C");break;case"d":this.addToken("D");break;case"e":this.addToken("E");break;case"f":this.addToken("F");break}}}},keyUp:function(e){},setNumberSize:function(e){this.numberSize=e;if(this.tokenList.length>0){var t=this.tokenList[this.tokenList.length-1];var i=this.getTokenValue(t);i=this.limitToNumberSize(i);var r=this.getTokenFromValue(i);this.tokenList[this.tokenList.length-1]=r;this.output(i);this.displayEquation()}},setMode:function(e){for(var t=0;t<this.tokenList.length;t++){if(this.isANumber(this.tokenList[t])){var i=this.tokenList[t];switch(this.mode){case"hex":i=parseInt(i,16);break;case"dec":i=parseInt(i,10);break;case"bin":i=parseInt(i,2);break}switch(e){case"hex":if(this.numberSize=="byte"){if(i>127){i-=256}}i=i.toString(16);break;case"dec":if(this.numberSize=="byte"){if(i>127){i-=256}}i=i.toString(10);break;case"bin":if(i<0){if(this.numberSize=="byte"){i+=256}}i=i.toString(2);break}this.tokenList[t]=i.toUpperCase()}}this.mode=e;this.displayEquation();$(".calculator-mode").removeClass("calculator-mode-selected");$(".calculator-mode-"+e).addClass("calculator-mode-selected");$(".calculator-buttons .num").addClass("disabled");$(".calculator-buttons ."+e).removeClass("disabled")},getOperator:function(e){for(var t=0;t<this.operators.length;t++){if(this.operators[t].id===e){return this.operators[t]}}return undefined},getOpPrecedence:function(e){for(var t=0;t<this.operators.length;t++){if(this.operators[t].id===e){return t}}return 1e3},hasPrecedence:function(e,t){if(typeof this.getOperator(e)!="undefined"){return this.getOpPrecedence(e)<=this.getOpPrecedence(t)}},toDegrees:function(e){return e*(180/Math.PI)},toRadians:function(e){return e*(Math.PI/180)},calculate:function(){var e=0;for(var t=0;t<this.tokenList.length;t++){if(this.tokenList[t]==="bracket-left"){e++}else if(this.tokenList[t]==="bracket-right"){e--}}if(e!=0){this.output("Error: unbalanced brackets");return}var i=[];var r=[];for(var t=0;t<this.tokenList.length;t++){if(this.isANumber(this.tokenList[t])){var a=this.tokenList[t];switch(this.mode){case"dec":a=parseInt(a,10);break;case"hex":a=parseInt(a,16);break;case"bin":a=parseInt(a,2);break}i.push(a)}else if(this.tokenList[t]==="num-pi"){i.push(Math.PI)}else if(this.tokenList[t]==="bracket-left"){r.push(this.tokenList[t])}else if(this.tokenList[t]==="bracket-right"){while(r[r.length-1]!=="bracket-left"){var s=this.getOperator(r.pop());if(s.numOperands===1)i.push(this.applyOperator(s,[i.pop()]));else i.push(this.applyOperator(s,[i.pop(),i.pop()]))}r.pop()}else{while(r.length>0&&this.hasPrecedence(r[r.length-1],this.tokenList[t])){var s=this.getOperator(r.pop());if(s.numOperands===1)i.push(this.applyOperator(s,[i.pop()]));else i.push(this.applyOperator(s,[i.pop(),i.pop()]))}r.push(this.tokenList[t])}}while(r.length>0){var s=this.getOperator(r.pop());if(s.numOperands===1)i.push(this.applyOperator(s,[i.pop()]));else i.push(this.applyOperator(s,[i.pop(),i.pop()]))}var a=Math.floor(i[0]);a=this.limitToNumberSize(a);this.tokenList=[];var o=a;switch(this.mode){case"dec":o=a.toString(10);break;case"hex":o=a.toString(16).toUpperCase();break;case"bin":o=a.toString(2);break}this.tokenList.push(o);this.output(a);this.displayEquation()},applyOperator:function(e,t){var i=t[0];var r;if(t.length===1){r=e.calc(parseFloat(i))}else{var a=t[1];r=e.calc(parseFloat(a),parseFloat(i))}return r},output:function(e){e=+e.toFixed(this.roundPlaces);switch(this.numberSize){case"byte":e=e&255;if(e>127){e=e-256}break;case"ubyte":e=e&255;break;case"word":e=e&65535;break;case"dword":e=e&4294967295;break}var t=e;switch(this.mode){case"dec":t=e.toString(10);break;case"hex":t=e.toString(16);break;case"bin":t=e.toString(2);break}this.showOutputValue(t.toUpperCase());this.updateModeValues(e)},showOutputValue:function(e){switch(this.mode){case"dec":if(typeof e!="string"){e=e.toString(10)}e=formatNumber(e,3,",");break;case"hex":if(typeof e!="string"){e=e.toString(16)}e=formatNumber(e,4," ").toUpperCase();break;case"bin":if(typeof e!="string"){e=e.toString(2)}e=formatNumber(e,4," ");break}$(".calculator-value").html(e)},isANumber:function(e){if(e===false){return false}var t=["rol","ror","or","xor","not","and","lsh","rsh"];if(e=="and"){return false}if(!isNaN(e)){return true}if(this.mode=="hex"){e=parseInt(e,16);return!isNaN(e)}return false},limitToNumberSize:function(e){switch(this.numberSize){case"byte":e=e&255;if(e&128){e=-128+(e&127)}else{e=e}break;case"ubyte":e=e&255;break;case"word":e=e&65535;break;case"dword":e=e&4294967295;break}return e},getTokenFromValue:function(e){var t=e;switch(this.mode){case"dec":t=e.toString(10);break;case"hex":t=e.toString(16);break;case"bin":if(e<0){if(this.numberSize=="byte"){e+=256}}t=e.toString(2);break}return t},getTokenValue:function(e){var t=e;switch(this.mode){case"dec":t=parseInt(t,10);break;case"hex":t=parseInt(t,16);break;case"bin":t=parseInt(t,2);break}return t},addToken:function(e){var t=false;if(this.tokenList.length>0){t=this.tokenList[this.tokenList.length-1]}if(!this.isANumber(e)){if(!this.isANumber(t)&&t!=="bracket-right"&&e!=="bracket-left"){return}if(e==="bracket-left"&&this.isANumber(t)){this.tokenList.push("multiply")}this.tokenList.push(e)}else{if(this.isANumber(t)){var i=t+e;var r=this.getTokenValue(i);switch(this.numberSize){case"byte":if(r<-128||r>127){r=false}break;case"ubyte":if(r<0||r>255){r=false}break;case"word":if(r<0||r>65535){r=false}break;case"dword":if(r<0||r>4294967295){r=false}break}if(r!==false){this.tokenList[this.tokenList.length-1]=t+e}}else{if(this.isANumber(e)&&t==="bracket-right"){this.tokenList.push("multiply")}this.tokenList.push(e)}}this.displayEquation()},displayEquation:function(){var e="";var t="0";var i=this.tokenList;for(var r=0;r<i.length;r++){if(!this.isANumber(i[r])){if(i[r]==="bracket-left"){e+=" ("}else if(i[r]==="bracket-right"){e+=") "}else{e+=this.getOperator(i[r]).symbol}}else{if(r!=i.length-1){e+=i[r]}t=i[r]}}$(".calculator-expression").html(e);var a=t;if(typeof t==="string"){this.showOutputValue(t.toUpperCase())}else{this.showOutputValue(t)}var s=t;if(typeof s=="string"){s=this.getTokenValue(t)}this.updateModeValues(s)},updateModeValues:function(e){var t=e.toString(10);var i=e<0;var r="";var a="";switch(this.numberSize){case"byte":if(e<0){e+=256}a=("00000000"+e.toString(2)).substr(-8);if(e>127){e=e-256}t=e.toString(10);r=("00"+e.toString(16)).substr(-2);break;case"ubyte":r=("00"+e.toString(16)).substr(-2);a=("00000000"+e.toString(2)).substr(-8);break;case"word":r=("0000"+e.toString(16)).substr(-4);a=("0000000000000000"+e.toString(2)).substr(-16);break;case"dword":r=("00000000"+e.toString(16)).substr(-8);a=("00000000000000000000000000000000"+e.toString(2)).substr(-32);break}a=formatNumber(a,4," ");r=formatNumber(r,4," ");t=formatNumber(t,3,",");$(".calculator-value-hex").html(r.toUpperCase());$(".calculator-value-bin").html(a);$(".calculator-value-dec").html(t)},deleteLast:function(){if(!this.isANumber(this.tokenList[this.tokenList.length-1])){this.tokenList.pop()}else{this.tokenList[this.tokenList.length-1]=this.tokenList[this.tokenList.length-1].slice(0,-1);if(this.tokenList[this.tokenList.length-1].length===0){this.tokenList.pop()}}this.displayEquation()},bitshift:function(e){var t=0;if(this.tokenList.length>0){t=this.tokenList[this.tokenList.length-1];switch(this.mode){case"hex":t=parseInt(t,16);break;case"dec":t=parseInt(t,10);break;case"bin":t=parseInt(t,2);break}}switch(e){case"rol":var i=0;switch(this.numberSize){case"byte":case"ubyte":i=t>>7&1;break;case"word":i=t>>15&1;break;case"dword":i=t>>32&1;break}t=t<<1|i;break;case"ror":var r=t&1;switch(this.numberSize){case"byte":case"ubyte":r=r<<7;break;case"word":r=r<<15;break;case"dword":r=t<<32;break}t=t>>1|r;break;case"lsh":t=t<<1;break;case"rsh":t=t>>1;break;case"not":t=~t;break}switch(this.numberSize){case"byte":case"ubyte":t=t&255;break;case"word":t=t&65535;break;case"dword":t=t&4294967295;break}var a=t;switch(this.mode){case"dec":a=t.toString(10);break;case"hex":a=t.toString(16).toUpperCase();break;case"bin":a=t.toString(2);break}if(this.tokenList.length>0){this.tokenList[this.tokenList.length-1]=a}else if(t!==0){this.tokenList.push(a)}this.output(t);this.displayEquation()},processButton:function(e){var t=$(e).attr("data-op");switch(t){case"rol":case"ror":case"lsh":case"rsh":case"not":this.bitshift(t);break;case"delete":this.deleteLast();break;case"clear":this.tokenList.length=0;this.displayEquation();break;case"equals":this.calculate();break;default:if(!$(e).hasClass("disabled")){if($(e).hasClass("num")){this.addToken($(e).attr("data-value"))}else{this.addToken($(e).attr("data-op"))}}}}};var MOS6502Opcodes=function(){this.searchTerm=false;this.prefix="dev"};MOS6502Opcodes.prototype={init:function(e,t){this.editor=e;if(typeof t!="undefine"){this.prefix=t}},buildInterface:function(t){var i=this;UI.on("ready",function(){var e="";e+='<div style="padding: 4px" class="panelFill" id="'+i.prefix+'mos6502OpcodeDictionary">';e+='<div style="position: absolute; top: 0; left: 0; right: 0; height: 40px">';e+='  <input name="mos6502OpcodeSearch" id="'+i.prefix+'mos6502OpcodeSearch" class="assemblerDocsSearch" placeholder="Search For..." size="40">';e+="</div>";e+='<div id="'+i.prefix+'mos6502OpcodeInfo" class="assemblerDocsInfo" style="position: absolute; top: 40px; left: 0; right: 0; bottom: 0;">';e+="opcode info opcode info";e+="</div>";e+="</div>";this.uiComponent=UI.create("UI.HTMLPanel",{id:i.prefix+"mos6502OpcodesPanel",html:e});t.add(this.uiComponent);i.initEvents()})},initEvents:function(){var a=this;$("#"+this.prefix+"mos6502OpcodeSearch").on("keyup",function(){var e=$(this).val();a.setSearchTerm(e)});$("#"+this.prefix+"mos6502OpcodeSearch").on("change",function(){var e=$(this).val();a.setSearchTerm(e)});$("#"+this.prefix+"mos6502OpcodeSearch").on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});$("#"+this.prefix+"mos6502OpcodeSearch").on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});$("#"+this.prefix+"mos6502OpcodeInfo").on("click",".mos6502CommandLink",function(e){var t=$(this).attr("data-cmd");var i=$(this).attr("data-section");var r=$(this).attr("data-index");$("#"+a.prefix+"mos6502OpcodeSearch").val(t);if(typeof i=="undefined"||typeof r=="undefined"){console.log("set search term: "+t);a.setSearchTerm(t)}else{a.setSearchResult(i,r)}e.preventDefault()});$("#"+this.prefix+"mos6502OpcodeInfo").on("click",".docs-link",function(e){var t=$(this).attr("data-term");var i=$(this).attr("data-section");var r=$(this).attr("data-index");$("#"+a.prefix+"mos6502OpcodeSearch").val(t);if(typeof i=="undefined"||typeof r=="undefined"){a.setSearchTerm(t)}else{a.setSearchResult(i,r)}e.preventDefault()});$("#"+this.prefix+"mos6502OpcodeInfo").on("click","#"+this.prefix+"gotoAllInstructions",function(){$(""+a.prefix+"#mos6502OpcodeSearch").val("");a.setSearchTerm("",true)});$(".mos6502Related").on("click",".mos6502CommandLink",function(){var e=$(this).attr("data-cmd");$("#"+a.prefix+"mos6502OpcodeSearch").val(e);a.setSearchTerm(e)});this.setSearchTerm("")},setSearchResult:function(e,t){console.log("show: "+e+":"+t);var i=false;if(e=="ioregisters"){i=this.editor.c64MemoryMap.getResultHTML(e,t)}if(e=="6510instr"){i=this.showCmd(t)}if(i!==false){i='<div id="'+this.prefix+'gotoAllInstructions" class="mos6502OpcodeLink">&lt; All Instructions</div>'+i;$("#"+this.prefix+"mos6502OpcodeInfo").html(i)}},setSearchTerm:function(e,t){var i=e.trim().toUpperCase();if(i===this.searchTerm&&(typeof t=="undefined"||t==false)){return}this.searchTerm=i;this.foundOpcodes=[];this.foundCmds=[];if(e.length==2){var r=parseInt(e,16);if(isNaN(r)){r=false}}var a="";if(r!==false){for(var s=0;s<MOS6510Opcodes.length;s++){if(MOS6510Opcodes[s].opcode==r){a=MOS6510Opcodes[s].cmd}}}for(var s=0;s<MOS6510OpcodeCmds.length;s++){if(typeof MOS6510OpcodeCmds[s].cmd!=="undefined"&&MOS6510OpcodeCmds[s].cmd!=="???"){var o=MOS6510OpcodeCmds[s].cmd;MOS6510OpcodeCmds[s].index=s;if(o.indexOf(this.searchTerm)===0||MOS6510OpcodeCmds[s].cmd===a){if(this.foundCmds.indexOf(s)===-1){this.foundCmds.push(s)}}}}var l=[];if(typeof this.editor.c64MemoryMap!="undefined"){l=this.editor.c64MemoryMap.setSearchTerm(e)}var n="";if(this.foundCmds.length>1||l.length>1){n+="<h3>Opcodes</h3>";n+=this.showCmds(this.foundCmds)}else if(this.foundCmds.length==1){n+='<div id="'+this.prefix+'gotoAllInstructions" class="mos6502OpcodeLink">&lt; All Instructions</div>';n+=this.showCmd(this.foundCmds[0])}if(l.length>0){n+=this.editor.c64MemoryMap.getResultsHTML(l)}$("#"+this.prefix+"mos6502OpcodeInfo").html(n)},showCmds:function(e){var t="";e.sort(function(e,t){return MOS6510OpcodeCmds[e].cmd.localeCompare(MOS6510OpcodeCmds[t].cmd)});for(var i=0;i<e.length;i++){var r=MOS6510OpcodeCmds[e[i]].cmd;var a=MOS6510OpcodeCmds[e[i]].name;var s=e[i];t+='<span class="opcode-holder">';t+='<div class="opcode-link mos6502CommandLink" title="'+a+'" data-cmd="'+r+'" data-index="'+s+'" data-section="6510instr">'+r+"</div>";t+="</span>"}return t},showCmd:function(e){cmd=MOS6510OpcodeCmds[e].cmd;var t="";var i="";var r="";var a=["N","V","-","B","D","I","Z","C"];var s={};for(var o=0;o<MOS6510OpcodeCmds.length;o++){if(MOS6510OpcodeCmds[o].cmd==cmd){t=MOS6510OpcodeCmds[o].name;i=MOS6510OpcodeCmds[o].desc;r=MOS6510OpcodeCmds[o].flags;if(typeof MOS6510OpcodeCmds[o].flagInfo!="undefined"){s=MOS6510OpcodeCmds[o].flagInfo}break}}var l="";var n="";for(var o=0;o<a.length;o++){if(r.indexOf(a[o])!==-1){l+=a[o]}else{l+="-"}if(typeof s[a[o]]!=="undefined"){n+="<tr>";n+="<th>"+a[o]+"</th>";n+="<td>"+s[a[o]]+"</td>";n=="</tr>"}}var h="";h+="<h2>"+cmd+"</h2>";h+='<div class="mos6502Name">'+t+"</div>";h+='<div style="position: absolute; top: 80px; left: 0; right: 0; bottom: 0; overflow: auto; padding: 0 8px 8px 8px">';h+='<div class="mos6502Description">'+i+"</div>";h+='<div class="mos6502Flags">';h+="<h3>Flags</h3> ";h+='<div class="mos6502FlagList">'+l+"</div>";if(n!=""){h+='<div class="mos6502FlagInfo">';h+="<table>";h+=n;h+="</table>";h+="</div>"}h+="</div>";h+="<h3>Addressing Modes</h3>";h+='<table class="addressingModeTable">';h+="<tr>";h+="<th>Opcode</th>";h+="<th>Format</th>";h+="<th>Mode</th>";h+="<th>Bytes</th>";h+="<th>Cycles</th>";h+="</tr>";var d=0;for(var o=0;o<MOS6510Opcodes.length;o++){if(MOS6510Opcodes[o].cmd==cmd){var c=MOS6510Opcodes[o];var f=c.opcode;var u=c.example;var p="";switch(c.addressing){case MOS6510AddressingModes.IMMED:p="Immediate";break;case MOS6510AddressingModes.ABSOL:p="Absolute";break;case MOS6510AddressingModes.ZEROP:p="Zero Page";break;case MOS6510AddressingModes.IMPLI:p="Implied";break;case MOS6510AddressingModes.INDIA:p="Indirect Absolute";break;case MOS6510AddressingModes.ABSIX:p="Absolute indexed with X";break;case MOS6510AddressingModes.ABSIY:p="Absolute indexed with Y";break;case MOS6510AddressingModes.ZEPIX:p="Zero Page indexed with X";break;case MOS6510AddressingModes.ZEPIY:p="Zero Page Indexed with Y";break;case MOS6510AddressingModes.INDIN:p="Indexed Indirect (with X)";break;case MOS6510AddressingModes.ININD:p="Indirect indexed (with Y)";break;case MOS6510AddressingModes.RELAT:p="Relative";break;case MOS6510AddressingModes.ACCUM:p="Accumulator";break}f=("00"+f.toString(16)).substr(-2);h+="<tr>";h+='<td class="addressingModeNumber">0x'+f+"</td>";h+='<td class="addressingModeExample">'+u+"</td>";h+="<td>"+p+"</td>";h+='<td class="addressingModeNumber">'+c.bytes+"</td>";h+='<td class="addressingModeNumber">'+c.cycles;if(typeof c.cycleextra!="undefined"){d|=c.cycleextra;h+="*"}h+="</td>";h+="</tr>"}}h+="</table>";if(d!=0){h+='<div style="display:inline-block; width: 10px; vertical-align: top">*</div>';h+='<div style="display: inline-block">';if(d&MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE){h+="<div>1 cycle added if page boundary crossed</div>"}if(d&MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE){h+="<div>1 cycle added if branch taken</div>"}h+="</div>"}h+="</div>";return h}};var C64IORegisters=[{address:"0000",label:"6510 Data Direction Register",chip:"6510",bits:[{l:"0-7",d:"0=Bit in processor port can only be read (input),1=Bit in processor port can be read and written (output)"}],description:"This register determines which of the lines on the 6510 I/O port ($0001) are inputs and which are outputs. The default value is xx101111"},{address:"0001",label:"6510 I/O Port",chip:"6510",bits:[{l:"0",d:"LORAM 0=Switch BASIC ROM Out"},{l:"1",d:"HIRAM 0=Switch Kernal ROM Out"},{l:"2",d:"CHARREN 0=Switch Char ROM In"},{l:"3",d:"Cassette Data Output Link"},{l:"4",d:"Cassette Switch Sense, 1=Switch Closed"},{l:"5",d:"Cassette Motor Control, 0=ON, 1=OFF"},{l:"6-7",d:"Undefined"}],description:"Default value $37 %xx110111: BASIC ROM visible at $A000-$BFFF,  I/O area visible at $D000-$DFFF, KERNAL ROM visible at $E000-$FFFF.\nThe direction of flow of data for each bit is determined by the corresponding bit of the 6510 Data Direction Register ($0000). Note: If KERNAL isn't mapped in, then BASIC won't map in either. If HIRAM and LORAM are both set to 0, CHARREN is ignored",examples:[{description:"Setup RAM at $A000-$BFFF and $E000-$FFFF, I/O at $D000-DFFF",code:"  lda #%00110101 ; hex #$35\n  sta $01 "}],keywords:"ram kernal basic cassette"},{address:"d000",label:"Sprite 0 X Coordinate (bits 0-7)",chip:"VIC-II",description:"This register controls the X position of sprite 0. The x position of a sprite is a 9 bit number (0 - 512) with the most significant bit held in ($d010). Only positions 23 to 347 are visible on the screen.",examples:[{description:"Set sprite 0's x position to 259",code:"; set bits 0-7 of x position\nlda #03\nsta $d000\n; set the msb of x position\nlda $d010\nora #%00000001\nsta $d010"}]},{address:"d001",label:"Sprite 0 Y Coordinate",chip:"VIC-II",description:"This register controls the Y position of sprite 0 (0-255). Only positions 50 - 249 are visible."},{address:"d002",label:"Sprite 1 X Coordinate",chip:"VIC-II",description:"This register controls the X position of sprite 1. The x position of a sprite is a 9 bit number (0 - 512) with the most significant bit held in ($d010). Only positions 23 to 347 are visible on the screen."},{address:"d003",label:"Sprite 1 Y Coordinate",chip:"VIC-II",description:"This register controls the Y position of sprite 1 (0-255). Only positions 50 - 249 are visible."},{address:"d004",label:"Sprite 2 X Coordinate",chip:"VIC-II",description:"This register controls the X position of sprite 2. The x position of a sprite is a 9 bit number (0 - 512) with the most significant bit held in ($d010). Only positions 23 to 347 are visible on the screen."},{address:"d005",label:"Sprite 2 Y Coordinate",chip:"VIC-II",description:"This register controls the Y position of sprite 2 (0-255). Only positions 50 - 249 are visible."},{address:"d006",label:"Sprite 3 X Coordinate",chip:"VIC-II",description:"This register controls the X position of sprite 3. The x position of a sprite is a 9 bit number (0 - 512) with the most significant bit held in ($d010). Only positions 23 to 347 are visible on the screen."},{address:"d007",label:"Sprite 3 Y Coordinate",chip:"VIC-II",description:"This register controls the Y position of sprite 3 (0-255). Only positions 50 - 249 are visible."},{address:"d008",label:"Sprite 4 X Coordinate",chip:"VIC-II",description:"This register controls the X position of sprite 4. The x position of a sprite is a 9 bit number (0 - 512) with the most significant bit held in ($d010). Only positions 23 to 347 are visible on the screen."},{address:"d009",label:"Sprite 4 Y Coordinate",chip:"VIC-II",description:"This register controls the Y position of sprite 4 (0-255). Only positions 50 - 249 are visible."},{address:"d00a",label:"Sprite 5 X Coordinate",chip:"VIC-II",description:"This register controls the X position of sprite 5. The x position of a sprite is a 9 bit number (0 - 512) with the most significant bit held in ($d010). Only positions 23 to 347 are visible on the screen."},{address:"d00b",label:"Sprite 5 Y Coordinate",chip:"VIC-II",description:"This register controls the Y position of sprite 5 (0-255). Only positions 50 - 249 are visible."},{address:"d00c",label:"Sprite 6 X Coordinate",chip:"VIC-II",description:"This register controls the X position of sprite 6. The x position of a sprite is a 9 bit number (0 - 512) with the most significant bit held in ($d010). Only positions 23 to 347 are visible on the screen."},{address:"d00d",label:"Sprite 6 Y Coordinate",chip:"VIC-II",description:"This register controls the Y position of sprite 6 (0-255). Only positions 50 - 249 are visible."},{address:"d00e",label:"Sprite 7 X Coordinate",chip:"VIC-II",description:"This register controls the X position of sprite 7. The x position of a sprite is a 9 bit number (0 - 512) with the most significant bit held in ($d010). Only positions 23 to 347 are visible on the screen."},{address:"d00f",label:"Sprite 7 Y Coordinate ",chip:"VIC-II",description:"This register controls the Y position of sprite 7 (0-255). Only positions 50 - 249 are visible."},{address:"d010",label:"MSBs of X coordinates",chip:"VIC-II",bits:[{l:"0-7",d:"MSB of sprites 0-7"}],description:"The most significant bit of the 9 bit value for a sprite's x position. When a bit is set to 1, the corresponding srpite will be displayed in x positions 256 to 511",keywords:"sprite msb"},{address:"d011",label:"VIC Control Register 1",chip:"VIC-II",bits:[{l:"0-2",d:"Vertical raster scroll"},{l:"3",d:"Screen height (rows). 0 = 24, 1 = 25"},{l:"4",d:"0 = Screen Off, 1 = Screen On"},{l:"5",d:"0 = Text Mode, 1 = Bitmap Mode"},{l:"6",d:"1 = Extended background mode"},{l:"7",d:"Bit 8 of current raster line"}],examples:[{description:"Turn on Extended Background Colour Mode",code:"; turn on ecm mode\nlda $d011\nora #%01000000\nsta $d011"}],keywords:"vertical scroll text bitmap extended background raster"},{address:"d012",label:"Raster Read/Write Register",chip:"VIC-II",description:"Bits 0-7 of the 9-bit value for the raster position. The MSB is stored in ($d011). Reading this register returns the current raster scan position. Writing to this register sets the raster line where to generate an interrupt",examples:[{description:"Generate an interrupt at ",code:"  sei           ; disable maskable IRQs"+"  lda #$01   ; this is how to tell the VICII to generate a raster interrupt\n"+"  sta $d01a  ; interrupt control register\n"+"  lda #$f0   ; this is how to tell at which rasterline we want the irq to be triggered\n"+"  sta $d012\n"+"  lda $d011  ; as there are more than 256 rasterlines, the topmost bit of $d011 serves as"+"  and #$7f   ; the 8th bit for the rasterline we want our irq to be triggered.\n"+"  sta $d011  ; clear it\n"+"; set up the address of the interrupt routine"+"  lda #<irq\n"+"  sta $fffe\n"+"  lda #>irq\n"+"  sta $ffff\n"+"  cli        ; enable maskable interrupts again\n"+"; loop forever..\n"+"loop\n"+"  jmp loop\n"+"; raster interrupt routine  \n"+"irq\n"+"  pha        ;store register A in stack"+"  txa\n"+"  pha        ;store register X in stack\n"+"  tya\n"+"  pha        ;store register Y in stack\n"+"  lda #$ff   ;this is the orthodox and safe way of clearing the interrupt condition of the VICII.\n"+"  sta $d019  ;if you don't do this the interrupt condition will be present all the time and you end\n"+"             ;up having the CPU running the interrupt code all the time, as when it exists the\n"+"             ;interrupt, the interrupt request from the VICII will be there again regardless of the\n"+"             ;rasterline counter.\n"+"             ;it's pretty safe to use inc $d019 (or any other rmw instruction) for brevity, they\n"+"             ;will only fail on hardware like c65 or supercpu. c64dtv is ok with this though.         "}],keywords:"interrupt raster"},{address:"d013",label:"Light pen X",chip:"VIC-II"},{address:"d014",label:"Light pen Y",chip:"VIC-II"},{address:"d015",label:"Sprite enabled",chip:"VIC-II"},{address:"d016",label:"VIC Control register 2",chip:"VIC-II",bits:[{l:"0-2",d:"Horizontal scroll"},{l:"3",d:"Screen width (columns). 0 = 38, 1 = 40"},{l:"4",d:"0 = Multicolour Off, 1 = Multicolor On"},{l:"5",d:"Always set to 0"},{l:"6-7",d:"Unused"}],keywords:"multicolour multicolor horizontal scroll text bitmap extended background raster"},{address:"d017",label:"Sprite Y expansion",chip:"VIC-II"},{address:"d018",label:"VIC Memory setup",chip:"VIC-II",description:"Setup of pointers relative to the VIC bank (set in $dd00)Bits #1-#3: In text mode, pointer to character memory (bits #11-#13), relative to VIC bank, memory address $DD00. Values:"+"%000, 0: $0000-$07FF, 0-2047.%001, 1: $0800-$0FFF, 2048-4095.%010, 2: $1000-$17FF, 4096-6143.%011, 3: $1800-$1FFF, 6144-8191.%100, 4: $2000-$27FF, 8192-10239.%101, 5: $2800-$2FFF, 10240-12287.%110, 6: $3000-$37FF, 12288-14335.%111, 7: $3800-$3FFF, 14336-16383.Values %010 and %011 in VIC bank #0 and #2 select Character ROM instead.In bitmap mode, pointer to bitmap memory (bit #13), relative to VIC bank, memory address $DD00. Values:%0xx, 0: $0000-$1FFF, 0-8191.%1xx, 4: $2000-$3FFF, 8192-16383.Bits #4-#7: Pointer to screen memory (bits #10-#13), relative to VIC bank, memory address $DD00. Values:%0000, 0: $0000-$03FF, 0-1023.%0001, 1: $0400-$07FF, 1024-2047.%0010, 2: $0800-$0BFF, 2048-3071.%0011, 3: $0C00-$0FFF, 3072-4095.%0100, 4: $1000-$13FF, 4096-5119.%0101, 5: $1400-$17FF, 5120-6143.%0110, 6: $1800-$1BFF, 6144-7167.%0111, 7: $1C00-$1FFF, 7168-8191.%1000, 8: $2000-$23FF, 8192-9215.%1001, 9: $2400-$27FF, 9216-10239.%1010, 10: $2800-$2BFF, 10240-11263.%1011, 11: $2C00-$2FFF, 11264-12287.%1100, 12: $3000-$33FF, 12288-13311.%1101, 13: $3400-$37FF, 13312-14335.%1110, 14: $3800-$3BFF, 14336-15359.%1111, 15: $3C00-$3FFF, 15360-16383.",bits:[{l:"0",d:"???"},{l:"1-3",d:"In text mode, pointer to character memory. In bitmap mode, pointer to bitmap memory"},{l:"4-7",d:"Pointer to screen memory"}],keywords:"character memory bitmap",examples:[{description:"Set character set location to $3800",code:"lda $d018\nora #$0e       ; set chars location to $3800 for displaying the custom font\nsta $d018      ; Bits 1-3 ($400+512bytes * low nibble value) of $d018 sets char location ; $400 + $200*$0E = $3800  "}]},{address:"d019",label:"Interrupt register",chip:"VIC-II"},{address:"d01a",label:"Interrupt enabled",chip:"VIC-II"},{address:"d01b",label:"Sprite data priority",chip:"VIC-II"},{address:"d01c",label:"Sprite multicolour",chip:"VIC-II"},{address:"d01d",label:"Sprite X expansion",chip:"VIC-II"},{address:"d01e",label:"Sprite-sprite collision",chip:"VIC-II"},{address:"d01f",label:"Sprite-data collision",chip:"VIC-II"},{address:"d020",label:"Border colour",chip:"VIC-II"},{address:"d021",label:"Background colour 0",chip:"VIC-II"},{address:"d022",label:"Background colour 1",chip:"VIC-II",keywords:"multicolor multicolour"},{address:"d023",label:"Background colour 2",chip:"VIC-II",keywords:"multicolor multicolour"},{address:"d024",label:"Background colour 3",chip:"VIC-II"},{address:"d025",label:"Sprite multicolour 0",chip:"VIC-II"},{address:"d026",label:"Sprite multicolour 1",chip:"VIC-II"},{address:"d027",label:"Sprite 0 colour",chip:"VIC-II"},{address:"d028",label:"Sprite 1 colour",chip:"VIC-II"},{address:"d029",label:"Sprite 2 colour",chip:"VIC-II"},{address:"d02a",label:"Sprite 3 colour",chip:"VIC-II"},{address:"d02b",label:"Sprite 4 colour",chip:"VIC-II"},{address:"d02c",label:"Sprite 5 colour",chip:"VIC-II"},{address:"d02d",label:"Sprite 6 colour",chip:"VIC-II"},{address:"d02e",label:"Sprite 7 colour",chip:"VIC-II"},{address:"d400",label:"Frequency voice 1 low byte",chip:"SID"},{address:"d401",label:"Frequency voice 1 high byte",chip:"SID"},{address:"d402",label:"Pulse wave duty cycle voice 1 low byte",chip:"SID"},{address:"d403",label:"Pulse wave duty cycle voice 1 high byte",chip:"SID"},{address:"d404",label:"Voice 1 Control Register",chip:"SID",bits:[{l:"0",d:"0 = Voice off; 1 = Voice on"},{l:"1",d:"Synchronise voice 1 with 3"},{l:"2",d:"Ring modulate voice 1 with 3"},{l:"3",d:"Test Bit, 1 = disable voice 1, reset noise generator"},{l:"4",d:"Triangle Waveform"},{l:"5",d:"Sawtooth Waveform"},{l:"6",d:"Pulse Waveform"},{l:"7",d:"Noise Waveform"}],description:"Write only"},{address:"d405",label:"Voice 1 Attack duration, decay duration",chip:"SID"},{address:"d406",label:"Voice 1 Sustain level, release duration",chip:"SID"},{address:"d407",label:"Frequency voice 2 low byte",chip:"SID"},{address:"d408",label:"Frequency voice 2 high byte",chip:"SID"},{address:"d409",label:"Pulse wave duty cycle voice 2 low byte",chip:"SID"},{address:"d40a",label:"Pulse wave duty cycle voice 2 high byte",chip:"SID"},{address:"d40b",label:"Control register voice 2",chip:"SID"},{address:"d40c",label:"Attack duration, decay duration Voice 2",chip:"SID"},{address:"d40d",label:"Sustain level release duration Voice 2",chip:"SID"},{address:"d40e",label:"Frequency voice 3 low byte",chip:"SID"},{address:"d40f",label:"Frequency voice 3 high byte",chip:"SID"},{address:"d410",label:"Pulse wave duty cycle voice 3 low byte",chip:"SID"},{address:"d411",label:"Pulse wave duty cycle voice 3 high byte",chip:"SID"},{address:"d412",label:"Control register voice 3",chip:"SID"},{address:"d413",label:"Attack duration, decay duration voice 3",chip:"SID"},{address:"d414",label:"Sustain level, release duration voice 3",chip:"SID"},{address:"d415",label:"Filter cutoff frequency low byte",chip:"SID"},{address:"d416",label:"Filter cutoff frequency high byte",chip:"SID"},{address:"d417",label:"Filter resonance and routing",chip:"SID"},{address:"d418",label:"Filter mode and main volume control",chip:"SID",bits:[{l:"0-3",d:"Volume"},{l:"4",d:"1 = Low pass enabled"},{l:"5",d:"1 = Band pass enabled"},{l:"6",d:"1 = High pass enabled"},{l:"7",d:"1 = Voice 3 disabled"}]},{address:"d419",label:"Paddle x value (read only)",chip:"SID"},{address:"d41a",label:"Paddle y value (read only)",chip:"SID"},{address:"d41b",label:"Oscillator voice 3 (read only)",chip:"SID"},{address:"d41c",label:"Envelope voice 3 (read only)",chip:"SID"},{address:"dc00",label:"CIA 1 Data Port A (Keyboard, Joystick, Paddles, Light Pen)",chip:"CIA 1",bits:[{l:"0",d:"Joystick Port 2 Up"},{l:"1",d:"Joystick Port 2 Down"},{l:"2",d:"Joystick Port 2 Left"},{l:"3",d:"Joystick Port 2 Right"},{l:"4",d:"Joystick Port 2 Fire"},{l:"x (write)",d:"0=Select keyboard matrix column x"},{l:"6-7 (write)",d:"Paddle selection: %01=Paddle 1, %10=Paddle 2"}],keywords:"keyboard joystick paddles"},{address:"dc01",label:"CIA 1 Data Port B (Keyboard, Joystick, Paddles)",chip:"CIA 1",bits:[{l:"0",d:"Joystick Port 1 Up"},{l:"1",d:"Joystick Port 1 Down"},{l:"2",d:"Joystick Port 1 Left"},{l:"3",d:"Joystick Port 1 Right"},{l:"4",d:"Joystick Port 1 Fire"},{l:"x (read)",d:"A key is being pressed in row x in the column selected in $dc00"}],keywords:"keyboard joystick paddles"},{address:"dc02",label:"CIA 1 DDRA",chip:"CIA 1"},{address:"dc03",label:"CIA 1 DDRB",chip:"CIA 1"},{address:"dc04",label:"Timer A low",chip:"CIA 1"},{address:"dc05",label:"Timer A high",chip:"CIA 1"},{address:"dc06",label:"Timer B low",chip:"CIA 1"},{address:"dc07",label:"Timer B high",chip:"CIA 1"},{address:"dc08",label:"TOD Clock 1/10 secs",chip:"CIA 1"},{address:"dc09",label:"TOD Clock Seconds",chip:"CIA 1"},{address:"dc0a",label:"TOD Clock Minutes",chip:"CIA 1"},{address:"dc0b",label:"TOD Clock",chip:"CIA 1"},{address:"dc0c",label:"Serial Data Register",chip:"CIA 1"},{address:"dc0d",label:"Interrupt Control Register",chip:"CIA 1"},{address:"dc0e",label:"Control Register A",chip:"CIA 1"},{address:"dc0f",label:"Control Register B",chip:"CIA 1"},{address:"dd00",label:"Data Port A (Serial Bus, RS-232, VIC Memory Control)",chip:"CIA 2",bits:[{l:"0-1",d:"VIC Chip System Memory Bank Select (default  = 11)"},{l:"2",d:"RS-232 Data Output (User Port)"},{l:"3",d:"Serial Bus ATN Signal Output"},{l:"4",d:"Serial Bus Clock Pulse Output"},{l:"5",d:"Serial Bus Data Output"},{l:"6",d:"Serial Bus Clock Pulse Input"},{l:"7",d:"Serial Bus Data Input"}],description:"%00, 0: Bank #3, $C000-$FFFF, 49152-65535.%01, 1: Bank #2, $8000-$BFFF, 32768-49151.%10, 2: Bank #1, $4000-$7FFF, 16384-32767.%11, 3: Bank #0, $0000-$3FFF, 0-16383.",keywords:"vic bank"},{address:"dd01",label:"Data Port B",chip:"CIA 2"},{address:"dd02",label:"DDRA",chip:"CIA 2"},{address:"dd03",label:"DDRB",chip:"CIA 2"},{address:"dd04",label:"Timer A low",chip:"CIA 2"},{address:"dd05",label:"Timer A high",chip:"CIA 2"},{address:"dd06",label:"Timer B low",chip:"CIA 2"},{address:"dd07",label:"Timer B high",chip:"CIA 2"},{address:"dd08",label:"TOD Clock 1/10 Secs",chip:"CIA 2"},{address:"dd09",label:"TOD Clock Seconds",chip:"CIA 2"},{address:"dd0a",label:"TOD Clock Minutes",chip:"CIA 2"},{address:"dd0b",label:"TOD Clock",chip:"CIA 2"},{address:"dd0c",label:"Serial Data Register",chip:"CIA 2"},{address:"dd0d",label:"Interrupt Control Register",chip:"CIA 2"},{address:"dd0e",label:"Control Register A",chip:"CIA 2"},{address:"dd0f",label:"Control Register B",chip:"CIA 2"},{address:"fffa",label:"NMI Service Routine Address Low",keywords:"interrupts"},{address:"fffb",label:"NMI Service Routine Address High",keywords:"interrupts"},{address:"fffc",label:"Cold Reset Address Low",keywords:"interrupts"},{address:"fffd",label:"Cold Reset Address High",keywords:"interrupts"},{address:"fffe",label:"Interrupt Service Routine Address Low",keywords:"interrupts"},{address:"ffff",label:"Interrupt Service Routine Address High",keywords:"interrupts"}];var C64MemoryMap=function(){this.searchTerm=""};C64MemoryMap.prototype={init:function(e){this.editor=e;for(var t=0;t<C64IORegisters.length;t++){var i="";if(typeof C64IORegisters[t].address!="undefined"){i+=C64IORegisters[t].address+" "}if(typeof C64IORegisters[t].chip!="undefined"){i+=C64IORegisters[t].chip}if(typeof C64IORegisters[t].label!="undefined"){i+=C64IORegisters[t].label}i=i.toLowerCase();if(typeof C64IORegisters[t].keywords=="undefined"){C64IORegisters[t].keywords=""}C64IORegisters[t].keywords+=i;C64IORegisters[t].index=t}},buildInterface:function(e){var t=this;UI.on("ready",function(){this.uiComponent=UI.create("UI.HTMLPanel",{id:"c64MemoryMapPanel"});e.add(this.uiComponent);this.uiComponent.load("html/assemblerUtils/c64MemoryMap.html",function(){t.initEvents()})})},initEvents:function(){var t=this;$("#c64MemoryMapSearch").on("keyup",function(){var e=$(this).val();t.setSearchTerm(e)});$("#c64MemoryMapSearch").on("change",function(){var e=$(this).val();t.setSearchTerm(e)})},setSearchTerm:function(e){this.searchTerm=e.trim().toLowerCase();var t=[];for(var i=0;i<C64IORegisters.length;i++){if(e==""||C64IORegisters[i].keywords.indexOf(e)!=-1){t.push(C64IORegisters[i])}}return t},getResultHTML:function(e,t){var i=C64IORegisters[t];var r="";r+="<h2>"+i.address+"</h2>";r+="<div>";r+=i.chip;r+="</div>";r+="<div>";r+=i.label;r+="</div>";if(typeof i.description!="undefined"){r+="<div>";r+=i.description;r+="</div>"}if(typeof i.bits!="undefined"){r+="<div>";r+="<h3>Bits</h3>";r+="<table>";for(var a=0;a<i.bits.length;a++){r+="<tr>";r+='<td style="white-space: nowrap">'+i.bits[a].l+"</td>";r+="<td>"+i.bits[a].d+"</td>";r+="</tr>"}r+="</table>";r+="</div>"}if(typeof i.examples!="undefined"){r+="<div>";r+="<h3>Examples</h3>";for(var a=0;a<i.examples.length;a++){r+="<h4>"+i.examples[a].description+"</h4>";r+="<pre>";r+=i.examples[a].code;r+="</pre>";r+='<a href="#">Copy To Clipboard</a>'}r+="</div>"}return r},getResultsHTML:function(e){var t="";t+='<div id="gotoAllInstructions" class="mos6502OpcodeLink">&lt; All Instructions</div>';if(e.length==1){t=this.getResultHTML("ioregisters",e[0].index)}else{t+="<h3>Registers</h3>";t+="<table>";t+="<tr>";t+="<th>Address</th>";t+="<th>Chip</th>";t+="<th>Description</th>";t+="</tr>";for(var i=0;i<e.length;i++){t+="<tr>";t+="<td>"+'<a href="#" class="docs-link" data-term="'+e[i]["address"]+'" data-section="ioregisters" data-index="'+e[i].index+'">'+e[i]["address"]+"</a>"+"</td>";t+="<td>";if(typeof e[i].chip!="undefined"){t+=e[i].chip}else{t+="&nbsp;"}t+="</td>";t+="<td>"+e[i]["label"]+"</td>";t+="</tr>"}t+="</table>"}return t}};var DbgFont=function(){this.debuggerFont=null;this.fontCanvas=null;this.fontCanvasColors=[];this.fontSize=12;this.fontCharWidth=10;this.fontCharHeight=18;this.hexNumberCanvas=[];this.hexNumberPositions=[];this.cmdCanvas=null;this.cmdPositions={};this.retinaFont=true;this.fontsCreated=false};DbgFont.prototype={init:function(){},createFonts:function(){if(this.fontsCreated){return}this.initDebuggerFont();this.initHexNumberCanvas();this.initCmdCanvas();this.fontsCreated=true},setFontSize:function(e){this.fontSize=e;if(this.fontsCreated){this.fontsCreated=false;this.initDebuggerFont();this.createFonts()}},initDebuggerFont:function(){if(this.retinaFont){this.fontPx=this.fontSize*UI.devicePixelRatio}else{this.fontPx=this.fontSize}this.font=this.fontPx+'px "Courier New", Courier, monospace';if(this.fontCanvas==null){this.fontCanvas=document.createElement("canvas");this.fontCanvas.style.position="absolute";this.fontCanvas.style.top="-100px";this.fontCanvas.style.left="0px";document.getElementById("ui").appendChild(this.fontCanvas)}this.fontCanvas.width=this.fontPx*3;this.fontCanvas.height=this.fontPx*3;var e=this.fontCanvas.getContext("2d");e.font=this.font;e.clearRect(0,0,this.fontCanvas.width,this.fontCanvas.height);var t=0;e.fillStyle="#ffffff";for(var i=0;i<128;i++){var r=String.fromCharCode(i);var a=e.measureText(r);if(a.width>t){t=a.width}e.fillText(r,0,this.fontPx*2)}var s=this.fontCanvas.width;var o=this.fontCanvas.height;var l=false;var n=false;var h=e.getImageData(0,0,this.fontCanvas.width,this.fontCanvas.height);for(var d=0;d<o;d++){var c=false;for(var f=0;f<s;f++){var u=d*s*4+f*4;if(h.data[u]>100){c=true}}if(l===false&&c){l=d}if(l!==false&&n===false&&!c){n=d}}this.fontCharHeight=n-l+3;this.fontCharWidth=Math.ceil(t);this.baseLine=n-this.fontPx*2;this.fontCanvas.width=this.fontCharWidth*128;this.fontCanvas.height=this.fontCharHeight+6;e=this.fontCanvas.getContext("2d");e.font=this.font;e.fillStyle="#000000";e.fillRect(0,0,this.fontCanvas.width,this.fontCanvas.height);e.fillStyle="#ffffff";for(var i=0;i<128;i++){var r=String.fromCharCode(i);e.fillText(r,i*this.fontCharWidth,this.fontCharHeight-this.baseLine)}var p=["#88aaff","#ff4411"];for(var v=0;v<p.length;v++){if(this.fontCanvasColors.length<=v){this.fontCanvasColors[v]=document.createElement("canvas")}this.fontCanvasColors[v].width=this.fontCharWidth*128;this.fontCanvasColors[v].height=this.fontCharHeight+6;e=this.fontCanvasColors[v].getContext("2d");e.font=this.font;e.fillStyle="#000000";e.fillRect(0,0,this.fontCanvasColors[v].width,this.fontCanvasColors[v].height);e.fillStyle=p[v];for(var i=0;i<128;i++){var r=String.fromCharCode(i);e.fillText(r,i*this.fontCharWidth,this.fontCharHeight-this.baseLine)}}},initCmdCanvas:function(){var e=MOS6510OpcodeCmds.length;if(this.cmdCanvas==null){this.cmdCanvas=document.createElement("canvas")}this.cmdCanvas.width=3*this.fontCharWidth;this.cmdCanvas.height=e*this.fontCharHeight;var t=this.cmdCanvas.getContext("2d");t.font=this.font;t.fillStyle="#b294bb";var i=this.fontCharWidth;var r=this.fontCharHeight;var a=0;var s=0;var o=i;var l=r;var n=0;var h=0;var d=i;var c=r;var f=false;for(var u=0;u<e;u++){var n=0;var p=MOS6510OpcodeCmds[u].cmd;this.cmdPositions[p]={x:n,y:h};var v=p.length;for(var g=0;g<v;g++){var f=String.fromCharCode(p.charCodeAt(g));t.fillText(f,n,h+r-this.baseLine);n+=i}n=0;h+=r}},initHexNumberCanvas:function(){var e=["#ffffff","#aab4ff","#ff94ab"];for(var t=0;t<e.length;t++){if(this.hexNumberCanvas.length<=t){this.hexNumberCanvas[t]=document.createElement("canvas")}this.hexNumberCanvas[t].width=16*2*this.fontCharWidth;this.hexNumberCanvas[t].height=16*this.fontCharHeight;var i=this.hexNumberCanvas[t].getContext("2d");i.fillStyle="#000000";i.fillRect(0,0,this.hexNumberCanvas[t].width,this.hexNumberCanvas[t].height);i.font=this.font;i.fillStyle=e[t];var r=this.fontCharWidth;var a=this.fontCharHeight;var s=0;var o=0;var l=r;var n=a;var h=false;for(var d=0;d<256;d++){if(d!==0&&d%16===0){s=0;o+=a}var c=hex2Digit[d];this.hexNumberPositions[d]={x:s,y:o};for(var f=0;f<2;f++){h=String.fromCharCode(c[f]);i.fillText(h,s,o+a-this.baseLine);s+=r}}}}};MOS6520_AddressingModes={};MOS6520_AddressingModes.IMMED=0;MOS6520_AddressingModes.ABSOL=1;MOS6520_AddressingModes.ZEROP=2;MOS6520_AddressingModes.IMPLI=3;MOS6520_AddressingModes.INDIA=4;MOS6520_AddressingModes.ABSIX=5;MOS6520_AddressingModes.ABSIY=6;MOS6520_AddressingModes.ZEPIX=7;MOS6520_AddressingModes.ZEPIY=8;MOS6520_AddressingModes.INDIN=9;MOS6520_AddressingModes.ININD=10;MOS6520_AddressingModes.RELAT=11;MOS6520_AddressingModes.ACCUM=12;var DbgDisassembly=function(){this.debugger=null;this.fontCanvas=null;this.fontCanvasColors=[];this.fontCharWidth=10;this.fontCharHeight=16;this.hexNumberCanvas=null;this.hexNumberPositions=[];this.cmdCanvas=null;this.cmdPositions=[];this.scrollCanvas=null;this.machine=null;this.lines=[];this.paramCounts=[];this.breakpointColWidth=10;this.cmdPositionX=100;this.opCodePositionX=100;this.cyclesPositionX=0;this.followPC=true;this.disassembleAddress=0;this.visible=true;this.prefix=false;this.dbgFont=null;this.addressPositions=[];this.cursorX=false;this.cursorY=false;this.cursorWidth=false;this.cursorHeight=false;this.disassemblyInfo=[];this.mouseInCanvas=false;this.canWrite=true};DbgDisassembly.prototype={initDisassembly:function(e){this.disassemblyInfo=[];var t=false;for(var i=0;i<65535;i++){this.disassemblyInfo.push({label:false,bytes:1,cycles:false,b:false,prev:t});t=i}},setReport:function(e){var t="";this.initDisassembly();if(typeof e!="undefined"&&typeof e.sourceMap!="undefined"){for(var i=0;i<e.sourceMap.length;i++){var r=e.sourceMap[i].address;var a=e.sourceMap[i].label;this.disassemblyInfo[r].bytes=e.sourceMap[i].byteCount;this.disassemblyInfo[r].b=e.sourceMap[i].b;if(a){this.disassemblyInfo[r].label=a;t+='<option value="'+r+'">';t+=a;t+="</option>"}if(e.sourceMap[i].byteCount){var s=r+e.sourceMap[i].byteCount;this.disassemblyInfo[s].prev=r}}if(typeof e.addressMap!="undefined"){for(var o in e.addressMap){if(e.addressMap.hasOwnProperty(o)){if(e.addressMap[o].label!==false){this.disassemblyInfo[o].label=e.addressMap[o].label}}}}}if(t!=""){t='<option value="">Select Label</option>'+t;$("#"+this.prefix+"DebuggerDisassemblyAddressLabels").show()}else{$("#"+this.prefix+"DebuggerDisassemblyAddressLabels").hide()}$("#"+this.prefix+"DebuggerDisassemblyAddressLabels").html(t)},init:function(e){this.prefix=e.prefix;this.machine=e.machine;this.debugger=e.debugger;if(typeof e.canWrite!="undefined"){this.canWrite=e.canWrite}var t=g_app.dbgFont;t.createFonts();this.fontCanvas=t.fontCanvas;this.fontCanvasColors=t.fontCanvasColors;this.hexNumberCanvas=t.hexNumberCanvas;this.cmdCanvas=t.cmdCanvas;this.setFontMetrics();this.initDisassembly()},setFontMetrics:function(){var e=g_app.dbgFont;this.fontCharWidth=e.fontCharWidth;this.fontCharHeight=e.fontCharHeight;this.hexNumberPositions=e.hexNumberPositions;this.cmdPositions=e.cmdPositions;this.lineHeight=this.fontCharHeight+4*UI.devicePixelRatio;this.cmdPositionX=23*this.fontCharWidth;this.cyclesPositionX=19*this.fontCharWidth;this.opCodePositionX=this.breakpointColWidth+this.fontCharWidth*4+20},buildInterface:function(e){this.uiComponent=UI.create("UI.SplitPanel");e.add(this.uiComponent);var t="";t+='<div style="display: flex">';t+='<label class="cb-container">Follow PC';t+='<input type="checkbox" checked="checked" id="'+this.prefix+'DebuggerDisassemblyUsePC">';t+='<span class="checkmark"></span>';t+="</label>";t+='<div id="'+this.prefix+'DebuggerDisassemblyAddressHolder" style="display: flex">Show from&nbsp;';t+='<input class="number" id="'+this.prefix+'DebuggerDisassemblyAddress" size="4">';t+='<select id="'+this.prefix+'DebuggerDisassemblyAddressLabels" style="display: none">';t+="</select>";t+="</div>";t+="</div>";this.controlsPanel=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.addSouth(this.controlsPanel,30,false);this.scrollCanvas=UI.create("UI.CanvasScrollPanel",{id:this.prefix+"DisassemblyCanvas"});this.uiComponent.add(this.scrollCanvas);var a=this;this.totalLines=1;this.contentHeight=this.totalLines*this.lineHeight;this.scrollCanvas.setContentHeight(this.contentHeight);this.scrollCanvas.draw=function(e){a.draw(e)};this.scrollCanvas.mouseWheel=function(e,t){e.stopPropagation();e.preventDefault();var i=normalizeWheel(e);var r=6;if(i.spinY>0){a.scrollDown(i.spinY)}else{a.scrollUp(i.spinY)}};this.scrollCanvas.on("mousedown",function(e){a.mouseDown(e)});this.scrollCanvas.on("mousemove",function(e){a.mouseMove(e)});this.scrollCanvas.on("mouseup",function(e){a.mouseUp(e)});UI.on("ready",function(){a.initEvents()})},setVisible:function(e){this.visible=e},getVisible:function(){return this.visible},initEvents:function(){var i=this;var e=this.scrollCanvas.getScale();var t=this.fontCharWidth*2/e;var r=this.fontCharHeight/e+2;var a="font: 12px 'Courier New', Courier, monospace;";var s='<input class="'+this.prefix+'DebuggerInput" spellcheck="false"  id="'+this.prefix+'DebuggerDisassemblyInput" type="text" style="'+a+"position: absolute; top: 30px; left: 30px; border: 0;";s+="padding: 0; display: none; width: "+t+"px; height: "+r+'px"/>';var o=$("#"+this.scrollCanvas.getElementId());var l=o.parent();l.append(s);o.on("mouseenter",function(e){i.mouseInCanvas=true});o.on("mouseleave",function(e){i.mouseInCanvas=false});$("#"+this.prefix+"DebuggerDisassemblyInput").on("focus",function(){i.debugger.blurMachine()});$("#"+this.prefix+"DebuggerDisassemblyInput").on("blur",function(){i.assembleEditLine();$(this).hide();i.debugger.focusMachine()});$("#"+this.prefix+"DebuggerDisassemblyAddress").on("focus",function(){i.debugger.blurMachine()});$("#"+this.prefix+"DebuggerDisassemblyAddress").on("blur",function(){i.debugger.focusMachine()});$("#"+this.prefix+"DebuggerDisassemblyInput").on("keydown",function(e){if(e.keyCode==13||e.keyCode==9){e.preventDefault()}});$("#"+this.prefix+"DebuggerDisassemblyInput").on("keypress",function(e){if(e.keyCode==13||e.keyCode==9){e.preventDefault()}});$("#"+this.prefix+"DebuggerDisassemblyInput").on("keyup",function(e){if(i.cmdEditAddress!==false){i.cmdEditKeyUp(e)}if(i.hexEditAddress!==false){i.hexEditKeyUp(e)}});$("#"+this.prefix+"DebuggerDisassemblyUsePC").on("click",function(e){console.log("click follow pc");i.followPC=$(this).is(":checked");if(i.followPC){$("#"+this.prefix+"DebuggerDisassemblyAddressHolder").hide()}else{var t=i.debugger.getPC();i.disassembleAddress=t;t=("0000"+t.toString(16)).substr(-4);$("#"+i.prefix+"DebuggerDisassemblyAddress").val(t);$("#"+i.prefix+"DebuggerDisassemblyAddressHolder").show();$("#"+i.prefix+"DebuggerDisassemblyAddress").focus();$("#"+i.prefix+"DebuggerDisassemblyAddress").select()}});$("#"+this.prefix+"DebuggerDisassemblyAddress").on("keyup",function(e){var t=$(this).val();t=parseInt(t,16);if(!isNaN(t)){i.setDisassembleAddress(t)}});$("#"+this.prefix+"DebuggerDisassemblyAddressLabels").on("change",function(){var e=$(this).val();if(e==""){return}e=parseInt(e,10);i.disassembleAddress=e;var t=("0000"+e.toString(16)).substr(-4);$("#"+i.prefix+"DebuggerDisassemblyAddress").val(t)});this.breakpointColWidth=20*e;this.cmdPositionX=23*this.fontCharWidth;this.cyclesPositionX=19*this.fontCharWidth;this.opCodePositionX=this.breakpointColWidth+this.fontCharWidth*4+20},setDisassembleAddress:function(e){if(this.followPC){this.followPC=false;$("#"+this.prefix+"DebuggerDisassemblyUsePC").prop("checked",false)}this.disassembleAddress=e},disableFollowPC:function(){this.followPC=false;$("#"+this.prefix+"DebuggerDisassemblyUsePC").prop("checked",false);var e=this.debugger.getPC();this.disassembleAddress=e;e=("0000"+e.toString(16)).substr(-4);$("#"+this.prefix+"DebuggerDisassemblyAddress").val(e);$("#"+this.prefix+"DebuggerDisassemblyAddressHolder").show();$("#"+this.prefix+"DebuggerDisassemblyAddress").focus();$("#"+this.prefix+"DebuggerDisassemblyAddress").select()},scrollDown:function(e){if(this.followPC){this.disableFollowPC()}if(this.disassembleAddress!==false){this.disassembleAddress=this.disassembleAddress+this.disassemblyInfo[this.disassembleAddress].bytes}else{this.disassembleAddress=0}var t=("0000"+this.disassembleAddress.toString(16)).substr(-4);$("#"+this.prefix+"DebuggerDisassemblyAddress").val(t)},scrollUp:function(e){if(this.followPC){this.disableFollowPC()}var t=0;if(this.disassembleAddress!==false){t=this.disassemblyInfo[this.disassembleAddress].prev}else{this.disassembleAddress=0}this.disassembleAddress=t;var i=("0000"+this.disassembleAddress.toString(16)).substr(-4);$("#"+this.prefix+"DebuggerDisassemblyAddress").val(i)},cmdEditKeyUp:function(e){if(e.keyCode==38||e.keyCode==9&&e.shiftKey){e.preventDefault();this.moveEditLine(-1)}if(e.keyCode==40||e.keyCode==9&&!e.shiftKey){e.preventDefault();this.moveEditLine(1)}if(e.keyCode==13){e.preventDefault();this.assembleEditLine({gotoNext:true})}else{this.checkEditLine()}},hexEditKeyUp:function(e){var t=$("#"+this.prefix+"DebuggerDisassemblyInput").val();t=parseInt(t,16);if(e.keyCode==13||e.keyCode==9&&!e.shiftKey){if(!isNaN(t)){this.setHexFromInput(t);this.editHex(this.hexEditAddress+1)}e.preventDefault()}},setHexFromInput:function(e){this.debugger.writeByte(this.hexEditAddress,e)},mouseDown:function(e){var t=this.scrollCanvas;var i=t.getElementId();var r=t.getScale();var a=t.getScrollY();var s=e.pageX-$("#"+i).offset().left;var o=e.pageY-$("#"+i).offset().top;s=s*r;o=o*r;var l=Math.floor(o/this.lineHeight);if(l<this.addressPositions.length&&l>=0){if(s<this.breakpointColWidth+4*this.fontCharWidth&&s>0){var n=this.addressPositions[l];var h=this.debugger.getPCBreakpoints();for(var d=0;d<h.length;d++){if(h[d].address===n){var c=h[d].enabled;if(c){this.debugger.setPCBreakpointEnabled({address:n,enabled:!c})}else{this.debugger.removePCBreakpoint({address:n})}this.debugger.breakpoints.drawBreakpoints();return}}this.debugger.addPCBreakpoint({address:n});this.debugger.breakpoints.drawBreakpoints()}}},mouseMove:function(e){var t=this.scrollCanvas;var i=t.getElementId();var r=t.getScale();var a=t.getScrollY();var s=e.pageX-$("#"+i).offset().left;var o=e.pageY-$("#"+i).offset().top;s=s*r;o=o*r;if(!this.canWrite){return}this.cursorX=false;var l=Math.floor(o/this.lineHeight);this.cursorY=l*this.lineHeight;this.cursorHeight=this.fontCharHeight;if(l<this.addressPositions.length&&l>=0){var n=this.addressPositions[l];var h=this.paramCounts[l];if(s>this.opCodePositionX&&s<this.cmdPositionX){s=s-this.opCodePositionX;this.cursorWidth=2*this.fontCharWidth;this.cursorHeight=this.fontCharHeight;this.cursorY=l*this.lineHeight;if(s>0&&s<this.fontCharWidth*2){this.cursorX=this.opCodePositionX}if(s>this.fontCharWidth*3&&s<this.fontCharWidth*5){if(h>0){this.cursorX=this.opCodePositionX+this.fontCharWidth*3}}if(s>this.fontCharWidth*6&&s<this.fontCharWidth*8){if(h>1){this.cursorX=this.opCodePositionX+this.fontCharWidth*6}}}if(s>this.cmdPositionX){this.cursorX=this.cmdPositionX;this.cursorWidth=this.fontCharWidth*23}}},mouseUp:function(e){var t=this.scrollCanvas;var i=t.getElementId();var r=t.getScale();var a=t.getScrollY();var s=e.pageX-$("#"+i).offset().left;var o=e.pageY-$("#"+i).offset().top;s=s*r;o=o*r;if(!this.canWrite){return}var l=Math.floor(o/this.lineHeight);if(l<this.addressPositions.length&&l>=0){var n=this.addressPositions[l];var h=this.paramCounts[l];if(s>this.opCodePositionX&&s<this.cmdPositionX){s=s-this.opCodePositionX;if(s>0&&s<this.fontCharWidth*2){this.editHex(n,0)}if(s>this.fontCharWidth*3&&s<this.fontCharWidth*5){if(h>0){this.editHex(n+1)}}if(s>this.fontCharWidth*6&&s<this.fontCharWidth*8){if(h>1){this.editHex(n+2)}}}if(s>this.cmdPositionX){this.editCmd(n)}}},getCmd:function(e){var t=e;var i=this.debugger.readByte(t)&255;var r=MOS6510Opcodes[i];var a="";var s=0;var o=0;if(typeof r!="undefined"){a=r.cmd;s=r.bytes;o=r.addressing}else{console.log("unknown opcode: "+i)}var l=this.debugger.readByte(t+1)&255;var n=this.debugger.readByte(t+2)&255;l=("00"+l.toString(16)).substr(-2);n=("00"+n.toString(16)).substr(-2);var h=s-1;var d="";d+=a;if(h==2){d+=" ";if(o==MOS6520_AddressingModes.INDIA){d+="("}d+="$";d+=n;d+=l;if(o==MOS6520_AddressingModes.ABSIX){d+=",X"}if(o==MOS6520_AddressingModes.INDIA){d+=")"}if(o==MOS6520_AddressingModes.ABSIY){d+=",Y"}}if(h==1){d+=" ";if(o==MOS6520_AddressingModes.IMMED){d+="#"}if(o==MOS6520_AddressingModes.RELAT){var c=t;var f=parseInt(l,16);if(f>127){f=f-256}var u=c+f+2;var p=("0000"+u.toString(16)).substr(-4);l=p}if(o==MOS6520_AddressingModes.ININD){d+="("}d+="$"+l;if(o==MOS6520_AddressingModes.ININD){d+="),Y"}if(o==MOS6520_AddressingModes.ABSIX||o==MOS6520_AddressingModes.ZEPIX){d+=",X"}}return d},moveEditLine:function(e){var t=false;for(var i=0;i<this.addressPositions.length;i++){if(this.addressPositions[i]==this.cmdEditAddress){t=i;break}}if(t!==false){var r=this.cmdEditAddress;while(a>=0&&this.cmdEditAddress===r&&a<this.addressPositions.length){var a=t+e;r=this.addressPositions[a]}this.editCmd(r)}},setCursorHex:function(e){},editHex:function(e){this.hexEditAddress=e;this.cmdEditAddress=false;var t=this.debugger.readByte(e);t=("00"+t.toString(16)).substr(-2);$("#"+this.prefix+"DebuggerDisassemblyInput").val(t);this.setInputPosition();$("#"+this.prefix+"DebuggerDisassemblyInput").css("background-color","#ffffff");$("#"+this.prefix+"DebuggerDisassemblyInput").focus();$("#"+this.prefix+"DebuggerDisassemblyInput").select()},editCmd:function(e){this.cmdEditAddress=e;this.hexEditAddress=false;var t=this.getCmd(e);$("#"+this.prefix+"DebuggerDisassemblyInput").val(t);this.setInputPosition();$("#"+this.prefix+"DebuggerDisassemblyInput").css("background-color","#ffffff");$("#"+this.prefix+"DebuggerDisassemblyInput").focus();$("#"+this.prefix+"DebuggerDisassemblyInput").select()},checkEditLine:function(){var e=this.cmdEditAddress;var t=$("#"+this.prefix+"DebuggerDisassemblyInput").val();var i=g_app.assembler.assembleLine(t,this.cmdEditAddress);if(!i.success){$("#"+this.prefix+"DebuggerDisassemblyInput").css("background-color","#ffcccc")}else{$("#"+this.prefix+"DebuggerDisassemblyInput").css("background-color","#ffffff")}},assembleEditLine:function(e){var t=false;var i=this.cmdEditAddress;var r=$("#"+this.prefix+"DebuggerDisassemblyInput").val();if(typeof e!="undefined"){if(typeof e.gotoNext!="undefined"){t=e.gotoNext}}var a=g_app.assembler.assembleLine(r,this.cmdEditAddress);if(a.success){for(var s=0;s<a.bytes.length;s++){this.debugger.writeByte(i++,a.bytes[s])}if(t){this.editCmd(i)}}else{$("#"+this.prefix+"DebuggerDisassemblyInput").css("background-color","#ffcccc")}},getLabel:function(e){if(e<this.disassemblyInfo.length){return this.disassemblyInfo[e].label}return false},setInputPosition:function(){var e=this.scrollCanvas.getScrollY();var t=this.scrollCanvas.getScale();var i=false;var r=0;if(this.hexEditAddress!==false||this.cmdEditAddress!==false){var a=this.hexEditAddress;if(a===false){a=this.cmdEditAddress}this.draw(this.scrollCanvas.getContext());var i=false;for(var s=0;s<this.addressPositions.length;s++){if(this.addressPositions[s]===a){while(s<this.addressPositions.length&&this.addressPositions[s]==a){i=s;s++}r=0;break}if(this.hexEditAddress!==false){var o=this.paramCounts[s];if(o>0&&this.addressPositions[s]+1===a){i=s;r=1;break}if(o>1&&this.addressPositions[s]+2===a){i=s;r=2;break}}}if(i===false){return}}if(this.hexEditAddress!==false){var l={x:this.opCodePositionX+r*3*this.fontCharWidth,y:i*this.lineHeight};var n=l.x/t;var h=(l.y-e)/t;var d=2*this.fontCharWidth/t;$("#"+this.prefix+"DebuggerDisassemblyInput").show();$("#"+this.prefix+"DebuggerDisassemblyInput").css("width",d+"px");$("#"+this.prefix+"DebuggerDisassemblyInput").css("left",n);$("#"+this.prefix+"DebuggerDisassemblyInput").css("top",h+"px")}if(this.cmdEditAddress!==false){var l={x:this.cmdPositionX,y:i*this.lineHeight};var n=l.x/t;var h=(l.y-e)/t;$("#"+this.prefix+"DebuggerDisassemblyInput").show();$("#"+this.prefix+"DebuggerDisassemblyInput").css("width","180px");$("#"+this.prefix+"DebuggerDisassemblyInput").css("left",n);$("#"+this.prefix+"DebuggerDisassemblyInput").css("top",h+"px")}},forceRedraw:function(){if(this.scrollCanvas){this.scrollCanvas.resize()}this.lastWidth=false;this.lastHeight=false;this.visible=true},draw:function(e){this.setFontMetrics();var t=this.scrollCanvas;var i=t.getScale();var r=t.getWidth();var a=t.getHeight();var s=t.getScrollY();var o=this.debugger.getPC();var l=this.debugger.getPCBreakpoints();e.fillStyle="#000000";e.fillRect(0,0,r,a);e.fillStyle="#444444";var n=1;var h=this.fontCharWidth;var d=this.fontCharHeight;var c="";var f=0;var u=0;var p=h;var v=d;var g=0;var m=0;var y=h;var b=d;var C=0;var x=Math.ceil(a/this.lineHeight)+1;var S=false;var P=4*i;var w=l.length;var I=4*i;var k=1*i;var M=Math.floor(x/4);var T=Math.floor(M*2);var D=o;if(!this.followPC){D=this.disassembleAddress}var E=D;{for(var $=0;$<T;$++){if(E!==false&&typeof this.disassemblyInfo[E]!="undefined"){E=this.disassemblyInfo[E].prev}if(E===false){T=$;E=0;break}}var _=0;for(var $=0;$<T+5;$++){var B=this.getLabel(E);if(B!=false){_++}var R=this.debugger.readByte(E)&255;var A=MOS6510Opcodes[R];var F=this.debugger.getCycleCount(E);var L=1;if(F>0){if(typeof A!="undefined"){c=A.cmd;L=A.bytes;Y=A.addressing}else{c="zz";L=1}}else{var U=this.disassemblyInfo[E].b;if(U==R){L=this.disassemblyInfo[E].bytes}}var H=L-1;E+=1+H;_++;if(D==E){break}}var B=this.getLabel(E);if(B!=false){_++}for(var $=0;$<T;$++){E=this.disassemblyInfo[E].prev}m=m-(_-M)*this.lineHeight;x+=_-M}this.paramCounts=[];this.addressPositions=[];var O=false;var G=false;for(var $=0;$<x;$++){n=1;if(E>=65535){break}var B=this.getLabel(E);if(B!==false){var z=B.length;g+=this.breakpointColWidth;if(m>=0){for(var N=0;N<z;N++){var C=B.charCodeAt(N);f=C*h;u=0;p=h;v=d;y=h;b=d;e.drawImage(this.fontCanvasColors[0],f,u,p,v,g,m,y,b);g+=h}this.addressPositions.push(E);this.paramCounts.push(0)}m+=this.lineHeight*1}g=0;if(m>=0){for(var N=0;N<w;N++){if(l[N].address==E){e.fillStyle="#ff0000";e.strokeStyle="#ff0000";e.lineWidth=2;e.beginPath();e.arc(g+I+P,m+k+P,P,0,2*Math.PI);if(l[N].enabled){e.fill()}else{e.stroke()}}}}g=this.breakpointColWidth;var W=E>>8&255;var X=E&255;S=this.hexNumberPositions[W];f=S.x;u=S.y;if(m>=0){e.globalAlpha=.5;e.drawImage(this.hexNumberCanvas[0],f,u,p*2,v,g,m,y*2,b);g+=y*2;S=this.hexNumberPositions[X];f=S.x;u=S.y;e.drawImage(this.hexNumberCanvas[0],f,u,p*2,v,g,m,y*2,b);e.globalAlpha=1;g+=y*2;g+=10;g=this.opCodePositionX}var R=this.debugger.readByte(E)&255;var A=MOS6510Opcodes[R];c="";var L=0;var Y=0;var F=this.debugger.getCycleCount(E);var B=false;if(O===false){O=D===E}var V=false;if(!F){var U=this.disassemblyInfo[E].b;if(U==R){V=true}}if(!O&&!F&&!V){c="???";L=1}else{if(typeof A!="undefined"){c=A.cmd;L=A.bytes;Y=A.addressing;if(typeof c=="undefined"){console.log("undefined opcode");console.log(A)}}else{c="???";L=1}}var q=0;var j=0;if(E+1<65535){q=this.debugger.readByte(E+1)&255}if(E+2<65535){j=this.debugger.readByte(E+2)&255}var H=L-1;if(m>=0){this.paramCounts.push(H);var K="";S=this.hexNumberPositions[R];f=S.x;u=S.y;e.drawImage(this.hexNumberCanvas[0],f,u,p*2,v,g,m,y*2,b);g+=y*2;g+=y;if(H>0){S=this.hexNumberPositions[q];f=S.x;u=S.y;e.drawImage(this.hexNumberCanvas[0],f,u,p*2,v,g,m,y*2,b);g+=y*2;g+=y}if(H>1){S=this.hexNumberPositions[j];f=S.x;u=S.y;e.drawImage(this.hexNumberCanvas[0],f,u,p*2,v,g,m,y*2,b);g+=y*2}if(F!==false&&F<10){g=this.cyclesPositionX;S=this.hexNumberPositions[F];f=S.x+p;u=S.y;if(F>0){e.drawImage(this.hexNumberCanvas[0],f,u,p,v,g,m,y,b)}}g=this.cmdPositionX;S=this.cmdPositions[c];if(typeof S!="undefined"){f=S.x;u=S.y;e.drawImage(this.cmdCanvas,f,u,p*3,v,g,m,y*3,b);g+=y*3}else{console.log("not found: "+c)}if(H==2){K+=" ";if(Y==MOS6510AddressingModes.INDIA){K+="("}K+="$";var z=K.length;for(var N=0;N<z;N++){var C=K.charCodeAt(N);f=C*h;u=0;p=h;v=d;y=h;b=d;e.drawImage(this.fontCanvas,f,u,p,v,g,m,y,b);g+=h}S=this.hexNumberPositions[j];f=S.x;u=S.y;e.drawImage(this.hexNumberCanvas[n],f,u,p*2,v,g,m,y*2,b);g+=y*2;S=this.hexNumberPositions[q];f=S.x;u=S.y;e.drawImage(this.hexNumberCanvas[n],f,u,p*2,v,g,m,y*2,b);g+=y*2;K="";if(Y==MOS6510AddressingModes.ABSIX){K+=",X"}if(Y==MOS6510AddressingModes.INDIA){K+=")"}if(Y==MOS6510AddressingModes.ABSIY){K+=",Y"}}if(H==1){j=false;K+=" ";if(Y==MOS6510AddressingModes.IMMED){K+="#";n=2}if(Y==MOS6510AddressingModes.RELAT){var Z=E;var J=q;if(J>127){J=J-256}var Q=Z+J+2;j=Q>>8&255;q=Q&255}if(Y==MOS6510AddressingModes.ININD){K+="("}K+="$";var z=K.length;for(var N=0;N<z;N++){var C=K.charCodeAt(N);f=C*h;u=0;p=h;v=d;y=h;b=d;e.drawImage(this.fontCanvas,f,u,p,v,g,m,y,b);g+=h}if(j!==false){S=this.hexNumberPositions[j];f=S.x;u=S.y;e.drawImage(this.hexNumberCanvas[n],f,u,p*2,v,g,m,y*2,b);g+=y*2}S=this.hexNumberPositions[q];f=S.x;u=S.y;e.drawImage(this.hexNumberCanvas[n],f,u,p*2,v,g,m,y*2,b);g+=y*2;K="";if(Y==MOS6510AddressingModes.ININD){K+="),Y"}if(Y==MOS6510AddressingModes.ABSIX||Y==MOS6510AddressingModes.ZEPIX){K+=",X"}}if(H==0){}var z=K.length;for(var N=0;N<z;N++){var C=K.charCodeAt(N);f=C*h;u=0;p=h;v=d;y=h;b=d;e.drawImage(this.fontCanvas,f,u,p,v,g,m,y,b);g+=h}if(o===E){e.beginPath();e.lineWidth=1;e.strokeStyle="#ffffff";e.moveTo(this.breakpointColWidth,m+this.fontCharHeight+.5);e.lineTo(350*i,m+this.fontCharHeight+.5);e.stroke();if(!this.debugger.isRunning()){e.fillStyle="#cccccc";var ee=m+ +this.fontCharHeight/4;var te=this.fontCharHeight/2;var ie=this.breakpointColWidth/2;e.moveTo(4,ee);e.lineTo(4+ie,ee+te/2);e.lineTo(4,ee+te);e.lineTo(4,ee);e.fill()}}this.addressPositions.push(E)}G=E;if(typeof this.disassemblyInfo[E]!="undefined"){this.disassemblyInfo[E].bytes=H+1}E+=1+H;if(isNaN(E)){console.log("program counter is NAN!!!!");console.log("param count = "+H)}if(typeof this.disassemblyInfo[E]!="undefined"){this.disassemblyInfo[E].prev=G}m+=this.lineHeight;g=0}if(this.cursorX!==false&&this.mouseInCanvas){e.beginPath();e.strokeStyle="#cccccc";e.rect(this.cursorX-.5,this.cursorY-.5,this.cursorWidth,this.cursorHeight);e.stroke()}},update:function(){if(this.visible){this.scrollCanvas.render()}}};var DbgBreakpoints=function(){this.debugger=null;this.fontCanvas=null;this.fontCharWidth=10;this.fontCharHeight=16;this.lineHeight=this.fontCharHeight;this.lastScrollY=0;this.machine=null;this.debugger=null;this.breakpointColWidth=10;this.deletePositionX=0;this.breakpointType="pc";this.memoryBreakpointsY=0;this.rasterYBreakpointsY=0;this.visible=true;this.prefix=""};DbgBreakpoints.prototype={init:function(e){this.prefix=e.prefix;this.machine=e.machine;this.debugger=e.debugger;var t=g_app.dbgFont;t.createFonts();this.fontCanvas=t.fontCanvas;this.hexNumberCanvas=t.hexNumberCanvas[0];this.hexNumberPositions=t.hexNumberPositions;this.cmdCanvas=t.cmdCanvas;this.cmdPositions=t.cmdPositions;this.breakpointColWidth=20*UI.devicePixelRatio;this.deletePositionX=200*UI.devicePixelRatio;this.setFontMetrics()},setFontMetrics:function(){var e=g_app.dbgFont;this.fontCharWidth=e.fontCharWidth;this.fontCharHeight=e.fontCharHeight;this.hexNumberPositions=e.hexNumberPositions;this.cmdPositions=e.cmdPositions;this.lineHeight=this.fontCharHeight+4*UI.devicePixelRatio;this.cmdPositionX=23*this.fontCharWidth;this.cyclesPositionX=19*this.fontCharWidth;this.opCodePositionX=this.breakpointColWidth+this.fontCharWidth*4+20},setVisible:function(e){this.visible=e},getVisible:function(){return this.visible},buildInterface:function(e){this.uiComponent=UI.create("UI.SplitPanel",{id:this.prefix+"BreakpointsCanvas"});e.add(this.uiComponent);var t="";t+='<div class="panelFill" style="background-color: #111111">';t+="Breakpoints";t+="</div>";this.headingPanel=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.addNorth(this.headingPanel,24,false);t="";t+='<div class="panelFill" style="background-color: #111111">';t+="  <div>";t+='    <select id="'+this.prefix+'BreakpointType">';t+='      <option value="pc">PC</option>';t+='      <option value="memory">Memory</option>';t+='      <option value="rasterY">Raster Y</option>';t+="    </select>";t+='    <input id="'+this.prefix+'BreakpointAddress" size="4"/>';t+='    <div id="'+this.prefix+'BreakpointMemoryOptions" style="display: inline-block;">';t+='      <select id="'+this.prefix+'BreakpointOp">';t+='        <option value="0">==</option>';t+='        <option value="1">!=</option>';t+='        <option value="2">&lt;</option>';t+='        <option value="3">&gt;</option>';t+="      </select>";t+='      <input id="'+this.prefix+'BreakpointValue" maxlength="2" size="4"/>';t+="    </div>";t+='    <div id="'+this.prefix+'AddBreakpoint" class="ui-button">Add</div>';t+="  </div>";t+="</div>";this.controlsPanel=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.addSouth(this.controlsPanel,34,false);this.scrollCanvas=UI.create("UI.CanvasScrollPanel");this.scrollCanvas.draw=function(e){i.draw(e)};this.uiComponent.add(this.scrollCanvas);var i=this;UI.on("ready",function(){i.initEvents();i.setBreakpointType("pc")});this.scrollCanvas.on("resize",function(){i.drawBreakpoints()});this.scrollCanvas.on("mousedown",function(e){i.mouseDown(e)})},setBreakpointType:function(e){this.breakpointType=e;switch(e){case"pc":case"address":case"rasterY":$("#"+this.prefix+"BreakpointMemoryOptions").hide();break;case"memory":$("#"+this.prefix+"BreakpointMemoryOptions").show();break}},mouseDown:function(e){var t=this.scrollCanvas.getElementId();var i=this.scrollCanvas.getScale();var r=e.pageX-$("#"+t).offset().left;var a=e.pageY-$("#"+t).offset().top;r=r*i;a=a*i;var s=this.debugger.getPCBreakpoints();var o=Math.floor(a/this.lineHeight);if(o<s.length){var l=s[o].address;var n=s[o].enabled;if(r<this.deletePositionX){this.debugger.setPCBreakpointEnabled({address:l,enabled:!n});this.drawBreakpoints();return}if(r>this.deletePositionX&&r<this.deletePositionX+this.fontCharWidth){this.debugger.removePCBreakpoint({address:l});this.drawBreakpoints();return}}s=this.debugger.getMemoryBreakpoints();o=Math.floor((a-this.memoryBreakpointsY)/this.lineHeight);if(o>=0&&o<s.length){var l=s[o].address;var n=s[o].enabled;var h=s[o].op;var d=s[o].value;if(r<this.deletePositionX){this.debugger.setMemoryBreakpointEnabled({address:l,op:h,value:d,enabled:!n});this.drawBreakpoints()}if(r>this.deletePositionX&&r<this.deletePositionX+this.fontCharWidth){this.debugger.removeMemoryBreakpoint({address:l,op:h,value:d});this.drawBreakpoints()}}s=this.debugger.getRasterYBreakpoints();o=Math.floor((a-this.rasterYBreakpointsY)/this.lineHeight);if(o>=0&&o<s.length){var c=s[o].rasterY;var n=s[o].enabled;if(r<this.deletePositionX){this.debugger.setRasterYBreakpointEnabled({rasterY:c,enabled:!n});this.drawBreakpoints()}if(r>this.deletePositionX&&r<this.deletePositionX+this.fontCharWidth){this.debugger.removeRasterYBreakpoint({rasterY:c});this.drawBreakpoints()}}},initEvents:function(){var s=this;$("#"+this.prefix+"BreakpointType").on("change",function(){var e=$(this).val();s.setBreakpointType(e)});$("#"+this.prefix+"AddBreakpoint").on("click",function(){var e=$("#"+s.prefix+"BreakpointType").val();if(e=="pc"){var t=parseInt($("#"+s.prefix+"BreakpointAddress").val(),16);$("#"+s.prefix+"BreakpointAddress").val("");if(isNaN(t)){alert("Please enter valid address");return}if(t<0||t>=64*1024){alert("Please enter a valid address");return}var i={address:t,enabled:true};s.addPCBreakpoint(i)}if(e=="memory"){var t=parseInt($("#"+s.prefix+"BreakpointAddress").val(),16);$("#"+s.prefix+"BreakpointAddress").val("");if(isNaN(t)){alert("Please enter valid address");return}if(t<0||t>=64*1024){alert("Please enter a valid address");return}var r=$("#"+s.prefix+"BreakpointOp").val();var a=parseInt($("#"+s.prefix+"BreakpointValue").val(),16);$("#"+s.prefix+"BreakpointValue").val("");if(!isNaN(a)&&!isNaN(t)){var i={address:t,enabled:true,op:r,value:a};s.addMemoryBreakpoint(i)}}if(e=="rasterY"){var t=parseInt($("#"+s.prefix+"BreakpointAddress").val(),10);$("#"+s.prefix+"BreakpointAddress").val("");var i={rasterY:t,enabled:true};s.addRasterYBreakpoint(i)}});$("#"+this.prefix+"BreakpointAddress").on("focus",function(){s.debugger.blurMachine()});$("#"+this.prefix+"BreakpointAddress").on("blur",function(){s.debugger.focusMachine()});$("#"+this.prefix+"BreakpointValue").on("focus",function(){s.debugger.blurMachine()});$("#"+this.prefix+"BreakpointValue").on("blur",function(){s.debugger.focusMachine()})},addPCBreakpoint:function(e){this.debugger.addPCBreakpoint(e);this.drawBreakpoints()},addMemoryBreakpoint:function(e){this.debugger.addMemoryBreakpoint(e);this.drawBreakpoints()},addRasterYBreakpoint:function(e){this.debugger.addRasterYBreakpoint(e);this.drawBreakpoints()},draw:function(e){this.setFontMetrics();var t=this.scrollCanvas;var i=t.getWidth();var r=t.getHeight();var a=t.getScrollY();if(a!==this.lastScrollY||i!==this.lastWidth||r!==this.lastHeight){this.lastScrollY=a;this.lastWidth=i;this.lastHeight=r;this.drawBreakpoints();return}var s=this.debugger.getMemoryBreakpoints();var o=this.fontCharWidth;var l=this.fontCharHeight;var n=0;var h=0;var d=o;var c=l;var f=0;var u=0;var p=o;var v=l;u=this.memoryBreakpointsY;var g=s.length;for(var m=0;m<g;m++){f=this.breakpointColWidth+o*5;var y=s[m].address;var b=this.debugger.readByte(y);var C=("00"+b.toString(16)).substr(-2);var x=C.length;for(var S=0;S<x;S++){var P=C.charCodeAt(S);n=P*o;h=0;d=o;c=l;p=o;v=l;e.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}u+=this.lineHeight}},updateContentSize:function(){var e=0;var t=this.debugger.getPCBreakpoints();e+=t.length;t=this.debugger.getMemoryBreakpoints();e+=t.length;t=this.debugger.getMemoryBreakpoints();e+=t.length;this.contentHeight=e*this.lineHeight;this.scrollCanvas.setContentHeight(this.contentHeight)},drawBreakpoints:function(){this.setFontMetrics();this.updateContentSize();var e=this.scrollCanvas;var t=e.getContext();var i=e.getWidth();var r=e.getHeight();t.fillStyle="#000000";t.fillRect(0,0,i,r);t.fillStyle="#444444";var a=e.getScrollY();this.deletePositionX=i-this.fontCharWidth*2;var s="";var o=this.fontCharWidth;var l=this.fontCharHeight;var n=0;var h=0;var d=o;var c=l;var f=0;var u=0;var p=o;var v=l;u=-a;var g=4*UI.devicePixelRatio;var m=4*UI.devicePixelRatio;var y=Math.floor((l-g*2)/2);breakpoints=this.debugger.getPCBreakpoints();var b=breakpoints.length;for(var C=0;C<b;C++){f=0;var x=breakpoints[C].address;var S=breakpoints[C].enabled;t.fillStyle="#ff0000";t.strokeStyle="#ff0000";t.lineWidth=2;t.beginPath();t.arc(f+m+g,u+y+g,g,0,2*Math.PI);if(S){t.fill()}else{t.stroke()}f=this.breakpointColWidth;var P=0;s="PC = ";P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}f+=o;f+=o;f+=o;s=("0000"+x.toString(16)).substr(-4);P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}if(breakpoints[C].file){f+=o*2;s=breakpoints[C].file;if(breakpoints[C].lineNumber){s+="("+breakpoints[C].lineNumber+")"}P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}}f=this.deletePositionX;s="X";P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}u+=this.lineHeight}this.memoryBreakpointsY=u;breakpoints=this.debugger.getMemoryBreakpoints();var b=breakpoints.length;for(var C=0;C<b;C++){f=0;var x=breakpoints[C].address;var k=breakpoints[C].op;var M=breakpoints[C].value;var S=breakpoints[C].enabled;t.fillStyle="#ff0000";t.strokeStyle="#ff0000";t.lineWidth=2;t.beginPath();t.arc(f+m+g,u+y+g,g,0,2*Math.PI);if(S){t.fill()}else{t.stroke()}f=this.breakpointColWidth;s="MEM";P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}f+=o;f+=o;s=("0000"+x.toString(16)).substr(-4);P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}f=this.breakpointColWidth+9*o;switch(k){case 0:s="==";break;case 1:s="!=";break;case 2:s="<";break;case 3:s=">";break}var P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}f+=10;var s=("00"+M.toString(16)).substr(-2);var P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}f=this.deletePositionX;s="X";var P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}u+=this.lineHeight}breakpoints=this.debugger.getRasterYBreakpoints();this.rasterYBreakpointsY=u;b=breakpoints.length;for(var C=0;C<b;C++){f=0;var T=breakpoints[C].rasterY;var S=breakpoints[C].enabled;t.fillStyle="#00ff00";t.strokeStyle="#00ff00";t.lineWidth=2;t.beginPath();t.arc(f+m+g,u+y+g,g,0,2*Math.PI);if(S){t.fill()}else{t.stroke()}f=this.breakpointColWidth;s="RY";P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}f+=o;f+=o;f+=o;s=T.toString(10);P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}f=this.deletePositionX;s="X";var P=s.length;for(var w=0;w<P;w++){var I=s.charCodeAt(w);n=I*o;h=0;d=o;c=l;p=o;v=l;t.drawImage(this.fontCanvas,n,h,d,c,f,u,p,v);f+=o}u+=this.lineHeight}},update:function(){if(this.visible){this.scrollCanvas.render()}}};var hex2Digit=[];for(var i=0;i<256;i++){var text=("00"+i.toString(16)).substr(-2);var entry=[];entry.push(text.charCodeAt(0));entry.push(text.charCodeAt(1));hex2Digit.push(entry)}var hex4Digit=[];for(var i=0;i<65536;i++){var text=("0000"+i.toString(16)).substr(-4);var entry=[];entry.push(text.charCodeAt(0));entry.push(text.charCodeAt(1));entry.push(text.charCodeAt(2));entry.push(text.charCodeAt(3));hex4Digit.push(entry)}var DbgMemory=function(){this.debugger=null;this.fontCanvas=null;this.fontCharWidth=10;this.fontCharHeight=16;this.hexNumberCanvas=null;this.hexNumberPositions=[];this.lineHeight=this.fontCharHeight;this.previousValues=[];this.lastScrollY=false;this.lastWidth=false;this.lastHeight=false;this.machine=null;this.addressStartX=10;this.valuesStartX=100;this.valueSpacing=10;this.bytesAcross=8;this.mouseCursorAddress=false;this.highlightedMouseCursorAddress=false;this.labelMap={};this.inputAddress=false;this.enteredAddress=false;this.visible=true;this.mouseInCanvas=false;this.prefix=false;this.maxAddress=65536;this.drawMode="memory";this.screenImageData=null;this.screenCanvas=null;this.screenContext=null;this.screenScale=2;this.charData=[];this.charWidth=8;this.charHeight=8;this.charsAcross=40;this.charsDown=25};DbgMemory.prototype={init:function(e){this.machine=e.machine;this.debugger=e.debugger;this.prefix=e.prefix;if(typeof e.maxAddress!="undefined"){this.maxAddress=e.maxAddress}var t=g_app.dbgFont;t.createFonts();this.fontCanvas=t.fontCanvas;this.hexNumberCanvas=t.hexNumberCanvas[0];this.cmdCanvas=t.cmdCanvas;this.setFontMetrics()},setFontMetrics:function(){var e=g_app.dbgFont;this.fontCharWidth=e.fontCharWidth;this.fontCharHeight=e.fontCharHeight;this.hexNumberPositions=e.hexNumberPositions;this.cmdPositions=e.cmdPositions;this.lineHeight=this.fontCharHeight+4*UI.devicePixelRatio},setBytesAcross:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.bytesAcross=e;this.forceRedraw()},setReport:function(e){this.labelMap={};var t=[];if(typeof e!="undefined"&&typeof e.memoryMap!="undefined"){t=e.memoryMap}if(t.length==0){$("#"+this.prefix+"DebuggerMemoryLabelSelect").hide()}else{var i="";i+='<option value="">Select Label</option>';for(var r=0;r<t.length;r++){this.labelMap[t[r].address]=t[r].label;i+='<option value="'+t[r].address+'">';i+=t[r].label;i+="</option>"}$("#"+this.prefix+"DebuggerMemoryLabelSelect").html(i);$("#"+this.prefix+"DebuggerMemoryLabelSelect").show()}},setVisible:function(e){this.visible=e},getVisible:function(){return this.visible},doClear:function(){this.clear=true;this.previousValues=[]},buildInterface:function(e){this.uiComponent=UI.create("UI.SplitPanel",{overflow:"unset"});e.add(this.uiComponent);var t="";t+='<div class="panelFill" style="background-color: #111111; z-index: 10000">';t+='<span class="debuggerMemoryInfoAddress" id="'+this.prefix+'DebuggerMemoryHoverAddress">0000</span>';t+='<span class="debuggerMemoryInfoValue" id="'+this.prefix+'DebuggerMemoryHoverValueDec">00</span>';t+='<span class="debuggerMemoryInfoValue" id="'+this.prefix+'DebuggerMemoryHoverValueHex">00</span>';t+='<span id="'+this.prefix+'DebuggerMemoryHoverValueBin">00000000</span>';t+='<span id="'+this.prefix+'DebuggerMemoryHoverLabel">00000000</span>';t+="</div>";this.infoPanel=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.addNorth(this.infoPanel,20,false);this.scrollCanvas=UI.create("UI.CanvasScrollPanel",{id:this.prefix+"MemoryCanvas"});this.uiComponent.add(this.scrollCanvas);var i="";i+='<div class="panelFill" style="background-color: black">';i+='<div style="margin: 2px 0">';i+="<label>Goto";i+='<input id="'+this.prefix+'DebuggerMemoryAddress" style="width: 80px">';i+="</label>";i+='<select style="display: none" id="'+this.prefix+'DebuggerMemoryLabelSelect">';i+="</select>";i+="<label> Bytes Across";i+='<input id="'+this.prefix+'DebuggerMemoryBytesAcross" style="width: 40px" value="8">';i+="</label>";i+="<label>";i+='<input type="checkbox" id="'+this.prefix+'DebuggerViewAsScreen"> View As Screen';i+="</label>";i+="</div>";i+="</div>";this.controlsPanel=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.addSouth(this.controlsPanel,30,false);var r=this;this.totalLines=Math.ceil(this.maxAddress/this.bytesAcross);this.contentHeight=this.totalLines*this.lineHeight;UI.on("ready",function(){r.initEvents()});this.scrollCanvas.setContentHeight(this.contentHeight);this.scrollCanvas.draw=function(e){r.draw(e)};this.scrollCanvas.on("resize",function(){r.doClear()});this.scrollCanvas.on("mousedown",function(e){r.mouseDown(e)});this.scrollCanvas.on("mousemove",function(e){r.mouseMove(e)});this.scrollCanvas.on("mouseup",function(e){r.mouseUp(e)});$("#"+this.prefix+"DebuggerMemoryLabelSelect").on("change",function(){if(e!=""){var e=parseInt($(this).val(),10);$("#"+r.prefix+"DebuggerMemoryAddress").val(e.toString(16));r.gotoAddress(e)}})},outputC64DebuggerMemoryControl:function(){var e=this.debugger.readByte(1);if(e!==this.cpuControlValue){var t=e&1;var i=e&2;var r=e&4;var a="";a+='<div style="margin-bottom: 4px; background-color: black">';a+="<div>";a+='<label title="BASIC ROM $A000-$BFFF banked in">LORAM</label>: ';if(t){a+="1"}else{a+="0"}a+="  ";a+='<label title="KERNAL ROM $E000-$FFFF banked in">HIRAM</label>: ';if(i){a+="1"}else{a+="0"}a+="  ";a+='<label title="Character generator ROM $D000-$DFFF banked in">CHAREN</label>: ';if(r){a+="1"}else{a+="0"}a+="</div>";a+="</div>";$("#"+this.prefix+"DebuggerMemoryControl").html(a);this.cpuControlValue=e}},mouseDown:function(e){var t=this.scrollCanvas.getElementId();var i=this.scrollCanvas.getScale();var r=e.pageX-$("#"+t).offset().left;var a=e.pageY-$("#"+t).offset().top;r=r*i;a=a*i},memoryValueNavKey:function(e){var t=e.keyCode;var i=e.shiftKey;var r=this.inputAddress;var a=r;switch(t){case 9:if(i){a--}else{a++}break;case 13:a++;break;case 37:a--;break;case 38:a-=this.bytesAcross;break;case 39:a++;break;case 40:a+=this.bytesAcross;break}if(a!==r){if(a>=0&&a<64*1024){e.preventDefault();this.editAddress(a)}}},editNextAddress:function(){this.editAddress(this.inputAddress+1)},editAddress:function(e){this.inputAddress=e;var t=this.debugger.readByte(e);t=t.toString(16);$("#"+this.prefix+"DebuggerMemoryValueInput").val(t);this.setInputPosition();$("#"+this.prefix+"DebuggerMemoryValueInput").show();$("#"+this.prefix+"DebuggerMemoryValueInput").focus();$("#"+this.prefix+"DebuggerMemoryValueInput").select()},setValueFromInput:function(e){this.debugger.writeByte(this.inputAddress,e)},setMouseCursorAddress:function(e){this.mouseCursorAddress=e;if(e===false){return}var t=("0000"+e.toString(16)).substr(-4);$("#"+this.prefix+"DebuggerMemoryHoverAddress").html(t);var i=this.debugger.readByte(e);t=("00"+i.toString(16)).substr(-2);$("#"+this.prefix+"DebuggerMemoryHoverValueHex").html(t);$("#"+this.prefix+"DebuggerMemoryHoverValueBin").html(i);t=("00000000"+i.toString(2)).substr(-8);$("#"+this.prefix+"DebuggerMemoryHoverValueBin").html(t);if(typeof this.labelMap[e]!="undefined"){$("#"+this.prefix+"DebuggerMemoryHoverLabel").html(this.labelMap[e])}else{$("#"+this.prefix+"DebuggerMemoryHoverLabel").html("")}},mouseMove:function(e){var t=this.scrollCanvas;var i=t.getElementId();var r=t.getScale();var a=t.getScrollY();var s=e.pageX-$("#"+i).offset().left;var o=e.pageY-$("#"+i).offset().top;if(this.drawMode=="screen"){s=Math.floor(s/this.charWidth);o=Math.floor(o/this.charHeight);var l=1024;if(this.enteredAddress!==false){l=this.enteredAddress}var n=l+o*this.charsAcross+s;this.setMouseCursorAddress(n)}else{s=s*r;o=o*r;var h=Math.floor((a+o)/this.lineHeight);var d=Math.floor((s-this.valuesStartX)/(this.fontCharWidth*2+this.valueSpacing));if(d>=0&&d<this.bytesAcross){var n=h*this.bytesAcross+d;this.setMouseCursorAddress(n)}else{this.setMouseCursorAddress(false)}}},mouseUp:function(e){if(this.drawMode=="screen"){return}else{if(this.mouseCursorAddress!==false){this.editAddress(this.mouseCursorAddress)}}},forceRedraw:function(){if(this.scrollCanvas){this.scrollCanvas.resize()}this.lastWidth=false;this.lastHeight=false},createImageData:function(e){var t=320;var i=200;this.screenCanvas=document.createElement("canvas");this.screenCanvas.width=t;this.screenCanvas.height=i;this.screenContext=UI.getContextNoSmoothing(this.screenCanvas);this.screenImageData=e.createImageData(t,i)},readCharset:function(){var e=[];for(var t=0;t<64;t++){e[t]=c64_vicReadRegister(t)}var i=(e[24]&14)<<10;var r=false;r=c64_cpuReadNS(56576);var a=false;var s=0;switch(r&3){case 0:s=49152;break;case 1:s=32768;if(i==4096){a=true}break;case 2:s=16384;break;case 3:s=0;if(i==4096){a=true}break}for(var t=0;t<2048;t++){this.charData[t]=c64_vicReadAbsolute(s+i+t)}},drawScreen:function(e){if(this.screenImageData==null){this.createImageData(e)}e.imageSmoothingEnabled=false;e.webkitImageSmoothingEnabled=false;e.mozImageSmoothingEnabled=false;e.msImageSmoothingEnabled=false;e.oImageSmoothingEnabled=false;var t=this.scrollCanvas;var i=t.getWidth();var r=t.getHeight();e.fillStyle="#111111";e.fillRect(0,0,i,r);var a=1024;if(this.enteredAddress!==false){a=this.enteredAddress}this.readCharset();var s=255;var o=255;var l=255;var n=0;var h=0;var d=0;var c=a;var f=this.charsAcross;var u=this.charsDown;for(var p=0;p<u;p++){for(var v=0;v<f;v++){var g=(p*f*8+v)*8*4;var m=this.debugger.readByte(c)*8;for(var y=0;y<8;y++){var b=this.charData[m+y];for(var C=0;C<8;C++){var x=g+C*4;if(b&1<<7-C){this.screenImageData.data[x]=s;this.screenImageData.data[x+1]=o;this.screenImageData.data[x+2]=l;this.screenImageData.data[x+3]=255}else{this.screenImageData.data[x]=n;this.screenImageData.data[x+1]=h;this.screenImageData.data[x+2]=d;this.screenImageData.data[x+3]=255}}g+=this.screenImageData.width*4}c++}}var S=0;this.screenContext.putImageData(this.screenImageData,0,0);e.drawImage(this.screenCanvas,0,0,i,r,0,0,i*this.screenScale,r*this.screenScale);var P=this.charWidth;var w=this.charHeight;e.strokeStyle="#999";e.lineWidth=1;e.beginPath();for(v=0;v<f;v++){e.moveTo(v*P*this.screenScale+.5,S);e.lineTo(v*P*this.screenScale+.5,S+w*u*this.screenScale)}e.stroke();e.beginPath();for(p=0;p<u;p++){e.moveTo(0,S+p*w*this.screenScale+.5);e.lineTo(f*P*this.screenScale,S+p*w*this.screenScale+.5)}e.stroke()},draw:function(e){if(this.drawMode=="screen"){this.drawScreen(e);return}this.setFontMetrics();this.addressStartX=10;this.valuesStartX=this.addressStartX+5*this.fontCharWidth;this.valueSpacing=this.fontCharWidth;this.outputC64DebuggerMemoryControl();var t=this.scrollCanvas;var i=t.getWidth();var r=t.getHeight();var a=t.getScrollY();if(a!==this.lastScrollY||i!==this.lastWidth||r!==this.lastHeight||this.mouseCursorAddress!=this.highlightedMouseCursorAddress){this.lastScrollY=a;this.lastWidth=i;this.lastHeight=r;this.doClear();e.fillStyle="#000000";e.fillRect(0,0,i,r);this.setInputPosition()}e.fillStyle="#444444";var s=this.fontCharWidth;var o=this.fontCharHeight;var l=0;var n=0;var h=s;var d=o;var c=0;var f=0;var u=s;var p=o;var v=Math.ceil(r/this.lineHeight)+1;var g=Math.floor(a/this.lineHeight)*this.bytesAcross;f=-(a%this.lineHeight);var m=g;var y=0;var b=0;var C=false;n=0;h=s;d=o;u=s;p=o;var x=0;for(var S=0;S<v;S++){var c=this.addressStartX;if(this.clear&&m>=0&&m<this.maxAddress){var P=m>>8&255;var w=m&255;var I=this.hexNumberPositions[P];l=I.x;n=I.y;e.globalAlpha=.5;e.drawImage(this.hexNumberCanvas,l,n,h*2,d,c,f,u*2,p);c+=u*2;var I=this.hexNumberPositions[w];l=I.x;n=I.y;e.drawImage(this.hexNumberCanvas,l,n,h*2,d,c,f,u*2,p);e.globalAlpha=1;c+=u*2}c=this.valuesStartX;for(var k=0;k<this.bytesAcross;k++){if(m<this.maxAddress){var M=this.debugger.readByte(m);if(typeof M=="undefined"){console.log(m)}if(x>=this.previousValues.length||this.previousValues[x]!==M){this.previousValues[x]=M;var I=this.hexNumberPositions[M];l=I.x;n=I.y;e.drawImage(this.hexNumberCanvas,l,n,h*2,d,c,f,u*2,p)}c+=u*2+this.valueSpacing}x++;m++}f+=this.lineHeight}if(this.enteredAddress!==false){var T=this.addressToXY(this.enteredAddress);e.beginPath();e.strokeStyle="#a3a8cc";e.rect(T.x-1.5,T.y-1.5-a,this.fontCharWidth*2+2,this.fontCharHeight+2);e.stroke()}if(this.mouseCursorAddress!==this.highlightedMouseCursorAddress&&this.mouseInCanvas){if(this.mouseCursorAddress!==false){var T=this.addressToXY(this.mouseCursorAddress);e.beginPath();e.strokeStyle="#cccccc";e.rect(T.x-1.5,T.y-1.5-a,this.fontCharWidth*2+2,this.fontCharHeight+2);e.stroke();var D="$"+("0000"+this.mouseCursorAddress.toString(16)).substr(-4);var E=T.x;var $=T.y-20-a;var _=50;var B=14;e.fillStyle="#222222";e.fillRect(E-1,$-1,_+2,B+4);e.font="14px Verdana";e.fillStyle="#accaff";e.fillText(D,E,$+12)}this.highlightedMouseCursorAddress=this.mouseCursorAddress}this.clear=false},addressToXY:function(e){var t=Math.floor(e/this.bytesAcross);var i=e%this.bytesAcross;var r=this.valuesStartX+i*(this.fontCharWidth*2+this.valueSpacing);var a=t*this.lineHeight;return{x:r,y:a}},gotoAddress:function(e){this.enteredAddress=parseInt(e,10);var t=Math.floor(e/this.bytesAcross);var i=t*this.lineHeight-8;if(i<0){i=0}this.scrollCanvas.setScrollY(i)},setInputPosition:function(){var e=this.scrollCanvas.getScrollY();var t=this.scrollCanvas.getScale();var i=this.addressToXY(this.inputAddress);var r=i.x/t;var a=(i.y-e)/t-1;$("#"+this.prefix+"DebuggerMemoryValueInput").css("left",r);$("#"+this.prefix+"DebuggerMemoryValueInput").css("top",a+"px")},initEvents:function(){var r=this;$("#"+this.prefix+"DebuggerMemoryAddress").on("focus",function(){r.debugger.blurMachine()});$("#"+this.prefix+"DebuggerMemoryAddress").on("blur",function(){});$("#"+this.prefix+"DebuggerMemoryAddress").on("change",function(e){var t=parseInt($(this).val(),16);if(isNaN(t)){return}r.gotoAddress(t)});$("#"+this.prefix+"DebuggerMemoryAddress").on("keyup",function(e){var t=parseInt($(this).val(),16);if(isNaN(t)){return}r.gotoAddress(t)});$("#"+this.prefix+"DebuggerMemoryBytesAcross").on("focus",function(e){r.debugger.blurMachine()});$("#"+this.prefix+"DebuggerMemoryBytesAcross").on("blur",function(e){});$("#"+this.prefix+"DebuggerMemoryBytesAcross").on("change",function(e){var t=parseInt($(this).val(),10);if(isNaN(t)){return}r.setBytesAcross(t)});$("#"+this.prefix+"DebuggerMemoryBytesAcross").on("keyup",function(e){var t=parseInt($(this).val(),10);if(isNaN(t)){return}r.setBytesAcross(t)});$("#"+this.prefix+"DebuggerViewAsScreen").on("click",function(e){if($(this).is(":checked")){r.drawMode="screen"}else{r.drawMode="memory"}r.forceRedraw()});var e=this.scrollCanvas.getScale();this.addressStartX=6*e;this.valuesStartX=this.addressStartX+6*this.fontCharWidth;this.valueSpacing=4*e;var t=this.fontCharWidth*2/e;var i=this.fontCharHeight/e+2;var a="font: 12px 'Courier New', Courier, monospace;";var s='<input class="'+this.prefix+'DebuggerInput" type="text" spellcheck="false" maxlength="2" id="'+this.prefix+'DebuggerMemoryValueInput" type="text" style="'+a+"position: absolute; top: 30px; left: 30px; border: 0;";s+="padding: 0; display: none; width: "+t+"px; height: "+i+'px"/>';var o=$("#"+this.scrollCanvas.getElementId());var l=o.parent();l.append(s);o.on("mouseenter",function(e){r.mouseInCanvas=true});o.on("mouseleave",function(e){r.mouseInCanvas=false});$("#"+this.prefix+"DebuggerMemoryValueInput").on("focus",function(){r.debugger.blurMachine()});$("#"+this.prefix+"DebuggerMemoryValueInput").on("blur",function(){r.hideValueInput()});$("#"+this.prefix+"DebuggerMemoryValueInput").on("change",function(e){var t=parseInt($(this).val(),16);if(isNaN(t)){return}r.setValueFromInput(t)});$("#"+this.prefix+"DebuggerMemoryValueInput").on("keypress",function(e){var t=e.keyCode;var i="[0-9a-fA-F]";if(t!=null&&t!=0&&t!=8&&t!=9&&t!=13&&t!=27){var r=new RegExp(i);var a=String.fromCharCode(t);if(!a.match(r)){e.preventDefault();return false}}});$("#"+this.prefix+"DebuggerMemoryValueInput").on("keydown",function(e){var t=$(this).val();r.keydownValueAddress=r.inputAddress;r.keydownValueLength=t.length;var i=e.keyCode;if(i==13||i==9||i>=37&&i<=40){e.preventDefault()}});$("#"+this.prefix+"DebuggerMemoryValueInput").on("keyup",function(e){var t=e.keyCode;if(e.key=="Escape"){console.log("ESCAPE!!!!!!")}if(t==13||t==9||t>=37&&t<=40){r.memoryValueNavKey(e);return}var i=$(this).val();r.keyupValueAddress=r.inputAddress;r.keyupValueLength=i.length;i=parseInt(i,16);if(isNaN(i)){return}r.setValueFromInput(i);if(r.keyupValueAddress==r.keydownValueAddress&&r.keydownValueLength!=r.keyupValueLength&&r.keyupValueLength==2){r.editNextAddress()}})},hideValueInput:function(){$("#"+this.prefix+"DebuggerMemoryValueInput").hide();this.debugger.focusMachine()},update:function(){if(this.visible){this.scrollCanvas.render()}}};var DbgScripting=function(){this.codeEditor=null;this.doc=null;this.scriptProcessor=null;this.prefix="dbg";this.editorElementId="";this.outputElementId=""};DbgScripting.prototype={init:function(e){if(typeof e.prefix){this.prefix=e.prefix}this.outputElementId=this.prefix+"DebuggerScriptingOutput";if(c64.scripting==null){c64.scripting=new C64Scripting;c64.scripting.init()}this.scriptProcessor=c64.scripting.scriptProcessor},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.SplitPanel",{overflow:"unset"});e.add(this.uiComponent);var i="";i+='<div class="panelFill">';i+='<div id="'+this.prefix+'ScriptingButtonPanel" style="position:absolute; top: 0px; left:0px; right:0px; height:26px; padding: 4px">';i+='  <div class="ui-button" id="'+this.prefix+'ScriptingRun"><i class="halflings halflings-play"></i> Run Script</div>';i+="</div>";i+='  <div style="overflow: auto; position:absolute; top: 26px; left:0px;right:0px;height: 24px">';i+='  <div class="ui-button" id="'+this.prefix+'ScriptingClearConsole">Clear</div>';i+="  </div>";i+='  <div style="overflow: auto; position:absolute; top: 50px; left:0px;right:0px;bottom:0px" id="'+this.outputElementId+'">';i+="  </div>";i+="</div>";this.controlsPanel=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.addSouth(this.controlsPanel,120,true);var r=UI.create("UI.Panel");this.uiComponent.add(r);this.codeEditor=new CodeEditor;this.codeEditor.init("javascript");this.codeEditor.buildInterface(r);this.codeEditor.on("change",function(e){t.codeEditorChange()});UI.on("ready",function(){t.initEvents()})},initEvents:function(){var r=this;$("#"+this.prefix+"ScriptingRun").on("click",function(){console.log("scripting run click!");r.run()});$("#"+this.prefix+"ScriptingClearConsole").on("click",function(){r.clearConsole()});$("#"+this.outputElementId).on("click",".scriptingOutputLine",function(){var e=$(this).attr("data-id");var t=$(this).attr("type");var i=$(this).attr("data-line");$(".scriptingOutputLine").css("background-color","transparent");$(".scriptingOutputLine").css("color","#eeeeee");$(this).css("background-color","#4586dd");$(this).css("color","#ffffff");if(typeof i!="undefined"){i=parseInt(i,10);if(!isNaN(i)){r.codeEditor.gotoLine(i,0,false)}}})},run:function(){console.log("run!"+this.prefix);if(this.scriptProcessor.getIsRunning()){this.scriptProcessor.stopScript()}else{var e="";this.path="/scripts/c64.js";var t=g_app.doc.getDocRecord(this.path);if(t!=null&&t.data!=""){e=t.data}else{e=this.codeEditor.getValue()}var i=[];this.scriptProcessor.runScripts([{content:e,filePath:"c64scripting"}])}},clearConsole:function(){$("#"+this.outputElementId).html("")},show:function(){this.path="/scripts/c64.js";var e=g_app.doc.getDocRecord(this.path);if(e==null){var t=g_app.doc.getDocRecord("/scripts");if(t){g_app.doc.createDocRecord("/scripts","c64.js","script","");e=g_app.doc.getDocRecord(this.path)}}if(e!=null){if(e.data==""){e.data=sampleC64DebuggerScript}this.codeEditor.setValue(e.data);this.doc=e}var i=this;this.scriptProcessor.on("start",function(){$("#"+i.prefix+"ScriptingButtonPanel").css("background-color","#222222");$("#"+i.prefix+"ScriptingRun").html('<i class="halflings halflings-stop"></i> Stop Script');$("#"+i.prefix+"ScriptingRun").addClass("ui-button-info")});this.scriptProcessor.on("end",function(){$("#"+i.prefix+"ScriptingButtonPanel").css("background-color","#111111");$("#"+i.prefix+"ScriptingRun").html('<i class="halflings halflings-play"></i> Start Script');$("#"+i.prefix+"ScriptingRun").removeClass("ui-button-info")});this.scriptProcessor.setOutputElementId(this.outputElementId)},codeEditorChange:function(){if(this.doc!=null){this.doc.data=this.codeEditor.getValue()}}};function isNumeric(e){return/^-?\d+$/.test(e)}var DbgC64Basic=function(){this.codeEditor=null;this.doc=null;this.basicTokeniser=new BasicTokeniser;this.prefix="dbg";this.editorElementId="";this.outputElementId="";this.bastext=["null","ct a","ct b","ct c","ct d","white","ct f","ct g","ct h","ct i","ct j","ct k","ct l","return","ct n","ct o","ct p","down","reverse on","home","delete","ct u","ct v","ct w","ct x","ct y","ct z","027","red","right","green","blue"," ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","[","pound","]","^","arrow left","096","097","098","099","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","orange","130","131","132","f1","f3","f5","f7","f2","f4","f6","f8","141","142","143","black","up","reverse off","clear","148","brown","pink","dark gray","gray","light green","light blue","light gray","156","left","yellow","cyan","sh space","cm k","cm i","cm t","cm @","cm g","cm +","cm m","cm pound","sh pound","cm n","cm q","cm d","cm z","cm s","cm p","cm a","cm e","cm r","cm w","cm h","cm j","cm l","cm y","cm u","cm o","sh @","cm f","cm c","cm x","cm v","cm b","sh asterisk","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","sh +","cm -","sh -","222","cm asterisk","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","pi"];this.petcat=["null","ctrl-a","ctrl-b","stop","ctrl-d","wht","ctrl-f","ctrl-g","dish","ensh","$0a","ctrl-k","\\f","\\n","swlc","ctrl-o","ctrl-p","down","rvon","home","del","ctrl-u","ctrl-v","ctrl-w","ctrl-x","ctrl-y","ctrl-z","esc","red","rght","grn","blu","space","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","[","\\","]","^","arrow left","$60","$61","$62","$63","$64","$65","$66","$67","$68","$69","$6a","$6b","$6c","$6d","$6e","$6f","$70","$71","$72","$73","$74","$75","$76","$77","$78","$79","$7a","$7b","$7c","$7d","$7e","$7f","$80","orng","$82","$83","$84","f1","f3","f5","f7","f2","f4","f6","f8","stret","swuc","$8f","blk","up","rvof","clr","inst","brn","lred","gry1","gry2","lgrn","lblu","gry3","pur","left","yel","cyn","$a0","cbm-k","cbm-i","cbm-t","cbm-@","cbm-g","cbm-+","cbm-m","cbm-pound","shift-pound","cbm-n","cbm-q","cbm-d","cbm-z","cbm-s","cbm-p","cbm-a","cbm-e","cbm-r","cbm-w","cbm-h","cbm-j","cbm-l","cbm-y","cbm-u","cbm-o","shift-@","cbm-f","cbm-c","cbm-x","cbm-v","cbm-b","shift-*","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","shift-+","cbm--","shift--","{$de}","cbm-*","$e0","$e1","$e2","$e3","$e4","$e5","$e6","$e7","$e8","$e9","$ea","$eb","$ec","$ed","$ee","$ef","$f0","$f1","$f2","$f3","$f4","$f5","$f6","$f7","$f8","$f9","$fa","$fb","$fc","$fd","$fe","$ff"];this.c64list=["null","$01","$02","stop","$04","white","$06","$07","altdis","altena","$0a","$0b","$0c","$0d","lower","$0f","$10","down","rvrs on","home","backspace","$15","$16","$17","$18","$19","$1a","$1b","red","right","green","blue","space","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","[","pound","]","up arrow","back arrow","$60","$61","$62","$63","$64","$65","$66","$67","$68","$69","$6a","$6b","$6c","$6d","$6e","$6f","$70","$71","$72","$73","$74","$75","$76","$77","$78","$79","$7a","$7b","$7c","$7d","$7e","$7f","$80","orange","$82","$83","$84","f1","f3","f5","f7","f2","f4","f6","f8","shft ret","upper","$8f","black","up","rvrs off","clear","insert","brown","lt. red","gray1","gray2","lt. green","lt. blue","gray3","purple","left","yellow","cyan","$a0","$a1","$a2","$a3","$a4","$a5","$a6","$a7","shft pound","ctrl pound","$aa","$ab","$ac","$ad","$ae","$af","$b0","$b1","$b2","$b3","$b4","$b5","$b6","$b7","$b8","$b9","$ba","$bb","$bc","$bd","$be","$bf","$c0","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","$db","$dc","$dd","$de","$df","$e0","$e1","$e2","$e3","$e4","$e5","$e6","$e7","$e8","$e9","$ea","$eb","$ec","$ed","$ee","$ef","$f0","$f1","$f2","$f3","$f4","$f5","$f6","$f7","$f8","$f9","$fa","$fb","$fc","$fd","$fe","$ff"]};var sampleC64BasicScript='10 print "hello"\n20 goto 10\n';DbgC64Basic.prototype={init:function(e){if(typeof e.prefix){this.prefix=e.prefix}},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.SplitPanel",{overflow:"unset"});e.add(this.uiComponent);var i="";i+='<div class="panelFill">';i+='<div id="'+this.prefix+'BasicButtonPanel" style="position:absolute; overflow: hidden; white-space: nowrap; top: 0px; left:0px; right:0px; height:26px; padding: 4px">';i+='  <div style="margin-right: 6px" class="ui-button ui-button-primary" id="'+this.prefix+'BasicRun"><i class="halflings halflings-play"></i> RUN (F5)</div>';i+='  <div style="margin-right: 6px" class="ui-button" id="'+this.prefix+'BasicStop"><i class="halflings halflings-stop"></i> STOP</div>';i+='  <div style="margin-right: 6px" class="ui-button" id="'+this.prefix+'BasicDownload"><img src="icons/svg/glyphicons-basic-199-save.svg"> Download PRG</div>';i+='  <div style="margin-right: 6px" class="ui-button" id="'+this.prefix+'BasicShare"><img src="icons/material/share-24px.svg">&nbsp;Share</div>';i+="</div>";i+='<div style="position: absolute; top: 34px; left: 2px; right: 0; height: 64px">';i+='<div style="margin: 4px 0"><label style="" class="cb-container">BASIC is in Uppercase  <input type="checkbox" id="'+this.prefix+'BasicUppercase" value="1"><span class="checkmark"></span></label></div>';i+="<div>";i+='<div style="margin: 4px 0">Bas Text, petcat and C64List PETSCII codes can be used</div>';i+='<div style="margin: 4px 0"><a href="https://www.c64-wiki.com/wiki/PETSCII_Codes_in_Listings" target="_blank">PETSCII BASIC Codes</a></div>';i+="</div>";i+="</div>";i+="</div>";this.controlsPanel=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.addSouth(this.controlsPanel,120,true);var r=UI.create("UI.Panel");this.uiComponent.add(r);this.codeEditor=new CodeEditor;this.codeEditor.init("c64basic");this.codeEditor.on("run",function(){t.run()});this.codeEditor.buildInterface(r);this.codeEditor.on("change",function(e){t.codeEditorChange()});UI.on("ready",function(){t.initEvents()})},binaryToData:function(e){var t=document.getElementById("binaryToDataFile").files[0];var i=new FileReader;i.onload=function(e){var t=new Uint8Array(e.target.result);var i="";var r=800;for(var a=0;a<t.length-2;a++){if(a%8==0){i+="\n";r+=10;i+=r+" DATA "}else{i+=","}i+=t[a+2]}i+="\n"};i.readAsArrayBuffer(t)},initEvents:function(){var e=this;$("#"+this.prefix+"BasicRun").on("click",function(){e.run()});$("#"+this.prefix+"BasicStop").on("click",function(){e.stop()});$("#"+this.prefix+"BasicDownload").on("click",function(){e.download()});$("#"+this.prefix+"BasicShare").on("click",function(){if(g_app.c64Debugger){g_app.c64Debugger.share({type:"basic"})}})},shiftCode:function(e){switch(e.toLowerCase()){case"@":return 186;break;case"asterisk":return 99;break;case"pound":return 169;break}if(e.length==1){return e.toUpperCase().charCodeAt(0)}return""},cbmCode:function(e){var t=false;switch(e.toLowerCase()){case"asterisk":return 127;break;case"pound":return 162;break;case"a":t=112+64;break;case"b":t=127+64;break;case"c":t=124+64;break;case"d":t=108+64;break;case"e":t=113+64;break;case"f":t=123+64;break;case"g":t=101+64;break;case"h":t=116+64;break;case"i":t=98+64;break;case"j":t=117+64;break;case"k":t=97+64;break;case"l":t=118+64;break;case"m":t=103+64;break;case"n":t=106+64;break;case"o":t=121+64;break;case"p":t=111+64;break;case"q":t=107+64;break;case"r":t=114+64;break;case"s":t=110+64;break;case"t":t=99+64;break;case"u":t=120+64;break;case"v":t=126+64;break;case"w":t=115+64;break;case"x":t=125+64;break;case"y":t=119+64;break;case"z":t=109+64;break}return t},setBAS:function(e){this.path="/scripts/c64.bas";var t=g_app.doc.getDocRecord(this.path);if(t){t.data=e}this.codeEditor.setValue(e)},download:function(){var e=$("#c64preBasicUppercase").is(":checked");var t="";this.path="/scripts/c64.bas";var i=g_app.doc.getDocRecord(this.path);if(i&&i.data!=""){t=i.data}else{t=this.codeEditor.getValue()}var r=this.basicTokeniser.tokenise({script:t,inUppercase:e});download(r,"basic.prg","application/prg")},run:function(){var e=$("#c64preBasicUppercase").is(":checked");var t="";this.path="/scripts/c64.bas";var i=g_app.doc.getDocRecord(this.path);if(i&&i.data!=""){t=i.data}else{t=this.codeEditor.getValue()}var r=this.basicTokeniser.tokenise({script:t,inUppercase:e});if(g_app.c64Debugger){this.codeEditor.blur();g_app.c64Debugger.focusMachine();g_app.c64Debugger.startPRG(r,true)}return;c64_reset();var a=t;if(e){a+="\nRUN\n"}else{a+="\nrun\n"}var s=[];a=a.split("\r\n").join("\n");for(var o=0;o<a.length;o++){var l=a[o];var n=l;if(l=="{"){o++;n="";while(o<a.length&&a[o]!="}"){n+=a[o];o++}}if(l!=n){var h=false;var d=1;var c=n.indexOf("*");if(c!=-1){d=n.substr(c+1);console.log("multiplier = "+d);d=parseInt(d,10);if(isNaN(d)){d=1}n=n.substr(0,c).trim()}for(var f=0;f<this.bastext.length;f++){if(this.bastext[f]==n){h=f;break}}console.log("bastext code = "+h);if(h===false){var u=n.toLowerCase();for(var f=0;f<this.petcat.length;f++){if(this.petcat[f]==u){h=f;break}}console.log("petcat code = "+h)}if(h===false){var u=n.toLowerCase();for(var f=0;f<this.c64list.length;f++){if(this.c64list[f]==u){h=f;break}}console.log("c64list code = "+h)}if(h===false){var p=n.toLowerCase();if(isNumeric(n)){h=parseInt(n)}else if(p.indexOf("shift")==0){n=n.substring("SHIFT-".length);h=n.toUpperCase().charCodeAt(0)+32;h=this.shiftCode(n)}else if(p.indexOf("sh ")==0){n=n.substring("sh ".length);h=this.shiftCode(n)}else if(p.indexOf("cbm")==0){n=n.substring("CBM-".length);h=this.cbmCode(n)}else if(p.indexOf("cm ")==0){n=n.substring("cm ".length);h=this.cbmCode(n)}else{n=n.toLowerCase();switch(n){case"blk":case"black":h=144;break;case"wht":case"white":h=5;break;case"red":case"red":h=28;break;case"cyn":case"cyan":h=159;break;case"pur":case"purple":h=156;break;case"grn":case"green":h=153;break;case"blu":case"blue":h=31;break;case"yel":case"yellow":h=158;break;case"orng":case"orange":h=129;break;case"brn":case"brown":h=149;break;case"lred":case"pink":case"lightred":case"light red":h=150;break;case"lgrn":case"lightgreen":case"light green":h=153;break;case"lblu":case"light blue":case"lightblue":h=154;break;case"dark gray":case"gry1":case"grey 1":case"grey1":h=151;break;case"medium gray":case"gry2":case"grey2":case"grey 2":h=152;break;case"light gray":case"gry3":case"grey3":case"grey 3":h=155;break;case"rvon":case"reverse on":case"rvs on":h=18;break;case"rvof":case"rvs off":case"reverse off":h=146;break;case"clr":case"clear":h=147;break;case"home":h=19;break;case"inst":h=148;break;case"del":h=20;break;case"up":h=145;break;case"down":h=17;break;case"left":h=157;break;case"rght":case"right":h=29;break}}}if(h!==false){for(var v=0;v<d;v++){s.push(h)}}console.log("symbols = ");console.log(s)}else{var h=false;if(e){h=l.charCodeAt(0)}else{if(l==l.toLowerCase()){l=l.toUpperCase();h=l.charCodeAt(0)}else{h=l.charCodeAt(0)+32}}switch(h){case 10:s.push(157);h=13;break}s.push(h)}}c64.insertScreenCodes(s);if(g_app.c64Debugger){g_app.c64Debugger.focusMachine()}},stop:function(){c64_keyPressed(C64_KEY_RUN_STOP);setTimeout(function(){c64_keyReleased(C64_KEY_RUN_STOP)},100)},show:function(){this.path="/scripts/c64.bas";var e=g_app.doc.getDocRecord(this.path);if(e==null){var t=g_app.doc.getDocRecord("/scripts");if(t){g_app.doc.createDocRecord("/scripts","c64.bas","script","");e=g_app.doc.getDocRecord(this.path)}}if(e!=null){if(e.data==""){e.data=sampleC64BasicScript}this.codeEditor.setValue(e.data);this.doc=e}},codeEditorChange:function(){if(this.doc!=null){this.doc.data=this.codeEditor.getValue()}}};var BasicTokeniser=function(){this.tokens=["end","for","next","data","input#","input","dim","read","let","goto","run","if","restore","gosub","return","rem","stop","on","wait","load","save","verify","def","poke","print#","print","cont","list","clr","cmd","sys","open","close","get","new","tab(","to","fn","spc(","then","not","step","+","-","*","/","^","and","or",">","=","<","sgn","int","abs","usr","fre","pos","sqr","rnd","log","exp","cos","sin","tan","atn","peek","len","str$","val","asc","chr$","left$","right$","mid$",""];this.abbreviations=["eN","fO","nE","dA","iN","","dI","rE","lE","gO","rU","","reS","goS","reT","","sT","","wA","lO","sA","vE","dE","pO","pR","?","cO","lI","cL","cM","sY","oP","clO","gE","","tA","","","sP","tH","nO","stE","","","","","","aN","","","","","sG","","aB","uS","fR","","sQ","rN","","eX","","sI","","aT","pE","","stR","vA","aS","cH","leF","rI","mI",""];this.bastext=["null","ct a","ct b","ct c","ct d","white","ct f","ct g","ct h","ct i","ct j","ct k","ct l","return","ct n","ct o","ct p","down","reverse on","home","delete","ct u","ct v","ct w","ct x","ct y","ct z","027","red","right","green","blue"," ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","[","pound","]","^","arrow left","096","097","098","099","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","orange","130","131","132","f1","f3","f5","f7","f2","f4","f6","f8","141","142","143","black","up","reverse off","clear","148","brown","pink","dark gray","gray","light green","light blue","light gray","purple","left","yellow","cyan","sh space","cm k","cm i","cm t","cm @","cm g","cm +","cm m","cm pound","sh pound","cm n","cm q","cm d","cm z","cm s","cm p","cm a","cm e","cm r","cm w","cm h","cm j","cm l","cm y","cm u","cm o","sh @","cm f","cm c","cm x","cm v","cm b","sh asterisk","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","sh +","cm -","sh -","222","cm asterisk","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","pi"];this.petcat=["null","ctrl-a","ctrl-b","stop","ctrl-d","wht","ctrl-f","ctrl-g","dish","ensh","$0a","ctrl-k","\\f","\\n","swlc","ctrl-o","ctrl-p","down","rvon","home","del","ctrl-u","ctrl-v","ctrl-w","ctrl-x","ctrl-y","ctrl-z","esc","red","rght","grn","blu","space","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","[","\\","]","^","arrow left","$60","$61","$62","$63","$64","$65","$66","$67","$68","$69","$6a","$6b","$6c","$6d","$6e","$6f","$70","$71","$72","$73","$74","$75","$76","$77","$78","$79","$7a","$7b","$7c","$7d","$7e","$7f","$80","orng","$82","$83","$84","f1","f3","f5","f7","f2","f4","f6","f8","stret","swuc","$8f","blk","up","rvof","clr","inst","brn","lred","gry1","gry2","lgrn","lblu","gry3","pur","left","yel","cyn","$a0","cbm-k","cbm-i","cbm-t","cbm-@","cbm-g","cbm-+","cbm-m","cbm-pound","shift-pound","cbm-n","cbm-q","cbm-d","cbm-z","cbm-s","cbm-p","cbm-a","cbm-e","cbm-r","cbm-w","cbm-h","cbm-j","cbm-l","cbm-y","cbm-u","cbm-o","shift-@","cbm-f","cbm-c","cbm-x","cbm-v","cbm-b","shift-*","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","shift-+","cbm--","shift--","{$de}","cbm-*","$e0","$e1","$e2","$e3","$e4","$e5","$e6","$e7","$e8","$e9","$ea","$eb","$ec","$ed","$ee","$ef","$f0","$f1","$f2","$f3","$f4","$f5","$f6","$f7","$f8","$f9","$fa","$fb","$fc","$fd","$fe","$ff"];this.c64list=["null","$01","$02","stop","$04","white","$06","$07","altdis","altena","$0a","$0b","$0c","$0d","lower","$0f","$10","down","rvrs on","home","backspace","$15","$16","$17","$18","$19","$1a","$1b","red","right","green","blue","space","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","[","pound","]","up arrow","back arrow","$60","$61","$62","$63","$64","$65","$66","$67","$68","$69","$6a","$6b","$6c","$6d","$6e","$6f","$70","$71","$72","$73","$74","$75","$76","$77","$78","$79","$7a","$7b","$7c","$7d","$7e","$7f","$80","orange","$82","$83","$84","f1","f3","f5","f7","f2","f4","f6","f8","shft ret","upper","$8f","black","up","rvrs off","clear","insert","brown","lt. red","gray1","gray2","lt. green","lt. blue","gray3","purple","left","yellow","cyan","$a0","$a1","$a2","$a3","$a4","$a5","$a6","$a7","shft pound","ctrl pound","$aa","$ab","$ac","$ad","$ae","$af","$b0","$b1","$b2","$b3","$b4","$b5","$b6","$b7","$b8","$b9","$ba","$bb","$bc","$bd","$be","$bf","$c0","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","$db","$dc","$dd","$de","$df","$e0","$e1","$e2","$e3","$e4","$e5","$e6","$e7","$e8","$e9","$ea","$eb","$ec","$ed","$ee","$ef","$f0","$f1","$f2","$f3","$f4","$f5","$f6","$f7","$f8","$f9","$fa","$fb","$fc","$fd","$fe","$ff"];this.prg=[];this.currentLine="";this.inQuotes=false;this.inRemark=false;this.removeSpaces=false;this.inUppercase=false;this.repeat=1};BasicTokeniser.prototype={asciiToPetscii:function(e){var t=false;if(e==e.toLowerCase()){e=e.toUpperCase();t=e.charCodeAt(0)}else{t=e.charCodeAt(0)+32}return t},nextToken:function(){this.repeat=1;if(this.removeSpaces){this.currentLine=this.currentLine.trim()}if(this.currentLine.length==0){return false}if(!this.inQuotes&&!this.inRemark){for(var e=0;e<this.tokens.length;e++){if(this.tokens[e]!=""&&this.currentLine.startsWith(this.tokens[e])){var t=this.tokens[e].length;this.currentLine=this.currentLine.substr(t);return e+128}}for(var e=0;e<this.abbreviations.length;e++){if(this.abbreviations[e]!=""&&this.currentLine.startsWith(this.abbreviations[e])){var t=this.abbreviations[e].length;this.currentLine=this.currentLine.substr(t);return e+128}}}var i=this.currentLine[0];this.currentLine=this.currentLine.substr(1);if(i=="{"){var r=0;var a="";while((i=this.currentLine[r++])!="}"){a+=i}this.currentLine=this.currentLine.substr(r);r=a.indexOf("*");if(r!=-1){var s=a.substr(r+1).trim();s=parseInt(s,10);if(!isNaN(s)){this.repeat=s}a=a.substr(0,r).trim()}for(var e=0;e<this.bastext.length;e++){if(this.bastext[e]==a){var o=this.bastext[e].length;return e}}for(var e=0;e<this.petcat.length;e++){if(this.petcat[e]==a){var o=this.petcat[e].length;return e}}for(var e=0;e<this.c64list.length;e++){if(this.c64list[e]==a){var o=this.c64list[e].length;return e}}for(var e=0;e<256;e++){var l=e.toString(10);if(a==l){var o=l.length;return e}}for(var e=0;e<100;e++){var l="0"+e.toString(10);if(a==l){var o=l.length;return e}}for(var e=0;e<10;e++){var l="00"+e.toString(10)+"}";if(a==l){var o=l.length;return e}}}var n=this.asciiToPetscii(i);if(i=='"'){this.inQuotes=!this.inQuotes}return n},tokeniseLine:function(e){var t=[];this.currentLine=e.trim();if(this.currentLine==""){return t}this.inQuotes=false;this.inRemark=false;var i=0;var r=/^\d+$/;var a=this.currentLine[i++];var s="";while(r.test(a)){s+=a.toString();a=this.currentLine[i++]}i=s.length;s=parseInt(s,10);t.push(s&255);t.push(s>>8&255);this.currentLine=this.currentLine.substr(i).trim();while((token=this.nextToken())!==false){for(var o=0;o<this.repeat;o++){t.push(token)}}t.push(0);return t},tokenise:function(e){this.prg=[];var t=e.script;this.inUppercase=e.inUppercase;if(this.inUppercase){t=t.toLowerCase()}var i=2049;this.prg.push(i&255);this.prg.push(i>>8&255);var r=t.split("\n");for(var a=0;a<r.length;a++){var s=r[a].replace("\r","").trim();if(s!=""){this.tokeniseLine(s);var o=this.tokeniseLine(s);i+=o.length+2;this.prg.push(i&255);this.prg.push(i>>8&255);for(var l=0;l<o.length;l++){this.prg.push(o[l])}}}this.prg.push(0);this.prg.push(0);var n=new Uint8Array(this.prg.length);for(var a=0;a<this.prg.length;a++){n[a]=this.prg[a]}return n}};var DbgC64Drive=function(){this.machine=null;this.visible=true;this.disassembly=null;this.memory=null;this.registers=null;this.prefix="";this.driveOn=false};DbgC64Drive.prototype={init:function(e){this.machine=e.machine;this.debugger=e.debugger;this.prefix=e.prefix},setVisible:function(e){this.visible=e;if(e){this.forceRedraw()}},getVisible:function(){return this.visible},buildInterface:function(e){this.uiComponent=UI.create("UI.SplitPanel");e.add(this.uiComponent);this.registersPanel=UI.create("UI.Panel");var t="<div>";t+='<div style="margin: 6px 0px 0px 20px">';t+="Drive&nbsp;";t+='<label class="rb-container" style="margin-right: 8px">On<input type="radio" name="'+this.prefix+'DriveOn" id="'+this.prefix+'DriveOn" value="on"><span class="checkmark"></span> </label>';t+='<label class="rb-container" style="margin-right: 8px">Off<input type="radio" checked="checked" name="'+this.prefix+'DriveOn" id="'+this.prefix+'DriveOff" value="off"><span class="checkmark"></span> </label>';t+="</div>";this.driveSettingsPanel=UI.create("UI.HTMLPanel",{html:t});this.topSplitPanel=UI.create("UI.SplitPanel");this.uiComponent.addNorth(this.topSplitPanel,74,false);this.topSplitPanel.addNorth(this.driveSettingsPanel,40,false);this.topSplitPanel.add(this.registersPanel);this.disassemblyPanel=UI.create("UI.Panel");this.uiComponent.add(this.disassemblyPanel);this.memoryPanel=UI.create("UI.Panel");this.uiComponent.addSouth(this.memoryPanel,200);this.registers=new DbgRegisters;this.registers.init({canWrite:false,showRasterPosition:false,prefix:this.prefix+"Drive",debugger:this,machine:this.machine});this.registers.buildInterface(this.registersPanel);this.disassembly=new DbgDisassembly;this.disassembly.init({canWrite:false,prefix:this.prefix+"Drive",debugger:this,machine:this.machine});this.disassembly.buildInterface(this.disassemblyPanel);this.memory=new DbgMemory;this.memory.init({debugger:this,machine:this.machine,prefix:this.prefix+"Drive",maxAddress:2048});this.memory.buildInterface(this.memoryPanel);var i=this;UI.on("ready",function(){i.initContent();i.initEvents()})},blurMachine:function(){this.debugger.blurMachine()},focusMachine:function(){this.debugger.focusMachine()},getPC:function(){return c1541_getPC()},getRegA:function(){return c1541_getRegA()},getRegX:function(){return c1541_getRegX()},getRegY:function(){return c1541_getRegY()},getRegSP:function(){return c1541_getSP()},getPC:function(){return c1541_getPC()},getFlagN:function(){return c1541_getFlagN()},getFlagV:function(){return c1541_getFlagV()},getFlagB:function(){return c1541_getFlagB()},getFlagD:function(){return c1541_getFlagD()},getFlagI:function(){return c1541_getFlagI()},getFlagZ:function(){return c1541_getFlagZ()},getFlagC:function(){return c1541_getFlagC()},getVC:function(){return 0},getRstY:function(){return 0},getPCBreakpoints:function(){return[]},readByte:function(e){return c1541_cpuRead(e)},writeByte:function(e,t){},getCycleCount:function(e){return 0},isRunning:function(){},resize:function(){this.forceRedraw()},initContent:function(){},initEvents:function(){var t=this;$("input[name="+this.prefix+"DriveOn]").on("click",function(){var e=$("input[name="+t.prefix+"DriveOn]:checked").val();if(e=="on"){c1541_setEnabled(true)}else{c1541_setEnabled(false)}})},forceRedraw:function(){this.disassembly.forceRedraw();this.memory.forceRedraw()},draw:function(e){},update:function(){var e=c1541_getStatus();if(e==0){if(this.driveOn){this.driveOn=false;$("#"+this.prefix+"DriveOff").prop("checked",true)}}else{if(!this.driveOn){this.driveOn=true;$("#"+this.prefix+"DriveOn").prop("checked",true)}}this.disassembly.update();this.memory.update();this.registers.update()}};var DbgRegisters=function(){this.fontCanvas=null;this.fontCharWidth=10;this.fontCharHeight=16;this.lineHeight=this.fontCharHeight;this.lastScrollY=false;this.lastWidth=false;this.lastHeight=false;this.machine=null;this.clear=false;this.pcLocationX=0;this.aLocationX=0;this.xLocationX=0;this.yLocationX=0;this.spLocationX=0;this.visible=true;this.showRasterPosition=false;this.canWrite=true;this.prefix=false};DbgRegisters.prototype={init:function(e){this.prefix=e.prefix;this.machine=e.machine;this.debugger=e.debugger;if(typeof e.showRasterPosition!="undefined"){this.showRasterPosition=e.showRasterPosition}if(typeof e.canWrite!="undefined"){this.canWrite=e.canWrite}var t=g_app.dbgFont;t.createFonts();this.fontCanvas=t.fontCanvas;this.hexNumberCanvas=t.hexNumberCanvas[0];this.cmdCanvas=t.cmdCanvas;this.setFontMetrics()},setFontMetrics:function(){var e=g_app.dbgFont;this.fontCharWidth=e.fontCharWidth;this.fontCharHeight=e.fontCharHeight;this.hexNumberPositions=e.hexNumberPositions;this.cmdPositions=e.cmdPositions;this.lineHeight=this.fontCharHeight+4*UI.devicePixelRatio},setVisible:function(e){this.visible=e},getVisible:function(){return this.visible},buildInterface:function(e){this.scrollCanvas=UI.create("UI.CanvasScrollPanel",{id:this.prefix+"RegistersCanvas"});e.add(this.scrollCanvas);var t=this;this.totalLines=2;this.contentHeight=1;this.scrollCanvas.setContentHeight(this.contentHeight);this.scrollCanvas.draw=function(e){t.draw(e)};this.scrollCanvas.on("mousedown",function(e){t.mouseDown(e)});this.scrollCanvas.on("mousemove",function(e){t.mouseMove(e)});this.scrollCanvas.on("mouseup",function(e){t.mouseUp(e)});this.scrollCanvas.on("resize",function(){t.doClear()});var t=this;UI.on("ready",function(){t.initEvents()})},initEvents:function(){var e=this.scrollCanvas.getScale();var t=this.fontCharWidth*4/e;var i=this.fontCharHeight/e+2;var r="font: 12px 'Courier New', Courier, monospace;";var a='<input class="'+this.prefix+'DebuggerInput" spellcheck="false"  id="'+this.prefix+'RegistersInput" type="text" ';a+=' style="'+r+"position: absolute; top: 0px; left: 0px; border: 0;";a+="padding: 0;display: none; width: "+t+"px; height: "+i+'px"/>';var s=$("#"+this.scrollCanvas.getElementId());var o=s.parent();o.append(a);var l=this;$("#"+this.prefix+"RegistersInput").on("focus",function(){l.debugger.blurMachine()});$("#"+this.prefix+"RegistersInput").on("blur",function(){$("#"+this.prefix+"RegistersInput").hide();l.debugger.focusMachine()});$("#"+this.prefix+"RegistersInput").on("keyup",function(e){l.keyUp(e)})},mouseDown:function(e){var t=this.scrollCanvas.getElementId();var i=this.scrollCanvas.getScale();var r=e.pageX-$("#"+t).offset().left;var a=e.pageY-$("#"+t).offset().top;r=r*i;a=a*i},mouseMove:function(e){var t=this.scrollCanvas.getElementId();var i=this.scrollCanvas.getScale();var r=e.pageX-$("#"+t).offset().left;var a=e.pageY-$("#"+t).offset().top;r=r*i;a=a*i},mouseUp:function(e){var t=this.scrollCanvas.getElementId();var i=this.scrollCanvas.getScale();var r=e.pageX-$("#"+t).offset().left;var a=e.pageY-$("#"+t).offset().top;r=r*i;a=a*i;if(!this.canWrite){return}if(a>this.lineHeight){if(r>this.pcLocationX&&r<this.pcLocationX+this.fontCharWidth*4&&a>this.lineHeight){this.editPC()}if(r>this.aLocationX&&r<this.aLocationX+this.fontCharWidth*2){this.editRegister("a")}if(r>this.xLocationX&&r<this.xLocationX+this.fontCharWidth*2){this.editRegister("x")}if(r>this.yLocationX&&r<this.yLocationX+this.fontCharWidth*2){this.editRegister("y")}if(r>this.spLocationX&&r<this.spLocationX+this.fontCharWidth*2){this.editRegister("sp")}}},keyUp:function(e){var t=e.keyCode;var i=$("#"+this.prefix+"RegistersInput").val();i=parseInt(i,16);if(isNaN(i)){return}if(!this.canWrite){return}var r=i;if(t==13){if(this.isEditingPC!==false){this.setPC(r)}if(this.isEditingRegister!==false){switch(this.isEditingRegister){case"a":this.debugger.setRegA(i);break;case"x":this.debugger.setRegX(i);break;case"y":this.debugger.setRegY(i);break;case"sp":this.debugger.setRegSP(i);break}}$("#"+this.prefix+"RegistersInput").hide()}},editRegister:function(e){var t=this.scrollCanvas;var i=t.getScale();this.isEditingRegister=e;this.isEditingPC=false;var r=this.aLocationX/i;var a=this.lineHeight/i;var s=0;switch(e){case"a":r=this.aLocationX/i;s=("00"+this.debugger.getRegA().toString(16)).substr(-2);break;case"x":r=this.xLocationX/i;s=("00"+this.debugger.getRegX().toString(16)).substr(-2);break;case"y":r=this.yLocationX/i;s=("00"+this.debugger.getRegY().toString(16)).substr(-2);break;case"sp":r=this.spLocationX/i;s=("00"+this.debugger.getRegSP().toString(16)).substr(-2);break}var o=2*this.fontCharWidth/i;$("#"+this.prefix+"RegistersInput").css("left",r+"px");$("#"+this.prefix+"RegistersInput").css("top",a+"px");$("#"+this.prefix+"RegistersInput").css("width",o+"px");$("#"+this.prefix+"RegistersInput").val(s);$("#"+this.prefix+"RegistersInput").show();$("#"+this.prefix+"RegistersInput").focus();$("#"+this.prefix+"RegistersInput").select()},editPC:function(){this.isEditingRegister=false;this.isEditingPC=true;var e=this.scrollCanvas;var t=e.getScale();var i=this.debugger.getPC();i=i.toString(16);var r=this.pcLocationX/t;var a=this.lineHeight/t;var s=4*this.fontCharWidth/t;$("#"+this.prefix+"RegistersInput").css("left",r+"px");$("#"+this.prefix+"RegistersInput").css("top",a+"px");$("#"+this.prefix+"RegistersInput").css("width",s+"px");$("#"+this.prefix+"RegistersInput").val(i);$("#"+this.prefix+"RegistersInput").show();$("#"+this.prefix+"RegistersInput").focus();$("#"+this.prefix+"RegistersInput").select()},setPC:function(e){var t=this.debugger.setPC(e)},doClear:function(){this.clear=true},draw:function(e){this.setFontMetrics();var t=this.scrollCanvas;var i=t.getScale();var r=t.getWidth();var a=t.getHeight();var s=t.getScrollY();if(s!==this.lastScrollY||r!==this.lastWidth||a!==this.lastHeight){this.lastScrollY=s;this.lastWidth=r;this.lastHeight=a;this.doClear();e.fillStyle="#000000";e.fillRect(0,0,r,a)}e.fillStyle="#444444";var o=this.debugger.getPC();var l=this.fontCharWidth;var n=this.fontCharHeight;var h=0;var d=0;var c=l;var f=n;var u=0;var p=0;var v=l;var g=n;this.breakpointColWidth=20*i;this.pcLocationX=this.breakpointColWidth;this.aLocationX=this.pcLocationX+6*this.fontCharWidth;this.xLocationX=this.pcLocationX+9*this.fontCharWidth;this.yLocationX=this.pcLocationX+12*this.fontCharWidth;this.spLocationX=this.pcLocationX+15*this.fontCharWidth;if(this.clear){e.fillStyle="#000000";e.fillRect(0,0,r,a);var m="PC    A  X  Y  SP  NV-BDIZC";if(this.showRasterPosition){m+="  VC  RY  RX"}var y=m.length;for(var b=0;b<y;b++){var C=m.charCodeAt(b);h=C*l;d=0;c=l;f=n;u=this.breakpointColWidth+b*l;v=l;g=n;e.drawImage(this.fontCanvas,h,d,c,f,u,p,v,g)}}p+=this.lineHeight;m="";m+=("0000"+o.toString(16)).substr(-4);m+="  ";m+=("00"+this.debugger.getRegA().toString(16)).substr(-2);m+=" ";m+=("00"+this.debugger.getRegX().toString(16)).substr(-2);m+=" ";m+=("00"+this.debugger.getRegY().toString(16)).substr(-2);m+=" ";m+=("00"+this.debugger.getRegSP().toString(16)).substr(-2);m+="  ";if(this.debugger.getFlagN()){m+="1"}else{m+="0"}if(this.debugger.getFlagV()){m+="1"}else{m+="0"}m+="-";if(this.debugger.getFlagB()){m+="1"}else{m+="0"}if(this.debugger.getFlagD()){m+="1"}else{m+="0"}if(this.debugger.getFlagI()){m+="1"}else{m+="0"}if(this.debugger.getFlagZ()){m+="1"}else{m+="0"}if(this.debugger.getFlagC()){m+="1"}else{m+="0"}if(this.showRasterPosition){m+="  ";var x=this.debugger.getVC();if(x<0){x+=63}m+=("000"+x.toString(10)).substr(-3);m+=" ";m+=("000"+this.debugger.getRstY().toString(10)).substr(-3);m+=" ";var S=x*8;m+=("000"+S.toString(10)).substr(-3)}y=m.length;for(var b=0;b<y;b++){var C=m.charCodeAt(b);h=C*l;d=0;c=l;f=n;u=this.breakpointColWidth+b*l;v=l;g=n;e.drawImage(this.fontCanvas,h,d,c,f,u,p,v,g)}this.clear=false},update:function(){if(this.visible){this.scrollCanvas.render()}}};var DbgCharset=function(){this.machine=null;this.visible=true;this.canvas=null;this.context=null;this.offscreenCanvas=null;this.offscreenContext=null;this.offscreenImageData=null;this.charEditor=null;this.charsetAddress=false;this.fgColor=6;this.bgColor=14;this.selectedChar=0;this.highlightChar=false;this.selectedFgColor=14;this.selectedBgColor=6;this.selectedMode="standard";this.highlightBgColor=false;this.prefix="";this.mouseRasterY=0;this.mouseRasterX=0;this.mouseAddress=false;this.isROMCharset=false;this.rasterY=false;this.drawMode=false;this.inDraw=false;this.lastSetAddress=false;this.lastSetByte=false};DbgCharset.prototype={init:function(e){this.machine=e.machine;this.debugger=e.debugger;this.prefix=e.prefix;this.canvasElementId=this.prefix+"CharsetCanvas";this.charEditor=new DbgC64CharEditor;this.charEditor.init(this,e)},setVisible:function(e){this.visible=e;if(e){this.forceRedraw()}},getVisible:function(){return this.visible},undo:function(){this.charEditor.undo()},redo:function(){this.charEditor.redo()},buildInterface:function(e){this.uiComponent=UI.create("UI.SplitPanel");e.add(this.uiComponent);this.charsetSplitPanel=UI.create("UI.SplitPanel");var t="";t+='<div class="panelFill">';t+="<div>";t+='<div style="margin-top: 6px">';t+='<span class="ui-text-label">Charset At</span> ';t+='<label class="rb-container" style="margin-right: 4px">Mouse Location';t+='<input type="radio" checked="checked" value="mouse"  name="'+this.prefix+'ShowCharset" id="'+this.prefix+'CharsetAtMouse">';t+='<span class="checkmark"></span>';t+="</label>";t+='<label class="rb-container" style="margin-right: 4px">Raster';t+='<input type="radio" value="raster" name="'+this.prefix+'ShowCharset"  id="'+this.prefix+'CharsetAtRaster">';t+='<span class="checkmark"></span>';t+="</label>";t+='<label class="rb-container" style="margin-right: 4px">Memory';t+='<input type="radio" value="memory" name="'+this.prefix+'ShowCharset"  id="'+this.prefix+'CharsetAtMemory">';t+='<span class="checkmark"></span>';t+="</label>";t+="</div>";t+="<div>";t+='<label id="'+this.prefix+'CharsetMouseInfo"><span class="ui-text-label">Raster Y </span><span size="4" id="'+this.prefix+'CharsetRasterY"></span>  (click to set)</label>';t+='<label id="'+this.prefix+'CharsetRasterYInfo" style="display: none" class="ui-text-label">Raster Y <input class="ui-number" size="4" id="'+this.prefix+'CharsetRasterYInput"/></label>';t+='<label id="'+this.prefix+'CharsetMemoryInfo" style="display: none" class="ui-text-label">Address $ <input size="4" id="'+this.prefix+'CharsetAddress"/></label>';t+="</div>";t+="</div>";t+="</div>";var i=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.addNorth(i,60,false);this.uiComponent.add(this.charsetSplitPanel);this.editorPanel=UI.create("UI.Panel");this.charsetSplitPanel.addNorth(this.editorPanel,260,true,false);this.charEditor.buildInterface(this.editorPanel);t='<div class="panelFill">';t+='<div style="height: 24px" id="'+this.prefix+'CharsetInfo">';t+="</div>";t+='<canvas id="'+this.prefix+'CharCanvas"></canvas>';t+="</div>";this.canvasPanel=UI.create("UI.HTMLPanel",{html:t});t='<div class="panelFill" style="background-color: #000000" >';t+='<canvas id="'+this.prefix+'ColorPaletteCanvas"></canvas>';t+="<div>";t+='<label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Standard";t+='<input type="radio" value="standard" checked="checked" name="'+this.prefix+'charDebuggerMode" id="'+this.prefix+'charDebuggerModestandard"><span class="checkmark"></span>';t+="</label>";t+='<label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Multicolour";t+='<input type="radio" value="multicolor"  name="'+this.prefix+'charDebuggerMode" id="'+this.prefix+'charDebuggerModemulticolor"><span class="checkmark"></span>';t+="</label>";t+="</div>";t+="</div>";this.colorPalettePanel=UI.create("UI.HTMLPanel",{html:t});var r=UI.create("UI.SplitPanel");r.add(this.canvasPanel);r.addSouth(this.colorPalettePanel,100);this.charsetSplitPanel.add(r);t="";t+='<div class="panelFill">';t+='<div style="">';t+='<label class="cb-container" style="margin-right: 4px; display: inline-block">';t+='<input type="checkbox" value="mouse"  id="'+this.prefix+'drawMode">';t+='<span class="cb-label">Draw In Emulator</span>';t+='<span class="checkmark"></span>';t+="</label>";t+='<label class="cb-container" style="margin-right: 4px; display: inline-block">';t+='<input type="checkbox" value="mouse" id="'+this.prefix+'showCharEditor">';t+='<span class="cb-label">Show Char Editor</span>';t+='<span class="checkmark"></span>';t+="</label>";t+='<label class="cb-container" style="margin-right: 4px; display: inline-block">';t+='<input type="checkbox" value="mouse" class="showMouseInfo"  id="'+this.prefix+'mouseInspect">';t+='<span class="cb-label">Mouse Inspect</span>';t+='<span class="checkmark"></span></label>';t+="</div>";t+="</div>";this.htmlSouthPanel=UI.create("UI.HTMLPanel",{html:t});this.charsetSplitPanel.addSouth(this.htmlSouthPanel,30,false);var a=this;UI.on("ready",function(){a.initContent();a.initEvents()})},resizeCanvas:function(){var e=2;var t=8*16*e;var i=8*16*e;this.canvas.width=t*UI.devicePixelRatio;this.canvas.height=i*UI.devicePixelRatio;this.canvas.style.width=t+"px";this.canvas.style.height=i+"px";if(this.canvas){this.context=UI.getContextNoSmoothing(this.canvas)}this.colorSize=16*e;t=8*this.colorSize;i=2*this.colorSize;this.colorPaletteCanvas.width=t*UI.devicePixelRatio;this.colorPaletteCanvas.height=i*UI.devicePixelRatio;this.colorPaletteCanvas.style.width=t+"px";this.colorPaletteCanvas.style.height=i+"px";if(this.colorPaletteCanvas){this.colorPaletteContext=UI.getContextNoSmoothing(this.colorPaletteCanvas)}},resize:function(){},setDrawInEmulator:function(e){this.drawInEmulator=e;$("#"+this.prefix+"").prop("checked",e)},initContent:function(){this.charsAcross=16;this.charsDown=16;this.charWidth=8;this.charHeight=8;this.showCharEditor(false);this.canvas=document.getElementById(this.prefix+"CharCanvas");this.canvasElementId=this.canvas.id;this.colorPaletteCanvasId=this.prefix+"ColorPaletteCanvas";this.colorPaletteCanvas=document.getElementById(this.colorPaletteCanvasId);this.offscreenCanvas=document.createElement("canvas");this.offscreenCanvas.width=this.charWidth*this.charsAcross;this.offscreenCanvas.height=this.charHeight*this.charsDown;this.offscreenContext=this.offscreenCanvas.getContext("2d");this.offscreenImageData=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)},setCharMode:function(e){this.selectedMode=e;$("#"+this.prefix+"charDebuggerMode").prop("checked",true);this.charEditor.setMulticolor(this.selectedMode=="multicolor");var t=c64_cpuReadNS(53270);if(e=="multicolor"){t=t|16}else{t=t&~16}this.debugger.writeByte(53270,t)},setDrawMode:function(e){this.drawMode=e;$("#"+this.prefix+"drawMode").prop("checked",e)},showCharEditor:function(e){this.charsetSplitPanel.setPanelVisible("north",e);var t=$("#"+this.prefix+"showCharEditor");if(t!=null&&typeof t.length!="undefined"){t.prop("checked",e)}if(e){this.charEditor.updateColors()}},initEvents:function(){var i=this;$("#"+this.prefix+"mouseInspect").on("click",function(){i.debugger.showMouseInfo($(this).is(":checked"))});$("#"+this.prefix+"showCharEditor").on("click",function(){i.showCharEditor($(this).is(":checked"))});$("#"+this.prefix+"drawMode").on("click",function(){i.setDrawMode($(this).is(":checked"))});$("#"+this.canvasElementId).on("mousedown",function(e){i.mouseDown(e)});$("#"+this.canvasElementId).on("dblclick",function(e){i.dblClick(e)});$("#"+this.canvasElementId).on("mousemove",function(e){i.mouseMove(e)});$("#"+this.canvasElementId).on("mouseup",function(e){i.mouseUp(e)});$("#"+this.canvasElementId).on("contextmenu",function(e){e.preventDefault()});$("#"+this.colorPaletteCanvasId).on("mousedown",function(e){i.colorPaletteMouseDown(e)});$("#"+this.colorPaletteCanvasId).on("mousemove",function(e){i.colorPaletteMouseMove(e)});$("#"+this.colorPaletteCanvasId).on("mouseup",function(e){i.colorPaletteMouseUp(e)});$("#"+this.colorPaletteCanvasId).on("contextmenu",function(e){e.preventDefault()});$("input[name="+this.prefix+"ShowCharset]").on("click",function(){var e=$("input[name="+i.prefix+"ShowCharset]:checked").val();i.setShowCharset(e)});$("#"+this.prefix+"CharsetAddress").on("focus",function(){i.debugger.blurMachine()});$("#"+this.prefix+"CharsetAddress").on("change",function(e){var t=parseInt($(this).val(),16);if(isNaN(t)){return}i.setCharsetAddress(t)});$("#"+this.prefix+"CharsetAddress").on("keyup",function(e){var t=parseInt($(this).val(),16);if(isNaN(t)){return}i.setCharsetAddress(t)});$("#"+this.prefix+"CharsetRasterYInput").on("focus",function(){i.debugger.blurMachine()});$("#"+this.prefix+"CharsetRasterYInput").on("change",function(){var e=parseInt($(this).val(),10);if(isNaN(e)){return}i.setRasterY(e)});$("#"+this.prefix+"CharsetRasterYInput").on("keyup",function(){var e=parseInt($(this).val(),10);if(isNaN(e)){return}i.setRasterY(e)});$("input[name="+this.prefix+"charDebuggerMode]").on("click",function(){var e=$("input[name="+this.prefix+"charDebuggerMode]:checked").val();var e=$(this).val();i.setCharMode(e)})},setShowCharset:function(e){this.showCharset=e;$("input[name="+this.prefix+"ShowCharset][value="+e+"]").prop("checked",true);$("#"+this.prefix+"CharsetMouseInfo").hide();$("#"+this.prefix+"CharsetRasterYInfo").hide();$("#"+this.prefix+"CharsetMemoryInfo").hide();if(this.showCharset=="mouse"){$("#"+this.prefix+"CharsetMouseInfo").show()}if(this.showCharset=="memory"){$("#"+this.prefix+"CharsetMemoryInfo").show();var t=this.charsetAddress;$("#"+this.prefix+"CharsetAddress").val(t.toString(16));this.setCharsetAddress(t)}if(this.showCharset=="raster"){var i=this.mouseRasterY;if(i===false){i=0}$("#"+this.prefix+"CharsetRasterYInput").val(i);$("#"+this.prefix+"CharsetRasterYInfo").show()}},setRasterY:function(e){e=parseInt(e,10);if(isNaN(e)){return}this.rasterY=e;$("#"+this.prefix+"CharsetRasterYInput").val(e);this.setShowCharset("raster")},debuggerMousePosition:function(e,t,i,r,a,s,o){this.mouseAddress=e;this.mouseColorAddress=t;this.mouseRasterX=i;this.mouseRasterY=r;this.fgColor=a;this.bgColor=s;this.highlightChar=o;if(this.inDraw){if(this.mouseAddress!==false&&this.selectedChar!==false){this.debuggerDrawChar(this.mouseAddress,this.selectedChar);this.inDraw=true}}},debuggerMouseLeave:function(){this.mouseRasterX=false;this.mouseRasterY=false;this.fgColor=1;this.bgColor=0},debuggerDrawChar:function(e,t){if(this.lastSetAddress!==e||this.lastSetByte!==t){this.debugger.writeByte(e,t);this.debugger.writeByte(this.mouseColorAddress,this.selectedFgColor);this.lastSetAddress=e;this.lastSetByte=t}},debuggerMouseDown:function(){this.setRasterY(this.mouseRasterY);if(this.drawMode){if(this.mouseAddress!==false&&this.selectedChar!==false){this.debuggerDrawChar(this.mouseAddress,this.selectedChar)}this.inDraw=true}},debuggerMouseUp:function(){this.inDraw=false},xyToChar:function(e,t){var i=0;var r=Math.floor((e-i*2)/(2*(this.charWidth+i)));var a=Math.floor((t-i*2)/(2*(this.charHeight+i)));var s=r+a*16;return s},setSelectedChar:function(e){if(this.selectedChar!==e){this.selectedChar=e;this.charEditor.setCharAddress(this.charsetAddress+this.highlightChar*8);this.draw(this.context)}},xyToColor:function(e,t){var i=this.colorSize;var r=Math.floor(e/i)+Math.floor(t/i)*8;return r},setSelectedBgColor:function(e){this.debugger.writeByte(53281,e);this.selectedBgColor=e;this.charEditor.setBgColor(e)},colorPaletteMouseDown:function(e){var t=e.pageX-$("#"+this.colorPaletteCanvasId).offset().left;var i=e.pageY-$("#"+this.colorPaletteCanvasId).offset().top;var r=this.xyToColor(t,i);if(e.button==2){this.setSelectedBgColor(r)}else{this.selectedFgColor=r;this.charEditor.setFgColor(r)}},colorPaletteMouseMove:function(e){var t=e.pageX-$("#"+this.colorPaletteCanvasId).offset().left;var i=e.pageY-$("#"+this.colorPaletteCanvasId).offset().top},colorPaletteMouseUp:function(e){var t=e.pageX-$("#"+this.colorPaletteCanvasId).offset().left;var i=e.pageY-$("#"+this.colorPaletteCanvasId).offset().top},mouseDown:function(e){this.setSelectedChar(this.highlightChar)},dblClick:function(e){this.showCharEditor(true)},mouseMove:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;var r=this.xyToChar(t,i);this.setHighlightChar(r)},mouseUp:function(e){},mouseLeave:function(e){},drawChar:function(e,t,i,r,a,s,o){var l=c64.colors.colors;var n=[];n.push(l[a]&16777215);n.push(l[s]&16777215);n.push(l[0]&16777215);n.push(l[o]&16777215);var h=e.width;var d=e.height;for(var c=0;c<8;c++){n[2]=l[r];dstPos=c*h*4;var f=c64_vicReadAbsolute(t++);for(var u=7;u>=0;u--){var p=f>>>u&1;if(i){var v=0;if(p){v+=2}u--;var g=f>>>u&1;if(g){v+=1}var m=n[v];e.data[dstPos++]=m&255;e.data[dstPos++]=m>>8&255;e.data[dstPos++]=m>>16&255;e.data[dstPos++]=255;e.data[dstPos++]=m&255;e.data[dstPos++]=m>>8&255;e.data[dstPos++]=m>>16&255;e.data[dstPos++]=255}else{var y=l[a];if(p){y=l[r]}e.data[dstPos++]=y&255;e.data[dstPos++]=y>>8&255;e.data[dstPos++]=y>>16&255;e.data[dstPos++]=255}}}},forceRedraw:function(){this.lastWidth=false;this.lastHeight=false},setHighlightChar:function(e){if(e!==this.highlightChar){this.highlightChar=e;this.draw(this.context)}},editChar:function(e){if(e!==false){this.setSelectedChar(e);this.showCharEditor(true)}},getPixel:function(e){var t=this.selectedChar;if(typeof e.c!="undefined"){t=e.c}var i=e.x;var r=e.y;if(typeof t==="undefined"||t===false){return 0}var a=this.charsetAddress+t*8+r%8;var s=7-i%8;var o=c64_vicReadAbsolute(a);return o>>s&1},setPixel:function(e){var t=this.selectedChar;if(typeof e.c!="undefined"){t=e.c}var i=e.x;var r=e.y;if(typeof t==="undefined"||t===false){return}var a=this.charsetAddress+t*8+r%8;var s=i%8;var o=c64_vicReadAbsolute(a);if(e.value==1){o=o|1<<7-s}else{if(o&1<<7-s){o=o^1<<7-s}}c64_cpuWrite(a,o)},setCharsetAddress:function(e){this.charsetAddress=e},drawColorPalette:function(){if(!this.colorPaletteContext){return}var e=this.colorPaletteContext;for(var t=0;t<16;t++){var i=t;var r=false;if(this.selectedMode=="multicolor"){r=true}if(r){if(i>7){i-=8}}var a=c64.colors.getColor(i)&16777215;var s=a&255;var o=a>>8&255;var l=a>>16&255;s=("00"+s.toString(16)).substr(-2);o=("00"+o.toString(16)).substr(-2);l=("00"+l.toString(16)).substr(-2);a="#"+s+o+l;e.fillStyle=a;var n=t%8*this.colorSize*UI.devicePixelRatio;var h=Math.floor(t/8)*this.colorSize*UI.devicePixelRatio;e.fillRect(n,h,this.colorSize*UI.devicePixelRatio,this.colorSize*UI.devicePixelRatio);if(r&&t>7){e.font="10px Verdana";e.fillStyle="#eeeeee";e.fillText("M",n+2,h+12)}}e.strokeStyle="yellow";if(this.selectedFgColor!==false){var d=this.selectedFgColor%8*this.colorSize*UI.devicePixelRatio;var c=Math.floor(this.selectedFgColor/8)*this.colorSize*UI.devicePixelRatio;var f=this.colorSize*UI.devicePixelRatio;e.fillStyle="yellow";e.beginPath();e.moveTo(d,c);e.lineTo(d+f/3,c);e.lineTo(d,c+f/3);e.fill();e.beginPath();e.lineWidth=2;e.rect(d,c,this.colorSize*UI.devicePixelRatio,this.colorSize*UI.devicePixelRatio);e.stroke()}if(this.selectedBgColor!==false){var d=this.selectedBgColor%8*this.colorSize*UI.devicePixelRatio;var c=Math.floor(this.selectedBgColor/8)*this.colorSize*UI.devicePixelRatio;var f=this.colorSize*UI.devicePixelRatio;e.fillStyle="yellow";e.beginPath();e.moveTo(d+f,c+f);e.lineTo(d+f-f/3,c+f);e.lineTo(d+f,c+f-f/3);e.fill();e.beginPath();e.lineWidth=2;e.rect(d,c,this.colorSize*UI.devicePixelRatio,this.colorSize*UI.devicePixelRatio);e.stroke()}},draw:function(e){if(!this.context){this.resizeCanvas()}if(!this.canvas){return}this.drawColorPalette();if(this.context&&this.canvas){this.context.fillStyle="#111111";this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}var t=c64.colors.colors;var i=[];var r=false;var a=[];var s=this.mouseRasterY;if(this.showCharset=="raster"){s=this.rasterY}if(s!==false){for(var o=0;o<64;o++){a[o]=c64_vicReadRegisterAt(s,this.mouseRasterX,o)}r=c64_cia2ReadRegisterAt(s,this.mouseRasterX,0)}else{for(var o=0;o<64;o++){a[o]=c64_vicReadRegister(o)}r=c64_cpuReadNS(56576)}var l=this.debugger.readByte(1)&8==0;var n=(a[24]&14)<<10;var h=(a[22]&16)>0;var d=a[33]&15;var c=a[34]&15;var f=a[35]&15;var u=this.fgColor;u=this.selectedFgColor;if(this.selectedMode=="multicolor"){h=true}if(h){if(u>=8){u-=8}else{h=false}}var p=[];p.push(t[d]&16777215);p.push(t[c]&16777215);p.push(t[f]&16777215);p.push(t[u]&16777215);var v=false;var g=0;switch(r&3){case 0:g=49152;break;case 1:g=32768;if(n==4096){v=true}break;case 2:g=16384;break;case 3:g=0;if(n==4096){v=true}break}if(this.showCharset!="memory"){if(v!==this.isROMCharset){v=this.isROMCharset}for(var o=0;o<2048;o++){i[o]=c64_vicReadAbsolute(g+n+o)}this.charsetAddress=g+n}else{for(var o=0;o<2048;o++){i[o]=c64_vicReadAbsolute(this.charsetAddress+o&65535)}}var m=256;var y=n;var b="#999999";var C="#cccccc";var x="";x+=' <span style="color: '+b+'">VIC Bank </span>';x+='<span style="color: '+C+'">$'+("0000"+g.toString(16)).substr(-4)+"</span>";x+=' <span style="color: '+b+'">Charset Address </span>';x+='<span style="color: '+C+'">$'+("0000"+this.charsetAddress.toString(16)).substr(-4)+"</span>";x+=' <span style="color: '+b+'">Char Address </span>';var S=this.charsetAddress+this.selectedChar*8;var S=this.charsetAddress+this.highlightChar*8;x+='<span style="color: '+C+'">$'+("0000"+S.toString(16)).substr(-4)+"</span>";if(s!==false){$("#"+this.prefix+"CharsetRasterY").html(s)}$("#"+this.prefix+"CharsetInfo").html(x);var P=255;var w=0;var I=t[u]&16777215;var k=I&255;var M=I>>8&255;var T=I>>16&255;var D=t[d]&16777215;var E=D&255;var _=D>>8&255;var B=D>>16&255;var R=0;var A=this.offscreenImageData;for(var F=0;F<m;F++){var L=F%this.charsAcross;var U=Math.floor(F/this.charsAcross);y=F*8;for(var H=0;H<this.charHeight;H++){var O=i[y+H];for(var G=0;G<this.charWidth;G++){var z=R+L*(this.charWidth+R)+G;var N=R+U*(this.charHeight+R)+H;var W=(z+N*A.width)*4;if(h){var X=0;var Y=O&1<<7-G;if(Y>0){X=2}G++;var V=O&1<<7-G;if(V>0){X++}var q=p[X];A.data[W]=q&255;A.data[W+1]=q>>8&255;A.data[W+2]=q>>16&255;A.data[W+3]=255;A.data[W+4]=A.data[W];A.data[W+5]=A.data[W+1];A.data[W+6]=A.data[W+2];A.data[W+7]=A.data[W+3]}else{if(O&1<<7-G){A.data[W]=k;A.data[W+1]=M;A.data[W+2]=T;A.data[W+3]=255}else{A.data[W]=E;A.data[W+1]=_;A.data[W+2]=B;A.data[W+3]=255}}}}y+=8}this.offscreenContext.putImageData(A,0,0);this.scale=2*UI.devicePixelRatio;this.context.drawImage(this.offscreenCanvas,0,0,this.offscreenCanvas.width*this.scale,this.offscreenCanvas.height*this.scale);if(this.highlightChar!==false){var j=Math.floor(this.highlightChar/this.charsAcross);var K=this.highlightChar%this.charsAcross;var H=j*8*this.scale;var G=K*8*this.scale;var Z=8*this.scale;var J=8*this.scale;this.context.lineWidth=2;this.context.strokeStyle="#ffaa00";this.context.beginPath();this.context.rect(G,H,Z,J);this.context.stroke()}if(this.selectedChar!==false){var j=Math.floor(this.selectedChar/this.charsAcross);var K=this.selectedChar%this.charsAcross;var H=j*8*this.scale;var G=K*8*this.scale;var Z=8*this.scale;var J=8*this.scale;this.context.lineWidth=2;this.context.strokeStyle="#ff0000";this.context.beginPath();this.context.rect(G,H,Z,J);this.context.stroke()}},update:function(){if(this.visible){this.draw()}this.charEditor.draw()}};var DbgC64Bitmap=function(){this.machine=null;this.visible=true;this.canvas=null;this.context=null;this.offscreenCanvas=null;this.offscreenContext=null;this.offscreenImageData=null;this.charEditor=null;this.bitmapAddress=false;this.fgColor=6;this.bgColor=14;this.highlightChar=false;this.prefix="";this.mouseRasterY=0;this.mouseRasterX=0};DbgC64Bitmap.prototype={init:function(e){this.machine=e.machine;this.debugger=e.debugger;this.prefix=e.prefix;this.canvasElementId=this.prefix+"BitmapCanvas"},setVisible:function(e){this.visible=e;if(e){this.forceRedraw()}},getVisible:function(){return this.visible},buildInterface:function(e){this.uiComponent=UI.create("UI.SplitPanel");e.add(this.uiComponent);this.bitmapSplitPanel=UI.create("UI.SplitPanel");var t="";t+='<div class="panelFill">';t+="<div>";t+='<label class="cb-container" style="margin-right: 4px">';t+="Mouse Inspect";t+='<input type="checkbox" value="mouse" class="showMouseInfo"  id="'+this.prefix+'bitmapMouseInspect"><span class="checkmark"></span></label>';t+="</div>";t+="</div>";var i=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.addNorth(i,40,false);this.uiComponent.add(this.bitmapSplitPanel);this.scrollCanvas=UI.create("UI.CanvasScrollPanel",{id:this.prefix+"BitmapCanvas"});this.bitmapSplitPanel.add(this.scrollCanvas);t="";t+='<div class="panelFill">';t+="</div>";this.htmlSouthPanel=UI.create("UI.HTMLPanel",{html:t});this.bitmapSplitPanel.addSouth(this.htmlSouthPanel,65,false);var r=this;UI.on("ready",function(){r.initContent();r.initEvents()})},resizeCanvas:function(){this.context=UI.getContextNoSmoothing(this.scrollCanvas.getCanvas())},resize:function(){},initContent:function(){this.canvas=this.scrollCanvas.getCanvas();this.canvasElementId=this.canvas.id;this.offscreenCanvas=document.createElement("canvas");this.offscreenCanvas.width=320;this.offscreenCanvas.height=200;this.offscreenContext=this.offscreenCanvas.getContext("2d");this.offscreenImageData=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)},initEvents:function(){var t=this;$("#"+this.prefix+"bitmapMouseInspect").on("click",function(){t.debugger.showMouseInfo($(this).is(":checked"))});this.scrollCanvas.draw=function(e){t.draw(e)};this.scrollCanvas.on("resize",function(){t.resizeCanvas()});this.scrollCanvas.on("mousedown",function(e){t.mouseDown(e)});this.scrollCanvas.on("mousemove",function(e){t.mouseMove(e)});this.scrollCanvas.on("mouseup",function(e){t.mouseUp(e)})},debuggerMousePosition:function(e,t,i,r,a){this.mouseRasterX=e;this.mouseRasterY=t;this.fgColor=i;this.bgColor=r;this.highlightChar=a},debuggerMouseLeave:function(){this.mouseRasterX=false;this.mouseRasterY=false;this.fgColor=1;this.bgColor=0},xyToChar:function(e,t){},mouseDown:function(e){this.charEditor.setCharAddress(this.charsetAddress+this.highlightedChar*8)},mouseMove:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top},mouseUp:function(e){},mouseLeave:function(e){},forceRedraw:function(){if(this.scrollCanvas){this.scrollCanvas.resize()}this.lastWidth=false;this.lastHeight=false},drawBitmap:function(){var e=c64.colors.colors;var t=false;var i=[];var r=this.mouseRasterY;if(r!==false){for(var a=0;a<64;a++){i[a]=c64_vicReadRegisterAt(r,this.mouseRasterX,a)}t=c64_cia2ReadRegisterAt(r,this.mouseRasterX,0)}else{for(var a=0;a<64;a++){i[a]=c64_vicReadRegister(a)}t=c64_cpuReadNS(56576)}var s=0;switch(t&3){case 0:s=49152;break;case 1:s=32768;break;case 2:s=16384;break;case 3:s=0;break}var o=(i[24]&8)<<10;var l=((i[24]&240)>>4)*1024;var n=(i[22]&16)>0;var h=e[i[33]&15];var d=this.offscreenImageData.data;var c=0;var f=s+o;var u=0;var p=0;for(var v=0;v<25;v++){for(var g=0;g<40;g++){var m=s+l+(g+v*40);var y=c64_vicReadAbsolute(m);var b=c64_cpuReadNS(55296+(g+v*40));var C=e[y&15];var x=C&255;var S=C>>8&255;var P=C>>16&255;var w=e[y>>4&15];var I=w&255;var k=w>>8&255;var M=w>>16&255;var T=e[b&15];for(var D=0;D<8;D++){var a=p++;var E=c64_vicReadAbsolute(s+o+a);var c=4*((v*8+D)*320+g*8);if(n){for(var $=0;$<8;$++){var _=0;var B=E&1<<7-$;if(B>0){_=2}$++;var R=E&1<<7-$;if(R>0){_++}var A=0;var F=0;var L=0;switch(_){case 0:A=h&255;F=h>>8&255;L=h>>16&255;break;case 1:A=I;F=k;L=M;break;case 2:A=x;F=S;L=P;break;case 3:A=T&255;F=T>>8&255;L=T>>16&255;break}u+=2;d[c++]=A;d[c++]=F;d[c++]=L;d[c++]=255;d[c++]=A;d[c++]=F;d[c++]=L;d[c++]=255}}else{for(var $=7;$>=0;$--){var U=E>>$&1;if(U){d[c++]=I;d[c++]=k;d[c++]=M;d[c++]=255}else{d[c++]=x;d[c++]=S;d[c++]=P;d[c++]=255}}}}}}this.offscreenContext.putImageData(this.offscreenImageData,0,0)},draw:function(e){this.context=e;if(this.context&&this.canvas){this.context.fillStyle="#111111";this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}this.drawBitmap();this.scale=2*UI.devicePixelRatio;this.context.drawImage(this.offscreenCanvas,0,0,this.offscreenCanvas.width*this.scale,this.offscreenCanvas.height*this.scale)},update:function(){if(this.visible){this.scrollCanvas.render()}}};var DbgC64CharEditor=function(){this.canvas=null;this.offscreenCanvas=null;this.context=null;this.charAddress=4096;this.dbgCharset=null;this.charWidth=8;this.charHeight=8;this.canvasElementId="dbgC64CharEditorCanvas";this.multicolor=false;this.buttons=0;this.drawMode=false;this.isROMChar=false;this.charColor=1;this.bgColor=0;this.mc1Color=2;this.mc2Color=3;this.lastPixelAddress=false;this.lastPixelX=false;this.historyPosition=0;this.history=[];this.historyEntry=[]};DbgC64CharEditor.prototype={init:function(e,t){this.dbgCharset=e;this.debugger=t.debugger;this.prefix=t.prefix},buildInterface:function(e){this.canvasElementId=this.prefix+"CharEditorCanvas";var t="";t='<div class="panelFill" id="'+this.prefix+'CharEditorPanel">';t+='  <div style="position: absolute; top: 0; left: 0; right: 0; height: 30px">';t+='    <div id="'+this.prefix+'CharEditorAddress" style="font-size: 24px; font-weight: 300"></div>';t+="  </div>";t+='  <div style="position: absolute; top: 30px; left: 0; right: 0; bottom: 40px">';t+='    <canvas id="'+this.canvasElementId+'" style="background-color: #333333" width="256" height="256"></canvas>';t+="  </div>";t+='  <div style="position: absolute; left: 0; right: 0; bottom: 0px; height: 40px">';t+='    <div id="'+this.prefix+'CharEditorMultiControls" style="display: none">';t+='      <label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Background";t+='      <input type="radio" class="showMouseInfo"  name="'+this.prefix+'CharEditorMultiMode" id="'+this.prefix+'CharEditorMultiModeErase" value="erase"><span class="checkmark"></span>';t+='<div id="'+this.prefix+'CharEditorColorBg" style="display: inline-block; width: 16px; height: 16px; background-color: #555555"></div>';t+="</label>";t+='      <label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Invididual";t+='      <input type="radio" class="showMouseInfo"  name="'+this.prefix+'CharEditorMultiMode" id="'+this.prefix+'CharEditorMultiModeDraw" value="draw"><span class="checkmark"></span>';t+='<div  id="'+this.prefix+'CharEditorColorFg" style="display: inline-block; width: 16px; height: 16px; background-color: #555555"></div>';t+="</label>";t+='      <label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Multi 1";t+='      <input type="radio" class="showMouseInfo"  name="'+this.prefix+'CharEditorMultiMode" id="'+this.prefix+'CharEditorMultiModeMulti1" value="multi1"><span class="checkmark"></span>';t+='<div  id="'+this.prefix+'CharEditorColorMulti1" style="display: inline-block; width: 16px; height: 16px; background-color: #555555"></div>';t+="</label>";t+='      <label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Multi 2";t+='      <input type="radio" class="showMouseInfo"  name="'+this.prefix+'CharEditorMultiMode" id="'+this.prefix+'CharEditorMultiModeMulti2" value="multi2"><span class="checkmark"></span>';t+='<div id="'+this.prefix+'CharEditorColorMulti2" style="display: inline-block; width: 16px; height: 16px; background-color: #555555"></div>';t+="</label>";t+="    </div>";t+="  </div>";t+="</div>";this.htmlPanel=UI.create("UI.HTMLPanel",{html:t});e.add(this.htmlPanel);var i=this;this.htmlPanel.on("resize",function(){i.resize()});this.canvasScale=Math.floor(UI.devicePixelRatio);var i=this;UI.on("ready",function(){i.initContent();i.initEvents()})},initContent:function(){if(this.canvas==null){this.canvas=document.getElementById(this.canvasElementId)}if(this.offscreenCanvas==null){this.offscreenCanvas=document.createElement("canvas");this.offscreenCanvas.width=this.charWidth;this.offscreenCanvas.height=this.charHeight;this.offscreenContext=this.offscreenCanvas.getContext("2d");this.offscreenImageData=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)}this.resize()},setMulticolor:function(e){this.multicolor=e;if(this.multicolor){this.setDrawMode("draw");$("#"+this.prefix+"CharEditorMultiControls").show()}else{$("#"+this.prefix+"CharEditorMultiControls").hide()}this.draw()},setFgColor:function(e){this.charColor=e;this.updateColors()},setBgColor:function(e){this.bgColor=e;this.updateColors()},setDrawMode:function(e){this.drawMode=e;$("input[name="+this.prefix+"CharEditorMultiMode][value="+e+"]").prop("checked",true)},initEvents:function(){var t=this;$("input[name="+this.prefix+"CharEditorMultiMode]").on("click",function(){var e=$("input[name="+t.prefix+"CharEditorMultiMode]:checked").val();t.setDrawMode(e)});$("#"+this.canvasElementId).on("mousedown",function(e){t.mouseDown(e)});$("#"+this.canvasElementId).on("mousemove",function(e){t.mouseMove(e)});$("#"+this.canvasElementId).on("mouseup",function(e){t.mouseUp(e)});$("#"+this.canvasElementId).on("mouseleave",function(e){t.mouseLeave(e)});$("#"+this.canvasElementId).on("contextmenu",function(e){e.preventDefault()});$("#"+this.canvasElementId).on("mouseenter",function(e){t.mouseEnter(e)})},setCharAddress:function(e){this.isROMChar=false;if(e>=4096&&e<4096+4096){this.isROMChar=true}if(e>=36864&&e<36864+4096){this.isROMChar=true}this.charAddress=e;this.draw();var t="";t+="$"+("0000"+e.toString(16)).substr(-4);if(this.isROMChar){t+=" (Char ROM - not editable)"}$("#"+this.prefix+"CharEditorAddress").html(t)},getPixel:function(e,t){return 0},setPixel:function(){var e=this.cursorPixelX;var t=this.charAddress;if(this.isROMChar){return}t+=this.cursorPixelY;var i=c64_vicReadAbsolute(t);if(this.multicolor){e=6-e%8;var r=0;switch(this.drawMode){case"erase":r=0;break;case"draw":r=3;break;case"multi1":r=1;break;case"multi2":r=2;break}i=i&~(3<<e);i=i|r<<e;this.debugger.writeByte(t,i)}else{var a=e%8;var i=c64_vicReadAbsolute(t);if(this.drawMode=="draw"){i=i|1<<7-a}else{if(i&1<<7-a){i=i^1<<7-a}}c64_cpuWrite(t,i)}this.draw()},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){this.buttons=2}if(e.metaKey&&this.buttons==1){this.buttons=4}},mouseDown:function(e){this.setButtons(e);if(this.buttons&1){UI.captureMouse(this);this.historyEntry=[];if(this.cursorPixelX!==false&&this.cursorPixelY!==false){if(!this.multicolor){if(this.dbgCharset.getPixel({x:this.cursorPixelX,y:this.cursorPixelY})){this.drawMode="erase"}else{this.drawMode="draw"}}this.setPixel()}}},mouseMove:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;t=t*this.canvasScale;i=i*this.canvasScale;if(t>this.gridXPos&&t<this.gridXPos+this.charWidth*this.scale&&i>this.gridYPos&&i<this.gridYPos+this.charHeight*this.scale){var r=Math.floor((t-this.gridXPos)/this.scale);var a=Math.floor((i-this.gridYPos)/this.scale);if(r!==this.cursorPixelX||a!==this.cursorPixelY){this.cursorPixelX=r;this.cursorPixelY=a;if(this.multicolor){this.cursorPixelX=Math.floor(this.cursorPixelX/2)*2}if(this.buttons&1){if(this.cursorPixelX!==false&&this.cursorPixelY!==false){this.setPixel()}}this.draw()}}},mouseUp:function(e){this.buttons=0},undo:function(){this.lastPixelAddress=false;this.lastPixelX=false;if(this.historyPosition<=0){return}this.historyPosition--;if(this.historyPosition>=this.history.length){return}var e=this.history[this.historyPosition];for(var t=e.length-1;t>=0;t--){this.debugger.writeByte(e[t].address,e[t].prev)}},redo:function(){if(this.historyPosition>=this.history.length){return}var e=this.history[this.historyPosition];for(var t=0;t<e.length;t++){this.debugger.writeByte(e[t].address,e[t].value)}this.historyPosition++},mouseEnter:function(e){},mouseLeave:function(e){this.cursorPixelX=false;this.cursorPixelY=false},resize:function(){this.canvasScale=Math.floor(UI.devicePixelRatio);var e=$("#"+this.prefix+"CharEditorPanel");var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}var i=this.height-70;this.canvas.width=this.width*UI.devicePixelRatio;this.canvas.height=i*UI.devicePixelRatio;this.canvas.style.width=this.width+"px";this.canvas.style.height=i+"px";this.context=this.canvas.getContext("2d");this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;this.scale=Math.floor(this.canvas.height/this.charHeight);this.gridXPos=0;this.gridYPos=0},setColor:function(e,t){var i=c64.colors.getColor(t)&16777215;var r=i&255;var a=i>>8&255;var s=i>>16&255;r=("00"+r.toString(16)).substr(-2);a=("00"+a.toString(16)).substr(-2);s=("00"+s.toString(16)).substr(-2);i="#"+r+a+s;$("#"+this.prefix+"CharEditorColor"+e).css("background-color",i)},updateColors:function(){this.setColor("Bg",this.bgColor);var e=this.charColor;if(this.multicolor&&e>7){e-=8}this.setColor("Fg",e);this.setColor("Multi1",this.mc1Color);this.setColor("Multi2",this.mc2Color)},drawChar:function(){var e=this.charColor;var t=this.multicolor;if(t){if(e>7){e-=8}else{t=false}}this.dbgCharset.drawChar(this.offscreenImageData,this.charAddress,t,e,this.bgColor,this.mc1Color,this.mc2Color);this.offscreenContext.putImageData(this.offscreenImageData,0,0)},drawGrid:function(){var e=1;var t=this.scale;var i=this.scale;if(this.multicolor){e=2}this.context.strokeStyle=styles.textMode.tileEditorGridLines;this.context.beginPath();for(var r=0;r<=this.charWidth;r+=e){this.context.moveTo(this.gridXPos+r*t+.5,this.gridYPos+0);this.context.lineTo(this.gridXPos+r*t+.5,this.gridYPos+this.charHeight*i)}for(var r=0;r<=this.charHeight;r++){this.context.moveTo(this.gridXPos+0,this.gridYPos+r*i+.5);this.context.lineTo(this.gridXPos+this.charWidth*t,this.gridYPos+r*i+.5)}this.context.stroke()},draw:function(){this.drawChar();var e=this.charWidth*this.scale;var t=this.charHeight*this.scale;this.context.drawImage(this.offscreenCanvas,0,0,this.charWidth,this.charHeight,this.gridXPos,this.gridYPos,e,t);if(this.cursorPixelX!==false&&this.cursorPixelY!==false){var i=this.scale;var r=this.scale;var a=this.gridXPos+this.scale*this.cursorPixelX;var s=this.gridYPos+this.scale*this.cursorPixelY;var o="cccccc";if(this.multicolor){i*=2}else{}this.context.fillStyle="#"+o;this.context.globalAlpha=.5;this.context.fillRect(a,s,i,r);this.context.globalAlpha=1}this.drawGrid()}};var DbgC64Colors=function(){this.prefix="dbg";this.visible=false;this.currentColor=false;this.colorPaletteLoad=null;this.palettes=[{name:"ccs64",colors:[4279242768,4294967295,4282400992,4294967136,4292894944,4282441792,4292886592,4282449919,4282425568,4282938524,4288717055,4283716692,4287137928,4288741280,4294942880,4290822336]},{name:"colodore",colors:[4278190080,4294967295,4281873281,4291350133,4288101518,4283280470,4288359470,4285657581,4280897678,4278204501,4285623492,4283058762,4286282619,4288675753,4293619056,4289901234]},{name:"frodo",colors:[4278190080,4294967295,4278190284,4291624704,4294902015,4278242304,4291559424,4278255615,4278225151,4278207624,4287138047,4282664004,4287137928,4287168392,4294936712,4291611852]},{name:"pepto-pal",colors:[4278190080,4294967295,4281022312,4289897584,4286987631,4282617176,4286130229,4285515704,4280635247,4278204739,4284049306,4282664004,4285295724,4286894746,4290076268,4287993237]}]};DbgC64Colors.prototype={init:function(e){if(typeof e.prefix){this.prefix=e.prefix}this.colorPaletteLoad=new ColorPaletteLoad},buildInterface:function(e){var t=this;this.uiComponent=UI.create("UI.Panel");e.add(this.uiComponent);var i="";i+='<div style="position: absolute; top: 0; bottom: 0; left: 0; right: 0; overflow: auto; padding: 8px">';i+='<div style="font-size: 0">';for(var r=0;r<8;r++){var a=r;i+='<div class="'+this.prefix+'colors" data-colorindex="'+a+'" style="display: inline-block; width: 32px; height: 32px; background-color: #cccccc; border: 2px solid #000000" id="'+this.prefix+"Color"+a+'"></div>'}i+="</div>";i+="<div>";for(var r=0;r<8;r++){var a=8+r;i+='<div class="'+this.prefix+'colors" data-colorindex="'+a+'" style="display: inline-block; width: 32px; height: 32px; background-color: #cccccc; border: 2px solid #000000" id="'+this.prefix+"Color"+a+'"></div>'}i+="</div>";i+="<div>";i+='<h3 id="'+this.prefix+'colorHeading" style="border-bottom: 0">Color</h3>';i+="<div>";i+='  <input type="color" id="'+this.prefix+'ColorControl" class="'+this.prefix+'ColorControl"  value="#ff0000">';i+="</div>";i+="</div>";i+='<form id="'+this.prefix+'PaletteForm">';i+='<input class="formControl"  id="'+this.prefix+'PaletteFile" type="file"  style="position: absolute; top: -50px; left: -100px" accept=".png,.json,.aco,.act,.ase,.gpl,.txt,.hex,.vpl,.jpg,.jpeg"/>';i+="</form>";i+="<div>";i+='<div style="margin-top: 14px; padding-top: 8px; border-top: 1px solid #222222">';i+='<div class="ui-button" style="margin-right: 6px" id="'+this.prefix+'ResetCurrentColor">Reset Current Colour</div>';i+='<div class="ui-button" style="margin-right: 6px" id="'+this.prefix+'ResetAllColors">Reset All Colours</div>';i+='<div class="ui-button" id="'+this.prefix+'LoadPalette">Load Palette...</div>';i+="</div>";i+="<div>";i+="<label>Palette: ";i+='<select id="'+this.prefix+'PaletteSelect">';for(var r=0;r<this.palettes.length;r++){i+='<option value="'+r+'" ';if(this.palettes[r].name=="colodore"){i+=' selected="selected" '}i+=">"+this.palettes[r].name+"</option>"}i+="</select>";i+="</label>";i+="</div>";i+="</div>";i+="</div>";this.htmlPanel=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.add(this.htmlPanel);UI.on("ready",function(){t.initEvents()})},initEvents:function(){var i=this;$("#"+this.prefix+"ResetCurrentColor").on("click",function(){i.resetColor(i.currentColor)});$("#"+this.prefix+"ResetAllColors").on("click",function(){for(var e=0;e<16;e++){i.resetColor(e)}});$("#"+this.prefix+"LoadPalette").on("click",function(){i.choosePaletteFile()});$("."+this.prefix+"colors").on("click",function(){var e=$(this).attr("data-colorindex");i.selectColor(e)});$("."+this.prefix+"ColorControl").on("change",function(){var e=$(this).val();var t=i.currentColor;i.setColor(t,e)});$("."+this.prefix+"ColorControl").on("input",function(){var e=$(this).val();var t=i.currentColor;i.setColor(t,e)});$("."+this.prefix+"ColorReset").on("click",function(){var e=$(this).attr("data-colorindex");i.resetColor(e)});$("#"+this.prefix+"PaletteSelect").on("change",function(){var e=parseInt($(this).val(),10);if(isNaN(e)){return}i.selectPalette(e)});document.getElementById(this.prefix+"PaletteFile").addEventListener("change",function(e){var t=document.getElementById(i.prefix+"PaletteFile").files[0];i.setImportFile(t)})},selectPalette:function(e){var t=this.palettes[e].colors;console.log(t);for(var i=0;i<t.length;i++){c64.colors.setColor(i,t[i]);this.updateColor(i)}},setImportFile:function(e){var l=this;this.colorPaletteLoad.setImportFile(e,function(e){if(e){console.log(e);var t=e.length;if(t>16){t=16}for(var i=0;i<t;i++){var r=e[i]>>16&255;var a=e[i]>>8&255;var s=e[i]&255;var o=r&255;o+=(a&255)<<8;o+=(s&255)<<16;o=(o>>>0)+4278190080;c64.colors.setColor(i,o);l.updateColor(i)}}})},choosePaletteFile:function(){document.getElementById(this.prefix+"PaletteForm").reset();$("#"+this.prefix+"PaletteFile").click()},selectColor:function(e){this.currentColor=e;$("#"+this.prefix+"colorHeading").html("Colour "+e);var t=c64.colors.getColor(e)&16777215;var i=t&255;var r=t>>8&255;var a=t>>16&255;i=("00"+i.toString(16)).substr(-2);r=("00"+r.toString(16)).substr(-2);a=("00"+a.toString(16)).substr(-2);t="#"+i+r+a;$("#"+this.prefix+"ColorControl").val(t);$("."+this.prefix+"colors").css("border","2px solid transparent");$("#"+this.prefix+"Color"+e).css("border","2px solid #cccccc")},resetColor:function(e){c64.colors.resetColor(e);this.setVisible(true)},setColor:function(e,t){e=parseInt(e,10);if(isNaN(e)){return}if(t.length==0){return}if(t[0]=="#"){t=t.substr(1)}if(t.length!=6){return}var i=parseInt(t.substr(0,2),16);var r=parseInt(t.substr(2,2),16);var a=parseInt(t.substr(4,2),16);if(isNaN(i)||isNaN(r)||isNaN(a)){return}var t=i&255;t+=(r&255)<<8;t+=(a&255)<<16;t=(t>>>0)+4278190080;c64.colors.setColor(e,t);this.updateColor(e)},updateColor:function(e){var t=c64.colors.getColor(e)&16777215;var i=t&255;var r=t>>8&255;var a=t>>16&255;i=("00"+i.toString(16)).substr(-2);r=("00"+r.toString(16)).substr(-2);a=("00"+a.toString(16)).substr(-2);t="#"+i+r+a;$("#"+this.prefix+"Color"+e).css("background-color",t)},setVisible:function(e){this.visible=e;if(e){if(this.currentColor===false){this.selectColor(0)}for(var t=0;t<16;t++){var i=c64.colors.getColor(t)&16777215;var r=i&255;var a=i>>8&255;var s=i>>16&255;r=("00"+r.toString(16)).substr(-2);a=("00"+a.toString(16)).substr(-2);s=("00"+s.toString(16)).substr(-2);i="#"+r+a+s;console.log("color = "+i);$("#"+this.prefix+"Color"+t).css("background-color",i)}}},update:function(){}};var DbgSID=function(){this.machine=null;this.visible=true;this.canvas=null;this.context=null;this.offscreenCanvas=null;this.offscreenContext=null;this.offscreenImageData=null;this.charEditor=null;this.bitmapAddress=false;this.fgColor=6;this.bgColor=14;this.highlightChar=false;this.prefix="";this.mouseRasterY=0;this.mouseRasterX=0};DbgSID.prototype={init:function(e){this.machine=e.machine;this.debugger=e.debugger;this.prefix=e.prefix;this.canvasElementId=this.prefix+"SIDCanvas"},setVisible:function(e){this.visible=e;if(e){this.forceRedraw()}},getVisible:function(){return this.visible},buildInterface:function(e){this.uiComponent=UI.create("UI.SplitPanel");e.add(this.uiComponent);this.bitmapSplitPanel=UI.create("UI.SplitPanel");var t="";t+='<div class="panelFill">';t+="</div>";var i=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.addNorth(i,40,false);this.uiComponent.add(this.bitmapSplitPanel);this.scrollCanvas=UI.create("UI.CanvasScrollPanel",{id:this.prefix+"SIDCanvas"});this.bitmapSplitPanel.add(this.scrollCanvas);t="";t+='<div class="panelFill">';for(var r=0;r<4;r++){var a=r+1;t+='      <label class="cb-container">Voice '+a;t+='        <input type="checkbox" id="'+this.prefix+"SIDVoice_"+r+'" checked="checked" value="1">';t+='        <span class="checkmark"></span>';t+="      </label>"}t+="</div>";this.htmlSouthPanel=UI.create("UI.HTMLPanel",{html:t});this.bitmapSplitPanel.addSouth(this.htmlSouthPanel,65,false);var s=this;UI.on("ready",function(){s.initContent();s.initEvents()})},resizeCanvas:function(){this.context=UI.getContextNoSmoothing(this.scrollCanvas.getCanvas())},resize:function(){},initContent:function(){this.canvas=this.scrollCanvas.getCanvas();this.canvasElementId=this.canvas.id},initEvents:function(){var t=this;this.scrollCanvas.draw=function(e){t.draw(e)};for(var e=0;e<3;e++){$("#"+this.prefix+"SIDVoice_"+e).on("click",function(){t.setActiveVoices()})}},setActiveVoices:function(){for(var e=0;e<3;e++){if($("#"+this.prefix+"SIDVoice_"+e).is(":checked")){sid_setVoiceEnabled(e,1)}else{sid_setVoiceEnabled(e,0)}}},mouseDown:function(e){},mouseMove:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top},mouseUp:function(e){},mouseLeave:function(e){},forceRedraw:function(){if(this.scrollCanvas){this.scrollCanvas.resize()}this.lastWidth=false;this.lastHeight=false},drawChannel:function(e){this.audioBufferLength=4096;for(var t=0;t<4;t++){var i=sid_getAudioBufferCh(t);var r=new Float32Array(c64.HEAPF32.subarray(i>>2,(i>>2)+this.audioBufferLength));var a=0;var s=2.8;var o=this.scrollCanvas.getWidth();var l=this.scrollCanvas.getHeight();var n=4;s=l/280;var h=50*s+60*t*s;var d=Math.floor(this.audioBufferLength/(o*n));if(d==0){d=1}var c=Math.floor(this.audioBufferLength/2);while(r[c]<2&&c<this.audioBufferLength+500){c++}while(r[c]>=1.95&&c<this.audioBufferLength+500){c++}c-=Math.floor(this.audioBufferLength/2);var f=0;a=Math.floor(c+f)%this.audioBufferLength;var u=-1;var p=h+r[0];e.strokeStyle="#ffffff";e.beginPath();e.moveTo(u,p);for(var v=1;v<this.audioBufferLength;v+=d){u++;p=r[a]*s+h;a=(a+d)%this.audioBufferLength;e.lineTo(u,p)}e.stroke()}},draw:function(e){this.context=e;if(this.context){this.context.fillStyle="#111111";this.context.fillRect(0,0,this.canvas.width,this.canvas.height);this.drawChannel(e)}},update:function(){if(this.visible){this.scrollCanvas.render()}}};var DbgSprites=function(){this.machine=null;this.visible=true;this.context=null;this.offscreenCanvas=null;this.offscreenContext=null;this.offscreenImageData=null;this.spritesLocation=false;this.spriteEditor=null;this.lastWidth=false;this.lastHeight=false;this.lastScrollY=false;this.prefix="";this.spritePositions=[];this.rasterY=false;this.showSprites="mouse";this.exportSpriteData=null};DbgSprites.prototype={init:function(e){this.machine=e.machine;this.debugger=e.debugger;this.prefix=e.prefix;var t=g_app.dbgFont;t.createFonts();this.fontCanvas=t.fontCanvas;this.hexNumberCanvas=t.hexNumberCanvas[0];this.setFontMetrics();this.spriteEditor=new DbgC64SpriteEditor;this.spriteEditor.init(this,e)},setFontMetrics:function(){var e=g_app.dbgFont;this.fontCharWidth=e.fontCharWidth;this.fontCharHeight=e.fontCharHeight;this.hexNumberPositions=e.hexNumberPositions;this.cmdPositions=e.cmdPositions;this.lineHeight=this.fontCharHeight+4*UI.devicePixelRatio;this.cmdPositionX=23*this.fontCharWidth;this.cyclesPositionX=19*this.fontCharWidth;this.opCodePositionX=this.breakpointColWidth+this.fontCharWidth*4+20},setVisible:function(e){this.visible=e},getVisible:function(){return this.visible},undo:function(){this.spriteEditor.undo()},redo:function(){this.spriteEditor.redo()},buildInterface:function(e){this.uiComponent=UI.create("UI.SplitPanel");e.add(this.uiComponent);this.spriteSplitPanel=UI.create("UI.SplitPanel");var t="";t+='<div class="panelFill">';t+='<div style="margin-top: 6px">';t+="Sprites At ";t+='<label class="rb-container" style="margin-right: 4px">Mouse Location';t+='<input name="'+this.prefix+'ShowSprites" type="radio" checked="checked" value="mouse" id="'+this.prefix+'SpritesMouseLocation">';t+='<span class="checkmark"></span>';t+="</label>";t+='<label class="rb-container" style="margin-right: 4px">At Raster Y';t+='<input name="'+this.prefix+'ShowSprites" type="radio" value="raster" id="'+this.prefix+'SpritesAtRasterY">';t+='<span class="checkmark"></span>';t+="</label>";t+='<label class="rb-container" style="margin-right: 4px">Memory';t+='<input name="'+this.prefix+'ShowSprites" type="radio" value="memory" id="'+this.prefix+'SpritesInMemory">';t+='<span class="checkmark"></span>';t+="</label>";t+="</div>";t+="<div>";t+='<label id="'+this.prefix+'SpriteMouseInfo"><span class="ui-text-label">Raster Y </span><span size="4" id="'+this.prefix+'SpritesRasterY"></span>  (click to set)</label>';t+='<label id="'+this.prefix+'SpriteRasterYInfo" style="display: none" class="ui-text-label">Raster Y <input class="number" size="4" id="'+this.prefix+'SpritesRasterYInput"/></label>';t+='<label id="'+this.prefix+'SpriteMemoryInfo" style="display: none" class="ui-text-label"> <input class="number" size="4" id="'+this.prefix+'SpritesMemoryInput"/></label>';t+="</div>";t+='<div id="'+this.prefix+'SpriteInfo">';t+="</div>";t+="</div>";var i=UI.create("UI.HTMLPanel",{html:t});this.uiComponent.addNorth(i,70,false);this.uiComponent.add(this.spriteSplitPanel);this.editorPanel=UI.create("UI.Panel");this.spriteSplitPanel.addNorth(this.editorPanel,280,true,false);this.spriteEditor.buildInterface(this.editorPanel);this.scrollCanvas=UI.create("UI.CanvasScrollPanel",{id:this.prefix+"SpriteCanvas"});this.spriteSplitPanel.add(this.scrollCanvas);t="";t='<div class="panelFill">';t+='<div style="margin-top: 4px">';t+='<label class="cb-container" style="margin-right: 4px">';t+='<input type="checkbox" value="mouse" class="showMouseInfo"  id="'+this.prefix+'spritesMouseInspect"><span class="checkmark"></span>';t+='<span class="cb-label">Mouse Inspect</span>';t+="</label>";t+='<label class="cb-container" style="margin-right: 4px; display: inline-block">';t+='<input type="checkbox" value="mouse" id="'+this.prefix+'showSpriteEditor"><span class="checkmark"></span>';t+='<span class="cb-label">Show Sprite Editor</span>';t+="</label>";t+='<div class="ui-button" id="'+this.prefix+'exportSpriteData">Export Data...</div>';t+="</div>";t+="</div>";this.htmlPanel=UI.create("UI.HTMLPanel",{html:t});this.spriteSplitPanel.addSouth(this.htmlPanel,30,false);var r=this;this.htmlPanel.on("resize",function(){r.resize()});var r=this;UI.on("ready",function(){r.initContent();r.initEvents()})},initContent:function(){this.spriteWidth=24;this.spriteHeight=21;this.showSpriteEditor(false);this.offscreenCanvas=document.createElement("canvas");this.offscreenCanvas.width=this.spriteWidth;this.offscreenCanvas.height=this.spriteHeight;this.offscreenContext=this.offscreenCanvas.getContext("2d");this.offscreenImageData=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)},showSpriteEditor:function(e){this.spriteSplitPanel.setPanelVisible("north",e);var t=$("#"+this.prefix+"showSpriteEditor");if(t!=null&&typeof t.length!="undefined"){t.prop("checked",e)}if(e){this.spriteEditor.updateColors()}},doExportSpriteData:function(){if(this.exportSpriteData==null){this.exportSpriteData=new ExportC64SpriteData}this.exportSpriteData.show()},initEvents:function(){var t=this;$("#"+this.prefix+"spritesMouseInspect").on("click",function(){t.debugger.showMouseInfo($(this).is(":checked"))});$("#"+this.prefix+"showSpriteEditor").on("click",function(){t.showSpriteEditor($(this).is(":checked"))});$("#"+this.prefix+"exportSpriteData").on("click",function(){t.doExportSpriteData()});$("input[name="+this.prefix+"ShowSprites]").on("click",function(){var e=$("input[name="+t.prefix+"ShowSprites]:checked").val();t.setShowSprites(e)});this.scrollCanvas.draw=function(e){t.draw(e)};this.scrollCanvas.on("resize",function(){t.doClear()});this.scrollCanvas.on("dblclick",function(e){t.dblClick(e)});this.scrollCanvas.on("mousedown",function(e){t.mouseDown(e)});this.scrollCanvas.on("mousemove",function(e){t.mouseMove(e)});this.scrollCanvas.on("mouseup",function(e){t.mouseUp(e)})},setRasterY:function(e){this.rasterY=parseInt(e,10);if(isNaN(e)){return}$("#"+this.prefix+"SpritesRasterYInput").val(e)},setShowSprites:function(e){$("input[name="+this.prefix+"ShowSprites][value="+e+"]").prop("checked",true);this.showSprites=e;$("#"+this.prefix+"SpriteMouseInfo").hide();$("#"+this.prefix+"SpriteRasterYInfo").hide();$("#"+this.prefix+"SpriteMemoryInfo").hide();if(e=="memory"){$("#"+this.prefix+"SpriteMemoryInfo").show();this.setSpritesCurrent(false)}else{this.setSpritesCurrent(true)}if(e=="raster"){$("#"+this.prefix+"SpriteRasterYInfo").show()}if(e=="memory"){$("#"+this.prefix+"SpriteMemoryInfo").show()}},setSpritesLocation:function(e){this.lastScrollY=false;if(this.spritesLocation===false){return}this.spritesLocation=e},setSpritesCurrent:function(e){this.lastScrollY=false;if(e){this.spritesLocation=false}else{this.spritesLocation=8192}},resize:function(){var e=$("#dbgSpritePanel");var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}},doClear:function(){this.context=this.scrollCanvas.getContext();this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false},drawSprite:function(e,t,i,r,a,s,o){var l=c64.colors.colors;var n=[];n.push(l[a]&16777215);n.push(l[s]&16777215);n.push(l[0]&16777215);n.push(l[o]&16777215);var h=e;var d=e.width;var c=e.height;for(var f=0;f<21;f++){n[2]=l[r];dstPos=f*d*4;for(var u=0;u<3;u++){var p=c64_vicReadAbsolute(t++);for(var v=7;v>=0;v--){var g=p>>>v&1;if(i){var m=0;if(g){m+=2}v--;var y=p>>>v&1;if(y){m+=1}var b=n[m];h.data[dstPos++]=b&255;h.data[dstPos++]=b>>8&255;h.data[dstPos++]=b>>16&255;h.data[dstPos++]=255;h.data[dstPos++]=b&255;h.data[dstPos++]=b>>8&255;h.data[dstPos++]=b>>16&255;h.data[dstPos++]=255}else{var C=l[a];if(g){C=l[r]}h.data[dstPos++]=C&255;h.data[dstPos++]=C>>8&255;h.data[dstPos++]=C>>16&255;h.data[dstPos++]=255}}}}},drawSpritesAtMemoryLocation:function(e){var t=this.scrollCanvas;var i=t.getWidth();var r=t.getHeight();var a=t.getScrollY();e.fillStyle="#222222";e.fillRect(0,0,i,r);var s=false;var o=1;var l=0;var n=2;var h=3;var d=6;var c=6;var f=this.offscreenCanvas.width*2*UI.devicePixelRatio;var u=this.offscreenCanvas.height*2*UI.devicePixelRatio;var p=f+16;this.spriteYSpacing=u+this.lineHeight+10;var v=this.fontCharWidth*4+16;if(v>p){p=v}var g=Math.floor(i/p);var m=Math.ceil(r/this.spriteYSpacing);var y=Math.floor(a/this.spriteYSpacing)*g*64;a=a%this.spriteYSpacing;var b=g*(m+1);var C=Math.ceil(65535/(g*64))*this.spriteYSpacing;this.scrollCanvas.setContentHeight(C);this.spritePositions=[];for(var x=0;x<b;x++){this.drawSprite(this.offscreenImageData,y,s,o,l,n,h);this.offscreenContext.putImageData(this.offscreenImageData,0,0);this.spritePositions.push({x:d,y:c-a,width:f,height:u,address:y});this.context.drawImage(this.offscreenCanvas,d,c-a,f,u);var S=y.toString(16);var P=S;this.drawLine(P,d,c+u+4-a);d+=p;if(d+p>i){d=6;c+=this.spriteYSpacing}y+=64;if(y>65535){break}}},dblClick:function(e){if(!this.scrollCanvas){return}this.canvas=this.scrollCanvas.getCanvas();this.canvasElementId=this.canvas.id;var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;for(var r=0;r<this.spritePositions.length;r++){if(t>=this.spritePositions[r].x&&t<this.spritePositions[r].x+this.spritePositions[r].width&&i>=this.spritePositions[r].y&&i<this.spritePositions[r].y+this.spritePositions[r].height){var a=this.spritePositions[r].address;this.spriteEditor.setSpriteAddress(a);break}}this.showSpriteEditor(true)},mouseDown:function(e){if(!this.scrollCanvas){return}this.canvas=this.scrollCanvas.getCanvas();this.canvasElementId=this.canvas.id;var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;t=t*UI.devicePixelRatio;i=i*UI.devicePixelRatio;for(var r=0;r<this.spritePositions.length;r++){if(t>=this.spritePositions[r].x&&t<this.spritePositions[r].x+this.spritePositions[r].width&&i>=this.spritePositions[r].y&&i<this.spritePositions[r].y+this.spritePositions[r].height){var a=this.spritePositions[r].address;this.spriteEditor.setSpriteAddress(a);break}}},mouseMove:function(e){},mouseUp:function(e){},forceRedraw:function(){if(this.scrollCanvas){this.scrollCanvas.resize()}this.lastWidth=false;this.lastHeight=false},debuggerMousePosition:function(e,t){this.mouseRasterX=e;this.mouseRasterY=t},debuggerMouseLeave:function(){this.mouseRasterX=false;this.mouseRasterY=false},debuggerMouseDown:function(){this.setShowSprites("raster");this.setRasterY(this.mouseRasterY)},drawCurrentSprites:function(e){this.context=e;var t=this.scrollCanvas;var i=t.getWidth();var r=t.getHeight();var a=-t.getScrollY();if(a!==this.lastScrollY||i!==this.lastWidth||r!==this.lastHeight){this.lastScrollY=a;this.lastWidth=i;this.lastHeight=r;this.doClear()}e.fillStyle="#000000";e.fillRect(0,0,i,r);var s=(this.fontCharHeight+4+(this.fontCharHeight+2)*4+20)*8;this.scrollCanvas.setContentHeight(s);var o=0;var l=[];var n=false;var h=this.mouseRasterY;if(this.showSprites=="raster"){h=this.rasterY}if(h!==false){for(var d=0;d<64;d++){l[d]=c64_vicReadRegisterAt(h,this.mouseRasterX,d)}n=c64_cia2ReadRegisterAt(h,this.mouseRasterX,0)}else{for(var d=0;d<64;d++){l[d]=c64_vicReadRegister(d)}n=c64_cpuReadNS(56576)}switch(n&3){case 0:o=49152;break;case 1:o=32768;break;case 2:o=16384;break;case 3:o=0;break}var c=l[16];var f=l[21];var u=l[24];var p=l[28];var v=l[33];var g=l[37];var m=l[38];var y=o+((u&240)>>4)*1024;var b=[];var C=v&15;var x=g&15;var S=m&15;var P="";P+=" VIC Bank: 0x"+("0000"+o.toString(16)).substr(-4);P+=" MC1: 0x"+("00"+x.toString(16)).substr(-2);P+=", MC2: 0x"+("00"+S.toString(16)).substr(-2);if(h!==false){P+="<div>";P+="Raster Y:"+h;P+="</div>"}$("#"+this.prefix+"SpriteInfo").html(P);var w=6;var I=6;var k="";var M=this.offscreenCanvas.width*3*UI.devicePixelRatio;var T=this.offscreenCanvas.height*3*UI.devicePixelRatio;var D=p;var E=y+1016;this.spritePositions=[];for(var d=0;d<8;d++){if(h!==false){b[d]=c64_debugger_get_sprite_pointer(d)}else{b[d]=c64_vicReadAbsolute(y+1016+d)}var _=o+b[d]*64;var B=(D>>>d&1)!==0;var R=l[39+d]&15;k="SPRITE "+d;this.drawLine(k,w,I+a);I+=this.fontCharHeight+4;this.drawSprite(this.offscreenImageData,_,B,R,C,x,S);this.offscreenContext.putImageData(this.offscreenImageData,0,0);this.spritePositions.push({x:w,y:I+a,width:i,height:T,address:_});this.context.drawImage(this.offscreenCanvas,w,I+a,M,T);w+=M+10;var A=w;var F=I;k="POINTER ";this.context.globalAlpha=.5;this.drawLine(k,w,I+a);this.context.globalAlpha=1;k="$"+b[d].toString(16);var L=_.toString(16);k+=" ($"+L+")";this.drawLine(k,w+8*this.fontCharWidth,I+a);I+=this.fontCharHeight+2;w=A;k="ENABLED ";this.context.globalAlpha=.5;this.drawLine(k,w,I+a);this.context.globalAlpha=1;k="NO";if(f&1<<d){k="YES"}this.drawLine(k,w+8*this.fontCharWidth,I+a);I+=this.fontCharHeight+2;w=A;k="MONOCHROME";if(D&1<<d){k="MULTICOLOUR"}this.drawLine(k,w+8*this.fontCharWidth,I+a);I+=this.fontCharHeight+2;w=A;var U=l[d*2];if(c&1<<d){U+=256}k="X ";this.context.globalAlpha=.5;this.drawLine(k,w,I+a);this.context.globalAlpha=1;k=U.toString();this.drawLine(k,w+2*this.fontCharWidth,I+a);w+=this.fontCharWidth*9;var H=l[d*2+1];k="Y ";this.context.globalAlpha=.5;this.drawLine(k,w,I+a);this.context.globalAlpha=1;k=H.toString();this.drawLine(k,w+2*this.fontCharWidth,I+a);I+=this.fontCharHeight+2;w=6;I+=20;if(I+a>r){break}}},drawLine:function(e,t,i){var r=this.fontCharWidth;var a=this.fontCharHeight;var s=e.length;for(var o=0;o<s;o++){var l=e.charCodeAt(o);srcX=l*r;srcY=0;srcWidth=r;srcHeight=a;dstX=t+o*r;dstY=i;dstWidth=r;dstHeight=a;this.context.drawImage(this.fontCanvas,srcX,srcY,srcWidth,srcHeight,dstX,dstY,dstWidth,dstHeight)}},draw:function(e){this.setFontMetrics();this.context=e;if(this.spritesLocation!==false){this.drawSpritesAtMemoryLocation(e)}else{this.drawCurrentSprites(e)}},update:function(){if(this.visible){this.scrollCanvas.render()}this.spriteEditor.draw()}};var ExportC64SpriteData=function(){this.editor=null;this.textEditor=null;this.lineIncrement=10;this.lineNumber=10};ExportC64SpriteData.prototype={init:function(e){this.editor=e},show:function(){var t=this;if(this.uiComponent==null){this.uiComponent=UI.create("UI.Dialog",{id:"exportC64SpriteDataDialog",title:"Export Sprite Data",width:800,height:600});this.htmlComponent=UI.create("UI.HTMLPanel");this.uiComponent.add(this.htmlComponent);this.htmlComponent.load("html/c64/exportC64SpriteData.html",function(){t.initContent();t.initEvents()});this.displayButton=UI.create("UI.Button",{text:'<img src="icons/svg/glyphicons-basic-614-copy.svg"/> Copy To Clipboard',color:"primary"});this.uiComponent.addButton(this.displayButton);this.displayButton.on("click",function(e){t.copyToClipboard()});this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()})}else{this.initContent()}UI.showDialog("exportC64SpriteDataDialog")},initContent:function(){if(this.textEditor==null){this.textEditor=ace.edit("exportC64SpriteDataSource");this.textEditor.getSession().setTabSize(2);this.textEditor.getSession().setUseSoftTabs(true);this.textEditor.on("focus",function(){g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)});this.textEditor.on("blur",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});var e="ace/mode/assembly_6502";if(this.mode=="javascript"){e="ace/mode/javascript"}this.textEditor.getSession().setMode(e);this.textEditor.setShowInvisibles(false)}},download:function(){var e=$("#exportSpriteDataAs").val();var t=this.textEditor.getValue();download(t,e,"application/txt")},copyToClipboard:function(){var e=this.textEditor.selection.toJSON();this.textEditor.selectAll();this.textEditor.focus();document.execCommand("copy");this.textEditor.selection.fromJSON(e)},initEvents:function(){var e=this;$("#exportSpriteDataFrom").on("change",function(){e.exportData()});$("#exportSpriteDataTo").on("change",function(){e.exportData()});$("#exportSpriteDataFrom").on("keyup",function(){e.exportData()});$("#exportSpriteDataTo").on("keyup",function(){e.exportData()});$("#exportC64SpriteDataDownload").on("click",function(){e.download()});$("#exportSpriteLineNumber").on("change",function(){e.exportData()});$("#exportSpriteLineNumber").on("keyup",function(){e.exportData()})},exportData:function(){var e=parseInt($("#exportSpriteDataFrom").val(),16);var t=parseInt($("#exportSpriteDataTo").val(),16);var i=parseInt($("#exportSpriteLineNumber").val(),10);if(isNaN(e)||isNaN(t)||isNaN(i)){return}if(t<e){return}this.generateBasic({lineNumber:i,from:e,to:t})},getLine:function(e){var t=this.lineNumber+" "+e+"\n";this.lineNumber+=this.lineIncrement;return t},toHex:function(e,t){if(t==2){return("00"+e.toString(16)).substr(-2).toUpperCase()}return("0000"+e.toString(16)).substr(-4).toUpperCase()},generateBasic:function(e){var t=8;var i=e.from;var r=e.to;this.lineNumber=e.lineNumber;var a="";var s=[];for(var o=i;o<r;o++){s.push(c64_vicReadAbsolute(o));if(s.length%t==0){if(s.length!=0){a+=this.getLine("DATA "+s.join(","));s=[]}}}if(s.length!=0){a+=this.getLine("DATA "+s.join(","));s=[]}this.textEditor.setValue(a,-1)}};var DbgC64SpriteEditor=function(){this.canvas=null;this.offscreenCanvas=null;this.context=null;this.spriteAddress=8192;this.dbgSprites=null;this.spriteWidth=24;this.spriteHeight=21;this.canvasElementId="dbgC64SpriteEditorCanvas";this.multicolor=false;this.buttons=0;this.drawMode=false;this.spriteColor=1;this.bgColor=0;this.mc1Color=2;this.mc2Color=3;this.lastPixelAddress=false;this.lastPixelX=false;this.historyPosition=0;this.history=[];this.historyEntry=[]};DbgC64SpriteEditor.prototype={init:function(e,t){this.dbgSprites=e;this.debugger=t.debugger;this.prefix=t.prefix},buildInterface:function(e){this.canvasElementId=this.prefix+"SpriteEditorCanvas";var t="";t='<div class="panelFill" id="'+this.prefix+'SpriteEditorPanel">';t+='  <div style="position: absolute; top: 0; left: 0; right: 0; height: 30px">';t+='    <div id="'+this.prefix+'SpriteEditorAddress" style="font-size: 24px; font-weight: 300"></div>';t+="  </div>";t+='  <div style="position: absolute; top: 30px; left: 0; right: 0; bottom: 38px">';t+='    <canvas id="'+this.canvasElementId+'" style="background-color: #333333" width="256" height="256"></canvas>';t+="  </div>";t+='  <div style="position: absolute; left: 0; right: 0; bottom: 0px; height: 38px">';t+="    <div>";t+='      <label class="cb-container" style="margin-right: 4px; display: inline-block">';t+="Multicolour";t+='      <input type="checkbox" value="mouse" class="showMouseInfo"  id="'+this.prefix+'SpriteEditorMulti"><span class="checkmark"></span>';t+="</label>";t+="    </div>";t+='    <div id="'+this.prefix+'SpriteEditorMultiControls" style="display: none">';t+='      <label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Background";t+='      <input type="radio" class="showMouseInfo"  name="'+this.prefix+'SpriteEditorMultiMode" id="'+this.prefix+'SpriteEditorMultiModeErase" value="erase"><span class="checkmark"></span>';t+='<div id="'+this.prefix+'SpriteEditorColorBg" style="display: inline-block; width: 16px; height: 16px; background-color: #555555"></div>';t+="</label>";t+='      <label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Invididual";t+='      <input type="radio" class="showMouseInfo"  name="'+this.prefix+'SpriteEditorMultiMode" id="'+this.prefix+'SpriteEditorMultiModeDraw" value="draw"><span class="checkmark"></span>';t+='<div id="'+this.prefix+'SpriteEditorColorBg" style="display: inline-block; width: 16px; height: 16px; background-color: #555555"></div>';t+="</label>";t+='      <label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Multi 1";t+='      <input type="radio" class="showMouseInfo"  name="'+this.prefix+'SpriteEditorMultiMode" id="'+this.prefix+'SpriteEditorMultiModeMulti1" value="multi1"><span class="checkmark"></span>';t+='<div id="'+this.prefix+'SpriteEditorColorMulti1" style="display: inline-block; width: 16px; height: 16px; background-color: #555555"></div>';t+="</label>";t+='      <label class="rb-container" style="margin-right: 4px; display: inline-block">';t+="Multi 2";t+='      <input type="radio" class="showMouseInfo"  name="'+this.prefix+'SpriteEditorMultiMode" id="'+this.prefix+'SpriteEditorMultiModeMulti2" value="multi2"><span class="checkmark"></span>';t+='<div id="'+this.prefix+'SpriteEditorColorMulti2" style="display: inline-block; width: 16px; height: 16px; background-color: #555555"></div>';t+="</label>";t+="    </div>";t+="  </div>";t+="</div>";t+="</div>";this.htmlPanel=UI.create("UI.HTMLPanel",{html:t});e.add(this.htmlPanel);var i=this;this.htmlPanel.on("resize",function(){i.resize()});this.canvasScale=Math.floor(UI.devicePixelRatio);var i=this;UI.on("ready",function(){i.initContent();i.initEvents()})},initContent:function(){if(this.canvas==null){this.canvas=document.getElementById(this.canvasElementId)}if(this.offscreenCanvas==null){this.offscreenCanvas=document.createElement("canvas");this.offscreenCanvas.width=this.spriteWidth;this.offscreenCanvas.height=this.spriteHeight;this.offscreenContext=this.offscreenCanvas.getContext("2d");this.offscreenImageData=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)}this.resize()},setDrawMode:function(e){this.drawMode=e;$("input[name="+this.prefix+"SpriteEditorMultiMode][value="+e+"]").prop("checked",true)},initEvents:function(){var t=this;$("#"+this.prefix+"SpriteEditorMulti").on("click",function(){t.setMulticolor($(this).is(":checked"))});$("input[name="+this.prefix+"SpriteEditorMultiMode]").on("click",function(){var e=$("input[name="+t.prefix+"SpriteEditorMultiMode]:checked").val();t.setDrawMode(e)});$("#"+this.canvasElementId).on("mousedown",function(e){t.mouseDown(e)});$("#"+this.canvasElementId).on("mousemove",function(e){t.mouseMove(e)});$("#"+this.canvasElementId).on("mouseup",function(e){t.mouseUp(e)});$("#"+this.canvasElementId).on("mouseleave",function(e){t.mouseLeave(e)});$("#"+this.canvasElementId).on("contextmenu",function(e){e.preventDefault()});$("#"+this.canvasElementId).on("mouseenter",function(e){t.mouseEnter(e)})},getPixel:function(e,t){var i=this.spriteAddress+t*3+Math.floor(e/8);var r=this.debugger.readByte(i);e=7-e%8;var a=r&1<<e;if(a){return 1}return 0},setPixel:function(){var e=this.cursorPixelX;var t=this.cursorPixelY;var i=this.spriteAddress+t*3+Math.floor(e/8);var r=c64_vicReadAbsolute(i);var a=r;if(this.lastPixelAddress===i&&this.lastPixelX===e){return}this.lastPixelAddress=i;this.lastPixelX=e;if(this.multicolor){e=e%8;e=6-e%8;var s=0;switch(this.drawMode){case"erase":s=0;break;case"draw":s=2;break;case"multi1":s=1;break;case"multi2":s=3;break}r=r&~(3<<e);r=r|s<<e}else{e=7-e%8;if(this.drawMode=="draw"){r=r|1<<e}if(this.drawMode=="erase"){r=r&(255^1<<e)}}this.debugger.writeByte(i,r);this.historyEntry.push({address:i,prev:a,value:r})},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){this.buttons=2}if(e.metaKey&&this.buttons==1){this.buttons=4}},mouseDown:function(e){this.setButtons(e);if(this.buttons&1){UI.captureMouse(this);this.historyEntry=[];if(this.cursorPixelX!==false&&this.cursorPixelY!==false){if(!this.multicolor){if(this.getPixel(this.cursorPixelX,this.cursorPixelY)){this.drawMode="erase"}else{this.drawMode="draw"}}this.setPixel();this.draw()}}},mouseMove:function(e){var t=e.pageX-$("#"+this.canvasElementId).offset().left;var i=e.pageY-$("#"+this.canvasElementId).offset().top;t=t*this.canvasScale;i=i*this.canvasScale;if(t>this.gridXPos&&t<this.gridXPos+this.spriteWidth*this.scale&&i>this.gridYPos&&i<this.gridYPos+this.spriteHeight*this.scale){var r=Math.floor((t-this.gridXPos)/this.scale);var a=Math.floor((i-this.gridYPos)/this.scale);if(r!==this.cursorPixelX||a!==this.cursorPixelY){this.cursorPixelX=r;this.cursorPixelY=a;if(this.multicolor){this.cursorPixelX=Math.floor(this.cursorPixelX/2)*2}if(this.buttons&1){if(this.cursorPixelX!==false&&this.cursorPixelY!==false){this.setPixel()}}this.draw()}}},mouseUp:function(e){this.buttons=0;this.lastPixelAddress=false;this.lastPixelX=false;this.history.length=this.historyPosition;this.history.push(this.historyEntry);this.historyPosition++;this.historyEntry=[]},mouseEnter:function(e){},undo:function(){this.lastPixelAddress=false;this.lastPixelX=false;if(this.historyPosition<=0){return}this.historyPosition--;if(this.historyPosition>=this.history.length){return}var e=this.history[this.historyPosition];for(var t=e.length-1;t>=0;t--){this.debugger.writeByte(e[t].address,e[t].prev)}},redo:function(){if(this.historyPosition>=this.history.length){console.log("no history");return}var e=this.history[this.historyPosition];for(var t=0;t<e.length;t++){this.debugger.writeByte(e[t].address,e[t].value)}this.historyPosition++},mouseLeave:function(e){this.cursorPixelX=false;this.cursorPixelY=false},resize:function(){this.canvasScale=Math.floor(UI.devicePixelRatio);var e=$("#"+this.prefix+"SpriteEditorPanel");var t=e.offset();if(t){this.left=t.left;this.top=t.top;this.width=e.width();this.height=e.height()}var i=this.height-72;this.canvas.width=this.width*UI.devicePixelRatio;this.canvas.height=i*UI.devicePixelRatio;this.canvas.style.width=this.width+"px";this.canvas.style.height=i+"px";this.context=this.canvas.getContext("2d");this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;this.scale=Math.floor(this.canvas.height/this.spriteHeight);this.gridXPos=0;this.gridYPos=0},setMulticolor:function(e){this.multicolor=e;$("#"+this.prefix+"SpriteEditorMulti").prop("checked",e);if(this.multicolor){this.setDrawMode("draw");$("#"+this.prefix+"SpriteEditorMultiControls").prop("checked",this.multicolor);$("#"+this.prefix+"SpriteEditorMultiControls").show()}else{$("#"+this.prefix+"SpriteEditorMultiControls").hide()}this.draw()},setSpriteAddress:function(e){this.history=[];this.spriteAddress=e;this.draw();var t=("0000"+e.toString(16)).substr(-4);$("#"+this.prefix+"SpriteEditorAddress").html("$"+t)},setColor:function(e,t){var i=c64.colors.getColor(t)&16777215;var r=i&255;var a=i>>8&255;var s=i>>16&255;r=("00"+r.toString(16)).substr(-2);a=("00"+a.toString(16)).substr(-2);s=("00"+s.toString(16)).substr(-2);i="#"+r+a+s;$("#"+this.prefix+"SpriteEditorColor"+e).css("background-color",i)},updateColors:function(){this.setColor("Bg",this.bgColor);this.setColor("Fg",this.spriteColor);this.setColor("Multi1",this.mc1Color);this.setColor("Multi2",this.mc2Color)},drawSprite:function(){this.dbgSprites.drawSprite(this.offscreenImageData,this.spriteAddress,this.multicolor,this.spriteColor,this.bgColor,this.mc1Color,this.mc2Color);this.offscreenContext.putImageData(this.offscreenImageData,0,0)},drawGrid:function(){var e=1;var t=this.scale;var i=this.scale;this.context.strokeStyle=styles.textMode.tileEditorGridLines;this.context.beginPath();if(this.multicolor){e=2}for(var r=0;r<=this.spriteWidth;r+=e){this.context.moveTo(this.gridXPos+r*t+.5,this.gridYPos+0);this.context.lineTo(this.gridXPos+r*t+.5,this.gridYPos+this.spriteHeight*i)}for(var r=0;r<=this.spriteHeight;r++){this.context.moveTo(this.gridXPos+0,this.gridYPos+r*i+.5);this.context.lineTo(this.gridXPos+this.spriteWidth*t,this.gridYPos+r*i+.5)}this.context.stroke();this.context.strokeStyle="#555555";this.context.beginPath();for(var r=8;r<this.spriteWidth;r+=8){this.context.moveTo(this.gridXPos+r*t+.5,this.gridYPos+0);this.context.lineTo(this.gridXPos+r*t+.5,this.gridYPos+this.spriteHeight*i)}for(var r=8;r<this.spriteHeight;r+=8){this.context.moveTo(this.gridXPos+0,this.gridYPos+r*i+.5);this.context.lineTo(this.gridXPos+this.spriteWidth*t,this.gridYPos+r*i+.5)}this.context.stroke()},draw:function(){this.drawSprite();var e=this.spriteWidth*this.scale;var t=this.spriteHeight*this.scale;this.context.drawImage(this.offscreenCanvas,0,0,this.spriteWidth,this.spriteHeight,this.gridXPos,this.gridYPos,e,t);if(this.cursorPixelX!==false&&this.cursorPixelY!==false){var i=this.scale;var r=this.scale;var a=this.gridXPos+this.scale*this.cursorPixelX;var s=this.gridYPos+this.scale*this.cursorPixelY;var o="cccccc";if(this.multicolor){i*=2}else{}this.context.fillStyle="#"+o;this.context.globalAlpha=.5;this.context.fillRect(a,s,i,r);this.context.globalAlpha=1}this.drawGrid()}};var MOS6510AddressingModes={};MOS6510AddressingModes.IMMED=0;MOS6510AddressingModes.ABSOL=1;MOS6510AddressingModes.ZEROP=2;MOS6510AddressingModes.IMPLI=3;MOS6510AddressingModes.INDIA=4;MOS6510AddressingModes.ABSIX=5;MOS6510AddressingModes.ABSIY=6;MOS6510AddressingModes.ZEPIX=7;MOS6510AddressingModes.ZEPIY=8;MOS6510AddressingModes.INDIN=9;MOS6510AddressingModes.ININD=10;MOS6510AddressingModes.RELAT=11;MOS6510AddressingModes.ACCUM=12;var MOS6510Cycles={};MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE=1;MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE=2;var MOS6510OpcodeCmds=[{cmd:"ADC",name:"ADd with Carry",desc:"Adds the byte held in the accumulator with that held in the memory address specified together with the carry bit. If overflow occurs the carry bit is set",flags:"NVZC",flagInfo:{N:"Set if bit 7 set",V:"Set if sign bit is incorrect",Z:"Set if A = 0",C:"Set if overflow in bit 7"}},{cmd:"AND",name:"Logic AND",desc:"Performs a bit-wise boolean 'and' between the eight bits in the operand and the eight bits of the accumulator",flags:"NZ",flagInfo:{N:"Set if bit 7 set",Z:"Set if A = 0"}},{cmd:"ANC",name:"AND, ASL/ROL",desc:"Illegal Opcode:  ANDs the contents of the A register with an immediate value and then moves bit 7 of A into the Carry flag. ",flags:"NZ",flagInfo:{N:"Set if bit 7 set",Z:"Set if A = 0"}},{cmd:"ASL",name:"Arithmetic Shift Left",desc:"Shifts all the bits of the accumulator or memory contents one bit left. Bit 0 is set to 0 and bit 7 is placed in the carry flag.",flags:"NZC",flagInfo:{N:"Set if bit 7 of the result is set",Z:"Set if A = 0",C:"Set to contents of old bit 7"}},{cmd:"ALR",name:"AND then Logical shift Right",desc:"Illegal Opcode:  AND then Logical shift Right ",flags:"NZC",flagInfo:{N:"Always cleared",Z:"Set if the result is zero, or cleared if it is non-zero.",C:"Has the value of accumulator's bit 0 if bit 0 of the mask is 1 or cleared otherwise"}},{cmd:"BCC",name:"Branch if Carry is Clear",desc:"Branches to the address specified if, and only if the carry flag is clear.",flags:"none"},{cmd:"BCS",name:"Branch if Carry is Set",desc:"Branches to the address specified if, and only if the carry flag is set",flags:"none"},{cmd:"BEQ",name:"Branch if EQual",desc:"Branches to the address specified if, and only if the zero flag is set",flags:"none"},{cmd:"BIT",name:"BIT test",desc:"Test if one or more bits are set in a target memory location. The mask pattern in A is ANDed with the value in memory to set or clear the zero flag, the result is not kept",flags:"NVZ",flagInfo:{N:"Set to bit 7 of the memory value",V:"Set to bit 6 of the memory value",Z:"Set if the result of the AND is zero"}},{cmd:"BMI",name:"Branch if MInus",desc:"Branches to the address specified if, and only if the negative flag is set",flags:"none"},{cmd:"BNE",name:"Branch if Not Equal",desc:"Branches to the address specified if, and only if the zero flag is clear",flags:"none"},{cmd:"BPL",name:"Branch if PLus",desc:"Branches to the address specified if, and only if the negative flag is clear.",flags:"none"},{cmd:"BRK",name:"BReaKpoint",desc:"Sets the break and interrupt flags, increments the program counter by two and stores it along with the processor status flags onto the stack. Finally it raises an IRQ interrupt event.",flags:"B",flagInfo:{B:"Set to 1"}},{cmd:"BVC",name:"Branch if oVerflow Clear",desc:"Branches to the address specified if, and only if the overflow flag is clear.",flags:"none"},{cmd:"BVS",name:"Branch if oVerflow Set",desc:"Branches to the address specified if, and only if the overflow flag is set",flags:"none"},{cmd:"CLC",name:"CLear Carry",desc:"Clears the carry flag.",flags:"C",flagInfo:{C:"Set to 0"}},{cmd:"CLD",name:"CLear Decimal flag",desc:"Clears the decimal flag",flags:"D",flagInfo:{D:"Set to 0"}},{cmd:"CLI",name:"CLear Interrupt flag",desc:"Clears the interrupt flag",flags:"I",flagInfo:{I:"Set to 0"}},{cmd:"CLV",name:"CLear oVerflow",desc:"clears the Overflow flag",flags:"V",flagInfo:{V:"Set to 0"}},{cmd:"CMP",name:"CoMPare",desc:"Compares the contents of the accumulator against that of the specified operand by subtracting operand from accumulator value, and setting the negative and carry flags according to the result",flags:"NZC",flagInfo:{N:"Set if bit 7 of the result is set",Z:"Set if A is equal",C:"Set if A is greater or equal"}},{cmd:"CPX",name:"ComPare X",desc:"Compares the contents of the X index register against that of the specified operand by subtracting the latter from the former, and setting the negative and carry flags according to the result",flags:"NZC",flagInfo:{N:"Set if bit 7 of the result is set",Z:"Set if X is equal",C:"Set if X is greater or equal"}},{cmd:"CPY",name:"ComPare Y",desc:"Compares the contents of the Y index register against that of the specified operand by subtracting the latter from the former, and setting the negative and carry flags according to the result. ",flags:"NZC",flagInfo:{N:"Set if bit 7 of the result is set",Z:"Set if Y is equal",C:"Set if Y is greater or equal"}},{cmd:"DEC",name:"DECrease",desc:"Decrements the numerical value of the contents of the address specified, by one, and 'wraps over' if the value goes below the numerical limits of a byte",flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"DEX",name:"DEcrement X register",desc:"Decrements the content of the X Register by 1",flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"DEY",name:"DEcrement Y register",desc:"Decrements the content of the Y Register by 1",flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"EOR",name:"Exclusive OR",desc:'Performs a bit-wise boolean "Exclusive-or" between each of the eight bits in the accumulator and their corresponding bits in the memory address specified. The eight resulting bits form a byte, which is stored in the accumulator.',flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"INC",name:"INCrease",desc:'Increases the numerical value of the contents of the address specified by one, and "wraps over" when the numerical limits of a byte are exceeded',flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"INX",name:"INcrease X",desc:'Increases the numerical value held in the X index register by one, and "wraps over" when the numerical limits of a byte are exceeded.',flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"INY",name:"INcrease Y",desc:'Increases the numerical value held in the Y index register by one, and "wraps over" when the numerical limits of a byte are exceeded.',flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"JMP",name:"JuMP",desc:"Unconditionally transfers program execution to the specified address.",flags:"none"},{cmd:"JSR",name:"Jump to SubRoutine",desc:"Calls a subroutine",flags:"none"},{cmd:"LAX",name:"LDA, LDX",desc:"Illegal Opcode:  Combination of LDA and LDX ",flags:"NZC",flagInfo:{N:"Always cleared",Z:"Set if the result is zero, or cleared if it is non-zero.",C:"Has the value of accumulator's bit 0 if bit 0 of the mask is 1 or cleared otherwise"}},{cmd:"LDA",name:"LoaD Accumulator",desc:"Retrieves a copy from the specified RAM or I/O address, and stores it in the accumulator.",flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"LDX",name:"LoaD X register",desc:"Retrieves a copy from the specified RAM or I/O address, and stores it in the X register.",flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"LDY",name:"LoaD Y register",desc:"Retrieves a copy from the specified RAM or I/O address, and stores it in the Y register.",flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"LSR",name:"Logic Shift Right",desc:"Shifts the bits in either the accumulator or a specified address in RAM, one bit position towards the right, or least significant end of the byte. The bit previously held at the least significant position is shifted out of the byte, and into the carry flag, whereas the most significant bit, left empty by the shift operation, is filled in with a zero bit.",flags:"NZC",flagInfo:{N:"Set to 0",Z:"Cleared unless the operand is zero",C:"Set to the least significant bit (bit 0) of the operand prior to shifting"}},{cmd:"NOP",name:"No OPeration",desc:"Causes no changes to the processor other than the normal incrementing of the program counter to the next instruction",flags:"none"},{cmd:"ORA",name:"Logical OR on Accumulator",desc:'Performs a bit-wise boolean "or" between each of the eight bits in the accumulator and their corresponding bits in the memory address specified. The eight resulting bits form a byte, which is stored in the accumulator.',flags:"NZ",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero"}},{cmd:"PHA",name:"PusH Accumulator",desc:"Stores a copy of the current content of the accumulator onto the stack and adjusts the stack pointer to reflect the addition.",flags:""},{cmd:"PHP",name:"PusH Processor flags",desc:"Stores the current state of the processor status flags onto the stack and adjusts the stack pointer to reflect the addition.",flags:""},{cmd:"PLA",name:"PulL Accumulator",desc:"Retrieves a byte from the stack and stores it in the accumulator, and adjusts the stack pointer to reflect the removal of that byte",flags:""},{cmd:"PLP",name:"PulL Processor flags",desc:"Retrieves a set of status flags  from the stack, and adjusts the stack pointer to reflect the removal of a byte.",flags:""},{cmd:"RLA",name:"RoL with And",desc:"Illegal Opcode:  ROLs the contents of a memory location and then ANDs the result with the accumulator.",flags:"NZC",flagInfo:{}},{cmd:"ROL",name:"ROtate Left",desc:"Shifts the bits in either the accumulator or a specified address in RAM, one bit position towards the left, or most significant end of the byte. The least significant bit, left empty by the shift operation, is filled in with the bit held in the carry flag prior to the ROL instruction, and the excess bit that gets pushed out of the most significant end, is subsequently placed in the carry flag.",flags:"NZC",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero",C:"Set to contents of old bit 7"}},{cmd:"ROR",name:"ROtate Right",desc:"Shifts the bits in either the accumulator or a specified address in RAM, one bit position towards the right, or least significant end of the byte. The most significant bit, is set to the value in the carry flag. Similarly, what was the least significant bit in the byte prior to the shifting, will subsequently be rotated into the carry flag.",flags:"NZC",flagInfo:{N:"Set if the result is negative",Z:"Set if the result is zero",C:"Set to contents of old bit 0"}},{cmd:"RTI",name:"ReTurn from Interrupt",desc:'returns the CPU from an interrupt service routine to the "mainline" program that was interrupted. It does this by pulling first the processor status flags (similar to PLP), and then the program counter, from the stack, effectively handling program execution back to the address pulled from the stack.',flags:"NVBDIZC"},{cmd:"RTS",name:"ReTurn from Subroutine",desc:"Returns the CPU from a subroutine to the part of the program which initially called the subroutine;",flags:""},{cmd:"SBC",name:"SuBtract with Carry",desc:'subtracts the byte held at the specified memory address, from the one currently held in the accumulator, leaving the result in the accumulator: The state of the carry flag before the subtraction takes place, is taken as an incoming "borrow" flag in the computation',flags:"NVZC",flagInfo:{N:"Set if the result is negative",V:" set if the operation results in an overflow",Z:"Set if the result is zero",C:"Clear if overflow in bit 7"}},{cmd:"SBX",name:"CMP, DEX",desc:"Illegal Opcode:  Combination of CMP and DEX",flags:"NZ",flagInfo:{N:"Set if bit 7 set",Z:"Set if A = 0"}},{cmd:"SEC",name:"SEt Carry",desc:"Unconditionally sets the carry flag",flags:"C",flagInfo:{C:"Set unconditionally"}},{cmd:"SED",name:"SEt Decimal flag",desc:"Sets the decimal flag",flags:"D",flagInfo:{D:"Set unconditionally"}},{cmd:"SEI",name:"SEt Interrupt flag",desc:"Sets the interrupt flag, thereby preventing the CPU from responding to IRQ interrupt events",flags:"I",flagInfo:{I:"Set unconditionally"}},{cmd:"SLO",name:"AND, ASL/ROL",desc:"Illegal Opcode:  ANDs the contents of the A register with an immediate value and then moves bit 7 of A into the Carry flag. ",flags:"NZ",flagInfo:{N:"Set if bit 7 set",Z:"Set if A = 0"}},{cmd:"STA",name:"STore Accumulator",desc:"Stores a copy of the byte held in the accumulator at the RAM or I/O address specified.",flags:""},{cmd:"STX",name:"STore X",desc:"Stores a copy of the byte held in the X register at the RAM or I/O address specified",flags:""},{cmd:"STY",name:"STore Y",desc:"Stores a copy of the byte held in the Y index register at the RAM or I/O address specified",flags:""},{cmd:"TAX",name:"Transfer Accumulator to X",desc:"Copies the contents of the accumulator to the X register.",flags:"NZ",flagInfo:{N:"Set if the byte transferred is negative",Z:"Set if the byte transferred is zeroy"}},{cmd:"TAY",name:"Transfer Accumulator to Y",desc:"Copies the contents of the accumulator to the Y register.",flags:"NZ",flagInfo:{N:"Set if the byte transferred is negative",Z:"Set if the byte transferred is zeroy"}},{cmd:"TSX",name:"Transfer Stack pointer to X",desc:"Copies the contents of the stack pointer into the X index register.",flags:"NZ",flagInfo:{N:"Set if the byte transferred is negative",Z:"Set if the byte transferred is zeroy"}},{cmd:"TXA",name:"Transfer X to Accumulator",desc:"Copies the contents of the X register into the accumulator.",flags:"NZ",flagInfo:{N:"Set if the byte transferred is negative",Z:"Set if the byte transferred is zeroy"}},{cmd:"TXS",name:"Transfer X to Stack pointer",desc:"Copies the contents of the X index register into the stack pointer",flags:""},{cmd:"TYA",name:"Transfer Y to Accumulator",desc:"Copies the contents of the Y index register into the accumulator.",flags:"NZ",flagInfo:{N:"Set if the byte transferred is negative",Z:"Set if the byte transferred is zeroy"}},{cmd:"???",name:"",desc:"",flags:""}];var MOS6510Opcodes=[{opcode:0,cmd:"BRK",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:7},{opcode:1,cmd:"ORA",example:"",addressing:MOS6510AddressingModes.INDIN,bytes:2,cycles:6},{opcode:2,cmd:"???",bytes:1},{opcode:3,cmd:"SLO",bytes:2,illegal:true,addressing:MOS6510AddressingModes.INDIN},{opcode:4,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:5,cmd:"ORA",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:6,cmd:"ASL",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:5},{opcode:7,cmd:"SLO",bytes:2,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:8,cmd:"PHP",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:3},{opcode:9,cmd:"ORA",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:10,cmd:"ASL",example:"",addressing:MOS6510AddressingModes.ACCUM,bytes:1,cycles:2},{opcode:11,cmd:"ANC",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:12,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSOL},{opcode:13,cmd:"ORA",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:14,cmd:"ASL",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:6},{opcode:15,cmd:"SLO",bytes:3,illegal:true,addressing:MOS6510AddressingModes.ABSOL},{opcode:16,cmd:"BPL",example:"",addressing:MOS6510AddressingModes.RELAT,bytes:2,cycles:2,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE|MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE},{opcode:17,cmd:"ORA",example:"",addressing:MOS6510AddressingModes.ININD,bytes:2,cycles:5,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:18,cmd:"???",bytes:1},{opcode:19,cmd:"SLO",bytes:2,illegal:true,addressing:MOS6510AddressingModes.ININD},{opcode:20,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:21,cmd:"ORA",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:22,cmd:"ASL",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:6},{opcode:23,cmd:"SLO",bytes:2,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:24,cmd:"CLC",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:25,cmd:"ORA",example:"",addressing:MOS6510AddressingModes.ABSIY,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:26,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMPLI},{opcode:27,cmd:"SLO",bytes:3,illegal:true,addressing:MOS6510AddressingModes.ABSIY},{opcode:28,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:29,cmd:"ORA",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:30,cmd:"ASL",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:7},{opcode:31,cmd:"SLO",bytes:3,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:32,cmd:"JSR",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:6},{opcode:33,cmd:"AND",example:"",addressing:MOS6510AddressingModes.INDIN,bytes:2,cycles:6},{opcode:34,cmd:"???",bytes:1},{opcode:35,cmd:"RLA",bytes:2,illegal:true,cycles:8},{opcode:36,cmd:"BIT",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:37,cmd:"AND",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:38,cmd:"ROL",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:5},{opcode:39,cmd:"RLA",bytes:2,illegal:true,cycles:5},{opcode:40,cmd:"PLP",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:4},{opcode:41,cmd:"AND",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:42,cmd:"ROL",example:"",addressing:MOS6510AddressingModes.ACCUM,bytes:1,cycles:2},{opcode:43,cmd:"ANC",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:44,cmd:"BIT",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:45,cmd:"AND",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:46,cmd:"ROL",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:6},{opcode:47,cmd:"RLA",bytes:3,cycles:6,illegal:true},{opcode:48,cmd:"BMI",example:"",addressing:MOS6510AddressingModes.RELAT,bytes:2,cycles:2,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE|MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE},{opcode:49,cmd:"AND",example:"",addressing:MOS6510AddressingModes.ININD,bytes:2,cycles:5,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:50,cmd:"???",bytes:1},{opcode:51,cmd:"RLA",bytes:2,illegal:true,cycles:8},{opcode:52,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:53,cmd:"AND",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:54,cmd:"ROL",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:6},{opcode:55,cmd:"RLA",bytes:2,illegal:true,cycles:6},{opcode:56,cmd:"SEC",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:57,cmd:"AND",example:"",addressing:MOS6510AddressingModes.ABSIY,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:58,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMPLI},{opcode:59,cmd:"RLA",bytes:3,cycles:7,illegal:true},{opcode:60,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:61,cmd:"AND",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:62,cmd:"ROL",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:7},{opcode:63,cmd:"RLA",bytes:3,cycles:7,illegal:true},{opcode:64,cmd:"RTI",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:6},{opcode:65,cmd:"EOR",example:"",addressing:MOS6510AddressingModes.INDIN,bytes:2,cycles:6},{opcode:66,cmd:"???",bytes:1},{opcode:67,cmd:"SRE",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ININD},{opcode:68,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:69,cmd:"EOR",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:70,cmd:"LSR",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:5},{opcode:71,cmd:"SRE",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:72,cmd:"PHA",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:3},{opcode:73,cmd:"EOR",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:74,cmd:"LSR",example:"",addressing:MOS6510AddressingModes.ACCUM,bytes:1,cycles:2},{opcode:75,cmd:"ALR",bytes:2,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:76,cmd:"JMP",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:3},{opcode:77,cmd:"EOR",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:78,cmd:"LSR",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:6},{opcode:79,cmd:"SRE",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSOL},{opcode:80,cmd:"BVC",example:"",addressing:MOS6510AddressingModes.RELAT,bytes:2,cycles:2,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE|MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE},{opcode:81,cmd:"EOR",example:"",addressing:MOS6510AddressingModes.ININD,bytes:2,cycles:5,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:82,cmd:"???",bytes:1},{opcode:83,cmd:"SRE",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ININD},{opcode:84,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:85,cmd:"EOR",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:86,cmd:"LSR",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:6},{opcode:87,cmd:"SRE",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:88,cmd:"CLI",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:89,cmd:"EOR",example:"",addressing:MOS6510AddressingModes.ABSIY,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:90,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMPLI},{opcode:91,cmd:"SRE",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIY},{opcode:92,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:93,cmd:"EOR",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:94,cmd:"LSR",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:7},{opcode:95,cmd:"SRE",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:96,cmd:"RTS",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:6},{opcode:97,cmd:"ADC",example:"ADC (nn,X)",addressing:MOS6510AddressingModes.INDIN,bytes:2,cycles:6},{opcode:98,cmd:"???",bytes:1},{opcode:99,cmd:"RRA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.INDIN},{opcode:100,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:101,cmd:"ADC",example:"ADC nn",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:102,cmd:"ROR",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:5},{opcode:103,cmd:"RRA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:104,cmd:"PLA",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:4},{opcode:105,cmd:"ADC",example:"ADC #nn",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:106,cmd:"ROR",example:"",addressing:MOS6510AddressingModes.ACCUM,bytes:1,cycles:2},{opcode:107,cmd:"ARR",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:108,cmd:"JMP",example:"",addressing:MOS6510AddressingModes.INDIA,bytes:3,cycles:5},{opcode:109,cmd:"ADC",example:"ADC nnnn",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:110,cmd:"ROR",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:6},{opcode:111,cmd:"RRA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSOL},{opcode:112,cmd:"BVS",example:"",addressing:MOS6510AddressingModes.RELAT,bytes:2,cycles:2,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE|MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE},{opcode:113,cmd:"ADC",example:"ADC (nn),Y",addressing:MOS6510AddressingModes.ININD,bytes:2,cycles:5,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:114,cmd:"???",bytes:1},{opcode:115,cmd:"RRA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ININD},{opcode:116,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:117,cmd:"ADC",example:"ADC nn,X",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:118,cmd:"ROR",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:6},{opcode:119,cmd:"RRA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:120,cmd:"SEI",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:121,cmd:"ADC",example:"",addressing:MOS6510AddressingModes.ABSIY,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:122,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMPLI},{opcode:123,cmd:"RRA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIY},{opcode:124,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:125,cmd:"ADC",example:"ADC nnnn,X",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:126,cmd:"ROR",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:7},{opcode:127,cmd:"RRA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:128,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMPLI},{opcode:129,cmd:"STA",example:"",addressing:MOS6510AddressingModes.INDIN,bytes:2,cycles:6},{opcode:130,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:131,cmd:"SAX",bytes:1,illegal:true,addressing:MOS6510AddressingModes.INDIN},{opcode:132,cmd:"STY",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:133,cmd:"STA",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:134,cmd:"STX",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:135,cmd:"SAX",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:136,cmd:"DEY",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:137,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:138,cmd:"TXA",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:139,cmd:"ANE",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:140,cmd:"STY",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:141,cmd:"STA",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:142,cmd:"STX",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:143,cmd:"SAX",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSOL},{opcode:144,cmd:"BCC",example:"",addressing:MOS6510AddressingModes.RELAT,bytes:2,cycles:2,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE|MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE},{opcode:145,cmd:"STA",example:"",addressing:MOS6510AddressingModes.ININD,bytes:2,cycles:6},{opcode:146,cmd:"???",bytes:1},{opcode:147,cmd:"SHA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ININD},{opcode:148,cmd:"STY",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:149,cmd:"STA",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:150,cmd:"STX",example:"",addressing:MOS6510AddressingModes.ZEPIY,bytes:2,cycles:4},{opcode:151,cmd:"SAX",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:152,cmd:"TYA",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:153,cmd:"STA",example:"",addressing:MOS6510AddressingModes.ABSIY,bytes:3,cycles:5},{opcode:154,cmd:"TXS",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:155,cmd:"SHS",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIY},{opcode:156,cmd:"SHY",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:157,cmd:"STA",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:5},{opcode:158,cmd:"SHX",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:159,cmd:"SHA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:160,cmd:"LDY",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:161,cmd:"LDA",example:"",addressing:MOS6510AddressingModes.INDIN,bytes:2,cycles:6},{opcode:162,cmd:"LDX",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:163,cmd:"LAX",bytes:2,illegal:true,addressing:MOS6510AddressingModes.INDIN},{opcode:164,cmd:"LDY",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:165,cmd:"LDA",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:166,cmd:"LDX",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:167,cmd:"LAX",bytes:2,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:168,cmd:"TAY",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:169,cmd:"LDA",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:170,cmd:"TAX",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:171,cmd:"LXA",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:172,cmd:"LDY",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:173,cmd:"LDA",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:174,cmd:"LDX",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:175,cmd:"LAX",bytes:3,illegal:true,addressing:MOS6510AddressingModes.ABSOL},{opcode:176,cmd:"BCS",example:"",addressing:MOS6510AddressingModes.RELAT,bytes:2,cycles:2,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE|MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE},{opcode:177,cmd:"LDA",example:"",addressing:MOS6510AddressingModes.ININD,bytes:2,cycles:5,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:178,cmd:"???",bytes:1},{opcode:179,cmd:"LAX",bytes:2,illegal:true,addressing:MOS6510AddressingModes.ININD},{opcode:180,cmd:"LDY",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:181,cmd:"LDA",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:182,cmd:"LDX",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:183,cmd:"LAX",bytes:2,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:184,cmd:"CLV",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:185,cmd:"LDA",example:"",addressing:MOS6510AddressingModes.ABSIY,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:186,cmd:"TSX",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:187,cmd:"LAS",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIY},{opcode:188,cmd:"LDY",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:189,cmd:"LDA",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:190,cmd:"LDX",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:191,cmd:"LAX",bytes:3,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:192,cmd:"CPY",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:193,cmd:"CMP",example:"",addressing:MOS6510AddressingModes.INDIN,bytes:2,cycles:6},{opcode:194,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:195,cmd:"DCP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.INDIN},{opcode:196,cmd:"CPY",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:197,cmd:"CMP",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:198,cmd:"DEC",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:5},{opcode:199,cmd:"DCP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:200,cmd:"INY",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:201,cmd:"CMP",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:202,cmd:"DEX",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:203,cmd:"SBX",bytes:2,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:204,cmd:"CPY",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:205,cmd:"CMP",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:206,cmd:"DEC",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:6},{opcode:207,cmd:"DCP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSOL},{opcode:208,cmd:"BNE",example:"",addressing:MOS6510AddressingModes.RELAT,bytes:2,cycles:2,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE|MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE},{opcode:209,cmd:"CMP",example:"",addressing:MOS6510AddressingModes.ININD,bytes:2,cycles:5,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:210,cmd:"???",bytes:1},{opcode:211,cmd:"DCP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ININD},{opcode:212,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:213,cmd:"CMP",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:214,cmd:"DEC",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:6},{opcode:215,cmd:"DCP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:216,cmd:"CLD",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:217,cmd:"CMP",example:"",addressing:MOS6510AddressingModes.ABSIY,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:218,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMPLI},{opcode:219,cmd:"DCP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIY},{opcode:220,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:221,cmd:"CMP",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:222,cmd:"DEC",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:7},{opcode:223,cmd:"DCP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:224,cmd:"CPX",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:225,cmd:"SBC",example:"",addressing:MOS6510AddressingModes.INDIN,bytes:2,cycles:6},{opcode:226,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:227,cmd:"ISB",bytes:1,illegal:true,addressing:MOS6510AddressingModes.INDIN},{opcode:228,cmd:"CPX",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:229,cmd:"SBC",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:3},{opcode:230,cmd:"INC",example:"",addressing:MOS6510AddressingModes.ZEROP,bytes:2,cycles:5},{opcode:231,cmd:"ISB",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSOL},{opcode:232,cmd:"INX",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:233,cmd:"SBC",example:"",addressing:MOS6510AddressingModes.IMMED,bytes:2,cycles:2},{opcode:234,cmd:"NOP",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:235,cmd:"SBC",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMMED},{opcode:236,cmd:"CPX",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:237,cmd:"SBC",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:4},{opcode:238,cmd:"INC",example:"",addressing:MOS6510AddressingModes.ABSOL,bytes:3,cycles:6},{opcode:239,cmd:"ISB",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSOL},{opcode:240,cmd:"BEQ",example:"",addressing:MOS6510AddressingModes.RELAT,bytes:2,cycles:2,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE|MOS6510Cycles.CYCLES_BRANCH_TAKEN_ADDS_ONE},{opcode:241,cmd:"SBC",example:"",addressing:MOS6510AddressingModes.ININD,bytes:2,cycles:5,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:242,cmd:"???",bytes:1},{opcode:243,cmd:"ISB",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ININD},{opcode:244,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEROP},{opcode:245,cmd:"SBC",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:4},{opcode:246,cmd:"INC",example:"",addressing:MOS6510AddressingModes.ZEPIX,bytes:2,cycles:6},{opcode:247,cmd:"ISB",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ZEPIX},{opcode:248,cmd:"SED",example:"",addressing:MOS6510AddressingModes.IMPLI,bytes:1,cycles:2},{opcode:249,cmd:"SBC",example:"",addressing:MOS6510AddressingModes.ABSIY,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:250,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.IMPLI},{opcode:251,cmd:"ISB",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIY},{opcode:252,cmd:"NOP",bytes:1,illegal:true,addressing:MOS6510AddressingModes.ABSIX},{opcode:253,cmd:"SBC",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:4,cycleextra:MOS6510Cycles.CYCLES_CROSS_PAGE_ADDS_ONE},{opcode:254,cmd:"INC",example:"",addressing:MOS6510AddressingModes.ABSIX,bytes:3,cycles:7}];var mos6510examples=[{opcode:"69",example:"ADC #nn",bytes:"2",cycles:"2"},{opcode:"6D",example:"ADC nnnn",bytes:"3",cycles:"4"},{opcode:"7D",example:"ADC nnnn,X",bytes:"3",cycles:"4*"},{opcode:"79",example:"ADC nnnn,Y",bytes:"3",cycles:"4*"},{opcode:"65",example:"ADC nn",bytes:"2",cycles:"3"},{opcode:"75",example:"ADC nn,X",bytes:"2",cycles:"4*"},{opcode:"61",example:"ADC (nn,X)",bytes:"2",cycles:"6"},{opcode:"71",example:"ADC (nn),Y",bytes:"2",cycles:"5*"},{opcode:"29",example:"AND #nn",bytes:"2",cycles:"2"},{opcode:"2D",example:"AND nnnn",bytes:"3",cycles:"4"},{opcode:"3D",example:"AND nnnn,X",bytes:"3",cycles:"4*"},{opcode:"39",example:"AND nnnn,Y",bytes:"3",cycles:"4*"},{opcode:"25",example:"AND nn",bytes:"2",cycles:"3"},{opcode:"35",example:"AND nn,X",bytes:"2",cycles:"4"},{opcode:"21",example:"AND (nn,X)",bytes:"2",cycles:"6"},{opcode:"31",example:"AND (nn),Y",bytes:"2",cycles:"5"},{opcode:"0A",example:"ASL A",bytes:"1",cycles:"2"},{opcode:"0E",example:"ASL nnnn",bytes:"3",cycles:"6"},{opcode:"1E",example:"ASL nnnn,X",bytes:"3",cycles:"7"},{opcode:"06",example:"ASL nn",bytes:"2",cycles:"5"},{opcode:"16",example:"ASL nn,X",bytes:"2",cycles:"6"},{opcode:"90",example:"BCC nn",bytes:"2",cycles:"2*"},{opcode:"B0",example:"BCS nnnn",bytes:"2",cycles:"2*"},{opcode:"F0",example:"BEQ nnnn",bytes:"2",cycles:"2*"},{opcode:"2C",example:"BIT nnnn",bytes:"3",cycles:"4"},{opcode:"24",example:"BIT nn",bytes:"2",cycles:"3"},{opcode:"30",example:"BMI nnnn",bytes:"2",cycles:"2*"},{opcode:"D0",example:"BNE nnnn",bytes:"2",cycles:"2*"},{opcode:"10",example:"BPL nnnn",bytes:"2",cycles:"2*"},{opcode:"00",example:"BRK",bytes:"1",cycles:"7"},{opcode:"50",example:"BVC nnnn",bytes:"2",cycles:"2*"},{opcode:"70",example:"BVS nnnn",bytes:"2",cycles:"2*"},{opcode:"18",example:"CLC",bytes:"1",cycles:"2"},{opcode:"D8",example:"CLD",bytes:"1",cycles:"2"},{opcode:"58",example:"CLI",bytes:"1",cycles:"2"},{opcode:"B8",example:"CLV",bytes:"1",cycles:"2"},{opcode:"C9",example:"CMP #nn",bytes:"2",cycles:"2"},{opcode:"CD",example:"CMP nnnn",bytes:"3",cycles:"4"},{opcode:"DD",example:"CMP nnnn,X",bytes:"3",cycles:"4*"},{opcode:"D9",example:"CMP nnnn,Y",bytes:"3",cycles:"4*"},{opcode:"C5",example:"CMP nn",bytes:"2",cycles:"3"},{opcode:"D5",example:"CMP nn,X",bytes:"2",cycles:"4"},{opcode:"C1",example:"CMP (nn,X)",bytes:"2",cycles:"6"},{opcode:"D1",example:"CMP (nn),Y",bytes:"2",cycles:"5*"},{opcode:"E0",example:"CPX #nn",bytes:"2",cycles:"2"},{opcode:"EC",example:"CPX nnnn",bytes:"3",cycles:"4"},{opcode:"E4",example:"CPX nn",bytes:"2",cycles:"3"},{opcode:"C0",example:"CPY #nn",bytes:"2",cycles:"2"},{opcode:"CC",example:"CPY nnnn",bytes:"3",cycles:"4"},{opcode:"C4",example:"CPY nn",bytes:"2",cycles:"3"},{opcode:"CE",example:"DEC nnnn",bytes:"3",cycles:"6"},{opcode:"DE",example:"DEC nnnn,X",bytes:"3",cycles:"7"},{opcode:"C6",example:"DEC nn",bytes:"2",cycles:"5"},{opcode:"D6",example:"DEC nn,X",bytes:"2",cycles:"6"},{opcode:"88",example:"DEY",bytes:"1",cycles:"2"},{opcode:"49",example:"EOR #nn",bytes:"2",cycles:"2"},{opcode:"4D",example:"EOR nnnn",bytes:"3",cycles:"4"},{opcode:"5D",example:"EOR nnnn,X",bytes:"3",cycles:"4*"},{opcode:"59",example:"EOR nnnn,Y",bytes:"3",cycles:"4*"},{opcode:"45",example:"EOR nn",bytes:"2",cycles:"3"},{opcode:"55",example:"EOR nn,X",bytes:"2",cycles:"4"},{opcode:"41",example:"EOR (nn,X)",bytes:"2",cycles:"6"},{opcode:"51",example:"EOR (nn),Y",bytes:"2",cycles:"5*"},{opcode:"EE",example:"INC nnnn",bytes:"3",cycles:"6"},{opcode:"FE",example:"INC nnnn,X",bytes:"3",cycles:"7"},{opcode:"E6",example:"INC nn",bytes:"2",cycles:"5"},{opcode:"F6",example:"INC nn,X",bytes:"2",cycles:"6"},{opcode:"E8",example:"INX",bytes:"1",cycles:"2"},{opcode:"C8",example:"INY",bytes:"1",cycles:"2"},{opcode:"4C",example:"JMP nnnn",bytes:"3",cycles:"3"},{opcode:"6C",example:"JMP (nnnn)",bytes:"3",cycles:"5"},{opcode:"20",example:"JSR nnnn",bytes:"3",cycles:"6"},{opcode:"A9",example:"LDA #nn",bytes:"2",cycles:"2"},{opcode:"AD",example:"LDA nnnn",bytes:"3",cycles:"4"},{opcode:"BD",example:"LDA nnnn,X",bytes:"3",cycles:"4*"},{opcode:"B9",example:"LDA nnnn,Y",bytes:"3",cycles:"4*"},{opcode:"A5",example:"LDA nn",bytes:"2",cycles:"3"},{opcode:"B5",example:"LDA nn,X",bytes:"2",cycles:"4"},{opcode:"A1",example:"LDA (nn,X)",bytes:"2",cycles:"6"},{opcode:"B1",example:"LDA (nn),Y",bytes:"2",cycles:"5*"},{opcode:"A2",example:"LDX #nn",bytes:"2",cycles:"2"},{opcode:"AE",example:"LDX nnnn",bytes:"3",cycles:"4"},{opcode:"BE",example:"LDX nnnn,Y",bytes:"3",cycles:"4*"},{opcode:"A6",example:"LDX nn",bytes:"2",cycles:"3"},{opcode:"B6",example:"LDX nn,Y",bytes:"2",cycles:"4"},{opcode:"A0",example:"LDY #nn",bytes:"2",cycles:"2"},{opcode:"AC",example:"LDY nnnn",bytes:"3",cycles:"4"},{opcode:"BC",example:"LDY nnnn,X",bytes:"3",cycles:"4*"},{opcode:"A4",example:"LDY nn",bytes:"2",cycles:"3"},{opcode:"B4",example:"LDY nn,X",bytes:"2",cycles:"4"},{opcode:"4A",example:"LSR A",bytes:"1",cycles:"2"},{opcode:"4E",example:"LSR nnnn",bytes:"3",cycles:"6"},{opcode:"5E",example:"LSR nnnn,X",bytes:"3",cycles:"7"},{opcode:"46",example:"LSR nn",bytes:"2",cycles:"5"},{opcode:"56",example:"LSR nn,X",bytes:"2",cycles:"6"},{opcode:"EA",example:"NOP",bytes:"1",cycles:"2"},{opcode:"09",example:"ORA #nn",bytes:"2",cycles:"2"},{opcode:"0D",example:"ORA nnnn",bytes:"3",cycles:"4"},{opcode:"1D",example:"ORA nnnn,X",bytes:"3",cycles:"4*"},{opcode:"19",example:"ORA nnnn,Y",bytes:"3",cycles:"4*"},{opcode:"05",example:"ORA nn",bytes:"2",cycles:"3"},{opcode:"15",example:"ORA nn,X",bytes:"2",cycles:"4"},{opcode:"01",example:"ORA (nn,X)",bytes:"2",cycles:"6"},{opcode:"11",example:"ORA (nn),Y",bytes:"2",cycles:"5"},{opcode:"48",example:"PHA",bytes:"1",cycles:"3"},{opcode:"08",example:"PHP",bytes:"1",cycles:"3"},{opcode:"68",example:"PLA",bytes:"1",cycles:"4"},{opcode:"28",example:"PLP",bytes:"1",cycles:"4"},{opcode:"2A",example:"ROL A",bytes:"1",cycles:"2"},{opcode:"2E",example:"ROL nnnn",bytes:"3",cycles:"6"},{opcode:"3E",example:"ROL nnnn,X",bytes:"3",cycles:"7"},{opcode:"26",example:"ROL nn",bytes:"2",cycles:"5"},{opcode:"36",example:"ROL nn,X",bytes:"2",cycles:"6"},{opcode:"6A",example:"ROR",bytes:"1",cycles:"2"},{opcode:"6E",example:"ROR nnnn",bytes:"3",cycles:"6"},{opcode:"7E",example:"ROR nnnn,X",bytes:"3",cycles:"7"},{opcode:"66",example:"ROR nn",bytes:"2",cycles:"5"},{opcode:"76",example:"ROR nn,X",bytes:"2",cycles:"6"},{opcode:"40",example:"RTI",bytes:"1",cycles:"6"},{opcode:"60",example:"RTS",bytes:"1",cycles:"6"},{opcode:"E9",example:"SBC #nn",bytes:"2",cycles:"2"},{opcode:"ED",example:"SBC nnnn",bytes:"3",cycles:"4"},{opcode:"FD",example:"SBC nnnn,X",bytes:"3",cycles:"4*"},{opcode:"F9",example:"SBC nnnn,Y",bytes:"3",cycles:"4*"},{opcode:"E5",example:"SBC nn",bytes:"2",cycles:"3"},{opcode:"F5",example:"SBC nn,X",bytes:"2",cycles:"4"},{opcode:"E1",example:"SBC (nn,X)",bytes:"2",cycles:"6"},{opcode:"F1",example:"SBC (nn),Y",bytes:"2",cycles:"5*"},{opcode:"38",example:"SEC",bytes:"1",cycles:"2"},{opcode:"F8",example:"SED",bytes:"1",cycles:"2"},{opcode:"78",example:"SEI",bytes:"1",cycles:"2"},{opcode:"8D",example:"STA nnnn",bytes:"3",cycles:"4"},{opcode:"9D",example:"STA nnnn,X",bytes:"3",cycles:"5"},{opcode:"99",example:"STA nnnn,Y",bytes:"3",cycles:"5"},{opcode:"85",example:"STA nn",bytes:"2",cycles:"3"},{opcode:"95",example:"STA nn,X",bytes:"2",cycles:"4"},{opcode:"81",example:"STA (nn,X)",bytes:"2",cycles:"6"},{opcode:"91",example:"STA (nn),Y",bytes:"2",cycles:"6"},{opcode:"8E",example:"STX nnnn",bytes:"3",cycles:"4"},{opcode:"86",example:"STX nn",bytes:"2",cycles:"3"},{opcode:"96",example:"STX nn,Y",bytes:"2",cycles:"4"},{opcode:"8C",example:"STY nnnn",bytes:"3",cycles:"4"},{opcode:"84",example:"STY nn",bytes:"2",cycles:"3"},{opcode:"94",example:"STY nn,X",bytes:"2",cycles:"4"},{opcode:"AA",example:"TAX",bytes:"1",cycles:"2"},{opcode:"A8",example:"TAY",bytes:"1",cycles:"2"},{opcode:"BA",example:"TSX",bytes:"1",cycles:"2"},{opcode:"8A",example:"TXA",bytes:"1",cycles:"2"},{opcode:"9A",example:"TXS",bytes:"1",cycles:"2"},{opcode:"98",example:"TYA",bytes:"1",cycles:"2"}];var MOS6510Bytes=[];for(var i=0;i<65535;i++){MOS6510Bytes[i]=1}for(var i=0;i<mos6510examples.length;i++){var opcode=parseInt(mos6510examples[i].opcode,16);var example=mos6510examples[i].example;var bytes=mos6510examples[i].bytes;var cycles=mos6510examples[i].cycles;var found=false;for(var j=0;j<MOS6510Opcodes.length;j++){if(MOS6510Opcodes[j].opcode==opcode){MOS6510Opcodes[j].example=example;MOS6510Bytes[opcode]=MOS6510Opcodes[j].bytes;if(bytes!=MOS6510Opcodes[j].bytes){}found=true;break}}if(!found){console.log("NOT FOUND!!!!! "+mos6510examples[i].opcode)}}var REGA=0;var REGX=1;var REGY=2;var REGSP=3;var sampleC64DebuggerScript=["// sample script (ES6)","","// set the border colour","c64.cpuWrite(0xd020, 0);","","// set the background colour","c64.cpuWrite(0xd021, 11);","","// counter","let counter = 1;","","// event handler for start of new frame","c64.on('frame', () => {","","  for(let i = 0; i < 1000; i++) {","    // set screen char","    c64.cpuWrite(0x400 + i, counter);","","    // set fg colour","    c64.cpuWrite(0xd800 + i, i % 16);","  }","","  counter = (counter + 1) % 256;","});",""].join("\n");function onC64Ready(){if(typeof g_app!="undefined"&&typeof g_app.c64Debugger!="undefined"){g_app.c64Debugger.onC64Ready()}}var C64Debugger=function(){this.uiComponent=null;this.disassembly=null;this.c64Memory=null;this.c64Registers=null;this.breakpoints=null;this.c64Charset=null;this.c64Bitmap=null;this.c64Sprites=null;this.c64Drive=null;this.c64SID=null;this.scripting=null;this.basic=null;this.colors=null;this.onscreenJoystick=null;this.overlayOnscreenJoystick=null;this.onscreenKeyboard=null;this.lastDriveStatus=false;this.lastDrivePosition=false;this.c64Focus=true;this.prgFile=null;this.prgName="test.prg";this.prgLoadMethod="inject";this.prgData=null;this.d64Data=null;this.d64Name="";this.crtData=null;this.crtName="";this.prefix="c64pre";this.showRaster=false;this.c64Size=1;this.c64Fit=false;this.c64FitPixel=false;this.joystickPort=0;this.lastUpdate=getTimestamp();this.offscreenCanvas=null;this.imageData=null;this.pcBreakpoints=[];this.memoryBreakpoints=[];this.rasterYBreakpoints=[];this.type="normal";this.c64CanvasId="c64DebuggerCanvas";this.runningButtons=false;this.assemblerReport=false;this.mouseX=false;this.mouseY=false;this.mouseZoom=4;this.mouseInfo=false;this.mouseC64X=0;this.mouseC64Y=0;this.mouseLocked=false;this.lockedMouseX=0;this.lockedMouseY=0;this.buttons=0;this.grid=false;this.fontSize=12;this.overlayVisible=true;this.prgToStart=null;this.crtToStart=null;this.d64ToStart=null;this.snapshotToStart=null;this.exportAsHTML=null;this.panelVisible={disassembly:false,scripting:false,basic:false,colors:false,memory:false,charset:false,sprites:false,bitmap:false,sid:false,drive:false,docs:false,calc:false,assembler:false};this.onlyc64Visible=false;this.contentIsSetup=false;this.pcGutterDecoration={session:false,lineNumber:false};this.autostartD64=false;this.assemblerEditor=null;this.gistShare=null;this.driveVisible=false};C64Debugger.prototype={init:function(e){if(typeof e!="undefined"&&typeof e.type!="undefined"){if(e.type=="compact"){this.type="compact";this.prefix="c64compactpre";this.c64CanvasId="c64DebuggerCanvasCompact"}}},setFontSize:function(e){this.fontSize=e;g_app.dbgFont.setFontSize(e);if(this.scripting){this.scripting.codeEditor.setFontSize(e)}if(this.basic){this.basic.codeEditor.setFontSize(e)}if(this.assemblerEditor){this.assemblerEditor.codeEditor.setFontSize(e)}this.resize()},getRandomDelayEnabled:function(){var e=g_app.getPref("c64-randomdelay");return e!="no"},toggleRandomDelay:function(){var e=!this.getRandomDelayEnabled();g_app.setPref("c64-randomdelay",e?"yes":"no");UI("c64debugger-randomdelay").setChecked(e)},setDebuggerScript:function(){var e="/scripts/c64.js"},loadPrefs:function(){var e=g_app.getPref("c64-model");if(typeof e!="undefined"&&e!==null){c64_model=e}this.setPRGLoadMethod(g_app.getPref("c64-prgstart"))},setModel:function(e){c64_model=e;if(e=="pal"){UI("c64debugger-model-ntsc").setChecked(false);UI("c64debugger-model-pal").setChecked(true);c64_setModel(1);g_app.setPref("c64-model",e)}if(e=="ntsc"){UI("c64debugger-model-pal").setChecked(false);UI("c64debugger-model-ntsc").setChecked(true);c64_setModel(2);g_app.setPref("c64-model",e)}var t=g_app.getPref("c64-"+this.prefix+"-size");if(typeof t!="undefined"&&t!==null){this.setSize(t)}if(this.canvas&&this.context){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}},getPRGLoadMethod:function(){return this.prgLoadMethod},setPRGLoadMethod:function(e){if(typeof e=="undefined"||e==null){return}this.prgLoadMethod=e;if(e=="loadrun"){UI("c64debugger-prgloadrun").setChecked(true);UI("c64debugger-prginject").setChecked(false);UI("c64-prgloadrun").setChecked(true);UI("c64-prginject").setChecked(false);g_app.setPref("c64-prgstart","loadrun")}if(e=="inject"){UI("c64debugger-prgloadrun").setChecked(false);UI("c64debugger-prginject").setChecked(true);UI("c64-prgloadrun").setChecked(false);UI("c64-prginject").setChecked(true);g_app.setPref("c64-prgstart","inject")}},setSpeed:function(e){UI("c64debugger-speed-25").setChecked(false);UI("c64debugger-speed-50").setChecked(false);UI("c64debugger-speed-100").setChecked(false);UI("c64debugger-speed-150").setChecked(false);UI("c64debugger-speed-200").setChecked(false);UI("c64debugger-speed-300").setChecked(false);UI("c64debugger-speed-"+e).setChecked(true);console.log("set speed = "+e);debugger_set_speed(e)},setSize:function(e){UI("c64-size-1").setChecked(false);UI("c64-size-2").setChecked(false);UI("c64-size-3").setChecked(false);UI("c64-size-4").setChecked(false);UI("c64-size-fit").setChecked(false);UI("c64-size-fitpixel").setChecked(false);UI("c64debugger-size-1").setChecked(false);UI("c64debugger-size-2").setChecked(false);UI("c64debugger-size-3").setChecked(false);UI("c64debugger-size-4").setChecked(false);UI("c64debugger-size-fit").setChecked(false);UI("c64debugger-size-fitpixel").setChecked(false);if(e=="fit"){UI("c64-size-fit").setChecked(true);UI("c64debugger-size-fit").setChecked(true);this.c64Fit=true;this.c64FitPixel=false;this.resizeC64Panel()}else if(e=="fitpixel"){UI("c64-size-fitpixel").setChecked(true);UI("c64debugger-size-fitpixel").setChecked(true);this.c64FitPixel=true;this.c64Fit=false;this.resizeC64Panel()}else{e=parseInt(e,10);if(isNaN(e)){e=2}this.c64Fit=false;this.c64FitPixel=false;this.c64Size=e;UI("c64-size-"+this.c64Size).setChecked(true);UI("c64debugger-size-"+this.c64Size).setChecked(true)}if(this.offscreenCanvas==null){return}g_app.setPref("c64-"+this.prefix+"-size",e);var t=1;var i=false;if(i){if(c64_model=="pal"){t=.9365}if(c64_model=="ntsc"){t=.75}}this.canvas.width=Math.floor(this.offscreenCanvas.width*this.c64Size*t);this.canvas.height=this.offscreenCanvas.height*this.c64Size;if(t==1||t==.75&&this.c64Size==4){this.context=UI.getContextNoSmoothing(this.canvas)}else{this.context=this.canvas.getContext("2d")}if(this.c64Focus){this.focusMachine()}else{this.blurMachine()}if(c64_ready){this.redraw();if(this.showRaster){this.drawRasterPosition()}}this.setOverlaySize()},readByte:function(e){var t=c64_cpuReadNS(e);return t&255},writeByte:function(e,t){c64_cpuWrite(e,t)},vicReadRegister:function(e){return c64_vicReadRegister(e)&255},vicRead:function(e){return c64_vicReadNS(e)&255},show:function(){if(this.offscreenCanvas==null){this.offscreenCanvas=document.createElement("canvas");this.offscreenCanvas.width=384;this.offscreenCanvas.height=272;this.offscreenContext=this.offscreenCanvas.getContext("2d");this.imageData=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height);this.canvas=document.getElementById(this.c64CanvasId);this.canvas.width=384;this.canvas.height=272;this.context=this.canvas.getContext("2d");var e=g_app.getPref("c64-"+this.prefix+"-size");if(typeof e=="undefined"||e==null){if(g_app.isMobile()||this.type=="compact"){e=1}else{e="fitpixel"}}this.setSize(e);if(g_app.isMobile()){$("#c64DebuggerCanvas").on("contextmenu",function(e){e.preventDefault()});this.canvas.addEventListener("touchstart",function(e){e.preventDefault()},false);this.canvas.addEventListener("touchmove",function(e){e.preventDefault();return false},false);this.canvas.addEventListener("touchend",function(e){e.preventDefault()},false)}this.c64Memory=new DbgMemory;this.c64Memory.init({debugger:this,machine:this.c64,prefix:this.prefix});this.c64Memory.buildInterface(this.memoryPanel);this.disassembly=new DbgDisassembly;this.disassembly.init({prefix:this.prefix,debugger:this,machine:this.c64});this.disassembly.buildInterface(this.disassemblyPanel);this.c64Registers=new DbgRegisters;this.c64Registers.init({canWrite:true,showRasterPosition:true,prefix:this.prefix,debugger:this,machine:this.c64});this.c64Registers.buildInterface(this.registersPanel);this.breakpoints=new DbgBreakpoints;this.breakpoints.init({prefix:this.prefix,debugger:this,machine:this.c64});this.breakpoints.buildInterface(this.breakpointsPanel);this.c64Charset=new DbgCharset;this.c64Charset.init({debugger:this,machine:this.c64,prefix:this.prefix});this.c64Charset.buildInterface(this.charsetPanel);this.c64Sprites=new DbgSprites;this.c64Sprites.init({debugger:this,machine:this.c64,prefix:this.prefix});this.c64Sprites.buildInterface(this.spritesPanel);this.c64Bitmap=new DbgC64Bitmap;this.c64Bitmap.init({debugger:this,machine:this.c64,prefix:this.prefix});this.c64Bitmap.buildInterface(this.bitmapPanel);this.c64SID=new DbgSID;this.c64SID.init({debugger:this,machine:this.c64,prefix:this.prefix});this.c64SID.buildInterface(this.sidPanel);this.c64Drive=new DbgC64Drive;this.c64Drive.init({debugger:this,machine:this.c64,prefix:this.prefix});this.c64Drive.buildInterface(this.drivePanel);this.scripting=new DbgScripting;this.scripting.init({debugger:this,machine:this.c64,prefix:this.prefix});this.scripting.buildInterface(this.scriptingPanel);this.scripting.codeEditor.setFontSize(this.fontSize);this.basic=new DbgC64Basic;this.basic.init({debugger:this,machine:this.c64,prefix:this.prefix});this.basic.buildInterface(this.basicPanel);this.basic.codeEditor.setFontSize(this.fontSize);this.colors=new DbgC64Colors;this.colors.init({debugger:this,machine:this.c64,prefix:this.prefix});this.colors.buildInterface(this.colorsPanel);if(this.type!="compact"){this.calculator=new Calculator;this.calculator.init(this,"c64Debugger");this.calculator.buildInterface(this.calcPanel);this.c64MemoryMap=new C64MemoryMap;this.c64MemoryMap.init(this);this.mos6502Opcodes=new MOS6502Opcodes;this.mos6502Opcodes.init(this,"c64Debugger");this.mos6502Opcodes.buildInterface(this.docsPanel);if(g_app.isMobile()){this.c64Memory.setVisible(false);this.disassembly.setVisible(false);this.c64Registers.setVisible(false);this.breakpoints.setVisible(false);$("#c64JoystickPort").hide()}this.assemblerEditor=new AssemblerEditor;this.assemblerEditor.init();this.assemblerEditor.buildC64DebuggerInterface(this.assemblerPanel);if(g_app.doc.getDocRecord("/asm/main.asm")==null&&g_app.doc.getDocRecord("/asm")!=null){g_app.doc.createDocRecord("/asm","main.asm","asm",c64Asm_example);g_app.doc.createDocRecord("/asm/inc","macros.asm","asm",c64Asm_macro);g_app.doc.createDocRecord("/config","assembler.json","json",'{\n  "assembler": "acme",\n  "arguments": "--format cbm",\n  "files": "main.asm",\n  "output": "out.prg",\n  "target": "c64"\n }')}var t="/asm/main.asm";this.assemblerEditor.showFile(t,0);this.assemblerEditor.codeEditor.setFontSize(this.fontSize);this.onscreenJoystick=new C64OnscreenJoystick;this.onscreenJoystick.init({debugger:this});this.onscreenJoystick.buildInterface(this.mobilePanel);this.onscreenKeyboard=new C64OnscreenKeyboard;this.onscreenKeyboard.init({debugger:this});this.onscreenKeyboard.buildInterface(this.mobilePanel);var i=this;this.mobilePanel.on("resize",function(){i.onscreenJoystick.draw();i.onscreenKeyboard.draw();i.overlayOnscreenJoystick.draw()});var r='<span style="color: white">filepanel!!!!</span>';this.mobileFilePanel=UI.create("UI.HTMLPanel",{id:"c64OnscreenFile",html:r});this.mobilePanel.add(this.mobileFilePanel);r='<div style="padding: 10px; position: absolute; top: 0; bottom: 0; left: 0; right: 0; overflow: auto">';r+="<h3>Sound</h3>";r+='<div class="radioGroup">';r+='<label class="rb-container" style="margin-right: 8px">No Sound<input type="radio" name="c64MobileAudio" id="c64MobileAudioNone" value="0" ><span class="checkmark"></span> </label>';r+='<label class="rb-container" style="margin-right: 8px">6581<input type="radio" checked="checked" name="c64MobileAudio" id="c64MobileAudio6581" value="6581" ><span class="checkmark"></span> </label>';r+='<label class="rb-container" style="margin-right: 8px">8580<input type="radio" name="c64MobileAudio" id="c64MobileAudio8580" value="8580" ><span class="checkmark"></span> </label>';r+="</div>";r+="<h3>Joystick</h3>";r+="<div>";r+='  <div class="radioGroup">';r+='    <label class="rb-container" style="margin-right: 8px">Port 1<input type="radio" name="c64MobileJoystickPort" id="c64MobileJoystickPort_1" value="1" ><span class="checkmark"></span> </label>';r+='    <label class="rb-container" style="margin-right: 8px">Port 2<input type="radio"  checked="checked" name="c64MobileJoystickPort" id="c64MobileJoystickPort_2" value="2" ><span class="checkmark"></span> </label>';r+="  </div>";r+="</div>";r+="<div>";r+='  <div class="radioGroup">';r+='    <label class="rb-container" style="margin-right: 8px">One Button<input type="radio" checked="checked" name="c64MobileJoystickType" id="c64MobileJoystickType_1" value="1" ><span class="checkmark"></span> </label>';r+='    <label class="rb-container" style="margin-right: 8px">Two Button<input type="radio" name="c64MobileJoystickType" id="c64MobileJoystickType_2" value="2" ><span class="checkmark"></span> </label>';r+="  </div>";r+="</div>";r+="<div>";r+="  <div>Button 2:</div>";r+='  <div class="radioGroup">';r+='    <label class="rb-container" style="margin-right: 8px">Up<input type="radio" checked="checked" name="c64MobileJoystickButton2" id="c64MobileJoystickButton2_up" value="up" ><span class="checkmark"></span> </label>';r+='    <label class="rb-container" style="margin-right: 8px">Space Bar<input type="radio" name="c64MobileJoystickButton2" id="c64MobileJoystickButton2_space" value="space" ><span class="checkmark"></span> </label>';r+="  </div>";r+="</div>";r+="</div>";this.mobileSettingsPanel=UI.create("UI.HTMLPanel",{id:"c64OnscreenSettings",html:r});this.mobilePanel.add(this.mobileSettingsPanel);r="<div>";r+='<div style="margin-top: 40px">';r+='  <div class="ui-button" id="c64MobileLoadPRG" style="margin-right: 20px">Load PRG...</div>';r+='  <div class="ui-button" id="c64MobileAttachD64" style="margin-right: 20px">Attach D64...</div>';r+='  <div class="ui-button" id="c64MobileInsertCRT" style="margin-right: 20px">Insert CRT...</div>';r+="</div>";r+='<div style="margin-top: 20px">';r+='  <div class="ui-button" id="c64MobileReset">Reset Machine</div>';r+="</div>";r+="</div>";this.mobileContentPanel=UI.create("UI.HTMLPanel",{id:"c64OnscreenContent",html:r});this.mobilePanel.add(this.mobileContentPanel);this.mobilePanel.showOnly("c64OnscreenJoystick");var i=this;UI.on("ready",function(){i.orientation=window.innerWidth>window.innerHeight?90:0;i.resize();$("input[name=c64MobileAudio]").on("click",function(e){var t=$("input[name=c64MobileAudio]:checked").val();if(t=="0"){if(c64.sound.getAudioEnabled()){c64.sound.stopAudio()}}if(t=="6581"){c64.sound.startAudio();c64.sound.setModel("6581")}if(t=="8580"){c64.sound.startAudio();c64.sound.setModel("8580")}});$("input[name=c64MobileJoystickPort]").on("click",function(e){var t=parseInt($("input[name=c64MobileJoystickPort]:checked").val(),10);if(!isNaN(t)){i.onscreenJoystick.setPort(t);i.overlayOnscreenJoystick.setPort(t)}});$("input[name=c64MobileJoystickType]").on("click",function(e){var t=parseInt($("input[name=c64MobileJoystickType]:checked").val(),10);if(!isNaN(t)){i.onscreenJoystick.setType(t);i.overlayOnscreenJoystick.setType(t)}});$("input[name=c64MobileJoystickButton2]").on("click",function(e){var t=$("input[name=c64MobileJoystickButton2]:checked").val();i.onscreenJoystick.setSecondButton(t);i.overlayOnscreenJoystick.setSecondButton(t)});$("#c64MobileLoadPRG").on("click",function(){i.choosePRG()});$("#c64MobileAttachD64").on("click",function(){i.chooseD64()});$("#c64MobileInsertCRT").on("click",function(){i.chooseCRT()});$("#c64MobileReset").on("click",function(){i.machineReset()});if(g_app.isMobile()){i.onscreenJoystick.draw()}})}}this.loadPrefs();this.scripting.show()},resize:function(){if(this.uiComponent){if(this.disassembly){UI(this.prefix+"DisassemblyCanvas").resize()}if(this.c64Memory){UI(this.prefix+"MemoryCanvas").resize();this.c64Memory.forceRedraw()}if(this.c64Registers){UI(this.prefix+"RegistersCanvas").resize()}if(this.breakpoints){UI(this.prefix+"BreakpointsCanvas").resize()}}if(this.type!="compact"&&g_app.isMobile()){this.orientation=window.innerWidth>window.innerHeight?90:0;this.layoutMobile()}},undo:function(){if(this.c64Sprites&&this.panelVisible["sprites"]){this.c64Sprites.undo()}if(this.c64Charset&&this.panelVisible["charset"]){this.c64Charset.undo()}},redo:function(){if(this.c64Sprites&&this.panelVisible["sprites"]){this.c64Sprites.redo()}if(this.c64Charset&&this.panelVisible["charset"]){this.c64Charset.redo()}},resizeC64Panel:function(){var e=g_app.isMobile();var t=e;var i=window.devicePixelRatio;if(this.canvas==null){return}if(this.c64Fit||this.c64FitPixel||t){var r=$("#"+this.c64CanvasId+"Holder");var a=r.offset();if(a){var s=r.width();var o=r.height();if(!t){o-=30}var l=384;var n=272;var h=1;var d=s/l;var c=o/n;if(d>c){h=c}else{h=d}if(h>1&&this.c64FitPixel&&!t){h=Math.floor(h)}this.c64Size=h;var f=Math.round(l*h);var u=Math.round(n*h);if(e){this.canvas.width=Math.round(l*h*i);this.canvas.height=Math.round(n*h*i);this.canvas.style.width=f+"px";this.canvas.style.height=u+"px"}else{this.canvas.width=Math.round(l*h);this.canvas.height=Math.round(n*h)}this.context=this.canvas.getContext("2d");if(h>=1&&(this.c64FitPixel||t)){this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false}else{this.context.imageSmoothingEnabled=true;this.context.webkitImageSmoothingEnabled=true;this.context.mozImageSmoothingEnabled=true;this.context.msImageSmoothingEnabled=true;this.context.oImageSmoothingEnabled=true}if(g_app.isMobile()&&this.orientation!=0){var p=Math.floor((r.height()-u)/2);this.canvas.style.marginTop=p+"px";var v=Math.floor((r.width()-f)/2);var g=Math.floor((v-40)/2);if(g<65){g=65}this.overlayOnscreenJoystick.maxRadius=g}else{this.canvas.style.marginTop="0px"}if(c64_ready){this.redraw()}}}this.setOverlaySize();this.setInfoPosition()},setInfoPosition:function(){if(this.type=="compact"||g_app.isMobile()){return}var e=$("#"+this.c64CanvasId);if(e.length==0){return}var t=e.width();var i=e.height();var r=e.position();var a=parseInt(e.css("marginTop").replace("px",""),10);var s=$("#"+this.c64CanvasId+"C64Info");var o=r.left;var l=r.top+a+i+2;var n=t;s.css("left",o+"px");s.css("top",l+"px");s.css("height","30px");s.css("width",n+"px")},setOverlaySize:function(){if(this.overlayVisible){if(this.type!="compact"){var e=$("#"+this.c64CanvasId);if(e.length>0){var t=e.width();var i=e.height();var r=e.position();var a=$("#"+this.c64CanvasId+"Overlay");a.css("top",r.top+"px");a.css("left",r.left+"px");a.css("width",t+"px");a.css("height",i+"px");if(this.canvas){a.css("marginTop",this.canvas.style.marginTop)}var s=$("#"+this.c64CanvasId+"OverlayElements");s.css("top",r.top+"px");s.css("left",r.left+"px");s.css("width",e.width()+"px");s.css("height",e.height()+"px");var o=$("#"+this.c64CanvasId+"OverlayPlayButton");var l=o.width();var n=o.height();var h=this.c64Size*18*6;var d=Math.round((t-l)/2);o.css("top",h+"px");o.css("left",d+"px");var c=$("#"+this.c64CanvasId+"OverlayTitle");var f=c.width();var u=c.height();var p=h-u;if(this.c64Size>=2){p-=36}else{p-=20}var v=Math.round((t-f)/2);c.css("top",p+"px");c.css("left",v+"px");var g=$("#"+this.c64CanvasId+"OverlayInfo");var m=g.width();var y=h+n;if(this.c64Size>=2){y+=32}else{y+=20}var b=Math.round((t-m)/2);g.css("top",y+"px");g.css("left",b+"px")}}}},hideOnscreenJoystick:function(){this.overlayOnscreenJoystick.setHidden(true)},buildInterface:function(e){var t=g_app.isMobile();var r=this;this.overlayOnscreenJoystick=new C64OnscreenJoystick;this.overlayOnscreenJoystick.init({debugger:this,id:"on-screen-joystick-overlay",showPortSelection:false});if(this.type!="compact"){this.uiComponent=UI.create("UI.Panel",{id:"c64debuggerPanel"});e.add(this.uiComponent);this.splitPanel=UI.create("UI.SplitPanel",{id:"c64DebuggerSplitPanel"});this.uiComponent.add(this.splitPanel);var i="";i+="<div>";i+='  <form id="c64DebuggerForm">';i+='    <input class="formControl"  id="c64ChoosePRG" type="file" accept=".prg" style="position: absolute; top: -50px; left: -100px" />';i+='    <input class="formControl"  id="c64ChooseD64" type="file" accept=".d64" style="position: absolute; top: -50px; left: -150px" />';i+='    <input class="formControl"  id="c64ChooseCRT" type="file" accept=".crt" style="position: absolute; top: -50px; left: -150px" />';i+="  </form>";i+='  <div id="c64DebuggerNav">';if(t){i+='    <div class="ui-button" style="display: none" id="c64BackToSource">&lt; back to source</div>'}i+="  </div>";i+='  <div style="text-align: center; position: absolute; left: 0; right: 0; top: 0; bottom: 0px" id="'+this.c64CanvasId+'Holder">';i+='    <canvas id="'+this.c64CanvasId+'"></canvas>';i+=this.overlayOnscreenJoystick.getHTML({opacity:.6});i+='    <div style="display: none" class="c64-overlay" id="'+this.c64CanvasId+'Overlay">';i+="    </div>";i+='    <div style="display: none; position: absolute; left: 0; top: 0;" id="'+this.c64CanvasId+'OverlayElements">';i+='      <div style="font-size: 40px; font-weight: 300; position: absolute; color: white; top: 0; left: 0" id="'+this.c64CanvasId+'OverlayTitle"></div>';i+='      <div id="'+this.c64CanvasId+'OverlayPlayButton" class="c64-play-button" style="position: absolute; cursor: pointer; margin: auto;  display: block; width: 80px; height: 80px;">';i+='        <i style="font-size: 80px; cursor: pointer" class="halflings halflings-play"></i>';i+="      </div>";i+='      <div id="'+this.c64CanvasId+'OverlayInfo" class="c64-overlay-info" style="cursor: pointer; margin: auto;  display: block; position: absolute; top: 0; left: 0">';i+="      </div>";i+="    </div>";var a="flex";if(t){a="none"}i+='    <div style="display: '+a+'; justify-content: space-between; align-items: center; padding: 5px 2px; position: absolute; left: 0; right: 0; bottom: 0; height; 30px;  text-align: left" id="'+this.c64CanvasId+'C64Info">';i+='      <div id="'+this.prefix+'DriveInfo" style="display: flex;">';i+='        <div id="'+this.prefix+'DriveLight" style="width: 30px; height: 16px; background-color: rgb(255, 0, 0);"></div>';i+='        <div id="'+this.prefix+'DrivePosition" style="margin-left: 6px; width: 20px"></div>';i+='        <span class="drive-info-label">DRIVE</span>';i+='        <div style="display: inline-block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 160px; color: #aaaaaa" id="'+this.prefix+'AttachedDisk"></div>';i+="      </div>";i+='      <div id="'+this.prefix+'JoystickHolder" style="display: flex; align-items: center">';i+="      </div>";if(false&&!t){i+='  <div id="c64DebuggerShare" class="ui-button">';i+='    <img src="icons/material/share-24px.svg">&nbsp;';i+="    Share PRG...";i+="  </div>"}i+="    </div>";i+="  </div>";i+="</div>";var s=UI.create("UI.HTMLPanel",{id:"c64DebuggerHTML",html:i});s.on("resize",function(){r.resizeC64Panel()});var o=UI.create("UI.SplitPanel",{id:"c64ScreenSplitPanel"});o.add(s);var l=false;this.assemblerHolder=UI.create("UI.SplitPanel",{});var n='<div class="title" style="background-color: #111111; height: 20px">';n+="&nbsp;Assembler";n+='<div style="position: absolute; top: 2px; right: 2px; width: 20px">';n+='<div id="c64CloseAssemblerPanel" class="ui-button ui-panel-close-button ui-button-danger"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>';n+="</div>";n+="</div>";this.assemblerClosePanel=UI.create("UI.HTMLPanel",{html:n});this.assemblerHolder.addNorth(this.assemblerClosePanel,20,false);this.assemblerPanel=UI.create("UI.Panel",{id:"debuggerAssemblerPanel"});this.assemblerHolder.add(this.assemblerPanel);o.addSouth(this.assemblerHolder,360,true,!l);o.southBarSize=5;o.southBarSizeSave=5;this.splitPanel.add(o);var r=this;UI.on("ready",function(){r.showPanel("c64-view-toggle-disassembly",false);r.showPanel("c64-view-toggle-scripting",false);r.showPanel("c64-view-toggle-colors",false);r.showPanel("c64-view-toggle-basic",false);r.showPanel("c64-view-toggle-memory",false);r.showPanel("c64-view-toggle-charset",false);r.showPanel("c64-view-toggle-sprites",false);r.showPanel("c64-view-toggle-bitmap",false);r.showPanel("c64-view-toggle-sid",false);r.showPanel("c64-view-toggle-drive",false);r.showPanel("c64-view-toggle-calc",false);r.showPanel("c64-view-toggle-docs",false);r.setPanelVisibility();if(!g_app.isMobile()&&$("#on-screen-joystick-overlay").length>0){$("#on-screen-joystick-overlay").hide()}r.initEvents();r.initContent()});var h=false;if(t){h=true}this.eastSplitPanel=UI.create("UI.SplitPanel");this.splitPanel.addEast(this.eastSplitPanel,440,true,h);this.eastTabPanel=UI.create("UI.TabPanel",{canCloseTabs:false});this.eastTabPanel.addTab({key:"memory",title:"Memory",isTemp:false},true);this.eastTabPanel.addTab({key:"charset",title:"Charset",isTemp:false},false);this.eastTabPanel.addTab({key:"sprites",title:"Sprites",isTemp:false},false);this.eastTabPanel.addTab({key:"bitmap",title:"Bitmap",isTemp:false},false);this.eastTabPanel.addTab({key:"sid",title:"SID",isTemp:false},false);this.eastTabPanel.addTab({key:"drive",title:"Drive",isTemp:false},false);this.eastTabPanel.addTab({key:"docs",title:"Docs",isTemp:false},false);this.eastTabPanel.addTab({key:"calc",title:"Calculator",isTemp:false},false);this.eastTabPanel.on("tabfocus",function(e,t){var i=r.eastTabPanel.getTabIndex(e);if(i>=0){r.showEastContent(e)}});this.eastTopPanel=UI.create("UI.SplitPanel");var d='<div class="title" style="background-color: #111111; height: 18px">';d+='<div style="position: absolute; top: 2px; right: 2px; width: 20px">';d+='<div id="c64CloseEastPanel" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>';d+="</div>";d+="</div>";this.eastClosePanel=UI.create("UI.HTMLPanel",{html:d});this.eastTopPanel.addNorth(this.eastClosePanel,24,false);this.eastTopPanel.add(this.eastTabPanel);this.eastSplitPanel.addNorth(this.eastTopPanel,54,false);this.eastMainPanel=UI.create("UI.Panel");this.eastSplitPanel.add(this.eastMainPanel);this.memoryPanel=UI.create("UI.Panel",{id:"c64DebuggerMemory"});this.eastMainPanel.add(this.memoryPanel);this.charsetPanel=UI.create("UI.Panel",{id:"c64DebuggerCharset"});this.eastMainPanel.add(this.charsetPanel);this.spritesPanel=UI.create("UI.Panel",{id:"c64DebuggerSprites"});this.eastMainPanel.add(this.spritesPanel);this.bitmapPanel=UI.create("UI.Panel",{id:"c64DebuggerBitmap"});this.eastMainPanel.add(this.bitmapPanel);this.sidPanel=UI.create("UI.Panel",{id:"c64DebuggerSID"});this.eastMainPanel.add(this.sidPanel);this.drivePanel=UI.create("UI.Panel",{id:"c64DebuggerDrive"});this.eastMainPanel.add(this.drivePanel);this.docsPanel=UI.create("UI.Panel",{id:"c64DebuggerDocs"});this.eastMainPanel.add(this.docsPanel);this.calcPanel=UI.create("UI.Panel",{id:"c64DebuggerCalculator"});this.eastMainPanel.add(this.calcPanel);this.cpuPanel=UI.create("UI.SplitPanel");this.splitPanel.addWest(this.cpuPanel,380,true,h);this.registersPanel=UI.create("UI.Panel");this.westTopPanel=UI.create("UI.SplitPanel");var c='<div class="title" style="background-color: #111111; height: 18px">';c+='<div style="position: absolute; top: 2px; right: 2px; width: 20px">';c+='<div id="c64CloseWestPanel" class="ui-button ui-panel-close-button ui-button-danger" style="padding: 1px 4px"><img src="icons/svg/glyphicons-basic-599-menu-close.svg"></div>';c+="</div>";c+="</div>";this.westClosePanel=UI.create("UI.HTMLPanel",{html:c});this.westTopPanel.addNorth(this.westClosePanel,24,false);this.westTopPanel.add(this.registersPanel);this.cpuPanel.addNorth(this.westTopPanel,80,false,h);this.breakpointsPanel=UI.create("UI.Panel");this.cpuPanel.addSouth(this.breakpointsPanel,200);this.westSplitPanel=UI.create("UI.SplitPanel");this.cpuPanel.add(this.westSplitPanel);this.westTabPanel=UI.create("UI.TabPanel",{canCloseTabs:false});this.westTabPanel.addTab({key:"disassembly",title:"Disassembly",isTemp:false},true);this.westTabPanel.addTab({key:"scripting",title:"Scripting",isTemp:false},false);this.westTabPanel.addTab({key:"basic",title:"BASIC",isTemp:false},false);this.westTabPanel.addTab({key:"colors",title:"Colours",isTemp:false},false);this.westTabPanel.on("tabfocus",function(e,t){var i=r.westTabPanel.getTabIndex(e);if(i>=0){r.showWestContent(e)}});this.westSplitPanel.addNorth(this.westTabPanel,30,false);this.westMainPanel=UI.create("UI.Panel");this.westSplitPanel.add(this.westMainPanel);this.disassemblyPanel=UI.create("UI.Panel",{id:"c64DebuggerDisassembly"});this.westMainPanel.add(this.disassemblyPanel);this.scriptingPanel=UI.create("UI.Panel",{id:"c64DebuggerScripting"});this.westMainPanel.add(this.scriptingPanel);this.colorsPanel=UI.create("UI.Panel",{id:"c64DebuggerColors"});this.westMainPanel.add(this.colorsPanel);this.basicPanel=UI.create("UI.Panel",{id:"c64DebuggerBasic"});this.westMainPanel.add(this.basicPanel);var f="";f+='  <div style="margin: 4px 0; position: relative">';f+='    <div class="ui-button" id="c64Play" style="width: 68px"><i class="halflings halflings-pause"></i>&nbsp;Pause (F9)</div>';f+='    <div class="ui-button ui-button-disabled" id="c64StepOver">Step Over (F10)</div>';f+='    <div class="ui-button ui-button-disabled" id="c64StepInto">Step Into (F11)</div>';f+="  </div>";var u=UI.create("UI.HTMLPanel",{html:f});this.westSplitPanel.addSouth(u,30,false);this.mobileSplitPanel=UI.create("UI.SplitPanel");this.splitPanel.addSouth(this.mobileSplitPanel,250,false,!h);var i="";i+='<div id="c64DebuggerTabs">';i+='<div class="ui-tab " data-tab="Keyboard">Keyboard</div>';i+='<div class="ui-tab ui-current-tab" data-tab="Joystick">Joystick</div>';i+='<div class="ui-tab" data-tab="Settings">Settings</div>';i+='<div class="ui-tab" data-tab="Content">Content</div>';i+="</div>";this.mobileSelectPanel=UI.create("UI.HTMLPanel",{html:i});this.mobileSplitPanel.addNorth(this.mobileSelectPanel,40,false);this.mobilePanel=UI.create("UI.Panel",{id:"c64MobilePanel"});this.mobileSplitPanel.add(this.mobilePanel)}else{this.uiComponent=UI.create("UI.Panel",{id:"c64debuggerCompactPanel"});e.add(this.uiComponent);var p=UI.create("UI.SplitPanel",{id:"c64DebuggerCompactSplitPanel"});this.uiComponent.add(p);var f="";f+='<div style="position: relative">';f+='  <div style="margin: 4px 0; position: relative">';f+='    <div class="ui-button" id="c64CompactPlay" style="width: 68px"><i class="halflings halflings-pause"></i>&nbsp;Pause (F9)</div>';f+='    <div class="ui-button ui-button-disabled" id="c64CompactStepOver">Step Over (F10)</div>';f+='    <div class="ui-button ui-button-disabled" id="c64CompactStepInto">Step Into (F11)</div>';f+='    <div class="ui-button ui-button-disabled" style="display: none" id="c64CompactStepCycle">Step 1/2 Cycle</div>';f+="  </div>";f+="</div>";var i="";i+='<div class="panelFill" id="'+this.c64CanvasId+'Holder">';i+='<form id="c64DebuggerCompactForm">';i+='  <input class="formControl"  id="c64CompactChoosePRG" type="file" accept=".prg" style="position: absolute; top: -50px; left: -100px" />';i+='  <input class="formControl"  id="c64CompactChooseD64" type="file" accept=".d64" style="position: absolute; top: -50px; left: -150px" />';i+='  <input class="formControl"  id="c64CompactChooseCRT" type="file" accept=".crt" style="position: absolute; top: -50px; left: -150px" />';i+="</form>";i+='<canvas id="'+this.c64CanvasId+'"></canvas>';i+='<div style="position: absolute; left: 0; right: 0; bottom: 0; height: 20px; background-color: #555555; color: #dddddd">';i+='  <div class="checkboxGroup">';i+='    <label class="cb-container">Grid<input type="checkbox" id="'+this.c64CanvasId+'Grid" value="1" ><span class="checkmark"></span> </label>';i+="  </div>";i+='  <div  style="display: inline-block" id="'+this.c64CanvasId+'InspectInfo"></div>';i+="</div>";i+="</div>";var s=UI.create("UI.HTMLPanel",{id:"c64DebuggerCompactHTML",html:i});s.on("resize",function(){r.resizeC64Panel()});this.registersPanel=UI.create("UI.Panel");this.cpuPanel=UI.create("UI.SplitPanel");p.add(this.cpuPanel);var v=g_app.getPref("c64-"+this.prefix+"-panelsizev");if(typeof v=="undefined"||v==null){v=280}else{v=parseInt(v,10)}if(isNaN(v)||v<10){v=280}this.cpuPanel.addNorth(s,v);this.cpuPanel.on("resizenorth",function(e){if(e>0){g_app.setPref("c64-"+r.prefix+"-panelsizev",e)}});var g=UI.create("UI.SplitPanel");this.cpuPanel.add(g);this.breakpointsPanel=UI.create("UI.Panel");this.cpuPanel.addSouth(this.breakpointsPanel,120);var u=UI.create("UI.HTMLPanel",{html:f});var m=UI.create("UI.SplitPanel");g.addNorth(this.registersPanel,38,false);g.add(m);g.addSouth(u,40,false);this.tabPanel=UI.create("UI.TabPanel",{canCloseTabs:false});this.tabPanel.addTab({key:"disassembly",title:"Disassembly",isTemp:false},true);this.tabPanel.addTab({key:"memory",title:"Memory",isTemp:false},false);this.tabPanel.addTab({key:"charset",title:"Charset",isTemp:false},false);this.tabPanel.addTab({key:"sprites",title:"Sprites",isTemp:false},false);this.tabPanel.addTab({key:"bitmap",title:"Bitmap",isTemp:false},false);this.tabPanel.addTab({key:"sid",title:"SID",isTemp:false},false);this.tabPanel.addTab({key:"drive",title:"Drive",isTemp:false},false);this.tabPanel.addTab({key:"scripting",title:"Scripting",isTemp:false},false);this.tabPanel.addTab({key:"colors",title:"Colors",isTemp:false},false);this.tabPanel.addTab({key:"basic",title:"Basic",isTemp:false},false);this.tabPanel.on("tabfocus",function(e,t){var i=r.tabPanel.getTabIndex(e);if(i>=0){r.showDebuggerContent(e)}});this.debuggerOutputPanel=UI.create("UI.Panel");m.add(this.debuggerOutputPanel);m.addNorth(this.tabPanel,30,false);this.disassemblyPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactDisassembly"});this.debuggerOutputPanel.add(this.disassemblyPanel);this.memoryPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactMemory"});this.debuggerOutputPanel.add(this.memoryPanel);this.charsetPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactCharset"});this.debuggerOutputPanel.add(this.charsetPanel);this.spritesPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactSprites"});this.debuggerOutputPanel.add(this.spritesPanel);this.bitmapPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactBitmap"});this.debuggerOutputPanel.add(this.bitmapPanel);this.sidPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactSID"});this.debuggerOutputPanel.add(this.sidPanel);this.drivePanel=UI.create("UI.Panel",{id:"c64DebuggerCompactDrive"});this.debuggerOutputPanel.add(this.drivePanel);this.scriptingPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactScripting"});this.debuggerOutputPanel.add(this.scriptingPanel);this.colorsPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactColors"});this.debuggerOutputPanel.add(this.colorsPanel);this.basicPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactBasic"});this.debuggerOutputPanel.add(this.basicPanel);UI.on("ready",function(){r.showDebuggerContent("disassembly");r.initCompactEvents()})}},closeWestPanel:function(){this.showPanel("c64-view-toggle-"+this.westContent,false)},closeEastPanel:function(){sid_setChannelBuffersEnabled(false);this.showPanel("c64-view-toggle-"+this.eastContent,false)},closeAssemblerPanel:function(){this.showPanel("c64-view-toggle-assembler",false)},showPanel:function(e,t){var i={"c64-view-toggle-disassembly":{menuItem:"c64-view-toggle-disassembly",tab:"disassembly",panel:"c64DebuggerDisassembly",component:this.disassembly},"c64-view-toggle-scripting":{menuItem:"c64-view-toggle-scripting",tab:"scripting",panel:"c64DebuggerScripting",component:null},"c64-view-toggle-colors":{menuItem:"c64-view-toggle-colors",tab:"colors",panel:"c64DebuggerColors",component:this.colors},"c64-view-toggle-basic":{menuItem:"c64-view-toggle-basic",tab:"basic",panel:"c64DebuggerBasic",component:null}};var r={"c64-view-toggle-memory":{menuItem:"c64-view-toggle-memory",tab:"memory",panel:"c64DebuggerMemory",component:this.memory},"c64-view-toggle-charset":{menuItem:"c64-view-toggle-charset",tab:"charset",panel:"c64DebuggerCharset",component:this.c64Charset},"c64-view-toggle-sprites":{menuItem:"c64-view-toggle-sprites",tab:"sprites",panel:"c64DebuggerSprites",component:this.c64Sprites},"c64-view-toggle-bitmap":{menuItem:"c64-view-toggle-bitmap",tab:"bitmap",panel:"c64DebuggerBitmap",component:this.c64Bitmap},"c64-view-toggle-sid":{menuItem:"c64-view-toggle-sid",tab:"sid",panel:"c64DebuggerSID",component:this.c64SID},"c64-view-toggle-drive":{menuItem:"c64-view-toggle-drive",tab:"drive",panel:"c64DebuggerDrive",component:this.c64Drive},"c64-view-toggle-docs":{menuItem:"c64-view-toggle-docs",tab:"docs",panel:"c64DebuggerDocs",component:null},"c64-view-toggle-calc":{menuItem:"c64-view-toggle-calc",tab:"calc",panel:"c64DebuggerCalculator",component:null}};var a=null;if(e=="c64-view-toggle-assembler"){UI("c64ScreenSplitPanel").setPanelVisible("south",t,300);UI(e).setChecked(t);this.panelVisible["assembler"]=t}if(i.hasOwnProperty(e)){for(var s in i){var o=i[s].component;if(e==s){this.panelVisible[i[s].tab]=t;UI(i[s].menuItem).setChecked(t);if(t){this.westContent=i[s].tab;UI("c64DebuggerSplitPanel").setPanelVisible("west",true);this.westTabPanel.showTab(i[s].tab);this.westMainPanel.showOnly(i[s].panel);if(this.c64Registers){this.c64Registers.update()}a=o}}else{if(t){this.panelVisible[i[s].tab]=false;if(o){if(typeof o.setVisible!="undefined"){o.setVisible(false)}}UI(i[s].menuItem).setChecked(false)}}}if(e=="c64-view-toggle-disassembly"){this.westSplitPanel.setPanelVisible("south",true);this.cpuPanel.setPanelVisible("south",true)}else{this.westSplitPanel.setPanelVisible("south",false);this.cpuPanel.setPanelVisible("south",false)}}if(r.hasOwnProperty(e)){for(var s in r){var o=r[s].component;if(e==s){this.panelVisible[r[s].tab]=t;UI(r[s].menuItem).setChecked(t);if(t){this.eastContent=r[s].tab;this.eastTabPanel.showTab(r[s].tab);a=o;this.eastMainPanel.showOnly(r[s].panel)}}else{if(t){this.panelVisible[r[s].tab]=false;UI(r[s].menuItem).setChecked(false);if(o&&typeof o.setVisible!="undefined"){o.setVisible(false)}}}}}this.setPanelVisibility();UI(e).setChecked(t);if(a){if(typeof a.setVisible!="undefined"){a.setVisible(true)}if(typeof a.forceRedraw!="undefined"){a.forceRedraw()}a.update()}},setPanelVisibility:function(){this.onlyc64Visible=true;if(this.panelVisible["assembler"]){this.onlyc64Visible=false}if(this.panelVisible["disassembly"]||this.panelVisible["scripting"]||this.panelVisible["colors"]||this.panelVisible["basic"]){UI("c64DebuggerSplitPanel").setPanelVisible("west",true);this.onlyc64Visible=false}else{UI("c64DebuggerSplitPanel").setPanelVisible("west",false)}if(this.panelVisible["memory"]||this.panelVisible["charset"]||this.panelVisible["sprites"]||this.panelVisible["bitmap"]||this.panelVisible["sid"]||this.panelVisible["drive"]||this.panelVisible["docs"]||this.panelVisible["calc"]){UI("c64DebuggerSplitPanel").setPanelVisible("east",true);this.onlyc64Visible=false}else{UI("c64DebuggerSplitPanel").setPanelVisible("east",false)}if(this.c64Focus||this.onlyc64Visible){this.focusMachine()}else{this.blurMachine()}},showWestContent:function(e){this.westContent=e;switch(e){case"disassembly":this.showPanel("c64-view-toggle-disassembly",true);break;case"scripting":this.showPanel("c64-view-toggle-scripting",true);break;case"colors":this.showPanel("c64-view-toggle-colors",true);break;case"basic":this.showPanel("c64-view-toggle-basic",true);this.basic.show();break}this.westMainPanel.resize()},showEastContent:function(e){this.eastContent=e;if(e!="sid"){sid_setChannelBuffersEnabled(false)}switch(e){case"memory":this.showPanel("c64-view-toggle-memory",true);break;case"charset":this.showPanel("c64-view-toggle-charset",true);break;case"sprites":this.showPanel("c64-view-toggle-sprites",true);break;case"bitmap":this.showPanel("c64-view-toggle-bitmap",true);break;case"sid":sid_setChannelBuffersEnabled(true);this.showPanel("c64-view-toggle-sid",true);break;case"drive":this.showPanel("c64-view-toggle-drive",true);break;case"docs":this.showPanel("c64-view-toggle-docs",true);break;case"calc":this.showPanel("c64-view-toggle-calc",true);break}this.eastMainPanel.resize()},showDebuggerContent:function(e){this.debuggerContent=e;if(e!="sid"&&c64_ready){sid_setChannelBuffersEnabled(false)}switch(e){case"disassembly":this.debuggerOutputPanel.showOnly("c64DebuggerCompactDisassembly");break;case"memory":this.debuggerOutputPanel.showOnly("c64DebuggerCompactMemory");break;case"charset":this.debuggerOutputPanel.showOnly("c64DebuggerCompactCharset");break;case"sprites":this.debuggerOutputPanel.showOnly("c64DebuggerCompactSprites");break;case"bitmap":this.debuggerOutputPanel.showOnly("c64DebuggerCompactBitmap");break;case"sid":this.debuggerOutputPanel.showOnly("c64DebuggerCompactSID");sid_setChannelBuffersEnabled(true);break;case"drive":this.debuggerOutputPanel.showOnly("c64DebuggerCompactDrive");break;case"scripting":this.debuggerOutputPanel.showOnly("c64DebuggerCompactScripting");if(this.scripting){this.scripting.show()}break;case"colors":break;case"basic":this.debuggerOutputPanel.showOnly("c64DebuggerCompactBasic");break}this.debuggerOutputPanel.resize()},initCompactEvents:function(){var i=this;this.canvas=document.getElementById(this.c64CanvasId);this.canvas.addEventListener("mousedown",function(e){i.mouseDown(e)},false);this.canvas.addEventListener("dblclick",function(e){i.dblClick(e)},false);this.canvas.addEventListener("mousemove",function(e){i.mouseMove(e)},false);this.canvas.addEventListener("mouseup",function(e){i.mouseUp(e)},false);this.canvas.addEventListener("mouseenter",function(e){if(i.mouseInfo){UI.setCursor("none")}else{UI.setCursor("default")}},false);this.canvas.addEventListener("mouseleave",function(e){i.mouseLeave(e)},false);this.canvas.addEventListener("contextmenu",function(e){e.preventDefault()},false);this.canvas.addEventListener("wheel",function(e){i.mouseWheel(e)},false);$("#c64CompactShowRaster").on("click",function(){var e=$(this).is(":checked");i.setShowRaster(e)});$("#c64CompactPlay").on("click",function(){i.play()});$("#c64CompactStepOver").on("click",function(){i.stepOver()});$("#c64CompactStepInto").on("click",function(){i.stepInto()});$("#c64CompactStepCycle").on("click",function(){i.stepCycle()});$("#c64CompactReset").on("click",function(){i.machineReset()});$("#"+this.c64CanvasId).on("click",function(e){i.focusMachine()});$("#"+this.c64CanvasId+"Grid").on("click",function(e){i.showGrid($(this).is(":checked"))});document.getElementById("c64CompactChoosePRG").addEventListener("change",function(e){var t=document.getElementById("c64CompactChoosePRG").files[0];i.loadPRGFile(t)});document.getElementById("c64CompactChooseD64").addEventListener("change",function(e){var t=document.getElementById("c64CompactChooseD64").files[0];i.attachD64(t)});document.getElementById("c64CompactChooseCRT").addEventListener("change",function(e){var t=document.getElementById("c64CompactChooseCRT").files[0];i.insertCRT(t)})},showGrid:function(e){this.grid=e;UI("c64debugger-grid").setChecked(e)},showMouseInfo:function(e){this.mouseInfo=e;UI("c64debugger-mouse").setChecked(e);$(".showMouseInfo").prop("checked",e)},initContent:function(){if(g_app.isMobile()){$("#"+this.c64CanvasId+"Holder").css("text-align","center");$("#"+this.c64CanvasId+"Holder").css("margin-top","10px");$("#c64DebuggerJoystickHolder").hide()}UI("c64debugger-randomdelay").setChecked(this.getRandomDelayEnabled())},layoutMobile:function(){if(this.canvas==null){return}var e=UI.getScreenHeight();var t=UI.getScreenWidth();if(this.orientation!=0){if(UI.exists("mobileMenuBar")){UI("mobileMenuBar").setVisible(false)}if(UI.exists("projectSplitPanel")){UI("projectSplitPanel").resizeThePanel({panel:"north",size:0})}$("#"+this.c64CanvasId+"Holder").css("margin-top","5px");this.splitPanel.setPanelVisible("south",false);$("#on-screen-joystick-overlay").show();this.overlayOnscreenJoystick.draw()}else{var i=UI.getScreenWidth();var r=UI.getScreenHeight();var a=384;var s=272;var o=i/a;if(o<1){o=1}var l=s*o;var n=Math.floor(r-l-40-60);if(n>280){n=280}if(n<260){n=260}if(UI.exists("mobileMenuBar")){UI("mobileMenuBar").setVisible(true)}if(UI.exists("projectSplitPanel")){UI("projectSplitPanel").resizeThePanel({panel:"north",size:70})}$("#"+this.c64CanvasId+"Holder").css("margin-top","10px");this.splitPanel.setPanelVisible("south",true);this.splitPanel.resizeThePanel({panel:"south",size:n});$("#on-screen-joystick-overlay").hide();this.onscreenJoystick.draw();this.onscreenKeyboard.draw()}},initEvents:function(){var e=g_app.isMobile();var i=this;if(e){this.overlayOnscreenJoystick.initEvents();window.addEventListener("orientationchange",function(e){return;if(typeof e.target.screen!="undefined"&&typeof e.target.screen.orientation!="undefined"&&typeof e.target.screen.orientation.angle!="undefined"){i.orientation=e.target.screen.orientation.angle}i.layoutMobile()})}$("#c64CloseWestPanel").on("click",function(){i.closeWestPanel()});$("#c64CloseEastPanel").on("click",function(){i.closeEastPanel()});$("#c64CloseAssemblerPanel").on("click",function(){i.closeAssemblerPanel()});$("#c64Play").on("click",function(){i.play()});$("#c64StepOver").on("click",function(){i.stepOver()});$("#c64StepInto").on("click",function(){i.stepInto()});$("#c64Reset").on("click",function(){i.machineReset()});$("#c64DebuggerCurrentPRG"+this.type).on("click",function(){$("#c64ChoosePRG").click()});$("#c64DebuggerAttachedDisk").on("click",function(){i.chooseD64()});$("#c64DebuggerJoystick").on("click",function(){i.toggleJoystick()});$("#c64DebuggerShare").on("click",function(){i.share()});$("#c64DebuggerTabs .ui-tab").on("click",function(){var e=$(this).attr("data-tab");$("#c64DebuggerTabs .ui-tab").removeClass("ui-current-tab");$(this).addClass("ui-current-tab");UI("c64MobilePanel").showOnly("c64Onscreen"+e);if(e=="Joystick"){i.onscreenJoystick.draw()}if(e=="Keyboard"){i.onscreenKeyboard.draw()}});$("#"+this.prefix+"JoystickHolder").on("click",function(){c64.joystick.showSettingsDialog()});$("#"+this.prefix+"DriveInfo").on("click",function(){i.chooseD64(false)});$("#"+this.c64CanvasId).on("click",function(){i.focusMachine()});$("#"+this.c64CanvasId+"OverlayPlayButton").on("click",function(){i.overlayClick()});this.canvas=document.getElementById(this.c64CanvasId);this.canvas.requestPointerLock=this.canvas.requestPointerLock||this.canvas.mozRequestPointerLock;document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock;this.canvas.addEventListener("click",function(e){if(!i.mouseLocked&&c64.joystick.hasMouse()){i.canvas.requestPointerLock()}},false);document.addEventListener("pointerlockchange",function(e){i.lockChange(e)},false);document.addEventListener("mozpointerlockchange",function(e){i.lockChange(e)},false);this.canvas.addEventListener("dblclick",function(e){i.dblClick(e)},false);this.canvas.addEventListener("mousedown",function(e){i.mouseDown(e)},false);this.canvas.addEventListener("contextmenu",function(e){e.preventDefault()},false);this.canvas.addEventListener("mousemove",function(e){i.mouseMove(e)},false);this.canvas.addEventListener("mouseup",function(e){i.mouseUp(e)},false);this.canvas.addEventListener("mouseenter",function(e){if(i.mouseInfo||c64_ready&&(c64.joystick.getMousePortEnabled(0)||c64.joystick.getMousePortEnabled(1))){UI.setCursor("none")}else{UI.setCursor("default")}},false);this.canvas.addEventListener("mouseleave",function(e){i.mouseLeave(e)},false);this.canvas.addEventListener("wheel",function(e){i.mouseWheel(e)},false);if(e){$("#c64BackToSource").on("click",function(){i.backToSource()})}document.getElementById("c64ChoosePRG").addEventListener("change",function(e){var t=document.getElementById("c64ChoosePRG").files[0];i.loadPRGFile(t)});document.getElementById("c64ChooseD64").addEventListener("change",function(e){var t=document.getElementById("c64ChooseD64").files[0];i.attachD64(t)});document.getElementById("c64ChooseCRT").addEventListener("change",function(e){var t=document.getElementById("c64ChooseCRT").files[0];i.insertCRT(t)})},setButtons:function(e){if(typeof e.buttons!="undefined"){this.buttons=e.buttons}else{if(typeof e.which!=="undefined"){this.buttons=e.which}else if(typeof e.nativeEvent!=="undefined"){if(typeof e.nativeEvent.which!="undefined"){this.buttons=e.nativeEvent.which}if(typeof e.nativeEvent.buttons!="undefined"){this.buttons=e.nativeEvent.buttons}}}if(typeof e.touches!="undefined"&&e.touches.length==1){this.buttons=1}if(e.ctrlKey&&this.buttons&1){if(UI.os=="Mac OS"){this.buttons=2}}},lockChange:function(e){if(document.pointerLockElement===this.canvas||document.mozPointerLockElement===this.canvas){this.mouseLocked=true}else{this.mouseLocked=false}},mouseDown:function(e){this.setButtons(e);var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;t=t-32;i=i-36;if(c64.joystick.getMousePortEnabled(0)){e.preventDefault();if(this.buttons&1){c64_joystickPush(0,C64_JOYSTICK_FIRE)}if(this.buttons&2){c64_joystickPush(0,C64_JOYSTICK_UP)}}if(c64.joystick.getMousePortEnabled(1)){e.preventDefault();if(this.buttons&1){c64_joystickPush(1,C64_JOYSTICK_FIRE)}if(this.buttons&2){c64_joystickRelease(1,C64_JOYSTICK_FIRE)}}if(this.c64Charset&&this.panelVisible["charset"]){this.c64Charset.debuggerMouseDown();UI.captureMouse(this)}if(this.c64Sprites&&this.c64Sprites.visible){this.c64Sprites.debuggerMouseDown()}},mouseUp:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;t=t-32;i=i-36;if(c64.joystick.getMousePortEnabled(0)){e.preventDefault();if(this.buttons&1){c64_joystickRelease(0,C64_JOYSTICK_FIRE)}if(this.buttons&2){c64_joystickRelease(0,C64_JOYSTICK_UP)}}if(c64.joystick.getMousePortEnabled(1)){e.preventDefault();if(this.buttons&1){c64_joystickRelease(1,C64_JOYSTICK_FIRE)}if(this.buttons&2){c64_joystickRelease(1,C64_JOYSTICK_UP)}}if(this.c64Charset&&this.c64Charset.visible){this.c64Charset.debuggerMouseUp()}this.buttons=0},dblClick:function(e){var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;if(this.c64Charset.visible){this.c64Charset.editChar(this.mouseChar)}},mouseMove:function(e){if(this.mouseLocked){this.lockedMouseX+=e.movementX;this.lockedMouseY+=e.movementY;this.mouseC64X+=e.movementX;this.mouseC64Y+=e.movementY;return}var t=e.pageX-$("#"+this.canvas.id).offset().left;var i=e.pageY-$("#"+this.canvas.id).offset().top;this.mouseX=t;this.mouseY=i;if(this.mouseX!==false&&this.mouseY!==false){if(c64_ready){this.redraw()}}},mouseLeave:function(e){UI.setCursor("default");this.mouseX=false;this.mouseY=false;if(this.c64Charset&&this.c64Charset.getVisible()){this.c64Charset.debuggerMouseLeave()}if(this.c64Sprites&&this.c64Sprites.getVisible()){this.c64Sprites.debuggerMouseLeave()}if(this.c64Bitmap&&this.c64Bitmap.getVisible()){this.c64Bitmap.debuggerMouseLeave()}},mouseWheel:function(e){e.preventDefault();var t=normalizeWheel(e);var i=-t.spinY;var r=this.mouseZoom+i/2;if(r<=1){r=1}this.setMouseZoom(r)},setMouseZoom:function(e){this.mouseZoom=e},choosePRG:function(){document.getElementById("c64DebuggerForm").reset();$("#c64ChoosePRG").click()},chooseD64:function(e){this.autostartD64=e;document.getElementById("c64DebuggerForm").reset();$("#c64ChooseD64").click()},chooseCRT:function(){document.getElementById("c64DebuggerForm").reset();$("#c64ChooseCRT").click()},loadBASFile:function(e){var t=this;var i=new FileReader;i.onload=function(e){t.showPanel("c64-view-toggle-basic",true);t.basic.setBAS(e.target.result);t.basic.run()};i.readAsText(e)},loadPRGFile:function(i){c64.sound.checkAudio();this.removePCMarker();var r=this;var a=new FileReader;a.onload=function(e){r.prgData=new Uint8Array(a.result);r.prgName=i.name;if(r.type!="compact"){$("#c64DebuggerCurrentPRG"+r.type).html(r.prgName)}var t=r.prgLoadMethod!="loadrun";if(r.crtData!=null){r.crtData=null;c64_removeCartridge()}r.startPRG(r.prgData,t)};a.readAsArrayBuffer(i);this.prgFile=i},attachD64AsByteArray:function(e,t){c64.sound.checkAudio();c64_insertDisk(t,t.length);this.d64Data=t;this.d64Name=e;if(this.type!="compact"){$("#"+this.prefix+"AttachedDisk").html(e);$("#"+this.prefix+"DriveInfo").show()}if(this.autostartD64){this.autostartD64PRG(t)}},autostartD64PRG:function(e){var t=D64Util.getFirstPRG(e);this.prgData=t;this.prgName="d64prg";c64_reset();c64_insertDisk(e,e.length);this.d64Data=e;if(false&&this.prgData){var i=this;setTimeout(function(){c64_loadPRG(i.prgData,i.prgData.length,false);c64.insertText("run:\n")},2e3)}else{setTimeout(function(){c64.insertText('load "*",8,1\nrun\n')},2e3)}},attachD64:function(i){c64.sound.checkAudio();var r=this;var a=new FileReader;a.onload=function(e){var t=new Uint8Array(a.result);c64_insertDisk(t,t.length);r.d64Data=t;r.d64Name=i.name;if(r.autostartD64){r.autostartD64PRG(t)}};a.readAsArrayBuffer(i);var e=i.name;if(this.type!="compact"){$("#"+this.prefix+"AttachedDisk").html(e);$("#"+this.prefix+"DriveInfo").show()}},insertCRT:function(i){c64.sound.checkAudio();var r=this;var a=new FileReader;a.onload=function(e){var t=new Uint8Array(a.result);if(r.crtData!=null){r.crtData=null;c64_removeCartridge()}c64_loadCRT(t,t.length);r.crtData=t;r.crtName=i.name};a.readAsArrayBuffer(i)},setSettings:function(e){},share:function(e){var t=e;if(typeof e=="undefined"){t={}}if(typeof t.type=="undefined"){if(this.prgData){t.type="prg"}else if(this.d64Data){t.type="d64"}else if(this.crtData){t.type="crt"}else if(this.panelVisible["assembler"]){t.type="assembly";t.view="current"}else if(this.panelVisible["basic"]){t.type="basic";t.view="current"}}if(this.gistShare==null){this.gistShare=new C64GistShare}this.gistShare.show(t);return;var i=this;if(!this.prgData){alert("Only sharing of PRGs currently supported, please choose a PRG first");return}var r={};var a=bufferToBase64(this.prgData);r[this.prgName]={content:a};var s=c64.colors.colors;var o=c64.joystick.portEnabled[0];var l=c64.joystick.portEnabled[1];var n={colors:s,port1:o,port2:l};r["c64settings"]={content:JSON.stringify(n)};g_app.gist.share({files:r})},step:function(){if(!debugger_isRunning()){debugger_step();this.syncToSource();this.redraw();if(this.showRaster){this.drawRasterPosition()}}},stepOver:function(){var e=this.getPC();var t=this.readByte(e)&255;var i=MOS6510Opcodes[t];if(typeof i=="undefined"||t!=32){this.stepInto();return}var r=e+i.bytes;if(!debugger_isRunning()){var a=0;while(a<9e5){a++;debugger_step();var e=this.getPC();if(e==r){break}}this.syncToSource();this.redraw();if(this.showRaster){this.drawRasterPosition()}}},stepInto:function(){if(!debugger_isRunning()){debugger_step();this.syncToSource();this.redraw();if(this.showRaster){this.drawRasterPosition()}}},syncToSource:function(){var e=this.getPC();if(this.assemblerReport!==false){if(typeof this.assemblerReport.addressMap[e]!="undefined"){var t=this.assemblerReport.addressMap[e];var i="/asm/"+t.file;if(this.type=="compact"){g_app.projectNavigator.showDocRecord(i);g_app.assemblerEditor.showFile(i,t.lineNumber);var r=g_app.assemblerEditor.codeEditor.getEditSession();var a=t.lineNumber;this.removePCMarker();r.addGutterDecoration(a-1,"ace_pc");this.pcGutterDecoration.session=r;this.pcGutterDecoration.lineNumber=a-1}else{this.assemblerEditor.showFile(i,t.lineNumber);var r=this.assemblerEditor.codeEditor.getEditSession();var a=t.lineNumber;this.removePCMarker();r.addGutterDecoration(a-1,"ace_pc");this.pcGutterDecoration.session=r;this.pcGutterDecoration.lineNumber=a-1}}}},removePCMarker:function(){if(this.pcGutterDecoration.session!==false){this.pcGutterDecoration.session.removeGutterDecoration(this.pcGutterDecoration.lineNumber,"ace_pc");this.pcGutterDecoration.session=false;this.pcGutterDecoration.lineNumber=false}},updateButtons:function(){console.log("update buttons");if(debugger_isRunning()){this.runningButtons=true;if(this.type=="compact"){$("#c64CompactPlay").html('<i class="halflings halflings-pause"></i>&nbsp;Pause (F9)');$("#c64CompactPlay").removeClass("ui-button-primary");$("#c64CompactStepOver").addClass("ui-button-disabled");$("#c64CompactStepInto").addClass("ui-button-disabled");$("#c64CompactStepCycle").addClass("ui-button-disabled")}else{$("#c64Play").html('<i class="halflings halflings-pause"></i>&nbsp;Pause (F9)');$("#c64Play").removeClass("ui-button-primary");$("#c64StepOver").addClass("ui-button-disabled");$("#c64StepInto").addClass("ui-button-disabled")}}else{this.runningButtons=false;if(this.type=="compact"){$("#c64CompactPlay").html('<i class="halflings halflings-play"></i>&nbsp;Play (F9)');$("#c64CompactPlay").addClass("ui-button-primary");$("#c64CompactStepOver").removeClass("ui-button-disabled");$("#c64CompactStepInto").removeClass("ui-button-disabled");$("#c64CompactStepCycle").removeClass("ui-button-disabled");this.syncToSource()}else{$("#c64Play").html('<i class="halflings halflings-play"></i>&nbsp;Play (F9)');$("#c64Play").addClass("ui-button-primary");$("#c64StepOver").removeClass("ui-button-disabled");$("#c64StepInto").removeClass("ui-button-disabled")}}},isRunning:function(){return debugger_isRunning()},play:function(){if(debugger_isRunning()){debugger_pause()}else{this.removePCMarker();debugger_play()}this.updateButtons()},machineReset:function(){$("#c64DebuggerAttachedDisk").html("");if(this.crtData!=null){this.crtData=null;c64_removeCartridge()}c64_reset()},overlayClick:function(){c64.sound.checkAudio();this.overlayVisible=false;$("#"+this.c64CanvasId+"Overlay").hide();$("#"+this.c64CanvasId+"OverlayElements").hide();if(g_app.isMobile()){var e=document.documentElement;if(e.requestFullscreen){e.requestFullscreen()}else if(e.mozRequestFullScreen){e.mozRequestFullScreen()}else if(e.webkitRequestFullscreen){e.webkitRequestFullscreen()}else if(e.msRequestFullscreen){e.msRequestFullscreen()}}else{if(!this.mouseLocked&&c64.joystick.hasMouse()){this.canvas.requestPointerLock()}}if(this.prgToStart){var t={};t.prg=this.prgToStart;if(typeof g_c64Settings!="undefined"){if(typeof g_c64Settings.prgstart!="undefined"){t.prgStartMethod=g_c64Settings.prgstart}if(typeof g_c64Settings.prgRandomDelay!="undefined"){t.prgRandomDelay=g_c64Settings.prgRandomDelay}}this.setPRG(t)}if(this.d64ToStart){this.autostartD64PRG(this.d64ToStart)}if(this.crtToStart){this.crtData=this.crtToStart;c64_loadCRT(this.crtData,this.crtData.length)}if(this.snapshotToStart){c64_loadSnapshot(this.snapshotToStart,this.snapshotToStart.length)}},onC64Ready:function(){var e=g_app.getPref("c64-model");if(typeof e!="undefined"&&e!==null){this.setModel(e)}this.setupContent();this.updateJoystickInfo()},setupContent:function(){if(!c64_ready){return}if(this.contentIsSetup){return}var e=new URLSearchParams(window.location.search);if(e.has("view")){var t=e.get("view");var i=t.split(",");for(var r=0;r<i.length;r++){var t=i[r];this.showPanel("c64-view-toggle-"+t,true)}}if(g_c64Settings===false){return}c64.setSettings();var a=g_c64Settings;if(!g_app.isMobile()){if(typeof a.view!="undefined"){for(var r=0;r<a.view.length;r++){var t=a.view[r];this.showPanel("c64-view-toggle-"+t,true)}}}if(typeof a.autostart!="undefined"){for(var r=0;r<a.autostart.length;r++){var s=a.autostart[r];switch(s){case"basic":this.basic.run();break;case"script":this.scripting.run();break;case"assembler":this.assemblerEditor.run();break}}}for(var r=0;r<2;r++){var o=r+1;if(typeof g_c64Settings["port"+o]!="undefined"&&g_c64Settings["port"+o]){this.onscreenJoystick.setPort(o);this.overlayOnscreenJoystick.setPort(o);$("#c64MobileJoystickPort_"+o).prop("checked",true);if(typeof g_c64Settings["port"+o+"Buttons"]!="undefined"){var l=parseInt(g_c64Settings["port"+o+"Buttons"],10);this.onscreenJoystick.setType(l);this.overlayOnscreenJoystick.setType(l);$("#c64MobileJoystickType_"+l).prop("checked",true)}if(typeof g_c64Settings["port"+o+"Button1Action"]!="undefined"){var n=g_c64Settings["port"+o+"Button1Action"];this.onscreenJoystick.setSecondButton(n);this.overlayOnscreenJoystick.setSecondButton(n);$("#c64MobileJoystickButton2_"+n).prop("checked",true)}}if(typeof g_c64Settings["mousePort"+o]!="undefined"){}}this.contentIsSetup=true},checkSharing:function(){if(typeof g_c64Settings!="undefined"){if(typeof g_c64Settings.share!="undefined"){return g_c64Settings.share}}return true},checkSnapshotDownload:function(){if(typeof g_c64Settings.snapshotDownload!="undefined"){return g_c64Settings.snapshotDownload}return true},applyShareSettings:function(){if(typeof g_c64Settings=="undefined"){return}if(typeof g_c64Settings.share!="undefined"){if(!g_c64Settings.share){$("#shareButton").hide()}UI("c64-share-link").setEnabled(g_c64Settings.share);UI("c64-export-html-page").setEnabled(g_c64Settings.share)}else{UI("c64-share-link").setEnabled(true);UI("c64-export-html-page").setEnabled(true)}if(typeof g_c64Settings.snapshotDownload!="undefined"){UI("c64-downloadsnapshot").setEnabled(g_c64Settings.snapshotDownload)}else{UI("c64-downloadsnapshot").setEnabled(true)}},setContentToStart:function(e){$("#shareButton").hide();$("#menuSignIn").hide();if(g_app.isMobile()){var t='<a href="http://lvllvl.com"><img src="images/logo32t.png" style="margin-top: 8px; filter: invert(10%) !important" height="32" style="padding: 3px 3px 3px 5px"></a>';$("#mobileMenuBarHamburger").html(t)}var i="";if(typeof e.filename!="undefined"){i=e.filename}if(typeof e.prg!="undefined"){this.prgToStart=e.prg;this.prgName=i}if(typeof e.crt!="undefined"){this.crtToStart=e.crt;this.crtName=i}if(typeof e.d64!="undefined"){this.d64ToStart=e.d64;this.d64Name=i}if(typeof e.snapshot!="undefined"){this.snapshotToStart=e.snapshot}$("#"+this.c64CanvasId+"Overlay").show();$("#"+this.c64CanvasId+"OverlayElements").show();$("#"+this.c64CanvasId+"OverlayTitle").html(i);var r="";this.applyShareSettings();if(!g_app.isMobile()){var a=false;if(typeof g_c64Settings!="undefined"&&g_c64Settings){for(var s=0;s<2;s++){var o=s+1;if(typeof g_c64Settings["port"+o]!="undefined"&&g_c64Settings["port"+o]){if(typeof g_c64Settings["port"+o+"Buttons"]!="undefined"&&g_c64Settings["port"+o+"Buttons"]>1){a=true}}}}r='<div style="display: inline-block; width: 162px; position: relative">';r+='<div style="position: absolute; top: 0; left: 0; width: 162px; height: 22px; font-size: 18px; color: white; text-align: center">Controls</div>';r+='<div style="position: absolute; top: 40px; left: 0; width: 92px"><img src="images/arrowkeys.png"></div>';r+='<div style="position: absolute; top: 52px; left: 92px; width: 42px; font-size: 20px; text-align: center">+</div>';r+='<div style="position: absolute; top: 72px; left: 134px; width: 28px"><img src="images/zkey.png"></div>';if(a){r+='<div style="position: absolute; top: 72px; left: 170px; width: 28px"><img src="images/xkey.png"></div>'}r+="</div>";$("#"+this.c64CanvasId+"OverlayInfo").html(r);this.overlayVisible=true}this.showPanel("c64-view-toggle-disassembly",false);this.showPanel("c64-view-toggle-scripting",false);this.showPanel("c64-view-toggle-colors",false);this.showPanel("c64-view-toggle-basic",false);this.showPanel("c64-view-toggle-memory",false);this.showPanel("c64-view-toggle-charset",false);this.showPanel("c64-view-toggle-sprites",false);this.showPanel("c64-view-toggle-bitmap",false);this.showPanel("c64-view-toggle-sid",false);this.showPanel("c64-view-toggle-drive",false);this.showPanel("c64-view-toggle-calc",false);this.showPanel("c64-view-toggle-docs",false);this.setPanelVisibility();this.resizeC64Panel()},downloadSnapshot:function(){if(!this.checkSnapshotDownload()){alert("Sorry, snapshot download has been disabled for this content");return}var e=c64_getSnapshot();var t=c64_getSnapshotSize();var i=new Uint8Array(c64.HEAPU8.subarray(e,e+t));download(i,"snapshot.c64","application/bin")},loadSnapshotFile:function(e){c64.sound.checkAudio();this.removePCMarker();var t=this;var i=new FileReader;i.onload=function(e){var t=new Uint8Array(i.result);c64_reset();c64_loadSnapshot(t,t.length)};i.readAsArrayBuffer(e);this.prgFile=e},startPRG:function(e,t,i){var r=e[0]+(e[1]<<8);var a=r-2+e.length;if(r<57344&&a>=65535||r<53248&&a>=57343){t=true}c64_reset();var s=1;var o=this.getRandomDelayEnabled();if(typeof i!="undefined"){o=i}if(o){s=Math.random()*100}setTimeout(function(){c64_loadPRG(e,e.length,t?1:0);if(t){if(r<1264&&a>1264){}else{c64.insertText("run\n")}}else{setTimeout(function(){c64.insertText('load "*",8,1\nrun\n')},2e3)}},s)},setPRG:function(e){this.overlayVisible=false;if($("#"+this.c64CanvasId+"Overlay").length>0){$("#"+this.c64CanvasId+"Overlay").hide();$("#"+this.c64CanvasId+"OverlayElements").hide()}var t=false;c64.sound.checkAudio();this.removePCMarker();if(typeof e.startC64!="undefined"){t=e.startC64}if(t){if(!debugger_isRunning()){debugger_play()}}var i=this.prgLoadMethod=="inject";if(typeof e.prgStartMethod!="undefined"){i=e.prgStartMethod=="inject"}var r=true;if(typeof e.prgRandomDelay!="undefined"){r=e.prgRandomDelay}this.startPRG(e.prg,i,r);this.prgFile=null;this.prgData=e.prg;if(typeof e.report!="undefined"){this.assemblerReport=e.report;if(this.disassembly){this.disassembly.setReport(e.report)}if(this.c64Memory){this.c64Memory.setReport(e.report)}}else{this.assemblerReport=false;this.disassembly.setReport({});this.c64Memory.setReport({})}if(this.type!="compact"){this.backLink="";if(typeof e!="undefined"&&typeof e.backLink!="undefined"){this.backLink=e.backLink}if($("#c64BackToSource").length>0){if(this.backLink!=""){$("#c64BackToSource").show()}else{$("#c64BackToSource").hide()}}}},backToSource:function(){g_app.setMode("assembler");g_app.assemblerEditor.showFile(this.backLink);this.currentEditor=g_app.assemblerEditor},toggleShowRaster:function(){this.setShowRaster(!this.showRaster)},setShowRaster:function(e){this.showRaster=e;UI("c64-viewraster").setChecked(e);$("#c64CompactShowRaster").prop("checked",e);if(e){this.drawRasterPosition()}},getRegA:function(){return c64_getRegA()},setRegA:function(e){c64_setRegA(e)},getRegX:function(){return c64_getRegX()},setRegX:function(e){c64_setRegX(e)},getRegY:function(){return c64_getRegY()},setRegY:function(e){c64_setRegY(e)},getRegSP:function(){return c64_getSP()},setRegSP:function(e){},getPC:function(){return c64_getPC()},setPC:function(e){c64_setPC(e)},getFlagN:function(){return c64_getFlagN()},setFlagN:function(e){c64_setFlagN(e)},getFlagV:function(){return c64_getFlagV()},setFlagV:function(e){c64_setFlagV(e)},getFlagB:function(){return c64_getFlagB()},setFlagB:function(e){c64_setFlagB(e)},getFlagD:function(){return c64_getFlagD()},setFlagD:function(e){c64_setFlagD(e)},getFlagI:function(){return c64_getFlagI()},setFlagI:function(e){c64_setFlagI(e)},getFlagZ:function(){return c64_getFlagZ()},setFlagZ:function(e){c64_setFlagZ(e)},getFlagC:function(){return c64_getFlagC()},setFlagC:function(e){return c64_setFlagC(e)},getVC:function(){return c64_getVicCycle()},getRstY:function(){return c64_getRasterY()},getCycleCount:function(e){return c64_getCycleCount(e)},getRstX:function(){return 0},addPCBreakpoint:function(e){var t=e.address;for(var i=0;i<this.pcBreakpoints.length;i++){if(this.pcBreakpoints[i].address===t){return}}var r=false;var a=false;if(typeof e.file!="undefined"){r=e.file}if(typeof e.lineNumber!="undefined"){a=e.lineNumber}this.pcBreakpoints.push({address:t,file:r,lineNumber:a,enabled:true});c64_pcBreakpointAdd(t)},setPCBreakpointEnabled:function(e){var t=e.address;var i=e.enabled;for(var r=0;r<this.pcBreakpoints.length;r++){if(this.pcBreakpoints[r].address===t){this.pcBreakpoints[r].enabled=i}}c64_pcBreakpointSetEnabled(t,i?1:0)},removePCBreakpoint:function(e){var t=e.address;var i=false;for(var r=0;r<this.pcBreakpoints.length;r++){if(this.pcBreakpoints[r].address===t){i=r;break}}if(i===false){return}this.pcBreakpoints.splice(i,1);c64_pcBreakpointRemove(t)},clearPCBreakpoints:function(){var e=0;while(this.pcBreakpoints.length>0){e++;if(e>200){break}this.removePCBreakpoint({address:this.pcBreakpoints[0].address})}},getPCBreakpoints:function(){return this.pcBreakpoints},addMemoryBreakpoint:function(e){var t=parseInt(e.address,10);var i=parseInt(e.op,10);var r=parseInt(e.value,10);for(var a=0;a<this.memoryBreakpoints.length;a++){if(this.memoryBreakpoints[a].address===t&&this.memoryBreakpoints[a].op===i&&this.memoryBreakpoints[a].value==r){return}}this.memoryBreakpoints.push({address:t,op:i,value:r,enabled:1});c64_memoryBreakpointAdd(t,i,r)},setMemoryBreakpointEnabled:function(e){var t=parseInt(e.address,10);var i=parseInt(e.op,10);var r=parseInt(e.value,10);var a=e.enabled?1:0;for(var s=0;s<this.memoryBreakpoints.length;s++){if(this.memoryBreakpoints[s].address===t&&this.memoryBreakpoints[s].op===i&&this.memoryBreakpoints[s].value==r){this.memoryBreakpoints[s].enabled=a}}c64_memoryBreakpointSetEnabled(t,i,r,a)},removeMemoryBreakpoint:function(e){var t=parseInt(e.address,10);var i=parseInt(e.op,10);var r=parseInt(e.value,10);var a=false;for(var s=0;s<this.memoryBreakpoints.length;s++){if(this.memoryBreakpoints[s].address===t&&this.memoryBreakpoints[s].op===i&&this.memoryBreakpoints[s].value==r){a=s;break}}if(a===false){return}this.memoryBreakpoints.splice(a,1);c64_memoryBreakpointRemove(t,i,r)},addRasterYBreakpoint:function(e){var t=parseInt(e.rasterY,10);for(var i=0;i<this.rasterYBreakpoints.length;i++){if(this.rasterYBreakpoints[i].rasterY===t){return}}this.rasterYBreakpoints.push({rasterY:t,enabled:true,activated:false});c64_rasterYBreakpointAdd(t)},setRasterYBreakpointEnabled:function(e){var t=parseInt(e.rasterY,10);var i=e.enabled?1:0;for(var r=0;r<this.rasterYBreakpoints.length;r++){if(this.rasterYBreakpoints[r].rasterY===t){this.rasterYBreakpoints[r].enabled=i}}c64_rasterYBreakpointSetEnabled(t,i)},removeRasterYBreakpoint:function(e){var t=parseInt(e.rasterY,10);var i=false;for(var r=0;r<this.rasterYBreakpoints.length;r++){if(this.rasterYBreakpoints[r].rasterY===t){i=r;break}}if(i===false){return}this.rasterYBreakpoints.splice(i,1);c64_rasterYBreakpointRemove(t)},getRasterYBreakpoints:function(){return this.rasterYBreakpoints},getMemoryBreakpoints:function(){return this.memoryBreakpoints},showFile:function(e){var t=g_app.doc.getDocRecord(e);if(!t){return}var i=base64ToBuffer(t.data);this.setPRG({prg:i})},toggleJoystick:function(){var e=this.joystickPort+1;if(e>2){e=0}this.setJoystickPort(e)},setOnscreenJoystickPort:function(e){var t="";this.joystickPort=e},joystickPush:function(e){var t=this.joystickPort-1;c64_joystickPush(t,e)},joystickRelease:function(e){var t=this.joystickPort-1;c64_joystickRelease(t,e)},keyDown:function(e){if(e.key=="z"&&this.overlayVisible){this.overlayClick()}var t=this.assemblerEditor;if(this.type=="compact"){t=g_app.assemblerEditor}if(this.panelVisible["assembler"]){if(e.key=="F5"){this.removePCMarker();t.run();e.preventDefault()}if(e.key=="F6"){t.build();e.preventDefault()}}else if(this.panelVisible["basic"]){if(e.key=="F5"){this.basic.run();e.preventDefault()}}if(e.key=="F9"){this.play();e.preventDefault()}if(e.key=="F11"||e.key=="F10"){if(debugger_isRunning()){debugger_pause()}else{if(e.key=="F10"){this.stepOver()}else{this.stepInto()}}e.preventDefault()}if(this.c64Focus&&c64_ready){if(c64.joystick.keyDown(e)){return}c64_keydown(e);e.preventDefault()}},keyUp:function(e){if(this.c64Focus&&c64_ready){if(c64.joystick.keyUp(e)){return}c64_keyup(e);e.preventDefault()}},focusMachine:function(){this.c64Focus=true;UI.canProcessKeyEvents=false;$(this.c64CanvasId).focus();if(!g_app.isMobile()){if(this.onlyc64Visible){$("#"+this.c64CanvasId).css("border","2px solid transparent")}else{$("#"+this.c64CanvasId).css("border","2px solid #3343a9")}}},exportAsHTMLPage:function(){if(this.exportAsHTML==null){this.exportAsHTML=new C64DebuggerExportHTML}this.exportAsHTML.show()},blurMachine:function(){this.c64Focus=false;UI.canProcessKeyEvents=true;if(!g_app.isMobile()){$("#"+this.c64CanvasId).css("border","2px solid #111111")}},getJoystickKeySymbol:function(e){if(e==false||e=="false"){return""}switch(e){case"arrowup":return'<img src="icons/material/north-black-18dp.svg"/>';break;case"arrowdown":return'<img src="icons/material/south-black-18dp.svg"/>';break;case"arrowleft":return'<img src="icons/material/west-black-18dp.svg"/>';break;case"arrowright":return'<img src="icons/material/east-black-18dp.svg"/>';break;default:return e}},updateJoystickInfo:function(){var e="";if(typeof c64.joystick=="undefined"){return}for(var t=0;t<2;t++){if(c64.joystick.portEnabled[t]){portNumber=t+1;e+='<div style="margin-left: 8px; color: #cccccc; align-items: center">Joystick '+portNumber+" keys</div>";var i=c64.joystick.joystickKeys[t];var r=i[1];var a=i[6];var s=i[3];var o=i[4];var l=i[8];var n=i[9];var h=c64.joystick.joystickButtons[t];e+='<span class="joystick-info-key">'+this.getJoystickKeySymbol(r)+"</span>";e+='<span class="joystick-info-key">'+this.getJoystickKeySymbol(a)+"</span>";e+='<span class="joystick-info-key">'+this.getJoystickKeySymbol(s)+"</span>";e+='<span class="joystick-info-key">'+this.getJoystickKeySymbol(o)+"</span>";e+='<span class="joystick-info-key">'+this.getJoystickKeySymbol(l)+"</span>";if(h>1){e+='<span class="joystick-info-key">'+this.getJoystickKeySymbol(n)+"</span>"}}}if(e===""){e+='<div style="margin-left: 8px; color: #cccccc; align-items: center">No joystick enabled</div>'}e+='<img class="joystick-settings-icon" src="icons/material/settings-black-18dp.svg"/>';$("#"+this.prefix+"JoystickHolder").html(e);this.resizeC64Panel()},updateDriveLight:function(){var e=c1541_getStatus();if(e!==this.lastDriveStatus){switch(e){case 2:$("#"+this.prefix+"DriveLight").css("background-color","#00ff00");break;case 1:$("#"+this.prefix+"DriveLight").css("background-color","#ff0000");break;case 0:$("#"+this.prefix+"DriveLight").css("background-color","#333333");break}if(e!=0&&!this.driveVisible){$("#"+this.prefix+"DriveInfo").show();this.driveVisible=true}this.lastDriveStatus=e}var t=c1541_getPosition();if(t!==this.lastDrivePosition){$("#"+this.prefix+"DrivePosition").html(t);this.lastDrivePosition=t}},drawGrid:function(){var e=this.context;var t=this.canvas.height;var i=this.canvas.width;var r=36;var a=32;var s=0;var o=0;var l=this.readByte(53270);if((l&8)==0){}s=0;var n=l&7;s=n;var h=this.readByte(53265);if((h&8)==0){}o-=3;n=h&7;o+=n;e.beginPath();e.lineWidth=1;e.strokeStyle="#ffffff";e.globalAlpha=.2;a+=s;r+=o;for(var d=0;d<40;d++){var c=(a+d*8)*this.c64Size+.5;var f=r*this.c64Size;e.moveTo(c,f);e.lineTo(c,f+25*8*this.c64Size)}for(var d=0;d<25;d++){var f=(r+d*8)*this.c64Size+.5;e.moveTo(a*this.c64Size,f);e.lineTo((a+40*8)*this.c64Size,f)}e.stroke();e.globalAlpha=1},drawMousePosition:function(){if(this.mouseX===false||this.mouseY===false){return}var e=this.context;var t=this.canvas.height;var i=this.canvas.width;if(this.mouseInfo){var r=160;var a=160;var s=this.mouseX-r/2;var o=this.mouseY-a/2;var l=this.mouseZoom;var n=r/(this.c64Size*l);var h=a/(this.c64Size*l);var d=this.mouseX/this.c64Size-n/2;var c=this.mouseY/this.c64Size-h/2;this.context.drawImage(this.offscreenCanvas,d,c,n,h,s,o,r,a);this.context.beginPath();this.context.strokeStyle="#cccccc";this.context.rect(s-.5,o-.5,r,a);this.context.stroke();this.context.globalAlpha=1;if(this.grid){var f=0;var u=0;var p=this.readByte(53270);if((p&8)==0){}f=0;var v=p&7;f=v;var g=this.readByte(53265);if((g&8)==0){}u-=3;v=g&7;u+=v;this.context.beginPath();this.context.lineWidth=1;this.context.strokeStyle="#ffffff";this.context.globalAlpha=.2;var m=this.c64Size*l*8;var y=Math.ceil(r/m);var b=-(d%8-f)*this.c64Size*l;for(var C=0;C<=y;C++){var x=b+s+C*m+.5;var S=o;if(x>s&&x<s+r){this.context.moveTo(x,S);this.context.lineTo(x,S+a)}}y=Math.ceil(a/m);var P=-(c%8+4-u)*this.c64Size*l;for(var C=1;C<=y;C++){var x=s;var S=P+o+C*m+.5;if(S>o&&S<o+a){this.context.moveTo(x,S);this.context.lineTo(x+r,S)}}this.context.stroke();this.context.globalAlpha=1}}var x=this.mouseX;var S=this.mouseY;if(this.mouseInfo){e.lineWidth=1;e.strokeStyle="#ffffff";e.globalAlpha=.6;e.beginPath();e.moveTo(x+.5,0);e.lineTo(x+.5,t);e.stroke();e.beginPath();e.moveTo(0,S+.5);e.lineTo(i,S+.5);e.stroke();e.globalAlpha=1}x=Math.floor(x/this.c64Size);S=Math.floor(S/this.c64Size);var s=x;var o=S-36+50;var w="";w="x: "+x+" (0x"+x.toString(16)+")";w+="y: "+S+" (0x"+S.toString(16)+")";var I=S+15;if(I<0){I=0}if(I>=312){I=311}if(!this.mouseLocked){this.mouseC64X=x;this.mouseC64Y=S+15}x=x-32;S=S-36;var k=Math.floor(x/8);if(k<0){k=0}if(k>63){k=63}var M=Math.floor(x/8);var T=Math.floor(S/8);var D=M+T*40;var E=0;var _=0;var B=c64_cia2ReadRegisterAt(I,0,0);var g=c64_vicReadRegisterAt(I,k,17);var p=c64_vicReadRegisterAt(I,k,22);var R=c64_vicReadRegisterAt(I,k,33)&15;var A=c64_vicReadRegisterAt(I,k,34)&15;var F=c64_vicReadRegisterAt(I,k,35)&15;var L=c64_vicReadRegisterAt(I,k,36)&15;c64_debugger_set_inspect_at(I,k);switch(B&3){case 0:_=49152;break;case 1:_=32768;break;case 2:_=16384;break;case 3:_=0;break}var U=(c64_vicReadRegisterAt(I,k,24)&240)>>4;U=U*1024;E=_+U;var H=E+D;var O=55296+D;var G=c64_cpuReadNS(H);var z=c64_cpuReadNS(O)&15;this.mouseChar=G;this.mouseCharX=M;this.mouseCharY=T;this.mouseCharAddress=H;var N=c64_vicReadRegisterAt(I,k,32)&15;w+=" | char x:"+M+", y: "+T+" : "+G+" (0x"+H.toString(16)+")"+I+", brdr:"+N;if(this.eastContent=="charset"){this.c64Charset.setHighlightChar(G)}var W=55296+D;w+="colour: 0x"+W.toString(16);$("#"+this.c64CanvasId+"InspectInfo").html(w);if(this.c64Charset&&this.c64Charset.getVisible()){if(this.mouseCharX>=40||this.mouseCharX<0||this.mouseCharY>=25||this.mouseCharY<0){H=false;W=false}this.c64Charset.debuggerMousePosition(H,W,s,I,z,R,G)}if(this.c64Sprites&&this.c64Sprites.getVisible()){this.c64Sprites.debuggerMousePosition(s,I)}if(this.c64Bitmap&&this.c64Bitmap.getVisible()){this.c64Bitmap.debuggerMousePosition(s,I,z,R,G)}if(this.mouseInfo){var s=this.mouseX-r/2;var o=this.mouseY-a/2;var X="#999999";var Y="#cccccc";var V=18;var q=280;var j=(V+2)*3;var K=s;if(K<0){K=0}if(K+q>this.canvas.width){K=this.canvas.width-q}var Z=o-j-1;if(Z<0){Z=o+a}this.context.globalAlpha=.9;this.context.fillStyle="#111111";this.context.fillRect(K,Z,q,j);this.context.font="10px Verdana";this.context.fillStyle="#cccccc";K=K+4;var J=K;Z=Z+j-8;var Q="";var ee=("0000"+_.toString(16)).substr(-4);Q="";Q="bank";this.context.fillStyle=X;this.context.fillText(Q,K,Z-V*2);K=J+40;Q="$"+ee;this.context.fillStyle="#cccccc";this.context.fillText(Q,K,Z-V*2);K=J+80;Q=" ";if(g&32){this.context.fillStyle="#ffffcc";Q+=" bitmap"}else if(g&64){this.context.fillStyle="#ffcccc";Q+=" extended background"}else{if(p&16){this.context.fillStyle="#aaffaa";Q+=" multicolour char"}else{this.context.fillStyle="#aaaaff";Q+=" standard char"}}this.context.fillText(Q,K,Z-V*2);K=J;Q="rsty";this.context.fillStyle=X;this.context.fillText(Q,K,Z-V);K=J+24;Q=I;this.context.fillStyle=Y;this.context.fillText(Q,K,Z-V);K=J+46;Q="rstx";this.context.fillStyle=X;this.context.fillText(Q,K,Z-V);K=J+70;var te=x+136;Q=te;this.context.fillStyle=Y;this.context.fillText(Q,K,Z-V);K=J+104;Q="sprite x,y";this.context.fillStyle=X;this.context.fillText(Q,K,Z-V);K=J+158;var ie=x+24;var re=I-1;Q=ie+","+re;Q+=" ($"+("000"+ie.toString(16)).substr(-3)+", $"+("00"+re.toString(16)).substr(-2)+")";this.context.fillStyle=Y;this.context.fillText(Q,K,Z-V);K=J;this.context.fillStyle="#cccccc";Q="";Q+=this.mouseCharX+","+this.mouseCharY+" ";this.context.fillText(Q,K,Z);K=J+38;var ae=("0000"+this.mouseCharAddress.toString(16)).substr(-4);Q="";Q+="$"+ae+" ";this.context.fillText(Q,K,Z);K=J+76;Q="ch";this.context.fillStyle=X;this.context.fillText(Q,K,Z);K=J+90;Q=this.mouseChar+" $"+("00"+this.mouseChar.toString(16)).substr(-2);this.context.fillStyle="#cccccc";this.context.fillText(Q,K,Z);K=J+134;Q="fg";this.context.fillStyle=X;this.context.fillText(Q,K,Z);K=J+148;Q="$"+("00"+z.toString(16)).substr(-2);this.context.fillStyle="#cccccc";this.context.fillText(Q,K,Z);K=J+174;Q="bg";this.context.fillStyle=X;this.context.fillText(Q,K,Z);K=J+188;Q="$"+("00"+R.toString(16)).substr(-2);this.context.fillStyle="#cccccc";this.context.fillText(Q,K,Z)}this.context.globalAlpha=1},drawRasterPosition:function(){var e=c64_getRasterY();var t=c64_getVicCycle()*8;var i=this.context;var r=this.canvas.height;var a=this.canvas.width;t=t-13*8;e=e-15;if(this.c64Size!=1){e*=this.c64Size;t*=this.c64Size;r=this.canvas.height;a=this.canvas.width}i.lineWidth=1;i.strokeStyle="#ffffff";i.globalAlpha=.6;i.beginPath();i.moveTo(t+.5,0);i.lineTo(t+.5,r);i.stroke();i.beginPath();i.moveTo(0,e+.5);i.lineTo(a,e+.5);i.stroke();i.globalAlpha=1},redraw:function(){if(!this.imageData){return}var e=c64_getPixelBuffer();var t=384*272*4;var i=new Uint8Array(c64.HEAPU8.subarray(e,e+t));var r=this.imageData.data;r.set(i);this.offscreenContext.putImageData(this.imageData,0,0);this.context.drawImage(this.offscreenCanvas,0,0,this.offscreenCanvas.width,this.offscreenCanvas.height,0,0,this.canvas.width,this.canvas.height);if(this.grid){this.drawGrid()}if(this.mouseX!==false&&this.mouseY!==false){this.drawMousePosition()}},update:function(){if(c64_ready){var e=getTimestamp();var t=g_deltaTime;this.lastUpdate=e;c64.joystick.checkGamepads();if(c64.pastingText){c64.processPasteText()}if(g_app.isMobile()){var i=window.innerWidth>window.innerHeight?90:0;if(i!==this.orientation){this.orientation=i;this.layoutMobile()}}c64_mousePosition(this.mouseC64X,this.mouseC64Y);if(debugger_update(t)||!debugger_isRunning()){this.redraw();if(this.showRaster){this.drawRasterPosition()}this.updateDriveLight()}if(this.type=="compact"){if(debugger_isRunning()!=this.runningButtons){this.updateButtons()}if(this.debuggerContent=="memory"){this.c64Memory.update()}if(this.debuggerContent=="disassembly"){this.disassembly.update()}if(this.debuggerContent=="charset"){this.c64Charset.update()}if(this.debuggerContent=="sprites"){this.c64Sprites.update()}if(this.debuggerContent=="bitmap"){this.c64Bitmap.update()}if(this.debuggerContent=="sid"){this.c64SID.update()}if(this.debuggerContent=="drive"){this.c64Drive.update()}this.c64Registers.update();this.breakpoints.update()}else{if(!g_app.isMobile()){if(debugger_isRunning()!=this.runningButtons){if(!debugger_isRunning()){console.log("sync to source!");this.syncToSource()}this.updateButtons()}if(this.eastContent=="memory"){this.c64Memory.update()}if(this.eastContent=="charset"){this.c64Charset.update()}if(this.eastContent=="sprites"){this.c64Sprites.update()}if(this.eastContent=="bitmap"){this.c64Bitmap.update()}if(this.eastContent=="sid"){this.c64SID.update()}if(this.eastContent=="drive"){this.c64Drive.update()}if(this.westContent=="disassembly"){this.disassembly.update()}this.c64Registers.update();this.breakpoints.update()}}}}};var C64DebuggerExportHTML=function(){this.uiComponent=null;this.assetList=["c64page/index.html","c64page/js/c64.min.js","c64page/js/c64.wasm","c64page/images/arrowkeys.png","c64page/images/c64keychars.png","c64page/images/controls.png","c64page/images/orgamepad.png","c64page/images/plus.png","c64page/images/zkey.png","c64page/images/xkey.png"];this.assets={};this.loadedAssetCount=0};C64DebuggerExportHTML.prototype={loadNextAsset:function(){var i=this.loadedAssetCount;if(i>=this.assetList.length){console.log(this.assets);this.assetsReady();return}var e=this.assetList[i];var t="text";if(e.indexOf(".png")!==-1){t="image/png"}var r=this;var a=new XMLHttpRequest;a.open("GET",e+"?v=0.491",true);a.responseType="arraybuffer";a.onload=function(e){var t=a.response;r.assets[r.assetList[i]]=t;r.loadedAssetCount++;r.loadNextAsset()};a.send(null)},loadAssets:function(){this.loadNextAsset()},show:function(){var e=g_app.c64Debugger;if(!e.checkSharing()){alert("Sorry, sharing has been disabled for this content");return false}if(this.uiComponent==null){var t=420;var i=544;this.uiComponent=UI.create("UI.Dialog",{id:"c64DebuggerExportDialog",title:"Export",width:t,height:i});var r="<h3>Export PRG/D64/CRT as a HTML Page</h3>";r+="<p>Download the current PRG/D64/CRT as a zipped HTML page to upload to websites such as itch.io</p>";r+="<p>Recommended itch.io viewport dimensions: 800x600</p>";r+='<div class="formGroup">';r+='  <label class="controlLabel">Content</label>';r+='  <div class="radioGroup">';r+='    <label class="rb-container">Current PRG';r+='      <input type="radio" name="c64DebuggerExportType" value="prg" checked="checked">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="    <br/>";r+='    <label class="rb-container">Current D64 (Autostart)';r+='      <input type="radio" name="c64DebuggerExportType" value="d64">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="    <br/>";r+='    <label class="rb-container">Current CRT';r+='      <input type="radio" name="c64DebuggerExportType" value="crt">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="    <br/>";r+='    <label class="rb-container">Snapshot';r+='      <input type="radio" name="c64DebuggerExportType" value="snapshot">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="  </div>";r+="</div>";r+='<div class="formGroup" id="c64DebuggerExportPRGOptions">';r+='  <label class="controlLabel">PRG Load Options</label>';r+='  <div class="radioGroup">';r+='    <label class="rb-container">Inject Into RAM (faster)';r+='      <input type="radio" name="c64DebuggerExportPRGLoad" id="c64DebuggerExportPRGLoad_inject" value="inject" checked="checked">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="    <br/>";r+='    <label class="rb-container">Load From D64';r+='      <input type="radio" name="c64DebuggerExportPRGLoad" id="c64DebuggerExportPRGLoad_loadrun" value="loadrun">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="  </div>";r+='  <div class="checkboxGroup">';r+='    <label class="cb-container">Add a Random Delay';r+='      <input type="checkbox" name="c64DebuggerRandomDelay" id="c64DebuggerRandomDelay" value="1" checked="checked">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="  </div>";r+="</div>";r+='<div class="formGroup">';r+='  <label class="controlLabel">Enable Joysticks</label>';r+='  <div class="checkboxGroup">';r+='    <label class="cb-container">Port 1';r+='      <input type="checkbox" id="c64DebuggerJoystickPort1" name="c64DebuggerJoystickPort" value="port1">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="    <br/>";r+='    <label class="cb-container">Port 2';r+='      <input type="checkbox" checked="checked" id="c64DebuggerJoystickPort2" name="c64DebuggerJoystickPort" value="port2">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="  </div>";r+="</div>";r+='<div class="formGroup">';r+='  <label class="controlLabel">Use SID Model</label>';r+='  <div class="radioGroup">';r+='    <label class="rb-container">6581';r+='      <input type="radio" name="c64DebuggerExportSIDModel" value="6581">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="    <br/>";r+='    <label class="rb-container">8580';r+='      <input type="radio" checked="checked" name="c64DebuggerExportSIDModel" value="8580">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="  </div>";r+="</div>";r+='<div class="formGroup">';r+='  <label class="controlLabel">Mobile Controls</label>';r+='  <div class="checkboxGroup">';r+='    <label class="cb-container">Allow Mobile Keyboard';r+='      <input type="checkbox" checked="checked" id="c64DebuggerAllowMobileKeyboard">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="    <br/>";r+='    <label class="cb-container">Allow Mobile Joystick';r+='      <input type="checkbox" checked="checked" id="c64DebuggerAllowMobileJoystick">';r+='      <span class="checkmark"></span>';r+="    </label>";r+="  </div>";r+="</div>";r+='<div id="c64ExportHTMLLoadingMessage">';r+='  <label class="controlLabel">&nbsp;</label>';r+='  <img src="images/loading.gif">';r+='  <span style="font-weight: 600">loading assets...</font>';r+="</div>";r+='<div id="c64ExportHTMLDownloadMessage">';r+='  <label class="controlLabel">&nbsp;</label>';r+='<div id="c64ExportHTMLDownloadButton" class="ui-button ui-button-primary"><img src="icons/svg/glyphicons-basic-199-save.svg"> Download</div>';r+="</div>";var a=UI.create("UI.HTMLPanel",{html:r});this.uiComponent.add(a);this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});var s=this;UI.on("ready",function(){});this.uiComponent.on("close",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});UI.showDialog("c64DebuggerExportDialog");$("#c64ExportHTMLLoadingMessage").show();$("#c64ExportHTMLDownloadMessage").hide();this.loadAssets();this.initEvents()}else{UI.showDialog("c64DebuggerExportDialog")}if(typeof g_app.c64Debugger.prgLoadMethod!="undefined"){var o=g_app.c64Debugger.prgLoadMethod;var l="c64DebuggerExportPRGLoad_"+g_app.c64Debugger.prgLoadMethod;$("#"+l).prop("checked",true)}this.setPRGLoadVisibility();g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true)},setPRGLoadVisibility:function(){var e=$("input[name=c64DebuggerExportType]:checked").val();if(e=="prg"){$("#c64DebuggerExportPRGOptions").show()}else{$("#c64DebuggerExportPRGOptions").hide()}},initEvents:function(){var r=this;$("input[name=c64DebuggerExportType]").on("click",function(){r.setPRGLoadVisibility()});$("#c64ExportHTMLDownloadButton").on("click",function(){var e={};e["type"]=$("input[name=c64DebuggerExportType]:checked").val();e["prgstart"]=$("input[name=c64DebuggerExportPRGLoad]:checked").val();e["prgrandomdelay"]=$("#c64DebuggerRandomDelay").is(":checked");e["port1"]=$("#c64DebuggerJoystickPort1").is(":checked");e["port2"]=$("#c64DebuggerJoystickPort2").is(":checked");e["sid"]=$("input[name=c64DebuggerExportSIDModel]:checked").val();e["mobileKeyboard"]=$("#c64DebuggerAllowMobileKeyboard").is(":checked");e["mobileJoystick"]=$("#c64DebuggerAllowMobileJoystick").is(":checked");for(var t=0;t<2;t++){var i=t+1;c64.joystick;e["port"+i+"buttons"]=c64.joystick.getJoystickButtons(t);e["port"+i+"buttonactions"]="['fire','"+c64.joystick.getJoystickButtonAction(t,1)+"']"}r.download(e)})},assetsReady:function(){$("#c64ExportHTMLLoadingMessage").hide();$("#c64ExportHTMLDownloadMessage").show()},download:function(e){var t=g_app.c64Debugger;if(!t.checkSharing()){alert("Sorry, sharing has been disabled for this content");return false}if(g_app.c64Debugger.prgData==null){}var i=false;var r="prg";if(typeof e.type!="undefined"){r=e.type}var a="";a+="var g_c64Settings = {";a+='"colors":[';for(var s=0;s<c64.colors.colors.length;s++){if(s!=0){a+=","}a+="0x"+("00000000"+c64.colors.colors[s].toString(16)).substr(-8)}a+="],";if(e["port1"]){a+='"port1":true,'}else{a+='"port1":false,'}if(e["port2"]){a+='"port2":true,'}else{a+='"port2":false,'}if(typeof e["port1buttons"]!="undefined"){a+='"port1buttons":'+e["port1buttons"]+","}if(typeof e["port2buttons"]!="undefined"){a+='"port2buttons":'+e["port2buttons"]+","}if(typeof e["port1buttonactions"]!="undefined"){a+='"port1buttonactions":'+e["port1buttonactions"]+","}if(typeof e["port2buttonactions"]!="undefined"){a+='"port2buttonactions":'+e["port2buttonactions"]+","}a+='"sid": "'+e["sid"]+'",';if(e["mobileJoystick"]){a+='"mobileJoystick": true,'}else{a+='"mobileJoystick": false,'}if(e["mobileKeyboard"]){a+='"mobileKeyboard": true,'}else{a+='"mobileKeyboard": false,'}if(r=="prg"&&typeof e["prgstart"]!="undefined"){a+='"prgLoadMethod": "'+e["prgstart"]+'"';if(typeof e["prgrandomdelay"]!="undefined"){a+=",";a+='"prgRandomDelay": "'+e["prgrandomdelay"]+'"'}}a+="};\n";if(r=="prg"){if(g_app.c64Debugger.prgData==null){alert("Please load a prg first");return}i=bufferToBase64(g_app.c64Debugger.prgData);a+='var g_prg = "';a+=i;a+='";\n'}if(r=="d64"){if(g_app.c64Debugger.d64Data==null){alert("Please attach or autostart a d64 first");return}i=bufferToBase64(g_app.c64Debugger.d64Data);a+='var g_d64 = "';a+=i;a+='";\n'}if(r=="crt"){if(g_app.c64Debugger.crtData==null){alert("Please insert a crt first");return}i=bufferToBase64(g_app.c64Debugger.crtData);a+='var g_crt = "';a+=i;a+='";\n'}if(r=="snapshot"){var o=c64_getSnapshot();var l=c64_getSnapshotSize();var n=new Uint8Array(c64.HEAPU8.subarray(o,o+l));var i=bufferToBase64(n);a+='var g_snapshot = "';a+=i;a+='";\n'}var h=new JSZip;h.file("index.html",this.assets["c64page/index.html"]);h.file("js/c64.min.js",this.assets["c64page/js/c64.min.js"]);h.file("js/c64.wasm",this.assets["c64page/js/c64.wasm"]);h.file("js/content.js",a);h.file("images/arrowkeys.png",this.assets["c64page/images/arrowkeys.png"]);h.file("images/c64keychars.png",this.assets["c64page/images/c64keychars.png"]);h.file("images/controls.png",this.assets["c64page/images/controls.png"]);h.file("images/orgamepad.png",this.assets["c64page/images/orgamepad.png"]);h.file("images/plus.png",this.assets["c64page/images/plus.png"]);h.file("images/zkey.png",this.assets["c64page/images/zkey.png"]);h.file("images/xkey.png",this.assets["c64page/images/xkey.png"]);var d="prg";h.generateAsync({type:"blob"}).then(function(e){download(e,d+".zip","application/zip")})}};var C64GistShare=function(){this.uiComponent=null;this.shareType="prg";this.shareView="current"};C64GistShare.prototype={init:function(e){this.githubClient=e},getLoginHTML:function(){var e='<div class="c64ShareSection" id="c64ShareLogin">';e+="  <h2>Sign in to GitHub to Share Project</h2>";e+="  <div>";e+="    <p>Files are shared by creating a ";e+='    <a href="https://docs.github.com/en/free-pro-team@latest/github/writing-on-github/editing-and-sharing-content-with-gists" target="_blank">GitHub secret Gist</a>';e+="    .</p>";e+="    <p>To share your content, you will need to login to GitHub.</p>";e+="  </div>";e+='  <div class="ui-button ui-button-info" id="c64ShareRegisterGitHub" style="padding: 4px; height: auto; line-height: 20px">';e+='    <img style="margin-right: 6px; margin-top: -4px" src="icons/GitHub-Mark-32px.png">';e+="    GitHub Login / Register";e+="  </div>";e+="</div>";return e},getAddScopeHTML:function(){var e="";e+='<div class="c64ShareSection" id="c64ShareAddScope">';e+="  <h2>Require Permission to create Gists</h2>";e+="  <div>";e+="    <p>Files are shared by creating a ";e+='    <a href="https://docs.github.com/en/free-pro-team@latest/github/writing-on-github/editing-and-sharing-content-with-gists" target="_blank">GitHub secret Gist</a>';e+="    .</p>";e+="    <p>To share a your project, you will need to allow lvllvl to create Gists.</p>";e+="  </div>";e+='  <div class="ui-button ui-button-info" id="c64ShareAddScope" style="padding: 4px; height: auto; line-height: 20px">';e+='    <img style="margin-right: 6px; margin-top: -4px" src="icons/GitHub-Mark-32px.png">';e+="    Allow Gist Access";e+="  </div>";e+="</div>";return e},getShareLinkHTML:function(){var e="";e+='<div class="c64ShareSection" id="c64ShareLinkGenerated">';e+="  <h2>Share Link</h2>";e+="  <div>";e+="    <p>A secret Gist has been created on GitHub.</p>";e+="    <p>You can use the link below to share your content.</p>";e+="  </div>";e+='<input type="text" size="40" id="c64ShareLink">';e+='<div class="ui-button ui-button-primary" id="c64ShareLinkCopy"><img src="icons/svg/glyphicons-basic-614-copy.svg">&nbsp;Copy To Clipboard</div>';e+="</div>";return e},getShareLinkProgressHTML:function(){html="";html+='<div id="c64ShareLinkProgress" class="c64ShareSection" style="display: none">';html+="  uploading...";html+="</div>";return html},getOptionsHTML:function(){var e="<h3>Create a share link</h3>";var t=[{label:"Current PRG",value:"prg"},{label:"Current D64 (Autostart)",value:"d64"},{label:"Current CRT",value:"crt"},{label:"Assembly Source",value:"assembly"},{label:"BASIC",value:"basic"},{label:"Script",value:"script"},{label:"Snapshot",value:"snapshot"}];e+='<div class="c64ShareSection" id="c64ShareOptions">';e+='  <div class="formGroup">';e+='    <label class="controlLabel">Content</label>';e+='    <select id="c64ShareType" name="c64ShareType">';for(var i=0;i<t.length;i++){e+='    <option value="'+t[i].value+'">'+t[i].label+"</option>"}e+="    </select>";e+="  </div>";e+='  <div class="formGroup">';e+='    <label class="controlLabel">Default View</label>';e+='    <select name="c64ShareView" id="c64ShareView">';e+='      <option value="c64only">C64 Only</option>';e+='      <option value="current">Current View</option>';e+="    </select>";e+="  </div>";e+='<div class="formGroup">';e+='  <label class="controlLabel">Enable Joysticks</label>';e+='  <div class="checkboxGroup">';e+='    <label class="cb-container">Port 1';e+='      <input type="checkbox" id="c64ShareJoystickPort1" name="c64ShareJoystickPort" value="port1">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="    <br/>";e+='    <label class="cb-container">Port 2';e+='      <input type="checkbox" id="c64ShareJoystickPort2" name="c64ShareJoystickPort" value="port2">';e+='      <span class="checkmark"></span>';e+="    </label>";e+="  </div>";e+="</div>";e+='  <div class="formGroup">';e+='    <label class="controlLabel">Options</label>';e+='    <div class="checkboxGroup">';e+='      <label class="cb-container">Allow Snapshot Download';e+='        <input type="checkbox" name="c64ShareSnapshot" id="c64ShareSnapshot" value="1" checked="checked">';e+='        <span class="checkmark"></span>';e+="      </label>";e+="      <br/>";e+='      <label class="cb-container">Allow Share';e+='        <input type="checkbox" name="c64ShareAllowShare" id="c64ShareAllowShare" value="1" checked="checked">';e+='        <span class="checkmark"></span>';e+="      </label>";e+="    </div>";e+="  </div>";e+='  <div class="ui-button ui-button-info" id="c64ShareCreateGist" style="padding: 4px; height: auto; line-height: 20px">';e+='    <img style="margin-right: 6px; margin-top: -4px" src="icons/GitHub-Mark-32px.png">';e+="    Create Share Link";e+="  </div>";e+="</div>";return e},buildInterface:function(){var e=500;var t=500;this.uiComponent=UI.create("UI.Dialog",{id:"c64gistsharedialog",title:"Share",width:e,height:t});var i=this.getOptionsHTML();i+=this.getLoginHTML();i+=this.getAddScopeHTML();i+=this.getShareLinkProgressHTML();i+=this.getShareLinkHTML();var r=UI.create("UI.HTMLPanel",{html:i});this.uiComponent.add(r);this.closeButton=UI.create("UI.Button",{text:"Close",color:"secondary"});this.uiComponent.addButton(this.closeButton);this.closeButton.on("click",function(e){UI.closeDialog()});this.uiComponent.on("close",function(){g_app.setAllowKeyShortcuts(true);UI.setAllowBrowserEditOperations(false)});this.initEvents()},initEvents:function(){var t=this;$("#c64ShareType").on("change",function(){var e=$(this).val();t.shareType=e});$("c64ShareView").on("change",function(){var e=$("c64ShareView").val();t.shareView=e});$("#c64ShareRegisterGitHub").on("click",function(){g_app.githubClient.login(function(){t.userHasLoggedIn()},["gist"])});$("#c64ShareAddScope").on("click",function(){var e=g_app.githubClient.getScopes();e.push("gist");g_app.githubClient.login(function(){t.userHasLoggedIn()},e)});$("#c64ShareCreateGist").on("click",function(){t.createShareLink()});$("#c64ShareLinkCopy").on("click",function(){t.copyShareLink()})},show:function(e){if(this.uiComponent==null){this.buildInterface()}var t=g_app.c64Debugger;if(!t.checkSharing()){alert("Sorry, sharing has been disabled for this content");return false}UI.showDialog("c64gistsharedialog");g_app.setAllowKeyShortcuts(false);UI.setAllowBrowserEditOperations(true);var t=g_app.c64Debugger;if(t.d64Data){this.shareType="d64"}else if(t.prgData){this.shareType="prg"}else if(t.crtData){this.shareType="crt"}if(typeof e!="undefined"){if(typeof e.type!="undefined"){this.shareType=e.type}if(typeof e.view!="undefined"){this.shareView=e.view}}$("#c64ShareType").val(this.shareType);$("#c64ShareView").val(this.shareView);$("#c64ShareJoystickPort1").prop("checked",c64.joystick.portEnabled[0]);$("#c64ShareJoystickPort2").prop("checked",c64.joystick.portEnabled[1]);$(".c64ShareSection").hide();var i=g_app.githubClient;if(!i.isLoggedIn()){$("#c64ShareLogin").show()}else if(!i.hasScope("gist")){$("#c64ShareAddScope").show()}else{this.userHasLoggedIn()}},userHasLoggedIn:function(){$(".c64ShareSection").hide();$("#c64ShareOptions").show()},createShareLink:function(){var e=g_app.c64Debugger;if(!e.checkSharing()){alert("Sorry, sharing has been disabled for this content");return false}var t=c64.colors.colors;var i=$("#c64ShareJoystickPort1").is(":checked");var r=$("#c64ShareJoystickPort2").is(":checked");var a=c64.joystick.joystickButtons[0];var s=c64.joystick.joystickButtons[1];var o=c64.joystick.joystickButtonActions[0][1];var l=c64.joystick.joystickButtonActions[1][1];var n=$("#c64ShareSnapshot").is(":checked");var h=$("#c64ShareAllowShare").is(":checked");var d=c64.joystick.mousePortEnabled[0];var c=c64.joystick.mousePortEnabled[1];var f={colors:t,port1:i,port2:r,port1Buttons:a,port2Buttons:s,port1Button1Action:o,port2Button1Action:l,mousePort1:d,mousePort2:c,snapshotDownload:n,share:h};var u={};var p=[];if(this.shareView=="current"){var v=[];for(var g in e.panelVisible){if(e.panelVisible[g]){v.push(g)}}f["view"]=v}else{f["view"]=[]}if(this.shareType=="prg"){if(e.prgData){var m=e.prgName;var y=bufferToBase64(e.prgData);u[m]={content:y}}f["prgstart"]=g_app.c64Debugger.prgLoadMethod;f["prgRandomDelay"]=g_app.c64Debugger.getRandomDelayEnabled()}if(this.shareType=="d64"){if(e.d64Data){var b=e.d64Name;var y=bufferToBase64(e.d64Data);u[b]={content:y}}}if(this.shareType=="crt"){if(e.crtData){var C=e.crtName;var y=bufferToBase64(e.crtData);u[C]={content:y}}}if(this.shareType=="assembly"){var x=[];x=e.assemblerEditor.collectSourceFiles("/asm",x,["asm","folder"]);console.log("ASSEMBLY FILES: ");console.log(u);for(var S=0;S<x.length;S++){var P=x[S].filePath;var w=x[S].type;if(w!=="folder"){if(P.length>0&&P[0]=="/"){P=P.substr(1)}P="asm/"+P;P=P.replace(/\//g,g_gistPathSeparator);u[P]={content:x[S].content}}}p.push("assembler")}if(this.shareType=="basic"){var P="/scripts/c64.bas";var I=g_app.doc.getDocRecord(P);if(I){u["c64.bas"]={content:I.data}}p.push("basic")}if(this.shareType=="script"){var P="/scripts/c64.js";var I=g_app.doc.getDocRecord(P);if(I){u["c64.js"]={content:I.data}}p.push("script")}if(this.shareType=="snapshot"){var k=c64_getSnapshot();var M=c64_getSnapshotSize();var v=new Uint8Array(c64.HEAPU8.subarray(k,k+M));var y=bufferToBase64(v);u["c64snapshot"]={content:y}}if(p.length>0){f["autostart"]=p}u["c64settings"]={content:JSON.stringify(f)};$(".c64ShareSection").hide();$("#c64ShareLinkProgress").show();console.log(u);var T=this;g_app.githubClient.createGist({files:u},function(e){console.log(e);var t=e.data.id;T.showLink({id:t})})},showLink:function(e){var t="https://lvllvl.com/c64/?gid="+e.id;$(".c64ShareSection").hide();$("#c64ShareLinkGenerated").show();$("#c64ShareLink").val(t)},copyShareLink:function(){$("#c64ShareLink").focus();$("#c64ShareLink").select();document.execCommand("copy")}};var REGA=0;var REGX=1;var REGY=2;var REGSP=3;var C64DebuggerCompact=function(){this.uiComponent=null;this.disassembly=null;this.c64Memory=null;this.c64Registers=null;this.c64Charset=null;this.c64Sprites=null;this.breakpoints=null;this.onscreenJoystick=null;this.onscreenKeyboard=null;this.lastDriveStatus=false;this.lastDrivePosition=false;this.c64Focus=true;this.prefix="c64compactpre";this.debuggerContent="disassembly";this.runningButtons=true;this.showRaster=false;this.c64Size=1;this.joystickPort=1;this.lastUpdate=getTimestamp();this.offscreenCanvas=null;this.imageData=null};C64DebuggerCompact.prototype={init:function(e){},setSize:function(e){switch(e){case 1:UI("c64-size-1").setChecked(true);UI("c64-size-2").setChecked(false);this.c64Size=1;break;case 2:this.c64Size=2;break}this.canvas.width=this.offscreenCanvas.width*this.c64Size;this.canvas.height=this.offscreenCanvas.height*this.c64Size;this.context=this.canvas.getContext("2d");this.context.imageSmoothingEnabled=false;this.context.webkitImageSmoothingEnabled=false;this.context.mozImageSmoothingEnabled=false;this.context.msImageSmoothingEnabled=false;this.context.oImageSmoothingEnabled=false;if(this.c64Focus){this.focusMachine()}else{this.blurMachine()}},show:function(){if(this.offscreenCanvas==null){this.offscreenCanvas=document.createElement("canvas");this.offscreenCanvas.width=384;this.offscreenCanvas.height=272;this.offscreenContext=this.offscreenCanvas.getContext("2d");this.imageData=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height);this.canvas=document.getElementById("c64DebuggerCompactCanvas");this.canvas.width=384;this.canvas.height=272;this.context=this.canvas.getContext("2d");this.setSize(1);this.c64Memory=new DbgMemory;this.c64Memory.init({debugger:this,machine:this.c64,prefix:this.prefix});this.c64Memory.buildInterface(this.memoryPanel);this.disassembly=new DbgDisassembly;this.disassembly.init({prefix:this.prefix,debugger:this,machine:this.c64});this.disassembly.buildInterface(this.disassemblyPanel);this.c64Charset=new DbgCharset;this.c64Charset.init({debugger:this,machine:this.c64,prefix:this.prefix});this.c64Charset.buildInterface(this.charsetPanel);this.c64Sprites=new DbgSprites;this.c64Sprites.init({debugger:this,machine:this.c64,prefix:this.prefix});this.c64Sprites.buildInterface(this.spritesPanel);this.c64Registers=new DbgRegisters;this.c64Registers.init({prefix:this.prefix,debugger:this,machine:this.c64});this.c64Registers.buildInterface(this.registersPanel);this.breakpoints=new DbgBreakpoints;this.breakpoints.init({prefix:this.prefix,debugger:this,machine:this.c64});this.breakpoints.buildInterface(this.breakpointsPanel)}this.resize()},resize:function(){UI(this.prefix+"DisassemblyCanvas").resize();UI(this.prefix+"MemoryCanvas").resize();UI(this.prefix+"RegistersCanvas").resize();UI(this.prefix+"BreakpointsCanvas").resize()},buildInterface:function(e){var r=this;this.uiComponent=UI.create("UI.Panel",{id:"c64debuggerCompactPanel"});e.add(this.uiComponent);var t=UI.create("UI.SplitPanel",{id:"c64DebuggerCompactSplitPanel"});this.uiComponent.add(t);var i="";i+='<div style="position: relative">';i+='  <div style="margin: 4px 0; position: relative">';i+='    <div class="ui-button" id="c64CompactPlay" style="width: 68px"><i class="halflings halflings-pause"></i>&nbsp;Pause (F9)</div>';i+='    <div class="ui-button ui-button-disabled" id="c64CompactStep">Step (F10)</div>';i+='    <div class="ui-button ui-button-disabled" style="display: none" id="c64CompactStepCycle">Step 1/2 Cycle</div>';i+="  </div>";i+="</div>";var a="";a+='<div style="padding: 4px">';a+='      <label class="cb-container">Show raster position';a+='        <input type="checkbox" id="c64CompactShowRaster" name="c64CompactShowRaster" value="1">';a+='        <span class="checkmark"></span>';a+="      </label>";a+='  <div style="margin: 4px 0; position: absolute; right: 4px; top: 3px">';a+="    Joystick";a+='    <div style="display: inline-block">';a+='      <label class="rb-container">None';a+='        <input type="radio" id="c64CompactJoystickPort0" name="c64CompactJoystickPort" checked="checked" value="0">';a+='        <span class="checkmark"></span>';a+="      </label>";a+='      <label class="rb-container">Port 1';a+='        <input type="radio" id="c64CompactJoystickPort1" name="c64CompactJoystickPort" value="1">';a+='        <span class="checkmark"></span>';a+="      </label>";a+='      <label class="rb-container">Port 2';a+='        <input type="radio" id="c64CompactJoystickPort1" name="c64CompactJoystickPort" value="2">';a+='        <span class="checkmark"></span>';a+="      </label>";a+="    </div>";a+="  </div>";a+="</div>";a+="<div>";a+='<form id="c64DebuggerCompactForm">';a+='  <input class="formControl"  id="c64CompactChoosePRG" type="file" accept=".prg" style="position: absolute; top: -50px; left: -100px" />';a+='  <input class="formControl"  id="c64CompactChooseD64" type="file" accept=".d64" style="position: absolute; top: -50px; left: -150px" />';a+='  <input class="formControl"  id="c64CompactChooseCRT" type="file" accept=".crt" style="position: absolute; top: -50px; left: -150px" />';a+="</form>";a+='  <canvas id="c64DebuggerCompactCanvas" style="cursor: default; border: 2px solid #111111"></canvas>';a+='  <canvas id="c64DebuggerCompactCanvasResize"  style="cursor: default; border: 2px solid #111111"></canvas>';a+="</div>";var s=UI.create("UI.HTMLPanel",{id:"c64DebuggerCompactHTML",html:a});this.registersPanel=UI.create("UI.Panel");this.cpuPanel=UI.create("UI.SplitPanel");t.add(this.cpuPanel);this.cpuPanel.addNorth(s,280);this.breakpointsPanel=UI.create("UI.Panel");this.cpuPanel.addSouth(this.breakpointsPanel,100);var o=UI.create("UI.SplitPanel");this.cpuPanel.add(o);var l=UI.create("UI.HTMLPanel",{html:i});var n=UI.create("UI.SplitPanel");o.addNorth(this.registersPanel,38,false);o.add(n);o.addSouth(l,40,false);this.tabPanel=UI.create("UI.TabPanel",{canCloseTabs:false});this.tabPanel.addTab({key:"disassembly",title:"Disassembly",isTemp:false},true);this.tabPanel.addTab({key:"memory",title:"Memory",isTemp:false},false);this.tabPanel.addTab({key:"charset",title:"Charset",isTemp:false},false);this.tabPanel.addTab({key:"sprites",title:"Sprites",isTemp:false},false);this.tabPanel.on("tabfocus",function(e,t){var i=r.tabPanel.getTabIndex(e);if(i>=0){r.showDebuggerContent(e)}});this.debuggerOutputPanel=UI.create("UI.Panel");n.add(this.debuggerOutputPanel);n.addNorth(this.tabPanel,30,false);this.disassemblyPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactDisassembly"});this.debuggerOutputPanel.add(this.disassemblyPanel);this.memoryPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactMemory"});this.debuggerOutputPanel.add(this.memoryPanel);this.charsetPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactCharset"});this.debuggerOutputPanel.add(this.charsetPanel);this.spritesPanel=UI.create("UI.Panel",{id:"c64DebuggerCompactSprites"});this.debuggerOutputPanel.add(this.spritesPanel);UI.on("ready",function(){r.showDebuggerContent("disassembly");r.initEvents()})},showDebuggerContent:function(e){this.debuggerContent=e;switch(e){case"disassembly":this.debuggerOutputPanel.showOnly("c64DebuggerCompactDisassembly");break;case"memory":this.debuggerOutputPanel.showOnly("c64DebuggerCompactMemory");break;case"charset":this.debuggerOutputPanel.showOnly("c64DebuggerCompactCharset");break;case"sprites":this.debuggerOutputPanel.showOnly("c64DebuggerCompactSprites");break}this.debuggerOutputPanel.resize()},initEvents:function(){var i=this;$("input[name=c64CompactJoystickPort]").on("click",function(){var e=$("input[name=c64CompactJoystickPort]:checked").val();i.setJoystickPort(e)});$("#c64CompactShowRaster").on("click",function(){var e=$(this).is(":checked");i.setShowRaster(e)});$("#c64CompactPlay").on("click",function(){i.play()});$("#c64CompactStep").on("click",function(){i.step()});$("#c64CompactStepCycle").on("click",function(){i.stepCycle()});$("#c64CompactReset").on("click",function(){i.machineReset()});$("#c64DebuggerCompactCanvas").on("click",function(e){i.focusMachine()});$("#c64DebuggerCompactCanvasResize").on("click",function(e){i.focusMachine()});document.getElementById("c64CompactChoosePRG").addEventListener("change",function(e){var t=document.getElementById("c64CompactChoosePRG").files[0];i.loadPRGFile(t)});document.getElementById("c64CompactChooseD64").addEventListener("change",function(e){var t=document.getElementById("c64CompactChooseD64").files[0];i.attachD64(t)});document.getElementById("c64CompactChooseCRT").addEventListener("change",function(e){var t=document.getElementById("c64CompactChooseCRT").files[0];i.inserCRT(t)})},choosePRG:function(){$("#c64CompactChoosePRG").click()},chooseD64:function(){$("#c64CompactChooseD64").click()},chooseCRT:function(){$("#c64CompactChooseCRT").click()},loadPRGFile:function(e){var i=new FileReader;i.onload=function(e){var t=new Uint8Array(i.result);c64_reset();c64_loadPRG(t,t.length,false)};i.readAsArrayBuffer(e);this.prgFile=e;this.prgData=null},attachD64:function(e){var i=new FileReader;i.onload=function(e){var t=new Uint8Array(i.result);c64_insertDisk(t,t.length)};i.readAsArrayBuffer(e);var t=e.name;$("#c64DebuggerAttachedDisk").html(t)},insertCRT:function(e){var i=new FileReader;i.onload=function(e){var t=new Uint8Array(i.result);console.log("INSERT CRT!!!");console.log(t)};i.readAsArrayBuffer(e)},step:function(){if(!debugger_isRunning()){debugger_step();if(this.showRaster){this.drawRasterPosition()}}},stepCycle:function(){return;if(!this.c64.isRunning()){this.c64.stepCycle()}},updateButtons:function(){console.log("updateButtons");if(debugger_isRunning()){this.runningButtons=true;$("#c64CompactPlay").html('<i class="halflings halflings-pause"></i>&nbsp;Pause (F9)');$("#c64CompactStep").addClass("ui-button-disabled");$("#c64CompactStepCycle").addClass("ui-button-disabled")}else{this.runningButtons=false;$("#c64CompactPlay").html('<i class="halflings halflings-play"></i>&nbsp;Play (F9)');$("#c64CompactStep").removeClass("ui-button-disabled");$("#c64CompactStepCycle").removeClass("ui-button-disabled")}},play:function(){if(debugger_isRunning()){debugger_pause()}else{debugger_play()}this.updateButtons()},machineReset:function(){$("#c64DebuggerAttachedDisk").html("");c64_reset()},setPRG:function(e){c64_reset();c64_loadPRG(e.prg,e.prg.length,false);if(typeof e.report!="undefined"){this.disassembly.setReport(e.report);this.c64Memory.setReport(e.report)}else{this.disassembly.setReport([]);this.c64Memory.setReport([])}},readByte:function(e){var t=c64_cpuRead(e);return t&255},writeByte:function(e,t){c64_cpuWrite(e,t)},vicReadRegister:function(e){return c64_vicReadRegister(e)&255},vicRead:function(e){return c64_vicRead(e)&255},getRegA:function(){return c64_getRegA()},setRegA:function(e){c64_setRegA(e)},getRegX:function(){return c64_getRegX()},setRegX:function(e){c64_setRegX(e)},getRegY:function(){return c64_getRegY()},setRegY:function(e){c64_setRegY(e)},getRegSP:function(){return 0},setRegSP:function(e){},getPC:function(){return c64_getPC()},setPC:function(e){c64_setPC(e)},getFlagN:function(){return c64_getFlagN()},setFlagN:function(e){c64_setFlagN(e)},getFlagV:function(){return c64_getFlagV()},setFlagV:function(e){c64_setFlagV(e)},getFlagB:function(){return c64_getFlagB()},setFlagB:function(e){c64_setFlagB(e)},getFlagD:function(){return c64_getFlagD()},setFlagD:function(e){c64_setFlagD(e)},getFlagI:function(){return c64_getFlagI()},setFlagI:function(e){c64_setFlagI(e)},getFlagZ:function(){return c64_getFlagZ()},setFlagZ:function(e){c64_setFlagZ(e)},getFlagC:function(){return c64_getFlagC()},setFlagC:function(e){return c64_setFlagC(e)},getVC:function(){return 0},getRstY:function(){return c64_getRasterY()},getRstX:function(){return 0},getCycleCount:function(e){return c64_getCycleCount(e)},getPCBreakpoints:function(){return[]},getMemoryBreakpoints:function(){return[]},getRasterYBreakpoints:function(){return[]},showFile:function(e){var t=g_app.doc.getDocRecord(e);if(!t){return}var i=base64ToBuffer(t.data);this.setPRG(i)},toggleAudio:function(){if(this.c64.getAudioEnabled()){this.c64.stopAudio();UI("c64-sound").setChecked(false)}else{this.c64.startAudio();UI("c64-sound").setChecked(true)}},toggleShowRaster:function(){this.setShowRaster(!this.showRaster)},setShowRaster:function(e){this.showRaster=e;UI("c64-viewraster").setChecked(e);$("#c64CompactShowRaster").prop("checked",e);if(e){this.drawRasterPosition()}},setJoystickPort:function(e){var t="";this.joystickPort=e;if(e===0){UI("c64-joysticknone").setChecked(true);UI("c64-joystick1").setChecked(false);UI("c64-joystick2").setChecked(false);t+="None"}else{UI("c64-joysticknone").setChecked(false);if(e==1){t+="Port 1";UI("c64-joystick1").setChecked(true);UI("c64-joystick2").setChecked(false);$("#c64CompactJoystickPort1").prop("checked",true)}if(e==2){t+="Port 2";UI("c64-joystick1").setChecked(false);UI("c64-joystick2").setChecked(true);$("#c64CompactJoystickPort2").prop("checked",true)}}$("#c64DebuggerJoystick").html(t)},keyDown:function(e){if(e.key=="F5"){g_app.assemblerEditor.run();e.preventDefault()}if(e.key=="F6"){g_app.assemblerEditor.build();e.preventDefault()}if(e.key=="F9"){this.play();e.preventDefault()}if(e.key=="F11"||e.key=="F10"){if(debugger_isRunning()){debugger_pause()}else{debugger_step()}e.preventDefault()}if(this.c64Focus){if(this.joystickPort!=0){var t=this.joystickPort-1;e.preventDefault();var i=e.key.toLowerCase();switch(i){case"arrowdown":c64_joystickPush(t,C64_JOYSTICK_DOWN);return;break;case"arrowup":c64_joystickPush(t,C64_JOYSTICK_UP);return;break;case"arrowleft":c64_joystickPush(t,C64_JOYSTICK_LEFT);return;break;case"arrowright":c64_joystickPush(t,C64_JOYSTICK_RIGHT);return;break;case"z":c64_joystickPush(t,C64_JOYSTICK_FIRE);return;break}}c64_keydown(e)}},keyUp:function(e){if(this.c64Focus){if(this.joystickPort!=0){var t=this.joystickPort-1;e.preventDefault();var i=e.key.toLowerCase();switch(i){case"arrowdown":c64_joystickRelease(t,C64_JOYSTICK_DOWN);return;break;case"arrowup":c64_joystickRelease(t,C64_JOYSTICK_UP);return;break;case"arrowleft":c64_joystickRelease(t,C64_JOYSTICK_LEFT);return;break;case"arrowright":c64_joystickRelease(t,C64_JOYSTICK_RIGHT);return;break;case"z":c64_joystickRelease(t,C64_JOYSTICK_FIRE);return;break}}c64_keyup(e)}},focusMachine:function(){this.c64Focus=true;if(this.c64Size==1){$("#c64DebuggerCompactCanvas").focus();$("#c64DebuggerCompactCanvas").css("border","2px solid #3343a9")}if(this.c64Size==2){$("#c64DebuggerCompactCanvasResize").focus();$("#c64DebuggerCompactCanvasResize").css("border","2px solid #3343a9")}},blurMachine:function(){if(this.c64Size==1){$("#c64DebuggerCompactCanvas").css("border","2px solid #111111")}if(this.c64Size==2){$("#c64DebuggerCompactCanvasResize").css("border","2px solid #111111")}this.c64Focus=false},updateDriveLight:function(){var e=c1541_getStatus();if(e!==this.lastDriveStatus){switch(e){case 2:$("#c64DebuggerDriveLight").css("background-color","#00ff00");break;case 1:$("#c64DebuggerDriveLight").css("background-color","#ff0000");break;case 0:$("#c64DebuggerDriveLight").css("background-color","#333333");break}this.lastDriveStatus=e}var t=c1541_getPosition();if(t!==this.lastDrivePosition){$("#c64DebuggerDrivePosition").html(t);this.lastDrivePosition=t}},drawRasterPosition:function(){var e=c64_getRasterY();var t=0;var i=this.context;var r=this.canvas.height;var a=this.canvas.width;i.lineWidth=1;i.strokeStyle="#ffffff";i.globalAlpha=.6;i.beginPath();i.moveTo(t+.5,0);i.lineTo(t+.5,r);i.stroke();i.beginPath();i.moveTo(0,e+.5);i.lineTo(a,e+.5);i.stroke();i.globalAlpha=1},redraw:function(){var e=c64_getPixelBuffer();var t=384*272*4;var i=new Uint8Array(c64.HEAPU8.subarray(e,e+t));var r=this.imageData.data;r.set(i);this.offscreenContext.putImageData(this.imageData,0,0);this.context.drawImage(this.offscreenCanvas,0,0,this.offscreenCanvas.width,this.offscreenCanvas.height,0,0,this.canvas.width,this.canvas.height)},update:function(){if(c64_ready){var e=getTimestamp();var t=e-this.lastUpdate;this.lastUpdate=e;if(debugger_update(t)){this.redraw();if(this.showRaster){this.drawRasterPosition()}this.updateDriveLight()}}if(this.debuggerContent=="memory"){this.c64Memory.update()}if(this.debuggerContent=="disassembly"){this.disassembly.update()}if(this.debuggerContent=="charset"){this.c64Charset.update()}if(this.debuggerContent=="sprites"){this.c64Sprites.update()}this.c64Registers.update();this.breakpoints.update()}};var C64Joystick=function(){this.settingsDialog=null;this.portEnabled=[false,false];this.mousePortEnabled=[false,false];this.joystickKeys=[[false,false,false,false,false,false,false,false,false,false],[false,"arrowup",false,"arrowleft","arrowright",false,"arrowdown",false,"z","x"]];this.joystickButtons=[1,1];this.joystickButtonActions=[["fire","up"],["fire","up"]],this.buttonMapping=[C64_JOYSTICK_FIRE,C64_JOYSTICK_FIRE,C64_JOYSTICK_FIRE,C64_JOYSTICK_FIRE,C64_JOYSTICK_FIRE,C64_JOYSTICK_FIRE,C64_JOYSTICK_FIRE,C64_JOYSTICK_FIRE,false,false,false,false,C64_JOYSTICK_UP,C64_JOYSTICK_DOWN,C64_JOYSTICK_LEFT,C64_JOYSTICK_RIGHT];this.dialogJoystickKeys=[];this.dialogPortEnabled=[];this.dialogJoystickButtons=[];this.dialogJoystickButtonActions=[["fire","up"],["fire","up"]];this.dialogGamepadPortEnabled=[];this.defaultGamepadPort=1;this.gamepads={}};C64Joystick.prototype={hasMouse:function(){return this.mousePortEnabled[0]||this.mousePortEnabled[1]},init:function(){var r=this;if(typeof UI!="undefined"){UI.on("ready",function(){r.loadPrefs()})}else{}var r=this;window.addEventListener("gamepadconnected",function(e){var t=[];for(var i=0;i<16;i++){t[i]=false}r.gamepads[e.gamepad.id]={port:false,index:e.gamepad.index,up:false,down:false,left:false,right:false,buttons:t}});window.addEventListener("gamepaddisconnected",function(e){delete r.gamepads[e.gamepad.id]})},loadPrefs:function(){for(var e=0;e<2;e++){var t=g_app.getPref("c64joystickportenabled-"+e);if(typeof t!="undefined"&&t!==null){if(t==="false"||t=="undefined"){t=false}if(t==="true"){t=true}this.setPortEnabled(e+1,t)}else if(e==1){this.setPortEnabled(2,true)}var i=g_app.getPref("c64joystickbuttons-"+e);if(typeof i=="undefined"||i==null){i=1}this.setJoystickButtons(e,i);var r=g_app.getPref("c64joystickbuttonaction-"+e+"_1");if(typeof r=="undefined"||r==null){r="up"}this.setJoystickButtonAction(e,1,r);for(var a=0;a<this.joystickKeys[e].length;a++){var s=g_app.getPref("c64joystickkey-"+e+"-"+a);if(typeof s!="undefined"&&s!==null){if(s==="false"){s=false}this.joystickKeys[e][a]=s}}var t=g_app.getPref("c64mouseportenabled-"+e);if(typeof t!="undefined"&&t!==null){if(t==="false"||t=="undefined"){t=false}if(t==="true"){t=true}this.setMousePortEnabled(e+1,t)}}},savePrefs:function(){for(var e=0;e<2;e++){g_app.setPref("c64joystickportenabled-"+e,this.portEnabled[e]);g_app.setPref("c64mouseportenabled-"+e,this.mousePortEnabled[e]);var t=g_app.getPref("c64joystickbuttons-"+e);if(typeof t=="undefined"||t==null){t=1}g_app.setPref("c64joystickbuttons"+e,this.joystickButtons[e]);g_app.setPref("c64joystickbuttonaction-"+e+"_1",this.joystickButtonActions[e][1]);for(var i=0;i<this.joystickKeys[e].length;i++){g_app.setPref("c64joystickkey-"+e+"-"+i,this.joystickKeys[e][i])}}},hasGamepad:function(){for(var e in this.gamepads){return true}return false},setMousePortEnabled:function(e,t){if(e==1){this.mousePortEnabled[0]=t;c64_setMousePortEnabled(0,t?1:0);if(typeof UI!="undefined"){if(UI.exists("c64-mouse1")){UI("c64-mouse1").setChecked(t);UI("c64debugger-mouse1").setChecked(t)}g_app.setPref("c64mouseportenabled-0",this.mousePortEnabled[0])}}if(e==2){this.mousePortEnabled[1]=t;c64_setMousePortEnabled(1,t?1:0);if(typeof UI!="undefined"){if(UI.exists("c64-mouse2")){UI("c64-mouse2").setChecked(t);UI("c64debugger-mouse2").setChecked(t)}g_app.setPref("c64mouseportenabled-1",this.mousePortEnabled[1])}}},getMousePortEnabled:function(e){return this.mousePortEnabled[e]},setPortEnabled:function(e,t){if(e==1){this.portEnabled[0]=t;if(typeof UI!="undefined"){if(UI.exists("c64-joystick1")){UI("c64-joystick1").setChecked(t);UI("c64debugger-joystick1").setChecked(t)}g_app.setPref("c64joystickportenabled-0",this.portEnabled[0])}}if(e==2){this.portEnabled[1]=t;if(typeof UI!="undefined"){if(UI.exists("c64-joystick2")){UI("c64-joystick2").setChecked(t);UI("c64debugger-joystick2").setChecked(t)}g_app.setPref("c64joystickportenabled-1",this.portEnabled[1])}}if(typeof g_app!="undefined"&&g_app.c64Debugger){g_app.c64Debugger.updateJoystickInfo()}},swap:function(){var e=this.portEnabled[0];this.setPortEnabled(1,this.portEnabled[1]);this.setPortEnabled(2,e);for(var t=0;t<this.joystickKeys[0].length;t++){var i=this.joystickKeys[0][t];this.joystickKeys[0][t]=this.joystickKeys[1][t];this.joystickKeys[1][t]=i}this.savePrefs()},buildSettingsDialog:function(){var t=this;var e=630;var i=500;this.settingsDialog=UI.create("UI.Dialog",{id:"c64JoystickSettings",title:"Joystick Settings",width:e,height:i});var r="";r="<div>";r+='<div style="margin-bottom: 10px">';r+="<h3>Joystick Settings</h3>";r+="<div>To set a key, click on a direction and then type the key, or delete to clear.</div>";r+="<div>If a gamepad is connected, it will be used for an enabled port.</div>";r+="</div>";r+='<div style="position: relative">';for(var a=0;a<2;a++){var s=a+1;var o=0+280*a;r+='<div style="display: inline-block; position: absolute; left: '+o+"px; ";if(a==1){r+="border-left: 1px solid #333333; padding-left: 30px"}r+='">';r+='<h3 style="border: 0">Port '+s+"</h3>";r+='<div class="formGroup">';r+='  <label class="cb-container">Enabled';r+='  <input type="checkbox" id="c64JoystickSettingsPortEnabled_'+a+'" name="c64JoystickSettingsPortEnabled" value="'+a+'">';r+='    <span class="checkmark"></span>';r+="  </label>";r+="</div>";r+='<div class="formGroup">';r+='  <label class="rb-container" style="margin-right: 8px; margin-bottom: 0">1 Button';r+='  <input type="radio" checked="checked" id="c64JoystickSettingsButtons_'+a+'_1" name="c64JoystickSettingsButtons_'+a+'" value="1">';r+='    <span class="checkmark"></span>';r+="  </label>";r+='  <label class="rb-container" style="margin-bottom: 0px">2 Button';r+='  <input type="radio" id="c64JoystickSettingsButtons_'+a+'_2" name="c64JoystickSettingsButtons_'+a+'" value="2">';r+='    <span class="checkmark"></span>';r+="  </label>";r+="</div>";r+='<div class="formGroup">';r+="  <label>Button 2 Action:</label>";r+='  <label class="rb-container" style="margin-right: 8px">Up';r+='  <input type="radio" checked="checked" id="c64JoystickSettingsButton2Action_'+a+'_Up" name="c64JoystickSettingsButton2Action_'+a+'" value="up">';r+='    <span class="checkmark"></span>';r+="  </label>";r+='  <label class="rb-container">Space Bar';r+='  <input type="radio" id="c64JoystickSettingsButton2Action_'+a+'_Space" name="c64JoystickSettingsButton2Action_'+a+'" value="space">';r+='    <span class="checkmark"></span>';r+="  </label>";r+="</div>";r+='<div class="formGroup">';r+="<div>Keys</div>";var l=0;r+="<table>";for(var n=0;n<3;n++){r+="<tr>";for(var h=0;h<3;h++){r+='<td style="padding: 4px">';if(n!=1||h!=1){r+='<div tabindex="'+l+'" data-keyindex="'+l+'" data-port="'+a+'" id="c64JoystickSettings'+a+"_"+l+'" class="c64JoystickSettingsKey" ';r+=' style="text-align: center; width: 68px; height: 28px; background-color: #eeeeee; border: 2px solid transparent; color: #444444">ArrowUp</div>';l++}r+="</td>"}r+="</tr>"}r+="<tr>";r+='<td colspan="3" style="padding: 3px;">';r+='<div style="display: inline-block; margin-right: 10px">Button 1</div>';r+='<div tabindex="'+l+'" data-keyindex="'+l+'" data-port="'+a+'" id="c64JoystickSettings'+a+"_"+l+'" class="c64JoystickSettingsKey" ';r+=' style="text-align: center; display: inline-block; width: 68px; height: 28px; background-color: #eeeeee; border: 2px solid transparent; color: #444444">';r+="ArrowUp";r+="</div>";l++;r+="</td>";r+="</tr>";r+="<tr>";r+='<td colspan="3" style="padding: 3px;">';r+='<div style="display: inline-block; margin-right: 10px">Button 2</div>';r+='<div tabindex="'+l+'" data-keyindex="'+l+'" data-port="'+a+'" id="c64JoystickSettings'+a+"_"+l+'" class="c64JoystickSettingsKey" ';r+=' style="text-align: center; display: inline-block; width: 68px; height: 28px; background-color: #eeeeee; border: 2px solid transparent; color: #444444">';r+="ArrowUp";r+="</div>";l++;r+="</td>";r+="</tr>";r+="</table>";r+="</div>";r+="</div>"}r+="</div>";r+="</div>";var d=UI.create("UI.HTMLPanel",{html:r});this.settingsDialog.add(d);this.okButton=UI.create("UI.Button",{text:"OK",color:"primary"});this.okButton.on("click",function(e){t.saveDialogButtons();UI.closeDialog()});this.closeButton=UI.create("UI.Button",{text:"Cancel",color:"secondary"});this.closeButton.on("click",function(e){UI.closeDialog()});this.settingsDialog.addButton(this.okButton);this.settingsDialog.addButton(this.closeButton);this.initEvents();this.updateContent()},initEvents:function(){var r=this;$(".c64JoystickSettingsKey").on("keydown",function(e){var t=parseInt($(this).attr("data-port"),10);var i=parseInt($(this).attr("data-keyindex"),10);if(e.key.toLowerCase()=="delete"||e.key.toLowerCase()=="backspace"){r.dialogJoystickKeys[t][i]=false}else{r.dialogJoystickKeys[t][i]=e.key.toLowerCase()}r.updateContent();e.preventDefault()});$(".c64JoystickSettingsKey").on("click",function(){$(this).focus()});$(".c64JoystickSettingsKey").on("focus",function(){$(".c64JoystickSettingsKey").css("border","2px solid transparent");$(".c64JoystickSettingsKey").css("color","#444444");$(this).css("border","2px solid #99aaff");$(".c64JoystickSettingsKey").css("color","#222222")});$(".c64JoystickSettingsKey").on("blur",function(){$(".c64JoystickSettingsKey").css("border","2px solid transparent");$(".c64JoystickSettingsKey").css("color","#444444")});$("input[name=c64JoystickSettingsPortEnabled]").on("click",function(){var e=parseInt($(this).val());r.dialogPortEnabled[e]=$(this).is(":checked")});$("input[name=c64JoystickSettingsGamepadPortEnabled]").on("click",function(){var e=parseInt($(this).val());r.dialogGamepadPortEnabled[e]=$(this).is(":checked")});$("input[name=c64JoystickSettingsButtons_0").on("click",function(){var e=parseInt($("input[name=c64JoystickSettingsButtons_0]:checked").val(),10);r.dialogJoystickButtons[0]=e});$("input[name=c64JoystickSettingsButtons_1").on("click",function(){var e=parseInt($("input[name=c64JoystickSettingsButtons_1]:checked").val(),10);r.dialogJoystickButtons[1]=e});$("input[name=c64JoystickSettingsButton2Action_0").on("click",function(){var e=$("input[name=c64JoystickSettingsButton2Action_0]:checked").val();r.dialogJoystickButtonActions[0][1]=e});$("input[name=c64JoystickSettingsButton2Action_1").on("click",function(){var e=$("input[name=c64JoystickSettingsButton2Action_1]:checked").val();r.dialogJoystickButtonActions[1][1]=e})},updateContent:function(){for(var e=0;e<2;e++){$("#c64JoystickSettingsPortEnabled_"+e).prop("checked",this.dialogPortEnabled[e]);if(this.dialogJoystickButtons[e]==2){$("#c64JoystickSettingsButtons_"+e+"_2").prop("checked",true)}else{$("#c64JoystickSettingsButtons_"+e+"_1").prop("checked",true)}if(this.dialogJoystickButtonActions[e][1]=="space"){$("#c64JoystickSettingsButton2Action_"+e+"_Space").prop("checked",true)}else{$("#c64JoystickSettingsButton2Action_"+e+"_Up").prop("checked",true)}for(var t=0;t<this.dialogJoystickKeys[e].length;t++){var i=this.dialogJoystickKeys[e][t];if(i===false){i=""}if(i===" "){i="space"}$("#c64JoystickSettings"+e+"_"+t).html(i)}}},showSettingsDialog:function(){this.dialogJoystickKeys=[];for(var e=0;e<2;e++){var t=[];for(var i=0;i<this.joystickKeys[e].length;i++){t.push(this.joystickKeys[e][i])}this.dialogJoystickKeys.push(t)}for(var e=0;e<2;e++){this.dialogPortEnabled[e]=this.portEnabled[e];this.dialogJoystickButtons[e]=this.joystickButtons[e];this.dialogJoystickButtonActions[e][1]=this.joystickButtonActions[e][1]}if(this.settingsDialog==null){this.buildSettingsDialog()}UI.showDialog("c64JoystickSettings");this.updateContent()},saveDialogButtons:function(){for(var e=0;e<2;e++){for(var t=0;t<this.joystickKeys[e].length;t++){this.joystickKeys[e][t]=this.dialogJoystickKeys[e][t];var i="c64joystickkey-"+e+"-"+t;console.log("set pref: "+i+" to "+this.joystickKeys[e][t]);g_app.setPref(i,this.joystickKeys[e][t])}}for(var e=0;e<2;e++){this.setPortEnabled(e+1,this.dialogPortEnabled[e]);g_app.setPref("c64joystickportenabled-"+e,this.dialogPortEnabled[e]);this.setJoystickButtons(e,this.dialogJoystickButtons[e]);g_app.setPref("c64joystickbuttons-"+e,this.dialogJoystickButtons[e]);this.setJoystickButtonAction(e,1,this.dialogJoystickButtonActions[e][1]);g_app.setPref("c64joystickbuttonaction-"+e+"_1",this.dialogJoystickButtonActions[e][1])}if(typeof g_app!="undefined"&&g_app.c64Debugger){g_app.c64Debugger.updateJoystickInfo()}},setJoystickButtons:function(e,t){this.joystickButtons[e]=t},getJoystickButtons:function(e){return this.joystickButtons[e]},setJoystickButtonAction:function(e,t,i){if(typeof i=="undefined"||i=="undefined"){this.joystickButtonActions[e][t]="up"}else{this.joystickButtonActions[e][t]=i}},getJoystickButtonAction:function(e,t){return this.joystickButtonActions[e][t]},gamepadIsActive:function(){if(typeof g_app!="undefined"&&g_app.c64Debugger){g_app.c64Debugger.hideOnscreenJoystick()}if(typeof overlayOnscreenJoystick!="undefined"&&overlayOnscreenJoystick!=null){overlayOnscreenJoystick.setHidden(true)}},checkGamepads:function(){var e=navigator.getGamepads();if(e.length==0){return}if(e[0]==null||typeof e[0].axes=="undefined"){return}for(var t in this.gamepads){var i=e[this.gamepads[t].index];var r=this.gamepads[t].port;for(var a=0;a<this.portEnabled.length;a++){if(this.portEnabled[a]){this.gamepads[t].port=a;r=a;if(i.axes[0]<=-.5){if(!this.gamepads[t].left){c64_joystickPush(r,C64_JOYSTICK_LEFT);this.gamepadIsActive();this.gamepads[t].left=true}}else{if(this.gamepads[t].left){c64_joystickRelease(r,C64_JOYSTICK_LEFT);this.gamepads[t].left=false}}if(i.axes[0]>=.5){if(!this.gamepads[t].right){c64_joystickPush(r,C64_JOYSTICK_RIGHT);this.gamepadIsActive();this.gamepads[t].right=true}}else{if(this.gamepads[t].right){c64_joystickRelease(r,C64_JOYSTICK_RIGHT);this.gamepads[t].right=false}}if(i.axes[1]<=-.5){if(!this.gamepads[t].up){c64_joystickPush(r,C64_JOYSTICK_UP);this.gamepadIsActive();this.gamepads[t].up=true}}else{if(this.gamepads[t].up){c64_joystickRelease(r,C64_JOYSTICK_UP);this.gamepads[t].up=false}}if(i.axes[1]>=.5){if(!this.gamepads[t].down){c64_joystickPush(r,C64_JOYSTICK_DOWN);this.gamepadIsActive();this.gamepads[t].down=true}}else{if(this.gamepads[t].down){c64_joystickRelease(r,C64_JOYSTICK_DOWN);this.gamepads[t].down=false}}if(typeof i.buttons!="undefined"){for(var s=0;s<this.buttonMapping.length;s++){if(i.buttons.length>s&&this.buttonMapping[s]!==false){var o=this.buttonMapping[s];if(this.joystickButtons[r]==2&&o==C64_JOYSTICK_FIRE){if(s==1||s==3){if(this.getJoystickButtonAction(r,1)=="up"){o=C64_JOYSTICK_UP}if(this.getJoystickButtonAction(r,1)=="space"){o="space"}}}if(i.buttons[s].pressed){if(!this.gamepads[t].buttons[s]){if(o=="space"){c64_keyPressed(C64_KEY_SPACE)}else{c64_joystickPush(r,o);this.gamepadIsActive()}this.gamepads[t].buttons[s]=true}}else{if(this.gamepads[t].buttons[s]){if(o=="space"){c64_keyReleased(C64_KEY_SPACE)}else{c64_joystickRelease(r,o)}this.gamepads[t].buttons[s]=false}}}}}}}}},keyDown:function(e){var t=1;e.preventDefault();var i=e.key.toLowerCase();for(var r=0;r<=1;r++){if(this.portEnabled[r]){switch(i){case this.joystickKeys[r][0]:return true;break;case this.joystickKeys[r][1]:c64_joystickPush(r,C64_JOYSTICK_UP);return true;break;case this.joystickKeys[r][2]:return true;break;case this.joystickKeys[r][3]:c64_joystickPush(r,C64_JOYSTICK_LEFT);return true;break;case this.joystickKeys[r][4]:c64_joystickPush(r,C64_JOYSTICK_RIGHT);return true;break;case this.joystickKeys[r][5]:return true;break;case this.joystickKeys[r][6]:c64_joystickPush(r,C64_JOYSTICK_DOWN);return true;break;case this.joystickKeys[r][7]:return true;break;case this.joystickKeys[r][8]:c64_joystickPush(r,C64_JOYSTICK_FIRE);return true;break;case this.joystickKeys[r][9]:if(this.joystickButtons[r]>1){if(this.joystickButtonActions[r][1]=="space"){c64_keyPressed(C64_KEY_SPACE)}else{c64_joystickPush(r,C64_JOYSTICK_UP)}return true}break}}}return false},keyUp:function(e){var t=1;e.preventDefault();var i=e.key.toLowerCase();for(var r=0;r<=1;r++){if(this.portEnabled[r]){switch(i){case this.joystickKeys[r][0]:return true;break;case this.joystickKeys[r][1]:c64_joystickRelease(r,C64_JOYSTICK_UP);return true;break;case this.joystickKeys[r][2]:return true;break;case this.joystickKeys[r][3]:c64_joystickRelease(r,C64_JOYSTICK_LEFT);return true;break;case this.joystickKeys[r][4]:c64_joystickRelease(r,C64_JOYSTICK_RIGHT);return true;break;case this.joystickKeys[r][5]:return true;break;case this.joystickKeys[r][6]:c64_joystickRelease(r,C64_JOYSTICK_DOWN);return true;break;case this.joystickKeys[r][7]:return true;break;case this.joystickKeys[r][8]:c64_joystickRelease(r,C64_JOYSTICK_FIRE);return true;break;case this.joystickKeys[r][9]:if(this.joystickButtons[r]>1){if(this.joystickButtonActions[r][1]=="space"){c64_keyReleased(C64_KEY_SPACE)}else{c64_joystickRelease(r,C64_JOYSTICK_UP)}return true}break}}}return false}};var C64Scripting=function(){this.scriptProcessor=null};C64Scripting.prototype={init:function(){var i=this;this.scriptProcessor=new Scripting;this.scriptProcessor.init({outputElementId:this.outputElementId});this.scriptProcessor.registerAPI(function(e,t){i.initAPI(e,t)});this.scriptProcessor.setPrescript("c64",this.apiPreScript())},getCompletions:function(e,t){var i=[];i.push({value:"c64.setColor",meta:"Set C64 Colour"});return i},apiPreScript:function(){var e="";var t=";";e+="c64.eventHandlers = {};"+t;e+="c64.on = function(eventType, callback) {"+t;e+=' Editor.on("c64." + eventType, callback);'+t;e+="}"+t;e+="c64.rasterY = function(rasterY, callback) { "+t;e+='  console.log("rastery:" + rasterY);';e+="}"+t;return e},initAPI:function(e,t){var i=this;var r=function(e){return c64_cpuRead(e)};var a=function(e,t){c64_cpuWrite(e,t)};var s=function(e,t,i,r){e=e&15;var a=t&255;a+=(i&255)<<8;a+=(r&255)<<16;a=(a>>>0)+4278190080;c64_setColor(e,a)};var o=e.createObjectProto(e.OBJECT_PROTO);e.setProperty(t,"c64",o);e.setProperty(o,"cpuWrite",e.createNativeFunction(c64_cpuWrite,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"cpuRead",e.createNativeFunction(c64_cpuRead,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"getPC",e.createNativeFunction(c64_getPC,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"setPC",e.createNativeFunction(c64_setPC,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"setColor",e.createNativeFunction(s,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"getA",e.createNativeFunction(c64_getRegA,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"setA",e.createNativeFunction(c64_setRegA,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"getX",e.createNativeFunction(c64_getRegX,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"setX",e.createNativeFunction(c64_setRegX,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"getY",e.createNativeFunction(c64_getRegY,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"setY",e.createNativeFunction(c64_setRegY,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(o,"getRasterY",e.createNativeFunction(c64_getRasterY,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64Write",e.createNativeFunction(c64_cpuWrite,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64Read",e.createNativeFunction(c64_cpuRead,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64GetPC",e.createNativeFunction(c64_getPC,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64SetPC",e.createNativeFunction(c64_setPC,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64GetRegA",e.createNativeFunction(c64_getRegA,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64SetRegA",e.createNativeFunction(c64_setRegA,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64GetRegX",e.createNativeFunction(c64_getRegX,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64SetRegX",e.createNativeFunction(c64_setRegX,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64GetRegY",e.createNativeFunction(c64_getRegY,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64SetRegY",e.createNativeFunction(c64_setRegY,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64SetColor",e.createNativeFunction(s,false),Interpreter.NONENUMERABLE_DESCRIPTOR);e.setProperty(t,"c64_reset",e.createNativeFunction(c64_reset,false),Interpreter.NONENUMERABLE_DESCRIPTOR)}};var C64Sound=function(){this.audioEnabled=true};C64Sound.prototype={init:function(){this.loadPrefs()},loadPrefs:function(){if(typeof UI!="undefined"){var e=this;UI.on("ready",function(){e.setModel(g_app.getPref("c64sidmodel"))})}},checkAudio:function(){if(this.audioEnabled){this.startAudio()}},setModel:function(e){switch(e){case"6581":sid_setModel(0);if(typeof UI!="undefined"){if(UI.exists("c64debugger-sound6581")&&UI.exists("c64debugger-sound8580")){UI("c64debugger-sound6581").setChecked(true);UI("c64debugger-sound8580").setChecked(false)}g_app.setPref("c64sidmodel",e)}break;case"8580":sid_setModel(1);if(typeof UI!="undefined"){if(UI.exists("c64debugger-sound6581")&&UI.exists("c64debugger-sound8580")){UI("c64debugger-sound6581").setChecked(false);UI("c64debugger-sound8580").setChecked(true)}g_app.setPref("c64sidmodel",e)}break}},toggleAudio:function(){if(this.audioEnabled){this.stopAudio()}else{this.startAudio()}UI("c64debugger-sound").setChecked(this.audioEnabled)},getAudioEnabled:function(){return this.audioEnabled},startAudio:function(){var e=window.AudioContext||window.webkitAudioContext||false;if(!e){return}var t=this;this.stopAudio();try{this.audioBufferLength=4096;this.audioCtx=new e;this.sampleRate=this.audioCtx.sampleRate;sid_setSampleRate(this.sampleRate);this.scriptNode=this.audioCtx.createScriptProcessor(this.audioBufferLength,0,1);this.scriptNode.onaudioprocess=function(e){t.audioProcess(e)};this.scriptNode.connect(this.audioCtx.destination);this.audioEnabled=true;if(typeof UI!="undefined"){UI("c64-sound").setChecked(this.audioEnabled)}}catch(e){console.log(e);this.audioEnabled=false}},stopAudio:function(){if(this.scriptNode){this.scriptNode.disconnect(this.audioCtx.destination);this.scriptNode.onaudioprocess=null;this.scriptNode=null}if(this.audioCtx){this.audioCtx.close().catch(function(e){});this.audioCtx=null}this.audioEnabled=false;if(typeof UI!="undefined"){UI("c64-sound").setChecked(this.audioEnabled)}},audioProcess:function(e){var t=e.outputBuffer;var i=t.getChannelData(0);if(debugger_isRunning()&&!document.hidden&&this.lastUpdate!=g_lastUpdate){this.lastUpdate=g_lastUpdate;var r=sid_getAudioBuffer();var a=new Float32Array(c64.HEAPF32.subarray(r>>2,(r>>2)+this.audioBufferLength));i.set(a)}else{for(var s=0;s<this.audioBufferLength;s++){i[s]=0}}}};var C64Colors=function(){this.colors=[4278190080,4294967295,4281873281,4291350133,4288101518,4283280470,4288359470,4285657581,4280897678,4278204501,4285623492,4283058762,4286282619,4288675753,4293619056,4289901234]};C64Colors.prototype={init:function(){},setColor:function(e,t){if(isNaN(e)||e<0||e>15){return}this.colors[e]=t;if(c64_ready){c64_setColor(e,t)}},getColor:function(e){if(e<0||e>15){return}return this.colors[e]},setAllColors:function(){if(c64_ready){for(var e=0;e<16;e++){c64_setColor(e,this.colors[e])}}},resetColor:function(e){var t=[4278190080,4294967295,4281873281,4291350133,4288101518,4283280470,4288359470,4285657581,4280897678,4278204501,4285623492,4283058762,4286282619,4288675753,4293619056,4289901234];this.setColor(e,t[e])},resetColors:function(){this.colors=[4278190080,4294967295,4281873281,4291350133,4288101518,4283280470,4288359470,4285657581,4280897678,4278204501,4285623492,4283058762,4286282619,4288675753,4293619056,4289901234];this.setAllColors()}};var D64Util={};D64Util.trackInfo=[{track:0,numSectors:0,sectorsIn:0,d64Offset:0},{track:1,numSectors:21,sectorsIn:0,d64Offset:0},{track:2,numSectors:21,sectorsIn:21,d64Offset:5376},{track:3,numSectors:21,sectorsIn:42,d64Offset:10752},{track:4,numSectors:21,sectorsIn:63,d64Offset:16128},{track:5,numSectors:21,sectorsIn:84,d64Offset:21504},{track:6,numSectors:21,sectorsIn:105,d64Offset:26880},{track:7,numSectors:21,sectorsIn:126,d64Offset:32256},{track:8,numSectors:21,sectorsIn:147,d64Offset:37632},{track:9,numSectors:21,sectorsIn:168,d64Offset:43008},{track:10,numSectors:21,sectorsIn:189,d64Offset:48384},{track:11,numSectors:21,sectorsIn:210,d64Offset:53760},{track:12,numSectors:21,sectorsIn:231,d64Offset:59136},{track:13,numSectors:21,sectorsIn:252,d64Offset:64512},{track:14,numSectors:21,sectorsIn:273,d64Offset:69888},{track:15,numSectors:21,sectorsIn:294,d64Offset:75264},{track:16,numSectors:21,sectorsIn:315,d64Offset:80640},{track:17,numSectors:21,sectorsIn:336,d64Offset:86016},{track:18,numSectors:19,sectorsIn:357,d64Offset:91392},{track:19,numSectors:19,sectorsIn:376,d64Offset:96256},{track:20,numSectors:19,sectorsIn:395,d64Offset:101120},{track:21,numSectors:19,sectorsIn:414,d64Offset:105984},{track:22,numSectors:19,sectorsIn:433,d64Offset:110848},{track:23,numSectors:19,sectorsIn:452,d64Offset:115712},{track:24,numSectors:19,sectorsIn:471,d64Offset:120576},{track:25,numSectors:18,sectorsIn:490,d64Offset:125440},{track:26,numSectors:18,sectorsIn:508,d64Offset:130048},{track:27,numSectors:18,sectorsIn:526,d64Offset:134656},{track:28,numSectors:18,sectorsIn:544,d64Offset:139264},{track:29,numSectors:18,sectorsIn:562,d64Offset:143872},{track:30,numSectors:18,sectorsIn:580,d64Offset:148480},{track:31,numSectors:17,sectorsIn:598,d64Offset:153088},{track:32,numSectors:17,sectorsIn:615,d64Offset:157440},{track:33,numSectors:17,sectorsIn:632,d64Offset:161792},{track:34,numSectors:17,sectorsIn:649,d64Offset:166144},{track:35,numSectors:17,sectorsIn:666,d64Offset:170496},{track:36,numSectors:17,sectorsIn:683,d64Offset:174848},{track:37,numSectors:17,sectorsIn:700,d64Offset:179200},{track:38,numSectors:17,sectorsIn:717,d64Offset:183552},{track:39,numSectors:17,sectorsIn:734,d64Offset:187904},{track:40,numSectors:17,sectorsIn:751,d64Offset:192256}];D64Util.getOffset=function(e,t){return D64Util.trackInfo[e].d64Offset+t*256};D64Util.d64ReadFile=function(e,t,i){var r=[];while(1){var a=D64Util.getOffset(t,i);var s=e[a+0];var o=e[a+1];var l=254;if(s==0){l=o-1}for(var n=0;n<l;n++){r.push(e[a+n+2])}if(s==0){break}t=s;i=o}return new Uint8Array(r)};D64Util.getFirstPRG=function(e){var t=D64Util.readDirectory(e);var i=false;for(var r=0;r<t.length;r++){if(t[r].type=="prg"){i=r;break}}if(i===false){return null}var a=D64Util.d64ReadFile(e,t[i].track,t[i].sector);return a};D64Util.readDirectory=function(e){var t=[];var i=18;var r=1;while(i!=0){var a=D64Util.getOffset(i,r);var s=a;for(var o=0;o<8;o++,s+=32){var l=e[s+2];console.log("file type = "+l);if(l==0){continue}switch(l&7){case 0:l="del";break;case 1:l="seq";break;case 2:l="prg";break;case 3:l="usr";break;case 4:l="rel";break;default:l="unk";break}var n=e.slice(s+5,s+21);var h=e[s+3];var d=e[s+4];var c=e[s+31]*256+e[s+30];var f="";for(var o=0;o<n.length;o++){f+=String.fromCharCode(n[o])}t.push({type:l,name:f,d64FileOffset:s+5,track:h,sector:d,sectors:c})}i=e[a+0];r=e[a+1];console.log("de track = "+i+":"+r);if(i==0){break}}console.log(t);return t};C64_JOYSTICK_UP=1;C64_JOYSTICK_DOWN=2;C64_JOYSTICK_LEFT=4;C64_JOYSTICK_RIGHT=8;C64_JOYSTICK_FIRE=16;function elementOffset(e){var t=e.getBoundingClientRect(),i=window.pageXOffset||document.documentElement.scrollLeft,r=window.pageYOffset||document.documentElement.scrollTop;return{top:t.top+r,left:t.left+i}}var C64OnscreenJoystick=function(){this.debugger=null;this.button1X=0;this.button1Y=0;this.button1Radius=0;this.button2X=0;this.button2Y=0;this.button2Radius=0;this.joystickX=0;this.joystickY=0;this.joystickRadius1=0;this.joystickRadius2=0;this.maxRadius=100;this.button1Down=false;this.button2Down=false;this.joystickDirectionDown=false;this.port=2;this.twoButton=false;this.button2Function="up";this.canvas=null;this.id="c64-onscreen-joystick";this.showPortSelection=false;this.hidden=false};C64OnscreenJoystick.prototype={init:function(e){this.debugger=e.debugger;this.debugger.setOnscreenJoystickPort(2);this.port=2;if(typeof e.id!="undefined"){this.id=e.id}if(typeof e.showPortSelection!="undefined"){this.showPortSelection=e.showPortSelection}},setHidden:function(e){this.hidden=e;this.draw()},getHTML:function(e){var t=1;if(typeof e!="undefined"){if(typeof e.opacity!="undefined"){t=e.opacity}}var i="";i+='<div id="'+this.id+'" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0">';if(this.showPortSelection){i+="  <div>";i+='    <label class="rb-container" style="margin-right: 4px">Port 1';i+='      <input type="radio" id="mobileC64JoystickPort1" name="mobileC64JoystickPort" value="1">';i+='      <span class="checkmark"></span>';i+="    </label>";i+='    <label class="rb-container" style="margin-right: 4px">Port 2';i+='      <input type="radio" id="mobileC64JoystickPort2" name="mobileC64JoystickPort" checked="checked"  value="2">';i+='      <span class="checkmark"></span>';i+="    </label>";i+="  </div>"}i+='  <canvas id="'+this.id+'-canvas"';if(t!=1){i+=' style="';i+=" opacity: "+t+";";i+=" position: absolute; left: 2px; bottom: 40px; ";i+='"'}i+="></canvas>";i+="</div>";return i},buildInterface:function(e){var t=this.getHTML();this.uiComponent=UI.create("UI.HTMLPanel",{id:"c64OnscreenJoystick",html:t});e.add(this.uiComponent);var i=this;UI.on("ready",function(){i.initEvents()})},initEvents:function(){var i=this;var i=this;this.canvas=document.getElementById(this.id+"-canvas");this.canvas.addEventListener("contextmenu",function(e){e.preventDefault()},false);this.canvas.addEventListener("touchstart",function(e){e.preventDefault();i.touchStart(e)},false);this.canvas.addEventListener("touchmove",function(e){e.preventDefault();i.touchMove(e);return false},false);this.canvas.addEventListener("touchend",function(e){e.preventDefault();i.touchEnd(e)},false);if(this.showPortSelection){if(typeof $!="undefined"){$("input[name=mobileC64JoystickPort]").on("click",function(e){var t=$("input[name=mobileC64JoystickPort]:checked").val();t=parseInt(t,10);if(!isNaN(t)){i.port=t}i.debugger.setJoystickPort(t)})}}},setPort:function(e){this.port=e},setType:function(e){switch(e){case 1:this.twoButton=false;break;case 2:this.twoButton=true;break}this.draw()},setSecondButton:function(e){this.button2Function=e},processButtonTouches:function(e){var t=false;var i=false;for(var r=0;r<e.length;r++){var a=e[r];var s=a.pageX-elementOffset(this.canvas).left;var o=a.pageY-elementOffset(this.canvas).top;var l=(this.button1X-s)*(this.button1X-s)+(this.button1Y-o)*(this.button1Y-o);if(l<this.button1Radius*this.button1Radius){t=true}var l=(this.button2X-s)*(this.button2X-s)+(this.button2Y-o)*(this.button2Y-o);if(l<this.button2Radius*this.button2Radius){i=true}}if(t!=this.button1Down){this.button1Down=t;if(this.button1Down){this.joystickPush("fire")}else{this.joystickRelease("fire")}}if(i!=this.button2Down){this.button2Down=i;switch(this.button2Function){case"space":if(this.button2Down){c64_keyPressed(C64_KEY_SPACE)}else{c64_keyReleased(C64_KEY_SPACE)}break;case"up":if(this.button2Down){this.joystickPush("up")}else{this.joystickRelease("up")}break}}},processJoystickTouches:function(e){var t=this.joystickDirectionDown;this.joystickDirectionDown=false;for(var i=0;i<e.length;i++){var r=e[i];var a=r.pageX-elementOffset(this.canvas).left;var s=r.pageY-elementOffset(this.canvas).top;var o=(this.joystickX-a)*(this.joystickX-a)+(this.joystickY-s)*(this.joystickY-s);o=Math.sqrt(o);if(o>this.joystickRadius1&&o<this.joystickRadius2){var l=Math.atan((s-this.joystickY)/(a-this.joystickX));if(a>=this.joystickX){l+=Math.PI/2}else{l+=Math.PI+Math.PI/2}for(var n=0;n<8;n++){var h=-(2*Math.PI/16)+n*(2*Math.PI/8);var d=h+2*Math.PI/8;if(h<0){h+=Math.PI*2;if(l>h||l<d){this.joystickDirectionDown=n;break}}else{if(l>h&&l<d){this.joystickDirectionDown=n;break}}}}}if(this.joystickDirectionDown!==t){switch(t){case 0:this.joystickRelease("up");break;case 1:this.joystickRelease("up");this.joystickRelease("right");break;case 2:this.joystickRelease("right");break;case 3:this.joystickRelease("right");this.joystickRelease("down");break;case 4:this.joystickRelease("down");break;case 5:this.joystickRelease("down");this.joystickRelease("left");break;case 6:this.joystickRelease("left");break;case 7:this.joystickRelease("left");this.joystickRelease("up");break}switch(this.joystickDirectionDown){case 0:this.joystickPush("up");break;case 1:this.joystickPush("up");this.joystickPush("right");break;case 2:this.joystickPush("right");break;case 3:this.joystickPush("down");this.joystickPush("right");break;case 4:this.joystickPush("down");break;case 5:this.joystickPush("down");this.joystickPush("left");break;case 6:this.joystickPush("left");break;case 7:this.joystickPush("up");this.joystickPush("left");break}}},touchStart:function(e){this.hidden=false;this.processButtonTouches(e.touches);this.processJoystickTouches(e.touches);this.draw()},touchMove:function(e){this.processButtonTouches(e.touches);this.processJoystickTouches(e.touches);this.draw()},touchEnd:function(e){this.processButtonTouches(e.touches);this.processJoystickTouches(e.touches);this.draw()},joystickPush:function(e){switch(e){case"up":c64_joystickPush(this.port-1,C64_JOYSTICK_UP);break;case"down":c64_joystickPush(this.port-1,C64_JOYSTICK_DOWN);break;case"left":c64_joystickPush(this.port-1,C64_JOYSTICK_LEFT);break;case"right":c64_joystickPush(this.port-1,C64_JOYSTICK_RIGHT);break;case"fire":c64_joystickPush(this.port-1,C64_JOYSTICK_FIRE);break}},joystickRelease:function(e){switch(e){case"up":c64_joystickRelease(this.port-1,C64_JOYSTICK_UP);break;case"down":c64_joystickRelease(this.port-1,C64_JOYSTICK_DOWN);break;case"left":c64_joystickRelease(this.port-1,C64_JOYSTICK_LEFT);break;case"right":c64_joystickRelease(this.port-1,C64_JOYSTICK_RIGHT);break;case"fire":c64_joystickRelease(this.port-1,C64_JOYSTICK_FIRE);break}},layout:function(){var e=document.getElementById(this.id);if(!e){return}if(this.canvas==null){return}var t=e.clientWidth-4;this.canvas.width=t;this.joystickRadius1=44;this.joystickRadius2=80;if(this.joystickRadius2>this.maxRadius){this.joystickRadius2=this.maxRadius;if(this.joystickRadius2-this.joystickRadius1<30){this.joystickRadius1=this.joystickRadius2-30}}var i=0;if(this.showPortSelection){i=30}this.joystickX=this.joystickRadius2+20;this.canvas.height=2*this.joystickRadius2+20;var r=this.canvas.height/2;this.joystickY=r;if(this.twoButton){var a=t-40;var s=30;this.button2X=a;this.button2Y=r-20;this.button2Radius=s;this.button1X=a-s*2.2;this.button1Y=r-20+1.8*s;this.button1Radius=s}else{this.button1X=t-70;this.button1Y=r;this.button1Radius=40}var o=Math.floor(5*(e.clientHeight-i-this.canvas.height)/8);if(o<0){o=0}this.canvas.style.marginTop="18px"},draw:function(){this.layout();if(this.canvas==null){return}this.context=this.canvas.getContext("2d");var e=document.getElementById(this.id);if(!e){console.log("no holder");return}var t=e.clientWidth-4;this.canvas.width=t;this.context=this.canvas.getContext("2d");this.context.clearRect(0,0,this.canvas.width,this.canvas.height);if(this.hidden){return}this.context.fillStyle="#ee1111";if(this.button1Down){this.context.fillStyle="#991111"}this.context.beginPath();this.context.arc(this.button1X,this.button1Y,this.button1Radius,0,2*Math.PI);this.context.fill();if(this.twoButton){this.context.fillStyle="#ee1111";if(this.button2Down){this.context.fillStyle="#991111"}this.context.beginPath();this.context.arc(this.button2X,this.button2Y,this.button2Radius,0,2*Math.PI);this.context.fill()}for(var i=0;i<8;i++){var r=0-Math.PI/2-2*Math.PI/16+i*(2*Math.PI/8);var a=r+2*Math.PI/8;this.context.fillStyle="#555555";if(i===this.joystickDirectionDown){this.context.fillStyle="#999999"}this.context.beginPath();this.context.arc(this.joystickX,this.joystickY,this.joystickRadius2,r,a,false);this.context.arc(this.joystickX,this.joystickY,this.joystickRadius1,a,r,true);this.context.closePath();this.context.fill()}}};var C64OnscreenKeyboard=function(){this.debugger=null;this.fontImage=null;this.fontCanvas=null;this.keyPositions=[];this.deletePosition={};this.keyIndexDown=false;this.keysDown=[];this.touchUsed=[];this.id="c64-onscreen-keyboard"};var C64_KEY_NONE=-1;C64OnscreenKeyboard.prototype={init:function(e){this.debugger=e.debugger;this.initKeyboard()},getHTML:function(){var e='<div style="text-align: center; position: absolute; top: 0; bottom: 0; left: 0; right: 0" id="'+this.id+'">';e+='<canvas id="c64OnscreenKeyboardCanvas" style="background-color: #440000"></canvas>';e+="</div>";return e},buildInterface:function(e){var t=this.getHTML();this.uiComponent=UI.create("UI.HTMLPanel",{id:"c64OnscreenKeyboard",html:t});e.add(this.uiComponent);this.initEvents();this.loadFont()},loadFont:function(){var e=this;this.fontImage=new Image;this.fontImage.onload=function(){e.createFontCanvas()};this.fontImage.src=c64keycharsImageData},createFontCanvas:function(){var e=this.fontImage.naturalWidth;var t=this.fontImage.naturalHeight;this.fontCanvas=document.createElement("canvas");this.fontCanvas.width=e;this.fontCanvas.height=t;this.fontContext=this.fontCanvas.getContext("2d");this.fontContext.drawImage(this.fontImage,0,0,e,t);this.draw()},initEvents:function(){this.canvas=document.getElementById("c64OnscreenKeyboardCanvas");if(typeof $!="undefined"){$("#c64OnscreenKeyboardCanvas").on("contextmenu",function(e){e.preventDefault()})}var t=this;this.canvas.addEventListener("contextmenu",function(e){e.preventDefault()},false);this.canvas.addEventListener("touchstart",function(e){e.preventDefault();t.touchStart(e)},false);this.canvas.addEventListener("touchmove",function(e){e.preventDefault();t.touchMove(e)},false);this.canvas.addEventListener("touchend",function(e){e.preventDefault();t.touchEnd(e)},false)},processStartTouches:function(e){var t=false;var i=[];for(var r=0;r<e.length;r++){var a=e[r];var s=a.pageX-elementOffset(this.canvas).left;var o=a.pageY-elementOffset(this.canvas).top;for(var r=0;r<this.keyPositions.length;r++){var l=this.keyPositions[r].x;var n=this.keyPositions[r].y;var h=this.keyPositions[r].width;var d=this.keyPositions[r].height;if(s>l&&s<l+h&&o>n&&o<n+d){var c=this.keyPositions[r].keyIndex;if(c===C64_KEY_SHIFT_LEFT||c===C64_KEY_SHIFT_RIGHT){t=false}i.push({keyIndex:c,identifier:a.identifier});break}}}var f=false;for(var u=0;u<this.keysDown.length;u++){if(this.keysDown[u]===C64_KEY_SHIFT_LEFT||this.keysDown[u]===C64_KEY_SHIFT_RIGHT){f=true;break}}var p=false;for(var u=0;u<this.keysDown.length;u++){if(this.keysDown[u]===C64_KEY_COMMODORE){p=true;break}}var v=false;for(var u=0;u<this.keysDown.length;u++){if(this.keysDown[u]===C64_KEY_CTRL){v=true;break}}for(var r=0;r<i.length;r++){var c=i[r].keyIndex;var g=false;var m=false;for(var u=0;u<this.keysDown.length;u++){if(this.keysDown[u]==i[r].keyIndex){g=true;m=u;break}}if(!g){this.keyDown(i[r].keyIndex);this.keysDown.push(i[r].keyIndex)}}this.releaseShiftLeft=false;this.releaseShiftRight=false;this.releaseCommodore=false;this.releaseCtrl=false;if(f){for(var u=0;u<this.keysDown.length;u++){if(this.keysDown[u]===C64_KEY_SHIFT_LEFT){this.releaseShiftLeft=true;this.keysDown.splice(u,1);u=0}if(this.keysDown[u]===C64_KEY_SHIFT_RIGHT){this.releaseShiftRight=true;this.keysDown.splice(u,1);u=0}}}if(p){for(var u=0;u<this.keysDown.length;u++){if(this.keysDown[u]===C64_KEY_COMMODORE){this.releaseCommodore=true;this.keysDown.splice(u,1);break}}}if(v){for(var u=0;u<this.keysDown.length;u++){if(this.keysDown[u]===C64_KEY_CTRL){this.releaseCtrl=true;this.keysDown.splice(u,1);break}}}},processTouches:function(e){var t=[];for(var i=0;i<e.length;i++){var r=e[i];var a=r.pageX-elementOffset(this.canvas).left;var s=r.pageY-elementOffset(this.canvas).top;for(var i=0;i<this.keyPositions.length;i++){var o=this.keyPositions[i].x;var l=this.keyPositions[i].y;var n=this.keyPositions[i].width;var h=this.keyPositions[i].height;if(a>o&&a<o+n&&s>l&&s<l+h){var d=this.keyPositions[i].keyIndex;if(d!==C64_KEY_SHIFT_LEFT&&d!==C64_KEY_SHIFT_RIGHT&&d!==C64_KEY_COMMODORE&&d!==C64_KEY_CTRL){t.push({keyIndex:d,identifier:r.identifier})}break}}}var c=[];for(var i=0;i<this.keysDown.length;i++){if(this.keysDown[i]!==C64_KEY_SHIFT_LEFT&&this.keysDown[i]!==C64_KEY_SHIFT_RIGHT&&this.keysDown[i]!==C64_KEY_COMMODORE&&this.keysDown[i]!==C64_KEY_CTRL){var f=false;for(var u=0;u<t.length;u++){if(this.keysDown[i]==t[u].keyIndex){f=true;break}}if(!f){this.keyUp(this.keysDown[i])}else{c.push(this.keysDown[i])}}else{c.push(this.keysDown[i])}}this.keysDown=c},keyDown:function(e){c64_keyPressed(e)},keyUp:function(e){c64_keyReleased(e)},touchStart:function(e){var t=e.touches;this.processStartTouches(e.changedTouches);this.draw()},touchMove:function(e){this.processTouches(e.touches);this.draw()},touchEnd:function(e){this.processTouches(e.touches);if(this.releaseCommodore){this.keyUp(C64_KEY_COMMODORE);this.releaseCommodore=false}if(this.releaseCtrl){this.keyUp(C64_KEY_CTRL);this.releaseCtrl=false}if(this.releaseShiftLeft){this.keyUp(C64_KEY_SHIFT_LEFT);this.releaseShiftLeft=false}if(this.releaseShiftRight){this.keyUp(C64_KEY_SHIFT_RIGHT);this.releaseShiftRight=false}this.draw()},initKeyboard:function(){this.petsciiKeyboardFull=[[{width:1,keyIndex:C64_KEY_ARROW_LEFT,charCode:31,shiftedCode:126,altCode:-1},{width:1,keyIndex:C64_KEY_ONE,charCode:49,shiftedCode:33,altCode:-1,colorCode:0},{width:1,keyIndex:C64_KEY_TWO,charCode:50,shiftedCode:34,altCode:-1,colorCode:1},{width:1,keyIndex:C64_KEY_THREE,charCode:51,shiftedCode:35,altCode:-1,colorCode:2},{width:1,keyIndex:C64_KEY_FOUR,charCode:52,shiftedCode:36,altCode:-1,colorCode:3},{width:1,keyIndex:C64_KEY_FIVE,charCode:53,shiftedCode:37,altCode:-1,colorCode:4},{width:1,keyIndex:C64_KEY_SIX,charCode:54,shiftedCode:38,altCode:-1,colorCode:5},{width:1,keyIndex:C64_KEY_SEVEN,charCode:55,shiftedCode:39,altCode:-1,colorCode:6},{width:1,keyIndex:C64_KEY_EIGHT,charCode:56,shiftedCode:40,altCode:-1,colorCode:7},{width:1,keyIndex:C64_KEY_NINE,charCode:57,shiftedCode:41,altCode:-1},{width:1,keyIndex:C64_KEY_ZERO,charCode:48,shiftedCode:42,altCode:-1},{width:1,keyIndex:C64_KEY_PLUS,charCode:43,shiftedCode:95,altCode:-1},{width:1,keyIndex:C64_KEY_MINUS,charCode:45,shiftedCode:43,altCode:-1},{width:1,keyIndex:C64_KEY_POUND,charCode:28,shiftedCode:43,altCode:-1},{width:1,keyIndex:C64_KEY_INS_DEL,charCode:-1,shiftedCode:-1}],[{width:1.5,keyIndex:9,charCode:-1,shiftedCode:-1,altCode:-1},{width:1,keyIndex:C64_KEY_Q,charCode:17,shiftedCode:81,altCode:195},{width:1,keyIndex:C64_KEY_W,charCode:23,shiftedCode:87,altCode:180},{width:1,keyIndex:C64_KEY_E,charCode:5,shiftedCode:69,altCode:193},{width:1,keyIndex:C64_KEY_R,charCode:18,shiftedCode:82,altCode:194},{width:1,keyIndex:C64_KEY_T,charCode:20,shiftedCode:84,altCode:204},{width:1,keyIndex:C64_KEY_Y,charCode:25,shiftedCode:89,altCode:185},{width:1,keyIndex:C64_KEY_U,charCode:21,shiftedCode:85,altCode:202},{width:1,keyIndex:C64_KEY_I,charCode:9,shiftedCode:73,altCode:203},{width:1,keyIndex:C64_KEY_O,charCode:15,shiftedCode:79,altCode:-1},{width:1,keyIndex:C64_KEY_P,charCode:16,shiftedCode:80,altCode:-1},{width:1,keyIndex:C64_KEY_AT,charCode:0,shiftedCode:123,altCode:-1},{width:1,keyIndex:C64_KEY_STAR,charCode:42,shiftedCode:125,altCode:-1},{width:1.5,keyIndex:C64_KEY_ARROW_UP,charCode:30,shiftedCode:124,altCode:-1}],[{width:1.75,keyIndex:C64_KEY_RUN_STOP,charCode:-1,shiftedCode:-1},{width:1,keyIndex:C64_KEY_A,charCode:1,shiftedCode:65,altCode:218},{width:1,keyIndex:C64_KEY_S,charCode:19,shiftedCode:83,altCode:191},{width:1,keyIndex:C64_KEY_D,charCode:4,shiftedCode:68,altCode:179},{width:1,keyIndex:C64_KEY_F,charCode:6,shiftedCode:70,altCode:196},{width:1,keyIndex:C64_KEY_G,charCode:7,shiftedCode:71,altCode:201},{width:1,keyIndex:C64_KEY_H,charCode:8,shiftedCode:72,altCode:187},{width:1,keyIndex:C64_KEY_J,charCode:10,shiftedCode:74,altCode:186},{width:1,keyIndex:C64_KEY_K,charCode:11,shiftedCode:75,altCode:205},{width:1,keyIndex:C64_KEY_L,charCode:12,shiftedCode:76,altCode:195},{width:1,keyIndex:C64_KEY_COLON,charCode:58,shiftedCode:58,altCode:195},{width:1,keyIndex:C64_KEY_SEMICOLON,charCode:59,shiftedCode:34,altCode:195},{width:1,keyIndex:C64_KEY_EQUALS,charCode:61,shiftedCode:34,altCode:195},{width:1.25,keyIndex:C64_KEY_RETURN,charCode:-1,shiftedCode:-1}],[{width:2.25,keyIndex:C64_KEY_SHIFT_LEFT,charCode:-1,shiftedCode:-1},{width:1,keyIndex:C64_KEY_Z,charCode:26,shiftedCode:90,altCode:192},{width:1,keyIndex:C64_KEY_X,charCode:24,shiftedCode:88,altCode:217},{width:1,keyIndex:C64_KEY_C,charCode:3,shiftedCode:67,altCode:197},{width:1,keyIndex:C64_KEY_V,charCode:22,shiftedCode:86,altCode:195},{width:1,keyIndex:C64_KEY_B,charCode:2,shiftedCode:66,altCode:200},{width:1,keyIndex:C64_KEY_N,charCode:14,shiftedCode:78,altCode:188},{width:1,keyIndex:C64_KEY_M,charCode:13,shiftedCode:77,altCode:206},{width:1,keyIndex:C64_KEY_COMMA,charCode:44,shiftedCode:60,altCode:195},{width:1,keyIndex:C64_KEY_PERIOD,charCode:46,shiftedCode:62,altCode:195},{width:1,keyIndex:C64_KEY_SLASH,charCode:47,shiftedCode:63,altCode:195},{width:2.75,keyIndex:C64_KEY_SHIFT_RIGHT,charCode:-1,shiftedCode:-1}],[{width:1.5,keyIndex:C64_KEY_COMMODORE,charCode:-1},{width:1.25,keyIndex:91},{width:1.5,keyIndex:18},{width:6.5,keyIndex:C64_KEY_SPACE,charCode:32,shiftedCode:32,altCode:32},{width:1.5,keyIndex:18},{width:1.25,keyIndex:92},{width:1.5,keyIndex:17}]];this.petsciiKeyboardSmall=[[{width:1,keyIndex:C64_KEY_ARROW_LEFT,charCode:31,shiftedCode:31,altCode:-1},{width:1,keyIndex:C64_KEY_ARROW_UP,charCode:30,shiftedCode:94,altCode:-1},{width:1.5,keyIndex:C64_KEY_F1,charCode:-1,shiftedCode:-1,altCode:-1,colorCode:0},{width:1.5,keyIndex:C64_KEY_F3,charCode:-1,shiftedCode:-1,altCode:-1,colorCode:1},{width:1.5,keyIndex:C64_KEY_F5,charCode:-1,shiftedCode:-1,altCode:-1,colorCode:2},{width:1.5,keyIndex:C64_KEY_F7,charCode:-1,shiftedCode:-1,altCode:-1,colorCode:3},{width:2,keyIndex:C64_KEY_RESTORE,charCode:-1,shiftedCode:-1,altCode:-1,colorCode:3},{width:2,keyIndex:C64_KEY_INS_DEL,charCode:-1,shiftedCode:-1,altCode:-1}],[{width:1,keyIndex:C64_KEY_ONE,charCode:49,shiftedCode:33,altCode:-1,colorCode:0},{width:1,keyIndex:C64_KEY_TWO,charCode:50,shiftedCode:34,altCode:-1,colorCode:1},{width:1,keyIndex:C64_KEY_THREE,charCode:51,shiftedCode:35,altCode:-1,colorCode:2},{width:1,keyIndex:C64_KEY_FOUR,charCode:52,shiftedCode:36,altCode:-1,colorCode:3},{width:1,keyIndex:C64_KEY_FIVE,charCode:53,shiftedCode:37,altCode:-1,colorCode:4},{width:1,keyIndex:C64_KEY_SIX,charCode:54,shiftedCode:38,altCode:-1,colorCode:5},{width:1,keyIndex:C64_KEY_SEVEN,charCode:55,shiftedCode:39,altCode:-1,colorCode:6},{width:1,keyIndex:C64_KEY_EIGHT,charCode:56,shiftedCode:40,altCode:-1,colorCode:7},{width:1,keyIndex:C64_KEY_NINE,charCode:57,shiftedCode:41,altCode:-1},{width:1,keyIndex:C64_KEY_ZERO,charCode:48,shiftedCode:-1,altCode:-1},{width:1,keyIndex:C64_KEY_PLUS,charCode:43,shiftedCode:91,altCode:-1},{width:1,keyIndex:C64_KEY_MINUS,charCode:45,shiftedCode:93,altCode:-1},{width:1,keyIndex:C64_KEY_POUND,charCode:28,shiftedCode:105,altCode:-1}],[{width:.5,keyIndex:C64_KEY_NONE,charCode:-1,shiftedCode:-1,altCode:-1},{width:1,keyIndex:C64_KEY_Q,charCode:17,shiftedCode:81,altCode:107},{width:1,keyIndex:C64_KEY_W,charCode:23,shiftedCode:87,altCode:115},{width:1,keyIndex:C64_KEY_E,charCode:5,shiftedCode:69,altCode:113},{width:1,keyIndex:C64_KEY_R,charCode:18,shiftedCode:82,altCode:114},{width:1,keyIndex:C64_KEY_T,charCode:20,shiftedCode:84,altCode:99},{width:1,keyIndex:C64_KEY_Y,charCode:25,shiftedCode:89,altCode:119},{width:1,keyIndex:C64_KEY_U,charCode:21,shiftedCode:85,altCode:120},{width:1,keyIndex:C64_KEY_I,charCode:9,shiftedCode:73,altCode:98},{width:1,keyIndex:C64_KEY_O,charCode:15,shiftedCode:79,altCode:121},{width:1,keyIndex:C64_KEY_P,charCode:16,shiftedCode:80,altCode:111},{width:1,keyIndex:C64_KEY_AT,charCode:0,shiftedCode:122,altCode:100},{width:1,keyIndex:C64_KEY_STAR,charCode:42,shiftedCode:70,altCode:95},{width:.5,keyIndex:C64_KEY_NONE,charCode:-1,shiftedCode:-1,altCode:-1}],[{width:1,keyIndex:C64_KEY_RUN_STOP,charCode:-1,shiftedCode:-1},{width:1,keyIndex:C64_KEY_A,charCode:1,shiftedCode:65,altCode:112},{width:1,keyIndex:C64_KEY_S,charCode:19,shiftedCode:83,altCode:110},{width:1,keyIndex:C64_KEY_D,charCode:4,shiftedCode:68,altCode:108},{width:1,keyIndex:C64_KEY_F,charCode:6,shiftedCode:70,altCode:123},{width:1,keyIndex:C64_KEY_G,charCode:7,shiftedCode:71,altCode:101},{width:1,keyIndex:C64_KEY_H,charCode:8,shiftedCode:72,altCode:116},{width:1,keyIndex:C64_KEY_J,charCode:10,shiftedCode:74,altCode:117},{width:1,keyIndex:C64_KEY_K,charCode:11,shiftedCode:75,altCode:97},{width:1,keyIndex:C64_KEY_L,charCode:12,shiftedCode:76,altCode:118},{width:1,keyIndex:C64_KEY_COLON,charCode:58,shiftedCode:27,altCode:27},{width:1,keyIndex:C64_KEY_SEMICOLON,charCode:59,shiftedCode:29,altCode:29},{width:1,keyIndex:C64_KEY_EQUALS,charCode:61,shiftedCode:61,altCode:61}],[{width:1.5,keyIndex:C64_KEY_SHIFT_LEFT,charCode:-1,shiftedCode:-1},{width:1,keyIndex:C64_KEY_Z,charCode:26,shiftedCode:90,altCode:109},{width:1,keyIndex:C64_KEY_X,charCode:24,shiftedCode:88,altCode:125},{width:1,keyIndex:C64_KEY_C,charCode:3,shiftedCode:67,altCode:124},{width:1,keyIndex:C64_KEY_V,charCode:22,shiftedCode:86,altCode:126},{width:1,keyIndex:C64_KEY_B,charCode:2,shiftedCode:66,altCode:127},{width:1,keyIndex:C64_KEY_N,charCode:14,shiftedCode:78,altCode:106},{width:1,keyIndex:C64_KEY_M,charCode:13,shiftedCode:77,altCode:103},{width:1,keyIndex:C64_KEY_COMMA,charCode:44,shiftedCode:60,altCode:60},{width:1,keyIndex:C64_KEY_PERIOD,charCode:46,shiftedCode:62,altCode:62},{width:1,keyIndex:C64_KEY_SLASH,charCode:47,shiftedCode:63,altCode:63},{width:1.5,keyIndex:C64_KEY_RETURN,charCode:-1,shiftedCode:-1}],[{width:1.5,keyIndex:C64_KEY_COMMODORE,charCode:-1},{width:1.25,keyIndex:C64_KEY_CTRL,charCode:-1},{width:6.5,keyIndex:C64_KEY_SPACE,charCode:32,shiftedCode:32,altCode:32}]];this.keyboard=this.petsciiKeyboardSmall},draw:function(){if(this.fontCanvas==null){return}var e=0;if(this.keyPositions.length==0){for(var t=0;t<256;t++){this.keyPositions[t]={x:0,y:0,width:0,height:0}}}this.context=this.canvas.getContext("2d");var i=this.keyboard;var r=8;var a=8;var s=1;var o=document.getElementById(this.id);if(!o){console.log("no holder");return}var l=o.clientWidth-4;var n=o.clientHeight-4;var h=Math.floor(l/15);if(u*s>h){u=Math.floor(h/s)}var d=Math.floor(r*1.8);var c=Math.floor(a*1.8);var f=13;var u=Math.floor(l/f);var p=u;if(p*6>n){p=Math.floor(n/6);if(u>1.35*p){u=Math.floor(1.35*p)}}if(s==1){}if(p>u){u=p}if(u<a){u=a}var v=p*7.5;var g=u*13;this.canvas.height=v*s+1;this.canvas.width=g*s+1;this.context=this.canvas.getContext("2d");this.shiftDown=false;this.commodoreDown=false;for(var t=0;t<this.keysDown.length;t++){if(this.keysDown[t]==C64_KEY_SHIFT_LEFT||this.keysDown[t]==C64_KEY_SHIFT_RIGHT){this.shiftDown=true}if(this.keysDown[t]==C64_KEY_COMMODORE){this.commodoreDown=true}}this.context.fillStyle="#151515";this.context.fillRect(0,0,this.canvas.width*s,this.canvas.height*s);this.context.fillStyle="#aaaaaa";var m=0;this.context.moveTo(0,m);for(var y=0;y<6;y++){this.context.moveTo(0,m+Math.floor(y*p*s)+.5);this.context.lineTo(g*s+1,m+Math.floor(y*p*s)+.5);var b=0;for(var t=0;t<i[y].length;t++){i[y][t].top=m+Math.floor(y*p*s)+.5;i[y][t].left=Math.floor(b*u*s)+.5;var C=false;for(var x=0;x<this.keysDown.length;x++){if(this.keysDown[x]==i[y][t].keyIndex){C=true}}if(C){this.context.fillRect(i[y][t].left,m+i[y][t].top,u*i[y][t].width*s,p*s)}this.keyPositions[e++]={x:i[y][t].left,y:m+i[y][t].top,width:u*i[y][t].width*s,height:p*s,keyIndex:i[y][t].keyIndex};this.context.moveTo(Math.floor(b*u*s)+.5,m+Math.floor(y*p*s)+.5);this.context.lineTo(Math.floor(b*u*s)+.5,m+Math.floor((y+1)*p*s)+.5);b+=i[y][t].width}this.context.moveTo(Math.floor(b*u*s)+.5,m+Math.floor(y*p*s)+.5);this.context.lineTo(Math.floor(b*u*s)+.5,m+Math.floor((y+1)*p*s)+.5)}this.context.moveTo(0,m+Math.floor(y*p*s)+.5);this.context.lineTo(g*s+1,m+Math.floor(y*p*s)+.5);this.context.strokeStyle="#333333";this.context.lineWidth=1.5;this.context.stroke();var b=13;var y=13;var S=4;var b=0;var y=0;for(var P=0;P<i.length;P++){b=0;y=P;for(var t=0;t<i[P].length;t++){var w=i[P][t].width*u*s;var I=Math.floor(b*u*s+(w-a*s)/2);var k=m+Math.floor(y*p*s+(p*s-r*s)/2);var S=this.keyboard[P][t].charCode;if(this.shiftDown){S=this.keyboard[P][t].shiftedCode}var M=false;if(this.commodoreDown){S=this.keyboard[P][t].altCode;if(S==-1&&typeof this.keyboard[P][t].colorCode!="undefined"){M=this.keyboard[P][t].colorCode;if(this.shiftDown){M+=8}}}if(typeof S=="undefined"){S=-1}if(S>=0){var T=S%16;var D=Math.floor(S/16);var E=T*8;var $=D*8;var _=8;var B=8;var R=I;var A=k;var F=8;var L=8;this.context.drawImage(this.fontCanvas,E,$,_,B,R,A,F,L)}else{var U=this.keyboard[P][t].keyIndex;var H=[];if(U==C64_KEY_F1||U==C64_KEY_F3||U==C64_KEY_F5||U==C64_KEY_F7){H.push(6);var S=49;switch(U){case C64_KEY_F3:S+=2;break;case C64_KEY_F5:S+=4;break;case C64_KEY_F7:S+=6;break}if(this.shiftDown){S++}H.push(S)}if(U==C64_KEY_COMMODORE){H.push(3);H.push(61)}if(U==C64_KEY_CTRL){H.push(3);H.push(20);H.push(18);H.push(12)}if(U==C64_KEY_SHIFT_LEFT){H.push(19);H.push(8);H.push(6);H.push(20)}if(U==C64_KEY_RESTORE){H.push(18);H.push(19);H.push(20);H.push(18)}if(U==C64_KEY_INS_DEL){H.push(4);H.push(5);H.push(12)}if(U==C64_KEY_RETURN){H.push(18);H.push(20);H.push(14)}if(U==C64_KEY_RUN_STOP){H.push(18);H.push(47);H.push(19)}var I=Math.floor(b*u*s+(w-H.length*a*s)/2);for(var O=0;O<H.length;O++){S=H[O];var T=S%16;var D=Math.floor(S/16);var E=T*8;var $=D*8;var _=8;var B=8;var R=I+O*8;var A=k;var F=8;var L=8;this.context.drawImage(this.fontCanvas,E,$,_,B,R,A,F,L)}}b+=i[P][t].width}}}};var c64keycharsImageData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAOk0lEQVR4Xu2d4XYbuw2Em/d/6PTIp+tSEIBvBqQs21H/9MZcgsBgMABXcvLnP//739+/f/9e/337/z9//vxZ/3z77+uZuBb3Zvs7+3R2Zn89g9ZX36+Y1hhiXFmc5GN3BtmvcI25qXwm+51vH0neMaDsJ/vregd+RsqOmBWAjj9rEVCiKl9OxXeRfiXjDZPqzxdeXbwPBIjGTic4qsrEvqpMXQV1iSWlq4hIBMjUxyFwhl0kQKbixwgQHYgMq1oIVY5akQQgrWfVksmjYidLhkIAp7VmBL5htcZxnAAnKpQSShW8u3/X/ndVAGUGcBU8nQEuJis9ZCLhXYJ/4gzg9PhT8XVnUgGt65+TfjflqgarFpDJbMZmkl5qQUpvzs6g+Mj/uF7dkqignPgcAnT+P1z1qt72/vnvROCuBZyq4JsdelfQKUCsUqpQdz22LXd/9XxVwYqCZAPfaq9T6B1qSu8BTgFUSaAaPEmoun6aADR0VreDbN8ag3tjUG5b0eZLCFAxVp2+dwnZDa7TGcElsUKaDCfCiOaolgBVC1ABn7YQFzzVn0wRsns0na9KeFeBylqHX+djbA9VC80IVV4Ds/5DEluxT2U7sZvOp/UUgP995qH0WCWJp15XuyrZtZmKILc9EgGoApx7sOKoe41S/fsIePDunBSCei/NANW7gZMzQOWjTIAIwgVm10+du74KUqcyqoLEs6ilqASIVavET/Kd4b5i3yl1przpDFDJzfvnPwsBRYkeSOqEqFYYVZRqp6u8a5hzKoQqedKeHPy+47PWm0A1cRMCZFJIQ526rsokVdA0foV4X02Oz1icgycAdBNoHMq6d/kE4rOn+Gef7+Rh99k1j0cUgBwiRVildzLkxf0KkbIBqRquOgVxCN4NiR2G6qBIechanEUA5YAK2GqvetVx7uArYCoZSP5/gwJkMT6dABnrKkVYSVJ9+cGxpyafkkvrisJ1AybZVwvPKZJPpVWNKwFUtnYBqiZ+5xNFNU51zlHtOc+pKqTirBDrSxTAAeFffXY3+VPcpG8EKUyiKZzWJ4OW8qZtVa5uCCP/aH2agG5mUluYMvNU/ksfBxMBSOJpPUv+7Wf0/YHKLzrv9Prp5KuJr8jjfJYi/V5ArCJykOSM+uzngFJ8UreSw51NsrN3CUEFoqwrA1ynYMoZ2TMPXwlbPy0jJmXMVwNxpnxienZPVq+XEZRIvmo9knBHBahgXNtKDi58jrSA3SqsXnRUILsVS9VB9oiAboJ2CmfdOyX5uu8IAYjBuwDTflrfJcCufTpfXSeiUR6y/dItoKrQOKR1PcqZors+rUr0tDp27J9IkDLRV4pEbSnD9f0egLJ2aH1SnYeObs3YBLgFMv3e21cEVJ2hJkB9zu3j1ZxE59E6xUuYWwQgeZo62znZDYgkeatd1Tf1ua8mwCRWSv6HTeWhlb3dFDoBjxJM/tE7CXfAmsQQz8iSVRWPch4VXkb0yweyf/e3S2Rgx2/Rxme6+3xFHEpqRzJn7wkFcMBX4p28W4l2qQWvBPz2BFAreNrr1NfJlVI4t5dMCYjMlKCuupU1si+3AIWFdNi0ert91EJ2CaDI+05cLmaZInUqRfZlAmRAT+VsB7DpXgJCmRVUG46PKoGrat9VGJkASlDPAEg5V3lG9a17TrWh+EPt4lpX+v3a8+PZ5LM0BDoBUa/OPmwiJ5UWcEKNVD+IJJQ0GpwVDNWcoMLgA8YvT5Lj2Xr36aMSpNoTlWFulwB0Y8jsq2euM5g7OHc5LlvA6lhlQHWkdWD5ZU3VXiVz8efqZxUxCZSULpFdTybl6KTcJUAV0wNGVLXdewA1YacJQFUfgaQE0zr1VVLRTsmcW4pCIIWAd898BQFW9mYOUsWteyop7yReTbDqh6MAKjmUYqr8iwXhEGW7BVCA2cBDFUqkrPZPW8C1b4cAkeTqx9HqmdQCspZNw+gHjgR21Uepv152s+l8OrFT5WU+kf8x+ZXfmQpVSSbgVXJQ66l8Ukj1+YxKgK6P7a4pDlcVQLKoSKvrv+rvNIFflZNbHPgiqOutCnBOi8jsEdhqf3eS0c0cVZtR7FMshOfu/sz+0wlAQdE6Bf1KAnTq0rWrqSoRFoTlryRANcARWLRezQbKjOC2KzVxqs+qvdtzP14BXkEApYJpYFWJ5LSjic1tAuz2eGIrsX63BUTQKnsuuFMCdDMXYe36eEQByCmlWjoSfCcCOLFMZ4CdoZuwesoM8GoCnGoBpyq/8qeaC6rbw6SaVdVZz3x5CyACqUC4rYCeX/1yKv/XESAbQiaATCfjSSJUUtH88dEjk38/Udk3keMVo4z4SoVXb1mrQkIFeBPg8R/QfBPgYFVQpewqAFUwqQXtr8hAcdG+lygAgaEwX3km+4SQPkBx5HhCGsVv55lTBEgn96UA6dZA63ct4E0AJ8X9sxWWrqJkdlwbWRv/VJhn93iyT5UyqebJHlWS43OKct1du4bt8xQ1HxSBEuQcrCbzJ7WA06q4U71OLlRCpy1g6uSbAJyiKbZsWXviQQGqpHW9hwYLus/GdffueoWqEi4bILM2Ub0cov3ZxL7GGL+VRH+u2kzls2Kv/BbWzeiOgRWcCkCyv67HZzP7CkBZ3536FxPctQXyn9aVqT+20OrPSrwfvxmUJWCHwZRwSuDufrJP61mSFCJWz6gKN7k5rPmLcR0nAB2QDZQKcJRwFcDYGrLKnQ6gShwKAZzWWvnfFW2Wgw7fBwXoJEhhlNIS3AqsKlKVZpVg3QxwigCrsk79j77sKHhKgF3Advbv9EiS0CmBKVHODHMqvu5MB//P3w7uZFY1WLWAlbGZTLsSH22QQqjn79wCstZSEafCk1rs024Bmey/f/ZvIHDXAk5VcNfnFAWgClcVSalo5RqsnldVMCnQuo9uINWgO6Xrt5gBnB6rDJmUsG6ImtinodYZIFfSujcGaoW39fRNIAF2er1iK7F/OsQpg9fODORUsDqoTjGqFKLEtnqR4LwqjeC5LeArFeCqAoUUWWI7Ce4qUFnrWnCHUYb/moNq/UOZsh5IkkZTbPeqtJPDZytAVlXV5wnPkN+sMIj8lAtHfbL4JQLQEOPcg59BANW/KwHxykYtjpJEvZdmgEqNTpJQagFUuRFotSdTggjg3f0k96cIECssa6OxhZB8R2ymLejCMB0CM2l4/+znIaAo0UNLUaqeKpQqiNZd+xmbuyn+ZB918PoJFMK/KNIZMtSW0Enyet7UnjJxu/3VmV3UYfaVBLl8fDoBuitIHMqU6iJwpz1Slc9nnf+VZLgb2hXQSaLJeaUFKBKuVPZFKvLJaQudCjoE74bEzl91UFRifsiFQwDlgArYaq8qxUryszu9Gt+/oABp61UBmiS/Uo5KEbL+n/VeUhQ1ma4KkPx3Hz51M8Suwir72/cAanJPAasCuQbWvZpewZ3KLIE4jV3FViEI2XJx/TjzKxSAHH+vP/5L6V+FifSNIKqOrAIf3ji0x404nqiKe0iDjsdUOkMkTREErrpxK2nqMWp7Kn8l/6PgARwO3JykC3Jpjkd/f83f2nk68mXp1huvik3wuIFU4OugmLBLv+XH1SV1U/+VX12VMEmMZN/V9RMCrSlSyrnw9fCes+HqYAnUC6oY7OUVqEer0k8lXrkYQ7KkDxurYVhf0srizho2my+KdlMueVBEYVqBickc71nxRAlVo3UV1M2Vq0PyX5XfGdIAAxeBdg2k/rJI+0n9bJ/ql1IhjlIS3Gqs9mEl0xUOlRzhSdBUL7ad1pT5m8K/ZPJGg9R5lpnPksxVU9hIJ7r/cITKrzKzC1XwTdAqlI812DpOpXezElhOLvlO00ppUqP8wzjgKQPBEABGA3MFZ7Vf9V39TnlOFWGR7pPMJ8gtkd4V0A183V2z7VZuxfE4KoZxHQ6qDW+dglq1pT/HJIEJ8l+/g3ha63hCz46Yc0arLVBJM9AqIigAO+Quhp0Sh+ZM9Q3C8nwG6CqdfFWw6dFwGbTP+VT+69vWohdEuhohy1AOW6QWyjKp2sP5sAURky8Cd+T1tOV+UdMcohkyoiA+D62VTOdgCb7lXJ2T2n2nB8VAl8V7X0x40zY5URj7GqgMQSqpHKB2n1WT9xMIkM0a02ukNAPsgr867Lx6Vs6tEqYmPKssIjCRxEmG46fzbKfcdzETyMqrYrLRyVxGCLJXyWHmq+O/CjCRrpoTsn3qmbGIphjFfdJbPWeqzRx7JgEyOYwzCvlfTf6TSl7jd2YkhQjKM9VwWWHwIwlAk3CsQEowrT9UTfjomwa5rlqdayq1nnhORcA7BVVYThWkyFFmwwm+6mmKxKsJViusk/KoACo5aO7oWkAsCIco2wpAAWYvJahCK0JllX+iBVSySX50FaZeyVTS0Qyw2iGbK44SATKQq8pTZMjpjdnAR6RyW0QXXzfTVElWVJXayuTcq7CIAGu8MgEUmZ8+ozhcVQBN5Iq0un6r/jpJVmwqzzix3Ozhi6Ao8S6gTotwWZ+RQgXJfa4C1ql29Uy39ThJfyAlJXSXADvOUd97NQE67LpBkTB/E2BBQK0addKfDnw02yhyr8byJsA3J4BSwc5VUVVJaqeXHcW/z0Kgh6kFkFNkn4KnqnErPypABK2y54I7JUCHN2Ht+vjRQilBbwL8/98OJqxWMk9nAMK7KxgqlnTIpqDIIWIl2d9VgKqnExikHBT3xG/yaR1qR9Wc/HYW5eflCkAOqkBQQmlI66R/QuLvogCELxKAZI0qgfZTVawBqImgoB2f1TOJYOqZygxQvQm9nUEfAD2sOwFSsijISVW8CfD3b3d1pVaF67+dABQfqQXtP31nf6kCEBhU4ep6JmH0SjWTNwLf2aP6rj43VUslB09rAcrhKgDdc/8SASIOrqJkOXFtZHPYZ1txkkHJJ9a/YgbYASu7lqkJrYpp1x/KAa1Hv+5uAZRA1TjJuUO63SFwF/DTqrjrD+WA1t8EIITC+m8nwH8Bc2k1JUw12cwAAAAASUVORK5CYII=";var romDump=romDump||{};romDump.character=[60,102,110,110,96,98,60,0,24,60,102,126,102,102,102,0,124,102,102,124,102,102,124,0,60,102,96,96,96,102,60,0,120,108,102,102,102,108,120,0,126,96,96,120,96,96,126,0,126,96,96,120,96,96,96,0,60,102,96,110,102,102,60,0,102,102,102,126,102,102,102,0,60,24,24,24,24,24,60,0,30,12,12,12,12,108,56,0,102,108,120,112,120,108,102,0,96,96,96,96,96,96,126,0,99,119,127,107,99,99,99,0,102,118,126,126,110,102,102,0,60,102,102,102,102,102,60,0,124,102,102,124,96,96,96,0,60,102,102,102,102,60,14,0,124,102,102,124,120,108,102,0,60,102,96,60,6,102,60,0,126,24,24,24,24,24,24,0,102,102,102,102,102,102,60,0,102,102,102,102,102,60,24,0,99,99,99,107,127,119,99,0,102,102,60,24,60,102,102,0,102,102,102,60,24,24,24,0,126,6,12,24,48,96,126,0,60,48,48,48,48,48,60,0,12,18,48,124,48,98,252,0,60,12,12,12,12,12,60,0,0,24,60,126,24,24,24,24,0,16,48,127,127,48,16,0,0,0,0,0,0,0,0,0,24,24,24,24,0,0,24,0,102,102,102,0,0,0,0,0,102,102,255,102,255,102,102,0,24,62,96,60,6,124,24,0,98,102,12,24,48,102,70,0,60,102,60,56,103,102,63,0,6,12,24,0,0,0,0,0,12,24,48,48,48,24,12,0,48,24,12,12,12,24,48,0,0,102,60,255,60,102,0,0,0,24,24,126,24,24,0,0,0,0,0,0,0,24,24,48,0,0,0,126,0,0,0,0,0,0,0,0,0,24,24,0,0,3,6,12,24,48,96,0,60,102,110,118,102,102,60,0,24,24,56,24,24,24,126,0,60,102,6,12,48,96,126,0,60,102,6,28,6,102,60,0,6,14,30,102,127,6,6,0,126,96,124,6,6,102,60,0,60,102,96,124,102,102,60,0,126,102,12,24,24,24,24,0,60,102,102,60,102,102,60,0,60,102,102,62,6,102,60,0,0,0,24,0,0,24,0,0,0,0,24,0,0,24,24,48,14,24,48,96,48,24,14,0,0,0,126,0,126,0,0,0,112,24,12,6,12,24,112,0,60,102,6,12,24,0,24,0,0,0,0,255,255,0,0,0,8,28,62,127,127,28,62,0,24,24,24,24,24,24,24,24,0,0,0,255,255,0,0,0,0,0,255,255,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,255,255,0,0,48,48,48,48,48,48,48,48,12,12,12,12,12,12,12,12,0,0,0,224,240,56,24,24,24,24,28,15,7,0,0,0,24,24,56,240,224,0,0,0,192,192,192,192,192,192,255,255,192,224,112,56,28,14,7,3,3,7,14,28,56,112,224,192,255,255,192,192,192,192,192,192,255,255,3,3,3,3,3,3,0,60,126,126,126,126,60,0,0,0,0,0,0,255,255,0,54,127,127,127,62,28,8,0,96,96,96,96,96,96,96,96,0,0,0,7,15,28,24,24,195,231,126,60,60,126,231,195,0,60,126,102,102,126,60,0,24,24,102,102,24,24,60,0,6,6,6,6,6,6,6,6,8,28,62,127,62,28,8,0,24,24,24,255,255,24,24,24,192,192,48,48,192,192,48,48,24,24,24,24,24,24,24,24,0,0,3,62,118,54,54,0,255,127,63,31,15,7,3,1,0,0,0,0,0,0,0,0,240,240,240,240,240,240,240,240,0,0,0,0,255,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,192,192,192,192,192,192,192,192,204,204,51,51,204,204,51,51,3,3,3,3,3,3,3,3,0,0,0,0,204,204,51,51,255,254,252,248,240,224,192,128,3,3,3,3,3,3,3,3,24,24,24,31,31,24,24,24,0,0,0,0,15,15,15,15,24,24,24,31,31,0,0,0,0,0,0,248,248,24,24,24,0,0,0,0,0,0,255,255,0,0,0,31,31,24,24,24,24,24,24,255,255,0,0,0,0,0,0,255,255,24,24,24,24,24,24,248,248,24,24,24,192,192,192,192,192,192,192,192,224,224,224,224,224,224,224,224,7,7,7,7,7,7,7,7,255,255,0,0,0,0,0,0,255,255,255,0,0,0,0,0,0,0,0,0,0,255,255,255,3,3,3,3,3,3,255,255,0,0,0,0,240,240,240,240,15,15,15,15,0,0,0,0,24,24,24,248,248,0,0,0,240,240,240,240,0,0,0,0,240,240,240,240,15,15,15,15,195,153,145,145,159,153,195,255,231,195,153,129,153,153,153,255,131,153,153,131,153,153,131,255,195,153,159,159,159,153,195,255,135,147,153,153,153,147,135,255,129,159,159,135,159,159,129,255,129,159,159,135,159,159,159,255,195,153,159,145,153,153,195,255,153,153,153,129,153,153,153,255,195,231,231,231,231,231,195,255,225,243,243,243,243,147,199,255,153,147,135,143,135,147,153,255,159,159,159,159,159,159,129,255,156,136,128,148,156,156,156,255,153,137,129,129,145,153,153,255,195,153,153,153,153,153,195,255,131,153,153,131,159,159,159,255,195,153,153,153,153,195,241,255,131,153,153,131,135,147,153,255,195,153,159,195,249,153,195,255,129,231,231,231,231,231,231,255,153,153,153,153,153,153,195,255,153,153,153,153,153,195,231,255,156,156,156,148,128,136,156,255,153,153,195,231,195,153,153,255,153,153,153,195,231,231,231,255,129,249,243,231,207,159,129,255,195,207,207,207,207,207,195,255,243,237,207,131,207,157,3,255,195,243,243,243,243,243,195,255,255,231,195,129,231,231,231,231,255,239,207,128,128,207,239,255,255,255,255,255,255,255,255,255,231,231,231,231,255,255,231,255,153,153,153,255,255,255,255,255,153,153,0,153,0,153,153,255,231,193,159,195,249,131,231,255,157,153,243,231,207,153,185,255,195,153,195,199,152,153,192,255,249,243,231,255,255,255,255,255,243,231,207,207,207,231,243,255,207,231,243,243,243,231,207,255,255,153,195,0,195,153,255,255,255,231,231,129,231,231,255,255,255,255,255,255,255,231,231,207,255,255,255,129,255,255,255,255,255,255,255,255,255,231,231,255,255,252,249,243,231,207,159,255,195,153,145,137,153,153,195,255,231,231,199,231,231,231,129,255,195,153,249,243,207,159,129,255,195,153,249,227,249,153,195,255,249,241,225,153,128,249,249,255,129,159,131,249,249,153,195,255,195,153,159,131,153,153,195,255,129,153,243,231,231,231,231,255,195,153,153,195,153,153,195,255,195,153,153,193,249,153,195,255,255,255,231,255,255,231,255,255,255,255,231,255,255,231,231,207,241,231,207,159,207,231,241,255,255,255,129,255,129,255,255,255,143,231,243,249,243,231,143,255,195,153,249,243,231,255,231,255,255,255,255,0,0,255,255,255,247,227,193,128,128,227,193,255,231,231,231,231,231,231,231,231,255,255,255,0,0,255,255,255,255,255,0,0,255,255,255,255,255,0,0,255,255,255,255,255,255,255,255,255,0,0,255,255,207,207,207,207,207,207,207,207,243,243,243,243,243,243,243,243,255,255,255,31,15,199,231,231,231,231,227,240,248,255,255,255,231,231,199,15,31,255,255,255,63,63,63,63,63,63,0,0,63,31,143,199,227,241,248,252,252,248,241,227,199,143,31,63,0,0,63,63,63,63,63,63,0,0,252,252,252,252,252,252,255,195,129,129,129,129,195,255,255,255,255,255,255,0,0,255,201,128,128,128,193,227,247,255,159,159,159,159,159,159,159,159,255,255,255,248,240,227,231,231,60,24,129,195,195,129,24,60,255,195,129,153,153,129,195,255,231,231,153,153,231,231,195,255,249,249,249,249,249,249,249,249,247,227,193,128,193,227,247,255,231,231,231,0,0,231,231,231,63,63,207,207,63,63,207,207,231,231,231,231,231,231,231,231,255,255,252,193,137,201,201,255,0,128,192,224,240,248,252,254,255,255,255,255,255,255,255,255,15,15,15,15,15,15,15,15,255,255,255,255,0,0,0,0,0,255,255,255,255,255,255,255,255,255,255,255,255,255,255,0,63,63,63,63,63,63,63,63,51,51,204,204,51,51,204,204,252,252,252,252,252,252,252,252,255,255,255,255,51,51,204,204,0,1,3,7,15,31,63,127,252,252,252,252,252,252,252,252,231,231,231,224,224,231,231,231,255,255,255,255,240,240,240,240,231,231,231,224,224,255,255,255,255,255,255,7,7,231,231,231,255,255,255,255,255,255,0,0,255,255,255,224,224,231,231,231,231,231,231,0,0,255,255,255,255,255,255,0,0,231,231,231,231,231,231,7,7,231,231,231,63,63,63,63,63,63,63,63,31,31,31,31,31,31,31,31,248,248,248,248,248,248,248,248,0,0,255,255,255,255,255,255,0,0,0,255,255,255,255,255,255,255,255,255,255,0,0,0,252,252,252,252,252,252,0,0,255,255,255,255,15,15,15,15,240,240,240,240,255,255,255,255,231,231,231,7,7,255,255,255,15,15,15,15,255,255,255,255,15,15,15,15,240,240,240,240];var NESDebugger=function(){this.nes=null;this.uiComponent=null;this.nesFocus=true;this.disassembly=null;this.lastUpdate=0;this.prefix="nes"};NESDebugger.prototype={init:function(e){},show:function(){this.disassembly=new DbgDisassembly;this.disassembly.init({prefix:this.prefix,debugger:this,machine:null});this.disassembly.buildInterface(this.disassemblyPanel)},buildInterface:function(e){this.uiComponent=UI.create("UI.Panel",{id:"nesdebuggerPanel"});e.add(this.uiComponent);var t=UI.create("UI.SplitPanel",{id:"nesDebuggerSplitPanel"});this.uiComponent.add(t);var i="";i+="<div>";i+="<div>";i+='<div class="ui-button" id="nesPlay">play/pause</div>';i+='<div class="ui-button" id="nesStep">step</div>';i+='<div class="ui-button" id="nesReset">machine reset</div>';i+='<div class="ui-button" id="nesLoadPRG">Load PRG...</div>';i+='<div style="display: inline-block">';i+="Joystick:";i+="<div>";i+='<label class="rb-container">None';i+='  <input type="radio" id="importNESJoystickPort1" name="importNESJoystickPort" checked="checked" value="0">';i+='  <span class="checkmark"></span>';i+="</label>";i+='<label class="rb-container">Port 1';i+='  <input type="radio" id="importNESJoystickPort1" name="importNESJoystickPort" value="1">';i+='  <span class="checkmark"></span>';i+="</label>";i+='<label class="rb-container">Port 2';i+='  <input type="radio" id="importNESJoystickPort2" name="importNESJoystickPort" value="2">';i+='  <span class="checkmark"></span>';i+="</label>";i+="</div>";i+="</div>";i+="</div>";i+='<input class="formControl"  id="nesChoosePRG" type="file" accept=".nes" style="position: absolute; top: -50px; left: -100px" />';i+='<canvas id="nesDebuggerCanvas"></canvas>';i+="</div>";var r=UI.create("UI.HTMLPanel",{id:"nesDebuggerHTML",html:i});t.add(r);var a=this;UI.on("ready",function(){a.initEvents()});this.memoryPanel=UI.create("UI.Panel");t.addEast(this.memoryPanel,400);this.cpuPanel=UI.create("UI.SplitPanel");t.addWest(this.cpuPanel,300);this.registersPanel=UI.create("UI.Panel");this.cpuPanel.addNorth(this.registersPanel,40,false);this.breakpointsPanel=UI.create("UI.Panel");this.cpuPanel.addSouth(this.breakpointsPanel,200);this.disassemblyPanel=UI.create("UI.Panel");this.cpuPanel.add(this.disassemblyPanel)},initEvents:function(){var i=this;$("#nesLoadPRG").on("click",function(){$("#nesChoosePRG").click()});document.getElementById("nesChoosePRG").addEventListener("change",function(e){var t=document.getElementById("nesChoosePRG").files[0];i.loadNESFile(t)})},loadNESFile:function(e){console.log("load nes file");console.log(e);var i=new FileReader;var t=this;i.onload=function(e){var t=new Uint8Array(i.result);nes_insertCartridge(t,t.length)};i.readAsArrayBuffer(e)},isRunning:function(){return true},getPC:function(){return 0},readByte:function(e){return 0},getCycleCount:function(e){return 0},writeByte:function(e,t){},getPCBreakpoints:function(){return[]},setPCBreakpointEnabled:function(e){},removePCBreakpoint:function(e){},loadROM:function(e){},step:function(){console.log("step")},play:function(){},machineReset:function(){},setPRG:function(e){},showFile:function(e){},setJoystickEnabled:function(e){},setJoystickPort:function(e){},keyDown:function(e){if(this.nesFocus){}},keyUp:function(e){if(this.nesFocus){}},focusMachine:function(){this.nesFocus=true},blurMachine:function(){this.nesFocus=false},update:function(){if(nes_ready){var e=getTimestamp();var t=e-this.lastUpdate;this.lastUpdate=e;if(nes_update(t)||!nes_isRunning()){}this.disassembly.update()}}};
